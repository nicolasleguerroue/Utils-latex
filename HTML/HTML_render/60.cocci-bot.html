<html><head><style>.cent {  display: block;  margin-left: auto;  margin-right: auto;}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script><body style='margin-left:5%;margin-right:5%;margin-top:1%'><h4>Fichier générer depuis les sources Latex</h4><h5>Auteur : Nicolas Le Guerroué</h5><a href='index.html'><button class='btn btn-success' >Revenir au sommaire</button></a><hr> 

<h2 >Introduction</h2>     
<h3>Présentation</h3>
Ce tutoriel a pour objectif de créer une application pour diriger le robot en Bluetooth.  
L'application enverra des « commandes » au module Bluetooth de type Crius 

Cette application se fera à l'aide du logiciel en ligne «App Inventor 2», qui se divise en deux parties : 

<ul>
    <li> une partie dédiée exclusivement à l'interface graphique
</li>
	  (positionnement des boutons, etc).

	<li> une seconde partie dédiée à la gestion des données et à leurs envois/réceptions
</li>
</ul>
\noindent

Nous verrons donc comment faire une interface spécifique pour le Cocci-Bot. 

<div class='alert alert-danger' ><h4>Remarque importante</h4>Il est impératif que le téléphone portable tactile soit sous le système d'exploitation Android et qu'il dispose de la fonctionnalité Bluetooth</div>
Par exemple, si j'appuie sur un bouton «avancer», je veux que l'application envoie en Bluetooth la donnée qui permettra à l'Arduino de comprendre l'instruction  à l'aide  du module Bluetooth.

<h3>Liste du matériel</h3>
Pour cette première partie, nous aurons besoin de : 

<ul>
    <li> Un téléphone portable, comme dit précédemment, étant tactile et fonctionnant sous <span style='color:red;'>Android</span>. Les dimensions importent peu, pourvu que celui-ci dispose du mode Bluetooth
</li>
    <li> Un module Bluetooth de type Crius (Alimentation en 5V)
</li>
    <li> Une carte Arduino 
</li>
    <li> Des fils de connexion pour brancher le module à la carte
</li>
    <li> Une connexion internet
</li>
</ul>
Et c'est tout… pour le moment.

<h3>Cahier des Charges</h3>
Maintenant que nous avons la liste du matériel nécessaire, ce serait bien de mettre en place un cahier des charges afin de savoir ce que le robot sera capable de faire… 

1) L'application devra se connecter au module Bluetooth du robot.

Pour cela, on se connectera  à un module en passant par la liste des modules Bluetooth disponibles.

Cette méthode permet de se connecter sans avoir l'adresse MAC. En revanche, l'étape de l'appairage est indispensable. (Chapitre \ref{appairage}) 

2) Le robot devra être contrôlé de façon manuelle,  il y aura donc 5 boutons de commande :

<ul>
    <li> 1 bouton «Avancer»
</li>
    <li> 1 bouton «Reculer»
</li>
    <li> 1 bouton «Droite»
</li>
    <li> 1 bouton «Gauche»
</li>
    <li> 1 bouton «Stop»
</li>
</ul>
3) Le robot devra également se diriger de façon autonome grâce à ses capteurs (distance, lumière). Il y aura donc un bouton «automatique» pour déclencher ce mode. 

<div class='alert alert-primary' ><h4>Application facultative</h4> Le robot pourra également indiquer l'état de la batterie (en \%, sur l'écran LCD) par simple appui d'un bouton.  Cette section ne sera pas abordée içi.</div>

 
<div class='alert alert-warning' ><h4>Point-clé</h4>Avant de créer l'application, il faut tout d'abord que le portable puisse reconnaître le module Bluetooth. Pour cela, il faut «l'appairer», c'est à dire que l'on va définir que le module sera apte à recevoir les données envoyées par le portable. Cette étape est très rapide et ne sera effectuée qu’à chaque changement de module Bluetooth.</div>
1) Tout d'abord, branchez le module : la broche +5V du module est reliée à la broche 5V de la carte Arduino et la broche GND du module est reliée à la GND de la carte. 

2) Démarrez le Bluetooth sur votre téléphone portable puis allez dans <b>paramètres > Bluetooth</b> 
Faites « <b>rechercher</b> » afin de trouver un périphérique. 
Vous devriez trouver un périphérique « BT Crius ». Cliquez dessus et faites « <b>associer</b> ». 
A ce moment là, on vous demandera un mot de passe, qui par défaut, est <b>0000</b> (ou <b>1234</b>). 
Lorsqu'il est entré, faites « <b>valider</b> » et au bout de quelques secondes, le clignotement du module devrait se stopper pour qu'il n'y ait qu'une lumière continue 
Et voila, le module est appairé.

<h3>Préparation</h3>
 
Maintenant que nous nous sommes assurés que la communication s'effectuera, il est temps de faire l'application et de préparer notre outil (enfin, me direz-vous!) 

\noindent

Tout d'abord, saisissez dans un moteur de recherche l'adresse suivante : 

<a class="alert-link">http://appinventor.mit.edu/</a> (Site <b>App Inventor 2</b>» ) 
Une page comme ceci devrait apparaître :

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/portail.png' class='alignnone size-medium' style='max-width:30%;'><figcaption>Figure - Le portail App Inventor</figcaption></div></figure>
Ensuite, cliquez en haut à gauche sur :  <span class='badge badge-light'>Create App</span>
Cela devrait vous diriger vers ceci : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/account.png' class='alignnone size-medium' style='max-width:30%;'><figcaption>Figure - La fenêtre de connexion</figcaption></div></figure>
Puis connectez vous avec votre compte Google (ou Gmail). Si vous n'en avez pas, sa création est rapide… (create account). 

Vous tombez ensuite sur une interface similaire : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/begin.png' class='alignnone size-medium' style='max-width:30%;'><figcaption>Figure - La fenêtre des applications</figcaption></div></figure>
\noindent

Pour démarrer votre projet, cliquez sur « <b>Start new project</b> » (onglet « <b>Projects</b> »)et là, cette page apparaît : 
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/screen1.png' class='alignnone size-medium' style='max-width:30%;'><figcaption>Figure - La fenêtre de notre application</figcaption></div></figure>
\noindent 

Avant toute chose, réglez la langue du site en français. Pour cela, sélectionnez l'onglet <b>English</b> et choisissez « <b>français</b> ».
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/langue.png' class='alignnone size-medium' style='max-width:70%;'><figcaption>Figure - Le choix de la langue</figcaption></div></figure>
<h3>Sauvegarde du projet</h3>
Avant toute chose, voici une étape non négligeable : la sauvegarde du projet

<div class='alert alert-danger' ><h4>Remarque importante</h4>L'application App Inventor étant en ligne, un problème de réseau peut ruiner votre projet en cas de mauvaise sauvegarde. Il convient de sauvegarder régulièrement votre travail</div>
Il faut se reporter au menu du haut et aller dans <b>Projets</b> puis <b>Enregistrer le projet</b>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/save.png' class='alignnone size-medium' style='max-width:70%;'><figcaption>Figure - Sauvegarde du projet</figcaption></div></figure>
Quant à l'interface, un petit tour d'horizon s'impose.

<h3>Présentation des éléments graphiques</h3>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/layout.png' class='alignnone size-medium' style='max-width:45%;'><figcaption>Figure - Les outils de App Inventor</figcaption></div></figure>
Par convention, dans ce tutoriel :

<ul>
    <li> la partie <span style='color:orange;'>orange</span> sera la partie menu
</li>
    <li> la partie <span style='color:blue;'>bleue</span>  sera l'interface
</li>
    <li> la partie <span style='color:gray;'>grise</span>  sera la partie composants
</li>
    <li> la partie <span style='color:green;'>verte</span>  sera la partie propriétés
</li>
    <li> la partie <span style='color:red;'>rouge</span>  garde son nom : blocks
</li>
    <li> la partie <span style='color:magenta;'>magenta</span> est la partie "graphique" (regroupement des quatre premières parties
</li>
</ul>
Maintenant, prenons un \colors{orange}{sélectionneur de liste} dans le menu, et faisons le <span style='color:blue;'>glisser sur l'interface</span>. 

Pour cela, maintenez enfoncé le« <b>sélectionneur de liste</b> » dans le menu et faites le glisser sur l'écran virtuel. Relâchez ensuite la souris. On obtient :
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/render1.png' class='alignnone size-medium' style='max-width:50%;'><figcaption>Figure - Rendu de l'<span style='color:blue;'>interface</span></figcaption></div></figure>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/render_2.png' class='alignnone size-medium' style='max-width:70%;'><figcaption>Figure - Rendu des <span style='color:gray;'>composants</span></figcaption></div></figure>
Veuillez cliquer sur <b>Sélecteur de list1</b>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/render_3.png' class='alignnone size-medium' style='max-width:50%;'><figcaption>Figure - Rendu des <span style='color:green;'>propriétés</span></figcaption></div></figure>
<h4>Principaux elements</h4> <span id='menu'></span>
Maintenant, on peut voir que le menu offre plusieurs choix d'objets. Voici les plus importants :

Il vous est notamment possible de faire les actions suivantes :

<ul>
    <li> Créer un bouton
</li>
    <li> Créer une case à cocher
</li>
    <li> Sélectionner une date
</li>
    <li> Afficher une image
</li>
    <li> Afficher du texte
</li>
    <li> Créer une liste de selection
</li>
    <li> Créer une liste classique
</li>
    <li> Envoyer une notification
</li>
    <li> Afficher un curseur
</li>
    <li> Créer une zone de saisie de texte (mot de passe...)
</li>
    <li> Sélectionner l'heure
</li>
</ul>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/menu.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - La liste des composants</figcaption></div></figure>
<h3>Présentation des propriétés</h3>
Nous allons présenter les propriétés principales des composants mis à notre disposition. 

\noindent

Tout d'abord, gardez le \colors{orange}{sélectionneur de liste} sur l'<span style='color:blue;'>écran</span>.

Ensuite, pour centrer la liste, allez dans le menu <span style='color:gray;'>composants</span>, sélectionnez  <b>screen 1</b>.
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/select_screen.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Sélection de l'écran</figcaption></div></figure>
Dans l'onglet <span style='color:green;'>propriété</span> → alignement horizontal, sélectionner la liste sur <b>centrer</b>. 
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/center_screen.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Centrage de l'écran</figcaption></div></figure>
Vous pouvez également changer la forme du bouton. 

Allez dans \colors{gray}{Composants} → sélectionneur de liste et dans <span style='color:green;'>Propriétés</span>, trouvez l'onglet <b>forme</b> 
et sélectionnez celle voulue.    

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/shape.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Forme du bouton</figcaption></div></figure>
Voici quelques paramètres de mise en forme : 

<ul>
    <li> Vous pouvez modifier la couleur de la liste en sélectionnant <b>Couleur de fond</b></li>
    <li> Pour modifier la taille de la liste, il suffit de rentrer la taille en pixels ou en \% de l'écran (<b>Hauteur, Largeur</b>) 	Il vaut mieux préciser en \% afin que l'application soit compatible au niveau du format sur tous les appareils.</li>
</ul>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/properties.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - La liste des propriétés</figcaption></div></figure>
Enfin, pour décider du titre de la liste sur l'application, sélectionner la liste <b>Selectionneur de liste1</b> et dans ses <span style='color:green;'>propriétés</span>, modifier l'onglet <b>texte</b> et écrivez, par exemple « <b>Connexion</b> »
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/rename.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Choisir le nom par défaut du bouton \bold{Connexion</figcaption></div></figure>
<h3>Renommer les élements</h3>
Dans un souci de clarté, il convient de  renommer les éléments que nous  plaçons sur l'écran. 

Pour renommer le sélectionneur de liste, il faut allez dans les <span style='color:gray;'>composants</span> de l'interface,  et sélectionnez  « Renommer » 

Je l'ai renommé en « connexion ».

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/rename_screen.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Renommer un élement</figcaption></div></figure>
<div class='alert alert-success' ><h4>Astuce</h4>Pour changer la couleur d'arrière-plan de l'application, allez dans composants → screen1 et dans propriétés, sélectionnez couleur de fond</div>
<h3>Ajouter un client Bluetooth</h3> <span id='bluetooth_install'></span>
Par la suite, nous allons utiliser le client Bluetooth d'App Inventor. 

Pour le trouver, il suffit d'explorer le <span style='color:orange;'>menu latéral</span>. Un ensemble d'éléments est disponible à la suite des principaux éléments énumérés dans la section \ref{menu}.

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/add.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Menu latéral</figcaption></div></figure>
Le client Bluetooth se situe dans la section <b>Connectivité</b>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/connectivite.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Ajouter un client Bluetooth</figcaption></div></figure>
Pour l'ajouter à noter application, il suffit de glisser le client Bluetooth sur l'<span style='color:blue;'>interface</span>.

A ce moment là, sous l'écran virtuel, le client Bluetooth apparaît.

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/non-visible.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Présence du client Bluetooth</figcaption></div></figure>
Et voila, le client Bluetooth est mis en place.

<h3>Premier rendu et agencement des élements</h3>
En faisant toutes ces étapes, on obtient : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/first_render.png' class='alignnone size-medium' style='max-width:40%;'><figcaption>Figure - Premier rendu de l'application</figcaption></div></figure>
En ajoutant un bouton (glisser-déposer un bouton disponible dans le menu latéral) et en modifiant ses propriétés (forme, couleur...), on obtient ceci : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/second_render.png' class='alignnone size-medium' style='max-width:40%;'><figcaption>Figure - Rendu avec un bouton "Avancer"</figcaption></div></figure>
<h4>Générer un espace entre deux élements</h4>
On souhaite maintenant espacer le bouton "Connexion" et le bouton "Avancer" 

Rien de plus simple ! Il suffit de placer un élément <b>label</b>
(outil dans menu) entre les deux boutons puis de

choisir ses dimensions, ce qui correspondra à l'espacement des boutons. 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/label.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Emplacement du label</figcaption></div></figure>
Pour que le label ne soit pas visible, il suffira de mettre son texte vide.

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/label_content.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Texte du label</figcaption></div></figure>
Et voilà le résultat : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/label_space.png' class='alignnone size-medium' style='max-width:20%;'><figcaption>Figure - Espace entre deux élements</figcaption></div></figure>
<h3>Alignement des éléments</h3>
Maintenant, ce serait bien de pouvoir aligner des boutons (ou autre)

horizontalement afin d'obtenir quelque  chose comme ceci :

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/align_button.png' class='alignnone size-medium' style='max-width:40%;'><figcaption>Figure - Alignement d'éléments</figcaption></div></figure>
Ne vous inquiétez pas, le cadre noir n’apparaîtra pas sur l'application ; c'est juste un moyen de distinguer les alignements. 

Pour faire ceci, allez dans le <span style='color:orange;'>menu</span> et sélectionnez l'onglet <b>Disposition</b>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/disposition.png' class='alignnone size-medium' style='max-width:40%;'><figcaption>Figure - Emplacement des éléments d'agencement</figcaption></div></figure>
Une fenêtre comme ceci apparaît :

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/disposition_layout.png' class='alignnone size-medium' style='max-width:50%;'><figcaption>Figure - Éléments d'agencement</figcaption></div></figure>
Ensuite, faites glisser l'outil <b>Arrangement Horizontal</b>
sous la liste « <b>Connexion</b> » et vous devriez avoir ceci :
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/add_layout.png' class='alignnone size-medium' style='max-width:50%;'><figcaption>Figure - Éléments d'agencement placé</figcaption></div></figure>
Vous pouvez dorénavant faire glisser des boutons dans ce carré et ils se mettront automatiquement côte à côte. Il suffit de régler la taille des boutons sélectionnés dans <span style='color:green;'>propriétés</span>.

<div class='alert alert-success' ><h4>Astuce</h4>Il est possible de changer les dimensions de l'outil "Arrangement Horizontal"</div>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/ha_layout.png' class='alignnone size-medium' style='max-width:50%;'><figcaption>Figure - Propriétés de l'objet \bold{Arrangement Horizontal</figcaption></div></figure>
En revanche, il y a un fond blanc pour l'objet <b>Arrangement Horizontal </b>:
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/next_layout.png' class='alignnone size-medium' style='max-width:70%;'><figcaption>Figure - Couleur d'arrière-plan de l'outil \bold{Arrangement Horizontal</figcaption></div></figure>
En allant dans les <span style='color:green;'>propriétés</span> de l'objet <b>Arrangement Horizontal</b>, mettez la couleur d'arrière-plan en « <b>aucun</b> »
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/background_color.png' class='alignnone size-medium' style='max-width:70%;'><figcaption>Figure - Couleur d'arrière-plan transparent</figcaption></div></figure>
<h3>Mise en place de l'ensemble des boutons</h3>
Après avoir mis les boutons "<b>Droite</b>", "<b>Stop</b>", "<b>Gauche</b>", "<b>Reculer</b>", "<b>Batterie</b>" et "<b>Auto</b>" et mis un peu de couleur, vous pouvez obtenir une interface de ce type :
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/render.png' class='alignnone size-medium' style='max-width:70%;'><figcaption>Figure - Rendu de l'application</figcaption></div></figure>
<div class='alert alert-danger' ><h4>Remarque importante</h4>Par la suite, veuillez mettre l'arrière-plan de « connexion » en rouge (non représenté ici) </div>

Nous avons réalisé et mis en place tous nos élément graphiques. Il ne nous reste donc plus qu'a les faire interagir afin d'envoyer les données Bluetooth. 

\noindent

Pour cela, commencez par aller dans la section <b>Bloc</b>, disponible en haut à droite de la page
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/bloc.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Emplacement du menu "\bold{Bloc</figcaption></div></figure>
<br>

<h3>Présentation</h3>
A l'ouverture du menu <b>Bloc</b>, voici le rendu
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/bloc_main.png' class='alignnone size-medium' style='max-width:30%;'><figcaption>Figure - Menu "\bold{Bloc</figcaption></div></figure>
Sur le menu de gauche, nous retrouvons une liste de blocs 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/blocs.png' class='alignnone size-medium' style='max-width:50%;'><figcaption>Figure - Menu latéral</figcaption></div></figure>
mais également nos élements graphiques agencés précédemment : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/own_blocs.png' class='alignnone size-medium' style='max-width:50%;'><figcaption>Figure - Nos élements ajoutés</figcaption></div></figure>
En cliquant sur chaque onglet (Contrôle, Logique, Math…), une liste de blocs apparaît :

(ici, en cliquant sur Contrôle)

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/zoom_control.png' class='alignnone size-medium' style='max-width:40%;'><figcaption>Figure - Blocs \bold{Controls</figcaption></div></figure>
Tous ces blocs sont faits pour pouvoir être glissés dans la partie blanche centrale…

<h3>Configuration de la liste des périphériques Bluetooth</h3>
<h4>Principe</h4>
Nous allons configurer notre liste <b>Connexion</b> afin qu'elle nous indique les modules Bluetooth disponibles.
Cette étape se fera en deux temps : 

<ul>
    <li> Configuration de la liste <b>avant</b> le choix de l'utilisateur</li>
    <li> Mise à jour de la liste <b>après</b> le choix de l'utilisateur</li>
</ul>
Commencer par sélectionner la liste <b>Connexion</b> dans le menu latéral
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/connexion.png' class='alignnone size-medium' style='max-width:90%;'><figcaption>Figure - Sélection de la liste</figcaption></div></figure>
Le menu suivant apparaît : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/zoom_connexion.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Éléments de l'objet \bold{Connexion</figcaption></div></figure>
<ul>
    <li> Le "<b>Quand connexion.Avant prise</b>" représente le bloc qui contiendra les instructions de la liste, c'est à dire que dans ce bloc, nous annoncerons que la liste contiendra toutes les adresses Bluetooth disponibles.</li>
    <li> Le "<b>Quand connexion.Après prise</b>" représente le bloc d'instructions après avoir choisi le module Bluetooth dans la liste. Dans ce bloc, après avoir récupéré l'adresse du module, nous nous connecterons à ce dernier.</li>
</ul>
Il faut donc placer ces deux blocs dans la zone blanche (glisser-déposer).

<h4>Définir les clients Bluetooth disponibles</h4>
Le bloc pour définir les élements de la liste <b>Connexion</b> est le suivant : 
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/connexion_begin.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Définition de la liste</figcaption></div></figure>
Il attend en argument (zone de puzzle à droite) une liste. 

Nous allons lui donner une liste des modules Bluetooth disponibles grâce à notre Client Bluetooth installé (Section \ref{bluetooth_install}). 

Ce bloc est disponible dans le menu latéral, partie <b>BluetoothClient1</b>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/bluetooth_place.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Sélection du client Bluetooth</figcaption></div></figure>
Puis

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/client.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Sélection du bloc des adresses</figcaption></div></figure>
Au final, on obtient le bloc suivant : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/bloc1.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Bloc de configuration de la liste</figcaption></div></figure>
<h3>Connexion au module Bluetooth</h3>
Une fois que l'utilisateur a sélectionner le module auquel il souhaite se connecter, il faudra mettre à jour l'état de la liste et se connecter au module Bluetooth

<h4>Principe</h4>
Une fois que la personne a fait son choix dans "<b>Connexion</b>", on vérifie la couleur de l'arrière plan de <b>connexion</b> :
<ul>
    <li> Si la couleur est rouge (par défaut), cela veut dire que nous ne sommes pas connectés.
</li>
    On remplace donc le mot « Connexion » par l'adresse MAC<span title="L'adresse MAC est une adresse physique pour identifier de manière unique un composant." style='color:grey;'><sup>[Note 125]</sup></span> sélectionnée et on définit la couleur d'arrière-plan en vert, pour obtenir ceci :

    

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/mac.png' class='alignnone size-medium' style='max-width:50%;'><figcaption>Figure - Rendu de l'état de connexion</figcaption></div></figure>
    

    

Visuellement, on sait que nous sommes connectés. 

Ensuite,  pour se connecter réellement, on établit une connexion Bluetooth sécurisée à l'adresse donnée par la sélection de la liste «connexion». 

Quand c'est fait, on envoie en Bluetooth la lettre « c » que l'Arduino se chargera d'interpréter, et pourra, en conséquent, jouer une mélodie pour confirmer la connexion.

    

   

    <li> Si la couleur est verte , cela veut dire que nous sommes déjà connectés. Il faut donc remettre la couleur et le texte d'origine (« connexion ») et se déconnecter
</li>
    

</ul>
<h4>Emplacement des blocs</h4>
Dans le bloc <b>Quand connexion.Après prise</b>, nous allons avoir besoin d'une structure de contrôle, c'est à dire en l'occurrence un bloc conditionnel <b>Si-Alors-Sinon</b>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/ifelse.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Emplacement des blocs conditionnels</figcaption></div></figure>
Nous aurons également besoin d'un bloc de comparaison : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/equal.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Emplacement des blocs de comparaison</figcaption></div></figure>
Les blocs de couleurs sont disponibles à l'emplacement suivant : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/colors.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Emplacement des blocs de couleurs</figcaption></div></figure>
Enfin, les chaînes de caractères sont disponibles à l'emplacement suivant : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/string.png' class='alignnone size-medium' style='max-width:80%;'><figcaption>Figure - Emplacement des chaînes de caractères</figcaption></div></figure>
<div class='alert alert-success' ><h4>Astuce</h4> Pour savoir où se situe une instruction, il faut regarder le nom de l'instruction. Elle sera de la forme nomInstruction.fonction. Le "nomInstruction" sera affiché dans un des onglets de gauchePar exemple, pour "mettre Connexion.elements", il faut aller dans l'onglet "Connexion"</div>
Maintenant que vous savez ou trouver les blocs, je vous invite à recopier ce bloc d'instructions, qui n'est que la mise en pratique de la partie "Principe" de cette section

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/connect.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Gestion de la liste après sélection</figcaption></div></figure>
Le plus dur est fait, reste maintenant à gérer les boutons directionels.

<h3>Gestion des boutons de direction</h3>
Nous allons sélectionner le bouton <b>Avancer</b> dans le menu de gauche
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/zoom_bouton.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Menu du bouton Avancer</figcaption></div></figure>
 A l'intérieur de ce bloc, on mettra les instructions pour envoyer le mot « c » en Bluetooth 

Pour le langage Arduino, c'est l'équivalent de :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
if (bouton==appui) {allumer led ;}     

</code></pre><hr>
	        

Après, nous avons d'autres  paramètres (appui long, après avoir retiré le doig, sur le bouton...) 

Placez le "<b>Quand  avancer. Click</b>" sur la page blanche. 
Ensuite, nous allons vérifier si nous sommes connectés. Pour cela, nous mettrons un "<b>Si connexion.Couleur de fond = vert</b> » afin d’attester la connexion.
Enfin, sélectionnez l'onglet "<b>BluetoothClient1</b>" et insérez la fonction "<b>envoyer texte</b>" en mettant le mot "a" (comme avancer) en texte à envoyer. <span title="il faut privilégier de petites chaînes de caractère afin que le module puisse lire plus facilement. Il y a moins de perte de données" style='color:grey;'><sup>[Note 126]</sup></span> 
Pour obtenir ceci : 

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/bouton_avancer.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Code du bouton Avancer</figcaption></div></figure>
Il suffit de réaliser la même étape pour tous les boutons. Il faudra juste changer le "<b>Quand avancer.Click</b>" en "<b>Quand 'bouton'.Click</b>" et ne pas oublier de changer le texte à envoyer. 
Par exemple, un deuxième bouton donnerait :  ("g" pour gauche, "d" pour droite, "r" pour reculer, "s" pour stop, "b" pour batterie, "A" pour automatique)

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/bouton_gauche.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Code du bouton Gauche </figcaption></div></figure>
Après avoir fait ceci pour les autres boutons, l'application est terminée… 

Nous pouvons donc passer à l'installation de l'application sur votre téléphone

<h3>Installation de MIT App Inventor</h3>
Pour installer l'application que vous avez réalisé, il est préférable d'installer l'application MIT AI2 Companion disponible sur Play Store. 

Cette application (relativement légère (50 Mo) va faire le lien entre le site App Inventor et votre téléphone. 

Une fois que votre application est terminée, voici la façon la plus simple pour l'installer : 

<ul>
    <li> Installer MIT AI2 Companion sur votre téléphone 
</li>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/download.png' class='alignnone size-medium' style='max-width:50%;'><figcaption>Figure - Logo de l'application</figcaption></div></figure>
    <li> Lancer l'application MIT AI2 Companion lorsque'elle est installée <b>sur votre téléphone</b></li>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/mit.png' class='alignnone size-medium' style='max-width:40%;'><figcaption>Figure - Rendu de l'application MIT AI2 Companion</figcaption></div></figure>
    <li> Connecter vous au réseau Wifi de votre maison <b>depuis votre téléphone</b></li>
    <li> Ouvrez votre application (Cocci-Bot) dans App Inventor (<a class="alert-link">http://appinventor.mit.edu/</a>) <b>depuis votre ordinateur</b></li>
    <li> Rendez-vous dans le menu du haut, sélectionner <b>Construire</b> puis <b>App ( Donnez le code QR pour fichier .apk )</b></li>
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/build.png' class='alignnone size-medium' style='max-width:100%;'><figcaption>Figure - Emplacement du menu "Construire"</figcaption></div></figure>
    Une barre de progression devrait apparaître.

<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/progressbar.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - Barre de progression</figcaption></div></figure>
    Une fois la barre de progression disparue, un QR Code apparaît.  {\color{red}Ne surtout pas cliquer sur <b>ok</b>}
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/qrcode.png' class='alignnone size-medium' style='max-width:60%;'><figcaption>Figure - QR code</figcaption></div></figure>
    

   <li> Il est temps de scanner le code avec l'application MIT AI2 Companion sur votre téléphone ("Scan with QRCode"). Une fois le processus terminé, vous pouvez cliquer sur <b>ok</b>, il faudra suivre les consignes sur votre téléphone portable (gestion des autorisations...)</li>
   <li> Et voila !
</li>
    

</ul>
Nous pouvons passer au code Arduino et au traitement des données.

<h3>Branchements</h3>
Comme dit au chapitre \ref{appairage}, il faut relier le « +5V » du module au  5 Volts de la carte Arduino et la masse du module à celle de la carte.

Ensuite, nous allons relier la broche TX du module à la broche 12 de la carte et la broche RX à la broche 10. 

Voilà, le branchement est terminé.

<h3>Code Arduino</h3>
<div class='alert alert-warning' ><h4>Point-clé</h4>Afin de lire les données du module, nous allons "émuler" une voie série, en l’occurrence les broches 10 et 12. C'est-à-dire que nous allons déclarer que ces broches recevront et enverront des données.</div>
Pour cela, il faut utiliser la bibliothèque <b>SoftwareSerial</b>.
Dans le logiciel Arduino, allez dans <b>croquis</b> puis <b>inclure une bibliothèque</b>  et sélectionnez <b>SotfwareSerial</b>.
<figure id=''><div class='cent' style='text-align:center;'><img src='/cocci-bot/software.png' class='alignnone size-medium' style='max-width:70%;'><figcaption>Figure - Inclusion de la bibliothèque SoftwareSerial</figcaption></div></figure>
Maintenant, nous allons définir les broches du module (toujours avant le « void setup ») :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
const int RX = 10;

const int TX = 12

</code></pre><hr>
Après ceci, il faut déclarer un objet <b>SoftwareSerial</b>  qui prendra en argument respectivement les broches TX et Rx, un peu comme lors de la déclaration d'un écran LCD (« LiquidCrystal lcd (RS,E,D4,D5,D6,D7); »).
On obtient donc :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
#include <SoftwareSerial.h>

const int RX = 10;

const int TX = 12;

SoftwareSerial crius(RX,TX);

</code></pre><hr>
Bien entendu, "crius" peut être remplacé par ce que vous voulez. 

Ensuite, on déclare que la communication carte-module peut débuter  avec "crius.begin(115200) ;"

Où 115200 correspond à la vitesse de transmission en bauds (comme "Serial.begin(115200);") ;

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
SoftwareSerial crius(RX,TX);

void setup() {

    crius.begin(115200);

}

</code></pre><hr>
<div class='alert alert-danger' ><h4>Remarque importante</h4>Par la suite, en cas d'erreurs de transmission Bluetooth (pas de données...), il conviendra de vérifier le branchement des broches RX et TX (essayer de les intervertir) et d'éventuellement changer la vitesse de communication  car certains modules communiquent à 9600 bauds !</div>
Pour lire les données du module, ce sont presque les mêmes fonctions que pour le port série : 

En effet : 

Pour le port série :		

<ul>
    <li> Serial,begin(115200);
</li>
    <li> Serial.available();
</li>
    <li> Serial.read();	
</li>
    <li> Serial.print();
</li>
    <li> Serial.println();
</li>
</ul>
Pour le module Bluetooth : 

<ul>
    <li> crius,begin(115200);
</li>
    <li> crius.available();
</li>
    <li> crius.read();	
</li>
    <li> crius.print();
</li>
    <li> crius.println();
</li>
    

</ul>
Tant que des données (caractères) sont disponibles, nous allons les assembler en une chaîne de caractère (concaténation). 

Ensuite, avec un <b>if</b>, nous allons voir si cette chaîne en question correspond par exemple à "a".  
Si c'est la cas, nous allons appeler la fonction <b>robot.enAvant(100);</b> 
Il faut donc définir un caractère x et une chaîne de caractère.

Donc dans le programme Arduino, avant la fonction <b>setup</b>, on rajoute :
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
#include <SoftwareSerial.h>

const int RX = 10;

const int TX = 12;

char c;

String message;

</code></pre><hr>
La boucle while va permettre de lire les données : 

Dans la boucle <b>loop</b> : on écrit :
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
 void loop() {

 

    while() {

    

    }//Fin while

 }//Fin void loop

</code></pre><hr>
Maintenant que la boucle va attendre des données, il suffit de les lire et de les transformer en chaîne de caractère. 

Pour cela : 

<ul>
    <li> on lit le premier caractère c
</li>
    <li> on définit que la chaîne message = message + c 
</li>
</ul>
On obtient :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
 void loop() {

 

    while(crius.available()>0) {

    

        c = crius.read();

        message = message + c;

    }//Fin while

 }//Fin void loop

</code></pre><hr>
La structure conditionnelle est très simple : 

Après la boucle « while », mettez : 

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
 void loop() {

 

    while(crius.available()>0) {

    

        c = crius.read();

        message = message + c;

    }//Fin while

    

    if(message=="c") {

    

        message="";

        Melodie(1);

    }//Fin if message=="c"

 }//Fin void loop

</code></pre><hr>
« c » correspond au message envoyé par l'application lors de l'appui du bouton connexion.

{\color{red} Attention !!! il est important de vider la chaîne de caractère avec "message= '' '' ;", sinon, lorsque le module recevra un autre message (par exemple "s"), la chaîne sera égale à "cs"} 

Après avoir fait ceci pour les boutons connexion, avancer, droite, gauche, stop, batterie et reculer, voici le résultat :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
void loop() {

 

    while(crius.available()>0) {

    

        c = crius.read();

        message = message + c;

    }//Fin while

    

    if(message=="c") {

    

        message="";

        Melodie(1);

    }//Fin if message=="c"

  if(message=="c")  {message=""; 

                    Melodie(1);}

                                

  else if(message=="a"){message="";             

                        robot.enAvant(100);

                        etatMoteurs=true;}

                                

  else if(message=="r")   {message="";

                           robot.enArriere(100);

                           etatMoteurs=false;}  

                                                      

  else if(message=="d")   {message="";            

                           robot.tourneDroite(100);

                           etatMoteurs=true;}

                                

  else if(message=="g")    {message="";           

                            robot.tourneGauche(100);} 

                                

  else if(message=="s") {message="";          

                              robot.arret();}

                                

  else if(message=="b")  {message="";              

                          TestBatterie();}        

                                                           

  else if(message=="A")  {gestion_mouvement();}   

  

  }//Fin void loop

</code></pre><hr>
Pour finir, nous allons nous occuper de la partie automatique, qui s'activera avec l'appui sur le bouton auto. 

Le début est le même, avec le <b>if</b>, en revanche, cette fois-ci, nous ne viderons pas la chaîne de caractère.
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
 void gestion_mouvement() {

  while(message=="A") {

  robot.enAvant(100);

    

    distance = moyenneMesure(30, A2);

    fin_automatique(); 

    if(distance>500) {

      robot.tourneGauche(100);

      delay(1500);

      distance = moyenneMesure(30, A2);

      fin_automatique(); 

      if(distance>500) {

        robot.tourneDroite(100);

        delay(3000);

        distance = moyenneMesure(30, A2);

        fin_automatique(); 

        if(distance>500) {

            robot.tourneGauche(100);

            delay(1500);

        }

        else{robot.enAvant(100);}

      }                

      else  {robot.enAvant(100);}   

    }

     else {robot.enAvant(100);}  

 }//fin while

 }//fin gestion mouvement

</code></pre><hr>
On remarque que dans cette fonction, il y a une boucle "while".

La boucle "while(message== "A") {}"  s’exécutera tant que l'on n’appuiera pas sur un autre bouton ; 

En effet, si j'appuie sur le bouton stop, la chaîne message ne sera plus égale à "A", la boucle "while" ne sera plus respectée et le robot s’arrêtera. 

Afin de sortir de la boucle "while", il faut intercaler dans l'algorithme plusieurs fois une fonction <b>fin automatique</b> » qui comprend :
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
 void fin_automatique() {

if(bluetooth.available()>0) {

  robot.arret();

  message="";

  etatMoteurs=false;

}//fin if

}//fin fin_automatique

</code></pre><hr>
Dès qu'une donnée est présente, cela arrête le robot, vide la chaîne de caractère. Le programme revient donc à la boucle "while" de départ, au tout début du <b>void loop</b>.
Si vous voulez ajouter un bouton sur l'application, vous savez le faire.

Pour ajouter ce bouton dans le code Arduino, il suffit de rajouter une ligne :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
if(message=="valeur envoyée depuis l'application")   {message="";             

                           action();}

</code></pre><hr>
<h3>Conclusion</h3>
Le programme complet du cocci-bot, l'application (que vous pourrez modifier) ainsi que les branchements se situent en annexe du dossier

</body></html>