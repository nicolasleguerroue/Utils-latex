<html><head><style>.cent {  display: block;  margin-left: auto;  margin-right: auto;}</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous"><script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"> </script><body style='margin-left:5%;margin-right:5%;margin-top:1%'><h4>Fichier générer depuis les sources Latex</h4><h5>Auteur : Nicolas Le Guerroué</h5><a href='index.html'><button class='btn btn-success' >Revenir au sommaire</button></a><hr><h1 class=''>ESP8266</h1>
<h2 >Introduction</h2>     
<h3>Présentation</h3>
Cette partie a pour but de configurer un ESP8266-12E (NodeMCU) afin que ce dernier puisse être accessible en tant que réseau Wifi.

Ce tutoriel s'adresse également dans le cas où vous avez perdu vos mots de passe d'accès (réseau wifi ou WebRepl) ou bien que vous souhaitez partir sur des bases saines.

<div class='alert alert-success' ><h4>Information</h4>Le temps estimé pour configurer l'ESP8266 est de 25 min</div>
<h3>Conventions</h3>
<h4>Commandes</h4>
Les commandes à saisir sont dans des encadrés similaires : 

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
sudo apt-get update

</code></pre><hr>
<h4>Références et repères</h4>
Dans un souci de clarté : 

<ul>
	<li> Les fichiers sont indiqués par le repère <span class='badge badge-primary'>nom du fichier</span></li>
	<li> Les dossiers sont indiqués par le repère <span class='badge badge-light'>nom du dossier</span></li>
	<li> Les touches du clavier et le texte à saisir au clavier sont indiqués par le repère <span class='badge badge-light'>Raccourci clavier ou texte à saisir</span></li>
	<li> Les bibliothèques, logiciels et utilitaires sont indiqués par le repère <span class='badge badge-success'>nom de l'utilitaire</span></li>
</ul>
<h2 >Pré-requis</h2>
<h3>Matériel</h3>
Pour réaliser ce tutoriel, vous aurez besoin de 

<ul>
    <li> Un ordinateur (Linux, Apple ou Windows)
</li>
    <li> Un ESP8266 (NodeMCU)
</li>
    <li> Un câble USB Micro Type-B
</li>
<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/usb.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/usb.png' class='alignnone size-medium' style='max-width:20%;'></a><figcaption>Figure - Un câble USB Micro type-B</figcaption></div></figure>
    

</ul>
<h3>Mise à jour des systèmes UNIX</h3>
Avant toute chose, il convient de mettre à jour la liste des paquets et de mettre à jour les logiciels déjà présents sur votre 

ordinateur si ce dernier est sous LINUX (UNIX). 

Les commandes suivantes sont à saisir dans un terminal.

<h4>Mise à jour de la liste des paquets</h4>
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
sudo apt-get update

</code></pre><hr>
<h4>Mise à jour des logiciels</h4>
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
sudo apt-get -y upgrade

</code></pre><hr>
<u>Le -y sert à accepter automatiquement la mise à jour.</u>
<h4>Mise à jour de Python</h4>
Il conviendra d'installer au minimum la version 3.6 de Python. 

Pour vérifier votre version, ouvrez un terminal et saisissez la commande 

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
python3

</code></pre><hr>
Si l'invité de commande Python suivant apparaît, la version est présente. 

Pour quitter l'interpréteur python, il suffit de saisir <span class='badge badge-light'>exit()</span> dans l'interpréteur ou bien de faire <span class='badge badge-light'>Ctrl  +z</span>
<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/python.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/python.png' class='alignnone size-medium' style='max-width:60%;'></a><figcaption>Figure - Invité de commande Python</figcaption></div></figure>
Le cas échéant, je vous invite à saisir la commande suivante :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
sudo apt-get -y install python3.7

</code></pre><hr>

<h4>Effacer la mémoire de l'ESP8266</h4>
Dans un premier temps, nous allons effacer le contenu de la puce ESP8266. Ceci nous permettra de partir sur des bases saines. 

Il convient ensuite d'installer les outils adéquats.

<h4>Installation de Pip3</h4>
<span class='badge badge-success'>pip3</span> est un utilitaire Python qui va nous permettre d'installer le petit programme pour effacer l'ESP8266. 
On l'installe de la manière suivante : 

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
sudo apt-get -y install python3-pip

</code></pre><hr>
<h4>Installation de Esptool</h4>
L'utilitaire qui va se charger d'exécuter cette opération s'appelle <span class='badge badge-success'>esptool</span>.
Pour l'installer, on effectue

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
pip3 install esptool

</code></pre><hr>
Voici le résultat de la commande sur le terminal : 

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/esptool_download.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/esptool_download.png' class='alignnone size-medium' style='max-width:28%;'></a><figcaption>Figure - Résultat de l'installation de pip3</figcaption></div></figure>
<h4>Récupération du port USB</h4>
L'ESP8266 étant raccordé, l'ordinateur lui a affecté un nom de port de type <i>/dev/ttyUSBx</i> avec x représentant le numéro du 
périphérique USB. 

Pour récupérer la valeur de ce numéro, nous allons lancer la commande suivante : 

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
ls /dev/ttyUSB*

</code></pre><hr>
<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/lsusb.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/lsusb.png' class='alignnone size-medium' style='max-width:80%;'></a><figcaption>Figure - Résultat de la commande</figcaption></div></figure>
Dans le cas présent,le nom du port est <i>/dev/ttyUSB0</i>
<h4>Effacer la mémoire</h4>
Lancer la commande suivante : 

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
esptool.py --port /dev/ttyUSB0 erase_flash

</code></pre><hr>
Évidemment, si vous avez un autre numéro de port avec la commande <b>esptool.py flash id</b>, vous mettez votre numéro.
Voici le résultat de la commande sur le terminal : 

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/esptool_erase.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/esptool_erase.png' class='alignnone size-medium' style='max-width:60%;'></a><figcaption>Figure - Résultat de la commande pour effacer l'ESP8266</figcaption></div></figure>
<h2 >Installer le firmware sur l'ESP8266</h2>
Maintenant que l'ESP8266 est vide, il nous reste à installer son logiciel (firmware) fin qu'il puisse utiliser le Wifi selon 

deux modes : 

<ul>
    <li> Point d'accès : l'ESP8266 créer son propre réseau Wifi
</li>
    <li> Connexion : l'ESP8266 peut se connecter à un réseau Wifi pour dialoguer
</li>
</ul>
<h4>Récupération du logiciel</h4>
Le logiciel se présente sous fichier binaire (.bin) et est disponible à l'adresse suivante : 

Je vous invite à télécharger la dernière version stable (latest)

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/esplatest.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/esplatest.png' class='alignnone size-medium' style='max-width:55%;'></a><figcaption>Figure - Récupération du logiciel pour l'ESP8266</figcaption></div></figure>
<h4>Installation du logiciel</h4>
<b>Tout d'abord, placez vous dans le même répertoire que votre fichier binaire installé précédemment et ouvrez un terminal.</b> 
La commande <span class='badge badge-light'>ls</span> devrait confirmer votre contenu du répertoire.
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
ls

</code></pre><hr>
<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/ls.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/ls.png' class='alignnone size-medium' style='max-width:70%;'></a><figcaption>Figure - Contenu du répertoire</figcaption></div></figure>
Il ne vous reste plus qu'a saisir la commande pour installer le firmware. 

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
esptool.py --port /dev/ttyUSB0 --baud 460800 write_flash --flash_size=detect 0 esp8266-20190125-v1.10.bin

</code></pre><hr>
Comme précédemment, si vous avez un nom de fichier différent, je vous laisse le soin de changer de nom afin de coïncider avec le vôtre.

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/espinstall.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/espinstall.png' class='alignnone size-medium' style='max-width:45%;'></a><figcaption>Figure - Résultat de la commande pour installer le firmware</figcaption></div></figure>
Après le déploiement du firmware, le module redémarre et il est configuré en point d’accès WiFi avec pour nom <b>MicroPython-6953</b>.  Les chiffres correspondent aux quatre derniers chiffres de l'adresse MAC du module. 
<h2 >Configurer le mot de passe WebRepl</h2>
<h4>Installation de WebRepl</h4>
Le logiciel <span class='badge badge-success'>WebRepl</span> va nous permettre de se connecter à l'ESP8266 afin de saisir des commandes Python.
Le logiciel est disponible à l'adresse suivante : 

Cliquez ensuite sur <span class='badge badge-light'>Code</span> puis <span class='badge badge-light'>Download Zip</span>
<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/github.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/github.png' class='alignnone size-medium' style='max-width:45%;'></a><figcaption>Figure - Téléchargement de WebRepl sur Github</figcaption></div></figure>
Veuillez commencer par extraire l'archive.

Celle-ci contient les fichiers suivants : 

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/webrepl.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/webrepl.png' class='alignnone size-medium' style='max-width:45%;'></a><figcaption>Figure - Contenu du dossier WebRepl</figcaption></div></figure>
<h4>Installation de screen</h4>
<span class='badge badge-success'>screen</span> est un utilitaire qui va nous permettre de se connecter à l'ESP8266 via le câble USB car actuellement, il nous est impossible d'utiliser WebRepl.
On installe l'utilitaire avec la commande suivante : 

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
sudo apt-get install -y screen

</code></pre><hr>
<h4>Création du mot de passe</h4>
<h4>Utilisation de screen</h4>
On peut accéder à l’interpréteur de commande Python REPL <span title="Read Evaluate Print Loop" style='color:grey;'><sup>[note]</sup></span> via le port série en tapant la commande suivante dans un terminal :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
screen /dev/ttyUSB0 115200

</code></pre><hr>
<div class='alert alert-warning' ><h4>Point-clé</h4>Il faut appuyer sur la touche Entrée pour afficher l'invité de commande MicroPython.</div>
<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/console.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/console.png' class='alignnone size-medium' style='max-width:60%;'></a><figcaption>Figure - Console screen</figcaption></div></figure>
Pour quitter Screen, il faut appuyer sur les touches <span class='badge badge-light'>CTRL + a</span> puis écrire <span class='badge badge-light'>:quit</span> 
Ensuite, entrez la commande suivante via le terminal Screen :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
>>> import webrepl_setup

</code></pre><hr>
Le système vous demande tout d'abord d’activer l’accès par le réseau Wifi dès le démarrage en saisissant <span class='badge badge-light'>E</span>.
<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/enable.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/enable.png' class='alignnone size-medium' style='max-width:60%;'></a><figcaption>Figure - Activation de l'ESP8266 screen</figcaption></div></figure>
Il vous invite ensuite à saisir le mot de passe pour l'accès à WebRepl. Ici le mot de passe choisi est <span class='badge badge-light'>crepp</span>
<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/password.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/password.png' class='alignnone size-medium' style='max-width:60%;'></a><figcaption>Figure - Activation de l'ESP8266 screen</figcaption></div></figure>
Enfin, saisissez <span class='badge badge-light'>y</span> pour redémarrer l'ESP8266.
A ce moment là, les lignes suivantes apparaissent : 

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/end.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/end.png' class='alignnone size-medium' style='max-width:60%;'></a><figcaption>Figure - Fin de la configuration</figcaption></div></figure>
<b>La configuration de l'ESP8266 est terminée</b>
<h4>Connexion à WebRepl</h4>
<h4>Connexion au réseau de l'ESP8266</h4>
Tout d'abord, veuillez chercher parmi les réseaux Wifi le réseau de l'ESP8266 appelé MicroPython-XXXX avec XXX représentant les 4 derniers chiffres de l'adresse MAC de l'ESP8266.

Lors de la connexion, un mot de passe est demandé, saisir <span class='badge badge-light'>micropythoN</span>
<h4>Lancement de WebRepl</h4>
 Veuillez lancer, à l'aide de votre navigateur Internet, le fichier <span class='badge badge-primary'>webrepl.html</span>  situé dans le dossier WebRepl précédemment installé. 
 Pour cela, veuillez faire un <span class='badge badge-light'>Click droit + "Ouvrir avec le navigateur Web ..."</span>. 
Vous tombez sur l’interface Web. Il suffit de cliquer sur <span class='badge badge-light'>Connect</span> et d’entrer le mot de passe que vous avez définie.
(en l'occurrence <b>crepp</b>).
<h2 >Connexion à un réseau Wifi</h2>
L’inconvénient avec la méthode présente est de jongler entre les 2 accès WiFi (Wifi classique ou réseau ESP8266).

Or, il est possible de configurer le module pour qu’il se connecte sur votre box WiFi en tant que client afin d'éviter les désagréments des connexions WiFi. 

Pour cela il suffit de se connecter à l'ESP8266 via le port série et de taper les commandes suivantes : 

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
import network

wlan = network.WLAN(network.STA_IF)

wlan.active(True)

wlan.connect('ssid', 'password')

</code></pre><hr>
Vous pouvez vérifier la nouvelle adresse IP fournie par votre box en tapant la commande :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
>>> wlan.ifconfig()

</code></pre><hr>
Par contre il est nécessaire de passer les commandes suivantes après la connexion à votre box :

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
>>> import webrepl

>>> webrepl.start()

</code></pre><hr>

 

<h2 >Un serveur Web avec ESP12</h2>
 
L'objectif de ce chapitre est de créer un serveur Web pour contrôler la led interne de l'ESP12, une carte basée sur les ESP8266 

(Broche D4)

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/led_esp.jpg'><img src='http://www.crepp.org/wp-content/uploads/2022/08/led_esp.jpg' class='alignnone size-medium' style='max-width:40%;'></a><figcaption>Figure - La led interne de l'ESP</figcaption></div></figure>
<h3>Architecture du mini-projet</h3>
Pour communiquer entre le client (utilisateur) et l'ESP12, nous utiliserons un routeur qui servira de passerelle.

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/arch.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/arch.png' class='alignnone size-medium' style='max-width:40%;'></a><figcaption>Figure - Architecture du projet</figcaption></div></figure>
L'ESP12 se connecte dans un premier temps au routeur. 

Une fois connecté, tout client sur le même réseau peut se connecter à l'ESP12 en saisissant l'adresse de 

l'ESP12 dans le navigateur.

<h3>Base des requêtes</h3>
Dès que nous allons sur une page Web, nous faisons une requête, c'est à dire que l'on va demander l'affichage 

d'une page Web à un serveur distant.

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/serveur.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/serveur.png' class='alignnone size-medium' style='max-width:70%;'></a><figcaption>Figure - Architecture client-serveur</figcaption></div></figure>
Afin de récupérer une page sur le serveur, nous avons besoin de connaitre 3 élements :

<ul>
    <li> L'adresse IP <span title="Internet Protocol : Adresse d'une machine sur un réseau" style='color:blue;'>IP</span> ou l'adresse du serveur : Ici ce sera l'adresse IP de l'ESP12
</li>
    <li> L'emplacement de la page sur le serveur : L'emplacement '/' désigne la racine du serveur
</li>
    <li> Le port de communication entre le client et le serveur : <span style='background-color:blue;opacity:60%;color:white;' class='badge badge-pill'>80</span> par défaut pour 
</li>
    le protocole HTTP<span title="le protocole HTTPS utilise le port 443" style='color:grey;'><sup>[note]</sup></span>   <span title="Hypertext Transfer Protocol : Protocole de transfert hypertexte" style='color:blue;'>HTTP</span>
</ul>
<h4>Une petite explication sur les ports</h4>
Pour recevoir et transmettre des données à d’autres ordinateurs, un ordinateur (ou serveur) a

besoin de ports. Cependant, les ports physiques tel que le port Eternet communiquent avec beaucoup de services.

Ainsi, des ports virtuels ont été créés. 

Chaque port virtuel est codé sur 16 bits et permet de faire communiquer un service

ou un logiciel.<span title="Par exemple, le service SSH communique sur le port 22" style='color:grey;'><sup>[note]</sup></span>. Il y a donc potentiellement

65536 ports disponibles. Certains numéros de port sont réservés à certains services 

Les ports de 0 à 1023 sont déjà réservés à des services particuliers et le port par défaut pour les serveurs Web est le 80.

<h4>Les types de requêtes</h4>
Lorsque nous nous connectons à un serveur Web, nous faisons principalement deux types de requêtes\footnote{Les webSockets ne 

seront pas abordées}

<ul>
<li> Requêtes GET
</li>
Les requêtes GET sont des requêtes avec des éléments passés via l'URl de la page.

Elles sont donc visibles via la barre d'adresse: 

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/led.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/led.png' class='alignnone size-medium' style='max-width:70%;'></a><figcaption>Figure - L'adresse avec la requête GET</figcaption></div></figure>
Chaque élément est séparé avec le symbole \lbl{blue}{LBL}{\&} et la liste des arguments commencent avec le symbole  <span style='background-color:blue;opacity:60%;color:white;' class='badge badge-pill'>?</span>

Comme nous avons un seul élément passé via l'URl, nous n'avons pas le symbole <span style='background-color:blue;opacity:60%;color:white;' class='badge badge-pill'>\&</span>

Ici, nous avons un argument \lbl{blue}{ARG}{LED} avec la valeur <span style='background-color:green;opacity:60%;color:white;' class='badge badge-pill'>OFF</span>

<li> Requêtes POST
</li>
Ces requêtes ne passent pas les arguments via l'adresse URl. Cette section ne sera pas abordée dans le cadre de l'atelier.

</ul>
<h3>Connexion au routeur</h3>
La carte ESP12 a besoin du nom du routeur ainsi que de son mot de passe. 

Dans le programme <span style='background-color:green;opacity:60%;color:white;' class='badge badge-pill'>serveur Web simple.ino</span>, il faut préciser le nom et le mot de passe sur les lignes suivantes : 

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
//Par exemple

const char* ssid     = "Creafab_invite";

const char* password = "MonTraficEstJournalise";

//Il faut mettre le nom du routeur chez soi et le mot de passe associé

</code></pre><hr>
<h3>Lancement du programme</h3>
Pour sélectionner la carte ESP12, veuillez vous reporter à l'annexe <b>UTILISATION DE L’ESP12 SOUS ARDUINO</b>.
<div class='alert alert-warning' ><h4>Remarque</h4>Il faudra activer la liaison série de la carte. Pour cela, lors du choix de la carte dans le logiciel Arduino, dans la section Outils - Types de cartes -  ESP12 NodeMCU, il faut bien vérifier que la case Serial est activée </div>
Une fois le programme téléversé, il vous faudra récupérer l'adresse IP de l'ESP12.

Pour cela, une fois que le code est téléversé, veuillez ouvrir la fenêtre du moniteur série, l’adresse IP de l'ESP va apparaître 

au bout de quelques secondes.

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/port_serie.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/port_serie.png' class='alignnone size-medium' style='max-width:45%;'></a><figcaption>Figure - Affichage de l'adresse IP</figcaption></div></figure>
Si aucune données n’apparaît, faite un reset de la carte ESP12 en appuyant sur la touche <span style='background-color:red;opacity:60%;color:white;' class='badge badge-pill'>RST</span> de la carte.

Il ne vous reste plus qu'à rentrer l’adresse IP obtenue dans un navigateur internet.

En l’occurrence, l'adresse IP dans ce cas là est <span style='background-color:green;opacity:60%;color:white;' class='badge badge-pill'>192.168.0.102</span>

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/ip.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/ip.png' class='alignnone size-medium' style='max-width:60%;'></a><figcaption>Figure - Connexion au serveur</figcaption></div></figure>
Le résultat doit être le suivant 

<figure id=''><div class='cent' style='text-align:center;'><a href='http://www.crepp.org/wp-content/uploads/2022/08/serveurWeb.png'><img src='http://www.crepp.org/wp-content/uploads/2022/08/serveurWeb.png' class='alignnone size-medium' style='max-width:60%;'></a><figcaption>Figure - Résultat</figcaption></div></figure>
<h3>Explication du programme</h3>
<b>Une explication du langage HTML est disponible en annexe (section HTML)</b>
<h4>En tête du code</h4>
Après avoir importé les bibliothèques liées à l'ESP12, nous définissons un objet <b>ESP8266WebServer</b> qui attend 
comme argument le port du serveur, c'est à dire le 80.

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
#include <ESP8266WiFi.h>

#include <ESP8266WebServer.h>

#include <ESP8266mDNS.h>

        

#define PORT 80 //Port par défaut

#define LED D4  //Broche de la LED

        

ESP8266WebServer server(PORT);

</code></pre><hr>
On précise ensuite le mot de passe et le nom du routeur de communication.

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
const char* ssid     = "Nom-reseau-Internet";

const char* password = "Mot-de-passe-Routeur";

</code></pre><hr>
Ensuite, nous allons définir et créer notre page HTML.

Deux versions de pages Web seront proposées:

<ul>
    <li> Une version minimale sans aucune mise en forme ajoutée.
</li>
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
        const String minimalPageContent = "<html>\

        <head>\

            <title>Serveur Web CREPP</title>\

            <meta charset=\"utf-8\"/> \

            </head>\

            <body>\

            <h1>Led ESP8266</h1><br>\

                <h3>Contrôle de la LED sur la broche D4</h3><br>\

                  <a href=\"/?LED=ON\"><button >Allumer</button></a>\

                  <a href=\"/?LED=OFF\"><button >Eteindre</button></a>\

              </body>\

            </html>";

</code></pre><hr>
        <li> Une version plus élaborée en utilisant la bibliothèque <span style='background-color:green;opacity:60%;color:white;' class='badge badge-pill'>Bootstrap</span> qui permet de faire de 
</li>
        jolies mises en forme très facilement.

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
            const String fullPageContent = "<html>\

            <head>\

              <title>Serveur Web CREPP</title>\

              <meta charset=\"utf-8\"/> \

              <link rel=\"stylesheet\" href=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\" integrity=\"sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\" crossorigin=\"anonymous\">\

            </head>\

            <body style=\"margin-left:5%;\">\

              <h1>Led ESP8266</h1><br>\

              <h3>Contrôle de la LED sur la broche <span class=\"badge badge-secondary\">D4</span></h3><br>\

                <a href=\"/?LED=ON\"><button class=\"btn btn-success\">Allumer</button></a>\

                <a href=\"/?LED=OFF\"><button class=\"btn btn-danger\">Eteindre</button></a>\

            </body>\

          </html>";

</code></pre><hr>
</ul>
<h4>Fonctionsetup</h4>
Lançons nous dans le code de la fonction <b>setup</b>
On définit la led en sortie et on se connecte au routeur.

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
void setup() {

      

    pinMode(LED, OUTPUT);       //LED en sortie

    digitalWrite(LED, LOW);     //LED éteinte

    Serial.begin(115200);       //Communication à 115200 bits/s

    WiFi.begin(ssid, password); //Connexion

    Serial.println("");         //Retour à la ligne

        

</code></pre><hr>
Puis on vérifie que nous sommes bien connecté et on affiche les informations de connexion.

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
    while (WiFi.status() != WL_CONNECTED) 

    {

        delay(500);

        Serial.println(">>> Impossible de se connecter au réseau...");

    }//Fin while

      

    Serial.print(">>> Connexion au réseau ");

    Serial.println(ssid);

    Serial.print("avec l'adresse IP : ");

    Serial.println(WiFi.localIP());            

</code></pre><hr>
Enfin on vérifie que le MDSN<span title="Multicast DNS, un serveur de résolution de nom de domaine" style='color:grey;'><sup>[note]</sup></span> est activé (optionnel)

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
    if (MDNS.begin("esp8266")) {   //Multicast DNS 

    Serial.println(">>> Serveur MDNS activé");

    }

}           

</code></pre><hr>
On définit (toujours dans le setup) les pages accessibles par le client ainsi que la fonction appelée lors de la requête.

Il s'agit de l'emplacement <b>'/'</b> et sa fonction associées est la fonction <b>mainPage</b>
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
    server.on("/", mainPage);           //Affichage de la page principale si requête sur '/' -> saisir IP dans le navigateur

</code></pre><hr>
On redirige également l'utilisateur sur une page dédiée si l'adresse demandée n'existe pas.

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
    server.onNotFound(notFoundPage);    //Affichage de la page d'erreur si adresse non valide

</code></pre><hr>
Enfin, on initialise le serveur.

<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
    server.begin();                     //Initialisation du serveur

    Serial.println(">>> démarrage du serveur");

</code></pre><hr>
<h4>Fonction loop</h4>
Le code à l'intérieur de la fonction <b>loop</b> se contente de gérer de manière transparente le comportement du serveur.
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
void loop() 

{

    server.handleClient(); //Gestion des clients sur le serveur

}//Fin loop

</code></pre><hr>
<h3>Code complet</h3>
<hr><pre style='background-color:#F5F5F5;padding-left:1em;'><code>
#include <ESP8266WiFi.h>

#include <ESP8266WebServer.h>

#include <ESP8266mDNS.h>

    

#define PORT 80 //Port par défaut

#define LED D4  //Broche de la LED

    

ESP8266WebServer server(PORT);

    

const char* ssid     = "Nom-reseau-Internet";

const char* password = "Mot-de-passe-Routeur";

    

//Page principale

const String minimalPageContent = "<html>\

<head>\

    <title>Serveur Web CREPP</title>\

    <meta charset=\"utf-8\"/> \

    </head>\

    <body>\

    <h1>Led ESP8266</h1><br>\

        <h3>Contrôle de la LED sur la broche D4</h3><br>\

          <a href=\"/?LED=ON\"><button >Allumer</button></a>\

          <a href=\"/?LED=OFF\"><button >Eteindre</button></a>\

      </body>\

    </html>";

    

    const String fullPageContent = "<html>\

      <head>\

        <title>Serveur Web CREPP</title>\

        <meta charset=\"utf-8\"/> \

        <link rel=\"stylesheet\" href=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\" integrity=\"sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\" crossorigin=\"anonymous\">\

      </head>\

      <body style=\"margin-left:5%;\">\

        <h1>Led ESP8266</h1><br>\

        <h3>Contrôle de la LED sur la broche <span class=\"badge badge-secondary\">D4</span></h3><br>\

          <a href=\"/?LED=ON\"><button class=\"btn btn-success\">Allumer</button></a>\

          <a href=\"/?LED=OFF\"><button class=\"btn btn-danger\">Eteindre</button></a>\

      </body>\

    </html>";

    

    

void setup() {

      

    pinMode(LED, OUTPUT);       //LED en sortie

    digitalWrite(LED, LOW);     //LED éteinte

    Serial.begin(115200);       //Communication à 115200 bits/s

    WiFi.begin(ssid, password); //Connexion

    Serial.println("");         //Retour à la ligne

    

      

    while (WiFi.status() != WL_CONNECTED) 

    {

        delay(500);

        Serial.println(">>> Impossible de se connecter au réseau...");

    }

      

    Serial.print(">>> Connexion au réseau ");

    Serial.println(ssid);

    Serial.print("avec l'adresse IP : ");

    Serial.println(WiFi.localIP());

    

    if (MDNS.begin("esp8266")) {   //Multicast DNS 

        Serial.println(">>> Serveur MDNS activé");

    }

    

    server.on("/", mainPage);           //Affichage de la page principale si requête sur '/' -> saisir IP dans le navigateur

    server.onNotFound(notFoundPage);    //Affichage de la page d'erreur si adresse non valide

    

    server.begin();                     //Initialisation du serveur

    Serial.println(">>> démarrage du serveur");

      

}//Fin setup

    

void loop() 

{

      

    server.handleClient(); //Gestion des clients sur le serveur

     

}//Fin loop

    

    

void mainPage() //Page principale

{ 

    

    if(server.arg("LED")=="ON") //Lecture de l'argument 'LED'

    {

         digitalWrite(LED, LOW); //On allume la led

    }//Fin if

    else if(server.arg("LED")=="OFF")

    {

        digitalWrite(LED, HIGH);   //On eteint la led

    }//Fin else if

    else {

     //nothing

    }

    server.send(200, "text/html", fullPageContent); //On envoie la page principale

      

}//FIn mainPage

    

    

void notFoundPage()  //Gestion si mauvaise URL

{

    server.send(404, "text/plain", "Page introuvable !\n\n");

      

}//Fin notFoundPage

</code></pre><hr>

</body></html>