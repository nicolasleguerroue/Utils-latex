\chapter{Remerciements}



Je souhaite remercier tout particulièrement Quentin L'HELGUEN, mon tuteur de stage et responsable de mon suivi sur la partie software des balises, Benjamin ADAM, responsable de la partie hardware ainsi que Stéphane JINCHELEAU, manager du service Recherche et Développement au sein d'Orolia. Leur aide m'a été très précieuse pour les demandes et questions posées tout au long du stage.\\

Je remercie également l'ensemble du personnel d'Orolia et plus particulièrement le service Recherche et Développement ainsi que Marion AUDREN du service des Ressources Humaines.\\

Enfin, je remercie Vincent KERHOAS, tuteur académique de l'ENIB.\chapter{Résumé}

      Ce rapport vise à présenter le travail réalisé tout au long des cinq mois de stage au sein d'Orolia.\\ Le sujet porte sur la gestion des alimentations des balises de détresse. Pour ce stage, j'ai donc dans un premier temps caractérisé le système actuel d'alimentation (modules convertisseurs...). Une fois cette première phase menée, mon stage s'est porté sur le système d'alimentation utilisé pour fournir des courants élevés à basse température.\\  
      En suivant un cahier des charges donné par l'entreprise, j'ai cherché un composant sur le marché pour répondre aux contraintes et j'ai pu caractériser, simuler et tester ce composant.\\
      %Après avoir analysé les performances des batteries des balises, la dernière phase avait pour objectif d'améliorer l'autonomie des balises.\\
      
       
    
    The purpose of this document is to present the work achieved for these five months to Orolia.\\
    The subject is about the power management on the distress beacons.\\ First of all, I studied existing system of power to get characteristics then I focused on the system to get high currents at low temperature. At the end, I analysed battery efficiency and I tried to search a component to replace the system according to speficications given by company.\chapter{Présentation de l'entreprise}

\section{Le groupe Orolia}

\subsection{Les domaines d'activité}

Le groupe Orolia regroupe 3 grands domaines d'activités : 

\begin{items}{blue}{\Circle}
  \item Les horloges atomiques
  \item Les balises de détresse 
  \item Les simulateurs \glossary{GNSS}  (Global Navigation Satellite System)
\end{items}

Orolia fait partie des leaders mondiaux dans les domaines des balises de détresse aéronautiques et militaires.\\
Le groupe est numéro un mondial pour les horloges de précision (horloges atomiques), et numéro deux pour les simulateurs.\\

Le groupe compte aujourd’hui 450 employés.

\subsection{Localisation}

L'entreprise est présente, comme indiqué sur la \figureName{localisation} à Les Ulis (France),\\Rochester (USA), Montréal (Canada), Neufchâtel (Suisse) et à Guidel (France), lieu de ce stage.

\imgn{\rootImages/localisation.png}{Localisation des filiales}{0.45}{localisation}


\section{Le site de Guidel}

A l'origine, la principale activité de l’entreprise de Guidel était la protection de sites sensibles comme les centrales nucléaires ou les bases militaires par le biais de systèmes électriques et électroniques.\\
A partir de 1986, le site se spécialise dans les balises de détresse et c'est en 2012 que l'entreprise prend le nom de Orolia SAS.


Le site de Guidel s'occupe essentiellement des balises de détresse qui peuvent être sous différentes gammes :

\begin{items}{blue}{\Circle}
    \item Balises \glossary{PLB} (Personal Locator Beacon) militaires
    \item Balises \glossary{ELT} (Emergency Locator Transmitter) pour l’aéronautique \figureRef{balises}
\end{items}


\imgn{\rootImages/balises.png}{Un ensemble de balises ELT }{0.10}{balises}


La \figureName{organigrame} montre la répartition dans les différents services des 90 employés d'Orolia à Guidel.
\imgn{\rootImages/diagramme.png}{Organigramme du site de Guidel}{0.4}{organigrame}


La conception et l'étude des balises se fait dans le département Recherche \& Développement. 
\newline
\section{Le département Recherche \& Développement}

Le service R\&D compte 25 employés, alternants ou stagiaires, ce qui représente de loin le plus grand service du site de Guidel.\\

Au sein du service R\&D, le responsable de l’équipe, Stéphane JINCHELEAU, gère l’organisation du travail en parallèle des trois chefs de projet qui contrôlent la répartition et l’avancement des tâches. \\
Ce sont eux aussi qui communiquent avec les clients des projets (Airbus et Boeing, principalement).\\ 
Le service est scindé en 3 salles pour répartir en fonction des "métiers", à savoir la partie Mécanique, Hardware, Software et Système.\\
Chaque stagiaire possède un maître de stage qui lui sert d’interlocuteur privilégié pour les questions techniques, même si tous les équipiers peuvent être questionnés pour des sujets précis.\\ 

Lors de mon stage, j'avais un maître de stage orienté Software, Quentin L'HELGUEN mais je pouvais aussi compter sur Benjamin ADAM pour la partie Hardware du stage.\\
Le service R\&D a tout au long du stage veillé à ce que j'ai le matériel adapté (oscilloscope, composants électroniques...) et j'avais une grande liberté pour commander du matériel si besoin.\\
Tout au long de mon passage à Orolia, j'ai donc constaté que l'entreprise souhaitait sincèrement que je progresse dans mes compétences.\chapter{L'environnement des balises}  

\section{Le programme COSPAS-SARSAT}

Pour communiquer, les balises Orolia se basent sur le programme standardisé \glossary{COSPAS-SARSAT} (C/S) \figureRef{network} qui regroupe 43 pays et organisations pour former un réseau de satellites et de stations terrestres. \\ Les échanges avec les satellites se font avec des signaux à 406 MHz et les fréquences 121.5 MHz et 243 MHz sont des fréquences qui permettent aux services \glossary{SAR}
(Search and Rescue) de localiser la balise.\\

Chaque signal de détresse est traité par l'un des 200 pays et territoires.

%#Parler des constellations

\imgn{\rootImages/global.png}{Le réseau Cospas-Sarsat}{0.9}{network}

La figure précédente nous indique le cheminement d'un processus de détresse, c'est à dire lorsque une balise commence à émettre un message.

Tout d'abord, une balise située dans un avion (ELT), un navire (EPIRB) ou sur une personne (PLB) envoie des messages de détresse pendant 24 heures au réseau de satellites. 
Les satellites forment un ensemble de 3 constellations : 


\begin{items}{blue}{\Circle}
    \item La constellation \glossary{LEOSAR} (Low-Earth Orbiting Search and Rescue) est formée de 6 satellites à 36 000 km d'altitude.
    \item La constellation \glossary{GEOSAR} (Geostationary Search and Rescue) avec cinq satellites à 36 000 km également.
    \item La constellation \glossary{MEOSAR} (Medium-Earth Orbit SAR) formée par les satellites GPS et Galiléo notamment.
\end{items}

Les satellites réceptionnent le message et transmettent aux différentes stations terrestres la demande de détresse.\\

Chaque message comprend différents champs ayant chacun une fonction comme indiquer l'identifiant unique de la balise, vérifier l'intégrité des données...\\

Lors des premières 48 heures, un signal de positionnement est envoyé pour que les secours puissent localiser la balise avec le système SAR qui lance les recherches au sol (hélicoptères, navires...). Cette phase est appelée Homing.

Les normes C/S imposent une durée de fonctionnement de minimum 24 h et 48 h pour certains modèles (ELT).

\section{L'architecture d'une balise}

Une balise peut fondamentalement est scindée en deux chaînes : 

\begin{items}{blue}{\Circle}
    \item Une chaîne de Puissance qui s'occupera d'émettre les messages de détresse
    \item Une chaîne Logique pour gérer les états de la balise
\end{items}

\imgn{\rootImages/powerBeacon.png}{L'architecture de l'alimentation d'une balise}{0.5}{archBeacon}

La gestion de l'énergie d'une balise (deux parties qui seront abordées par la suite) est donc la partie qui vise à faire fonctionner la logique et la puissance en partant d'une batterie.


\section{Les contraintes des balises}

Ces balises sont placées dans des environnements contraignants (avion, navires...), il faut donc alimenter la balise avec une batterie afin qu'elle puisse émettre ses messages de détresse en toute situation.\\Les balises doivent être autonomes en énergie et ne nécessiter aucune interaction de l'utilisateur pour émettre les messages.\\

Ainsi, en plus des normes C/S, le domaine de l'aéronautique ajoute ses propres normes de sécurité dont notamment l'utilisation des balises à -40°.\\
Cependant, à cette température, les batteries utilisées dans certaines balises sont moins efficaces et la capacité apparente diminue comme le montre la figure suivante :\\

\imgn{\rootImages/datasheet.png}{L'effet de la température et du courant sur une cellule de batterie}{0.8}{batt}

Ces balises ne doivent être activées qu'en cas de détresse avérée et ne peuvent pas se déclencher intempestivement. Elles forment donc un système de sécurité utilisé en dernier recours car l'échec n'est pas permis.\\
Les contraintes d'autonomie énergétique sont exigeantes car une balise doit émettre dans les 5 secondes même lorsque elle n'est pas activée depuis des années.


Il faut donc jongler entre les contraintes imposées par la batterie et par la puissance nécessaire à la partie Puissance et Logique afin d'émettre avec suffisamment de puissance aux satellites. 

\section{Les modes de la balise}
\label{frequencies}

Il existe principalement 3 modes de fonctionnement :

\begin{items}{blue}{\Circle}
    \item mode OFF : La balise est totalement désactivée.
    \item mode ARMED : Seule quelques fonctions vitales (détection de crash, détection d'eau de mer) sont activées, le reste est en sommeil.
    \item mode ON : La balise émet ses signaux de détresse sur les différentes fréquences. Un message transmit est appelé Burst. Pour le 406 MHz, les bursts durent une seconde et se répartissent ainsi sur les 24 premières heures : 
     \begin{items}{blue}{\Triangle}
 \item 6 bursts espacés chacun de 5 secondes
 \item 59 bursts espacés chacun de 30 secondes
 \item 705 bursts espacés chacun de 120 secondes
 \end{items}
 
 Entre chaque burst en 406 Mhz, un signal est transmis pour le système SAR. Après 24 h, la balise émet uniquement en 121.5 MHz et 243 MHz.
\end{items}

\section{Le système de batterie}

Afin d'alimenter les balises, deux modèles de batterie ont été développés : 

\begin{items}{blue}{\Circle}
 \item Une batterie BAT400 qui comprend 4 cellules de 3V (3Ah) en série, ce qui fait une batterie de 12V et 3Ah (4s1p)
 \item Une batterie BAT800 qui comprend 2 branches parallèles de 4 cellules de 3V (3Ah) en série, ce qui fait une batterie de 12V et 6Ah (4s2p)
 \end{items}
\chapter{Présentation du travail réalisé}

\section{Objectifs du stage}

Le premier objectif de ce stage était d'analyser dans un premier temps la gestion de l'énergie sur les balises. \\ 
Il a donc fallu caractériser l'ensemble des modules permettant la conversion et la répartition de l'énergie à travers les balises.\\

Un second objectif était d'étudier le système des supercondensateurs et d'analyser les supercondensateurs , partie qui sera abordée par la suite.\\

L'objectif final était d'améliorer l'autonomie des balises grâce aux études et expériences précédentes.\\

L'ensemble des résultats et analyses ont été rédigées dans un cahier de conception demandé par l'entreprise.\\
Pour m'aider dans la compréhension du système actuel, j'ai souvent utilisé le logiciel LTSpice ou Tina afin de simuler le comportement du système.







\section{Analyse de la batterie}

La base de l'alimentation est la batterie, il convient donc de la caractériser.

Comme vu précédemment, les performances de la batterie diminuent lorsque la température diminue. Cependant, le courant tiré par la balise entre en compte. \\

Le cas le plus critique pour l'utilisation de la batterie est lors d'une émission d'un burst en 406 MHz. La partie Puissance de la balise nécessite un courant de 2A sous une tension de 7.6V afin d'émettre avec suffisamment de puissance le signal aux satellites.\\

Des mesures réalisées par la société ont montré qu'on ne pouvaient pas tirer plus de 1.5A sur un ensemble BAT400 ou BAT800 si l'on souhaitait effectuer correctement les émissions.
Ce courant (en ampères) sera par la suite appelé \bold{$I_{max}$}

Sous ces basses températures, analysons le phénomène de Résistance Série Équivalente (ESR) qui pénalise la batterie.

\subsection{Analyse de la résistance interne}

A faible température, la capacité de la batterie diminue et son \glossary{ESR} augmente de manière significative. \\

J'ai essayé de mesurer la valeur de l'ESR de la batterie. Pour cela, je suis parti du principe que l'ESR engendre une chute de tension parasite lors du passage d'un courant. \\
J'ai utilisé une charge dynamique afin d'imposer le courant de 1 ampère en sortie de la cellule placée dans une étuve à -40°C, comme indiqué sur la \figureName{esrDynamicLoad}.\\ Les valeurs sont ensuite relevées avec un oscilloscope.

\imgn{\rootImages/box.png}{Montage pour mesurer l'ESR à -40°C}{0.7}{esrDynamicLoad}

Pour un même courant demandé (1A), la chute de tension due à l'ESR à -40°C augmente considérablement. La \figureName{esr} montre la chute de tension due à l'ESR pour un courant de 1A sur une cellule de 3V.

\imgn{\rootImages/esr_pile.png}{Mise en évidence de l'ESR à -40°C}{0.7}{esr}

L'ESR d'une cellule vaut donc :

$$ R_{ESR} = \frac{\Delta V}{I} = \frac{0.843}{1} = 0.843 \Omega$$

Avec $I$ le courant débité par la celulle en A, $\Delta $ la chute de tension mesurée


La \figureName{esrHot} en annexe met en évidence le lien entre la température et l'ESR. J'ai soumis la pile à plusieurs salves de 1A afin de réchauffer le coeur de la pile et on constate que l'ESR diminue progressivement.\\

Sur un ensemble BAT400 ou BAT800 de 12V, lorsque un courant de 1A est tiré, une chute de tension de 3.4V apparaît et la tension apparente n'est plus que de 8.6V.\\


Le système actuel cherche donc à limiter le courant drainé par la batterie et pour cela, un ensemble de supercondensateurs (configuration 2s2p) fait office de réservoir d'énergie intermédiaire lors des appels importants de courant de la balise.\\

Les condensateurs sont intégrés de la façon suivante au sein de la chaîne d'énergie.


\imgn{\rootImages/hybrid2.png}{Configuration des supercondensateurs}{0.55}{config}

La partie verte correspond au mode Hybrid sur la \figureName{arch} et s'explique car la balise doit émettre dans les 5 secondes. Or, les condensateurs sont déchargés et il n'est pas possible de les charger en 5 secondes. La partie Puissance tire l'énergie directement sur la batterie lors des 6 premiers bursts.


Les supercondensateurs peuvent délivrer de forts courants à basse température. Ainsi, excepté lors des 6 premiers Bursts en 406 MHz, la partie Puissance tire le courant des supercondensateurs qui sont rechargés entre les bursts avec un courant moyen constant afin de réduire l'impact de l'ESR et d'améliorer les performances de la batterie.\\


D'un point de vue capacité de batterie, il est plus efficace de tirer un faible courant sur la pile qu'un courant plus élevé. 

Au lieu d'avoir la courbe de courant bleue (figure suivante) pour le courant sur la batterie, on va chercher à obtenir la courbe rouge. L'énergie débitée par la pile avec ces deux courbes est la même , seule le profil du courant évolue.


\begin{graphic}{0.8}{0.5}{0}{32}{-0.1}{1.6}{t(s)}{$I ~~(A)$}{Courbes de courant entre deux bursts}
\addPoints{blue}{(0,0.033)(1,0.033)(1,1.38)(2,1.38)(2,0.033)(31,0.033)(31,1.38)(32,1.38)(32,0.033)}
\addPoints{red}{(0,0.08)(32,0.08)}
\addPoints{green}{(0,1.5)(32,1.5)}
\addLegend{Courant pulsé (A), Courant lissé (A), $I_{max}$ Batterie ($A$)}
\end{graphic}





\section{Analyse d'un convertisseur}

\subsection{Besoins techniques du convertisseur}


Pour la partie Puissance, il faut une tension de 7.6V (2A) avec un pack batterie de 12V (ou batterie de 6V pour les balises PLB). 

Or, nous avons vu précédemment qu'on ne peut pas tirer 2A avec la batterie à -40°C.\\
L'utilisation d'un régulateur de tension linéaire n'est pas acceptable car si un courant de 2A est tiré en sortie du régulateur, cette même valeur de courant sera tirée sur la batterie.\\

En revanche, il est possible de réduire le courant tiré sur la batterie en utilisant un convertisseur DC-DC.\\ Ce dernier va convertir la tension d'entrée en une tension plus faible. A puissance d'entrée et de sortie du module égale, une tension plus grande sur l'entrée par rapport à la tension de sortie va imposer un courant plus faible en entrée (par rapport à la sortie).\\
La figure suivante indique les différents courants et tensions pour un convertisseur (rendement de 90\%) en séquence de burst.\\


\imgn{\rootImages/converter.png}{Principe d'un convertisseur}{0.55}{converter}


Les convertisseurs, lorsqu'ils sont utilisés dans leur plage de courant nominal possèdent de très bons rendements contrairement aux régulateurs linéaires. Cependant, ces régulateurs sont utilisés dans les balises lorsque une tension stable est recherchée.\\


J'ai étudié principalement 3 topologies de convertisseurs DC-DC , dont deux qui sont utilisés sur les balises :

\begin{items}{blue}{\Triangle}
    \item Convertisseur \glossary{Buck} : Ce module engendre en sortie une tension plus petite que la tension en entrée.
    \item Convertisseur \glossary{Boost} : Ce module engendre en sortie une tension plus élevée que la tension en entrée.
    \item Convertisseur \glossary{Buck-Boost} non-inverseur : Ce module regroupe les deux topologies précédentes pour produire une tension plus faible ou plus élevée que la tension d'entrée.
\end{items}


\subsection{Principe}
Les convertisseurs Buck-Boost (ou Boost) se basent sur les propriétés des bobines à stocker de l'énergie. En commutant une bobine, il est possible de faire varier la tension de sortie.\\
Ces convertisseurs utilisent généralement la même configuration pour leur commande, à savoir un pont diviseur de tension pour fixer la tension de sortie, une résistance pour fixer la fréquence du module et une broche pour activer ou non le module.

\subsection{Mesure des rendements}

L'un des objectifs du stage est de mesurer les rendements des modules Buck-Boost utilisés. En effet, sur les différentes balises les modules Buck-Boost varient et leur efficacité également. 

J'ai pu simuler et mesurer les rendements de 3 modules différents. Cependant, seul une des caractérisation sera présentée. Une première étape a été de simuler un convertisseur puis les mesures ont été réalisées.

\subsubsection{Mesures par simulation}

J'ai simulé le convertisseur LTC3119 sous LTSpice afin d'avoir une première estimation des valeurs de rendement en condition nominale des burst, c'est à dire 7.6V et 2A en charge.

Connaissant la tension de sortie et d'entrée du module, le calcul du rendement se fait donc ainsi : 

$$ \eta = \frac{Vs \cdot Is}{Ve \cdot Ie} *100 ~~[\%]$$
Avec $V_s$ et $V_s$ en $V$, $I_s$ et $I_s$ en $A$ \\

J'ai réalisé le schéma suivant \figureRef{ltc3119} sous LTSpice et avec l'aide de la commande MEAS (Ces instructions sont disponibles en annexes \ref{meas}), j'ai pu mesurer le courant en entrée du module ainsi qu'en sortie, une fois le régime permanent établi.


\imgn{\rootImages/LTC3119.png}{Le schéma de simulation d'un LTC3119}{0.3}{ltc3119}


Les rendements des modules LTC3112, LTC3124 et LTC3119 sont disponibles en annexes \figureRef{ltc3112Efficiency}


\subsubsection{Mesures réelles}
Pour mesurer réellement les rendements de ces modules, j'ai soit : 

\begin{items}{blue}{\Triangle}
    \item Démonté de vieilles balises pour souder directement les câbles de l'alimentation et simulé la batterie avec une alimentation externe \figureRef{rendement_mesures}.
    \imgn{\rootImages/mesures.jpg}{Mesure de rendements}{0.07}{rendement_mesures}
    \item Utilisé des modules de démonstration fourni par les fabricants (Analog Device).
\end{items}


J'ai réalisé une première série de mesures mais l'écart des rendements entre la simulation et la pratique était très élevé (plus de 20\%), j'ai donc remis en cause le montage et constaté une chute de tension élevée aux bornes des câbles d'alimentation.\\
J'ai augmenté la section des fils des câbles d'alimentation afin de me rapprocher des résultats des simulations\\

Les résultats des rendements mesurés sont disponibles en annexes \figureRef{ltc3112Efficiency}.\\


Les différences de rendement dans les graphiques montrant les résultats s'expliquent car de nombreux phénomènes n'ont pas été simulés sous LTSpice comme la résistance des câbles.\\De plus, il ne s'agit que d'une simulation, on arrive rapidement aux limites du monde théorique.
\\Les rendements mesurés sont inférieurs aux rendements simulés ce qui est cohérent.\\
Plus la tension en entrée est faible plus le courant en entrée sera important pour une puissance égale.\\

Les trois modules sont néanmoins capables de fournir suffisamment d'énergie à la partie Puissance lors de l'émission des burst, même si la tension en entrée diminue.\\
A chaque fois que les 2A étaient consommés par la charge, le courant tiré sur l'alimentation était inférieur au $I_{max}$ de la batterie.\\ L'utilisation de convertisseurs pour la partie Puissance est donc justifiée.



\newpage
\section{Analyse des supercondensateurs}

Nous avons vu que les supercondensateurs permettaient de délivrer un courant élevé pendant un bref instant afin de s'affranchir de la température. Cependant, il convient de caractériser ce système afin de connaître ses performances.

\subsection{Caractérisation des supercondensateurs}

J'ai cherché dans un premier temps à déterminer la capacité (F) et la Résistance Série Équivalente ($\Omega$).\\ Cette première donnée est relativement imprécise de la part des fabricants ($\pm$~20\%).

Le supercondensateur mesuré est un BCAP0005-P270 avec une tension nominale de 2.7V et une capacité nominale de 5F.

\subsubsection{Mesure de la capacité}

Pour mesurer la capacité, j'ai simplement fait un pont RC et j'ai soumis le supercondensateur à une tension de 2.7V. 
La tension du supercondensateur a atteint 63\% de la valeur nominale ($1.7V$) en 1072s avec une résistance de 189.9 $\Omega$.
d'ou 
$$ C = \frac{t_{63\%}}{R} = \frac{1072}{189.9} = 5.64 F$$

\subsubsection{Détermination de la Résistance Série Équivalente}


Le principe utilisé pour mesurer l'ESR est le même que celui utilisé pour l'ESR de la batterie à -40°C, c'est à dire qu'on impose un courant de charge de 1 ou 2A et on regarde la chute de tension aux bornes du supercondensateur. J'ai mesuré l'ESR lorsque les supercondensateurs étaient chargés à 2.7V (tension nominale).\\
La valeur de l'ESR mesurée vaut en moyenne $55~ m\Omega$ ce qui est plus faible que la valeur de l'ESR de la batterie. Les supercondenseurs permettent de tirer un courant important même à faible température.\\

La courbe du relevé de l'expérience est disponible avec la \figureName{esrCapa}.

\subsection{Mesure du courant}

Toujours dans l'optique de ne pas dépasser $I_{max}$ sur la batterie, un capteur de courant est placé en amont des supercondensateurs pour connaître le courant.\\

La figure \figureRef{current} indique l'emplacement du capteur.

\imgn{\rootImages/sensor.png}{Emplacement du capteur de courant}{0.46}{current}

Une simulation du composant (\figureName{currentSensor} en annexe) a été réalisée avec le logiciel TINA afin de vérifier sa validité, notamment son temps de réponse.

La \figureName{currentSensorResponse} simule le temps de réponse en sortie du filtre passe-bas du capteur.\\

\imgn{\rootImages/transient.png}{Temps de réponse du filtre}{0.46}{currentSensorResponse}


J'ai ensuite réalisé une mesure réelle. J'ai fixé un courant de 1A et j'ai mesuré le temps que met le capteur à produire la tension image de ce courant.\\
La relation entre le courant et la tension de sortie est la suivante : 

$$ V_{s} = \frac{I}{1.25}~~ [V]$$


%# \begin{graphic}{0.8}{0.5}{0}{1}{-0.1}{1.5}{t(s)}{Vs}{Temps de mesure du capteur}
%# \addPoints{red}{(0,0)(0.1,0)(0.1,1)(0.8,1)(1,1)}
%# \addTrace{blue}{0.1}{1}{1.25*(1-exp{-(x-0.1)/(0.075)})}
%# \addLegend{Courant (A), Vs (V)}
%# \end{graphic}

%# A ev
J'ai constaté que le signal de sortie met 362 $ms$ à atteindre sa valeur nominale. Or, le temps entre deux acquisitions de courant est de 10 ms. Il a donc fallu réduire le temps de réponse du filtre à moins de 10 $ms$ en modifiant le filtre.

Une mesure de comparaison entre le capteur avec et sans filtre passe-bas est disponible en annexe (\figureName{annexe_filter}).


\subsection{Le système de recharge actuel}


%#Ajouter courbe standards -> 
Le système de recharge actuel des 4 supercondensateurs est un chargeur Buck contrôlé via un signal \glossary{PWM} (Pulse Width Modulation) en provenance du microcontrôleur de la balise.


Pour charger les supercondensateurs, différents algorithmes ont été mis en place par la société, certains sont plus efficaces que d'autres. Le rendu de la charge avec l'algorithme de la balise Tauceti est disponible en annexe \figureRef{annexe_tauceti}.\\

\subsubsection{Mesure des rendements}


\imgf{\rootImages/nucleo.jpg}{Une carte Nucleo F411}{0.3}{0.5}{right}{10}

L'un des objectifs de mon stage était de caractériser le système actuel de recharge pour connaître les rendements.\\
Le système actuel est fonctionnel mais peu de données de rendement étaient disponibles. Lors des mesures, j'ai réalisé un code en C (organisation du code sur la \figureName{code}) avec une carte de développement Nucleo F411 afin de reproduire la séquence de charge et décharge des supercondensateurs.\\
\vspace{1cm}
\imgn{\rootImages/diagramme.png}{Graphique des modules C de code}{0.6}{code}

Chaque module gère des fonctions propres à l'expérience (chargeur de supercondensateurs, module de décharge, gestions des interrupteurs, communication UART...) et comprend un fichier d'en-tête et de source code C.\\


L'ensemble du fonctionnement de la balise est régie par le module \bold{Beacon} qui est vu comme la principale machine à état.


\subsection{Mesures des rendements}

Ainsi, pour mesurer les rendements du chargeur de supercondensateurs, il suffit d'appuyer sur le bouton utilisateur de la Nucleo afin de lancer le cycle : 

\begin{items}{blue}{\Bullet}
    \item Décharge des supercondensateurs jusqu'à 4.3V. Cette tension est la tension des supercondensateurs en fin de burst.
    \item Calcul du courant nécessaire en fonction du temps de charge souhaité
    
    Ce courant est simple à calculer car étant donné qu'il est constant, l'évolution de la tension est linéaire et le courant est proportionnel au temps de charge. On sait que : 
        $$ Q = I\cdot t~[C] ~~~~~~~~ et ~~~~~~~~~Q = C \cdot \Delta  V$$ avec $Q$ la charge en Coulomb, $I$ le courant dans le condensateur en Ampère, $t$ le temps de charge en s et $\Delta V$ la différence de potentiel aux bornes du condensateur.
    D'ou :
    $$ <I> = \frac{C \cdot\Delta V}{t}~[A]$$

Ainsi, par exemple, pour charger un condensateur de 5F de 0V à 5.4V en 30 s, il faut un courant (mA) de 
$$ <I> = \frac{5 \cdot 5.4}{30} = 900 mA$$
    \item Activation de la \glossary{PWM} et de l'algorithme de charge
    \item Scrutation de la fin de la charge (tension à 5.4V) et acquisition des valeurs de courant
\end{items}

Afin d'automatiser le calcul du rendement, je me suis basé sur l'énergie accumulée dans les supercondensateurs pour calculer le rendement. En effet, l'énergie accumulée (en Joule) par un condensateur vaut : 

$$ E_C = \frac{C\cdot \Delta V^2}{2} [J] $$

Il s'agit donc de l'énergie stockée dans le condensateur sur une période $t_{charging} $ (s)

Ensuite, on relève le courant débité par l'alimentation (capteur de courant) tous les 10 ms et on stocke le résultat dans un tableau le temps de la durée de charge du condensateur.

$$ <I_e> = \frac{1}{N} \cdot \sum_{n=0}^{N}{array[n]}$$

D'où : 

$$ <P_{condensateur}> = V_{CC}~\cdot <I>~[W]$$

Comme $E = P.t~[W.s] $ et que $ 1Wh\cdot s = 1 J$, on en déduit que :

$$ E[J] =  V_{CC}~ \cdot (\frac{1}{N} \cdot \sum_{n=0}^{N}{array[n]}) \cdot t_{charging} $$


Avec N le nombre d'échantillons du courant, $t_{charging}$ le temps de charge du condensateur en s.\\


Étant donné que les supercondensateurs seront une seule fois déchargés au démarrage de la balise (cas critique), les essais des rendements ont été fait pour une tension des supercondensateurs comprise entre 4.3V et 5.4V (on ignore la charge initiale).\\

Il a été ensuite possible de lancer une séquence avec plusieurs bursts pour faire une moyenne des rendements.


La \figureName{arctarusCurrent} présente un cycle de recharge et décharge de supercondensateurs.\\
La courbe rouge représente l'image du courant dans les supercondensateurs et la courbe bleue la tension des supercondensateurs (V).
\imgn{\rootImages/simulation_burst_1.png}{Séquence de bursts avec l'algorithme Arctarus}{0.35}{arctarusCurrent}


La \figureName{resultBuck} est disponible en annexe et présente les résultats des rendements pour des temps de charges de 5, 10 et 30s.\\ Les rendements sont d'autant meilleurs que le courant en entrée est élevé (sous peine de ne pas dépasser le courant de
saturation de l'inductance).\\
Sur les premières 24 heures, la plupart des recharges se font en 30 secondes (cas nominal) et le rendement pour ces recharges va de 45\% (batterie à 12V) à 56\% (batterie à 8V).

%# Une fois que le système actuel de recharge des supercondensateurs a été caractérisé, la seconde étape était de vérifier si leur présence est indispensable.\\

%# \newpage
%# \section{Caractérisation du système sans supercondensateurs}

%# Un des objectifs de mon stage était de savoir si on gardait le système des supercondensateurs ou non.\\
%# En effet, on peut se demander s'il ne valait pas mieux de perdre un peu de capacité de batterie en tirant un courant plus élevé mais compenser l'énergie perdue en retirant le chargeur de supercondenseurs qui ne possède pas un bon rendement.

%# Pour répondre à la question, j'ai simulé et mesuré le comportement d'une balise en faisant abstraction des supercondensateurs,  c'est à dire en supprimant le circuit de recharge et en mettant la batterie en entrée des convertisseurs utilisés pour la partie Puissance.
 
%#  Ce principe de branchement direct est indiqué sur la \figureName{arch}, plus précisément avec le bloc Direct où l'on supprime le chargeur de supercondensateurs.


%# \subsection{Calculs préliminaires}

%# Afin d'estimer la capacité d'un pack BAT800, j'ai réalisé un tableur où j'ai rentré précisément le cycle des bursts avec les durée et les courants. De ce tableur en a découlé une capacité estimée pour 48 h de fonctionnement (en Ah).

%# \subsection{Expérience}

%#  La séquence des bursts a dû être reproduite avec un microcontrôleur, en accord avec les périodes des bursts (Section \ref{frequencies}).\\

%# J'ai donc placé la batterie à -40°C dans une étuve 2 heures avant de lancer la simulation afin que le coeur de la batterie soit à -40°C.\\

%# Pour simuler la balise, j'ai utilisé deux convertisseurs LTC3112 , l'un pour simuler les émissions en 406 MHz (2A) et le second pour la consommation de la balise hors bursts et en Homing (30
%# mA moyen sur la batterie).\\

%# Le schéma suivant (\figureName{battery}) m'a donc permis de réaliser l'expérience. 

%# Lors de mes premières expériences, j'avais utilisé un régulateur linéaire \glossary{LDO} (Low DropOut) pour simuler le courant hors-burst mais le modèle était incohérent vis à vis du courant tiré sur la batterie en dehors des burst à 406 MHz.

%# \imgn{\rootImages/cold.png}{Schéma pour la batterie sans supercondensateur}{0.5}{battery}


%# La figure suivante présente la montage. On aperçoit l'étuve en arrière-plan avec les câbles de la batterie qui sortent.


%# \begin{figure}[!h]
%# \begin{minipage}[b]{.45\linewidth}
%#     \imgn{\rootImages/montage.jpg}{Montage globale}{0.1}{montage}


%# \end{minipage}
%# \begin{minipage}[b]{.45\linewidth}
%#     \imgn{\rootImages/photo.jpg}{Montage des convertisseurs}{0.1}{montage}
%# \end{minipage}
%# \end{figure}


%# \subsection{Résultats}


%# Afin de vérifier si le système fonctionne sans supercondensateur, il a fallu vérifier que toutes les séquences de Burst ont bien été réalisées. 


%# Le système sans supercondensateur a tenu près de XX heures. Cela peut sembler élevé par rapport à la contrainte des 48 heures mais il faut prendre en compte la pré-décharge de la batterie.
%# %#Ref pour question à l'oral

%# Les résultats détaillés des essais de la batterie sans supercondensateurs sont disponibles en annexe.



\newpage
\section{Optimisation du chargeur de supercondensateurs}

J'ai cherché un composant pour améliorer le rendement du chargeur de supercondensateurs. 

La contrainte de ce composant était de pouvoir contrôler le courant pour ne pas dépasser le $I_{max}$ de la batterie.
Un asservissement en tension aurait entraîné des pics de courants non maîtrisés et inacceptables vis-à-vis du $I_{max}$.\\
De plus, il fallait que ce composant soit le plus autonome possible.
je me suis orienté dans mes recherches sur deux technologies disponibles sur le marché.

\begin{items}{blue}{\Circle}
    \item Des chargeurs de supercondensateurs linéaires
    \item Des convertisseurs DC-DC dont le courant est programmable soit par un bus \glossary{I2C} (Inter-Integrated Circuit) ou bien en fixant une résistance pour déterminer le courant de charge.
\end{items}

La première catégorie, ayant des rendements faibles (50\% environ, la \figureName{ltc4425} montre les rendements mesurés sur le LTC4425, un chargeur linéaire), je me suis porté sur les convertisseurs programmables, plus précisément sur le \bold{LT3120} qui utilise une résistance pour fixer le courant. \\

\imgn{\rootImages/ltc4425.png}{Rendements du LTC4425 (\%)}{0.5}{ltc4425}

Pour fixer le courant, je suis parti sur le choix technologique des potentiomètres numériques\footnote{Il était possible d'utiliser un Convertisseur-Analogique Numériques et même des transistors en commutation mais c'est la méthode la plus simple} qui ne sont ni plus ni moins que des circuits intégrés avec des résistances internes qui commutent par l'intermédiaire de transistors.

Ce composant est prévu pour fonctionner sous deux modes différents : 


\begin{items}{blue}{\Circle}
    \item Le mode PWM est prévu pour les courants en sortie assez élevés ($> 1A$)
    \item Le mode Burst pour les courants inférieurs
\end{items}


La résistance de contrôle du courant maximal se calcul de la manière suivante : 

  $$ R_{P} = \frac{795}{2\cdot I_{m}\cdot R_{S}}  $$
  
  avec $I_{m}$ en $A$ et $R_S$ en $\Omega$ (Il s'agit de la résistance \glossary{Shunt} utilisé par le composant pour connaître le courant en sortie).\\
  
 
Lors des essais en mode Burst, il m'a été impossible de contrôler un courant inférieur à 250 mA. J'ai donc contacté le fournisseur du composant afin d'expliquer mon expérience et les capacités du composant.

De plus, même si le courant en sortie était constant, celui en entrée ne l'était pas du tout, on avait un comportement étrange en fin de charge, comme le montre la figure suivante : 

\imgn{\rootImages/fluctuation.png}{Mesure d'une charge avec le LT3120}{0.3}{fluc}

La courbe blue représente la tension des supercondensateurs (V) et la courbe rouge le courant en entrée du module.\\

Ce composant ne répondant pas en totalité au cahier des charges (comportement étrange), je  n'ai pas pu valider l'intérêt d'utiliser ce composant qui prenait une grande place sur un circuit imprimé.

%#- Image comportemennt LT3120\chapter{Conclusion}

J'ai dans un premier temps analysé le système actuel de la gestion de l'énergie des balises. \\
J'ai ensuite mesuré le rendement du système de recharge des supercondensateurs en reproduisant l'environnement de charge et de décharge et j'ai essayé de trouver un composant qui ferait la même tâche plus efficacement. J'ai prouvé que les composants du marché ne permettent pas d'avoir de meilleurs rendements dans le cadre de notre utilisation.\\

Sur la partie finale de mon stage, j'analyserai les performances des batteries à très faible température  avec et sans le système des supercondensateurs.\\


J’ai trouvé que la taille de l’entreprise était très propice au développement personnel ainsi qu’au développement des connaissances et j’ai eu l’occasion d’apprendre beaucoup de choses et de consolider mes acquis en électronique.\\
J'ai également pu améliorer mes connaissances dans les domaines des alimentations, des batteries et des supercondensateurs. \\

Ce stage m'a donc permis de me conforter dans mon orientation professionnelle, à savoir le domaine de l'électronique avec une partie d'informatique pour contrôler un système électronique.\\


Le développement de balises de détresse permet de sauver de nombreuses vies que ce soit en aéronautique, dans le domaine militaire ou maritime, ce qui ajoute un côté plus humain dans le travail réalisé.\\
\chapter{Annexes}

\subsection{Verrou de l'alimentation Arctarus}


Lorsque une balise est est mode ON, il faut que son alimentation soit active. Pour cela, on utilise un verrou présenté ci-contre.


\imgn{\rootImages/latch_lt.png}{Verrouillage de l'alimentation Arctarus}{0.7}{annexes_verrou_arctarus}

L'ensemble du verrouillage est assuré par le transistor Q1.

\subsection{Filtre du capteur de courant}
Ces deux signaux sont l'image du courant à travers le capteur, c'est à dire la tension en sortie du filtre passe-bas.\\
Le signal bleu est le signal sans filtre et le rouge avec filtre.
\imgn{\rootImages/comp.png}{Efficacité du filtre passe-bas}{0.35}{annexe_filter}


%## \newpage
%## \section{Balise Kiwi}
%## \subsection{Verrou de l'alimentation Kiwi}
%## \imgn{\rootImages/kiwi_supply.png}{Verrouillage de l'alimentation Kiwi}{0.7}{annexe_verrou_kiwi}


\subsection{Allure de l'algorithme de charge de Tauceti}

La courbe bleue représente la tension des supercondensateurs (V) et la rouge leimage du courant (A) en entrée de la balise en fonction du temps (s). \\Contrairement à l'algorithme utilisé pour reproduire les charges et décharges des supercondensateurs, le courant est moins constant car l'asservissement est géré différemment.
\imgn{\rootImages/charge_tauceti.png}{Allure de l'algorithme Tauceti}{0.4}{annexe_tauceti}
%#erreur statique
%#Ajouter algo Arctarus


\subsection{Mesure de l'ESR pour les supercondensateurs}
La courbe bleue représente la tension des supercondensateurs (V) et la rouge le courant (A) dans les supercondensateurs. La tension de charge est de 5.4V car deux condensateurs ont été mis en série pour augmenter la tension maximale.

\imgn{\rootImages/ESR_2A.png}{Mesure de l'ESR des supercondensateurs avec une charge à courant constant de 2A}{0.3}{esrCapa}

\subsection{Rendement du Buck}


Ce tableau présente les rendements du chargeur de supercondensateurs en fonction de la tension d'alimentation (V) et du temps de charge (s).
Dans notre cas nominal (30 secondes), nous pouvons espérer un rendement compris entre $45.7\%$ et $57.9\%$.

\imgn{\rootImages/time.png}{Mesure des rendements pour le module Buck}{0.7}{resultBuck}


\subsection{Simulation des convertisseurs}
\label{meas}

Les instructions suivantes permettent de mesurer le rednement des convertisseurs sous LTSpice.
% \begin{Cpp}{Instructions LTSpice pour les mesures des rendements}
% .tran 0 6.4m 6m 100u startup
% .step param load list 5 4 3 2.5 2 1.5 1 0.5
% .meas POWER_INPUT AVG -V(INPUT)*I(Vin)
% .meas POWER_OUTPUT AVG V(OUTPUT)*I(I1)
% .meas EFFICIENCY PARAM POWER_OUTPUT/POWER_INPUT
% .meas OUTPUT_VOLTAGE AVG V(OUTPUT)
% .meas OUTPUT_CURRENT AVG I(I1)
% \end{Cpp}


\subsection{Rendements des convertisseurs}

Voici les rendements simulés et mesurés pour les 3 convertisseurs disponibles pour une utilisation nominale (2A, 7.6V)
A chaque fois, le rendement réel était inférieur au rendement théorique.

\imgn{\rootImages/LTC3112_eff.png}{Rendements des modules LTC3112}{0.7}{ltc3112Efficiency}

\imgn{\rootImages/LTC3124_eff.png}{Rendements des modules LTC3124}{0.7}{ltc3124Efficiency}


\imgn{\rootImages/LTC3119_b.png}{Rendements des modules LTC3119}{0.9}{ltc3119Efficiency}


\subsection{Mise en évidence entre la température et l'ESR}

La figure suivante indique la chute de tension (V) pour une cellule de 3V placée dans l'étuve à -40°C. 
En imposant un courant de décharge suffisamment élevé à la cellule, le coeur de cette dernière se réchauffe ce qui fait baisser son ESR.

\imgn{\rootImages/salve.png}{Lien entre la température et l'ESR}{0.45}{esrHot}



%# \subsection{Mesures de la batterie sans supercondensateur}

%# La courbe bleue représente la tension de la batterie (V), la courbe jaune la tension en sortie du LDO (V), la courbe orange la tension en sortie du convertisseur (V) fournissant le 7.56V et la courbe grise le courant dans la batterie (A).

%# Pour vérifier la faisabilité du système sans supercondensateur, il a fallu vérifier que l'ensemble des Bursts s'est correctement déroulé, c'est à dire en vérifiant que les convertisseur ont pu délivrer la puissance nécessaire pour les émissions.

%# \imgn{\rootImages/b1.png}{Évolution de la batterie pour les bursts de 5 secondes}{0.7}{burst_Fast}

%# \imgn{\rootImages/b2.png}{Évolution de la batterie pour les bursts de 30 secondes}{0.5}{burst_Medium}

\subsection{Simulation du capteur de courant}

La figure suivante présente la simulation du capteur de courant effectuée avec le logiciel TINA.
\imgn{\rootImages/current_sensor.png}{Simulation du capteur de courant}{0.8}{currentSensor}


\newpage
\imgr{\rootImages/planning.png}{Planning}{0.35}{90}%\addPartText{Théorie sur les amplificateurs opérationnels}
\partImg{Les amplificateurs opérationnels}{\rootImages/aop.jpeg}{0.4}

 \chapter{Introduction}
 
\section{Généralités}

  \index{AOP}

Un AOP (Amplificateur Opérationnel) est un composant actif qui permet de réaliser des opérations mathématiques (addition, soustraction, intégration, dérivation, etc) et du fait de sa miniaturisation et de sa fiabilité, on le rencontre aujourd’hui dans de nombreuses applications comme l’audio, la radio, l’asservissement…

\img{\rootImages/pinoutAOP.png}{Les entrées et sorties de l'AOP}{0.5}

\index{Alimentation symétrique}
Un AOP possède deux entrées notées appelées \colors{red}{entrée non inverseuse} et \colors{red}{entrée inverseuse}, une 
\colors{red}{sortie} et deux broches d’\colors{red}{alimentation}.
L’AOP dispose souvent d’une alimentation symétrique ($Vcc+$ et $Vcc-$) avec comme référence de tension le point milieu 
(GND) des alimentations.


\img{\rootImages/power.png}{L'alimentation d'un AOP}{0.6}


\section{Conventions}


Afin de simplifier les calculs sur les AOP, quelques conventions ont été adoptées :

\begin{items}{blue}{\Triangle}
  \item La tension de sortie de l’AOP est notée $Vs$
  \item La tension sur l’entrée inverseuse est appelée $E_-$
  \item La tension sur l’entrée non inverseuse est appelée $E_+$
  \item La tension différentielle \colors{red}{$(E+-E-)$ est appelée $\varepsilon$}
  \item Le gain d’amplification différentiel de l’AOP est appelé $Ad$
  Ce gain est variable entre différentes familles d’AOP mais reste constant dans le temps
  \item Le gain d’amplification du montage est appelé $A_0$ et varie en fonction des différents montages possibles 
\end{items}

\messageBox{Remarque}{green}{white}{L’alimentation des montages suivants ne sera pas représentée par souci de clarté.}{black}
\chapter{Modélisation de l'AOP}
\section{Modèle théorique}


Dans un souci de simplification des calculs, un AOP peut être vu physiquement comme un composant ayant des caractéristiques parfaites. 
Ces caractéristiques sont les suivantes :

\begin{items}{blue}{\Triangle}
  \item impédance d’entrée :  $Z\rightarrow+\infty \Omega$ \index{Inpédance d'entrée}
  \item Impédance de sortie : $Z=0 \Omega$  \index{Inpédance de sortie}
  \item $Ad\rightarrow+\infty$
  \item Vsmax $ = Vcc_+$
  \item Vsmin $ = Vcc_-$
  \item Bande passante : $Fmax\rightarrow+\infty$ \index{Bande passante}
\end{items}

Cela se traduit par un modèle dont les deux entrées sont ouvertes (courant nul) et avec une tension de sortie qui ne serait pas affectée par le courant de sortie

\img{\rootImages/theorique.png}{Le modèle théorique de l'AOP}{0.6}

\section{Modèle réel} 


Cependant, il convient de noter que ce modèle n’est que théorique.\\

Du fait de la nature des composants constituant les AOP (transistors, condensateurs), la tension de sortie ne peut pas être égale à la tension d’alimentation. 

Cette tension de sortie max est appelée $Vsat_+$et $Vsat_-$ \\

D'où le modèle suivant : 

\begin{items}{blue}{\Triangle}
  \item impédance d’entrée :  $Z>10^5 \Omega$
  \item Impédance de sortie : $Z>0 \Omega$ (courant de sortie max $20mA$)
  \item $Ad \gg 1000$
  \item $Vs_{max}$ =$Vcc_{sat_+}$
  \item $Vs_{min}$ =$Vcc_{sat_-}-$
  \item Bande passante : imposée par le constructeur (Ex : le LM324 tolère 1MHz)
\end{items}


\img{\rootImages/real.png}{Le modèle réel de l'AOP}{0.6}


Cependant, pour les calculs, \colors{red}{l’hypothèse du courant d’entrée} nul sera retenue, tout comme celle du gain $Ad$


\section{ Modes de fonctionnement}


\subsection{Montages linéaires }
Le signal $V_s$ est une fonction mathématique du signal d’entrée $V_e$. \\

Dans certains cas, le signal de sortie conserve la forme du signal d’entrée sous couvert que que l’AOP ne rentre pas en saturation. \\


Un \colors{red}{montage linéaire impose un $\varepsilon$ nul, sauf si l’AOP est saturé}, c’est à dire si $V_s=V_{sat}$




\subsection{Montages comparateurs}

Le signal de sortie ne peut prendre que deux valeurs, $Vsat_+$ou $Vsat_-$
En l’absence de contre-réaction, $Vs=\varepsilon Ad$ \\

\bold{Une réaction est un retour du signal sur une des deux entrées. Celle ci peut être positive ou négative en fonction de l’entrée choisie (entrée -,réaction négative et entrée +, réaction positive).}

\img{\rootImages/52.png}{Les modes de fonctionnement de l'AOP}{0.6}

\section{Résistance de charge}

Il est possible de mettre une résistance de charge entre $V_s$ et la masse. \\

Cette résistance symbolise un circuit relié directement à l'AOP. \\

Cependant, le courant de l’AOP étant limité à quelques dizaines de mA, il convient de prendre une résistance de charge $R_c$ suffisamment grande ($Rc>1000 \omega$). \\

Si $R_{c}$ est suffisamment élevée, cette dernière n’influence pas la tension de sortie $V_s$ \\


\img{\rootImages/loadAOP.png}{La résistance de charge}{0.8}

\chapter{Étude en mode linéaire}
\section{Intérêt de l’étude }

Les AOP en fonctionnement linéaire permettent de réaliser les opérations mathématiques :

d\begin{items}{blue}{\Triangle}
  \item \bold{amplification} : $Vs=A_0 \cdot Ve$
  $A_0$ est le coefficient d’amplification du montage (A ne pas confondre avec $A_d$ le coefficient d’amplification différentiel 
  imposé par le constructeur)
  $A_0$ peut être positif ou négatif
  \item \bold{addition algébrique} : $V_s=\sum_{k=0}^{n} V_k$
  \item \bold{intégration et dérivation} (avec des condensateurs) à une constante près
  \item \bold{logarithme et exponentielle}
\end{items}

\section{Méthode de résolution}
La \colors{red}{réaction négative} (liaison entre la sortie et l’entrée inverseuse) impose un fonctionnement stable et linéaire, 
d'où \colors{red}{$\varepsilon=0, E_+=E_-$} \\

L’hypothèse de la résistance d’entrée de l’AOP implique que $I_+=I_-=0$

Afin de déterminer $Vs$, il faut exprimer \bold{$E_+$et $E_-$ en fonction des éléments du montage}. \\

\bold{En égalisant les deux équations obtenues ($E_+=k$ et $E_-=k'$)}, on obtient une relation de type $V_s = f(V_e)$


\messageBox{Remarque}{orange}{white}{$I_s$ est issu d’une source de tension, il n’y a donc pas de loi simple permettant de déterminer sa valeur algébrique. Il ne faut pas avoir d'à priori sur son sens}{black}
\chapter{Montage suiveur }
\section{Présentation}

Ce montage permet de reproduire à l’identique une tension d'entrée. \\
L'intérêt de ce montage réside dans le fait que l’impédance d’entrée de l’AOP est considérée comme infinie et que 
son impédance de sortie est considérée comme nulle.\\

Ainsi, le comportement de la charge en entrée ne sera pas affecté par l’AOP, le signal d'entrée ne sera donc pas modifié. \\

Ce montage sert donc à faire une \bold{adaptation d’impédance}.  

\section{Montage}

\img{\rootImages/suiveur.png}{Le montage suiveur}{0.6}


\section{Démonstration} 
La réaction négative implique que $\varepsilon=0$ (fonctionnement linéaire)
$$ E_+=Ve $$
$$ E_-=Vs $$

$$ \Rightarrow Ve=Vs$$ car $E_+=E_-$


%\section{Application}

\begin{exemple}
On souhaite mesurer une tension au borne d’un capteur avec un appareil de mesure.

\img{\rootImages/sensor.png}{Le capteur}{0.6}

On place ensuite une charge $ R_c $ au bornes de $A$ et $b$. Cette résistance $ R_c $ représente l'appareil d'acquisition.

\img{\rootImages/rc.png}{Le modèle d'acquisition}{0.3}
\end{exemple}


\Question{Quelle est l’influence de $Rc$ sur la tension $AB$ dans le montage suivant ?} 


\begin{reponse}

Sans la charge $Rc$ : 

$$ U_{AB}= \frac{U \cdot R_2}{R_1+R_2}$$

Avec  la charge $Rc$ :

$$ U_{AB}= \frac{U \cdot R_{equ}}{R_1+R_{equ}}$$


Avec $R_{equ}$ la résistance équivalente entre $R_2$ et $R_c$ \\



Si $R_c \rightarrow + \infty$ alors $R_{equ} \rightarrow \frac{U_{AB} \cdot R_2}{R_1+R_2}$ \\

Si $R_c \rightarrow + 0 $ alors $R_{equ} \rightarrow 0 \Rightarrow U_{AB} \rightarrow 0$

\end{reponse}


D'où le montage suivant, avec $R_c \rightarrow + \infty$, le signal n'est pas déformé.


\img{\rootImages/measure.png}{L'adaptation d'impédance}{0.8}


\chapter{Montage non-inverseur}


\section{Présentation}

Ce montage amplifie la tension $V_e$ par un \bold{gain $A_0$ positif}. \\
L’amplificateur reste en mode linéaire si $Ve < Vcc_{sat} \cdot A_0$

\section{Montage}

\img{\rootImages/non_inv.png}{Le montage amplificateur non inverseur}{0.8}

\section{Démonstration}

Un AOP en mode linéaire impose $\varepsilon=0$
D'où $E_+ =E_-$ 

$$E_+=V_e$$
$$E_-=V_s \cdot \frac{R_2}{R_1+R_2}$$

\begin{align}
E_+ = E_- &\Rightarrow V_e = V_s \cdot \frac{R_2}{R_1+R_2}\\
 &\Rightarrow \frac{V_e}{V_s} = \frac{R_2}{R_1+R_2}\\
 &\Rightarrow V_s = V_e \cdot \frac{R_1+R_2}{R_2} \\
\end{align}

%avec $A_0=\frac{R_1+R_2}{R_2}$

\subsection{Exemple}


\begin{exemple}
On souhaite amplifier un signal sinusoïdal par un coefficient $k=5$.\\
On peut donc utiliser le montage précédent. \\
On prendra $R_1=1 k\Omega$ et $R_2=4k\Omega$ pour avoir $A_0=5$
\img{\rootImages/inv_img.png}{Amplification du signal noir par 5}{0.4}
\end{exemple}


\chapter{Montage inverseur}
\section{Présentation}

Ce montage amplifie la tension $V_e$ par un \bold{gain $A_0$ négatif}.

\section{Montage}

\img{\rootImages/non_inv.png}{Le montage amplificateur non inverseur}{0.8}

\section{Démonstration}

Mode linéaire : $\varepsilon = 0$
\begin{align}
E_+&=0 \\
E_-&= \frac{ \frac{V_e}{R_1}+\frac{V_s}{R_2} } { \frac{1}{R_1} + \frac{1}{R_2}} \\
E_-&=\frac{V_e \cdot R_2 + V_s \cdot R_1}{R_1 + R_2} \\
\Rightarrow \frac{V_e}{V_s} &= -\frac{R_1}{R_2}\\
\Rightarrow V_s &= -V_e \cdot \frac{R_2}{R_1} 
\end{align}

Avec $A0= -\frac{R_2}{R1}$

\section{Application}

\begin{exemple}
On souhaite amplifier un signal sinusoïdal par un coefficient $k=-5$.\\
On peut donc utiliser le montage précédent. \\
On prendra $R_1=1 k\Omega$ et $R_2=5k\Omega$ pour avoir $A_0=-5$
\img{\rootImages/inv_signal.png}{Amplification du signal noir par -5}{0.4}

\end{exemple}

\chapter{Montages comparateurs}
\section{Présentation}

Un montage comparateur se reconnaît par son branchement : 

\begin{items}{blue}{\Triangle}
  \item \colors{red}{Aucune contre réaction} n’est présente
  \item Une \colors{red}{contre réaction a lieu sur l’entrée non inverseuse} via un dipôle passif
\end{items}

Le montage comparateur permet de comparer deux tensions entre elles. \\
Cependant, cette comparaison peut s’effectuer de plusieurs manières, avec un ou deux seuils, de manière inversée ou non...

\subsection{Comparateur non inverseur simple seuil}

\subsubsection{Présentation}

Ce montage permet de comparer simplement deux tensions entre elle.

\subsubsection{Montage}

\img{\rootImages/cmp.png}{Comparateur simple seuil}{0.7}

Ce mode est le plus simple et est régi de la manière suivante : \\

On sait que $\varepsilon = E_+ - E_-$ et que $V_s=\varepsilon \cdot A_d$ avec $Ad=+\infty$ \\
(Circuit en boucle ouverte) \\


Si $E_+>E_-$ :
$$Vs=Vsat_+$$ 
 si $E_+<E_-$ :
$$Vs=Vsat_-$$

Si $V_2=0V$, on obtient la caractéristique de transfert suivante  

\img{\rootImages/12.jpg}{Caractéristique de transfert, $V_1$ est la tension d’entrée de l’AOP}{0.3}


\subsection{Comparateur inverseur simple seuil}

Le raisonnement est le même sauf que les entrées sont inversées. \\
De ce fait, le seuil de basculement se fait dans l’autre sens. \\

Si $E_+>E_-$ :
$$Vs=Vsat-$$
Si $E_+<E_-$ :
$$V_s=Vsat_+$$

\subsection{Comparateur non inverseur double seuil}


\subsubsection{Présentation}

Ce type de montage permet d’éliminer les tensions “parasites”, c’est à dire les tensions bruités et non indésirables. \\

\subsubsection{Montage}

\img{\rootImages/double_cmp.png}{Montage comparateur non inverseur double seuil }{0.8}

\subsubsection{Application}

Par exemple, un capteur de lumière résistif (photo-résistance) sera sensible aux variations de lumière (nuages…). \\

\img{\rootImages/14.png}{Un signal bruité}{0.5}

Or, si on compare ce signal par rapport à une référence, on ne veut pas que le capteur déclenche plusieurs fois l’action.

\img{\rootImages/trig.png}{Le cycle de déclenchement}{1}

Pour éviter ce problème, on utilise un comparateur à double seuil : \\
toute les tensions parasites ayant une amplitude inférieure à la tension de différence entre les deux seuils seront ignorées.\\

\img{\rootImages/dual.png}{Le principe}{0.8}

On va chercher les deux valeurs de basculement : 

$$E_+ = \frac{V_eR_2 + V_s R_1}{R_1 + R_2}$$
$$E_- = U_0=0$$

Étudions le cas où $\varepsilon>0$

\begin{align}
\varepsilon>0 & \Leftrightarrow E_+ > E_-\\
& \Leftrightarrow \frac{V_eR_2 + V_s R_1}{R_1 + R_2} > U_0 \\
& \Leftrightarrow \frac{V_eR_2}{R_1 + R_2} > U_0 -  \frac{V_s R_1 }{R_1 + R_2} \\
& \Leftrightarrow  V_eR_2 > R_1 + R_2 \cdot  U_0 -  V_s R_1 \\
& \Leftrightarrow  V_e > \frac{R_1 + R_2 \cdot  U_0 -  V_s R_1}{R_2}
\end{align}

Ici, $U_0=0$ et $V_s=V_{sat_+}$ car $\varepsilon>0$

D'où $V_e > \frac{-V_{sat} + R_1}{R_2}$


\messageBox{Remarque}{orange}{white}{$U_0$ peut être différent de $0V$ en mettant une source de tension sur $E_-$}{black}


Étudions le cas où $\varepsilon>0$ : 

\begin{align}
\varepsilon>0 & \Leftrightarrow E_+ < E_-\\
& \Leftrightarrow \frac{V_eR_2 + V_s R_1}{R_1 + R_2} < U_0 \\
& \Leftrightarrow  \frac{V_eR_2}{R_1 + R_2} < U_0 -  \frac{V_s R_1 }{R_1 + R_2} \\
& \Leftrightarrow  V_eR_2 < R_1 + R_2 \cdot  U_0 -  V_s R_1 \\
& \Leftrightarrow  V_e < \frac{R_1 + R_2 \cdot  U_0 -  V_s R_1}{R_2}
\end{align}

Ici, $U_0=0$ et $V_s=V_{sat_-}$ car $\varepsilon<0$ \\

D'où $V_e < \frac{-V_{sat} + R_1}{R_2}$



On obtient deux seuils $S1$ et $S2$ de valeurs respectives : \\


$\frac{-V_{sat}+R1}{R2}$ et $\frac{Vsat - R_1}{R_2}$ \\



Afin de basculer, la tension d’entrée doit dépasser $S1 V$ et afin de basculer dans l’autre sens, la tension d’entrée doit 
être inférieure à $S2 V$ \\


On obtient le cycle d’hystérésis suivant : \\

$(VB=S2 et VH=S1)$

\img{\rootImages/hys1.png}{Cycle d'hystérésis non inverseur}{0.8}



$U_{milieu\_de\_cycle}=(V_{seuil1}+V_{seuil2}) \cdot 0.5$ \\
$Largeur_{cycle}=V_{seuil1}-V_{seuil2}$



\subsection{Comparateur inverseur double seuil}

\subsubsection{Montage}

\img{\rootImages/double_inv.png}{Montage comparateur inverseur double seuil}{0.5} 

\subsubsection{Démonstration}

La démarche est rigoureusement identique avec $\varepsilon>0$, on a $V_s=Vsat_+$
et pour  $\varepsilon<0$ on a $V_s=Vsat_-$

On obtient le cycle d’hystérésis suivant : \\


\img{\rootImages/hys2.png}{Cycle d'hystérésis inverseur}{0.8}\chapter{Montage intégrateur}
\section{Présentation}
Ce montage intègre une tension d’entrée. \\
En sortie, on obtient une tension $V_s$ valant $V_s=k \cdot \int V_e$

\section{Montage}

\img{\rootImages/integrateur.png}{Montage intégrateur}{0.6}

\section{Démonstration}

Montage en mode linéaire car contre-réaction négative. \\


\begin{align}
I_{R1} + I_{C1}  = 0 & 
& \Leftrightarrow I_{R1} = -I_{C1} \\
& \Leftrightarrow \frac{E}{R} = - C \cdot \frac{dV_s}{dt} \\
& \Leftrightarrow -\frac{1}{RC}\cdot E = \frac{dV_s}{dt} \\
& \Leftrightarrow V_s = -\frac{1}{RC} \int V_e \\
k=-\frac{1}{RC} &
\end{align}
   
Ce montage est notamment présent dans certains Convertisseurs Analogiques Numériques dit “simple” ou “double” rampe. 


\section{Application}

\begin{exemple}
On souhaite générer un signal triangulaire.
\end{exemple}


En intégrant un signal rectangulaire, on obtient un signal triangulaire.


\img{\rootImages/triangle.png}{Un signal triangulaire généré depuis un signal carré}{0.4}

Soit $V_e=2V$ ou $V_e=-2V$

Si $V_e=2V$ \\

\begin{align}
k \int V_e &= k V_e\cdot t + x\\
&= - \frac{2}{RC}t+c 
\end{align}

avec $k=-\frac{1}{RC} $ \\

$\Rightarrow$ droite d'équation $y=-\frac{2}{RC}+c$ \\


Si $V_e=-2V$ \\

\begin{align}
k \int V_e &= k V_e\cdot t + x \\
&= \frac{2}{RC}t+c 
\end{align}

avec $k=-\frac{1}{RC} $ \\

$\Rightarrow$ droite d'équation $y=\frac{2}{RC}+c$ \chapter{Montage soustracteur}
\section{Présentation}
Ce montage permet de soustraire deux tensions d’entrée afin d’obtenir la différence en sortie.

\section{Montage}

\img{\rootImages/sous.png}{Montage soustracteur}{0.6}

\section{Démonstration}


Contre-réaction négative donc mode linéaire.\\


$$E_+=U_2\frac{R_4}{R_2+R_4}$$

\begin{align}
E_-&=\frac{\frac{U_1}{R_1}+\frac{U_5}{R3}}{\frac{1}{R_1}+\frac{1}{R_3}}\\
&=\frac{U_1R_3+U_5R_1}{R_1+R_3}
\end{align}

Or $E_+=E_-$

\begin{align}
&\Leftrightarrow U_2 \cdot \frac{R_4}{R_2+R_4} = \frac{U_1R_3+U_5R_1}{R_1+R_3} \\
&\Leftrightarrow  \frac{U_5R_1}{R_1+R_3} = \frac{U_2R_4}{R_2+R_4} -\frac{U_1R_3}{R_1+R_3} \\
&\Leftrightarrow  U_5R_1 = \frac{R_4(R_1+R_3)}{R_2+R_4} - \frac{U_1R_3}{R_1} 
\end{align}


Si $R_1=R_2=R_3=R_4$, on obtient : \\

$U_s=U_2-U_1$\\

\section{Application}

\begin{exemple}
On souhaite mesurer une tension entre deux points A et B d’un circuit (tension différentielle)
\img{\rootImages/variable.png}{Tension différentielle $AB$}{0.4}
\end{exemple}


Pour étudier la différence de potentiel entre les deux points du circuit, on peut utiliser un montage soustracteur 
afin qu’en sortie du montage avec l’AOP, on ait : 

$$ V_s=V_a-V_b$$

On peut réaliser le montage suivant.

\img{\rootImages/diff.png}{Un montage pour lire une tension entre deux points}{0.55}\chapter{Montage sommateur}

\section{Présentation}
Ce montage permet d'additionner en sortie plusieurs tensions d’entrée. Avec ce montage, la tension de sortie est multipliée par un coefficient -1

\section{Montage}
\img{\rootImages/somme.png}{Montage sommateur inverseur}{0.6}

\section{Démonstration}

Contre-réaction négative donc montage linéaire. \\
On applique le théorème de Millman \footnote{on fera abstraction de U3}

$$E_+=0$$
$$ E_- = \frac{ \frac{U_1}{R_1} + \frac{U_2}{R_1} + \frac{U_s}{R_1} }{\frac{1}{R_1} + \frac{1}{R_1} + \frac{1}{R_1}}=0$$

\begin{align}
&\Leftrightarrow \frac{U_1+U_2+U_s}{R_1}=0 \\
&\Leftrightarrow \frac{U_s}{R_1} = \frac{-(U_1+U_2)}{R_1} \\
&\Leftrightarrow U_s = -(U_1+U_2)
\end{align}%\addPartText{Théorie sur les condensateurs et applications}
\partImg{Les condensateurs}{\rootImages/capa.jpg}{0.4}


\chapter{Histoire} 

C’est en 1745, que le physicien allemand Ewald Georg von Kleist invente le premier condensateur. \\
Il a enroulé une feuille d'argent autour d'une bouteille en verre,  et  a  chargé  la  feuille  à  l'aide  d'un  générateur  à  
friction. Il était convaincu  qu'une  charge  pourrait  être  accumulée  lorsqu'il  a  reçu  un  choc  électrique  significatif 
(par un générateur par exemple). \\

Un an plus tard, Pieter van Musschenrboek poursuivra les recherches sur cette invention et lui donnera le nom de : 
“bouteille de Leyde”. Pour la petite histoire, ce nom vient de l’université où travaillait ce dernier : l’université de Leyde. \\
Le condensateur est une véritable révolution car il permet de contenir une importante charge électrique dans un très petit volume.  
La bouteille de Leyde est un condensateur formé de deux conducteurs séparés par le verre de la bouteille.\\

Le premier conducteur est généralement constitué d'une électrode supérieure, reliée à des feuilles en étain mises dans  la  bouteille. 
 Le  second  conducteur  est  formé  par  une feuille  métallique  autour la  bouteille. Ces deux conducteurs permettent de 
 créer deux charges égales mais de signes opposées. \\


\img{\rootImages/layde.jpg}{Bouteille de Leyde}{1.1} 

Puis avec le temps, d'autres condensateurs ont vu le jour : 

\img{\rootImages/condo_type.jpg}{Différents types de condensateurs}{0.8}
\chapter{Principe de fonctionnement}

Un condensateur est un dipôle électrique composé de deux armatures conductrices appelées électrodes et séparées par un matériel isolant ou diélectrique.

\img{\rootImages/condensateur.jpg}{schéma condensateur}{1}

Lorsque l'on exerce une tension sur un condensateur, une force électrique déplace des électrons vers la première armature pour s'y déposer. Cette augmentation du nombre d'électrons vient chargée négativement l'armature. Une force se créée entre les deux plaques et vient arracher des électrons à la seconde armature et donc charger positivement l'armature. \\ 

Malgré la présence d'un isolant entre les deux plaques, le courant dans le circuit n'est pas nul. En effet, tant que le condensateur n'est pas chargé ,un nombre d'électrons arrive vers le condensateur. Le nombre d'électrons arrivant sur la première plaque est égale au nombre d'électrons quittant la seconde plaque. Des charges sont arrachées à la seconde armature et continuent de se déplacer dans le circuit.  \\ 

Le condensateur continue de se charger tant que la tension entre les deux armatures n'est pas égale à la tension exercée sur ses bornes. Si on exerce une tension sur le condensateur supérieur à sa tension admissible, le composant va casser ou exploser. Lorsque le condensateur est complètement chargé, les nouveaux électrons arrivant sont repoussés par ceux déjà présents sur la plaque, il n'y a plus déplacement de charges , le courant devient nul. \\

Un condensateur est caractérisé par un coefficient de proportionnalité entre la charge et la tension à ses bornes. On note ce coefficient capacité électrique et il s'exprime en Farad.

$$ Q = C(V_1 - V_2) \;\; ou \;\; i = C \frac{du}{dt}$$ \\

La capacité d'un condensateur est déterminée par la géométrie du composant et la nature de l'isolant. \\

Le tableau suivant résume la valeur de capacité pour différente géométrie de condensateur. $ \varepsilon_r $ représente la permittivité relative de l'isolant.\\


\img{\rootImages/capacitor.png}{calcul capacité}{0.8}\chapter{Les différentes technologies}

Au cours de l’histoire plusieurs technologies ont été découvertes afin de fabriquer des condensateurs. Cela nous offre maintenant, un large choix de technologies suivant les utilisations et, ou les valeurs en Farad nécessaires. Afin de mieux comprendre les avantages et les inconvénients de chaque technologie, nous allons en faire une comparaison des plus couramment utilisées. \\ \\

\img{\rootImages/classification.PNG}{Classification des différents types de condensateur}{0.7}


La figure \ref{classification} récapitule tous les types de condensateurs. Ils sont divisés en 2 catégories, les condensateurs à capacité fixes et ceux à capacité variable. Nous allons par la suite nous intéresser majoritairement au condensateur à capacité fixe car ce sont ceux le plus répandus.

\section{Les condensateurs à film}


Ces condensateurs utilisent un film plastique. Il en existe de 2 types, suivant l’utilisation du film plastique.  Ceux de type un utilisent un film plastique comme diélectrique, c’est-à-dire comme moyen de limiter ou empêcher la conduction électrique mais laissant s’exercer les forces électrostatiques. Ceux de type deux utilisent quant à eux un film plastique métallisé. \\

\img{\rootImages/condo_film.png}{Schéma interne d'un condensateur à film plastique}{0.5}


Ces condensateurs possèdent une faible capacité comprise entre 1nF et 30µF, mais à défaut permettent une très grande précision. 
Ils possèdent également une durée de vie supérieure à la plupart des autres types de condensateurs et ne sont pas polarisé. 
De plus, certains de ces condensateurs permettent une régénération après un claquage. 
Ils sont également conçus pour résister à de hautes tensions (de l’ordre du kilovolt) et permettent de fournir des impulsions de courant de surcharge très élevées.

\newpage
\section{Les condensateurs à céramique}

Ce type de condensateur est celui majoritairement utilisé. Ils sont notamment très utilisés en électronique du fait de leur petite 
taille. Ils permettent des capacités comprises entre 1nF et 1µF. Ils ne sont pas polarisés comme les condensateurs à film ce qui 
permet leur utilisation dans des circuits à courant alternatif. Il en existe également 2 types :\\

\begin{items}{blue}{\Triangle}
    \item Ceux de classe 1 sont utilisés lorsque l’on nécessite une grande stabilité et de faible perte. Ils possèdent une valeur de capacité très stable.\\
    \item Ceux de classe 2 possèdent une capacité élevée. Ils perdent cependant en stabilité thermique et les tolérances de capacité sont plus élevée.
\end{items}

\img{\rootImages/condo_ceramique.jpg}{Schéma interne d'un condensateur à céramique}{1}

\newpage
\section{Les condensateurs électrolytiques}

Les condensateurs électrolytiques ou encore condensateurs chimiques, utilisent un électrolyte, c’est-à-dire une substance conductrice contenant des ions mobiles. Cela permet à ces condensateurs de pouvoir fournir une plus grande plage de valeur de capacité que les autres types de condensateur. Ils sont dans la très grande majorité polarisé ce qui oblige leur utilisation dans des circuits à courant continu. On en voit très souvent dans des alimentations notamment d'ordinateur etc... Ils permettent une capacité comprise entre 1µF et 47mF avec une tension de fonctionnement pouvant aller à l’ordre de quelques centaines de volts. Ils ne sont cependant pas très précis. En effet il possède une tolérance de 20\%, une grande résistance en série et réagissent très mal aux hautes fréquences (surchauffe). 


\img{\rootImages/condo_electro.png}{Schéma interne d'un condensateur électrolytiques}{0.5}



\section{Les condensateurs variables}

Les condensateurs variables sont des condensateurs dont la valeur de la capacité est comme son nom l’indique variable. Ils sont constitués d’un rotor, d’un axe et d’un stator. 


\img{\rootImages/condo_variable.png}{Schéma interne d'un condensateur variable}{0.5}


Le rotor entraîné par l’axe tourne dans l’armature fixe du stator. La capacité de ces condensateurs varie en continu entre une valeur minimum appelé capacité résiduelle et une valeur maximum appelée capacité nominale. \\

Cette variation suit une fonction appelée loi de variation : 

$$ C=f(\theta) $$


f() dépend de multiples paramètres complexes. Il est donc difficile de pouvoir le définir clairement.\\
$\theta$ quant à lui correspond à l'angle de rotation de l'axe. \\ \\

Nous avons pu dans cette partie, nous intéresser à différents types de condensateur. Il en existe encore plein d'autres comme les condensateurs au mica, au papier... Mais nous avons vu ici, ceux les plus couramment utilisés.\part{Les condensateurs}
\chapter{Domaines d'application des condensateurs}

Nous allons présenter trois domaines d'application des condensateurs. Cette liste n'est pas exhaustive. Les condensateurs permettent également de redresser le cosinus $\Phi$ ou bien de filtrer des signaux audio.

\section{Les condensateurs de filtrage}

\subsubsection{Présentation}

Les condensateurs permettent de lisser une tension afin de stabiliser cette dernière.

\subsubsection{Objectif}

On souhaite amortir les oscillations de tension en sortie d'un pont de Graëtz (14 V DC).\n
On souhaite donc passer d'une tension alternative à une tension pseudo-continue.

\img{\rootImages/graetz.png}{Le pont de Graetz}{0.5}

\img{\rootImages/graetz_input.png}{La tension en sortie du pont}{0.5}



\subsubsection{Mise en oeuvre}

Afin de lisser la tension, il convient de mettre un condensateur en sortie du pont de Graëtz, avec une borne sur INPUT et une autre à la masse. \\
Une résistance de 50 $\Omega$ a été rajoutée pour simuler la présence d'une charge.

\img{\rootImages/out_filtre.png}{Le circuit de filtrage }{0.5}

Observons le résultat.

\img{\rootImages/graetz_out.png}{La tension aux bornes du condensateur }{0.7}

\subsubsection{Principe}

Le condensateur joue le rôle d'accumulateur. Pendant les phases ou la tension est croissante, ce dernier se charge. \\
Lors des phases ou la tension décroît, le condensateur restitue une partie de son énergie, ce qui a pour effet de réduire l'amplitude de variation de tension.\n 

On retrouve notamment ces condensateurs dans les alimentations linéaires. \\
Dans ce cas, la capacité du condensateur nécessaire croit avec le courant demandé par la charge. \\

Il est fréquent de voire des condensateurs chimiques de quelques mF dans ces alimentations. Une valeur inférieure risque de rendre instable l'alimentation.


\section{Les condensateurs de découplage}

\subsubsection{Présentation}


Certains circuits nécessitent une alimentation très stable (aucune fluctuation de la tension d'entrée). 
Cependant, lors de l'utilisation du circuit, des courants importants peuvent être demandés par le circuit. \\
Nous allons montrer un cas en exemple où, pour améliorer les performances du circuit, il conviendra 
de mettre ce fameux condensateur de découplage.

\subsubsection{Objectif}

Nous souhaitons cascader deux portes logiques CMOS\footnote{Complementary MOS : MOS complémentaires, mise en cascade d'un MOS canal P et d'un MOS canal N} de type inverseur, comme le montre la figure suivante.

\img{\rootImages/cmos_purpose.png}{Schéma d'exploitation}{0.3}

A première vue, ce modèle peut sembler satisfaisant. Cependant, nous souhaitons faire fonctionner ce circuit dans des fréquences assez élevée \footnote{Toutefois inférieures à la fréquence maximale du circuit}.

En prenant un modèle réel, on peut déjà prendre en compte les capacités parasites des transistors MOSFETs. Ces derniers possèdent une capacité entre la broche de commande (Gate) et la masse.

Le modèle réel des entrées de chaque porte logique est le suivant.

\img{\rootImages/real_input_cmos.png}{Modèle équivalent des entrées CMOS}{0.3}


\subsubsection{En régime transitoire}
Intéressons nous au régime transitoire.
On constate que dans notre cas d'exemple, les grilles des  MOSFETS consomment du courant pendant les phases de commutation, du fait qu'il faut charger ou décharger les condensateurs.
Cet appel de courant peut faire réduire la tension d'alimentation si cette dernière n'est pas très puissante.


\subsubsection{En régime stationnaire}

Lorsque la tension d'entrée (INPUT) est constante et que le condensateur est chargé (ou déchargé), les grilles des MOSFETs ne sont parcourus par aucun courant.\\

\subsubsection{Le modèle réel}

L'alimentation étant rarement en liaison directe avec le circuit logique (piste de circuit imprimé, fils d'alimentation), on constate l'apparition d'une inductance parasite entre la borne d'alimentation du circuit et l'alimentation en elle-même.
Le modèle équivalent final du circuit peut être modélisé par la figure suivante.

\img{\rootImages/noise.png}{Modèle équivalent du circuit}{0.3}

L'inductance parasite s'oppose aux variations de tensions. \\ Ainsi, lors des phases de commutation (régime transitoire), une partie de la tension d'alimentation va au bornes des inductances parasites.
De ce fait, le circuit est de moins en moins efficace à mesure que l'on augmente la fréquence du signal d'entrée.
Pour pallier à ce problème, nous allons ajouter un condensateur de découplage.
\subsubsection{Mise en oeuvre du condensateur de découplage}


Le condensateur de découplage doit être placé au plus près du circuit à alimenter. Une de ses bornes est reliée à la broche d'alimentation du circuit et la seconde à la masse. \n

\img{\rootImages/capa_decouplage.png}{Le placement du condensateur de découplage}{0.5}

Lorsque le circuit en aval va demander du courant lors des commutations, le condensateur, qui va se charger pendant le régime permanent du circuit, va pouvoir fournir un apport de courant qui évitera à la tension d'alimentation de s'écrouler. 
Le circuit sera plus efficace et les temps de communication seront plus faibles. \\


D'un point de vue des filtres, ces condensateurs peuvent être considérés comme des filtres passe-bas. En effet, la tension d'alimentation qui varie est vue comme un signal haute fréquence. Il faut donc éviter l'oscillation haute fréquence.

\section{Les condensateurs de liaison}

\subsubsection{Présentation}

Une des propriétés des condensateurs est de bloquer les composantes continues.
Nous allons aborder un exemple ou le condensateur va permettre de se passer d'une alimentation symétrique. 

\subsubsection{Objectif}

On souhaite amplifier la composante alternative d'un signal d'amplitude 1V, de tension moyenne 0.5V et de fréquence 1kHz avec un AOP alimenté en 0-12V (Alimentation asymétrique).

\img{\rootImages/sinus.png}{Le signal à amplifier}{0.6}

\subsubsection{Mise en oeuvre}

Tout d'abord, on va chercher à recentrer le signal pour avoir une composante alternative toujours positive.
Pour cela, on utilise le circuit suivant.

\img{\rootImages/bridge.png}{Montage pour recentrer la tension}{0.4}

La fréquence de coupure valant $\frac{1}{2\pi RC}$ avec $ R < 10 k\Omega$, il faudra prendre un condensateur tel que la fréquence de coupure soit inférieure à la fréquence du signal d'entrée. \n
Un condensateur de 1 mF conviendra donc pour cette application.\\

En utilisant le théorème de superposition au point OUTPUT, on en déduit que une résistance de $10 k\Omega$ et une résistance de $ 900 \Omega$, on obtient la tension OUTPUT suivante.

\img{\rootImages/bridge_level.png}{Tension positive}{0.5}

Il nous reste à amplifier la tension OUTPUT (ici par 2). Nous obtenons donc une tension sinusoïdale d'amplitude 2V. \\

\img{\rootImages/bridge_output.png}{Schéma avec les deux condensateurs de liaison}{0.7}

Pour extraire la composante alternative, il suffit de mettre en sortie un condensateur qui va recentrer le signal en 0V.
Le condensateur sera de 1mF (même fréquence). \\
Nous obtenons finalement un signal de sortie avec un gain de 2 de la composante alternative d'entrée.\n

\img{\rootImages/vs_liaison.png}{La tension de sortie}{0.6}
Au final, les deux condensateurs permettent à des portions de circuits de communiquer entre elles avec des niveaux de tension différents. Ces condensateurs sont appelés \textbf{condensateurs de liaison ou de couplage}\chapter{Avenir du condensateur}

Nous avons donc vu dans les parties précédentes que le condensateur est un élément essentielles à tout circuits électronique. \\
Nous nous sommes donc posé la question suivante : Le condensateur sera-t-il amené à disparaître dans le futur pour être remplacé par un autre composant ? \\

Il est évident que l'importance du condensateur est telle qu'il parait irremplaçable. \\ 
En effet, on ne peut se passer d'un telle composant dans un circuit électronique.\\
 Cependant, depuis quelques années un composant est utilisé de plus en plus : le super-condensateur. \\

\section{Les supercondensateurs}

Les supercondensateurs sont une sous-catégorie des condensateurs électrolytiques.\\ 
Ils permettent de stocker une très grande quantité d’énergie grâce à une combinaison de 2 technologies de capacité. \\

La capacité double couche que l’on retrouve dans les condensateurs électrolytiques et la pseudo-capacité. \\
L’une est électrostatique et l’autre électrochimique.\\


Cela leur permet de combiner les caractéristiques des condensateurs ordinaires et celles des batteries.\\ 
En effet grâce à ces technologies ils peuvent atteindre des capacités allant jusqu’à 12 000F, tout en ayant des temps de charge et décharge très rapide comparable aux condensateurs ordinaires.\\
 Toutes ces caractéristiques en feraient de bons candidats pour remplacer nos batteries au lithium.\\
 
 Mais c’était sans compter leurs défauts. Ils sont en effet très chers à produire, possèdent une faible énergie spécifique (Rapport en Wh/kg entre l’énergie électrique fournie par unité de temps et la masse du convertisseur) et une tension de décharge linéaire.\\
 Cela entraînerait de grandes chutes de tension d’alimentation très rapidement.\\

Le supercondensateur sera probablement l'avenir pour le stockage d'électricités, qui a terme remplacera sûrement les batteries des véhicules électriques.\\

Cependant, il est trop puissant pour le mettre dans la majorité des circuits électroniques. La science progresse énormément dans ce domaine. 
%\addPartText{Théorie sur les alimentations}
\part{Les alimentations linéaires et à découpage}

\chapter{Les alimentations linéaires}
\section{Introduction}

Il existe deux grandes familles d'alimentations : 

\begin{items}{orange}{\Triangle}
    \item Les alimentations linéaires
    \item Les alimentations à découpage \index{découpage}
\end{items}

Les alimentations linéaires sont réputées pour avoir une tension stable et propre (tension continue).\\
Regardons de plus près le principe de ces alimentations.

\section{L'objectif}

On souhaite transformer une tension sinusoïdale\footnote{De valeur efficace 230V et de fréquence 50 Hz} en une tension continue, 
stable et régulée.

\vfill
\begin{graphicFigure}{0.8}{1}{0}{0.08}{-230}{230}{t(s)}{Tension (V)}{Les tensions d'entrée et de sortie de notre alimentation}
  \addTrace{blue}{0}{0.08}{230*sin(50*360*\x)}
  \addTrace{orange}{0}{0.08}{12}
  \addTrace{black}{0}{0.08}{0}
  \addLegend{Entrée, Sortie, 0V}
  \end{graphicFigure}

  \newpage
  \section{Le choix du transformateur}

  Pour notre circuit, nous devons connaître la tension finale en sortie de notre alimentation.\\
  Au vue des composants demandés (régulateurs, pont de diode), il faudra une tension efficace de $12V$\footnote{Nous verrons 
  la justification de cette valeur par la suite.}
  Le rapport des bobines de notre transformateur sera donc au minimum de \bold{19}. \\Cela veut dire que pour 19 enroulements dans 
  la bobine primaire, il en faudra une seule dans la bobine secondaire.

  La puissance demandée pour le transformateur n'est pas critique, la puissance absorbée par le circuit en aval est négligeable.

  Notre transformateur va donc abaisser la tension du secteur en une tension plus faible.

  \begin{graphicFigure}{0.6}{0.6}{0}{0.08}{-230}{230}{t(s)}{Tension (V)}{Les tensions d'entrée et de sortie du transformateur}
    \addTrace{blue}{0}{0.08}{230*sin(50*360*\x)}
    \addTrace{red}{0}{0.08}{14*sin(50*360*\x)}
    \addTrace{black}{0}{0.08}{0}
    \addLegend{Entrée, Sortie, 0V}
    \end{graphicFigure}

    \newpage 
  \section{Le pont redresseur de tension}

  \subsection{Principe}
  Notre objectif est maintenant de supprimer la composante négative de notre signal. Pour cela, on va utiliser la propriété des 
  diodes qui ont la faculté de laisser passer le courant dans un seul sens.\\
  Un montage existant est le Pont de Graetz. 
  \index{Pont de Graetz}

  \img{\rootImages/diode.png}{Le pont de diode}{0.5}

  Observons le résultat lorsque nous mettons notre tension de sortie du transformateur sur notre entrée de pont.

  \begin{graphicFigure}{0.6}{0.6}{0}{0.08}{-20}{20}{t(s)}{Tension (V)}{Les tensions d'entrée et de sortie du pont de diode}
    \addTrace{blue}{0}{0.08}{12*sin(50*360*\x)}
    \addTrace{red}{0}{0.08}{abs(15.64*sin(50*360*\x))}
    \addTrace{black}{0}{0.08}{0}
    \addLegend{Entrée, Sortie, 0V}
    \end{graphicFigure}

  On constate que la tension de sortie est plus élevée que notre tension d'entrée.\\
  Cette valeur s'explique par les diodes. 
  
  En sortie, nous voulons une tension de \(15V\). Or, les $12V$ en entrée de notre pont sont une valeur efficace, ce qui veut dire 
  que la valeur réelle vaut $17.04V$

  Or, à chaque changement de polarité dans notre pont (signal alternatif [positif et négatif]), le courant passe à travers 
  deux diodes.\\

  Chaque diode engendre une chute de tension de $0.7V$, d'où une perte de $1.4V$ en sortie.

  Nous avons comme tension finale en sortie de pont: 

  $$V_{s} = V_{efficace}\cdot \sqrt{2} - 0.7\cdot 2 = 12\cdot 1.41 -1.4 = 15.64 V$$


  \subsection{Un exemple de boîtier}

    La plupart des boîtiers possèdent 4 broches

    \begin{items}{blue}{\Triangle}
      \item deux broches $V_{~}$ pour la tension alternative
      \item Une broche $V_-$ pour la masse du circuit en aval
      \item Une broche $V_+$ pour la tension positive du circuit en aval
   \end{items}

  \img{\rootImages/case.png}{Un exemple de boîtier}{0.2}


  \section{Les condensateurs}

  \subsection{Principe}
  Comme vu à la section précédente, notre signal n'est pas continu et possède des oscillations élevées.
  Nous cherchons à produire une tension continue.\\

  Pour cela, nous allons utiliser des condensateurs.\\

  Leur rôle sera d'accumuler de l'énergie lorsque le signal monte en amplitude et de restituer cette énergie lorsque le signal sera sur sa phase descendante.

  \img{\rootImages/signal.png}{Le rôle du condensateur}{0.6}

  \subsection{Choix de la valeur}
  Plus la valeur du condensateur est élevée, plus notre signal sera lisse en sortie, ce qui est l'effet recherché.\\
  En effet, la capacité du condensateur exprime la quantité d'énergie emmagasinée dans le condensateur.\\

  Un condensateur de $1mF$ et plus est une valeur normale.\\
   Une fois notre tension assez propre (même si elle présente des oscillations), nous allons utiliser les régulateurs de tensions.

  \section{Les Régulateurs de tension}

  \subsection{Principe et branchements}
  Ces composants à trois broches servent à stabiliser une tension pseudo-continue en une tension continue et stable, c'est à dire ne présentant pas d'oscillations.\\


  Le branchement est le suivant : \\

  \img{\rootImages/lm.png}{Un régulateur de tension}{0.8}

  \begin{items}{blue}{\Triangle}
    \item L'entrée INPUT est la tension à réguler
    \item La broche GROUND est la masse du circuit
    \item la sortie OUTPUT est la tension régulée (stable)
\end{items}

\subsection{Les familles des régulateurs}

  Il existe différentes familles de régulateurs linaires, les plus connus étant les LM78XX\footnote{XX prend la tension régulée de sortie (5,9,12,15,18V...)} ou les LM317 qui sont des régulateurs de tension réglables.\\
  Pour des tensions négatives, se référer à la famille des LM79XX.\\

  Pour que ces composants fonctionnent correctement, il convient de leur mettre en entrée une tension supérieure à leur tension de régulation.\\

  Concrètement, si on utilise un LM7812 (régulateur 12 V), il faudra mettre en entrée au moins 15 V pour que le composant fonctionne dans la plage idéale.\\

  \bold{Cette tension de $15V$ justifie la valeur de tension du transformateur.}

  Ces composants sont linéaires, c'est à dire que la différence de tension entre l'entrée et la sortie ($V_{e}-V_s$) 
  engendre une perte de puissance dans le système.\\
  Cette perte dépend directement du courant absorbé par le circuit en aval mais également de la différence de tension $(V_e-V_s)$.\\
  Cette puissance vaut : $$ P_{perdue} =(V_e-V_s)\cdot I_{charge} ~~~~(W)$$

  \subsection{Un exemple}

  On souhaite réguler un circuit en 12V, ce dernier consommant 150 mA ($I_{charge}$).

  La perte d'énergie vaut $$ P_{perdue} =(V_e-V_s)\cdot I_{charge} =(15-12)\cdot 0.150 = 0.45 W$$

  \subsection{La résistance thermique  des régulateurs}
  \index{Résistance thermique}
  En fonction de cette puissance perdue, il est possible de calculer l’élévation de la température du régulateur de tension.
  La documentation technique des régulateurs de tension précise la valeur de la résistance thermique, c'est à dire de l'élévation de température lorsque le composant dissipe 1 Watt en pure chaleur.%\addPartText{Théorie sur les signaux et leur traitement}
\part{Les signaux}
\chapter{Les signaux}

\section{Introduction}

Un signal est une évolution d'une grandeur physique.\\
Il permet donc de caractériser cette grandeur qui peut ensuite être traitée par un circuit adapté.


\begin{itemize}
    \item Les signaux numériques
    \item Les signaux analogiques
\end{itemize} 

\subsection{Les grandeurs physiques}

Afin de mieux comprendre comment un signal peut se former, nous allons étudier les notions de tensions, 
de courant et de résistances électriques.
Pour cela, plongeons nous dans la matière, au niveau des électrons

\subsection{Les atomes}


\subsection{Les électrons}

Les électrons forment la couche extérieure de l'atome, element insécable de notre univers.

%image atome.

Lorsqu'un électron se déplace dans l'espace, ce dernier engendre un courant.\\

%\box{Le courant électrique est le nombre d'éléctrons par unité de temps}
%\boxed{Le~courant~électrique~est~le~nombre~d'éléctrons~par~unité~de~temps}\\


La charge électrique représente quant à elle le nombre d'électron à un endroit donné et à un temps précis.

\section{La tension électrique}

Nous avons vu que le courant est une nombre de charges par unité de temps. \\
Comment pouvons nous engendrer ce courant ? Tout simplement en soumettant une différence de potentiel, 
autrement dit une \bold{tension}

\section{Analogie}
\newcommand{\A}{$A~$~}
\newcommand{\B}{$B~$~}

Afin de mieux comprendre ce principe, faisons une analogie.

Prenons un rivière, un barrage et une montagne.\\

Soit deux points sur une route dont nous pouvons régler la hauteur en chaque point. On considère une goutte d'eau entre ces points. \\
Notre objectif est de déplacer notre goutte d'un point à l'autre.\\

>> Comment faire ?\\

En surélevant le point \A et en abaissant notre point \B, notre goutte va descendre du point le plus élevé au plus bas.\\

Le courant fonctionne de la même manière : \\

\bold{Il ira toujours du potentiel le plus haut au plus faible.}

Pour la petite histoire, historiquement, le sens du courant étaient du potentiel le plus élevé au plus faible.\\
Bien des années plus tard, les scientifiques se sont rendu compte que le courant allait en réalité du
potentiel le plus faible au plus élevé. Néanmoins, la convention a été gardée...


\subsection{Exemples}
\begin{question}
Soient \A et \B nos deux points du circuits. Ces deux points sont soumis à une tension $U_A$ et $U_B$\\
Quel est le sens de parcours du courant (de \A vers \B, de \B vers \A ou bien autre chose) ?

\begin{figure}[!h]
    \centering
\begin{tabular}{|c|c|c|}
    \hline
    $U_A$ (V) & $U_B$ (V) & Sens du courant ?\\
    \hline
    10 & 5 & \\
    \hline
    5 & 10 & \\
    \hline
    5 & 5 &\\
    \hline
\end{tabular}
\caption{Question sur le sens du courant en fonction des tensions $U_A$ et $U_B$}
\end{figure}
\end{question}%\addPartText{Théorie sur les circuits logiques}
\part{Les circuits logiques}
\chapter{Les familles des circuits logiques}

\section{Présentation}

Les circuits logiques sont des éléments permettant de réaliser des opérations avec l'algèbre de Boole 
(uniquement des '0' et des '1').\\
Pour réaliser ces opérations (ET, NON, OU, NON-OU, NON-ET...), des circuits ont vu le jours dans les années 60 avec deux grandes familles de circuits : \\
\begin{items}{blue}{\Triangle}
    \item La famille TTL \glossary{TTL}
    \item La famille CMOS \glossary{CMOS}
\end{items} 


De nouvelles technologies arrivent à maturité mais nous ne les évoquerons pas ici.

\subsection{Principe TTL}

Les circuits TTL sont composées de transistors bipolaires NPN ou PNP. \\
Les transistors bipolaires sont commandés en courant.


\subsection{Principe CMOS}

La famille CMOS, quant à elle, repose sur l'utilisation en interne de transistors MOS complémentaires (C). \\
Les transistors MOS, du fait de leur structure, sont commandés en tension.


\section{Comment les distinguer ?}

La famille des CMOS est rapidement identifiable car le nom du composant contient un numéro commençant par 40 et se termine avec un nombre à 2 ou 3 chiffres (40XX ou 40XXX). \\

Par exemple, CD4001, CD4017 sont des composants CMOS. \\



La famille des TTL contient en général le chiffre 74\footnote{La série militaire des TTL possède le numéro 54 et possède de meilleurs caractéristiques : plage de température de fonctionnement plus élevée, fréquence plus élevée...} encadré par des lettres et des chiffres. \\





\section{Avantages et inconvénients}

\begin{items}{blue}{\Triangle}
    \item Les TTL consomment plus de courant que les CMOS \footnote{Ces derniers consomment uniquement lors des phases de commutation}
    \item Les CMOS ont des fréquences de fonctionnement plus faibles que les TTL.
\end{items}%\addPartText{Présentation de l'environnement Arduino et de son langage}
\partImg{L'environnement Arduino}{\rootImages/uno.jpg}{0.5}
\chapter{Introduction}

Ce document vise à présenter le projet Arduino et ses supports\\
Ce tutoriel a pour but également de présenter certaines possibilités d'Arduino en terme de langage et de 
ressources. \\
Bien évidemment, cette section n'est pas du tout exhaustive.

\section{Origines}

Arduino est née en 2004 sous l'impulsion d'étudiants italiens souhaitant promouvoir l'accès à  l'électronique. 
Ils se rencontraient fréquemment dans un bar pour développer leur projet. \\
Aujourd'hui, \underline{Arduino} c'est:
\begin{items}{blue}{\Triangle}
\item Un langage de programmation basé sur le C++
\item Une communauté
\item Un projet Open-Source
\end{items}

\section{Supports}

Arduino disposant d'une communauté assez vaste, de nombreux supports existent. \\
Nous avons notamment le site officiel d'Arduino à l'adresse suivante:

\underline{arduino.cc/Reference/en} \\

Le langage Arduino est compatible avec les instructions du C++ dans la mesure ou le compilateur pour Arduino est g++.
Ainsi, les types composés comme les structures et classes sont supportés, tout comme le mot clé auto par exemple.


\chapter{Présentation}

Nous utilisons des cartes Arduino Uno, basées sur les microcontrôleurs Atmega-328 du fabricant ATMEL.\\
Les microcontrôleurs sont des unités contenant dans un seul boîtier une mémoire, un processeur et des 
interfaces entrées-sorties pour ne citer que ces elements.
 \\
 Cela permet notamment de dialoguer avec des périphériques\footnote{Voire section Protocoles de communication}

\section{Le microcontrôleur}


\subsection{Alimentation}

\subsubsection{Tension d'alimentation}

Le microcontrôleur doit être alimenté entre 1.8 V et 5.5 V. \\
Il existe deux façon d'alimenter la carte Arduino: 

\begin{items}{blue}{\Triangle}
\item Via le port USB 
Le port USB délivre du 5V régulé avec un courant maximal de 500 mA (cas général)
\item Via la broche Vin (connectique Jack femelle)
La carte Arduino possède un régulateur intégré de tension en 5 V, ce qui permet d'alimenter la carte entre 7V et 20V

\end{items}

\subsubsection{Courants d'entrées-sortie}

\subsection{Fréquence d'horloge}

La carte Arduino comporte un oscillateur de 16 MHz même si en interne du microcontrôleur, 
un oscillateur de 8 Mhz est intégré.\\
Cela donne une idée des performances maximales de l'Arduino.



\subsection{Mémoire}

Ce microcontrôleur dispose de clé \textbf{32 ko} de clé \textbf{mémoire flash}, c'est à dire la mémoire 
pour stocker le programme téléversé vers la carte. \\


Quand à la clé \textbf{mémoire vive (SRAM)}, elle est de \textbf{2 ko} et est utilisée pour les 
variables du programme en cours d’exécution. \\
Cette mémoire peut être donc vite saturée lors de l'utilisation de grands tableaux par exemple. \\


Enfin, le  possède une mémoire effaçable électriquement, appelée \textbf{EEPROM}\footnote{Référence: 
arduino.cc/Reference/EEPROM}, lors de l’exécution du programme. \\
Cette mémoire occupe \textbf{1 ko} et chaque registre de cette mémoire, pouvant stocker un nombre 
codé sur 8 bits (type byte ou char), peut être modifiée 100 000 fois avant son arrêt définitif.\\


\section{Caractéristiques électriques}

Le microcontrôleur dispose d'entrée sorties permettant d’interagir avec des périphériques 
(Diodes électroluminescentes, capteurs, modules de communication\ldots) \\

Les entrées sont deux types: 

\begin{items}{blue}{\Triangle}
\item entrée \textbf{numérique}: la valeur lue sera perçue comme un niveau logique 0 ou 1 sur les broches allant de 1 à 13
\item entrée \textbf{analogique}: Un Convertisseur Analogique-Numérique 10 bits est intégrés sur les broches A0, A1, A2, A3, A4 et A5
De ce fait, le CAN \glossary{CAN} est possède une résolution de 4.84 mV avec une référence de tension à 5V\footnote{Il est également possible de changer la tension de référence de la carte Arduino 
arduino.cc/Reference/en/language/function/analog-io/analogreference}
\end{items}

Astuce: Il est possible de configurer les broches analogique en broches digitales. 

\chapter{Le langage}

\section{Les types}


Par défaut les types sont signés, c'est à dire que la plage de valeur pour un nombre codé sur \emph{n} bits est compris entre $ \frac{-2^n}{2} $ et $ \frac{2^n+1}{2} $ 
Pour définir un type non signé, c'est à dire pour agrandir la plage positive, il suffit d'ajouter le mot clé \textbf{unsigned} avant les types concernés.

\subsubsection{Les types supportés}

\begin{items}{blue}{\Triangle}
\item \textbf{byte} \textit{[1 octet]} \\
Désigne la plus petite unité de mémoire allouable, permettant de stocker un nombre entier compris entre -127 et + 127.
\item \textbf{unsigned byte} \textit{[1 octet]} \\
Idem mais la plage de valeur strictement positive

\item \textbf{int}    \textit{[2 octets]} \\
Permet de stocker un nombre entier compris entre -32536 et +32536
\item \textbf{unsigned int} \textit{[2 octet]} \\
Idem mais la plage de valeur strictement positive

\item \textbf{float}  \textit{[4 octets]} \\
Permet de manipuler des réels
\item \textbf{double} \textit{[4 octets]} \\
Idem, mais ce type est plus précis que le type float et demande plus de ressources au microcontroleur. 

\item \textbf{char} \textit{[1 octets]} \\
Ce type est utilisé pour stcoker et traiter des caractères de la table ASCII.\@
\item \textbf{String} \textit{[4 octets]} \\
String est un type élaboré qui permet de traiter des chaines de caractères.
\end{items}

\subsubsection{Les types non supportés}

Les types \textbf{vector}, \textbf{array} et \textbf{tuple} ne sont pas supportés par le langage Arduino.




\section{Les fonctions}

\subsection{Les fonctions mathématiques}

En ce qui concerne les fonctions mathématiques, les fonctions trogonométriques sont incluses.



\chapter{Les broches d'interruption}

Dans certains cas, il est souhaitable de récuperer la valeur d'une broche à tout moment du programme, même quand celui ci est occupé dans une tâche et même dans une fonction de temporisation \footnote{Voir delay(), delayMicroseconds()}. \\
Pour remédier à ce problème, on peut utiliser les \textcolor{blue} {\textbf{broches d'interruption}} qui permettent de récuperer la main sur l'ensemble du programme lorsque'un évènement survient sur une broche.\\

Concrètement, lorsque un évènement  \emph{e} survient sur la broche \emph{b}, la fonction \emph{f} est appelée, quelque soit l'état du programme principal. \\


Prenons le cas d'un bouton qui doit changer l'état d'une LED à n'importe quel moment du programme.


\begin{Cpp}{Code d'exemple}

	int ledPin = 13;    //Led interne
	int BOUTON = 2;  //Bouton relié à la broche 2 avec une résistance de charge
	
	volatile int state = LOW;  //Etat courant de la LED
	
	void setup() {
	  
	  Serial.begin(9600);//Vitesse de communication à 9600 bit/s
	  
	  pinMode(ledPin, OUTPUT);                //Led mise en sortie
	  pinMode(BOUTON, INPUT_PULLUP);    //Bouton mis en entrée
	  
	  attachInterrupt(digitalPinToInterrupt(BOUTON), onEvent, CHANGE);  //Appel de la fonction onEvent à chaque changement de front du bouton
	  Serial.println("Init");
	}
	
	void loop() {
	  
	 delay(5000); //Pause du programme principal
	  
	}
	
	void onEvent() {
	  
	  state = !state; //Inverse l'état de la LED
	  
	  if(state){
		Serial.println("ON");
	  }else{
		Serial.println("OFF");
	  }
	   digitalWrite(ledPin, state); //Met à jour l'état de la LED
	}
	
\end{Cpp}


Ici, quelque soit l'action effectuée dans la fonction loop, dès qu'un front montant est détecté sur la broche BOUTON (2), 
la fonction onEvent() sera exécutée et changera l'état de la LED à chaque front



\subsection{Mode d'interruption}

Il existe différents modes pour les broches :

\begin{items}{blue}{\Bullet}
	\item RISING: front montant
	\item FALLING: Front descendant
	\item CHANGE: Front montant et descendant
\end{items}

\subsection{Chronogrammes d'interruption}


\begin{numeric}{Exemple avec mode RISING}
	BOUTON & LLLLLLLHLLLLLLLLLL \\
	loop &  7D{EXECUTION} 6D{PAUSE} 7D{REPRISE} \\
	onEvent & 7D{INACTIVE} 6D{EXECUTION} 7D{INACTIVE} \\
\end{numeric}


\begin{numeric}{Exemple avec mode FALLING}
	BOUTON & LLLLLLLHLLLLLLLLLL \\
	loop &  8D{EXECUTION} 6D{PAUSE} 6D{REPRISE} \\
	onEvent & 8D{INACTIVE} 6D{APPEL} 6D{INACTIVE} \\
	\end{numeric}



\begin{numeric}{Exemple avec mode CHANGE}
	BOUTON & LLLLLLLHHHHHHHHHHHHHHLLLLLLLLLLLLLL \\
	loop &  7D{EXECUTION} 8D{PAUSE} 6D{REPRISE} 8D{PAUSE} 6D{REPRISE}  \\
	onEvent & 7D{INACTIVE} 8D{EXECUTION} 6D{INACTIVE} 8D{EXECUTION} 6D{INACTIVE}\\
	\end{numeric}

\chapter{Synthèse Arduino}


\subsection{Matériel}

\begin{items}{blue}{\Triangle}
\item Mémoire Flash: 32 ko
\item Mémoire Vive (SRAM): 2 ko 
\item Fréquence d'horloge: 16 MHz 
\end{items}



\subsection{Électriques}

\begin{items}{blue}{\Triangle}
\item Impédance d'entrée: $> 1 MOhm$
\item Courant de sortie par broche: $40$ mA maximum
\item Courant de sortie pour toutes les broches entrée-sorties: $200$ mA
\end{items}



\section{Calcul d'une résistance}


$$ U = RI $$

avec 

\begin{items}{blue}{\Triangle}
    \item U la tension en V (Volt)
    \item R la résistance en $\Omega$ (Ohm)
    \item I le courant en A (Ampère)
\end{items}

Or, 
$$ R = \frac{U}{I} $$

On cherche à déterminer la valeur de R avec un I imposé et un $U_{led}$ imposée par la couleur de la led. \\
D'où : 
$$ R_{led} = \frac{U_{arduino} - U_{led}}{I_{led}}$$

$$ R_{led} = \frac{5-1.6}{0.01} = 340 \Omega$$%\addPartText{Théorie sur les servo-moteur et applications pratiques avec Arduino}
\partImg{Les servomoteur}{\rootImages/img.jpg}{0.4}
\chapter{Présentation}

\newcommand{\servo}{servo-moteurs } 

\index{Servo-moteurs}

Les \servo sont utilisés lorsqu'on souhaite un asservissement en position d'un axe de rotation.



\section{Asservissement}

Un asservissement est un processus de correction pour maintenir une consigne. \\
Par exemple, un régulateur de vitesse dans une voiture est un système asservi car la vitesse 
doit être constante quelle que soit la pente.


\section{Architecture}

\img{\rootImages/servoInput.png}{Constitution d'un servo-moteur}{1.6}

\section{Domaines d'application}

\begin{items}{blue}{\Bullet}
    \item Modélisme
    \item Robotique
\end{items}

\section{Commande des \servo}

Les \servo ont besoins d'être contrôlés via un signal \glossary{PWM} ou \glossary{MLI}. %\footnote{Pulse Width Modulation : Modulation par Largeur d'Impulsion \index{PWM}}

\subsection{Principe de la PWM}

La PWM est la création d'un signal numérique dont le temps à l'état haut est variable.\\
On fait varier le rapport cyclique (appelé $r$) qui est compris entre 0 et 1.

$$ r = \frac{T_{on}}{T_{signal}} $$


\img{\rootImages/PWM.png}{Différents rapports cycliques}{0.5}

\subsection{Trame de commande servomoteurs}

Pour indiquer une consigne de position, il faut faire varier le rapport cyclique 
du signal envoyé au servomoteur.

La période des signaux est de 20 ms et le temps à l'état Haut du signal représente la position : 

\begin{items}{blue}{\Triangle}
\item 1 ms : 180$^\circ$
\item 1.5 ms : 90$^\circ$
\item 2 ms : 0$^\circ$
\end{items}

\img{\rootImages/TRAME.png}{Une trame PWM}{0.5}

\section{Branchement d'un servo-moteur}

\begin{items}{blue}{\Bullet}
  \item Câble noir ou marron : GND 
  \item Câble rouge : +5V
  \item Câble blanc ou jaune : Signal Arduino (9)
\end{items}


\img{\rootImages/pinout.png}{Branchement d'un servomoteur}{0.3}

\subsection{Code Arduino}


\begin{Cpp}{Variation de la position d'un \servo}

  #include <Servo.h>      //Inclusion de la bibliothèque Servo
  Servo myservo;  // Création d'un objet Servo
  int pos = 0;    //Angle du servomoteur
  
  void setup() {

    myservo.attach(9);  //Choix de la broche du servo moteur

  }
  
  void loop() {

    for (pos = 0; pos <= 180; pos += 1) { //Parcours la plage angulaire [0-180] degré par degré

      myservo.write(pos);              //Actualise la position 
      delay(15);                       //Attend 15 ms avant l'actualisation

    }//Fin for

    for (pos = 180; pos >= 0; pos -= 1) {     //Parcours la plage angulaire [0-180] degré par degré

      myservo.write(pos);              //Actualise la position 
      delay(15);                       //Attend 15 ms avant l'actualisation

    }//Fin for
  }//Fin loop

\end{Cpp}


\section{Caractéristiques}


\subsection{Electriques}


\begin{items}{blue}{\Bullet}
  \item Tension de commande et d'alimentation : \~5V
\end{items}

\subsection{Mécaniques}

\begin{items}{blue}{\Bullet}
  \item Couple de sortie (Nm)
  \item Vitesse de rotation (temps pour parcourir 60°)
\end{items}




\section{Pour aller plus loin}

\subsection{Une autre application de la PWM}

En faisant varier la tension de sortie dans le temps rapidement ($>$50Hz), on peut simuler une 
tension analogique.\\

Voici un code d'exemple pour faire varier la luminosité d'une LED.

\begin{Cpp}{Variation de la luminosité d'une LED}

  const int pin_led = 11; //Selection d'une broche PWM

  float duty_cyle[11] = {0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0};//Création d'un tableau avec les différents 
  rapports cycliques
  
  void setup() {
  
      pinMode(pin_led, OUTPUT);  //Mise en sortie de la broche LED
  
  }//Fin setup
  
  void loop() {
  
      for(int i=0;i<11;i++) 
      {
          int value_r = duty_cyle[i]*255.0; //Conversion d'une valeur entre 0 et 1 en une valeur entre 0 et 255
          analogWrite(pin_led, value_r); //Change le rapport cyclique pendant 3 s
          delay(600);        //Attend 0.6s
      }
      
  
  }//Fin loop

\end{Cpp}


%https://howtomechatronics.com/how-it-works/how-servo-motors-work-how-to-control-servos-using-arduino/%\addPartText{Théorie sur les moteurs pas-à-pas et applications pratiques avec Arduino et ESP8266}
\partImg{Les moteurs pas-à-pas}{\rootImages/img.jpg}{0.4}
\chapter{Présentation}


\newcommand{\pap}{moteur pas-à-pas~} \index{Moteurs pas-à-pas}
\newcommand{\paps}{moteurs pas-à-pas~}

Les \pap sont utilisés lorsqu'on souhaite un asservissement en position d'un axe de rotation 
avec une précision inégalée par les servomoteurs.
\index{asservissement}


\subsection{Constitution}

Les \pap sont constitués de :
\begin{items}{blue}{\Triangle}
\item Plusieurs bobines (un pôle forme une paire de bobines)
\item Un aimant qui sert d'axe de rotation
\end{items} \index{bobine}

\subsection{Les types de \pap}

\begin{items}{blue}{\Triangle}
  \item \pap à phase bipolaire
  \img{\rootImages/moteur_bipolaire.png}{\pap bipolaire}{0.4}
  \item \pap à phases unipolaires
  \img{\rootImages/step_wire.png}{\pap unipolaires}{0.4}
  \item \pap à reluctance variable (non abordés ici)
  \end{items}

\subsection{Principe}

En faisant varier le champ électromagnétique des différentes phases, on peut faire varier la position angulaire de l'aimant.

\subsubsection{Exemples avec phases bipolaires}

En alimentant une paire de phases avec une tension positif, l'aimant se place dans l'alignement du champ électromagnétique 
formé par la paire de phase.\\
En alimentant la paire de phase avec une tension négative, l'aimant se place dans le sens contraire.\\

\img{\rootImages/step1.png}{Pas 1}{0.3}
\img{\rootImages/step2.png}{Pas 2}{0.3}
\img{\rootImages/step3.png}{Pas 3}{0.3}


\subsubsection{Exemples avec phases unipolaires}

\img{\rootImages/ste2.png}{Pas 1}{0.3}
\img{\rootImages/ste21.png}{Pas 2}{0.3}
\img{\rootImages/ste22.png}{Pas 3}{0.3}

Les moteurs possèdent plus de phases car un débattement de 45° est vite limité.
\img{\rootImages/inside.png}{Un intérieur de moteur}{1}

Les \pap unipolaires présentent l'avantage de faire circuler un courant positif dans le circuit de commande. 
Ils sont donc plus simples à mettre en oeuvre mais ils nécessitent plus de bobinage.

\chapter{Commande des \paps}

\section{Moteurs unipolaires}
Les \pap unipolaires ont besoins d'être contrôlés via un circuit adaptés, le plus connu est le \lbl{blue}{REF}{ULN2803}

\img{\rootImages/udn.jpg}{Driver ULN2803}{0.6}


Pour les moteurs unipolaires, il faut mettre une des phases à la masse pour faire circuler le courant dans la phase \footnote{Due au cable relié à l'alimentation positive du moteur}

On constate sur la figure suivante un montage Darlington : deux transistors NPN forme un seul transistor dont le coefficient
$\beta$ est le produit de chacun des coefficients $\beta$ de chaque transistor.

Cela permet de contrôler des charges avec très peu de courant de commande. \footnote{Se référer à la partie \bold{Circuits de puissance}}

\img{\rootImages/darlington.png}{Contrôle d'une phase}{0.6}

\img{\rootImages/uln_pinout.png}{Driver de controle}{0.6}

\section{Moteurs bipolaires}

On a vu qu'il fallait inverser la tension de commande au borne des bobines. Pour cela on peut utiliser le montage en pont en H.

\img{\rootImages/pont.png}{Structure du pont en H}{0.5}

\begin{items}{blue}{\Bullet}
  \item En activant S1 et S4 (fermeture du circuit), la charge est parcourue par un courant allant de gauche à droite
  \item En activant S2 et S3 (fermeture du circuit), la charge est parcourue par un courant allant de droite à gauche
\end{items}

Et qui dit inversion de courant dit inversion de tension. Notre objectif est atteint, nous pouvons mettre des tensions positives 
et négatives aux bornes des phases de nos moteurs.\\

Ce principe est également utilisé pour contrôler les moteurs à courant continu

On peut utiliser le circuit \lbl{blue}{REF}{L298}

\img{\rootImages/l298.jpg}{Un pont en H intégré}{0.3}

\subsection{Avantages et inconvénients des \paps}

\begin{items}{green}{\Bullet}
    \item Très grande précision en boucle ouverte \footnote{Contrôle sans asservissement, contrairement aux servomoteurs}
    \item Couple élevé en bas régime
\end{items}

\begin{items}{red}{\Bullet}
  \item Plus lent qu'un servomoteur
  \item Complexité de mise en oeuvre
\end{items}


\subsection{Domaines d'application}

\begin{items}{blue}{\Bullet}
    \item Imprimantes
    \item Machines CNC
\end{items}


\section{Comment distinguer les différents types de moteurs ?}


\begin{items}{blue}{\Bullet}
  \item 2 fils = moteur à courant continue
  \item 3 fils = servomoteurs
  \item 4 fils = \pap bipolaire
  \item 5 fils = \pap unipolaire
\end{items}


\chapter{Exemples}

\section{Mise en pratique avec Arduino} 

Nous utiliserons un \pap \bold{28BYJ-48} de type unipolaire. 

\img{\rootImages/byj.png}{Le moteur 28BYJ-48 }{0.3}

Les caractéristiques sont les suivantes : 
\begin{items}{blue}{\Bullet}
  \item Nombre de pas : 2048
  \item Tension d'alimentation : 5V
\end{items}

Pour augmenter le nombre de pas, on ajoute un train d'engrenage.
\img{\rootImages/reduce.jpg}{Une augmentation du nombre de pas}{0.8}

\subsection{Liste du matériel}

\begin{items}{blue}{\Bullet}
  \item Carte Arduino Uno
  \item Driver ULN2803
  \item Moteur \pap 28BYJ-48 ou équivalent
  \item Câbles
\end{items}


\subsection{Branchements}

Nous utiliserons les broches 8, 9, 10 et 11 et  l'alimentation 5V du moteur sera fournie par la broche +5V de l'Arduino

\begin{items}{blue}{\Bullet}
  \item D1 sur IN1
  \item D2 sur IN3
  \item D5 sur IN2
  \item D6 sur IN4
  \item Vin sur Vcc
  \item Gnd sur Gnd
\end{items}

\img{\rootImages/arduino.png}{Schéma Arduino}{0.2}

\subsection{Code Arduino}

Ce code fait tourner le moteur d'un tour, attend 2 secondes puis fait un tour dans l'autre sens avec un délai de 2s.

\begin{Cpp}{Code minimaliste Arduino}

#include <Stepper.h> //Inclusion de la bibliothèque Stepper

int nbPas = 2048; //Nombre de pas pour le moteur 28BYJ-48

#define IN1 8  //Broche IN1
#define IN2 9  //Broche IN2
#define IN3 10  //Broche IN3
#define IN4 11  //Broche IN4

Stepper moteur(nbPas, IN1, IN3, IN2, IN4); //Création de l'objet moteur
   
  void setup() {

    moteur.setSpeed(10); //On définit la vitesse à 10 tr/min

  }//Fin setup
   
  void loop() {

    moteur.step(nbPas);   //On avance de nbPas pas, c'est à dire un tour complet (sens horaire)
    delay(2000);          //pause de 2s
    moteur.step(-nbPas);  //On avance de -nbPas pas, c'est à dire un tour complet (sens anti-horaire)
    delay(2000);          //pause de 2s

  }//Fin loop
\end{Cpp} %ENDCODE


\section{Mise en pratique avec ESP8266} 

Nous utiliserons le même \pap 28BYJ-48

\subsection{Liste du matériel}

\begin{items}{blue}{\Bullet}
  \item Carte ESP8266 NodeMCU (ESP-12)

  \img{\rootImages/mcu.jpeg}{ESP12 NodeMCU}{0.8}

  Cette carte fait partie de la famille des ESP8266 et se programme directement avec l’Éditeur Arduino. 
  L'installation des bibliothèques pour l'ESP12 est détaillée en annexe du document.
  \item Driver ULN2803
  \item Moteur \pap 28BYJ-48 ou équivalent (\pap unipolaire)
  \item Câbles
\end{items}


\subsection{Branchements}

Les numéros des broches sont différents sur les cartes ESP812 (modèle NodeMCU).\\
Voici les équivalences des broches entre le code et l'emplacement physique.

\img{\rootImages/nodeMCU.png}{Broches ESP12}{0.4}

Nous utiliserons les broches D1, D2, D5 et D6 et  l'alimentation 5V du moteur sera fournie par la broche Vin de l'ESP12

\begin{items}{blue}{\Bullet}
  \item D1 sur IN1
  \item D2 sur IN3
  \item D5 sur IN2
  \item D6 sur IN4
  \item Vin sur Vcc
  \item Gnd sur Gnd
\end{items}

\img{\rootImages/nodemcu.png}{Schéma ESP12}{0.4}

\subsection{Code ESP12}

Ce code fait tourner le moteur d'un tour, attend 2 secondes puis fait un tour dans l'autre sens avec un délai de 2s.

\begin{Cpp}{Code minimaliste ESP12}

  #include <Stepper.h> //Inclusion de la bibliothèque Stepper
  
  int nbPas = 2048; //Nombre de pas pour le moteur 28BYJ-48
  
  #define IN1 D1  //Broche IN1
  #define IN2 D5  //Broche IN2
  #define IN3 D2  //Broche IN3
  #define IN4 D6  //Broche IN4
  
  Stepper moteur(nbPas, IN1, IN3, IN2, IN4); //Création de l'objet moteur
     
    void setup() {
  
      moteur.setSpeed(10); //On définit la vitesse à 10 tr/min
  
    }//Fin setup
     
    void loop() {
  
      moteur.step(nbPas);   //On avance de nbPas pas, c'est à dire un tour complet (sens horaire)
      delay(2000);          //pause de 2s
      moteur.step(-nbPas);  //On avance de -nbPas pas, c'est à dire un tour complet (sens anti-horaire)
      delay(2000);          //pause de 2s
  
    }//Fin loop
  \end{Cpp}
  %\addPartText{Théorie sur les interfaces de puissance et applications pratiques avec Arduino}
\partImg{Les interfaces de puissance}{\rootImages/power.jpg}{0.5}
\chapter{Introduction}

Pour certains projets plus évolués, on souhaite utiliser des composants tels que des moteurs ou des résistances (chauffage, ventilation).\\

Or, on constate rapidement que le branchement direct de ces éléments sur une carte Arduino va se révéler impossible. \\

En effet, la carte Arduino est prévu pour délivrer de \bold{faibles courants} et \bold{faibles tensions}. Nous allons donc créer un circuit où la puissance et la commande sont dissociés.\chapter{Les transistors bipolaires}

\section{Présentation}

Une des moyens pour créer notre circuit de puissance est le transistor bipolaire. \index{bipolaire}. Ce composant possède trois broches : 

\begin{items}{blue}{\Triangle}

  \item Le collecteur (C)
  \item la base (B)
  \item l'émetteur (E)

\end{items}

\img{\rootImages/bjt.png}{La représentation du transistor bipolaire}{0.1}

\section{Conventions}

Afin de simplifier les calculs par la suite, posons les normes suivantes : 

\begin{items}{blue}{\Triangle}

  \item Le courant entrant dans le Collecteur est appelé $I_{C}$
  \item Le courant entrant dans la Base est appelé $I_{B}$
  \item Le courant sortant de l'émetteur est appelé $I_{E}$

  \item La tension entre la Base et l’Émetteur est appelée $V_{be}$
  \item La tension entre le Collecteur et l’Émetteur est appelée $V_{ce}$
\end{items}

\img{\rootImages/courants.png}{Conventions du transistor bipolaire}{0.6}


Les flèches au sein du transistor indiquent le sens de déplacement du courant sur les broches.

\subsection{Les familles de transistors bipolaires}

Les transistors bipolaires sont classés en deux catégories : 

\begin{items}{blue}{\Triangle}

  \item Les transistors NPN\footnote{Le nom de ces familles provient du type de jonction utilisé en interne. Pour plus de renseignements, consulter les diodes et semi-conducteurs}
  \item Les transistors PNP

\end{items}

Le principe de fonctionnement est similaire entre ces deux familles, seul le branchement et le niveau de commande diffère.\\ Dans ce document, nous utiliserons essentiellement des transistors NPN car ces derniers utilisent des grandeurs positives.

\img{\rootImages/pnppnp.jpeg}{Transistors NPN et PNP}{0.6}


\section{Les paramètres de sélection du transistor}

Notre transistor doit dans un premier temps répondre à deux contraintes : 

\begin{items}{blue}{\Triangle}

  \item La tension admissible sur $V_{ce}$\footnote{Cette tension est indiquée dans les documentations techniques} doit être supérieure à la tension d'alimentation de notre circuit.\\
  Concrètement, si notre circuit est alimenté en 48V mais que le transistor ne supporte pas plus de 30V, il va être détruit.
  \item Le transistor doit supporter un courant plus élevé que le courant maximal transitant dans notre circuit.
  Pour contrôler un moteur consommant 1 Ampère, je dois donc choisir un transistor pouvant contrôler au moins 2 Ampère.
\end{items}

Pour la suite de la présentation, on supposera que notre transistor a été dimensionné pour répondre à ces deux contraintes.


\section{Le principe}

Ce type de transistor fonctionne comme une vanne pour une canalisation. Il est possible de réguler le débit de la canalisation avec la vanne.\\

Le transistor bipolaire permet de contrôler un courant important avec un faible courant.\\

\img{\rootImages/barrage.png}{Le rôle du transistor}{0.3}.

Ici, notre transistor joue le rôle de la vanne et permet de bloquer le courant (électrons) ou bien de les laisser passer. \\


Le courant de l'élément à contrôler (moteur, résistance de puissance) transite entre le collecteur et l'émetteur et le courant de commande passe par la base, comme l'illustre la figure suivante.\\

\img{\rootImages/courant_main.png}{Courant de commande et de puissance}{0.6}

La relation fondamentale reliant le courant de puissance et de commande est la suivante : 

$$ \boxed{ I_{C} = \beta \cdot I_{B} }$$

Le paramètre $\beta$, appelé \bold{gain du transistor}\footnote{le gain \index{gain (transistor)}est sans dimension (unité) et est appelé $ h_fe$ dans les documentations} est une caractéristique interne de notre transistor, c'est à dire qu'il dépend du type de transistor que nous choisissons.\\
Les courants $I_{C}, I_{B},I_{E}$ sont exprimés dans la même unité (Ampère, milliampères..) pour une formule homogène.\\

Les transistors de puissance possède des gains de l'ordre de la dizaine alors que les transistors de signal (faibles courants) ont un gain pouvant facilement atteindre 200 ou 300.

\messageBox{Remarque}{cyan}{white}{Plus notre $\beta$ est faible, plus il va falloir injecter un courant important dans notre base}{black}

\Question{Et que devient notre broche Émetteur" ?}

\begin{reponse}
  
  Notre émetteur est relié à la masse du circuit et permet de le fermer pour que les électrons puissent circuler.\\

  Le courant circulant dans l'émetteur est simplement la somme des courants entrant dans le transistor. \\
  d'où : $$ \boxed{ I_{E} = I_{B} + I_{C} }$$

  \end{reponse}



\section{Exemple}

On souhaite commander l'arrêt et la marche d'un moteur consommant au maximum 0.5A et alimenté avec une tension de 9V. \\
Nous choisissons un transistor permettant de commuter 1A (sécurité) avec $\beta=30$ \\

\Question{Quel doit-être le courant injecté dans la base ?}


\begin{reponse}
  On applique la formule précédent et on obtient : 

  $$  I_{B} = \frac{I_{C}}{\beta} = \frac{0.5}{30} = 16 mA $$

  \end{reponse}

 

\section{Mise en pratique}

\subsection{Branchements}

    Maintenant que nous connaissons les tensions et courants nécessaires à notre transistor et à notre moteur, nous allons le commander avec une carte Arduino. \\

    Tout d'abord, il convient de placer le moteur entre notre alimentation et le collecteur.\\
    

\messageBox{Remarque}{cyan}{white}{Toutes les charges à contrôler avec ce type de transistor se placent entre l'alimentation et le collecteur.}{black}

    Enfin, il ne nous reste plus qu'à relier une sortie numérique de l'Arduino vers notre base par l'intermédiaire d'une résistance.

    \bold{La résistance va servir à imposer le courant dans la base de notre transistor}.

    Nous obtenons donc le schéma suivant.

    \img{\rootImages/schema_pnp.png}{Branchement du transistor bipolaire}{0.4}

    \subsection{Dimensionnement de la résistance}

    On souhaite obtenir un courant de $16 mA$ dans notre base et on sait que l'Arduino délivre du $5V$ en sortie.\\

    Nous somme donc tentés de dire que $R_b = \frac{U_{arduino}}{ I_{B}} = \frac{5}{0.016} = 312 \Omega$ \footnote{On part de la loi de Ohm qui dit que $U=R.I$}\\


    Hélas, il y a peu de chance que votre moteur tourne dans les conditions optimales.\\
    Il convient d'avoir à l'esprit que notre $\beta$ trouvé dans la documentation n'est que théorique et qu'il peut être en réalité inférieur.

    \messageBox{Remarque}{cyan}{white}{Une des conventions non officielles admet que pour de la commutation en Tout ou Rien, on divise la valeur théorique de notre $\beta$ par 2. \\Nous allons donc prendre donc un $\beta$ valant 15.}{black}
    
    On refait donc les calculs.

    $$  I_{B} = \frac{I_{C}}{\beta} = \frac{0.5}{15} = 32 mA $$

    Une dernière chose : les transistors bipolaires entraînent une chute de tension entre la base et l'émetteur ($V_{be}$).\\
    Cette chute de tension dépend de la technologie des transistors bipolaires : 

    \begin{items}{blue}{\Triangle}

      \item $0.7V$ pour les transistors au silicium
      \item $0.3V$ pour les transistors au germanium
    \end{items}
    Dans l'extrême majorité des cas, on utilisera des transistors au silicium. La tension disponible aux bornes de la résistance est donc de $4.3V$ ($5-0.7$)

    D'où : 

    $$ \boxed{ R_{b} = \frac{U_{arduino}-V_{be}}{I_b} = \frac{4.3}{0.032} = 134 \Omega} $$

    \subsection{Exemple de programme Arduino}

    Voici un code permettant de faire tourner le moteur périodiquement pendant 5 secondes puis de l'arrêter pendant 5 secondes.

\begin{Cpp}{Code Arduino avec transistors NPN}
#define D8 8     //Broche 8 de l'Arduino

void setup() {

  pinMode(D8, OUTPUT); //Mise en sortie de la broche

}//End setup

void loop() {

  digitalWrite(D8, HIGH);     //Déclencher la rotation du moteur
  delay(5000);                //Délai de 5s
  digitalWrite(D8, LOW);      //Fin de la rotation du moteur
  delay(5000);                //Délai de 5s

}//End loop

\end{Cpp}
\chapter{Les transistors MOSFET}
\index{MOSFET} 
\section{Présentation}

     Nous avons vu l'utilisation des transistors bipolaires. \\
     Ces derniers sont assez contraignants à mettre en oeuvre car ils sont commandés en courant.

     Nous allons utiliser cette fois-ci la technologie des \glossary{MOSFET} \footnote{MOSFET : Metal Oxide Semiconductor Field Effect Transistor = Transistor à effet de champ à structure métal-oxyde-semi-conducteur} car ces derniers ont l'avantage d'être contrôlés en \bold{tension}.

     Ce composant possède trois broches : 
     
     \begin{items}{blue}{\Triangle}
     
       \item Le drain (D)
       \item la porte (G)\footnote{G pour Gate}
       \item la source (S)
     
     \end{items}
     
     \img{\rootImages/mosfet.png}{La représentation du transistor MOSFET}{0.1}
     
     \section{Conventions}
     
     Afin de simplifier les calculs par la suite, posons également les normes suivantes : 
     
     \begin{items}{blue}{\Triangle}
     
       \item Le courant entrant dans le Drain est appelé $I_{D}$
       \item Le courant entrant dans la Porte est appelé $I_{G}$
       \item Le courant sortant de la Source est appelé $I_{S}$

       \item La tension entre la Porte et la Source est appelée $V_{GS}$
       \item La tension entre le Drain et la Source est appelée $V_{DS}$
     \end{items}
     
     \subsection{Les familles de transistors MOSFET}

     Les transistors MOSFET sont classés en deux catégories : 
     
     \begin{items}{blue}{\Triangle}
     
       \item Les transistors MOSFET à canal N \footnote{Le nom de ces familles provient du type de jonction utilisé en interne. Pour plus de renseignement, consulter les diodes et semi-conducteurs}
       \item Les transistors MOSFET à canal P
     
     \end{items}
     
     Le principe de fonctionnement est similaire entre ces deux familles, seul le branchement et le niveau de commande diffère.\\
     Dans ce document, nous utiliserons essentiellement des transistors MOSFET à canal N car ces derniers utilisent des grandeurs 
     positives.
     
     \img{\rootImages/mos.png}{Transistors à canal N et P}{0.6}

     \section{Les paramètres de sélection du transistor}
     
     Les paramètres de sélection de nos transistors MOSFET sont identiques aux transistors bipolaires, c'est à dire :
     
     \begin{items}{blue}{\Triangle}
     
       \item La tension admissible sur $V_{DS}$ du transistor
       \item Le courant admissible entre le Drain et la Source.
     \end{items}
     
     Pour la suite de la présentation, on supposera que notre transistor a été dimensionné pour répondre à ces deux contraintes.


     \section{Le principe}

     Ce type de transistor fonctionne comme les transistors bipolaires mais est commandé en tension et non en courant.

     Par analogie, le drain joue le rôle du collecteur, la source celui de l'émetteur et la porte celui de la base.\\
     Le courant de l'élément à contrôler (moteur, résistance de puissance) transite entre le drain et la source et la tension de commande est aux bornes de la porte.\\
     
     Les transistors MOSFET deviennent passant\footnote{Le transistor laisse passer tout le courant autorisé.} lorsque la tension sur la porte dépasse une tension de déclenchement appelée $V_{GS_{th}}$.
     Cette valeur est généralement comprise entre $2$ et $4$ Volts.\\

     \bold{Lorsque cette tension} $V_{GS_{th}}$ est atteinte, notre transistor peut être remplacé d'un point de vue électrique entre le drain et la source par une résistance de très faible valeur, appelée $R_{DS_{on}}$

    \section{Comparaison avec les transistors bipolaires}

    Par nature, la porte du MOSFET est vue comme un condensateur. Le transistor ne consomme pas de courant, excepté pendant les commutations.\\
    Ainsi, le courant est nul dans la porte pour maintenir le moteur en marche alors que pour un bipolaire, il faut maintenir un courant dans la base.\\

    Les MOSFET sont donc plus économes en énergie que les bipolaires.\\
    De plus, ils peuvent généralement supporter des courants plus importants que les bipolaires.\\

    En revanche, en hautes fréquences, les MOSFET sont moins réactifs du fait de leur capacité en entrée.
     \section{Mise en pratique}

     Nous souhaitons faire tourner le même moteur que celui utilisé avec notre transistor bipolaire.\\
     Nous allons le commander avec une carte Arduino.

     \subsection{Branchements}

     Tout d'abord, il convient de placer le moteur entre notre alimentation et le drain.\\
     
 
    \messageBox{Remarque}{cyan}{white}{Toutes les charges à contrôler avec ce type de transistor se placent entre l'alimentation et le drain.}{black}
 
     Enfin, il ne nous reste plus qu'à relier une sortie numérique de l'Arduino vers notre porte \bold{sans} résistance. Nous obtenons donc le schéma suivant.
 
     \img{\rootImages/schema_mosfet.png}{Branchement du transistor MOSFET}{0.45}
  
     \subsection{Exemple de programme Arduino}
 
     Voici un code permettant de faire tourner le moteur périodiquement pendant 5 secondes puis de l'arrêter pendant 5 secondes. 
     Il s'agit du même code que pour le transistor bipolaire.
 
 \begin{Cpp}{Code Arduino avec MOSFET}

  #define PIN 11     //GATE du transistor
 
  void setup() {
  
    pinMode(PIN, OUTPUT); //Mise en sortie de la broche
  
  }//Fin setup
  
  void loop() {
  
    digitalWrite(PIN, HIGH);    //Mise en route du transistor
    delay(5000);               //Délai de 5s
    digitalWrite(PIN, LOW);     //Arret du transistor
    delay(5000);               //Délai de 5s
  
  }//Fin loop
  
 \end{Cpp}

 \chapter{Conclusion}

 \section{Ce qu'il faut retenir}

 
 Nous avons à notre disposition tout un ensemble de technologies pour contrôler la partie puissance.

 Les transistors ne sont pas adaptés pour commuter une charge sur secteur (230V), cette partie sera donc réservée aux relais.\\
 En revanche, pour toutes les tensions continues, les transistors sont adaptés et prennent moins de place en encombrement.\\

 \section{Les fiches techniques}

 L'intégralité des informations disponibles pour un transistor sont disponibles dans un document complet appelé \bold{Datasheet}.

 Ce document détaille les broches, les caractéristiques électriques, propose des schémas d'exemples....\\

 Par exemple, voici quelques extraits de la documentation du transistors IRF520\footnote{Transistor de puissance} :

 \img{\rootImages/irf520.png}{Extrait n°1 du IRF520}{0.4}

 \img{\rootImages/rdson.png}{Extrait n°2 du IRF520}{0.5}

 On retrouve sur cette figure la valeur de $R_{DS_{on}}$ et de $V_{GS_{th}}$\part{Les écrans}

\chapter{Les écrans OLED}

\subsection{Les caractéristiques}
Les écrans \glossary{OLED} sont des afficheurs graphiques 
compacts avec une résolution de 128×64 pixels ou 64x32 pixels.\\
Leur résolution plus élevée que des écrans \glossary{LCD} permet d’afficher du texte, des images, et des figures 
graphiques. Ces écrans intègrent généralement un contrôleur, permettant de faire l’interface entre l’écran
en lui même et la carte de commande (Arduino, ESP32...) et utilisent le protocole \glossary{I2C} pour communiquer, avec les broches \glossary{SDA} et \glossary{SCL}.

\img{\rootImages/oled.jpg}{Un écran OLED}{0.25}

La plupart des écrans utilisent le contrôleur SSD1306 et généralement, ces modules OLED s’alimentent de 3,3 à 5V.


\subsection{Installation de la bibliothèque}

Plusieurs bibliothèques sont disponibles pour utiliser l'écran dont la bibliothèque \lib{adafruit\_SSD1306.h}.\\

Pour changer, nous utiliserons la bibliothèque de rinky-dink-electronics à l'adresse suivante : 
\link{OLED\_I2C.zip},  bien documentée et simple d’utilisation

La figure suivante rappelle comment installer rapidement une bibliothèque depuis une archive ZIP.
En l’occurrence, le fichier \file{OLED\_I2C.zip}

\img{\rootImages/library.jpg}{Installation d'une bibliothèque depuis l'archive}{0.6}
L'installation plus détaillé des bibliothèques Arduino est disponible en annexe du document.



\subsection{Branchements}

\begin{items}{green}{\Circle}
    \item La broche \outputPin{+5V} de l'Arduino vers la broche \inputPin{VCC} de l'écran
    \item La broche \outputPin{GND} de l'Arduino vers la broche \inputPin{GND} de l'écran
    \item La broche \outputPin{A4} de l'Arduino vers la broche \inputPin{SDA}de l'écran
    \item La broche \outputPin{A5} de l'Arduino vers la broche \inputPin{SCL} de l'écran
\end{items}

\img{\rootImages/branchementOled.png}{Le branchement de l'écran}{0.45}


\messageBox{Remarque}{orange}{white}{
    Les broches SDA et SCL sont sur des broches différentes pour les carte Arduino Leonardo et Arduino Mega : \\
    \begin{items}{orange}{\Triangle}
        \item Arduino Mega
        \begin{items}{orange}{\Triangle}
            \item SDA : Broche 20
            \item SCL : Broche 21
        \end{items}
        \item Arduino Leonardo
        \begin{items}{orange}{\Triangle}
            \item SDA : Broche 20
            \item SCL : Broche 21
        \end{items}
    \end{items}
}{white}

Plusieurs accès aux broches s'offrent à vous : 
\begin{enumerate}
\item Utiliser les broches I2C du shield
\img{\rootImages/shield1.jpg}{Le branchement sur le SensorShield avec les broches I2C}{0.08}

\item Utiliser les broches A4 et A5 du shield
\img{\rootImages/shield2.jpg}{Le branchement sur le SensorShield avec les broches A5 et A4}{0.08}

\end{enumerate}


\subsection{Programme de l'écran}
\begin{Cpp}{Création de l'objet MyOLED}
    // ----------ppr début ------------------------
    // écran OLED
    // --------------------------------------------
    //
    #include <OLED_I2C.h>
    OLED  myOLED(SDA, SCL, 8);
    extern uint8_t SmallFont[];
    extern uint8_t MediumNumbers[];
    extern uint8_t BigNumbers[];
    // ----------ppr fin   ------------------------
    //
\end{Cpp}

\begin{Cpp}{Démarrage de l'écran}
    // 
----------ppr début ------------------------
// écran OLED démarrage
// --------------------------------------------
//
myOLED.begin();
myOLED.setFont(SmallFont);
// ----------ppr fin ------------------------
//
\end{Cpp}

\begin{Cpp}{Coeur de l'affichage}
    // ----------ppr début ------------------------
    // écran OLED affichage
    // --------------------------------------------
    //myOLED.drawLine(0,0,127,63); 
    // Draw a line from the upper left 
    // to the lower right corner
      myOLED.drawLine(0,20,127,20);  // ligne horizontale 
      myOLED.drawLine(65,0,65,40);   // ligne verticale
      myOLED.setFont(MediumNumbers);      
  
      myOLED.printNumI(HG, LEFT, 0);
      myOLED.printNumI(HD, RIGHT, 0);
      myOLED.printNumI(BG, LEFT, 20);
      myOLED.printNumI(BD, RIGHT, 20);
  
      myOLED.setFont(BigNumbers);
      myOLED.printNumI(consigneInclinaison, LEFT, 40);
      myOLED.printNumI(consigneRotation, RIGHT, 40);
      myOLED.update();
    // ----------ppr fin --------------------------
    //
  
\end{Cpp}



\chapter{Les écran à encre électronique}

Parmi les supports d'affichage disponibles, en plus des écrans, cristaux liquides 
(\glossary{LCD}), OLED, une révolution est apparue : le papier électronique \bold{e-paper} 
bien connu des utilisateurs de liseuses type Kindle ou Kobo (Fnac).

L'objectif de ces écrans est d'imiter l'apparence d'une feuille imprimée.\\

\img{\rootImages/example.png}{Un écran e-paper}{1}


L'affichage est obtenu par l'orientation de sphères colorées (noir et blanche ou noir, blanche, rouge) sous l'effet d'un champ électrique.\\ 
Une fois que l'affichage a été actualisé, l'écran n'a plus besoin d'énergie pour maintenir l'affichage de l'écran.

\img{\rootImages/ink2.png}{Principe d'affichage}{0.45}
\img{\rootImages/ink3.png}{La dalle d'affichage}{0.45}
\img{\rootImages/ink4.png}{Un zoom sur les billes}{0.45}


Quelques utilisations : \\
\begin{items}{green}{\Bullet}
    \item Des posters
    \item Des liseuses
    \item Les étiquettes des prix dans les grandes surfaces
\end{items}


La principale utilisation est l'étiquette électronique de gondole / EEG Electronic Shelf Labels 
qui est vendu actuellement comme un système intégré de gestion géré par un ordinateur central.\\
Cela permet d'automatiser les prix en temps réel (cela évite de faire des centaines d'étiquettes 
papier à mettre à jour) mais surtout de synchroniser les prix dans un magasin en ligne et 
hors ligne sur plusieurs sites.\\ 
Des bornes interactives permettent de trouver un produit dans un hypermarché.\\
Équipé de puces NFC ou par QR code, des informations sont disponibles sur le smartphone du client 
en rayon.\\
Actuellement un système de gestion d'inventaire et de stock est en cours de développement.


\chapter{Utilisation des sous-programmes Arduino}

On améliore la lisibilité du code en découpant le programme Arduino en plusieurs onglets. \\
La méthode la plus simple et d'abord, d'écrire un sous-programme/sous-routine, en langage 
Arduino une fonctions pour structurer le programme.\\ 
Ensuite, on place dans un onglet la fonction (sous-programme/sous-routine) : le nom de 
l'onglet sera sauvegardé en fichier .ino placé dans le même répertoire que le programme principal.\\

L'environnement de développement intégré \glossary{IDE} Arduino va modifier l'ensemble en 
un seul fichier type cpp qui sera envoyé dans le compilateur puis le linker 
(enfin vers la carte Arduino pour exécution).

Concrètement : 

\img{\rootImages/sub1.jpg}{Nom de la fonction}{0.4}
\img{\rootImages/sub2.png}{Les variables "partagées"}{0.3}
\img{\rootImages/sub3.png}{Fonction setup}{0.5}
\img{\rootImages/sub4.jpg}{Fonction d'affichage}{0.9}
\img{\rootImages/sub5.png}{Suite fonction d'affichage}{0.3}

\subsection{Code Arduino}

\begin{Cpp}{Code OLED avec routine}

    // ----------ppr début ------------------------
// écran OLED
// --------------------------------------------
//
#include <OLED_I2C.h>
OLED  myOLED(SDA, SCL, 8);
extern uint8_t SmallFont[];
extern uint8_t MediumNumbers[];
extern uint8_t BigNumbers[];
// ----------ppr fin   ------------------------
//

//*
//******************************
//*
void setup_oled() { 
  // ----------ppr début ------------------------
  // écran OLED démarrage
  // --------------------------------------------
  //
  myOLED.begin();
  myOLED.setFont(SmallFont);
  // ----------ppr fin   ------------------------
  //
 }  
  
 //*
 //*************************
 //*
  
 void oled_Affiche() {
  // ----------ppr début ------------------------
  // écran OLED affichage
  // --------------------------------------------
    myOLED.clrScr();   // efface la mémoire de l'écran (évite vieux affichage)

    // affiche les valeurs des consignes Inclinaison et rotation
    myOLED.setFont(MediumNumbers);   // 1ere ligne jaune
    myOLED.printNumI(consigneInclinaison, 20, 0);   // 20,40
    myOLED.printNumI(consigneRotation, RIGHT, 0);   // right,40

    // affiche les valeurs HG,HD,BG, BD 
    myOLED.setFont(BigNumbers);  // gros chiffres
    myOLED.printNumI(HG, LEFT, 16);
    myOLED.printNumI(HD, RIGHT, 16);
    myOLED.printNumI(BG, LEFT, 41);
    myOLED.printNumI(BD, RIGHT, 42);
    
    // mise en page 
    myOLED.drawLine(0,40,127,40);  // ligne horizontale 
    myOLED.drawLine(65,20,65,80);   // ligne verticale   
    
    myOLED.setFont(SmallFont);
    myOLED.print("INC", 0, 8);   // 
    myOLED.print("ROT",70, 8);   //  

    myOLED.print("HG",50, 30);    // 
    myOLED.print("HD",70, 30);    // 
    myOLED.print("BG",50, 50);    // 
    myOLED.print("HD",70, 50);    // 

    myOLED.update();
  // ----------ppr fin --------------------------
  //

}
\end{Cpp}\part{Un serveur Web}
%\addPartText{Serveur Web avec ESP12}
%\partImg{Mise en place d'un serveur ESP12}{\rootImages/serveurWeb.png}{0.4}
\chapter{Un serveur Web avec ESP12}

L'objectif de ce chapitre est de créer un serveur Web pour contrôler la led interne de l'ESP12, une carte basée sur les ESP8266 
(Broche D4)



\img{\rootImages/led_esp.jpg}{La led interne de l'ESP}{0.4}

\section{Présentation des modules ESP12}

\img{\rootImages/nodemcu.jpg}{Une carte ESP12 NodeMCU}{0.2}

Les cartes ESP12 sont des microcontrôleurs basés sur la puce ESP8266 
qui permet de se connecter en Wifi à des réseaux ou bien de créer son propre réseau.
Une des sous-famille est la NodeMCU.\\

Cette carte possède un certains nombre de broches dites \glossary{GPIO}, qui, comme les cartes Arduino, 
sont utilisées pour interagir avec des capteurs et des actionneurs.

Voici la disposition des broches sur les ESP12.

\img{\rootImages/pinout.png}{Les broches de l'ESP12}{2}

\messageBox{\faExclamationTriangle}{red}{red}{Les broches GPIO de l'ESP12 sont en 3.3V, contrairement aux cartes Arduino qui sont en 5V. Il existe néanmoins une broche (VIN) pour alimenter des périphériques en 5V}{white}

\section{Architecture du mini-projet}

Pour communiquer entre le client (utilisateur) et l'ESP12, nous utiliserons un routeur qui servira de passerelle.

\img{\rootImages/arch.png}{Architecture du projet}{0.4}

L'ESP12 se connecte dans un premier temps au routeur. 
Une fois connecté, tout client sur le même réseau peut se connecter à l'ESP12 en saisissant l'adresse de 
l'ESP12 dans le navigateur.

\section{Base des requêtes}

Dès que nous allons sur une page Web, nous faisons une requête, c'est à dire que l'on va demander l'affichage 
d'une page Web à un serveur distant.

\img{\rootImages/serveur.png}{Architecture client-serveur}{0.7}

Afin de récupérer une page sur le serveur, nous avons besoin de connaître 3 éléments :

\begin{items}{blue}{\Triangle}
    \item L'adresse \glossary{IP} ou l'adresse du serveur : Ici ce sera l'adresse IP de l'ESP12
    \item L'emplacement de la page sur le serveur : L'emplacement '/' désigne la racine du serveur
    \item Le port de communication entre le client et le serveur : \lbl{blue}{port}{80} par défaut pour 
    le protocole \glossary{HTTP} 
\end{items}


\subsection{Une petite explication sur les ports}

Pour recevoir et transmettre des données à d’autres ordinateurs, un ordinateur (ou serveur) a
besoin de ports. Cependant, les ports physiques tel que le port Eternet communiquent avec beaucoup de services.\\

Ainsi, des ports virtuels ont été créés. \\


Chaque port virtuel est codé sur 16 bits et permet de faire communiquer un service
ou un logiciel.\footnote{Par exemple, le service SSH communique sur le port 22}. Il y a donc potentiellement
65536 ports disponibles. Certains numéros de port sont réservés à certains services \\
Les ports de 0 à 1023 sont déjà réservés à des services particuliers et le port par défaut pour les serveurs Web est le 80.

\subsection{Les types de requêtes}

Lorsque nous nous connectons à un serveur Web, nous faisons principalement deux types de requêtes\footnote{Les webSockets ne 
seront pas abordées}
\begin{items}{blue}{\Triangle}
\item Requêtes GET

Les requêtes GET sont des requêtes avec des éléments passés via l'\glossary{URL} de la page.
Elles sont donc visibles via la barre d'adresse: 

\img{\rootImages/led.png}{L'adresse avec la requête GET}{0.7}

Chaque élément est séparé avec le symbole \lbl{blue}{LBL}{\&} et la liste des arguments commencent avec le symbole  \lbl{blue}{LBL}{?}
Comme nous avons un seul élément passé via l'URl, nous n'avons pas le symbole \lbl{blue}{LBL}{\&}

Ici, nous avons un argument \lbl{blue}{ARG}{LED} avec la valeur \lbl{green}{VAL}{OFF}

\item Requêtes POST

Ces requêtes ne passent pas les arguments via l'adresse URl. Cette section ne sera pas abordée dans le cadre de l'atelier.
\end{items}

\section{Connexion au routeur}

La carte ESP12 a besoin du nom du routeur ainsi que de son mot de passe. 
Dans le programme \lbl{green}{FILE}{serveur\_Web\_simple.ino}, il faut préciser le nom et le mot de passe sur les lignes suivantes : 

\begin{Cpp}{Identifiant et mot de passe}
//Par exemple
const char* ssid     = "Creafab_invite";
const char* password = "MonTraficEstJournalise";
//Il faut mettre le nom du routeur chez soi et le mot de passe associé
\end{Cpp}



\section{Lancement du programme}

Pour sélectionner la carte ESP12, veuillez vous reporter à l'annexe \bold{UTILISATION DE L’ESP12 SOUS ARDUINO}.

\messageBox{\faviconWarning}{orange}{orange}{Il faudra activer la liaison série de la carte. Pour cela, lors du choix de la carte dans le logiciel Arduino, dans la section Outils - Types de cartes -  ESP12 NodeMCU, il faut bien vérifier que la case Serial est activée }{black}

Une fois le programme téléversé, il vous faudra récupérer l'adresse IP de l'ESP12.


Pour cela, une fois que le code est téléversé, veuillez ouvrir la fenêtre du moniteur série, l’adresse IP de l'ESP va apparaître 
au bout de quelques secondes.\\

\img{\rootImages/port_serie.png}{Affichage de l'adresse IP}{0.45}

Si aucune données n’apparaît, faite un reset de la carte ESP12 en appuyant sur la touche \lbl{red}{RST}{RST} de la carte.\\

Il ne vous reste plus qu'à rentrer l’adresse IP obtenue dans un navigateur internet.\\
En l’occurrence, l'adresse IP dans ce cas là est \lbl{green}{IP}{192.168.0.102}

\img{\rootImages/ip.png}{Connexion au serveur}{0.6}

Le résultat doit être le suivant \\

\img{\rootImages/serveurWeb.png}{Résultat}{0.6}

\section{Explication du programme}

\bold{Une explication du langage HTML est disponible en annexe (section HTML)}

\subsection{En tête du code}

Après avoir importé les bibliothèques liées à l'ESP12, nous définissons un objet \bold{ESP8266WebServer} qui attend 
comme argument le port du serveur, c'est à dire le 80.
\begin{Cpp}{Importation des bibliothèques}
#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <ESP8266mDNS.h>
        
#define PORT 80 //Port par défaut
#define LED D4  //Broche de la LED
        
ESP8266WebServer server(PORT);
\end{Cpp}


On précise ensuite le mot de passe et le nom du routeur de communication.

\begin{Cpp}{Identifiant et mot de passe du routeur}
const char* ssid     = "Nom-reseau-Internet";
const char* password = "Mot-de-passe-Routeur";
\end{Cpp}


Ensuite, nous allons définir et créer notre page HTML.\\

Deux versions de pages Web seront proposées:

\begin{items}{blue}{\Triangle}
    \item Une version minimale sans aucune mise en forme ajoutée.

    \begin{Cpp}{Page minimale}
        const String minimalPageContent = "<html>\
        <head>\
            <title>Serveur Web CREPP</title>\
            <meta charset=\"utf-8\"/> \
            </head>\
            <body>\
            <h1>Led ESP8266</h1><br>\
                <h3>Contrôle de la LED sur la broche D4</h3><br>\
                  <a href=\"/?LED=ON\"><button >Allumer</button></a>\
                  <a href=\"/?LED=OFF\"><button >Eteindre</button></a>\
              </body>\
            </html>";
        \end{Cpp}

        \bold{Tout le principe de ce serveur repose dans l'action qu'effectue bouton lors d'un click.
        Ce dernier va demander à afficher la page et lors de la demande, il va passer à l'URL le mot-clé
        \bold{LED} et la valeur souhaitée (On ou OFF).}

        \item Une version plus élaborée en utilisant la bibliothèque \lbl{green}{LIB}{Bootstrap} qui permet de faire de 
        jolies mises en forme très facilement.

        \begin{Cpp}{Page plus élaborée}
            const String fullPageContent = "<html>\
            <head>\
              <title>Serveur Web CREPP</title>\
              <meta charset=\"utf-8\"/> \
              <link rel=\"stylesheet\" href=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\" integrity=\"sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\" crossorigin=\"anonymous\">\
            </head>\
            <body style=\"margin-left:5%;\">\
              <h1>Led ESP8266</h1><br>\
              <h3>Contrôle de la LED sur la broche <span class=\"badge badge-secondary\">D4</span></h3><br>\
                <a href=\"/?LED=ON\"><button class=\"btn btn-success\">Allumer</button></a>\
                <a href=\"/?LED=OFF\"><button class=\"btn btn-danger\">Eteindre</button></a>\
            </body>\
          </html>";
            \end{Cpp}   
\end{items}

\subsection{Fonction setup}
Lançons nous dans le code de la fonction \bold{setup}

On définit la led en sortie et on se connecte au routeur.

\begin{Cpp}{Initialisation}
void setup() {
      
    pinMode(LED, OUTPUT);       //LED en sortie
    digitalWrite(LED, LOW);     //LED éteinte
    Serial.begin(115200);       //Communication à 115200 bits/s
    WiFi.begin(ssid, password); //Connexion
    Serial.println("");         //Retour à la ligne
        
\end{Cpp}

Puis on vérifie que nous sommes bien connecté et on affiche les informations de connexion.

\begin{Cpp}{Vérification de la connexion}
    while (WiFi.status() != WL_CONNECTED) 
    {
        delay(500);
        Serial.println(">>> Impossible de se connecter au réseau...");
    }//Fin while
      
    Serial.print(">>> Connexion au réseau ");
    Serial.println(ssid);
    Serial.print("avec l'adresse IP : ");
    Serial.println(WiFi.localIP());            
\end{Cpp}

Enfin on vérifie que le MDSN\footnote{Multicast DNS, un serveur de résolution de nom de domaine} est activé (optionnel)
\begin{Cpp}{Vérification de la connexion}
    if (MDNS.begin("esp8266")) {   //Multicast DNS 
    Serial.println(">>> Serveur MDNS activé");
    }
}           
\end{Cpp}

On définit (toujours dans le setup) les pages accessibles par le client ainsi que la fonction appelée lors de la requête.
Il s'agit de l'emplacement \bold{'/'} et sa fonction associées est la fonction \bold{mainPage}\\

\begin{Cpp}{Redirection sur la page principale}
    server.on("/", mainPage);           //Affichage de la page principale si requête sur '/' -> saisir IP dans le navigateur
\end{Cpp}
On redirige également l'utilisateur sur une page dédiée si l'adresse demandée n'existe pas.

\begin{Cpp}{Redirection en cas d'erreur}
    server.onNotFound(notFoundPage);    //Affichage de la page d'erreur si adresse non valide
\end{Cpp}

Enfin, on initialise le serveur.

\begin{Cpp}{Initialisation du serveur}
    server.begin();                     //Initialisation du serveur
    Serial.println(">>> démarrage du serveur");
\end{Cpp}

\subsection{Fonction loop}

Le code à l'intérieur de la fonction \bold{loop} se contente de gérer de manière transparente le comportement du serveur.
\begin{Cpp}{Fonction principale}
void loop() 
{
    server.handleClient(); //Gestion des clients sur le serveur
}//Fin loop
\end{Cpp}


\subsection{Fonction mainPage}

Le code à l'intérieur de la fonction \bold{mainPage} permet de gérer la LED en fonction des 
valeurs passées via l'URL.


\begin{Cpp}{Fonction mainPage}

void mainPage() //Page principale
{ 

 if(server.arg("LED")=="ON") //Lecture de l'argument 'LED'
 {
  digitalWrite(LED, LOW); //On allume la led
 }//Fin if
 else if(server.arg("LED")=="OFF")
 {
 digitalWrite(LED, HIGH);   //On eteint la led
 }//Fin else if
 else {
  //nothing
 }

 server.send(200, "text/html", fullPageContent); //On envoie la page principale
  
}//FIn mainPage

\end{Cpp}

Tout appui sur un bouton va exécuter cette fonction.\\
La fonction \bold{server.send()} permet d'envoyer la page au client lorsque celui-ci la demande.
La valeur 200 correspond au code d'erreur de la page : 200 veut dire qu'il n'y a pas eu d'erreur \footnote{L'erreur 4040 indique une page inexistante.}.


\section{Code complet}
\begin{Cpp}{Code complet}

#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <ESP8266mDNS.h>
    
#define PORT 80 //Port par défaut
#define LED D4  //Broche de la LED
    
ESP8266WebServer server(PORT);
    
const char* ssid     = "Nom-reseau-Internet";
const char* password = "Mot-de-passe-Routeur";
    
//Page principale
const String minimalPageContent = "<html>\
<head>\
    <title>Serveur Web CREPP</title>\
    <meta charset=\"utf-8\"/> \
    </head>\
    <body>\
    <h1>Led ESP8266</h1><br>\
        <h3>Contrôle de la LED sur la broche D4</h3><br>\
          <a href=\"/?LED=ON\"><button >Allumer</button></a>\
          <a href=\"/?LED=OFF\"><button >Eteindre</button></a>\
      </body>\
    </html>";
    
    const String fullPageContent = "<html>\
      <head>\
        <title>Serveur Web CREPP</title>\
        <meta charset=\"utf-8\"/> \
        <link rel=\"stylesheet\" href=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\" integrity=\"sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\" crossorigin=\"anonymous\">\
      </head>\
      <body style=\"margin-left:5%;\">\
        <h1>Led ESP8266</h1><br>\
        <h3>Contrôle de la LED sur la broche <span class=\"badge badge-secondary\">D4</span></h3><br>\
          <a href=\"/?LED=ON\"><button class=\"btn btn-success\">Allumer</button></a>\
          <a href=\"/?LED=OFF\"><button class=\"btn btn-danger\">Eteindre</button></a>\
      </body>\
    </html>";
    
    
void setup() {
      
    pinMode(LED, OUTPUT);       //LED en sortie
    digitalWrite(LED, LOW);     //LED éteinte
    Serial.begin(115200);       //Communication à 115200 bits/s
    WiFi.begin(ssid, password); //Connexion
    Serial.println("");         //Retour à la ligne
    
      
    while (WiFi.status() != WL_CONNECTED) 
    {
        delay(500);
        Serial.println(">>> Impossible de se connecter au réseau...");
    }
      
    Serial.print(">>> Connexion au réseau ");
    Serial.println(ssid);
    Serial.print("avec l'adresse IP : ");
    Serial.println(WiFi.localIP());
    
    if (MDNS.begin("esp8266")) {   //Multicast DNS 
        Serial.println(">>> Serveur MDNS activé");
    }
    
    server.on("/", mainPage);           //Affichage de la page principale si requête sur '/' -> saisir IP dans le navigateur
    server.onNotFound(notFoundPage);    //Affichage de la page d'erreur si adresse non valide
    
    server.begin();                     //Initialisation du serveur
    Serial.println(">>> démarrage du serveur");
      
}//Fin setup
    
void loop() 
{
      
    server.handleClient(); //Gestion des clients sur le serveur
     
}//Fin loop
    
    
void mainPage() //Page principale
{ 
    
    if(server.arg("LED")=="ON") //Lecture de l'argument 'LED'
    {
         digitalWrite(LED, LOW); //On allume la led
    }//Fin if
    else if(server.arg("LED")=="OFF")
    {
        digitalWrite(LED, HIGH);   //On eteint la led
    }//Fin else if
    else {
     //nothing
    }
    server.send(200, "text/html", fullPageContent); //On envoie la page principale
      
}//FIn mainPage
    
    
void notFoundPage()  //Gestion si mauvaise URL
{
    server.send(404, "text/plain", "Page introuvable !\n\n");
      
}//Fin notFoundPage

\end{Cpp}

\section{Une amélioration possible}

il est possible d'afficher l'adresse IP du serveur sur un écran \glossary{OLED} afin d'éviter d'ouvrir le moniteur série Arduino.\\
Pour cela, nous allons effectuer le branchement suivant : 

\img{\rootImages/esp_oled.png}{Branchement de l'écran OLED à l'ESP12}{0.5}

\section{Code complet avec l'écran OLED}
\begin{Cpp}{Code complet avec l'écran OLED}

    #include <ESP8266WiFi.h>
    #include <ESP8266WebServer.h>
    #include <ESP8266mDNS.h>
    
    
    #include <SPI.h>
    #include <Wire.h>
    #include <Adafruit_GFX.h>
    #include <Adafruit_SSD1306.h>
    
    
    #define PORT 80 //Port par défaut
    #define LED D4  //Broche de la LED
    
    ESP8266WebServer server(PORT);
    
    const char* ssid     = "creafab_invite";//Nom du routeur sur le réseau 
    const char* password = "MonTraficEstJournalise"; //Mot de passe du routeur
    
    
    #define SCREEN_WIDTH 128 // OLED display width, in pixels
    #define SCREEN_HEIGHT 64 // OLED display height, in pixels
    
    #define OLED_RESET     -1 //Broche reset
    #define SCREEN_ADDRESS 0x3C ///Parfois 0x3D ou 0x3F
    Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);
    
    //Page principale
    const String minimalPageContent = "<html>\
      <head>\
        <title>Serveur Web CREPP</title>\
        <meta charset=\"utf-8\"/> \
        </head>\
      <body>\
        <h1>Led ESP8266</h1><br>\
        <h3>Contrôle de la LED sur la broche D4</h3><br>\
          <a href=\"/?LED=ON\"><button >Allumer</button></a>\
          <a href=\"/?LED=OFF\"><button >Eteindre</button></a>\
      </body>\
    </html>";
    
    void setup() {
      
      pinMode(LED, OUTPUT);       //LED en sortie
      Serial.begin(115200);       //Communication à 115200 bits/s
      WiFi.begin(ssid, password); //Connexion
      Serial.println("");         //Retour à la ligne
    
      delay(100);
      
      while (WiFi.status() != WL_CONNECTED) 
      {
        delay(500);
        Serial.println(">>> Impossible de se connecter au réseau...");
      }
      
    
      if (MDNS.begin("esp8266")) {   //Multicast DNS 
        Serial.println(">>> Serveur MDNS activé");
      }
    
      server.on("/", mainPage);           //Affichage de la page principale si requête sur '/' -> saisir IP dans le navigateur
      server.onNotFound(notFoundPage);    //Affichage de la page d'erreur si adresse non valide
    
      server.begin();                     //Initialisation du serveur
      Serial.println(">>> démarrage du serveur : OK");
    
      if(!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
        Serial.println(F("Echec OLED"));
        for(;;); 
      }
    
      display.display(); //Affiche le logo Adafruit
      delay(500); 
      display.clearDisplay(); //efface l'écran
    
      display.setTextSize(1);               //Facteur d'échelle
      display.setTextColor(SSD1306_WHITE);  //texte blanc
      display.setCursor(0, 0);              //Place le curseur en (0,0)
      
      display.println("Connexion au reseau ");
      display.println(ssid);
      display.println("avec l'adresse IP : ");
      display.println(WiFi.localIP());
      
      display.display();   //met à jour le contenu
      
    }//Fin setup
    
    void loop() 
    {
      
      server.handleClient(); //Gestion des clients sur le serveur
      
    }//Fin loop
    
    
    void mainPage() //Page principale
    { 
    
     if(server.arg("LED")=="ON") //Lecture de l'argument 'LED'
     {
          digitalWrite(LED, LOW); //On allume la led
          display.clearDisplay();
          display.setCursor(0, 0);  
          display.println("LED : 1");
          display.display();
          
     }//Fin if
     else if(server.arg("LED")=="OFF")
     {
        digitalWrite(LED, HIGH);   //On eteint la led
        display.clearDisplay();
        display.setCursor(0, 0);  
        display.println("LED : 0");
        display.display();
     }//Fin else if
     else {
      //nothing
     }
    
     server.send(200, "text/html", minimalPageContent); //On envoie la page principale
      
    }//FIn mainPage
    
    
    void notFoundPage()  //Gestion si mauvaise URL
    {
      server.send(404, "text/plain", "Page introuvable !\n\n");
      
    }
    

\end{Cpp}%\addPartText{Les capteurs et périphériques}
\part{Les capteurs et périphériques}

\chapter{Principes et théorie}
\section{Objectifs}

Ce chapitre a pour but de faire un petit tour d'horizon des différents capteurs et de leur mise en place.\\
Une mise en exemple sera faite avec le code de base pour réaliser un serveur Web.


\section{Les types de capteurs}

Il existe une multitude de capteurs: 


\begin{items}{blue}{\Triangle}

    \item Capteur de distance
    \item Capteur de température
    \item Capteur de présence
    \item Capteur de pression-humidité
    \item Capteur de position (potentiomètre, joystick, fin de course)
    \item Capteur de particules fines
    \item Capteur d'accélération
\end{items}


\section{Les modes de transmission}

Voici les différentes façon de communiquer. \\
Pour nos exemples, nous nous baserons sur deux périphériques qui communiquent entre eux.

\begin{items}{blue}{\Triangle}
    \index{Simplex}
    \item Simplex: la communication est unidirectionnel , c'est à dire que le périphérique A envoie des informations au périphérique B mais le B ne peut pas envoyer au A. \\
    \img{\rootImages/keyboard.png}{L'analogie du mode Simplex}{0.2}
    \index{Half-duplex}
    \item Half-duplex: la communication se fait dans les deux sens mais avec un décalage dans le temps. Si le périphérique A communique, le B ne peut pas envoyer des informations en meme temps que le A. \\
    \img{\rootImages/talkie.png}{L'analogie du mode Half-Duplex}{0.2}
    \index{Full-duplex}
    \item Full-duplex: les périphériques peuvent communiquer en même temps, comme dans une conversation téléphonique.
    \img{\rootImages/cell3.png}{L'analogie du mode Full-Duplex}{0.1}
\end{items}

\section{Les protocoles de communication}

Pour communiquer, de nombreux protocoles existent mais voici les principaux.

\subsection{Le bus I2C}

Le bus \glossary{I2C} est un bus informatique qui a émergé dans les années 80 pendant la «guerre des standards» lancée par les acteurs du monde électronique.\\
Conçu par Philips pour les applications de domotique et d’électronique domestique, il permet de relier facilement un microcontrôleur et différents circuits récepteurs tels que des capteurs de pression, température....\\

C'est un bus série synchrone bidirectionnel half-duplex avec 2 broches utilisées pour communiquer :
\begin{items}{green}{\Triangle}
    \item \glossary{SDA} : Serial Data (ligne de données) \index{SDA}
    \item \glossary{SCL} : Serial Clock (ligne d'horloge) \index{SCL}
\end{items}

Une masse est commune aux périphériques.\\

Les échanges ont toujours lieu entre un seul maître et un (ou tous les) esclave(s), toujours à l’initiative du maître \footnote{Jamais de maître à maître ou d’esclave à esclave, cependant, rien n’empêche un composant de passer du statut de maître à esclave et réciproquement} et pour éviter les conflits électriques les broches SDA et SCL sont de type \bold{Collecteur Ouvert}. Il faut donc ajouter des résistances de tirage mais ces dernières sont généralement intégrées.

\img{\rootImages/opencollector.png}{Les résistances de rappel du bus I2C}{0.4}

Il existe d’innombrables périphériques exploitant ce bus, il est même implémentable par logiciel dans n’importe quel microcontrôleur.\\

A chaque composant est attribué une adresse physique qui permettra les échanges.\\
 Cette adresse est codée sur 7 bits, ce qui fait que le bus I2C peut supporter en théorie 127 périphériques \footnote{en  réalité moins car il faut tenir compte de la capacité de ligne}.\\
Par exemple, on pourra trouver sur un même bus I2C : \\

\begin{items}{orange}{\Triangle}

    \item 1 écran \glossary{OLED}  (adresse 0x3C) \index{OLED}
    \item 1 écran \glossary{LCD}  (0x27) \index{LCD}
    \item 1 capteur de pression BME180 (0x35)
\end{items}

\img{\rootImages/bus_i2c.png}{Un réseau de capteurs}{0.5}


\img{\rootImages/I2C.png}{Une capture de trame I2C}{0.5}

\subsection{Les vitesses de communication}

Il existe différentes vitesses de communication sur le bus : 

\begin{items}{darkBlue}{\Triangle}
\item 100 kilobits par seconde pour le mode \bold{standard}
\item 400 kilobits par seconde pour le mode \bold{Fast}
\item 1 mégabits par seconde pour le mode \bold{Fast plus}
\item 3.4 mégabits par seconde pour le mode \bold{High Speed}
\end{items}

\subsection{Les changements d'adresses}

Lorsqu'on souhaite connecter plusieurs périphériques ayant la même adresse (par exemple 2 capteurs de température), il est possible pour certains périphériques de mettre certaines broches à un certain niveau logique pour définir l'adresse.

\subsection{Le bus SPI} 

Le bus \glossary{SPI} \index{SPI} est full-duplex et développé par Motorola dans le milieu des années 80.\\
La liaison est de type maitre-esclave où le maitre sélectionne l'esclave avec qui il veut communiquer avec une broche \genericPin{SS}.

Le bus comporte 4 broches :

\begin{items}{green}{\Triangle}
    \item SCLK : Serial Clock, Horloge (généré par le maître)
    \item MOSI : Master Output Slave Input (généré par le maître)
    \item MISO : Master Input Slave Output (généré par l'esclave)
    \item SS : Slave Select, Actif à l'état bas (généré par le maître)
\end{items}

\img{\rootImages/spi.png}{Un bus SPI}{0.2}

\subsubsection{Protocole}

\begin{items}{orange}{\Triangle}
    \item Le maître génère l'horloge et sélectionne l'esclave avec qui il veut communiquer par l'utilisation du signal SS
    \item L'esclave répond aux requêtes du maître
\end{items}



\subsection{La liaison UART} 

La liaison \glossary{UART} est une liaison série avec deux broches :

\begin{items}{green}{\Triangle}
    \item RX
    \item TX
\end{items}

Il permet uniquement de faire communiquer deux appareils entre eux.\\ 
Contrairement aux bus I2C ou SPI, on ne peut pas relier plusieurs périphériques.

\img{\rootImages/uart_periph.png}{Une communication UART}{0.5}

\subsubsection{Protocole}

\begin{items}{blue}{\Triangle}
    \item Un bit de start toujours à 0 pour synchroniser la communication
    \item Un champ de données de 7 à 8 bits
    \item Un bit de parité (paire ou impaire)
    \item Un bit de stop
\end{items}

\img{\rootImages/uart_prot.png}{Le protocole UART}{1.5}

Au repos, la ligne est au niveau logique HAUT.

\subsubsection{Vitesse de communication}

La liaison étant asynchrone, il faut que les périphériques communiquent à la même vitesse. Cette dernière est normalisée et représente le nombre de bit par seconde (baud\footnote{1 baud représente 1 symbole par seconde.})

\begin{items}{blue}{\Triangle}
\item 1 200 bauds
\item 2 400 bauds
\item 4 800 bauds
\item 9 600 bauds
\item 19 200 bauds
\item 38 400 bauds
\item 57 600 bauds
\item 115 200 bauds
\end{items}

\subsubsection{Une trame en exemple}

On constate bien que le niveau au repos est au niveau HAUT.

\img{\rootImages/uart.png}{Une capture de trame UART à 9600 bauds}{0.28}


\subsection{D'autres exemple}

\begin{items}{blue}{\Triangle}
    \item Le bus CAN\footnote{Controller Area Network} est un bus série half-duplex couramment 
    utilisé dans l'industrie et avionique. La transmission suit le principe de transmission en paire différentielle et possèdent donc deux lignes CAN L (CAN LOW) et CAN H (CAN HIGH). Tous les équipements, appelés noeuds, souhaitant communiquer via le bus sont connectés et peuvent échanger des informations.
    L'avantage du bus CAN est la robustesse des signaux dans un milieu dégradé (perturbations électromagnétiques)
    \item Protocole One-Wire qui utilise un seul câble pour communiquer.
    \item Protocole MODBus \footnote{Utilisé dans les automates industriels}
\end{items}



\section{Les capteurs de distance}

Différentes technologies sont utilisées pour mesurer une distance, cependant elles possèdent leurs avantages et inconvénients.


\begin{items}{blue}{\Triangle}
    \item Infrarouge
    \begin{items}{green}{\Triangle}
        \item Bon marché
        \item Assez précis
    \end{items}
    \begin{items}{red}{\Triangle}
        \item Non-linéaires
        \item Sensibilité à la lumière ambiante
        \item Dépend du coefficient de réflexion lumineuse de la surface en face du capteur
    \end{items}

    \item Laser
    \begin{items}{green}{\Triangle}
        \item Très précis
        \item Longue distance
    \end{items}
    \begin{items}{red}{\Triangle}
        \item Prix
    \end{items}

    \item Ultra-sonore
    \begin{items}{green}{\Triangle}
        \item Prix
        \item Ne dépend pas de la couleur de la surface en face du capteur
    \end{items}
    \begin{items}{red}{\Triangle}
        \item Précision parfois arbitraire
    \end{items}
\end{items}
    

\subsection{Les capteurs infrarouges}

Ce capteur envoie une tension qui dépend de la distance de l'objet.

\img{\rootImages/sharp.png}{Un capteur de distance infrarouge}{0.1}

Cependant, cette tension n'est pas proportionnelle à la distance\footnote{Extrait de la datasheet du capteur}

\img{\rootImages/dist.png}{La tension de sortie en fonction de la distance}{0.5}

\subsection{Les capteurs ultrasons}

\subsubsection{Principe}

Le principe de ce capteur repose sur le temps de propagation d'une onde sonore dans l'air.\\
En connaissant le temps d'une aller-retour et la vitesse de propagation, on peut déterminer la distance de l'objet.

\img{\rootImages/hcsr04.png}{Un capteur de distance HCSR-04}{0.5}


\subsubsection{Séquence de la mesure}

\begin{items}{green}{\Triangle}
    \item On envoie une impulsion de 10µs sur la broche \lbl{green}{PIN}{TRIGGER} du capteur.
    \item Le capteur envoie une dizaine d'impulsions ultrasonores à 40 kHz
    \item Les ondes se propagent et rebondissent sur l'obstacle
    \item Le capteur renvoie le temps de propagation avec la broche \lbl{green}{PIN}{ECHO} en mettant la sortie à 
    l'état haut durant le temps de l'aller-retour.
\end{items}

\img{\rootImages/hc.png}{L'algorithme de la mesure}{0.5}

Voici le relevé de la broche \lbl{green}{PIN}{TRIGGER} et \lbl{green}{PIN}{ECHO} 

\img{\rootImages/trigger.png}{Les broches TRIGGER et ECHO}{0.5}


\section{Les capteurs de température}

\subsection{Les capteurs numériques}

Les capteurs de température DHTXX\footnote{DHT11 ou DHT22} sont des capteurs de température et d'humidité fonctionnant entre 3.3 et 5V.

Les DHT11 possèdent une précision de température plus faible que les DHT22 (précision de 1°C).

\subsubsection{Protocole}

Le protocole de communication se fait sur un seul câble.\footnote{Protocole de type "One-Wire"}

\img{\rootImages/dht.png}{Une trame du capteur DHT22}{0.23}

\subsubsection{Branchements}

\img{\rootImages/dht22.jpg}{Le capteur DHT22}{0.35}

\subsection{Les capteurs analogiques}

Enfin, certains capteurs transmettent leurs données via une tension analogique. \\
Pour certains capteurs, il suffire le lire une tension pour obtenir indirectement la grandeur physique. Par exemple, le capteur LM35 sort une tension de 10 mV/°C.\\

\img{\rootImages/lm35.jpg}{Le capteur de température LM35}{0.2}

Si le capteur sort une tension de 210 mV, cela veut dire qu'il fait 21°C.


L'un des avantages de ces capteurs est que cela permet de s'affranchir de la partie numérique (microcontrôleur).
Le schéma suivant est un circuit qui active un relais quand la température descend en dessous d'un certain seuil.\\

\img{\rootImages/kicad.png}{Un schéma purement analogique}{0.3}

\section{Les capteurs PIR}

\img{\rootImages/pir.jpg}{Un capteur PIR}{0.3}

\subsection{Principe}

Les capteurs \glossary{PIR} détectent les rayonnements infrarouges émis par un objet.\\
Puisque tout objet émet un rayonnement infrarouge, le capteur PIR est muni de deux cellules sensibles aux infrarouges qui vont détecter ces rayons infrarouges réfléchit ou émit par l'objet. \\

Lorsqu’il n’y a pas de mouvement, le niveau d’infrarouge reçu est le même pour les deux cellules. Lors du passage d’un objet, l’émission de ces rayons va être modifiée sur une cellule puis sur l’autre ce qui va permettre de détecter le mouvement. \\

Le cache blanc, qui couvre et protège généralement le capteur, est une lentille de Fresnel avec plusieurs facettes qui permet de concentrer le rayonnement infrarouge sur les cellules.

\subsection{Utilisation}

Ces capteurs possèdent une broche de sortie qui est mise à l'état HAUT pendent une certaine durée
\footnote{Cette durée est réglable avec le potentiomètre sur le capteur} lorsqu'il y a détection d'un mouvement.\\


\begin{numeric}{Diagramme temporel du capteur}
    Présence & [green] LLLLLLHHHHHHHLLLLLLHHHLLLLLLLLLLLLHHHHHHLLLLL \\
    OUT & [blue] LLLLLLLHHHHHHHHLLLLLHHHHHHHHLLLLLLLHHHHHHHHLL \\
\end{numeric}


\subsection{Applications}

\begin{items}{blue}{\Triangle}
    \item Allumage d’une lumière à la détection d’un mouvement
    \item Activation d’une alarme lors de l’intrusion d’une personne
\end{items}


\section{Les relais électromagnétiques}

\subsection{Principe}

Les relais sont des interrupteurs commandés électriquement. 
Une bobine alimentée sous faible tension (5 à 24 V) génère un champ électromagnétique qui fait déplacer une membrane qui va ouvrir ou fermer le circuit.\\

\img{\rootImages/relai.jpg}{Un relais électro-mécanique}{3}
Le relais offre une isolation galvanique entre le circuit de commande et de puissance, c'est à dire qu'il n'y a aucune liaison conductrice entre ces deux circuits.\\

Un relais est caractérisé par :

\begin{items}{blue}{\Triangle}
  \item La tension de commande : 5 à 24V
  \item Le courant de coupure : Ex 30A
  \item La tension maximale dans le circuit de puissance : Ex 230V
  \item Sa position au repos\footnote{Position en absence de tension sur la commande} : Normalement Ouvert (NO) ou 
  Normalement Fermé (NF)
  \item Sa durée de vie : les relais sont garantis pour un nombre de commutation, par exemple 1 million.
\end{items}


\subsection{Symbole}

Le relais se symbolise de la façon suivante : 

\img{\rootImages/relais.png}{Le symbole du relais}{1}

On distingue clairement la partie de commande (rectangle) et le circuit qui s'ouvre ou se ferme pour laisser passer le courant.


\subsection{La diode de roue libre}

La bobine de commande du relais nécessite un certain courant \footnote{De l'ordre de la centaine de mA} qu'une broche de microcontrôleur ne peut pas fournir.
Pour cela on utilise un composant qui fera l'interface entre le microcontrôleur et le relais : le transistor.

\img{\rootImages/commande-de-relais.jpg}{Utilisation d'un relais}{1}

Cependant, lors de la fermeture du relais \footnote{Mise à 0 de la broche de commande de transistor}, le courant est brutalement coupé, or, les bobines s'opposent aux variations de courant.\\
Cela engendre une surtension qui va se répercuter sur le transistor.\\

Cette surtension vaut : 

$$ U = L\cdot \frac{dI}{dt}$$

Avec : 

\begin{items}{blue}{\Triangle}
    \item U la tension en Volt aux bornes de la bobine
    \item L la valeur en Henry de l'inductance\footnote{Bobine}
    \item I la variation de courant en Ampère dans la bobine
\end{items}

On met donc une diode en parallèle de la bobine pour que l’énergie accumulée dans la bobine passe dans la diode.\\
Cette diode est appelé \bold{diode de roue libre}.

En exemple, une simulation sans diode est faite avec \lib{LTSpice} : 

\img{\rootImages/ltspice.png}{Une simulation LTSpice}{0.8}

On active le transistor pendant 100 ms puis on le désactive et on observe la tension aux bornes du transistor.

\img{\rootImages/simulation.png}{Une surtension sur le transistor}{0.34}

On constate un pic à 24V, c'est à dire le double de l'alimentation 12V.

Maintenant, faisons la même simulation avec une diode de roue libre. \\Pour ces diodes, on privilégie des diodes Schottky à commutation rapide.


\img{\rootImages/simulation2.png}{Une surtension plus faible}{0.34}

La surtension ne vaut plus que quelques dizaines de mV.


\subsection{En pratique}

Pour utiliser des relais avec des microcontrôleurs, on utilise le plus souvent des relais qui intègrent une interface de contrôle.\\

\img{\rootImages/relai_5V.png}{Un relai avec une interface de contrôle}{0.2}

Il suffit généralement d'alimenter le relai en 5V constant et une broche active le relais si elle passe au niveau logique HAUT.\chapter{Mise en pratique}

Les codes suivants seront utilisés avec le serveur Web mis en place avec l'ESP12.\\
Cela permettra de réaliser une interface plus élaborée avec des capteurs et actionneurs.

\section{Utilisation du DHT11}


\subsection{Objectif}
L'intégration du code permettant de lire la température permettra d'obtenir l'interface suivante, à savoir un graphique pour 
visualiser la température et l'humidité en temps réel.

\img{\rootImages/graphe.png}{Le rendu de l'interface}{0.3}

\subsection{Branchements}

\img{\rootImages/dht_esp12.png}{Le branchement du module DHT}{0.5}

\subsection{Programme de test}

Avant de tester le code complet du DHT11/22 avec le serveur Web , on va essayer le module DHT sans le serveur. 
Pour cela, on va téléverser le programme suivant\footnote{Fichier \lbl{red}{FILE}{temperature\_humidite.ino}} :

\begin{Cpp}{Programme DHT11/22 minimaliste}
    #include "DHT.h"
    #define DHTPIN D2     //Broche du capteur
    
    #define DHTTYPE DHT11   // DHT 11
    //#define DHTTYPE DHT22   // DHT 22 
    //#define DHTTYPE DHT21   // DHT 21 
    
    DHT dht(DHTPIN, DHTTYPE);
    
    void setup() {
      
      Serial.begin(115200);
      dht.begin();          //Initialisation du capteur
    }
    
    void loop() {
    
      float h = dht.readHumidity();       //Récupère la température
      float t = dht.readTemperature();    //récupère l'humidité
    
      Serial.print("Humidite: ");
      Serial.print(h);
      Serial.print("\%  Temperature: ");
      Serial.print(t);
      Serial.println("C ");
      
      delay(2000);
    
    }
\end{Cpp}

Si vous obtenez le résultat suivant en lançant la console série, c'est que le capteur est fonctionnel.

\img{\rootImages/term_dht.png}{Le capteur DHT fonctionnel}{0.5}

Il ne vous reste plus qu'à lancer le programme \lbl{red}{FILE}{Serveur\_Web\_DHT11\_Graphe.ino}.

\subsection{Explications}

Pour gérer les températures et les valeurs d'humidité dans le temps, un tableau 'circulaire' est utilisé dans le programme. \\
Il consiste à remplir au fur et à mesure un tableau et quand celui-ci est plein, on décale les valeurs pour ajouter la dernière.

Prenons un exemple avec un tableau de 5 éléments auquel on cherche à ajouter le cycle suivant : 21,22,21,22,23,24,25,26 \\

\begin{numeric}{Les tableaux 'circulaires'}
    Etape Initial & 2D{0} 2D{0} 2D{0} 2D{0} 2D{0} \\
    Ajout de '21' & 2D{21} 2D{0} 2D{0} 2D{0} 2D{0} \\
    Ajout de '22' & 2D{21} 2D{22} 2D{0} 2D{0} 2D{0} \\
    Ajout de '21' & 2D{21} 2D{22} 2D{21} 2D{0} 2D{0} \\
    Ajout de '22' & 2D{21} 2D{22} 2D{21} 2D{22} 2D{0} \\
    Ajout de '23' & 2D{21} 2D{22} 2D{21} 2D{22} 2D{23} \\
    Ajout de '24' & 2D{22} 2D{21} 2D{22} 2D{23} 2D{24} \\
    Ajout de '25' & 2D{21} 2D{22} 2D{23} 2D{24} 2D{25} \\
    Ajout de '26' & 2D{22} 2D{23} 2D{24} 2D{25} 2D{26} \\
\end{numeric}%

Ce mouvement cyclique est géré par la fonction \lbl{blue}{FUNC}{updateRings} dans le fichier \lbl{purple}{LIB}{circularRings.h}

La fonction principale pour gérer le graphique est la fonction \lbl{blue}{FUNC}{getString} : 

\begin{Cpp}{Lecture de la température et de l'humidité}

    temperature = dht.readTemperature();
    humidity  = dht.readHumidity();

\end{Cpp}

Une fois ces deux données lues, on actualise les tableaux circulaires contenant les températures, les valeurs d'humidité et les références du graphique \footnote{Tableau contenant que des '0'}.

\begin{Cpp}{Actualisation des tableaux}

    updateRings(&current_index, NB_DATA_TEMP, temperature, humidity); //Mise à jour des tableaux

\end{Cpp}

On créer ensuite les chaines de caractères pour générer le graphique :

\begin{Cpp}{Génération du graphique}

    String dataTemperatures = concatenateArray(temperatures, current_index);
    String dataHumidities = concatenateArray(humidities, current_index);
    String dataReferences = concatenateArray(references, current_index); //Tableau contenant toutes les valeurs à 0, pour afficher la référence sur le graphique
    
    String dataTime ="[";
    for (int i=current_index;i>0;i--) {
      dataTime += "'"+String(i)+"',";
    }
    dataTime += "]";

\end{Cpp}

Une fois toutes les données, on génère la page dans son intégralité :


\begin{Cpp}{Génération de la page}

const String fullPageContent = "<html>\
<head>\
  <title>Serveur Web CREPP</title>\
  <meta charset=\"utf-8\"/> \
  <meta http-equiv=\"refresh\" content=\""+String(REFRESH_PAGE_DELAY)+"\">\
  <link rel=\"stylesheet\" href=\"https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css\" integrity=\"sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T\" crossorigin=\"anonymous\">\
  <script src=\"https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js\"></script>  \
  </head>\
<body style=\"margin-left:5\%;\">\
  <h1>Interface ESP12</h1><br>\
  <h3>Contrôle de la LED sur la broche <span class=\"badge badge-secondary\">D4</span></h3><br>\
    <a href=\"/?LED=ON\"><button class=\"btn btn-success\">Allumer</button></a>\
    <a href=\"/?LED=OFF\"><button class=\"btn btn-danger\">Eteindre</button></a><br><br>\
  <h3>Mesure de la température et humidité avec le module DHT11 sur la broche <span class=\"badge badge-secondary\">D2</span></h3><br>\
    <br>\
    >>> <b>Temperature</b> : "+String(temperature)+" C<br>\
    >>> <b>Humidite</b> : "+String(humidity)+"%\
    <div style='max-width:40\%;'><canvas id=\"myChart\" width=\"600\" height=\"450\"></canvas></div> \
      <script> \
var ctx = document.getElementById('myChart'); \
var temperatures = "+dataTemperatures+";\
var references = "+dataReferences+";\
var humidities = "+dataHumidities+";\
var time = "+dataTime+";\
var myChart = new Chart(ctx, {type: 'line', data: { labels: time, datasets: [{ label: 'Temperature', data: temperatures, borderColor: 'blue',backgroundColor: '', fill: 0}, { label: 'Référence', data: references, borderColor: 'black',backgroundColor: '', fill: 1}, { label: 'Humidité', data: humidities, borderColor: 'green',backgroundColor: '', fill: 0}]}})</script>\
</body>\
</html>";

\end{Cpp}


\section{Utilisation du HC-SR04}

\subsection{Branchements}

\img{\rootImages/hcsr04_esp.png}{Branchement du capteur}{0.6}

\subsection{Code complet}

\begin{Cpp}{Code complet pour le capteur HCSR-04}

#define TRIGGER_PIN D5  //Broche Trigger
#define ECHO_PIN D6     //Broche Echo

#define SOUND_VELOCITY 0.034 //Vitesse en cm/us

float distance = 0.0;

void setup() {

  Serial.begin(9600);         //Communication à 9600 bauds
  pinMode(TRIGGER_PIN, OUTPUT); //Broche Trigger en sortie
  pinMode(ECHO_PIN, INPUT);     //Broche Echo en entrée

  digitalWrite(TRIGGER_PIN, LOW);

}//End setup

void loop() {

  digitalWrite(TRIGGER_PIN, HIGH); //Envoie une impulsion de 10us
  delayMicroseconds(10);
  digitalWrite(TRIGGER_PIN, LOW);
  
  int duration = pulseIn(ECHO_PIN, HIGH); //Récupère le temps à l'état Haut de la broche ECHO

  distance = duration * SOUND_VELOCITY/2; //Distance en cm, v=d/t

  Serial.print("Distance (cm) = ");
  Serial.println(distance);
  
  delay(1000);
}

\end{Cpp}


\section{Utilisation d'un capteur PIR}

\subsection{Branchements}

\img{\rootImages/pir_esp.png}{Branchement du capteur PIR}{0.5}

\subsection{Code complet}

\begin{Cpp}{Code complet}

#define LED D2    //Broche de la LED
#define OUT D7     //Broche du capteur PIR
    
int status = LOW;     //Statut du mouvement : LOW : pas de mouvement détecté
bool outValue = 0;    //Valeur du capteur
long beginTime = 0;   //instant du déclenchement lors de la ldétection d'un mouvement
    
void setup() 
{
      
  pinMode(LED, OUTPUT); //LED en sortie
  pinMode(OUT, INPUT);  //Broche du capteur en entrée
  Serial.begin(9600);   //Vitesse de communication à 9600 bauds

}//End setup
    
void loop(){
    
  outValue = digitalRead(OUT);          //Lire létat du capteur
        
  if (outValue == HIGH)                 //Détection d'un mouvement
  {
    digitalWrite(LED, HIGH);            //Allume la LED
    
    if (status == LOW) 
    {
      Serial.println(">>> Mouvement ");
      status = HIGH;                    //Mise à jour du statut du capteur
      beginTime = millis();             //Sauvegarde du temps                   
    
    }//End if
    
    } 
    else                                //Aucun mouvement
    {
          
      digitalWrite(LED, LOW);           //Eteint la LED
            
      if(status == HIGH)                //Fin de détection
      { 
        Serial.print(">>> Fin du mouvement");
        status = LOW;                               //Mise à jour du statut du capteur
        unsigned long duree = millis() - beginTime; //Calcul de la durée du mouvement
        Serial.print(">>> Duree = ");
        Serial.print(duree);
        Serial.println(" ms");
    
      }//End if
    }//End else
}//End loop
\end{Cpp}

\section{Utilisation d'un écran OLED}


\subsection{Récupération de l'adresse I2C}

Pour tous les périphériques I2C, il convient de connaître l'adresse du périphérique. Or parfois on ne s'en rappel plus.
Il existe un code qui permet de scanner toutes les adresses possibles et d'afficher l'adresse du composant qui est relié au bus I2C.

Voici le code, disponible dans les exemples de la classe Wire \footnote{Classe qui gère le protocole I2C} : 

\begin{Cpp}{Un scanner I2C}

void loop()
{
  byte error, address;
  int nDevices;
     
  Serial.println("Scanning...");
     
  nDevices = 0;
  for(address = 1; address < 127; address++ )
  {
    Wire.beginTransmission(address);
    error = Wire.endTransmission();
     
    if (error == 0)
    {
      Serial.print("I2C device found at address 0x");
      if (address<16) {
        Serial.print("0");
      }
      Serial.print(address,HEX);
      Serial.println("  !");
      nDevices++;
    }
    else if (error==4)
    {
      Serial.print("Unknow error at address 0x");
      if (address<16) {
        Serial.print("0");
      } 
      Serial.println(address,HEX);
    }    
  }
  if (nDevices == 0) {
    Serial.println("No I2C devices found\n");
  }
  else {
    Serial.println("done\n");
  }
  delay(5000);         
    
}
\end{Cpp}


\subsection{Code complet}

\begin{Cpp}{Code complet}

  #include "SSD1306Ascii.h"
  #include "SSD1306AsciiAvrI2c.h"
   
  #define I2C_ADDRESS 0x3C
   
  SSD1306AsciiAvrI2c oled;
   
  void setup() {
  
    //Init size
    oled.begin(&Adafruit128x64, I2C_ADDRESS);
    oled.setFont(Adafruit5x7);  
    oled.clear();
    oled.set2X();
  
    
    oled.println("CREPP");
    oled.set1X();
    oled.println("Club de");
    oled.println("Robotique et");
    oled.println("d'Electronique");
    oled.println("Programmable");
   
  }
  void loop() {
   
  }
\end{Cpp}

\subsection{Branchements}

\img{\rootImages/esp_oled.png}{Branchements de l'éran OLED}{0.5}

\img{\rootImages/oled_result.jpg}{L'écran OLED fonctionnel}{0.4}
 \chapter{Les broches d'interruptions}

 \index{Interruptions (broches)}
 Dans certains cas, il est souhaitable de récupérer la valeur d'une broche à tout moment du programme, même quand celui ci est occupé dans une tâche et même dans une fonction de temporisation \footnote{Voir delay(), delayMicroseconds()}. \\
 
 Pour remédier à ce problème, on peut utiliser les \colors{blue}{broches d'interruption} qui permettent de récupérer la main sur l'ensemble du programme lorsque'un évènement survient sur une broche.\\
 
 Concrètement, lorsque un évènement  \bold{e} survient sur la broche \bold{b}, la fonction \bold{f} est appelée, quelque soit l'état du programme principal. \\
 
 Prenons le cas d'un bouton qui doit changer l'état d'une LED à n'importe quel moment du programme.
 
 
\begin{Cpp}
 
     int ledPin = 13;    //Led interne
     int BOUTON = 2;  //Bouton relié à la broche 2 avec une résistance de charge
     
     volatile int state = LOW;  //Etat courant de la LED
     
     void setup() {
       
       Serial.begin(9600);//Vitesse de communication à 9600 bit/s
       
       pinMode(ledPin, OUTPUT);                //Led mise en sortie
       pinMode(BOUTON, INPUT_PULLUP);    //Bouton mis en entrée
       
       attachInterrupt(digitalPinToInterrupt(BOUTON), onEvent, CHANGE);  //Appel de la fonction onEvent à chaque changement de front du bouton
       Serial.println("Init");
     }
     
     void loop() {
       
      delay(5000); //Pause du programme principal
       
     }
     
     void onEvent() {
       
       state = !state; //Inverse l'état de la LED
       
       if(state){
         Serial.println("ON");
       }else{
         Serial.println("OFF");
       }
        digitalWrite(ledPin, state); //Met à jour l'état de la LED
     }
     
\end{Cpp}
 
 
 Ici, quelque soit l'action effectuée dans la fonction loop, dès qu'un front montant est détecté sur la broche BOUTON (2), la fonction onEvent() sera exécutée et changera l'état de la LED à chaque front.
 
 
 
 \subsection{Mode d'interruption}
 
 Il existe différents modes pour les broches :
 
 \begin{items}{blue}{\Bullet}
     \item RISING: front montant
     \item FALLING: Front descendant
     \item CHANGE: Front montant et descendant
 \end{items}
 
 \subsection{Chronogrammes d'interruption}
 
 
 \begin{numeric}{Exemple avec mode RISING}
     BOUTON & LLLLLLLHLLLLLLLLLL \\
     loop &  7D{EXECUTION} 6D{PAUSE} 7D{REPRISE} \\
     onEvent & 7D{INACTIVE} 6D{\bold{EXECUTION}} 7D{INACTIVE} \\
 \end{numeric}
 
 
 \begin{numeric}{Exemple avec mode FALLING}
     BOUTON & LLLLLLLHLLLLLLLLLL \\
     loop &  8D{EXECUTION} 6D{PAUSE} 6D{REPRISE} \\
     onEvent & 8D{INACTIVE} 6D{\bold{APPEL}} 6D{INACTIVE} \\
     \end{numeric}
 
 
 
 \begin{numeric}{Exemple avec mode CHANGE}
     BOUTON & LLLLLLLHHHHHHHHHHHHHHLLLLLLLLLLLLLL \\
     loop &  7D{EXECUTION} 8D{PAUSE} 6D{REPRISE} 8D{PAUSE} 6D{REPRISE}  \\
     onEvent & 7D{INACTIVE} 8D{\bold{EXECUTION}} 6D{INACTIVE} 8D{\bold{EXECUTION}} 6D{INACTIVE}\\
     \end{numeric}
 

     Par exemple, on souhaite réagir prioritairement à un capteur PIR quel que soit l'état du programme.


     \subsection{Exemple avec les capteur PIR}
     
     Les capteurs \glossary{PIR} (Passive-Infra-Red) détectent les rayonnements infrarouges émis par un objet.\\
     Puisque tout objet émet un rayonnement infrarouge, le capteur PIR est muni de deux cellules sensibles aux infrarouges qui vont détecter ces rayons infrarouges réfléchit ou émit par l'objet. \\
     
     Lorsqu’il n’y a pas de mouvement, le niveau d’infrarouge reçu est le même pour les deux cellules. 
     Lors du passage d’un objet, l’émission de ces rayons va être modifiée sur une cellule puis sur l’autre ce qui va permettre de détecter le mouvement. \\
     
     Le cache blanc, qui couvre et protège généralement le capteur, est une lentille de Fresnel avec plusieurs facettes qui permet de concentrer le rayonnement infrarouge sur les cellules.
     
     \subsection{Utilisation}
     
     Ces capteurs possèdent une broche de sortie qui est mise à l'état HAUT pendent une certaine durée
     \footnote{Cette durée est réglable avec le potentiomètre sur le capteur} lorsqu'il y a détection d'un mouvement.\\
     
     
     \begin{numeric}{Diagramme temporel du capteur}
         Présence & [green] LLLLLLHHHHHHHLLLLLLHHHLLLLLLLLLLLLHHHHHHLLLLL \\
         OUT & [blue] LLLLLLLHHHHHHHHLLLLLHHHHHHHHLLLLLLLHHHHHHHHLL \\
     \end{numeric}
     
     
\subsection{Code sans interruption}

Voici un code d'exemple pour réagir dès qu'une présence est détectée.

\begin{Cpp}{Code sans interruption}

#define LED 13    //Broche de la LED
#define OUT 2     //Broche du capteur PIR
    
void setup() 
{
      
  pinMode(LED, OUTPUT); //LED en sortie
  pinMode(OUT, INPUT);  //Broche du capteur en entrée
  Serial.begin(9600);   //Vitesse de communication à 9600 bauds

}//End setup
    
void loop(){
    
  outValue = digitalRead(OUT);          //Lire létat du capteur
        
    if (outValue == HIGH)                 //Détection d'un mouvement
    {
        Serial.println("Detection");
    }//End else
}//End loop
\end{Cpp}


Maintenant, supposons que la carte exécute un programme qui prend plusieurs secondes. Comment faire ?\\

On peut utiliser une interruption externe

\begin{Cpp}{Code avec interruption}
 

    #define LED 13    //Broche de la LED
    #define OUT 2     //Broche du capteur PIR
       
    void setup() {
      
      Serial.begin(9600);//Vitesse de communication à 9600 bit/s
      
      pinMode(LED, OUTPUT); //LED en sortie
      pinMode(OUT, INPUT);  //Broche du capteur en entrée
      
      attachInterrupt(digitalPinToInterrupt(OUT), presence, RISING);  //Appel de la fonction presence à chaque changement de front du bouton
      Serial.println("Init");
    }
    
    void loop() {
      
     delay(5000); //Pause du programme principal
      
    }
    
    void presence() {
      
      Serial.println("Presence !");
    }
    
\end{Cpp}



%\addPartText{Les modules de communication sans fil}
\part{Les modules de communication}



\chapter{Principes et théorie}
\section{Objectifs}

Ce chapitre a pour but de faire un petit tour d'horizon des différents modules de communication et les technologies associées.


\section{Les différents modules}

Il existe une multitude de modules: 


\begin{items}{blue}{\Circle}

    \item Modules Infrarouge
    \item Modules Radio basses fréquence (433MHz) 
    \item Modules Radio hautes fréquences (Wifi, Bluetooth) à 2.4 GHz

\end{items}

Les deux derniers modules se déclinent en une multitude de modules : 

\begin{items}{blue}{\Circle}

    \item Modules Lora
    \item Modules Xbee
    \item Modules HC-04 ou HC-05\footnote{Les modules HC-05 sont configurables en mode maître ou esclave et les modules HC-06 en 
    mode esclave uniquement.}
    \item Modules Crius
\end{items}


\section{Les modules Bluetooth}


\img{\rootImages/hc06.jpg}{Un module Bluetooth}{0.5}

La plupart des modules Bluetooth communiquent en liaison série (broche RX et TX) et se configurent avec les commandes AT.

\subsection{Configuration}

Il s'agit d'un jeu d'instruction pour gérer les paramètres des modules comme l'identifiant, le nom, la vitesse de communication, etc.\\

Ces commandes étaient utilisée à l'origine pour les modem Hayes Smartmodem 300 et sont donc également appelées \bold{commandes Hayes}.\\

Chaque commande est envoyée sous la forme d'une ligne de texte encodée en ASCII, débutant par le mot \bold{AT} et se terminant par le caractère \r seul (code ASCII 13).\\ 
Le module retourne une réponse sous la forme d'une ou plusieurs lignes selon la commande envoyée, chaque ligne se terminant par les caractères \r suivi de \n (codes ASCII 13 et 10).


\subsection{Branchements}

\img{\rootImages/arduino_hc_06.png}{Branchements du module Bluetooth}{0.3}

Pour l'exemple, nous nous baserons sur un module HC-06 ou HC-05.\\

il faut relier le « +5V » du module au  5 Volts de la carte Arduino et la masse du module à celle de la carte.\\
Ensuite, nous allons relier la broche TX du module à la broche 12 de la carte et la broche RX à la broche 10. \\


\subsection{Code Arduino}

\messageBox{Point-clé}{orange}{white}{Afin de lire les données du module, nous allons "émuler" une voie série, en l’occurrence les broches 3 et 2. C'est-à-dire que nous allons déclarer que ces broches recevront et enverront des données.}{white}


Pour cela, il faut utiliser la bibliothèque \bold{SoftwareSerial}.
Dans le logiciel Arduino, allez dans \bold{croquis} puis \bold{inclure une bibliothèque}  et sélectionnez \bold{SotfwareSerial}.

\img{\rootImages/software.png}{Inclusion de la bibliothèque SoftwareSerial}{0.7}

Maintenant, nous allons définir les broches du module : :

\begin{Cpp}{Définitions des broches RX et TX}
const int RX = 3; //RX du module
const int TX = 2;
\end{Cpp}

Après ceci, il faut déclarer un objet \bold{SoftwareSerial}  qui prendra en argument respectivement les broches TX et Rx, un peu comme lors de la déclaration d'un écran LCD (« LiquidCrystal lcd (RS,E,D4,D5,D6,D7); »).

On obtient donc :

\begin{Cpp}{Définition de l'objet SoftwareSerial}
#include <SoftwareSerial.h>

const int RX = 3; //RX du module
const int TX = 2;

SoftwareSerial device(RX,TX);
\end{Cpp}

Bien entendu, "device" peut être remplacé par ce que vous voulez. \\
Ensuite, on déclare que la communication carte-module peut débuter  avec "device.begin(9600) ;"
Où 115200 correspond à la vitesse de transmission en bauds (comme "Serial.begin(9600);") ;

\begin{Cpp}{Vitesse de communication}
SoftwareSerial device(RX,TX);
void setup() {
    device.begin(9600);
}
\end{Cpp}

\messageBox{Remarque importante}{red}{white}{Par la suite, en cas d'erreurs de transmission Bluetooth (pas de données...), il conviendra de vérifier le branchement des broches RX et TX (essayer de les intervertir) et d'éventuellement changer la vitesse de communication  car certains modules communiquent à 115200 bauds !}{white}

Pour lire les données du module, ce sont les mêmes fonctions que pour le port série : \\
En effet : \\

Pour le port série :	\\	

\begin{items}{blue}{\Triangle}
    \item Serial,begin(115200);
    \item Serial.available();
    \item Serial.read();	
    \item Serial.print();
    \item Serial.println();
\end{items}

Pour le module Bluetooth : \\

\begin{items}{blue}{\Triangle}
    \item crius.begin(115200);
    \item device.available();
    \item device.read();	
    \item device.print();
    \item device.println();
\end{items}


Tant que des données (caractères) sont disponibles, nous allons les assembler en une chaîne de caractère (concaténation). \\
Ensuite, avec un \bold{if}, nous allons voir si cette chaîne en question correspond par exemple à "a". \\ 

Il faut donc définir un caractère x et une chaîne de caractère.\\
Donc dans le programme Arduino, avant la fonction \bold{setup}, on rajoute :

\begin{Cpp}{Définition des structures du message}
#include <SoftwareSerial.h>

const int RX = 3; //RX du module
const int TX = 2;

char c;
String message;

\end{Cpp}

La boucle while va permettre de lire les données : 
Dans la boucle \bold{loop} : on écrit :

\begin{Cpp}{Boucle de lecture partielle}
 void loop() {
 
    while() {
    
    }//Fin while

 }//Fin void loop

\end{Cpp}

Maintenant que la boucle va attendre des données, il suffit de les lire et de les transformer en chaîne de caractère. \\
Pour cela : \\

\begin{items}{blue}{\Triangle}
    \item on lit le premier caractère c
    \item on définit que la chaîne message = message + c 
\end{items}
On obtient :

\begin{Cpp}{Boucle de lecture complète}
 void loop() {
 
    while(device.available()>0) {
    
        c = device.read();
        message = message + c;
    }//Fin while

 }//Fin void loop

\end{Cpp}

La structure conditionnelle est très simple : \\
Après la boucle « while », mettez : \\

\begin{Cpp}{Structure conditionnelle}
 void loop() {
 
    while(device.available()>0) {
    
        c = device.read();
        message = message + c;
    }//Fin while
    
    if(message=="c") {
    
        Serial.println("C);
    }//Fin if message=="c"

 }//Fin void loop

\end{Cpp}

\section{Les modules radio }

\img{\rootImages/radio.jpg}{Un module receveur et émetteur}{0.5}

\subsection{Choix de l'antenne}

La plupart du temps, on utilise une antenne \bold{quart d'onde} ou \bold{demi-onde}.\\
La fréquence vaut :

$$ \lambda = \frac{c}{\nu}$$
 avec $\lambda$ la longueur d'onde en mètre, $c$ la vitesse de l'onde en $m\cdot s^-1 $ et  $\nu $ la fréquence de l'onde en Hz

 D'ou : 

 $$ \lambda = \frac{3\cdot 10^{8}}{433\cdot 10^{6}} = 0.69 ~m $$

 Or on prend une antenne valant le quart du résultat, c'est à dire 17 cm.

 \subsection{Branchements}

 \subsubsection{Module émetteur}
 \begin{items}{blue}{\Bullet}
    \item \inputPin{VCC} sur le \outputPin{+5V} de l'Arduino
    \item \inputPin{GND} sur le \outputPin{GND} de l'Arduino
    \item \inputPin{Data} sur la broche \outputPin{D12} de l'Arduino
 \end{items}

 \subsubsection{Module receveur}

 \begin{items}{blue}{\Bullet}
    \item \inputPin{VCC} sur le \outputPin{+5V} de l'Arduino
    \item \inputPin{GND} sur le \outputPin{GND} de l'Arduino
    \item \inputPin{Data} sur la broche \outputPin{D11} de l'Arduino
 \end{items}


 \section{Les modules Xbee }

 \img{\rootImages/xbee.png}{Un module Xbee}{0.5}

 Ce module communique via une liaison série.\\ L'un des inconvénient de ce module est l'espacement des broches de 2mm et non de 2.54 mm.
 Il faut donc utiliser un shield adapté.

 La fréquence de communication est cette fois ci de 2.4GHz.


 \chapter{Introduction au projet MySensors}


\section{Présentation}

Ce chapitre a pour but d'introduire la mise en place d'une passerelle et d'une sonde MySensors dans un projet de domotique

\subsection{Organigramme}

\begin{figure}[h]
  \centering
\begin{tikzpicture}[node distance={30mm}, thick, main/.style = {draw, circle}]
  \node[main] (1) [color=green] {$Sonde$}; 
  \node[main] (2) [above right of=1, color=cyan] {$Passerelle$}; 
  \node[main] (3) [left of=1] {$DHT$}; 
  \node[main] (4) [below of=3] {$Capteur_2$}; 
  \node[main] (5) [below of=1] {$Capteur_3$}; 
  \node[main] (6) [right of=2, color=blue] {$Domoticz$};
  
  \draw[->] (3) -- (1);
  \draw[->] (4) -- (1);
  \draw[->] (5) -- (1);

  \draw[->] (1) -- (2);
  \draw[->] (2) -- (6);
\end{tikzpicture} 
\caption{Les différents composants du projet}
\end{figure}

  \subsection{Principe}

  Les capteurs vont être analysés par la sonde MySensors.\\
  Cette dernière enverra à distance les informations vers la passerelle qui se chargera d'envoyer les informations au serveur Domoticz via une liaison USB.\\


  Une sonde représente un endroit physique, un lieu de mesure. \\
  Si vous souhaitez par la suite faire d'autres relevés dans un endroit différent, il suffira d'ajouter une sonde et de garder la passerelle.\\
  Chaque sonde est caractérisée par un identifiant de noeud (NODE\_ID) et chaque capteur possède un identifiant enfant sur la sonde qui lui est rattachée (CHILD\_ID)
  \begin{figure}[h]
    \centering
  \begin{tikzpicture}[node distance={30mm}, thick, main/.style = {draw, circle}]
    \node[main] (1) {$Passerelle$}; 
    \node[main] (2) [below left of=1] {$Sonde_1$}; 
    \node[main] (3) [left of=1] {$Sonde_2$}; 
    \node[main] (4) [above left of=1] {$Sonde_3$}; 

    \node[main] (5) [right of=1] {$Domoticz$};
    
    \draw[->] (2) -- (1);
    \draw[->] (3) -- (1);
    \draw[->] (4) -- (1);
  
    \draw[->] (1) -- (5);
    \end{tikzpicture} 
    \caption{Une extension possible}
  \end{figure}



  \section{Présentation de la passerelle}

  \img{\rootImages/pin.png}{Circuit imprimé vu de dessus, coté composants}{0.5}\label{TEST}

  \img{\rootImages/side.png}{Vue de coté}{0.4}
  \img{\rootImages/passerelle_emetteur.png}{Vue de la passerelle et de l'émetteur}{0.4}
  \img{\rootImages/dessus.png}{Vue de dessus}{0.4}


  \section{Présentation de la sonde}

  \img{\rootImages/pcb.png}{Circuit imprimé vu de dessus, coté composants}{0.5}\label{TEST}


  \img{\rootImages/s4.jpg}{Sonde vue de dessus sans la nappe}{0.25}
  \img{\rootImages/s3.jpg}{Sonde vue de dessus avec la nappe}{0.25}
  
  
  
\chapter{Configuration de Domoticz}

Une fois que la passerelle est fonctionnelle, nous allons configurer Domoticz pour que la plateforme reçoive les données en provenance de la passerelle.

\section{Ajout de la passerelle}

Tout d'abord, allez dans la section \bold{Configuration > Matériel}

\img{\rootImages/hardware.png}{Emplacement du matériel}{0.5}

Ensuite, saisissez les informations suivantes :

\img{\rootImages/add_gateway.png}{Paramétrage de la passerelle}{0.5}

Le port série sélectionné sera celui où est raccordé la passerelle en liaison USB.
Il ne faut pas prendre les noms simplifiés des ports USB (\italic{COM\_XXX}) mais le nom le plus complet.\\
Pour plus de simplicité, veuillez déconnectez tous les autres périphériques du Raspberry-Pi\\.


S'il s'agit d'un autre capteur (température...) il suffit de parcourir la liste pour le trouver?


\section{Recherche des capteurs}

Visualisons les données en provenance de la sonde en allant dans \\
\bold{Configuration > Matériel}\\.

L'ensemble de vos dispositif apparaît. En cas de liste trop longue, saisissez \bold{Gateway} dans la barre de recherche.


\img{\rootImages/search.png}{Recherche de la passerelle}{0.5}


\messageBox{Remarque}{orange}{white}{Si le dispositif n'apparaît pas immédiatement, patientez quelques instants.}{black}

\img{\rootImages/gateway.png}{La passerelle est détectée}{0.4}



Pour visualisez les valeurs des capteurs, il faut sélectionner la passerelle avec l'ID de la sonde (ici, 30).

\img{\rootImages/nodes.png}{Sélection de la passerelle}{0.5}

En cliquant dessus, on voit que la partie \bold{Enfants} est mise à jour et contient les 3 capteurs avec les ID définis dans le programme de la sonde (31,32 et 33 en ce qui me concerne)

\img{\rootImages/enfants.png}{Visualisation des enfants}{0.4}


\section{Visualisation des données}

Maintenant que nous savons que la sonde envoi les bonnes données, nous allons ajouter les capteurs dans les dispositifs.
Pour cela, allez dans \bold{Configuration > Dispositifs}, les 3 capteurs de la sonde (Tension batterie, humidité et température) apparaissent dans la liste.\\
Si vous ne les trouvez pas, vous pouvez nettoyer la page des capteurs en sélectionnant les capteurs non-utilisés et en le mettant à la poubelle.

\img{\rootImages/disp.png}{Visualisation des capteurs}{0.25}

Les capteurs apparaissent sous les 3 noms suivants : 

\img{\rootImages/names.png}{Nom des capteurs}{0.6}

Pour ajouter un dispositif, il suffit de cliquer sur la flèche verte et de choisir le nom du dispositif.

\img{\rootImages/fleche.png}{Ajout des dispositifs}{0.5}

\img{\rootImages/voltage.png}{Ajout des dispositifs - Sélection du nom}{0.5}

Il suffit de cliquer dans le menu \bold{Mesures}

\img{\rootImages/mesure.png}{Mesures}{0.4}

Et apparaît la tension de la batterie.

\img{\rootImages/volt.png}{tension de la batterie}{0.5}

On procède de même pour l'humidité et la température, les dispositifs seront mis dans l'onglet  \bold{Température}.

\img{\rootImages/temp.png}{Mesures de l'humidité et de la température}{0.4}


Pour visualiser les données, il suffit de cliquer sur le bouton \bold{logs}


\section{Conclusion}

Nous avons vu une utilisation de Domoticz via les sondes MySensors mais énormément de dispositifs domotiques existent sur Domoticz.\newcommand{\wel}{Wellington~}



\chapter{Introduction}

La bataille de Waterloo est l'une des batailles de l'Empire les plus étudiée car elle marque l'écroulement 
définitif du régime de Napoléon. \\
Ce document a pour but de synthétiser les principales erreurs de Napoléon effectuées durant la campagne 
de Belgique.


\epigraph{Cette bataille sera l'affaire d'un déjeuner}{\textit{Napoléon}}

\chapter{Contexte}



Nous sommes en juin 1815.\\
Dès le retour de Napoléon le 1er avril 1815, les Alliés, c'est à dire l'Angleterre, la Prusse, 
l'Autriche et la Russie ont de nouveau réunis le Congrès de Vienne afin de mettre définitivement 
Napoléon à genoux. Ils mettent donc en place plusieurs armées qui convergent vers la France. 
Le premier rang est formé par les Anglais et les prussiens, viennent ensuite les russes et les autrichiens.
La première vague est formée par 210 000 anglais et prussiens.
Les autrichiens et les russes sont environ 300 000 hommes.\\

Dans un premier temps, avec l'analyse des forces en présence et les différentes chaînes de commandement, nous verrons qu'un ensemble d'erreurs incombe directement à Napoléon, le reste du moins implique ses subordonnées.\\

\subsection{L'Armée du Nord}

Sous le ministre de la Guerre Davout, l'Armée du Nord est constitué principalement de français, 
les régiments étrangers ayant retrouvés leur territoire national (notamment les polonais et les italiens). \\
Cette armée, forte de 133.000 hommes est une armée formée de vétérans, certains ayant été rapatriés des 
pontons espagnols et gardant par ce fait une rancune tenace contre les anglais. 
Ils sont motivés à en découdre.\\


L'Armée du Nord est composée des Corps d'armée suivant :  \\


- Le 1er Corps du comte Drouet-D'Erlon.\\

N'ayant pas participé à la bataille de Ligny le 16 juin, il s'agit du corps d'armée le plus à même 
d'effectuer une offensive sur le centre anglais, étant le plus frais et le plus nombreux en terme de troupe. il est constitué de 20 000 hommes et du 4ème corps de cavalerie de Milhaud.\\
La cavalerie de la Garde lui est directement rattachée sous le commandement de  Lefebvre-Desnouettes.\\


- Le 2ème Corps d'Armée est celui de Reille (17 000 h)\\

- Le VIème Corps est celui de Lobau (10 0000).\\

- La Garde forme la réserve et la cavalerie lourde sera sous le commandement de Kellerman.\\

Suite au Cents-Jours, de nombreux maréchaux se sont ralliés à Louis XVIII et Napoléon ne peut faire le 
difficile au sein du haut commandement \footnote{Certains maréchaux ont été mis en retraite comme Jourdan, Kellerman ou bien disgracié comme Masséna}. Il confie donc l'aile gauche de l'armée au Maréchal Ney, rallié 
récemment à Napoléon après de nombreuses hésitations.\\
L'aile droite de l'armée est sous la responsabilité du nouveau Maréchal Grouchy. 
Ce choix semble étonnant dans la mesure où ce dernier n'a jamais commandé des effectifs aussi importants. 
Étant responsable pendant des années de la cavalerie française, il a donc commandé des divisions de 
cavalerie mais jamais de Corps d'armée. \\


Napoléon possédait cependant d'excellents divisionnaires comme Gérard, Saint-Hilaire ou Guyot qui 
connaissent les rouages du commandement. \\
Le choix le plus dérangeant est sans doute la présence de Davout en tant que ministre de la Guerre. 
Bien que très compétant et ayant réussi à mettre sur pied une armée en quelques mois après les coupes 
des effectifs pendant les Cents-Jours, sa présence sur le terrain eut été un avantage décisif.\\
Il reste le seul Maréchal invaincu de Napoléon et ses talents de manœuvriers ne sont plus à démontrer. \\
De plus, la présence de Suchet, seul maréchal ayant gagné son bâton de maréchal en Espagne (fait rare) 
a été laissé dans les Alpes avec un corps \\d'Observation pour éviter la menace venant d'Italie.\\
Enfin, et non une des moindres, la perte de Berthier en juin 1815 au poste de chef d'État-Major de l'Armée 
se fera cruellement ressentir dans la chaîne de commandement. Cette responsabilité incombe désormais à 
Soult qui est plus manœuvrier que bureaucrate.\\
Berthier occupait ce poste depuis les débuts de la Grande Armée et savait parfaitement traduire les 
ordres de l'Empereur en lettre précises et concises pour les subordonnées.\\

Napoléon compte appliquer sa technique habituelle, c'est à dire appliquer la manœuvre en position centrale :

- Percer le centre anglais\\

- Battre séparément les deux ailes ennemies\\

N'ayant jamais affronté Wellington dans une bataille rangée, Napoléon essayait de faire taire les 
remarques de Soult sur les qualité défensives de ce dernier. \\
Il avait pourtant raison, Wellington est un général préférant rester sur ses positions pour attendre le 
moment opportun d'une contre-attaque, comme en Espagne.\\
De plus, au vue de la situation géographique des deux armées alliées, le plan de Wellington visait à 
temporiser pour attendre les prussiens. Comme l'a résumé Wellington, "je livrerai bataille si je peux espérer le soutien ne serait que d'un seul corps prussien".
Il en aura 3 à la place, le 4ème (celui de Bulow, chef d'état major de Blucher) étant retenu par le corps de Grouchy.\\



Un élément dérange Napoléon. La présence de la ferme fortifiée de la Haye-Sainte. 
Située en plein centre du champ de bataille, cette ferme empêche de déployer les bataillons 
français dans une vaste offensive. La prise de cette ferme constituera donc l'objectif central pour 
Napoléon, le reste devant découler naturellement une fois le centré enfoncée. \\

Toute la journée, Wellington tenta de préserver son centre en faisant parvenir de nombreux renforts. 
Il y aura donc une bataille dans la bataille au vu des effectifs engagés des deux cotés, 8000 h pour 
les français contre 4000 coté anglais.\\

Nous reviendrons sur cette offensive, qui étonnamment, a été mené par l'un des frères de Napoléon, 
Jérôme. \footnote{N'ayant pas particulièrement brillé lors de la campagne de Russie en se détachant 
du commandement de Davout, il sera mis de côté jusqu'à ce moment là.}

Toute l'offensive prussiennes reposera donc sur le corps de Lobau à partir de 18 h.


\subsection{L'Armée Alliée}


Les troupes anglaises sont formées de contingents anglais (470000 h), irlandais et comptent parmi eux la 
Légion Hanovrienne \footnote{King's German Legion}.\\
Ces derniers auront pour mission de tenir la Haye-Sainte, la position clé du centre britannique.\\

L'ensemble des forces britanniques sont sous le Duc de Wellington, ayant gagné son titre en Espagne en 
1808 après la bataille de Vittoria.\\
L'objectif de \wel est de tenir le plus longtemps possible sur ses postions afin d'attendre le corps 
de Blucher. \\
Cette stratégie payera dans la mesure où sentant son centre menacé, \wel fera intervenir ses réserves 
afin de combler le centre menacé.\\


Les troupes prussiennes quand à elles sont dirigées par le maréchal Blucher, alors âge de 71 ans.
Cet habitué des guerre napoléoniennes \footnote{Prise de Lubeck en 1806 alors tenue sous ses ordres}, 
c'est un militaire qui a également participé à la guerre de 7 ans (1756-1763). Il a donc pu assister à 
la réorganisation de l'armée prussienne suite à la débâcle de Iéna et Austerdaest en 1806.
Cette évolution s'est faite sous l'impulsion de son chef d'état major Von Bulow et du célèbre 
théoricien Karl Von Clausewitz.\\

Les prussiens se méfiaient des anglais, ces derniers n'ayant pas encore fait de combats directs avec 
Napoléon. Ils souhaitaient donc se rapprocher de leur ligne de communication (Wavre) afin de panser 
leurs plaies suite à la bataille de Ligny effectuée le 16 juin.\\


\subsection{Disposition des troupes}

\section{Entrée en campagne}

Le 14 juin 1815, Napoléon décide de passer à l'attaque, en se disant que la meilleure stratégie était de battre d'abord les anglo-prussiens puis de se retourner vers les russes et les prussiens.

Il fonde donc sa stratégie sur une campagne éclair.


Il confie donc au Maréchal Ney l'attaque de la position aux Quatres-bras. Il aura sous son commandement le corps de Drouet d'Erlon, Lobau et Reille. 

la timidité du maréchal conduira Wellington à rester sur ses positions. De plus, le corps de Drouet-d'Erlon jonglera en d'incessant allers-retours entre le corps de Ney et l'armée principales sous les ordres de Napoléon.\\ Il ne participera donc à aucun des deux affrontements de la journée.

\section{Bataille de Ligny}

Le 16 juin 1815, Napoléon décide de passer à l'attaque, en se disant que la meilleure stratégie était de battre d'abord les anglo-prussiens puis de se retourner vers les russes et les prussiens.

Il fonde donc sa stratégie sur une campagne éclair.


Du coté de Napoléon, l'armée prussienne accepte le combat et durant toute la journée, ses troupes sont envoyées successivement au feu, ce qui amoindrie leur puissance offensive.

Ayant donc subi les assauts des français, ils se voient dans l'obligation de se retirer.

Une des clés de la victoire des alliées résidera à ce moment là au choix de la direction de repli des anglais.

les prussiens veulent se retirer sur Namur mais les anglais leur conseille plutôt vers Wavre pour lier leur communication. Si les prussiens s'étaient repliés vers leur ligne de repli classique, les prussiens ne seraient pas intervenus sur le champ de bataille le 18, cela aurait permis aux français de mener leur offensive principale plus sereinement.













\section{Ouverture des hostilités}

Ayant plu toute la nuit du 17 juin, le sol est détrempé. or à cette époque, la présence de boue dans le sol empêche les boulets pleins de rebondir et de faire des ricochets sur le sol. l'efficacité des salves en est grandement réduite car les boulets ne ricochent pas.

Les rares boulets explosifs n'ont que peu d'impact.

De plus, le rôle de la cavalerie sous l'Empire, du moins la cavalerie lourde est la rupture sur une section du front. Or la boue amoindrie cette efficacité.


Sous l'avis du général Drouet, responsable de l'Artillerie, les canons de la Garde ouvrent le feu à 11 h 30. \\

Il s'agit incontestablement d'une erreur car à cette époque, le batailles commençaient au lever du jour afin de profiter du maximum d'heure avec de la lumière. \footnote{Les combats de nuits étaient rares.}. nous pouvons citer la bataille de la Moskova, Wagram, Austerlitz, toutes ces batailles ont commencée au lever du jour.






\section{Le Subterfuge de Bulow}
\section{Trahison}

A 18 h 30, Napoléon joue sa dernière carte. La Veille Garde entre en action sur le centre anglais.\\
Les bonnets d'ours se dirigent vers le centre mais arrivés à 200 m, ils subissent un feu roulant des anglais qui se sont levés des champs de blé. La première ligne ets fauché, la seconde prend le relais et tire une salve.


Lors de la 5ème salve, les grognards hésitent puis commencent à reculer. A ce moment là, le cri de Trahison circule et se propage au sein de l'Armée. L"effort demandé par l'armée est trop fort, les régiments commencent à refluer en désordre.


\section{Le dernier carré}

A ce moment là, \wel agite son chapeau, c'est le signal convenu de l'assaut général.

Seuls au mileu des fuyards, la Vielle Garde forme 3 carrés, Napoléon se réfugie parmi un des carré.

La légende aura forgé le Dernier Carré où Cambronne répond aux anglais "Merde !" quand ces derniers lui demandent de se rendre.\\
\section{La fuite de l'Aigle}%\addPartText{Mise en place du Bluetooth dans le projet Cocci-Bot}
\partImg{Projet Cocci-Bot}{\rootImages/module.jpg}{0.5}

\chapter{Introduction}     

\section{Présentation}

Ce tutoriel a pour objectif de créer une application pour diriger le robot en Bluetooth. \index{Bluetooth}
L'application enverra des « commandes » au module Bluetooth de type Crius 
Cette application se fera à l'aide du logiciel en ligne «App Inventor 2», qui se divise en deux parties : 

\begin{items}{blue}{\Triangle}
    \item une partie dédiée exclusivement à l'interface graphique
	  (positionnement des boutons, etc).
	\item une seconde partie dédiée à la gestion des données et à leurs envois/\\réceptions
\end{items}

\noindent
Nous verrons donc comment faire une interface spécifique pour le Cocci-Bot. \\

\messageBox{Remarque importante}{red}{white}{Il est impératif que le téléphone portable tactile soit sous le système d'exploitation Android et qu'il dispose de la fonctionnalité Bluetooth}{white}



Par exemple, si j'appuie sur un bouton «avancer», je veux que l'application envoie en Bluetooth la donnée qui permettra à l'Arduino de comprendre l'instruction  à l'aide  du module Bluetooth.


\section{Liste du matériel}

Pour cette première partie, nous aurons besoin de : 

\begin{items}{blue}{\Triangle}
    \item Un téléphone portable, comme dit précédemment, étant tactile et fonctionnant sous \colors{red}{Android}. Les dimensions importent peu, pourvu que celui-ci dispose du mode Bluetooth
    \item Un module Bluetooth de type Crius (Alimentation en 5V)
    \item Une carte Arduino 
    \item Des fils de connexion pour brancher le module à la carte
    \item Une connexion internet
\end{items}

Et c'est tout… pour le moment.


\section{Cahier des Charges}

Maintenant que nous avons la liste du matériel nécessaire, ce serait bien de mettre en place un cahier des charges afin de savoir ce que le robot sera capable de faire… \\

1) L'application devra se connecter au module Bluetooth du robot.
Pour cela, on se connectera  à un module en passant par la liste des modules Bluetooth disponibles.\\
Cette méthode permet de se connecter sans avoir l'adresse MAC. En revanche, l'étape de l'appairage est indispensable. (Chapitre \ref{appairage}) \\

2) Le robot devra être contrôlé de façon manuelle,  il y aura donc 5 boutons de commande :

\begin{items}{blue}{\Triangle}
    \item 1 bouton «Avancer»
    \item 1 bouton «Reculer»
    \item 1 bouton «Droite»
    \item 1 bouton «Gauche»
    \item 1 bouton «Stop»
\end{items}


3) Le robot devra également se diriger de façon autonome grâce à ses capteurs (distance, lumière). Il y aura donc un bouton «automatique» pour déclencher ce mode. \\

\messageBox{Application facultative}{blue}{white}{ Le robot pourra également indiquer l'état de la batterie (en \%, sur l'écran LCD) par simple appui d'un bouton. \\ Cette section ne sera pas abordée içi.}{white}\chapter{Appairage du module} \label{appairage}
\index{Appairage}
\messageBox{Point-clé}{orange}{white}{Avant de créer l'application, il faut tout d'abord que le portable puisse reconnaître le module Bluetooth. Pour cela, il faut «l'appairer», c'est à dire que l'on va définir que le module sera apte à recevoir les données envoyées par le portable. \\Cette étape est très rapide et ne sera effectuée qu’à chaque changement de module Bluetooth.}{white}


1) Tout d'abord, branchez le module : la broche +5V du module est reliée à la broche 5V de la carte Arduino et la broche GND du module est reliée à la GND de la carte. \\


2) Démarrez le Bluetooth sur votre téléphone portable puis allez dans \bold{paramètres > Bluetooth} \\
Faites « \bold{rechercher} » afin de trouver un périphérique. 
Vous devriez trouver un périphérique « BT Crius ». Cliquez dessus et faites « \bold{associer} ». \\
A ce moment là, on vous demandera un mot de passe, qui par défaut, est \bold{0000} (ou \bold{1234}). \\

Lorsqu'il est entré, faites « \bold{valider} » et au bout de quelques secondes, le clignotement du module devrait se stopper pour qu'il n'y ait qu'une lumière continue 



Et voila, le module est appairé.\chapter{Création de l'interface}
\section{Préparation}
\index{App Inventor}
Maintenant que nous nous sommes assurés que la communication s'effectuera, il est temps de faire l'application et de préparer notre outil (enfin, me direz-vous!) \\

\noindent
Tout d'abord, saisissez dans un moteur de recherche l'adresse suivante : 
\url{http://appinventor.mit.edu/} (Site \bold{App Inventor 2}» ) \\

Une page comme ceci devrait apparaître :

\img{\rootImages/portail.png}{Le portail App Inventor}{0.3}

Ensuite, cliquez en haut à gauche sur :  \shortcut{Create App}
Cela devrait vous diriger vers ceci : \\

\img{\rootImages/account.png}{La fenêtre de connexion}{0.3}

Puis connectez vous avec votre compte Google (ou Gmail). Si vous n'en avez pas, sa création est rapide… (create account). \\
Vous tombez ensuite sur une interface similaire : 

\img{\rootImages/begin.png}{La fenêtre des applications}{0.3}

\noindent
Pour démarrer votre projet, cliquez sur « \bold{Start new project} » (onglet « \bold{Projects} »)et là, cette page apparaît : 
\img{\rootImages/screen1.png}{La fenêtre de notre application}{0.3}
\noindent 
Avant toute chose, réglez la langue du site en français. Pour cela, sélectionnez l'onglet \bold{English} et choisissez « \bold{français} ».\\

\img{\rootImages/langue.png}{Le choix de la langue}{0.7}

\section{Sauvegarde du projet}

Avant toute chose, voici une étape non négligeable : la sauvegarde du projet

\messageBox{Remarque importante}{red}{white}{L'application App Inventor étant en ligne, un problème de réseau peut ruiner votre projet en cas de mauvaise sauvegarde. Il convient de sauvegarder régulièrement votre travail}{white}


Il faut se reporter au menu du haut et aller dans \bold{Projets} puis \bold{Enregistrer le projet}

\img{\rootImages/save.png}{Sauvegarde du projet}{0.7}


Quant à l'interface, un petit tour d'horizon s'impose.

\section{Présentation des éléments graphiques}
\img{\rootImages/layout.png}{Les outils de App Inventor}{0.45}

Par convention, dans ce tutoriel :

\begin{items}{blue}{\Triangle}
    \item la partie \colors{orange}{orange} sera la partie menu
    \item la partie \colors{blue}{bleue}  sera l'interface
    \item la partie \colors{gray}{grise}  sera la partie composants
    \item la partie \colors{green}{verte}  sera la partie propriétés
    \item la partie \colors{red}{rouge}  garde son nom : blocks
    \item la partie \colors{magenta}{magenta} est la partie "graphique" (regroupement des quatre premières parties
\end{items}

Maintenant, prenons un \colors{orange}{sélectionneur de liste} dans le menu, et faisons le \colors{blue}{glisser sur l'interface}. 
Pour cela, maintenez enfoncé le« \bold{sélectionneur de liste} » dans le menu et faites le glisser sur l'écran virtuel. Relâchez ensuite la souris. On obtient :


\img{\rootImages/render1.png}{Rendu de l'\colors{blue}{interface}}{0.5}
\img{\rootImages/render_2.png}{Rendu des \colors{gray}{composants}}{0.7}
Veuillez cliquer sur \bold{Sélecteur\_de\_list1}
\img{\rootImages/render_3.png}{Rendu des \colors{green}{propriétés}}{0.5}


\subsection{Principaux elements} \label{menu}

Maintenant, on peut voir que le menu offre plusieurs choix d'objets. Voici les plus importants :

Il vous est notamment possible de \\faire les actions suivantes :

\begin{items}{blue}{\Triangle}
    \item Créer un bouton
    \item Créer une case à cocher
    \item Sélectionner une date
    \item Afficher une image
    \item Afficher du texte
    \item Créer une liste de selection
    \item Créer une liste classique
    \item Envoyer une notification
    \item Afficher un curseur
    \item Créer une zone de saisie de texte \\(mot de passe...)
    \item Sélectionner l'heure
\end{items}


\img{\rootImages/menu.png}{La liste des composants}{0.6}

\section{Présentation des propriétés}

Nous allons présenter les propriétés principales des composants mis à notre disposition. \\
\noindent
Tout d'abord, gardez le \colors{orange}{sélectionneur de liste} sur l'\colors{blue}{écran}.
Ensuite, pour centrer la liste, allez dans le menu \colors{gray}{composants}, sélectionnez  \bold{screen 1}.
\img{\rootImages/select_screen.png}{Sélection de l'écran}{0.6}

Dans l'onglet \colors{green}{propriété} → alignement horizontal, sélectionner la liste sur \bold{centrer}. 
\img{\rootImages/center_screen.png}{Centrage de l'écran}{0.6}


Vous pouvez également changer la forme du bouton. \\
Allez dans \colors{gray}{Composants} → sélectionneur de liste et dans \colors{green}{Propriétés}, trouvez l'onglet \bold{forme} 
et sélectionnez celle voulue.    

\img{\rootImages/shape.png}{Forme du bouton}{0.6}


Voici quelques paramètres de mise en forme : 

\begin{items}{blue}{\Triangle}
    \item Vous pouvez modifier la couleur de la liste en sélectionnant \bold{Couleur de fond}
    \item Pour modifier la taille de la liste, il suffit de rentrer la taille en pixels ou en \% de l'écran (\bold{Hauteur, Largeur}) \\	Il vaut mieux préciser en \% afin que l'application soit compatible au niveau du format sur tous les appareils.
\end{items}


\img{\rootImages/properties.png}{La liste des propriétés}{0.6}

Enfin, pour décider du titre de la liste sur l'application, sélectionner la liste \bold{Selectionneur\_de\_liste1} et dans ses \colors{green}{propriétés}, modifier l'onglet \bold{texte} et écrivez, par exemple « \bold{Connexion} »

\img{\rootImages/rename.png}{Choisir le nom par défaut du bouton \bold{Connexion}}{0.6}

\section{Renommer les élements}

Dans un souci de clarté, il convient de \\ renommer les éléments que nous \\ plaçons sur l'écran. \\

Pour renommer le sélectionneur de liste,\\ il faut allez dans les \colors{gray}{composants} de \\l'interface,  et sélectionnez  « Renommer » \\
Je l'ai renommé en « connexion ».


\img{\rootImages/rename_screen.png}{Renommer un élement}{0.6}



\messageBox{Astuce}{green}{white}{Pour changer la couleur d'arrière-plan de l'application, allez dans composants → screen1 et dans propriétés, sélectionnez couleur de fond}{white}

\section{Ajouter un client Bluetooth} \label{bluetooth_install}

Par la suite, nous allons utiliser le client Bluetooth d'App Inventor. \\
Pour le trouver, il suffit d'explorer le \colors{orange}{menu latéral}. Un ensemble d'éléments est disponible à la suite des principaux éléments énumérés dans la section \ref{menu}.

\img{\rootImages/add.png}{Menu latéral}{0.6}

Le client Bluetooth se situe dans la section \bold{Connectivité}

\img{\rootImages/connectivite.png}{Ajouter un client Bluetooth}{0.6}
Pour l'ajouter à noter application, il suffit de glisser le client Bluetooth sur l'\colors{blue}{interface}.
A ce moment là, sous l'écran virtuel, le client Bluetooth apparaît.

\img{\rootImages/non-visible.png}{Présence du client Bluetooth}{0.6}

Et voila, le client Bluetooth est mis en place.

\section{Premier rendu et agencement des élements}

En faisant toutes ces étapes, on obtient : 

\img{\rootImages/first_render.png}{Premier rendu de l'application}{0.4}

En ajoutant un bouton (glisser-déposer un bouton disponible dans le menu latéral) et en modifiant ses propriétés (forme, couleur...), on obtient ceci : 

\img{\rootImages/second_render.png}{Rendu avec un bouton "Avancer"}{0.4}

\subsection{Générer un espace entre deux élements}

On souhaite maintenant espacer le bouton "Connexion" et le bouton "Avancer" \\

Rien de plus simple ! Il suffit de placer un élément \bold{label}
(outil dans menu) entre les deux boutons puis de
choisir ses dimensions, ce qui correspondra à l'espacement des boutons. \\
\img{\rootImages/label.png}{Emplacement du label}{0.8}

Pour que le label ne soit pas visible, il suffira de mettre son texte vide.

\img{\rootImages/label_content.png}{Texte du label}{0.8}

Et voilà le résultat : 

\img{\rootImages/label_space.png}{Espace entre deux élements}{0.2}


\section{Alignement des éléments}

Maintenant, ce serait bien de pouvoir aligner des boutons (ou autre)
horizontalement afin d'obtenir quelque  chose comme ceci :

\img{\rootImages/align_button.png}{Alignement d'éléments}{0.4}

Ne vous inquiétez pas, le cadre noir n’apparaîtra pas sur l'application ; c'est juste un moyen de distinguer les alignements. \\

Pour faire ceci, allez dans le \colors{orange}{menu} et sélectionnez l'onglet \bold{Disposition}

\img{\rootImages/disposition.png}{Emplacement des éléments d'agencement}{0.4}

Une fenêtre comme ceci apparaît :

\img{\rootImages/disposition_layout.png}{Éléments d'agencement}{0.5}

Ensuite, faites glisser l'outil \bold{Arrangement Horizontal}
sous la liste « \bold{Connexion} » et vous devriez avoir ceci :

\img{\rootImages/add_layout.png}{Éléments d'agencement placé}{0.5}

Vous pouvez dorénavant faire glisser des boutons dans ce carré et ils se mettront automatiquement côte à côte. Il suffit de régler la taille des boutons sélectionnés dans \colors{green}{propriétés}.


\messageBox{Astuce}{green}{white}{Il est possible de changer les dimensions de l'outil "Arrangement Horizontal"}{white}
\img{\rootImages/ha_layout.png}{Propriétés de l'objet \bold{Arrangement Horizontal}}{0.5}


En revanche, il y a un fond blanc pour l'objet \bold{Arrangement Horizontal }:

\img{\rootImages/next_layout.png}{Couleur d'arrière-plan de l'outil \bold{Arrangement Horizontal}}{0.7}

En allant dans les \colors{green}{propriétés} de l'objet \bold{Arrangement Horizontal}, mettez la couleur d'arrière-plan en « \bold{aucun} »

\img{\rootImages/background_color.png}{Couleur d'arrière-plan transparent}{0.7}

\section{Mise en place de l'ensemble des boutons}

Après avoir mis les boutons "\bold{Droite}", "\bold{Stop}", "\bold{Gauche}", "\bold{Reculer}", "\bold{Batterie}" et "\bold{Auto}" et mis un peu de couleur, vous pouvez obtenir une interface de ce type :

\img{\rootImages/render.png}{Rendu de l'application}{0.7}

\messageBox{Remarque importante}{red}{white}{Par la suite, veuillez mettre l'arrière-plan de « connexion » en rouge (non représenté ici) }{white}\chapter{Gestion de l'application}

Nous avons réalisé et mis en place tous nos élément graphiques. Il ne nous reste donc plus qu'a les faire interagir afin d'envoyer les données Bluetooth. \\
\noindent
Pour cela, commencez par aller dans la section \bold{Bloc}, disponible en haut à droite de la page

\img{\rootImages/bloc.png}{Emplacement du menu "\bold{Bloc}"}{0.8}

\newpage
\section{Présentation}
A l'ouverture du menu \bold{Bloc}, voici le rendu
\img{\rootImages/bloc_main.png}{Menu "\bold{Bloc}"}{0.3}

Sur le menu de gauche, nous retrouvons une liste de blocs 

\img{\rootImages/blocs.png}{Menu latéral}{0.5} \label{place_menu_left}

mais également nos élements graphiques agencés précédemment : 

\img{\rootImages/own_blocs.png}{Nos élements ajoutés}{0.5}

En cliquant sur chaque onglet (Contrôle, Logique, Math…), une liste de blocs apparaît :
(ici, en cliquant sur Contrôle)

\img{\rootImages/zoom_control.png}{Blocs \bold{Controls}}{0.4}

Tous ces blocs sont faits pour pouvoir être glissés dans la partie blanche centrale…


\section{Configuration de la liste des périphériques Bluetooth}

\subsection{Principe}

Nous allons configurer notre liste \bold{Connexion} afin qu'elle nous indique les modules Bluetooth disponibles.

Cette étape se fera en deux temps : 

\begin{items}{blue}{\Triangle}
    \item Configuration de la liste \bold{avant} le choix de l'utilisateur
    \item Mise à jour de la liste \bold{après} le choix de l'utilisateur
\end{items}


Commencer par sélectionner la liste \bold{Connexion} dans le menu latéral

\img{\rootImages/connexion.png}{Sélection de la liste}{0.9}

Le menu suivant apparaît : \\

\img{\rootImages/zoom_connexion.png}{Éléments de l'objet \bold{Connexion}}{0.6}

\begin{items}{blue}{\Triangle}
    \item Le "\bold{Quand connexion.Avant prise}" représente le bloc qui contiendra les instructions de la liste, c'est à dire que dans ce bloc, nous annoncerons que la liste contiendra toutes les adresses Bluetooth disponibles.
    \item Le "\bold{Quand connexion.Après prise}" représente le bloc d'instructions après avoir choisi le module Bluetooth dans la liste. \\Dans ce bloc, après avoir récupéré l'adresse du module, nous nous connecterons à ce dernier.
\end{items}

Il faut donc placer ces deux blocs dans la zone blanche (glisser-déposer).

\subsection{Définir les clients Bluetooth disponibles}

Le bloc pour définir les élements de la liste \bold{Connexion} est le suivant : 

\img{\rootImages/connexion_begin.png}{Définition de la liste}{0.8}

Il attend en argument (zone de puzzle à droite) une liste. \\
Nous allons lui donner une liste des modules Bluetooth disponibles grâce à notre Client Bluetooth installé (Section \ref{bluetooth_install}). \\

Ce bloc est disponible dans le menu latéral, partie \bold{BluetoothClient1}

\img{\rootImages/bluetooth_place.png}{Sélection du client Bluetooth}{0.8}

Puis

\img{\rootImages/client.png}{Sélection du bloc des adresses}{0.8}

Au final, on obtient le bloc suivant : 

\img{\rootImages/bloc1.png}{Bloc de configuration de la liste}{0.8}

\section{Connexion au module Bluetooth}

Une fois que l'utilisateur a sélectionner le module auquel il souhaite se connecter, il faudra mettre à jour l'état de la liste et se connecter au module Bluetooth

\subsection{Principe}
Une fois que la personne a fait son choix dans "\bold{Connexion}", on vérifie la couleur de l'arrière plan de \bold{connexion} :

\begin{items}{blue}{\Triangle}
    \item Si la couleur est rouge (par défaut), cela veut dire que nous ne sommes pas connectés.
    On remplace donc le mot « Connexion » par l'adresse MAC\footnote{L'adresse MAC est une adresse physique pour identifier de manière unique un composant.} sélectionnée et on définit la couleur d'arrière-plan en vert, pour obtenir ceci :
    
     \img{\rootImages/mac.png}{Rendu de l'état de connexion}{0.5}
    
    
Visuellement, on sait que nous sommes connectés. \\
Ensuite,  pour se connecter réellement, on établit une connexion Bluetooth sécurisée à l'adresse donnée par la sélection de la liste «connexion». \\
Quand c'est fait, on envoie en Bluetooth la lettre « c » que l'Arduino se chargera d'interpréter, et pourra, en conséquent, jouer une mélodie pour confirmer la connexion.
    
   
    \item Si la couleur est verte , cela veut dire que nous sommes déjà connectés. Il faut donc remettre la couleur et le texte d'origine (« connexion ») et se déconnecter
    
\end{items}

\subsection{Emplacement des blocs}


Dans le bloc \bold{Quand connexion.Après prise}, nous allons avoir besoin d'une structure de contrôle, c'est à dire en l'occurrence un bloc conditionnel \bold{Si-Alors-Sinon}


\img{\rootImages/ifelse.png}{Emplacement des blocs conditionnels}{0.8}

Nous aurons également besoin d'un bloc de comparaison : 

\img{\rootImages/equal.png}{Emplacement des blocs de comparaison}{0.8}


Les blocs de couleurs sont disponibles à l'emplacement suivant : 

\img{\rootImages/colors.png}{Emplacement des blocs de couleurs}{0.8}


Enfin, les chaînes de caractères sont disponibles à l'emplacement suivant : 

\img{\rootImages/string.png}{Emplacement des chaînes de caractères}{0.8}


\messageBox{Astuce}{green}{white}{ Pour savoir où se situe une instruction, il faut regarder le nom de l'instruction. Elle sera de la forme nomInstruction.fonction. Le "nomInstruction" sera affiché dans un des onglets de gauche\\Par exemple, pour "mettre Connexion.elements", il faut aller dans l'onglet "Connexion"}{white}

Maintenant que vous savez ou trouver les blocs, je vous invite à recopier ce bloc d'instructions, qui n'est que la mise en pratique de la partie "Principe" de cette section

\img{\rootImages/connect.png}{Gestion de la liste après sélection}{0.6}

Le plus dur est fait, reste maintenant à gérer les boutons directionels.

\section{Gestion des boutons de direction}

Nous allons sélectionner le bouton \bold{Avancer} dans le menu de gauche
\img{\rootImages/zoom_bouton.png}{Menu du bouton Avancer}{0.6}

 A l'intérieur de ce bloc, on mettra les instructions pour envoyer le mot « c » en Bluetooth \\
Pour le langage Arduino, c'est l'équivalent de :

\begin{Cpp}{Equivalent Arduino}
if (bouton==appui) {allumer led ;}     
\end{Cpp}
	        
Après, nous avons d'autres  paramètres (appui long, après avoir retiré le doig, sur le bouton...) \\


Placez le "\bold{Quand  avancer. Click}" sur la page blanche. \\

Ensuite, nous allons vérifier si nous sommes connectés. Pour cela, nous mettrons un "\bold{Si connexion.Couleur\_de\_fond = vert} » afin d’attester la connexion.

Enfin, sélectionnez l'onglet "\bold{BluetoothClient1}" et insérez la fonction "\bold{envoyer texte}" en mettant le mot "a" (comme avancer) en texte à envoyer. \footnote{il faut privilégier de petites chaînes de caractère afin que le module puisse lire plus facilement. Il y a moins de perte de données} \\
Pour obtenir ceci : 


\img{\rootImages/bouton_avancer.png}{Code du bouton Avancer}{0.6}

Il suffit de réaliser la même étape pour tous les boutons. Il faudra juste changer le "\bold{Quand avancer.Click}" en "\bold{Quand 'bouton'.Click}" et ne pas oublier de changer le texte à envoyer. \\


Par exemple, un deuxième bouton donnerait :  ("g" pour gauche, "d" pour droite, "r" pour reculer, "s" pour stop, "b" pour batterie, "A" pour automatique)

\img{\rootImages/bouton_gauche.png}{Code du bouton Gauche }{0.6}

Après avoir fait ceci pour les autres boutons, l'application est terminée… \\
Nous pouvons donc passer à l'installation de l'application sur votre téléphone\chapter{Installation de l'application}

\section{Installation de MIT App Inventor}

Pour installer l'application que vous avez réalisé, il est préférable d'installer l'application MIT AI2 Companion disponible sur Play Store. \\
Cette application (relativement légère (50 Mo) va faire le lien entre le site App Inventor et votre téléphone. \\
Une fois que votre application est terminée, voici la façon la plus simple pour l'installer : 


\begin{items}{blue}{\Triangle}
    \item Installer MIT AI2 Companion sur votre téléphone 
     \img{\rootImages/download.png}{Logo de l'application}{0.5}
    \item Lancer l'application MIT AI2 Companion lorsque'elle est installée \bold{sur votre téléphone}
     \img{\rootImages/mit.png}{Rendu de l'application MIT AI2 Companion}{0.4}
    \item Connecter vous au réseau Wifi de votre maison \bold{depuis votre téléphone}
    \item Ouvrez votre application (Cocci-Bot) dans App Inventor (\url{http://appinventor.mit.edu/}) \bold{depuis votre ordinateur}
    \item Rendez-vous dans le menu du haut, sélectionner \bold{Construire} puis \bold{App ( Donnez le code QR pour fichier .apk )}
    \img{\rootImages/build.png}{Emplacement du menu "Construire"}{1}
    Une barre de progression devrait apparaître.
    \img{\rootImages/progressbar.png}{Barre de progression}{0.6}
    Une fois la barre de progression disparue, un QR Code apparaît. \\ {\color{red}Ne surtout pas cliquer sur \bold{ok}}
    \img{\rootImages/qrcode.png}{QR code}{0.6}
    
   \item Il est temps de scanner le code avec l'application MIT AI2 Companion sur votre téléphone ("Scan with QRCode"). Une fois le processus terminé, vous pouvez cliquer sur \bold{ok}, il faudra suivre les consignes sur votre téléphone portable (gestion des autorisations...)
   \item Et voila !
    
\end{items}

Nous pouvons passer au code Arduino et au traitement des données.\chapter{Traitement des données}

\section{Branchements}

Comme dit au chapitre \ref{appairage}, il faut relier le « +5V » du module au  5 Volts de la carte Arduino et la masse du module à celle de la carte.\\
Ensuite, nous allons relier la broche TX du module à la broche 12 de la carte et la broche RX à la broche 10. \\
Voilà, le branchement est terminé.

\section{Code Arduino}

\messageBox{Point-clé}{orange}{white}{Afin de lire les données du module, nous allons "émuler" une voie série, en l’occurrence les broches 10 et 12. \\C'est-à-dire que nous allons déclarer que ces broches recevront et enverront des données.}{white}

Pour cela, il faut utiliser la bibliothèque \bold{SoftwareSerial}.
Dans le logiciel Arduino, allez dans \bold{croquis} puis \bold{inclure une bibliothèque}  et sélectionnez \bold{SotfwareSerial}.

\img{\rootImages/software.png}{Inclusion de la bibliothèque SoftwareSerial}{0.7}

Maintenant, nous allons définir les broches du module (toujours avant le « void setup ») :

\begin{Cpp}{Définitions des broches RX et TX}
const int RX = 10;
const int TX = 12
\end{Cpp}

Après ceci, il faut déclarer un objet \bold{SoftwareSerial}  qui prendra en argument respectivement les broches TX et Rx, un peu comme lors de la déclaration d'un écran LCD (« LiquidCrystal lcd (RS,E,D4,D5,D6,D7); »).

On obtient donc :

\begin{Cpp}{Définition de l'objet SoftwareSerial}
#include <SoftwareSerial.h>

const int RX = 10;
const int TX = 12;

SoftwareSerial crius(RX,TX);
\end{Cpp}

Bien entendu, "crius" peut être remplacé par ce que vous voulez. \\
Ensuite, on déclare que la communication carte-module peut débuter  avec "crius.begin(115200) ;"
Où 115200 correspond à la vitesse de transmission en bauds (comme "Serial.begin(115200);") ;

\begin{Cpp}{Vitesse de communication}
SoftwareSerial crius(RX,TX);
void setup() {
    crius.begin(115200);
}
\end{Cpp}

\messageBox{Remarque importante}{red}{white}{Par la suite, en cas d'erreurs de transmission Bluetooth (pas de données...), il conviendra de vérifier le branchement des broches RX et TX (essayer de les intervertir) et d'éventuellement changer la vitesse de communication  car certains modules communiquent à 9600 bauds !}{white}

Pour lire les données du module, ce sont presque les mêmes fonctions que pour le port série : \\
En effet : \\

Pour le port série :	\\	

\begin{items}{blue}{\Triangle}
    \item Serial,begin(115200);
    \item Serial.available();
    \item Serial.read();	
    \item Serial.print();
    \item Serial.println();
\end{items}

Pour le module Bluetooth : \\

\begin{items}{blue}{\Triangle}
    \item crius,begin(115200);
    \item crius.available();
    \item crius.read();	
    \item crius.print();
    \item crius.println();
    
\end{items}


Tant que des données (caractères) sont disponibles, nous allons les assembler en une chaîne de caractère (concaténation). \\
Ensuite, avec un \bold{if}, nous allons voir si cette chaîne en question correspond par exemple à "a". \\ 
Si c'est la cas, nous allons appeler la fonction \bold{robot.enAvant(100);} \\

Il faut donc définir un caractère x et une chaîne de caractère.
Donc dans le programme Arduino, avant la fonction \bold{setup}, on rajoute :

\begin{Cpp}{Définition des structures du message}
#include <SoftwareSerial.h>

const int RX = 10;
const int TX = 12;

char c;
String message;

\end{Cpp}

La boucle while va permettre de lire les données : 
Dans la boucle \bold{loop} : on écrit :

\begin{Cpp}{Boucle de lecture partielle}
 void loop() {
 
    while() {
    
    }//Fin while

 }//Fin void loop

\end{Cpp}

Maintenant que la boucle va attendre des données, il suffit de les lire et de les transformer en chaîne de caractère. \\
Pour cela : \\

\begin{items}{blue}{\Triangle}
    \item on lit le premier caractère c
    \item on définit que la chaîne message = message + c 
\end{items}
On obtient :

\begin{Cpp}{Boucle de lecture complète}
 void loop() {
 
    while(crius.available()>0) {
    
        c = crius.read();
        message = message + c;
    }//Fin while

 }//Fin void loop

\end{Cpp}

La structure conditionnelle est très simple : \\
Après la boucle « while », mettez : \\

\begin{Cpp}{Structure conditionnelle}
 void loop() {
 
    while(crius.available()>0) {
    
        c = crius.read();
        message = message + c;
    }//Fin while
    
    if(message=="c") {
    
        message="";
        Melodie(1);
    }//Fin if message=="c"

 }//Fin void loop

\end{Cpp}

« c » correspond au message envoyé par l'application lors de l'appui du bouton connexion.\\

{\color{red} Attention !!! il est important de vider la chaîne de caractère avec "message= '' '' ;", sinon, lorsque le module recevra un autre message (par exemple "s"), la chaîne sera égale à "cs"} \\

Après avoir fait ceci pour les boutons connexion, avancer, droite, gauche, stop, batterie et reculer, voici le résultat :


\begin{Cpp}{Code des if}
void loop() {
 
    while(crius.available()>0) {
    
        c = crius.read();
        message = message + c;
    }//Fin while
    
    if(message=="c") {
    
        message="";
        Melodie(1);
    }//Fin if message=="c"

  if(message=="c")  {message=""; 
                    Melodie(1);}
                                
  else if(message=="a"){message="";             
                        robot.enAvant(100);
                        etatMoteurs=true;}
                                
  else if(message=="r")   {message="";
                           robot.enArriere(100);
                           etatMoteurs=false;}  
                                                      
  else if(message=="d")   {message="";            
                           robot.tourneDroite(100);
                           etatMoteurs=true;}
                                
  else if(message=="g")    {message="";           
                            robot.tourneGauche(100);} 
                                
  else if(message=="s") {message="";          
                              robot.arret();}
                                
  else if(message=="b")  {message="";              
                          TestBatterie();}        
                                                           
  else if(message=="A")  {gestion_mouvement();}   
  
  }//Fin void loop
\end{Cpp}

Pour finir, nous allons nous occuper de la partie automatique, qui s'activera avec l'appui sur le bouton auto. \\
Le début est le même, avec le \bold{if}, en revanche, cette fois-ci, nous ne viderons pas la chaîne de caractère.

\begin{Cpp}{Code gestion\_mouvement()}
 void gestion_mouvement() {

  while(message=="A") {

  robot.enAvant(100);
    
    distance = moyenneMesure(30, A2);
    fin_automatique(); 
    if(distance>500) {

      robot.tourneGauche(100);
      delay(1500);
      distance = moyenneMesure(30, A2);
      fin_automatique(); 
      if(distance>500) {

        robot.tourneDroite(100);
        delay(3000);

        distance = moyenneMesure(30, A2);
        fin_automatique(); 
        if(distance>500) {

            robot.tourneGauche(100);
            delay(1500);
        }
        else{robot.enAvant(100);}

      }                
      else  {robot.enAvant(100);}   

    }
     else {robot.enAvant(100);}  

 }//fin while
 }//fin gestion mouvement
\end{Cpp}


On remarque que dans cette fonction, il y a une boucle "while".
La boucle "while(message== "A") {}"  s’exécutera tant que l'on n’appuiera pas sur un autre bouton ;\\ 
En effet, si j'appuie sur le bouton stop, la chaîne message ne sera plus égale à "A", la boucle "while" ne sera plus respectée et le robot s’arrêtera. \\

Afin de sortir de la boucle "while", il faut intercaler dans l'algorithme plusieurs fois une fonction \bold{fin\_automatique} » qui comprend :

\begin{Cpp}{Code fin\_automatique()}
 void fin_automatique() {

if(bluetooth.available()>0) {
  robot.arret();
  message="";
  etatMoteurs=false;

}//fin if

}//fin fin_automatique

\end{Cpp}

Dès qu'une donnée est présente, cela arrête le robot, vide la chaîne de caractère. Le programme revient donc à la boucle "while" de départ, au tout début du \bold{void loop}.

Si vous voulez ajouter un bouton sur l'application, vous savez le faire.
Pour ajouter ce bouton dans le code Arduino, il suffit de rajouter une ligne :

\begin{Cpp}{Code d'ajout de touche}
if(message=="valeur envoyée depuis l'application")   {message="";             
                           action();}
\end{Cpp}

\section{Conclusion}
Le programme complet du cocci-bot, l'application (que vous pourrez modifier) ainsi que les branchements se situent en annexe du dossier%\addPartText{Documentation du projet MySensors}
\part{Projet MySensors}

\chapter{Introduction}

\section{Présentation}

Ce document a pour but d'expliquer la mise en place d'une passerelle et d'une sonde MySensors.

\subsection{Organigramme}

\begin{figure}[h]
  \centering
\begin{tikzpicture}[node distance={30mm}, thick, main/.style = {draw, circle}]
  \node[main] (1) [color=green] {$Sonde$}; 
  \node[main] (2) [above right of=1, color=cyan] {$Passerelle$}; 
  \node[main] (3) [left of=1] {$DHT$}; 
  \node[main] (4) [below of=3] {$Capteur_2$}; 
  \node[main] (5) [below of=1] {$Capteur_3$}; 
  \node[main] (6) [right of=2, color=blue] {$Domoticz$};
  
  \draw[->] (3) -- (1);
  \draw[->] (4) -- (1);
  \draw[->] (5) -- (1);

  \draw[->] (1) -- (2);
  \draw[->] (2) -- (6);
\end{tikzpicture} 
\caption{Les différents composants du projet}
\end{figure}

  \subsection{Principe}

  Les capteurs vont être analysés par la sonde MySensors.\\
  Cette dernière enverra à distance les informations vers la passerelle qui se chargera d'envoyer les informations au serveur Domoticz via une liaison USB.\\


  Une sonde représente un endroit physique, un lieu de mesure. \\
  Si vous souhaitez par la suite faire d'autres relevés dans un endroit différent, il suffira d'ajouter une sonde et de garder la passerelle.\\
  Chaque sonde est caractérisée par un identifiant de noeud (NODE\_ID) et chaque capteur possède un identifiant enfant sur la sonde qui lui est rattachée (CHILD\_ID)
  \begin{figure}[h]
    \centering
  \begin{tikzpicture}[node distance={30mm}, thick, main/.style = {draw, circle}]
    \node[main] (1) {$Passerelle$}; 
    \node[main] (2) [below left of=1] {$Sonde_1$}; 
    \node[main] (3) [left of=1] {$Sonde_2$}; 
    \node[main] (4) [above left of=1] {$Sonde_3$}; 

    \node[main] (5) [right of=1] {$Domoticz$};
    
    \draw[->] (2) -- (1);
    \draw[->] (3) -- (1);
    \draw[->] (4) -- (1);
  
    \draw[->] (1) -- (5);
    \end{tikzpicture} 
    \caption{Une extension possible}
  \end{figure}





  \section{Structure du projet}

  Nous vous invitons à garder la structure suivante pour le projet : 
  
  Dans un dossier \lblue{DIR}{Domoticz\_Crepp}, placez deux dossiers appelés \lblue{DIR}{Sonde\_MySensors} et\\ \lblue{DIR}{Passerelle\_MySensors}
  
  Ces deux derniers dossiers contiendront respectivement le programme de la sonde et de la passerelle.
  
  
  % \begin{figure}[h!]
  %   \centering
  % \usetikzlibrary{trees}
  
  % \tikzstyle{every node}=[draw=black,thick,anchor=west]
  % \tikzstyle{selected}=[draw=blue,fill=blue!30]
  % \tikzstyle{optional}=[dashed,fill=gray!50]
  % \begin{tikzpicture}[%
  %   grow via three points={one child at (0.5,-0.7) and
  %   two children at (0.5,-0.7) and (0.5,-1.4)},
  %   edge from parent path={(\tikzparentnode.south) |- (\tikzchildnode.west)}]
  %   \node {Domoticz\_MySensors\_Crepp}
  %     child { node {Sonde\_MySensors}
  %       child { node [selected] {Sonde\_MySensors.ino}}
  %     }
  %     child [missing] {}				
  %     child { node {Passerelle\_MySensors}
  %       child { node [selected] {Passerelle\_MySensors.ino}}
  %     };
  % \end{tikzpicture}
  
  % \tikzstyle{every node}=[]
  % \tikzstyle{selected}=[]
  % \tikzstyle{optional}=[]
  % \caption{Arborescence du projet}
  % \end{figure}

  Occupons nous maintenant des bilbiothèques Arduino.\chapter{Bibliothèques Arduino}

\section{Installation des bibliothèques}

Lors de la première compilation d'un programme, il se peut que des bibliothèques soient manquantes.
C'est ce que nous allons voir. Pour cela, ouvrez le programme de la sonde (\bold{Sonde\_MySensors.ino}) sans brancher de carte Arduino.

Ensuite, cliquez sur le bouton \bold{Vérifier} (bouton de gauche) et patientez quelques secondes.\\

\img{\rootImages/verifier.png}{Bouton de vérification}{0.5}

Si la bibliothèque MySensors est manquante, vous obtiendrez l'erreur suivante: 

\img{\rootImages/error.png}{La bibliothèque MySensors manquante}{0.5}

Pour installer la bibliothèque, il suffit d'aller dans \bold{Croquis > Inclure une bibliothèque >Ajouter la bibliothèque .ZIP}

\img{\rootImages/place.png}{Ajout d'une bibliothèque}{0.5}

Il ne reste qu'à trouver le fichier \bold{Bibliothèque\_MySensors.zip} et à faire \bold{OK}

\img{\rootImages/lib.png}{Sélection du fichier ZIP}{0.5}

Un message de confirmation d'ajout est affichée en bas de la page du logiciel Arduino.

\img{\rootImages/message.png}{La bibliothèque MySensors est ajoutée}{0.5}

On clique à nouveau sur le bouton \bold{Vérifier} pour afficher les éventuelles erreurs.

\messageBox{Important}{orange}{white}{Dans certains cas, la bibliothèque \bold{Adafruit\_sensor} est manquante, il faut installer le fichier \bold{Bibliothèque\_Adafruit\_sensor.zip} disponible en annexe.}{white}
 

On refait ensuite le bouton \bold{Vérifier} et si la bibliothèque \bold{DHT} n'est pas installé, on obtient de nouveau : 

\img{\rootImages/dht.png}{La bibliothèque DHT manquante}{0.5}

On procède de la même façon, on va importer le fichier \bold{Bibliothèque\_DHT.zip} dans \bold{Croquis > Inclure une bibliothèque >Ajouter la bibliothèque .ZIP}

Une fois toutes les bibliothèques installées, le message suivant apparaît: 

\img{\rootImages/compilation.png}{La compilation est terminée}{0.5}

On va ensuite s'occuper de la vérification de la communication entre les cartes Arduino et l'ordinateur.\chapter{Programmation Pro-Mini}

Programmer une carte Arduino pro-mini avec une carte Arduino évite d'acheter un module FTDI.\\
De plus, la carte Arduino Uno pourra être réutilisée pour d'autres projets.\\

L'objectif est de programmer la carte Pro-mini sur la sonde MySensors.

\section{Liste du matériel}

\begin{items}{blue}{\Triangle}
    \item 5 câbles Dupont mâles-femelles\footnote{Il est possible de faire des liaisons mâles-femelles avec des câbles mâles-mâles et femelles-femelles}
    \img{\rootImages/wire.jpg}{Les câbles de connexion}{0.3}

    \item Une carte Arduino Pro-Mini
    \img{\rootImages/promini.jpeg}{La carte Arduino Pro-mini}{0.5}

    \item Une carte Arduino Uno
    \img{\rootImages/a1.jpg}{La carte Arduino Uno}{0.05}
    \messageBox{Important}{red}{white}{Il faut retirer le microcontrôleur de la carte Arduino Uno pour pouvoir programmer la carte Pro-Mini. Pour le retirer, on prend un petit tournevis et on soulève délicatement la puce. On prendra le soin de repérer l'orientation de la puce sur la carte (méplat vers l'extérieur de la carte) }{white}
    \img{\rootImages/step1.jpg}{On retire le microcontrôleur}{0.05}
    \img{\rootImages/a2.jpg}{La carte Arduino Uno sans son microcontrôleur}{0.05}

    
 

    \end{items}

  \section{Branchements}

  \messageBox{Attention}{red}{white}{La carte Arduino Pro-Mini doit être alimentée en 3.3V et non en 5V ! La carte Arduino Pro-Mini ne doit pas être placée sur son support de sonde lorsque elle est en train d'être programmée}{white}
 
  
  Voici les connexions à faire pour programmer la Pro-Mini: 

  Le mot \inputPin{XXXX\_UNO} représente une broche de la carte Arduino UNO et \\ 
  \outputPin{XXXX\_PRO-MINI} représente une broche de la carte Arduino Pro-Mini.\\
  \bold{XXXX} est l'indication du nom de la broche.

  \begin{items}{orange}{\Triangle}
    \item \inputPin{RESET\_UNO} vers \outputPin{RST\_PRO-MINI}
    \item \inputPin{+3.3V\_UNO} vers \outputPin{VCC\_PRO-MINI}
    \item \inputPin{GND\_UNO} vers \outputPin{GND\_PRO-MINI}
    \item \inputPin{RX\_UNO} vers \outputPin{RX\_PRO-MINI}
    \item \inputPin{TX\_UNO} vers \outputPin{TX\_PRO-MINI}
  \end{items}

  \img{\rootImages/pinout.png}{Les broches du Pro-Mini}{0.3}

  \messageBox{Remarque}{orange}{white}{Ici, la liaison série (\bold{RX} et \bold{TX}) n'est pas croisée, le \bold{RX} de la carte Uno  va sur le \bold{RX} de la Pro-Mini, idem pour le TX}{white}
 




  Vous pouvez ouvrir le programme Arduino que vous désirez charger\footnote{Vous pouvez charger le programme de clignotement de la LED pour l'exemple} sur la carte Arduino Pro-Mini.
  Voici un programme minimal pour faire clignoter la LED du pro-mini. \\
  Ce programme est disponible en allant, dans le logiciel Arduino, dans la section \bold{Fichiers > Exemples > basics > Blink}\\
  
  \begin{Cpp}{Programme d'exemple Blink}
  void setup() {
  // initialize digital pin LED_BUILTIN as an output.
  pinMode(LED_BUILTIN, OUTPUT);
}

// the loop function runs over and over again forever
void loop() {
  digitalWrite(LED_BUILTIN, HIGH);   // turn the LED on (HIGH is the voltage level)
  delay(1000);                       // wait for a second
  digitalWrite(LED_BUILTIN, LOW);    // turn the LED off by making the voltage LOW
  delay(1000);                       // wait for a second
}
  \end{Cpp}
  
Une fois le programme ouvert, voici les étapes pour compiler le programme.

  \section{Téléversement}

  \begin{items}{blue}{\Triangle}
    \item 1) Sélectionner la carte \bold{Arduino Pro-mini} dans \bold{Outils > Types de carte}
    \img{\rootImages/type.png}{Type de carte}{0.3}

    \item 2) Sélectionne le processeur \bold{ATmega328P, 3.3V, 8Mhz} dans \bold{Outils > Processeur}
    \img{\rootImages/processeur.png}{Type de processeur}{0.4}
  \end{items}

  \messageBox{Avertissement}{orange}{white}{N'oubliez pas de sélectionner le port de communication de l'Arduino}{black}
 
  Il ne vous reste plus qu'à cliquer sur le bouton de téléversement du programme.\\
  La LED de la carte Pro-Mini devrait clignoter.



  \messageBox{Information}{green}{white}{Ici, nous avons chargé un programme de test, par la suite, il conviendra de charger le programme \bold{Sonde\_MySensors.ino}.\\Cette étape de chargement de programme sera nécessaire à chaque modification du code de la sonde.}{black}
 

  \section{Programmation de la Nano}

  La carte Nano étant reliée à l'ordinateur par un câble USb, sa programmation sera plus aisée. 
  On alimente la carte via l'ordinateur, on sélectionne le type de carte (\bold{Type de carte > Arduino Nano}),\\
   le type de processeur (\bold{Outils > Processeur > Old bootloader}), le port puis on téléverse le programme désiré.\\


%PB : 

%Canal différent pour chaque personne\chapter{Montage de la passerelle}

\section{Rappels}

La passerelle reçoit sur sa barrette connecteurs femelles un \bold{Arduino Nano} et est reliée par une nappe à 8 conducteurs à un \bold{module transmetteur NRF24}.

L'Arduino Nano est relié au Raspberry Pi de votre plateforme Domoticz par un câble USB (transmission d'infos et alimentation 5v) et alimentera la passerelle en 5v.

Le module transmetteur NRF24 assure la liaison radio avec les sondes. 

\section{Liste du matériel de la passerelle}

\begin{items}{blue}{\Triangle}
    \item 3 Led
    \item 3 résistances de $270~\Omega$
    \item 2 condensateurs électrolytiques ( $100~\mu F, 16~V$ – cylindriques noirs)
    \item 2 condensateurs céramiques monolithiques ( $100nF, 50~V$ – couleur jaune foncé )
    \item 1 régulateur 3.3v HT7533-1
    \item 1 module transmetteur NRF24
    \item 1 bouton poussoir
    \item 1 circuit imprimé
    \item 1 barrette connecteurs femelle (\colors{red}{déjà montée sur le circuit imprimé})
    \item 1 nappe 8 conducteurs (\colors{red}{dont l'un porte un liseré rouge} ),
    \item 2 jumpers
\end{items}

\section{Placement des composants}

\subsection{Vue de dessus du circuit}
\img{\rootImages/pin.png}{Circuit imprimé vu de dessus, coté composants}{0.5}\label{TEST}
\subsection{Étapes}
\begin{items}{blue}{\Triangle}
\item Souder la barrette déjà en place


\messageBox{Remarque}{red}{white}{Il faudra faire très attention au placement de la carte Arduino nano par la suite : La broche D13 de la Nano doit être impérativement dans le trou le plus avancé (coté nappe de fils).\\Un décalage de 1 trou lors du placement de la carte Nano dans sa barrette pourra endommager la carte Nano et le module RF24 !}{black}
 
\item Souder les 8 brins de la nappe en respectant les consignes suivantes : 

\begin{items}{blue}{\Triangle}
\item Séparer les 8 conducteurs sur 2 cm environ.	
\item Chaque conducteur étant multibrins, s'assurer qu'ils sont bien torsadés puis étamer.
\item Respecter l'ordre de soudage -> Fil au liseré rouge en 1 puis conducteurs suivants en 2,3 	   etc.
\end{items}
\img{\rootImages/nappe.png}{Emplacement de la nappe}{0.5}

\messageBox{Remarque}{red}{white}{Ne pas se tromper sur la soudure de la nappe.\\ En gardant la vue de la Figure 3.1, le câble rouge de la nappe est en bas à gauche, le n°2 est en bas à droite, etc...}{black}
 
\end{items}

Puis dans l'ordre que vous souhaitez : 
\begin{items}{blue}{\Triangle}
    \item Led rouge en D1 – Led jaune en D2 – Led verte en D3 (\colors{red}{sont polarisées}, patte longue au + ,  patte courte, méplat sur la led au - ),
    \item Les 3 résistances sont à souder en R1, R2 et R3
    \item Les 2 condensateurs électrolytiques sont à souder en C1 et C2 (\colors{red}{sont polarisées}, le corps du condo est noir avec une bande grisée, la patte de ce côté est le - ),
    \item Les 2 condensateurs céramiques sont à souder en C3 et C4
    \item Le bouton poussoir en SW1
    \item Le jumper D13 (Arduino Nano) en J12
    \item Le jumper 5v (Arduino Nano) en J10
    \item Le régulateur 3.3v HT7533 est à souder suivant les conseils de la section suivante
\end{items}

\section{Mise en place du régulateur de tension}

Comme vous l'avez sûrement remarqué, l'implantation précédente correspond à un régulateur LE33 et non à un HT7533

Si vous voulez utiliser un HT7533, il faut adapter le brochage du HT7533 au circuit.

\begin{items}{blue}{\Triangle}
    \item Vin : Entrée 5v
    \item GND : la masse
    \item Vout : sortie 3.3V
\end{items}

\img{\rootImages/to-92.png}{Broches du HT7533}{0.5}

\subsection{Adaptation des broches du HT7533 au schéma de la passerelle}

Il faut que les broches \bold{GND, Vin et Vout} rentrent dans les mêmes broches que celle du schéma de la passerelle. Même si les broches ne sont pas dans le même ordre, c'est assez simple à faire en tordant les broches du HT7533 avec une petite pince plate.\\

Sur le HT7533, sans que les broches se touchent, \bold{on tord Vin vers l'avant, Vout vers l'arrière et on ramène GND au milieu.}

\img{\rootImages/ht.png}{Insertion du HT7533}{0.35}

\section{Rendus}

\img{\rootImages/side.png}{Vue de coté}{0.4}
\img{\rootImages/passerelle_emetteur.png}{Vue de la passerelle et de l'émetteur}{0.4}
\img{\rootImages/dessus.png}{Vue de dessus}{0.4}
\chapter{Montage de la sonde}


\section{Rappels}


La sonde reçoit sur sa barrette connecteurs femelles un \bold{Arduino Pro-Mini} et est reliée par une nappe à 8 conducteurs à un \bold{module transmetteur NRF24}.
Le module transmetteur NRF24 assure la liaison radio avec la passerelle. 

\section{Liste du matériel de la sonde}

\begin{items}{blue}{\Triangle}
\item 1 pcb
\item 2 barrettes mâle-femelle 12 plots		
\item 1 barrette mâle-femelle 3 plots	
\item 1 barrette mâle-femelle 2 plots	
\item 3 barrettes mâle-mâle 5 plots		
\item 1 barrette mâle-mâle 4 plots		
\item 1 barrette mâle-mâle 3 plots		
\item 3 barrettes mâle-mâle 2 plots		
\item 1 barrette mâle-mâle 1 plot		
\item 2 condensateurs céramiques 100 nF
\item 2 condensateurs chimiques    10 µF
\item 1 résistance 1/4 w  330 K$\Omega$
\item 1 résistance 1/4 w 1M$\Omega$
\item 1 régulateur HT7533
\item 1 longueur de fil d'acier pour shunts
\item 1 longueur de fil isolé pour shunt
\item 1 carte Pro mini
\item 1 émetteur NRF24
\item 1 nappe 8 conducteurs
\end{items}

\section{Placement des composants}

\subsection{Vue de dessus du circuit}
\img{\rootImages/pcb.png}{Circuit imprimé vu de dessus, coté composants}{0.5}\label{TEST}


\subsection{Étapes}
\begin{items}{blue}{\Triangle}
\item Souder les shunts. Voir schéma général et la photo platine sonde shunts
\item Souder les 8 conducteurs de la nappe en suivant les mêmes instructions que pour le montage de la passerelle
\img{\rootImages/nappe.png}{Emplacement de la nappe}{0.5}
\end{items}
Puis dans l'ordre que vous souhaitez : 
\begin{items}{blue}{\Triangle}
    \item Les 2 condensateurs électrolytiques sont à souder en C1 et C2 (\colors{red}{sont polarisées}, le corps du condensateur est noir avec une bande grisée, la patte de ce côté est le - ),
    \item Les 2 condensateurs céramiques sont à souder en C3 et C4
    \item Le régulateur 3.3v HT7533\\
    \bold{A la différence de son implantation sur la passerelle MySensor, ici il ne faut pas croiser les pattes, implantez le module tel quel en respectant son positionnement sur le pcb grâce au méplat}

    \item Les 2 condensateurs céramiques de 100 nF
    \item Les 2 résistances de 330 k$\Omega$ et de 1 M$\Omega$    (Elles ont le même aspect extérieur vérifier à l’ohmmètre avant la pose)
    \item les 2 condensateurs chimiques de 10 µF	(Le moins est du côté grisé sur le corps du condensateur)
    \item Souder les connecteurs mâle-mâle sur la carte Pro mini, ils sont livrés dans la pochette.\\ Attention à ne pas trop chauffer les points de soudure.
    \item Faire de même avec la carte Arduino Nano nécessaire à la passerelle.
\end{items}

\section{Rendus}

\img{\rootImages/s4.jpg}{Sonde vue de dessus sans la nappe}{0.25}
\img{\rootImages/s3.jpg}{Sonde vue de dessus avec la nappe}{0.25}\chapter{Vérification}

\section{Les court-circuit}

\subsection{Le multimètre} 

Le meilleur allié contre les courts circuit est le multimètre.\\
Sur les rangées de barrettes, nous allons regarder la résistance entre deux broches voisines. \\
Si la résistance est infinie (\bold{Un 1 affiché sur l'écran}), il n'y a pas de court-circuit et si elle tend vers 0, il y a un risque.

\subsubsection{Réglage}

On règle le multimètre en mode \bold{Ohmmètre}, c'est à dire avec le fil noir sur \bold{COM}, le rouge sur \bold{$\Omega$} et le curseur réglé sur la résistance la plus élevée de l'appareil.
\imgr{\rootImages/multi.jpg}{un multimètre bien réglé}{0.05}{-90}


On regarde la résistance entre les broches 1 et 2 par exemple pour commencer puis ensuite entre la broche 2 et 3, etc...

\img{\rootImages/c.jpg}{Une vérification}{0.08}


\subsection{L'alimentation} 

Le problème le plus grave peut survenir si un court circuit a lieu entre la broche +VCC\footnote{Alimentation positive, ici +3.3V pour la sonde et +5V pour la passerelle} et la masse.\\
Il convient donc de trouver ces deux broches (VCC et GND) et de regarder la valeur de la résistance entre ces deux broches. Cette valeur doit être infinie (\bold{1 sur l'afficheur})

\section{Les sondes NRF24}

Les sondes NRF24 viennent s'insérer dans la nappe de fils (8 brins). Il ne faut pas se tromper de sens sous peine de détruire le module NRF24 lors de sa mise sous tension.

Pour cela, il faut que le coté avec les broches 1 et deux du NRF24 (repéré avec le carré blanc sur la broche 1) soit du même coté que le fils rouge de la nappe.

\imgr{\rootImages/nrf24.jpg}{Insertion du NRF24 dans son connecteur}{0.05}{-90}


Une fois que la connexion électrique est exacte, on peut alimenter le montage et vérifier la tension au bornes de la sonde NRF24.
Si une tension inférieure à $3.2V$ ou supérieure à $3.4V$ apparaît, coupez l'alimentation et reprenez les vérifications.

Puis procédez de la même manière pour la sonde.\chapter{Programmation sonde}

Nous allons configurer le programme de la sonde (\bold{Sonde\_MySensors.ino})pour l'envoi des données des capteurs. 

\subsection{Paramétrage du NRF24}

Pour éviter les interférences entre les modules NRF24 dans une même salle, nous allons sélectionner un canal de communication pour chaque personne.\\
Un canal correspond à une fréquence précise d'émission et de réception pour le module NRF24.\\

Voici le tableaux des canaux attribué aux personnes :
\begin{figure}[!h]
    \centering
    \begin{tabular}{|l|r|}
        \hline
\bold{Prénom} & \bold{CANAL\_NRF24}\\
    \hline
André P. & 84 \\
\hline
Florian M. & 85 \\
\hline
Guy D. & 86 \\
\hline
Marcel R. & 87 \\
\hline
Michel T. & 88 \\
\hline
Nicolas L.G. & 89 \\
\hline
Patrice G. & 90 \\
\hline
Patrick P. & 91 \\
\hline
Patrick Z. & 92 \\
\hline
Philippe C. & 93\\
\hline
Pierre G. & 94\\
\hline
Yvon & 95\\
\hline
    \end{tabular}
    \caption{Répartition des canaux pour les utilisateurs}
    \end{figure}


    Voici un extrait du code \bold{Sonde\_MySensors.ino} : 

\begin{Cpp}{Paramétrage du NRF24}
/*!
 * ************************************************************
 * PARAMETRES NRF24 (exemple canal 86)
 * Légende : (*) = A changer pour chaque personne
 * ************************************************************
 */
//Mode debug activé
#define MY_DEBUG

// Enable and select radio type attached 
#define MY_RADIO_RF24

#ifndef MY_RF24_PA_LEVEL
#define MY_RF24_PA_LEVEL     RF24_PA_MAX
#endif

#ifndef MY_RF24_CHANNEL
#define MY_RF24_CHANNEL    86 //(*)  A CHANGER
#endif

#ifndef MY_RF24_DATARATE
#define MY_RF24_DATARATE RF24_250KBPS
#endif

\end{Cpp}

\subsection{Paramétrage de Domoticz}

Comme vue dans le chapitre de présentation, chaque sonde possède un identifiant et chaque capteur rattaché à la sonde possède lui aussi un identifiant.\\

Pour éviter toute confusion, nous allons également attribuer un identifiant à notre sonde et à nos capteurs, ces identifiants sont définis pour chaque personne dans le tableau suivant :\\


\begin{figure}[!h]
    \centering
    \begin{tabular}{|l|r|r|r|r|}
        \hline
\bold{Prénom} & \bold{MY\_NODE\_ID} & \bold{ID batterie} & \bold{ID température} & \bold{ID Humidité} \\
    \hline
André P. & 10 & 11 & 12 & 13 \\
\hline
Florian M. & 20 & 21 & 22 & 23 \\
\hline
Guy D. & 30 & 31 & 32 & 33 \\
\hline
Marcel R. & 40 & 41 & 42 & 43 \\
\hline
Michel T. & 50 & 51 & 52 & 53 \\
\hline
Nicolas L.G. & 60 & 61 & 62 & 63 \\
\hline
Patrice G. & 70 & 71 & 72 & 73 \\
\hline
Patrick P. & 80 & 81 & 82 & 83 \\
\hline
Patrick Z. & 90 & 91 & 92 & 93 \\
\hline
Philippe C. & 100 & 101 & 102 & 103 \\
\hline
Pierre G. & 110 & 111 & 112 & 113 \\
\hline
Yvon G. & 120 & 121 & 122 & 123 \\
\hline
    \end{tabular}
    \caption{Répartition des identifiants pour les utilisateurs}
    \end{figure}

\begin{Cpp}{Paramétrage de Domoticz}

/*!
 * ************************************************************
 * PARAMETRES DOMOTICZ (Exemple avec l'ID 30)
 * ************************************************************
 * Légende : (*) = A changer pour chaque personne
 */
#define MY_NODE_ID 30         //Noeud dans Domoticz (*)

//Voir le tableau
#define CHILD_ID_BATT 31      //(*) Identifiant Domoticz pour le niveau de batterie 
#define CHILD_ID_TEMP 32      //(*) Identifiant Domoticz pour la température
#define CHILD_ID_HUM 33       //(*) Identifiant Domoticz pour l'humidité

\end{Cpp}

ici, il nous reste à définir le temps entre deux envois de données par la sonde.

\begin{Cpp}{Temps de mise à jour}

//Temps entre deux envois de données
static const uint64_t UPDATE_INTERVAL = 10000;   
\end{Cpp}

Ensuite, on peut éventuellement changer le nombre de mesure au bout duquel la sonde envoie les données même si elles n'ont pas changés

\begin{Cpp}{Nombre de lectures forcée}
    //Nombre au bout duquel la sonde envoie les données même si elles n'ont pas changés
    static const uint8_t FORCE_UPDATE_N_READS = 10;
\end{Cpp}



\subsection{Paramétrage du DHT}

Il faut préciser si le capteur est un DHT11 ou DHT22 et indiquer la broche du capteur

\begin{Cpp}{Paramétrage du DHT}
    /*!
    * ************************************************************
    * DHT22/DHT11
    * ************************************************************
    */
   //Broche de données du DHT22 (ou DHT11)
   #define DHT_DATA_PIN 3
   
   #define DHT_TYPE DHT22 //use DHT11 or DHT22
   
   //définir une valeur si le capteur à un offset permanent par rapport à la température réelle
   #define SENSOR_TEMP_OFFSET 0
   
   float lastTemp;   //Dernière valeur de température lue
   float lastHum;    //dernière valeur d'humidité lue
   
\end{Cpp}


\subsection{Paramétrage de la mesure de la batterie}

Il suffit de renseigner les valeurs des résistances (en $\Omega$) formant le pont diviseur de tension.\\
Dans mon cas, les résistances ont une valeur de 330 $k\Omega$ et $1 M\Omega$

\bold{Le calcul pour afficher la tension réel de la batterie est détaillé en annexe.}

\begin{Cpp}{Paramétrage du multimètre}
    /*!
    * ************************************************************
    * BATTERIE
    * ************************************************************
    */
   //Partie pour mesure Batterie
   int BATTERY_SENSE_PIN = A0;  //ne pas toucher
   
   float oldBatteryV = 0;//Sauvegarde du niveau de batterie
   
   const float r1_value = 1000000.0; //Valeur de la résistance la plus proche de l'alimentation de la batterie
   const float r2_value = 330000.0; //Valeur de la résistance la plus proche de la masse

\end{Cpp}




\chapter{Branchements du DHT}

\img{\rootImages/dht.jpg}{Branchement du DHT sur la sonde}{0.07}

Voici les connexions pour brancher le DHT : 

\begin{items}{orange}{\Triangle}
  \item \inputPin{GND\_DHT} est représenté par le câble verts (droite)
  \item \inputPin{VCC\_DHT} est représenté par le câble orange (gauche)
  \item \inputPin{OUT\_FHT} est représenté par le câble jaune (D3) (centre)
\end{items}

\img{\rootImages/connection.png}{Schéma du circuit imprimé}{0.5}\chapter{Programmation passerelle}

Nous allons configurer le programme de la passerelle(\bold{Passerelle\_MySensors.ino})pour la réception des données.

\subsection{Paramétrage du NRF24}

Il faut mettre le même canal de communication que pour la sonde.\\
Un module recevant sur le canal 84 ne pourra pas recevoir des données en provenance d'un canal 83 ou 85.

Pour rappel, voici le tableau des canaux: 
\begin{figure}[!h]
    \centering
    \begin{tabular}{|l|r|}
        \hline
\bold{Prénom} & \bold{CANAL\_NRF24}\\
    \hline
André P. & 84 \\
\hline
Florian M. & 85 \\
\hline
Guy D. & 86 \\
\hline
Marcel R. & 87 \\
\hline
Michel T. & 88 \\
\hline
Nicolas L.G. & 89 \\
\hline
Patrice G. & 90 \\
\hline
Patrick P. & 91 \\
\hline
Patrick Z. & 92 \\
\hline
Philippe C. & 93\\
\hline
Pierre G. & 94\\
\hline
Yvon & 95\\
\hline
    \end{tabular}
    \caption{Répartition des canaux pour les utilisateurs}
    \end{figure}

    Voici un extrait du code \bold{Passerelle\_MySensors.ino} : 

\begin{Cpp}{Paramétrage du NRF24}
/*!
 * ************************************************************
 * PARAMETRES NRF24 (exemple canal 86)
 * Légende: (*) = A changer pour chaque personne
 * ************************************************************
 */
 #ifndef MY_RF24_CHANNEL
 #define MY_RF24_CHANNEL    86         //Le canal doit être le même que celui de la sonde
 #endif             

\end{Cpp}


\section{Envoi des programmes}

Une fois les deux programmes modifiés avec les bonnes valeurs, il ne vous reste plus qu'à envoyer le programme de la sonde sur la carte Pro-Mini et celui de la passerelle sur la carte Nano.\\
Toutes les informations pour programmer les deux cartes sont disponibles au chapitre 2 (\bold{Programmation}).

Lorsque les deux cartes sont programmées, occupons nous maintenant de Domoticz.\chapter{Configuration de Domoticz}

Une fois que la passerelle est fonctionnelle, nous allons configurer Domoticz pour que la plateforme reçoive 
les données en provenance de la passerelle.

\section{Ajout de la passerelle}

Tout d'abord, allez dans la section \bold{Configuration > Matériel}

\img{\rootImages/hardware.png}{Emplacement du matériel}{0.5}

Ensuite, saisissez les informations suivantes :

\img{\rootImages/add_gateway.png}{Paramétrage de la passerelle}{0.5}

Le port série sélectionné sera celui où est raccordé la passerelle en liaison USB.
Il ne faut pas prendre les noms simplifiés des ports USB (\italic{COM\_XXX}) mais le nom le plus complet.\\
Pour plus de simplicité, veuillez déconnectez tous les autres périphériques du Raspberry-Pi\\.


\section{Recherche des capteurs}

Visualisons les données en provenance de la sonde en allant dans \\
\bold{Configuration > Matériel}\\.

L'ensemble de vos dispositif apparaît. En cas de liste trop longue, saisissez \bold{Gateway} dans la barre de recherche.


\img{\rootImages/search.png}{Recherche de la passerelle}{0.5}


\messageBox{Remarque}{orange}{white}{Si le dispositif n'apparaît pas immédiatement, patientez quelques instants.}{black}

\img{\rootImages/gateway.png}{La passerelle est détectée}{0.4}


Nous allons ensuite vérifier que les capteurs de la sonde envoient bien les données. Pour cela, cliquez sur \bold{Configuration}.
La page suivante apparaît : 

\img{\rootImages/home.png}{Page de la Gateway}{0.4}

Pour visualisez les valeurs des capteurs, il faut sélectionner la passerelle avec l'ID de la sonde (ici, 30).

\img{\rootImages/nodes.png}{Sélection de la passerelle}{0.5}

En cliquant dessus, on voit que la partie \bold{Enfants} est mise à jour et contient les 3 capteurs avec les ID définis dans le programme de la sonde (31,32 et 33 en ce qui me concerne)

\img{\rootImages/enfants.png}{Visualisation des enfants}{0.4}


\section{Visualisation des données}

Maintenant que nous savons que la sonde envoi les bonnes données, nous allons ajouter les capteurs dans les dispositifs.
Pour cela, allez dans \bold{Configuration > Dispositifs}, les 3 capteurs de la sonde (Tension batterie, humidité et température) apparaissent dans la liste.\\
Si vous ne les trouvez pas, vous pouver nettoyer la page des capteurs en sélectionnant les capteurs non-utilisés et en le mettant à la poubelle.

\img{\rootImages/disp.png}{Visualisation des capteurs}{0.25}

Les capteurs apparaissent sous les 3 noms suivants : 

\img{\rootImages/names.png}{Nom des capteurs}{0.6}

Pour ajouter un dispositif, il suffit de cliquer sur la flèche verte et de choisir le nom du dispositif.

\img{\rootImages/fleche.png}{Ajout des dispositifs}{0.5}

\img{\rootImages/voltage.png}{Ajout des dispositifs - Sélection du nom}{0.5}

Il suffit de cliquer dans le menu \bold{Mesures}

\img{\rootImages/mesure.png}{Mesures}{0.4}

Et apparaît la tension de la batterie.

\img{\rootImages/volt.png}{tension de la batterie}{0.5}

On procède de même pour l'humidité et la température, les dispositifs seront mis dans l'onglet  \bold{Température}.

\img{\rootImages/temp.png}{Mesures de l'humidité et de la température}{0.4}


Pour visualiser les données, il suffit de cliquer sur le bouton \bold{logs}%\chapter{Pont diviseur}


\section{Démonstration}

Soit le pont diviseur de tension formé par les deux résistances $R_1$ et $R_2$.\\
Le pont est alimenté avec la tension de la batterie.\\
La tension de sortie $V_s$ va en entrée de la carte Arduino. (A0)


\begin{schema}{Le pont diviseur}
  \addPower{6,4}{power1}{$V_{Batterie}$}
  \addResistor{power1}{\Down}{6,2}{\orthogonalWireA}{$R1$}
  \addNode{6.5,2.3}{node1}{$V_s$}
  \addResistor{6,2}{\Down}{6,0}{\orthogonalWireA}{$R2$}
  \addGround{6,0}{gnd1}{}
 \end{schema}


La tension en sortie d'un pont diviseur de tension vaut :

 $$ V_s = V_{Batterie} \cdot \frac{R_2}{R_1+R_2} $$\\

 La résolution du Convertisseur Analogique Numérique de l'Arduino est de 10 bits, c'est à dire que la CAN va donner une valeur $N_{CAN}$ comprise entre 0 et $2^{10}-1$, c'est à dire entre 0 et 1023.\\

 Ainsi, si le CAN affiche une valeur de 1023, cela veut dire que $V_s=3.3V$ et si $N_{CAN}=512$, la tension $V_s$ vaut environ 1.65 V.


 La tension $V_s$ est obtenue par la relation suivante : 

 %$$ V_s = N_{CAN} \cdot \frac{Tension_{référence}}{Résolution_{CAN}} = N_{CAN}\cdot \frac{3.3}{2^{10}}$$\\

 La tension de référence est généralement la tension de fonctionnement du microcontrôleur, c'est à dire ici 3.3V.

 On obtient donc la formule liant $V_{Batterie}$ et la valeur $N_{CAN}$ :

 %$$ V_{Batterie} = \frac{R_1+R_2}{R_2} \cdot N_{CAN} \cdot \frac{3.3}{2^{10}}$$\\


 Cette formule sera utilisé pour déterminer la tension réelle de la batterie en fonction du Convertisseur Analogique Numérique.


 %\chapter{Schéma passerelle}

 \img{\rootImages/schema_passerelle.png}{Schéma de la passerelle}{0.7}

 \chapter{Schéma sonde}

 \img{\rootImages/schema_sonde.png}{Schéma de la sonde}{0.6}


 \chapter{Questions}

\Question{Pourquoi ma passerelle n'est pas détectée sur Domoticz ?}
\Reponse{Une erreur fréquente est de sélectionner le mauvais port lors de la configuration de la passerelle dans Domoticz.}

 
 
\Question{Pourquoi la passerelle allume sa LED rouge ?}
\Reponse{La LED rouge veut dire que des erreurs de communication sont survenues entre la passerelle et la sonde. Vérifier les branchements de la sonde. }\part{Projet synthétiseur}
\chapter{Introduction}

L’objectif de ce projet est de réaliser un synthétiseur analogique.\\
On utilise donc un clavier qui, lorsque l’on appuie sur ses touches, produit des trames MIDI. 
On se sert ensuite du module MCV4 qui convertit les trames MIDI du clavier en signal analogique.\\

Notre rôle sera donc de dimensionner un synthétiseur analogique qui devra, à partir du signal de sortie du MCV4, 
retourner un signal qui répond au cahier des charges en fonction de la note jouée au clavier.\\

Le système global est appelé Oscillateur Contrôlé en Tension (VCO, Voltage Controlled Oscillator).
\chapter{Cahier des charges}

\subsection{Caractérisation du matériel}

Pour réaliser notre synthétiseur analogique, nous avons à disposition  :


\begin{items}{blue}{\Bullet}
    \item Un MCV4 (convertisseur MIDI / Tension) alimenté en 9V (tension continue)
    \item Un clavier générant une trame MIDI alimenté en 12V (tension continue)
    \item une plaque d’expérimentation LABDEC
    \item Des composants électroniques de base (résistances, condensateurs, AOP TL081...)
\end{items}

Dans un premier temps, nous allons caractériser la tension du MCV4 en fonction de la note jouée au clavier.\\
 Le MCV4 sera en mode Volt/Hz afin de simplifier le dimensionnement du système (relation linéaire entre les grandeurs d’entrée). \\

On cherche donc à déterminer la relation qui existe entre le signal d’entrée du MCV4 qui code la fréquence des notes jouées au piano et la 
tension analogique délivrée par le MCV4. Pour cela, on mesure la tension en sortie du MCV4 à l’aide d’un voltmètre. Pour chaque note jouée, on obtient :


\img{\rootImages/tableur.png}{Equation du VCO}{1}


Ainsi, nous obtenons la relation suivante : 


$$ Tension_{MCV4} =0.00217020673595 \cdot Frequence + 0.002907571050445 $$ 


Cette relation servira donc à vérifier la validité du système final en comparant la fréquence de sortie de notre 
synthétiseur avec la fréquence théorique donnée par cette relation.\\

\section{Contraintes}

Le montage général est imposé et sera sous cette forme:

\img{\rootImages/global.png}{Forme global du montage}{1}

Ce système devra générer un signal:

\begin{items}{blue}{\Bullet}
    \item Triangulaire
    \item Symétrique avec une composante moyenne nulle
    \item de valeur crête à crête 12V
    \item De fréquence f (f=1/T) qui correspond à la note jouée au piano
\end{items}

On va imposer certaines valeurs pour certains composants : 

\begin{items}{blue}{\Bullet}
\item une résistance R1 de 100K
\item un condensateur C de15nF
\item une alimentation symétrique +14 /-14V
\end{items}

Notre objectif sera donc de déterminer les valeurs de R3, R4 et R5 en sachant que R2 et R6 seront fixées de manière (presque) arbitraire.

\chapter{Etude des différents blocs fonctionnels}
\section{Etude du bloc 1}

\img{\rootImages/bloc1.png}{Bloc ensemble}{0.8}


\subsection{Etude du transistor}


Afin de caractériser le transistor, on étudie le montage ci- contre.

\img{\rootImages/transistor1.png}{Montage du transistor}{0.8}

Ce montage comprend une double alimentation stabilisée, une résistance de 1K et un transistor MOSFET 2N7000.\\

Afin de déterminer le modèle équivalent, on applique une tension négative puis positive sur la broche Gate du transistor (broche de commande) 
et on relève la tension aux bornes du transistor (tension entre Drain et Source appelée $V_{DS}$).\\

\img{\rootImages/gate9.png}{On applique une tension de 9V}{0.7}
\img{\rootImages/equ1.png}{Modèle équivalent}{0.7}

\img{\rootImages/gate-9.png}{On applique une tension de -9V}{0.7}
\img{\rootImages/equ2.png}{Modèle équivalent}{0.7}

On applique maintenant un signal carré sur la broche Gate et on observe la tension $V_{DS}$.

Paramètres du Générateur Basse Fréquence sur LTSpice:

\begin{items}{blue}{\Bullet}
\item Tension crête-à-crête: 18V
\item Tension moyenne: 0V
\item Fréquence: 1Hz
\end{items}


\img{\rootImages/ltspice1.png}{Montage du transistor}{0.8}

Ainsi, d’un point de vue électrique, le transistor peut être assimilé à un interrupteur.\\
L’état du transistor dépend de la tension sur la broche Gate. Selon la documentation technique (Datasheet 2N7000) :


\begin{items}{blue}{\Bullet}
\item Lorsque $VGS<VGSth$ (avec $VGSth$ fournie par le constructeur), le transistor est bloquant et se comporte comme un interrupteur ouvert
\item Lorsque $VGS>VGSth$, le transistor se comporte comme un fil (la tension aux bornes de Drain et Source est considérée comme nulle).
\end{items}{

Remarque:

En étudiant la documentation technique, on constate que le transistor peut être assimilé à une résistance variable dont la valeur dépend de la tension appliquée sur la broche Gate.

Ci contre, la résistance équivalente entre Drain et Source (RDS) en fonction de la tension VGS(Datasheet 2N7002).

\img{\rootImages/vgsth.png}{Courant en fonction de $VGSth$}{0.8}

Pour une tension VGSth valant 9V, la résistance RDSvaut 2.5 $Ohm $ (lecture graphique).

Pour une tension $VGSth$ nulle, un courant de fuite ($ID_{SS}$) apparaît ce qui implique une résistivité très élevée du composant.

\img{\rootImages/dt1.png}{Courant en fonction de $VGSth$}{0.8}
\img{\rootImages/dt2.png}{Courant en fonction de $VGSth$}{0.8}

Il convient donc de protéger le transistor lorsque celui-ci est passant car sa mise en conduction imposerait un courant $\frac{Ve}{RDS} = \frac{14}{2.5} =5.6A$

La résistance R1 ($100K$) du cahier des charge est donc justifiée pour la protection du transistor.


On a donc expérimenté le bon fonctionnement du transistor en commutation avec les mêmes composants (mêmes valeurs) que la simulation :

%\img{\rootImages/graph1.png}{Courant en fonction de $VGSth$}{0.8}

Sur ce graphe, on remarque que la tension VDS ne peut prendre que deux valeurs : 0V ou Ve (ici, Ve=$14$V).


\subsubsection{On remplace le transistor par un interrupteur ouvert:}


$$V_+=V_e$$ (la tension $V_e$ est aux bornes de Drain et Source)

Or, étant donné la contre-réaction négative (fonctionnement linéaire), nous avons: 


\begin{align}
     V-=V+     &\Rightarrow V_sR_2R_3+R_2+VeR_3R_3+R_2=V_e\\
               &\Rightarrow V_sR_2R_3+R_2=V_eR_2R_3+R_2
\end{align}

En posant $R_3=R_2$, on obtient:

     $$  Vs=Ve $$


\subsubsection{On remplace le transistor par un interrupteur fermé:}

En posant R3=R2, on obtient:

$$ Vs= -Ve $$


\section{Etude du bloc 2}

\img{\rootImages/bloc2.png}{Bloc 2}{0.7}

Ce bloc comprend un montage de l’AOP avec un condensateur dans la boucle de contre-réaction négative.\\

Le condensateur est un composant passif permettant de stocker des charges électriques à ses bornes.\\
De ce fait, ce composant intervient dans les systèmes ou le temps fait partie des équations car le condensateur se charge théoriquement au bout de $5\tau$ , $\tau$ représente la constante de temps valant $RC$ avec $C$ la capacité du condensateur exprimée en farad F et $R$ la résistance en $\Omega$\\

On calcule l’expression de la tension $V_{s}$ en fonction de $V_e$:

On sait que $I_{condensateur}+I_{R4}=0 $ car l’impédance d’entrée de l’AOP est considérée comme infinie et $V- = 0V = V+$ car le montage est en mode linéaire (contre-réaction négative).

Soit $I_c(t)$ le courant (en ampère [A]) circulant dans le condensateur.


$$I_c(t)=C \cdot dV_c(t)dt $$


avec $V_c$ la tension aux bornes du condensateur.
		
\begin{align}
     I_c+I_{R4}=0        &\Rightarrow I_{R4}= -I_c\\
                         &\Rightarrow V_e \cdot R_4 = -CdV_cdt 
\end{align}

On obtient donc la tension de sortie du montage intégrateur:

$$ V_s(t)=\frac{-1}{R_4\cdot C} \cdot V_e \cdot t $$


Afin d’étudier l'intérêt de ce type de montage, on détermine l’expression de la pente du signal suivant, simulé avec le schéma ci contre :


Simulation du signal de sortie : 




Par calcul, on retrouve une pente a (coefficient directeur) :

$$ a=\frac{-V_e}{R_4C}= 6080 $$

Par lecture graphique, on retrouve une pente a (coefficient directeur) :

$$ a=U_t=-6048 $$

On constate que le signal est décroissant jusqu’à atteindre la tension de saturation. \\
Ceci est tout à fait cohérent dans la mesure ou cet AOP intègre une valeur constante avec un coefficient négatif.\\
 La tension de sortie décroît dans le temps mais la tension d'alimentation n’étant pas infinie, 
 la tension de sortie ne pourra pas dépasser la tension d’alimentation, ou du moins celle de saturation.\\
  La tension de sortie se maintient donc à Vsat- pour une tension d’entrée positive.\\


Calculons la pente avec $V_e= -1V$

Par le calcul: 

$$ a=\frac{-V_e}{R_4C}= 3030$$

Par lecture graphique:

$$ a=U_t=3024$$

On constate que la pente du signal varie en fonction de la tension d’entrée $V_e$.

On souhaite obtenir un signal triangulaire centré en 0V et d’amplitude théorique de 4V:
(Vsmax-Vsmin=28V en supposant que les amplificateurs sont parfaits):

Afin de centrer le signal triangulaire, nous devons imposer $Vs= Vsat$ afin que le signal de sortie (signal triangulaire) bascule lorsque ce dernier est à son maximum en terme d’amplitude.

Pour un signal triangulaire de fréquence $f=500Hz$et de période $T=1f$ en sortie, cela veut dire que la tension croît ou décroît de $Vsat$ sur une période $t$ valant $\frac{T}{4}$.

Pour l’étude de ce montage, on considérera l’AOP comme étant non-idéal, c’est à dire que $Vsat+<Vcc+$ et $Vsat-<Vcc$

Nous prendrons $Vsat+=12.5V$ et $Vsat-=-12.5V$ (valeurs simulées par LTSpice).

Le signal appliqué sera un signal carré de fréquence $f=500Hz$ car les variations des pentes du signal triangulaire 
doivent avoir lieu lorsque $Ve$ change de signe. Cela veut dire que $f_{entree}=f_{sortie}$.

   $$  Vs(t)=-1R4CVet $$ 
 $$R4=-VeT4VsC $$    

avec Ve=1V, C=10nF, Vs=-12V et T=1500=2ms soit 2.010-3s

D'où :$ R_4=-10.002412.510-8=4000 \Omega$
 
On simule le circuit avec $R_4=4000 \Omega$



Ainsi, un signal carré d’amplitude $1V$ et de valeur moyenne nulle permet d’obtenir un signal triangulaire d'amplitude $12.5V$ et de fréquence $f=500 Hz$ avec une résistance de $4000$ et un condensateur de $10nF$
\section{Etude du bloc 3}


Dans cette configuration (contre-réaction positive et signal sur l’entrée inverseuse), il s’agit d’un comparateur double seuils inverseur.

On déterminer les expressions des seuils de basculement.
Dans un premier temps, on prendra :
 $Vsat+=12.5V$ et $Vsat- =-12.5V$  (valeurs simulées de l’étude n°2)

1er cas : >0Vs=Vsat+

E+=Ve
E-=VsR5R5+R6
=E+-E-
>0VsR5R5+R6<Ve
VsR5<Ve(R5+R6)
Ve>Vsat+R5R5+R6

2nd cas : <0Vs=Vsat-

<0VsR5R5+R6>Ve
VsR5>Ve(R5+R6)
Ve<Vsat-R5R5+R6

Ainsi, les deux expressions des seuils de basculement valent: 

$Ve>Vsat+R5R5+R6$      et        $Ve<Vsat-R5R5+R6$

On calcule ces valeurs de basculement (seuils) avc $R5=10k$ et $R6=8k$

$Ve1=12.51000010000+8000=6.67V$

$Ve2=-12.5100001000+8000=-6.67V$

Par lecture graphique:



$Ve1=6.88V$   et  $Ve2=-6.94V$


Les valeurs simulées et calculées sont cohérentes par rapport aux calculs.\\

\section{Explication du fonctionnement global}

\subsection{Interactions avec les blocs fonctionnels}

En faisant une étude temporelle du signal triangulaire, on peut décomposer le signal en différentes phases, en supposant qu’à $t=0$, la tension de sortie est nulle 
(condensateur déchargé):

\begin{items}{blue}{\Bullet}
\item le signal croît avec un coefficient directeur  positif
\item lorsque la tension dépasse 6V, le coefficient directeur devient négatif et garde la même valeur absolue
\item le signal décroit avec un coefficient directeur   négatif
\item lorsque le signal devient inférieur à -6V, le coefficient directeur du signal change de signe
\end{items}
Ainsi, on voit bien que le montage intégrateur va imposer la valeur absolue du coefficient. Lorsque la tension en entrée sera négative, le coefficient sera positif et inversement pour une tension d’entrée positive.
Le montage 3 (comparateur) va donc se charger de changer le signe de ce coefficient par l’intermédiaire du transistor (étude bloc 1) et l’amplitude du signal de sortie dépendra de la valeur de basculement du montage 3.

On calcule donc les valeurs des résistances manquantes:


La tension d’entrée Ve doit prendre deux valeurs : $Ve$ et $-Ve$

Or avec une résistance $R2$ identique à $R3$, on a:
$Vs=Ve$ ou $Vs=-Ve$

En fixant arbitrairement $R2$ à $1k$(valeur minimale), $R3=1k$.

Ensuite, pour $R4$, nous voulons que la tension en sortie du montage intégrateur soit de $6V$ lorsque la période du signal vaut T4s.
Nous savons que $R4=-VeT4VsC$ avec $Ve = 1.02V$, $T = 1f=1466$, $C = 15 nF$ et $Vs = - 6V$
d'où : $R4=-1.0214f-61510-9=-1.0214466-61510-9 = R4=6080$

Pour $R5$, nous allons supposer que $Vsat+=Vsat$-

Calculons la valeur de la résistance $R6$ en prenant $R6=10k$, $Ve=6Vet$ $Vsat+=12.5V$

R5=VeR6(Vsat+)-Ve
R5=61000012.5-6
R5=9231

\section{Expérimentation du fonctionnement global}

Une fois tous les blocs indépendants fonctionnels, on réalise le schéma suivant:



La tension en entrée du circuit est réalisée avec un potentiomètre relié alimenté en $+14V$ et relié à la masse.

La résistance $R4$ est formée d’une résistance $R4.1$ de $5.6k$et d’une résistance $R4.2$ de $470$, ce qui fait une résistance $R4$ théorique de $6.07k$

La résistance $R5$ est formée par une résistance $R5.1$ valant $6.8k$ et d’une résistance $R5.2$ valant $2.2k$, ce qui fait une $R5$ théorique de$9k$

Cependant, lors de ce test, nous avons constaté que la tension d’entrée n’était pas constante dans le temps. Le principe du $VCO$ impose une tension stable.

On ajoute donc un suiveur en entrée afin de faire une adaptation d’impédance : le signal d’entrée n’est plus perturbé car l’impédance d’entrée du suiveur est considérée comme infinie.









On obtient donc le circuit d’entrée suivant :




Simulation par LTSpice :


\begin{items}{blue}{\Bullet}
\item Tension max : 6.07V
\item Tension min : -6.08V
\item Fréquence : 460 Hz (lecture graphique)
\item Fréquence théorique : 466 Hz
\end{items}

Mesure réalisée avec un oscilloscope :


\begin{items}{blue}{\Bullet}
\item Note jouée : LA\# (fréquence théorique : 466 Hz)
\item Fréquence réelle : 498.5 Hz
\item Tension max : 6.24V
\item Tension minimal : -5.68V
\end{items}

On détermine la fréquence en sortie du système avec une tension Ve d’entrée:

Par simulation (Ve=1.02V)



Fréquence simulation : $460 Hz$


$Vs(t)=-1VeR4Ct$  

On sait qu’à $t=T4$, la tension de sortie vaut $6V$ et que $T=1f$

f(Ve)=-1VeVsR4C4


Ve(f)=VsR44Cf-1

Pour R4=6080, C=15 nF, Ve=1.02Vet Vs=-6V

On obtient $f=466 Hz$, ce qui correspond parfaitement au cahier des charges.
Cependant, ces calculs ne sont que théoriques.\chapter{Conclusion}

Avec les différentes mesures réalisées, on constate que le cahier des charges est globalement rempli.\\
En effet, la fréquence en sortie du montage est proportionnelle à la tension en entrée. En revanche, le signal n’est pas totalement centré en 0V (Vsat+ Vsat-). \\
Malgré tout, le signal de sortie est triangulaire et la tension crête-à-crête est proche de 12V.\\\chapter{Quelques pistes d’améliorations}
\section{Ajustement de la fréquence du signal}

Par relevés sur l’oscilloscope, nous pouvons constater que la fréquence en sortie n’est pas la fréquence théorique. \\

Ici, ci contre, nous avons joué un LA\# (octave 1).\\
La fréquence théorique pour cette note est de $466 Hz$ et sur l’oscilloscope, nous relevons $497 Hz$. Il y a un écart de $32 Hz$. \\


Ces facteurs d’écarts sont nombreux mais nous pouvons essayer d’en éliminer, ou du moins les réduire. \\

Tout d’abord, nous avons mesuré la valeur réelle du condensateur \\
Ne pouvant pas mesurer la valeur du condensateur en se basant sur la constante de charge $RC$ avec nos appareils de projet (résistances trop faibles, inférieures à 10 M), nous avons utilisé un appareil plus précis : au lieu des 15nF, nous avons relevés 14.46nF (4.6\% d’erreur).
De plus, nous avons mesuré précisément les valeurs de toutes les résistances du circuit.\\

Ainsi, la fréquence du signal dépend donc directement de la constante de temps RC du circuit intégrateur. \\
Plus cette constante sera élevée, plus le coefficient directeur du signal de l’intégrateur sera faible. \\
Or, un coefficient plus faible représente un signal de fréquence plus faible car pour atteindre les 6 volts d’amplitudes (seuil de basculement du circuit 3), 
le signal mettra plus de temps à atteindre cette valeur.\\


Afin de modifier la fréquence, nous allons modifier la valeur de la résistance $R4$ (plus facile que de mettre une capacité variable) en utilisant un potentiomètre couplé à la résistance $R4$ dont la valeur sera à modifier.\\



Notre contrainte est de concevoir une résistance équivalente $R4$ afin d’augmenter ou de diminuer la valeur théorique de la résistance $R4$. 
On a calculé que $R4=6080$ Ohms (théorie).
Cependant, avec une résistance $R4$ de $5990 Ohms$ ($5.53K+460$), la fréquence du signal ci dessus est supérieure de$ 31 Hz$ par rapport à la fréquence théorique.
Pour former une résistance équivalente similaire, légèrement plus grande, nous allons prendre une résistance de $5.6K$ et ajouter un potentiomètre de $1K$ afin de former une résistance allant jusqu’à 6.6KOhms.

Une fois le potentiomètre ajouté et valant $579$, nous obtenons les fréquences suivantes :\\

Pour obtenir ces valeurs, nous avons réalisé le schéma suivant :\\

Une fois le branchement effectué, nous avons mesuré la fréquence de sortie du système en fonction de la touche du piano :

On constate que la fréquence réelle est plus proche de la fréquence théorique avec le potentiomètre.













\subsection{Ajustement du cycle d’hystérésis}
Après les différents relevés, nous avons constaté que la fréquence était correcte avec l’ajout du potentiomètre en série avec R4. 
Cependant, le signal triangulaire n’est pas centré en $0V$ 
et $Vseuil1Vseuil2$.


Ici, nous avons joué un LA $440 Hz$. La fréquence mesurée est proche de la théorique avec le potentiomètre $POT1$ mais le signal n’est pas symétrique. 
Nous avons $Vmax=6.08V$ et $Vmin=-5.44V$





Afin de pallier à ce souci, nous pouvons utiliser deux méthodes pour compenser les dérives du circuit dues notamment au fait qu’en réalité, $Vsat+Vsat-$ 
(respectivement $13.8V$ et $13.2V$). \\
Tout d’abord, avec un potentiomètre, nous pouvons modifier la valeur de basculement afin d’obtenir un signal crête-à-crête de $12V$. \\

Nous pouvons injecter une tension à la base du pont diviseur formé par $R5$ et $R6$ afin de recentrer le cycle d’hystérésis\\

En observant l’équation du seuil de basculement, nous voyons clairement que plus $R5$ augmente, plus l'écart entre les deux tensions de seuils sera important.
Nous allons former une résistance $R5$ équivalente plus précise.
Nous avons mesuré les tensions $Vsat+$ et $Vsat-$réelles afin de tenir compte de cette différence. 
Pour être plus précis, nous allons modifier la tension d’alimentation de l’AOP N°3 afin qu’en simulation, nous obtenions $Vsat+=13.8V$ et $Vsat-=-13.2V$
Ces deux valeurs ont été mesurée avec un voltmètre.
Sur LTSpice, la tension de saturation vaut toujours $Vcc-1.53$
Nous allons donc alimenter (en simulation) l’AOP en $+15.33$ et en $-14.73V$

Après calcul avec la résistance $R6$ de valeur exacte $(9.73k)$, la nouvelle résistance est  comprise entre $7.48k$ et $8.10k$ 
(calculs réalisés en tenant compte des deux valeurs de saturation différentes). \\

Nous prendrons une résistance de 6.8kcouplée à un potentiomètre de $1k$
Voici le schéma :

A l’aide de LTSpice, nous faisons varier le potentiomètre et avec un potentiomètre (monté en résistance variable) valant $1k$, nous obtenons un signal 
de valeur crête-à-crête de $12V$.\\


A l’avenir, il faudra donc augmenter légèrement $R5$ car le potentiomètre est en butée.\\
 De ce fait, il perd tout son intérêt en résistance variable.\\

Une fois que la tension crête-à-crête est de $6V$, nous allons ajouter une source de tension à la base du pont diviseur $R5/R6$.




Nous allons faire le montage suivant : 



Les résistances $R8$ et $R9$ forment un potentiomètre $POT3$. \\
En faisant varier le potentiomètre, nous décalons le cycle d'hystérésis, ce qui est le but recherché. \\

Dans cette configuration, le potentiomètre n’est pas monté en résistance variable mais bel et bien en source de tension variable.\\
Le suiveur est ajouté afin que le pont formé par le potentiomètre ne débite pas de courant ailleur que dans les deux résistance $R8$ et $R9$.

Considérons représentant le déplacement du potentiomètre POT (01)
En testant quelques valeurs pour , on constate que si =0.49 (R9=4.9k et R8=5.1k)


on obtient un cycle d”hystérésis centré en 0V, de valeur crête-à-crête de 12V et de fréquence f=445Hz(au lieu de 466Hz).
Ainsi, pour obtenir ce cycle, il faut injecter une tension valant -0.7V (Vsat-0.05)à la base du pont diviseur

Obtenir un signal parfait est très compliqué, c’est pourquoi, au final, en faisant certains compromis, nous pouvons néanmoins valider le schéma suivant :





Ainsi, à chaque calibration du système: 
\begin{items}{blue}{\Bullet}
\item on déplace le potentiomètre POT1 afin d’obtenir la fréquence désirée et en accord avec la tension d’entrée
\item on régle le potentiomètre POT1 afin d’obtenir un signal de tension crête-à-crête de 12 V
\item on recentre ensuite le cycle avec le potentiomètre POT3 simulé par les des deux résistances.
\end{items}\part{Enveloppe du synthétiseur}
\chapter{Introduction}

\section{Avant-propos}

Dans la partie précédente, nous avons réalisé un projet permettant la génération d’un signal triangulaire à fréquence variable, dépendant de la tension. \\

Ce système est appelé VCO, ce dernier permettant la création d’un son. \\

Nous allons générer une enveloppe pour le signal émis par le VCO.\\ 
Par ailleur, ceci pourra permettre l'amélioration du son obtenu en sortie. \\
Exceptées les composants numérique (monostable,décodeur), Les différente parties du projet devront être réalisé par des composants passifs c’est à dire 
résistance,bobine,condensateur
\chapter{Matériel}
\subsection{Liste du matériel}


Pour la réalisation du projet nous utiliserons les composants suivants:

\begin{items}{blue}{\Bullet}
    \item RIT : 78L05
    \item Décodeur :74HC138
    \item Switch : HEF4066B
    \item Multiplieur : AD633
    \item Inverseur : 74HC04
    \item Monostable : 74HC123
    \item AOP : T081
    \item Transistor : 2N7000
    \item Résistance : Série E24,  précision 5%,  ¼ de watt
    \item Potentiometre : 22 tour
    \item Condensateurs : non polarisé,max 63 V 
    \item Diode : 1N4818, chute de tension de 0.7V dans le sens passant [silicium]
\end{items}\chapter{Alimentation}
\section{Régulateur de Tension }


Le régulateur intégré de tension (RIT) est un régulateur linéaire permettant de baisser une tension d’alimentation à une valeur fixe.\\

La famille des composants HCT doit être alimentée en 5V [TTL]. Nous utiliserons un 78L05 qui fournit du 5V régulé. Le L « low power » indique que le composant peut être traversé par un courant de 100mA.\\
La tension d’entré concernant notre montage est de 15V, ce qui permet le bon fonctionnement du composant, le dataSheet indique « Ve>7V ».  \\

Le circuit global consommant du courant, nous ne pouvons pas utiliser de pont diviseur de tension.\\
 
Des appels de courant importants peuvent entraîner une chute de tension en sortie du régulateur. \\
Pour éviter cela nous insérons un condensateur de découplage, c’est à dire  en sortie du régulateur et relié à la masse. 
Le modèle équivalent de l’ensemble est un filtre passe bas.\\

Plus la valeur du condensateur est élevée,plus la tension de sortie sera stable.\\


 Figure 3.1 : Régulateur de tension 5V et son condensateur de découplage\chapter{Conclusion}

Lors de ce projet, nous avons été confrontés à un problème majeur : les faux contacts des composants lors des branchements sur la plaque LABDEC.\\

De plus, lors du branchement avec le module haut-parleur, nous avons dû rajouter un suiveur car les hauts-parleurs demandaient trop de courant, 
ce qui provoquait une chute de tension en sortie du montage intégrateur.\\

Avec les différentes mesures réalisées, on constate que le cahier des charges est globalement rempli.\\
En effet, la fréquence en sortie du montage est proportionnelle à la tension en entrée. En revanche, le signal n’est pas totalement centré en 0V (Vsat+ Vsat-). 
Malgré tout, le signal de sortie est triangulaire et la tension crête-à-crête est proche de 12V.\\




Voici le signal en sortie du suiveur :

 
\chapter{Quelques pistes d’améliorations}
\section{Ajustement de la fréquence du signal}

Par relevés sur l’oscilloscope, nous pouvons constater que la fréquence en sortie n’est pas la fréquence théorique. 


Ici, ci contre, nous avons joué un LA\# (octave 1)
La fréquence théorique pour cette note est de $466 Hz$ et sur l’oscilloscope, nous relevons 497 Hz. Il y a un écart de $32 Hz$.




Ces facteurs d’écarts sont nombreux mais nous pouvons essayer d’en éliminer, ou du moins les réduire. 

Tout d’abord, nous avons mesuré la valeur réelle du condensateur \\
Ne pouvant pas mesurer la valeur du condensateur en se basant sur la constante de charge RC avec nos appareils de projet (résistances trop faibles, inférieures à 10 M), nous avons utilisé un appareil plus précis : au lieu des 15nF, nous avons relevés 14.46nF (4.6\% d’erreur).
De plus, nous avons mesuré précisément les valeurs de toutes les résistances du circuit.\\

Ainsi, la fréquence du signal dépend donc directement de la constante de temps RC du circuit intégrateur. \\
Plus cette constante sera élevée, plus le coefficient directeur du signal de l’intégrateur sera faible.
Or, un coefficient plus faible représente un signal de fréquence plus faible car pour atteindre les 6 volts d’amplitudes (seuil de basculement du circuit 3), 
le signal mettra plus de temps à atteindre cette valeur.\\


Afin de modifier la fréquence, nous allons modifier la valeur de la résistance R4 (plus facile que de mettre une capacité variable) en utilisant un potentiomètre couplé à la résistance R4 dont la valeur sera à modifier.\\



Notre contrainte est de concevoir une résistance équivalente R4 afin d’augmenter ou de diminuer la valeur théorique de la résistance R4. 
On a calculé que R4=6080 Ohms (théorie).
Cependant, avec une résistance R4 de 5990 Ohms (5.53K+460), la fréquence du signal ci dessus est supérieur de 31 Hz par rapport à la fréquence théorique.
Pour former une résistance équivalente similaire, légèrement plus grande, nous allons prendre une résistance de 5.6K et ajouter un potentiomètre de 1K afin de former une résistance allant jusqu’à 6.6KOhms.

Une fois le potentiomètre ajouté et valant 579, nous obtenons les fréquences suivantes :\\

Pour obtenir ces valeurs, nous avons réalisé le schéma suivant :\\

Une fois le branchement effectué, nous avons mesuré la fréquence de sortie du système en fonction de la touche du piano :

On constate que la fréquence réelle est plus proche de la fréquence théorique avec le potentiomètre.













2 - Ajustement du cycle d’hystérésis
Après les différents relevés, nous avons constaté que la fréquence était correcte avec l’ajout du potentiomètre en série avec R4. Cependant, le signal triangulaire n’est pas centré en 0V 
et Vseuil1Vseuil2.


Ici, nous avons joué un LA 440 Hz. La fréquence mesurée est proche de la théorique avec le potentiomètre POT1 mais le signal n’est pas symétrique. Nous avons 
Vmax=6.08V et
Vmin=-5.44V











Afin de pallier à ce souci, nous pouvons utiliser deux méthodes pour compenser les dérives du circuit dues notamment au fait qu’en réalité, Vsat+Vsat- (respectivement 13.8V et 13.2V)
Tout d’abord, avec un potentiomètre, nous pouvons modifier la valeur de basculement afin d’obtenir un signal crête-à-crête de 12V.

Nous pouvons injecter une tension à la base du pont diviseur formé par R5 et R6 afin de recentrer le cycle d’hystérésis

En observant l’équation du seuil de basculement, nous voyons clairement que plus R5 augmente, plus l'écart entre les deux tensions de seuils sera important.
Nous allons former une résistance R5 équivalente plus précise.
Nous avons mesuré les tensions Vsat+ et Vsat-réelles afin de tenir compte de cette différence. 
Pour être plus précis, nous allons modifier la tension d’alimentation de l’AOP N°3 afin qu’en simulation, nous obtenions Vsat+=13.8Vet Vsat-=-13.2V
Ces deux valeurs ont été mesurée avec un voltmètre.
Sur LTSpice, la tension de saturation vaut toujours Vcc-1.53
Nous allons donc alimenter (en simulation) l’AOP en +15.33 et en -14.73V

Après calcul avec la résistance R6 de valeur exacte (9.73k), la nouvelle résistance est  comprise entre7.48k et 8.10k(calculs réalisés en tenant compte des deux valeurs de saturation différentes).
Nous prendrons une résistance de 6.8kcouplée à un potentiomètre de 1k
Voici le schéma :


A l’aide de LTSpice, nous faisons varier le potentiomètre et avec un potentiomètre (monté en résistance variable) valant 1k, nous obtenons un signal de valeur crête-à-crête de 12V.


A l’avenir, il faudra donc augmenter légèrement R5 car le potentiomètre est en butée. De ce fait, il perd tout son intérêt en résistance variable.

Une fois que la tension crête-à-crête est de 6V, nous allons ajouter une source de tension à la base du pont diviseur R5/R6.






Nous allons faire le montage suivant : 



Les résistances R8 et R9 forment un potentiomètre POT3. En faisant varier le potentiomètre, nous décalons le cycle d'hystérésis, ce qui est le but recherché.
Dans cette configuration, le potentiomètre n’est pas monté en résistance variable mais bel et bien en source de tension variable. Le suiveur est ajouté afin que le pont formé par le potentiomètre ne débite pas de courant ailleur que dans les deux résistance R8 et R9.
Considérons représentant le déplacement du potentiomètre POT (01)
En testant quelques valeurs pour , on constate que si =0.49 (R9=4.9k et R8=5.1k)
on obtient un cycle d”hystérésis centré en 0V, de valeur crête-à-crête de 12V et de fréquence f=445Hz(au lieu de 466Hz).
Ainsi, pour obtenir ce cycle, il faut injecter une tension valant -0.7V (Vsat-0.05)à la base du pont diviseur

Obtenir un signal parfait est très compliqué, c’est pourquoi, au final, en faisant certains compromis, nous pouvons néanmoins valider le schéma suivant :





Ainsi, à chaque calibration du système : 
on déplace le potentiomètre POT1 afin d’obtenir la fréquence désirée et en accord avec la tension d’entrée
on régle le potentiomètre POT1 afin d’obtenir un signal de tension crête-à-crête de 12 V
on recentre ensuite le cycle avec le potentiomètre POT3 simulé par les des deux résistances.\chapter{Configuration}

\section{UART}
Interruptions disponibles pour le niveau de réception FIFO atteint, niveau de transmission FIFO atteint, FIFO 
dépassement ou sous-débit, ralenti de l’émetteur, changement de détection de coupure du récepteur, cadrage 
erreur, erreur de parité, détection Delta CTS, et le bruit d’échantillon de récepteur détecté (parmi 
autres). 



\section{Choix de la fréquence d'horloge}

Il faut sélectionner le bloc fonctionnel dans le  \bold{functionnal block}
\img{\rootImages/select.png}{Choix de la fréquence d'horloge}{0.5}

\section{Localisation des horloges}

Aller dans \bold{ConfigTools > Clocks}

puis vérifier que vous êtes dans l'onglet \bold{Clock\_diagramm}


\img{\rootImages/clock_diagramm.png}{Onglet du diagramme d'horloge}{0.5}

Il faut chercher sur le diagramme le nom de l'horloge correspondante et faire un click-gauche dessus: 


\img{\rootImages/select_clock.png}{Selection de la clock}{0.7}


Dans le menu latéral droit, il faut cliquer sur None et sélectionner l'horloge 

\img{\rootImages/none.png}{Selection de l'horloge à rattacher}{0.7}


Il ne reste plus qu'à mettre à jour le code avec le bouton \bold{Update}


\img{\rootImages/upadte.png}{Mise à jour du code}{0.7}



\section{UART}

\img{\rootImages/fonctionnement\_uart.png}{Principe UART}{0.8}

\section{Code ANSI}
\img{\rootImages/code\_ANSI.png}{commande code ANSI}{0.3}



\begin{Cpp}{utilisation du code ANSI} 
void clear(USART_Type *base)
{
	unsigned char buf[]="\x1B[2J\x1B[17;1H";
	USART_WriteBlocking(base, buf, sizeof(buf) - 1);
}
\end{Cpp}

\section{IRQ Number}

\begin{Cpp}{utilisation du code ANSI} 
EnableIRQ(FLEXCOMM0_IRQn);
\end{Cpp}

Pour trouver le "tableau" des IRQ Number, il faut aller dans le fichier LPC55S69\_cm33\_core0.


\section{Mode interruption}

\subsection{Question 1}

\subsection{Question 2}


\subsection{Question 3}



la variable \bold{demoRingBuffer} est un tableau qui stocke les caractères reçus par interruption.
Lorsque le tableau est plein, les caractères suivants sont stockés au début du tableau.

La variable \bold{txIndex} permet de parcourir le tableau demoRingBuffer. 

\begin{Cpp}{Code FLEXCOMM0\_IRQHandler}

void FLEXCOMM0_IRQHandler(void) {
    uint8_t data;

    /* If new data arrived. */
    if ((kUSART_RxFifoNotEmptyFlag | kUSART_RxError) & USART_GetStatusFlags(USART0)) {
        data = USART_ReadByte(USART0);
        /* If ring buffer is not full, add data to ring buffer. */
        if (((rxIndex + 1) \% DEMO_RING_BUFFER_SIZE) != txIndex) {
            demoRingBuffer[rxIndex] = data;
            rxIndex++;
            rxIndex \%= DEMO_RING_BUFFER_SIZE;
        }
    }

}
\end{Cpp}



\subsection{Question 4}

demoRingBuffer[rxIndex] 

La variable txIndex représente l'index de la donnée à envoyer et rxIndex représente l'adresse de stockage de la donnée reçue.

Le mot clé volatile signifie que la variable est accessible depuis n'importe où (variable globale).


Identifier sur cet exemple le moyen qui a été utilisé pour synchroniser l'envoi de la donnée avec le code principal ?

On utilise une interruption pour sortir d'une boucle et continuer le code.

\begin{Cpp}{Code FLEXCOMM0\_IRQHandler}
USART_TransferCreateHandle(USART1, &g_usartHandle, USART_UserCallback, NULL);

...

while (!txFinished)
{
}
\end{Cpp}

\begin{Cpp}{Code FLEXCOMM0\_IRQHandler}
void USART_UserCallback(usart_handle_t *handle, status_t status, void *userData)
{
    userData = userData;
    if (kStatus_USART_TxIdle == status)
    {
        txFinished = true;
    }
    if (kStatus_USART_RxIdle == status)
    {
        rxFinished = true;
    }
}
\end{Cpp}\chapter{Les GPIOs}

 \section{Question 1}

\subsection{1.a}

Les broches LEDs 

\begin{itemize}

  \item LED\_RED : \outputPin{OUTPUT} sur la broche \genericPin{PB4}
  \item LED\_BLUE : \outputPin{OUTPUT} sur la broche \genericPin{PA9}
  \item LED\_GREEN : \outputPin{OUTPUT} sur la broche \genericPin{PC7}

\end{itemize}

Les broche des interrupteurs 

\begin{itemize}

  \item SW\_UP : \inputPin{INPUT} sur la broche \genericPin{PA4}
  \item SW\_DOWN : \inputPin{INPUT} sur la broche \genericPin{PB0}
  \item SW\_LEFT : \inputPin{INPUT} sur la broche \genericPin{PC1}
  \item SW\_RIGHT : \inputPin{INPUT} sur la broche \genericPin{PC0}
  \item SW\_CENTER : \inputPin{INPUT} sur la broche \genericPin{PB5}

\end{itemize}

\subsection{1.b}

Étant donné que les LEDs sont configurées en mode \bold{anode commune}, 
il convient de mettre un niveau logique bas pour activer ces dernières. \\

\img{\rootImages/leds.png}{Schéma des LEDs}{0.6}

Un niveau logique haut ne créé pas de différence de potentiel aux bornes des LEDs, de ce fait, aucun courant ne circule.
  
\subsection{1.c}

Lors d'un appui sur un interrupteur, le niveau logique associé est un niveau haut (3.3V). \\
Ce niveau se justifie par le type de montage. En effet, nous distinguons un montage en mode \bold{Pull-down} 
avec la résistance à la masse, ce qui implique que lors d'un appui, le courant circule dans
la résistance et toute la tension est au borne de la résistance.

\img{\rootImages/buttons.png}{Schéma des interrupteurs}{0.4}

\section{Question 2}

\subsection{2.a)}
\subsubsection*{Instruction}
L'adresse du registre \reg{RCC\_AHB1ENR} est \adr{0x40023830}

\subsubsection{Instruction}
L'instruction est la suivante : 

\begin{Cpp}{Affectation de l'horloge au port C}
#define PORT_C 2

RCC->AHB1ENR |= 1u << PORT_C;	
\end{Cpp}
\subsubsection{Justification de l'instruction}

Le registre \reg{RCC\_AHB1ENR} est de la forme suivante (Avec GPIOAEN le bit de poids faible): \\
\bitred{RESERVED} \bitgreen{GPIODEN} \bitgreen{GPIOCEN} \bitgreen{GPIOBEN} \bitgreen{GPIOAEN} \\
\bitblue{X}\bitblue{X}\bitblue{X}\bitblue{X}\bitblue{X}\bitblue{X}    \quad\quad \quad\quad \bitgreen{X}   \quad\quad \quad\quad          \bitgreen{X}    \quad\quad \quad\quad  \bitgreen{X}    \quad\quad \quad\quad\bitgreen{X}\\



Pour synchroniser l'horloge au port voulue, il suffit de mettre à 1 le bit du port C.

Pour cela, on commence par placer un '1' devant le bon bit, dans notre cas sur \bold{GPIOCEN}. On utilise l'opérateur de décalage à gauche.\\



$1 << 2$ revient à écrire \bin{100} puis en faisant ou \bold{OU} logique, cela permet de passer le bit à 1 si ce dernier est à 0 et de ne rien changer si il est déja à 1.


Le fait de faire un \bold{OU} permet de ne pas affecter les autres bits du registre, ce qui est souhaité. 

\subsubsection{Exemple}
Prenons en considération les 4 premiers bits de notre registre \reg{RCC\_AHB1ENR} et observons le résultat avec notre opération.\\
Ici, le port B et A sont déja activés (LSB).\\

\begin{tabular}{rl|l}
  Opérateur & Données & Information \\
\hline
    & 0011 & (RCC\_AHB1ENR tronqué)\\
   | & 0100 & ($1 << pin$)\\
   \hline
   = & 0111 & (RCC\_AHB1ENR tronqué)\\
  
\end{tabular} \\

On constate que le port C est bien relié à l'horloge et que les autres ports n'ont pas été affectés.

\subsection{2.b)}

\begin{itemize}

\item \reg{GPIOC\_MODER} : Ce registre permet de définir le mode de la broche. Il existe 4 modes.

  \begin{itemize}
    \item 00 : entrée  (mode par défaut)
    \item 01 : sortie
    \item 10 : broches alternatives (SPI, I2C, UART...)
    \item 11 : analogique
  \end{itemize}

 \item \reg{GPIOC\_PUPDR} : Ce registre permet de définir les éventulles résistances de rappel. Il existe 4 modes.

  \begin{itemize}
    \item 00 : aucune résistance de rappel
    \item 01 : mode Pull-Up
    \item 10 : mode Pull-Down
    \item 11 : mode réservé
  \end{itemize}

  Dans notre cas, les broches \inputPin{PC0} et \inputPin{PC1} sont en entrée \bold{sans résistance de pull-up/pull-down}.

\end{itemize}

\subsubsection{Instructions}

  \begin{Cpp}{Configurations des broches en entrée}

  int pc0 = 0;                //Broche associée au port
  int pc1 = 1;                //Broche associée au port

  int upDown = 0b00;   //Aucune résistance de rappel
  int input = 0b00     //broche en entrée

  //Etat de la broche
  GPIOC->MODER=GPIOC->MODER & ~(0b11 << (pc0*2) ) | input << (pc0*2); 
  GPIOC->MODER=GPIOC->MODER & ~(0b11 << (pc1*2) ) | input << (pc1*2);

  //pull-up/pull-down ?
  GPIOC->PUPDR=GPIOC->PUPDR & ~(0b11 << (pc0*2) ) | upDown << (pc0*2);
  GPIOC->PUPDR=GPIOC->PUPDR & ~(0b11 << (pc1*2) ) | upDown << (pc1*2);

\end{Cpp}

\subsubsection{Justification de l'instruction}

Le registre \reg{GPIOC\_MODER} est de la forme suivante, de manière tronquée (Avec MODER0 les 2 bits de poids les plus faibles): \\
\bitgreen{MODER3} \bitgreen{MODER2} \bitgreen{MODER1} \bitgreen{MODER0}\\
\quad\quad\quad\bitgreen{X}\bitgreen{X} \quad\quad\quad\bitgreen{X}\bitgreen{X}\quad\quad\quad\bitgreen{X}\bitgreen{X}    \quad\quad\bitgreen{X}\bitgreen{X}\\


Où \bitgreen{XX} represente l'état de la broche.\\

On souhaite mettre nos deux broches en entrée. Pour cela, on va utiliser l'opérateur de décalage pour sélectionner le duo de bits voulus (en fonction du numéro de la broche). \\

Cependant, on souhaite écraser la paire de bits car si on utilise la technique précédente, si on veut passer du mode  \bold{11} au mode \bold{00}\footnote{Ce mode ne sera pas utilisé mais cela permet de rendre l'opération générique pour tous les modes}, le bit de droite ne sera pas affecté.\\

On va donc réinitialiser les deux bits en faisant un complément de la valeur \bold{0x3} avec un décalage de \bold{$2$ fois le numéro de la broche.} \\


Ce coefficient est justifié par le fait que l'état de chaque broche est défini sur 2 bits. \\

Ensuite, il ne nous reste plus qu'à faire un \bold{ET} avec le registre pour ne pas modifier les autres broches puis faire un \bold{OU} avec notre mode souhaité. \\
Il est impératif que le mode soit exprimé en valeur hexadécimal.

\subsubsection{Exemple}
Prenons en considération les 8 premiers bits de poids faibles (4 premières broches du port) de notre registre \reg{GPIOC\_MODER} et observons le résultat avec notre opération.\\
On souhaite mettre la broche 4 au mode \bold{00} \\

\begin{tabular}{rl|l}
  Opérateur & Données & Information \\
\hline
    & 10110011 & (GPIOC\_MODER)\\
  \& & 00111111 & not(0b11 $<< 2*$ pin) \\
  \hline
  = & 00110011 &  \\
  | & 00000000 & (\bold{0b00}$<<2*$ pin)  \\
  \hline
   = & 00110011 & (GPIOC\_MODER)  \\
\end{tabular} \\

Le registre \reg{GPIOC\_PUPDR} est modifié de la même façon que \\
le registre \reg{GPIOC\_MODER}.


\subsection{2.c)}

\begin{itemize}

\item \reg{GPIOC\_MODER} : Voir question précédente

 \item \reg{GPIOC\_OTYPER} : Ce registre permet de définir le type de configuration de sortie. Il existe 2 modes.

  \begin{itemize}
    \item 0 : sortie push pull
    \item 1 : sortie à drain ouvert
  \end{itemize}

\item \reg{GPIOC\_OSPEEDR} : Ce registre permet de définir la vitesse des broches de sortie. Il existe 4 modes.

  \begin{itemize}
    \item 00 : Vitesse faible
    \item 01 : Vitesse intermédiaire
    \item 10 : Vitesse elevée
    \item 11 : Vitesse maximale
  \end{itemize}



\end{itemize}


\subsubsection{Instructions}

  \begin{Cpp}{Configurations des paramètres des sorties}
  int pc7 = 0;   //Broche associée au port
  
  int output_type = 0x0;   //sortie push-pull
  int speed = 0b01;        //vitesse medium
  int upDown = 0b00;       //Aucune résistance de rappel

  //Type de sortie
  GPIOC->OTYPER = GPIOC->OTYPER & ~(0b1 << pc7 ) | output_type << pc7; 
  //Vitesse
  GPIOC->OSPEED=GPIOC->OSPEED & ~(0b11 << (pc7*2) ) | speed << (pc7*2);
  //Pullup-down ?
  GPIOC->PUPDR=GPIOC->PUPDR & ~(0b11 << (pc7*2) ) | upDown << (pc7*2);

\end{Cpp}

\subsubsection{Présentation}

Les registres \reg{GPIOC\_OTYPE} et \reg{GPIOC\_SPEEDR} sont modifiés de la même façon que le registre \reg{GPIOC\_MODER}  si ce n'est que le registre \\
\reg{GPIOC\_OTYPER} ne nécéssite pas de décaler de deux fois le numéro de la broche car chaque information sur le type de sortie est stockée dans un bit et non deux.


\section{Question 3}

\subsection{a)}

\subsection{Instructions BSRR}

\begin{Cpp}{Instruction BSRR}
  
  #define pin 7 //Broche de la led sur le port C
  void green_led(uint32_t state) {

    GPIOC->BSRR = (state)?  1u << pin  :  0b1 <<(16u)<<pin;
    
  }
  

\end{Cpp}

\subsection{Justification de l'instruction BSRR}

Ce registre utilise les 16 premiers bits de poids les plus faibles pour mettre la sortie à 1 et 
les 16 bits suivants pour mettre la sortie à 0. \\

Lorsque \bold{state} est à 0, on veut donc écrire dans le bit BR7 qui force la broche à 0. 
D'ou le décalage de la valeur 1 de 16 bits puis du décalage de la pin. \\
On peut écrire la valeur brute dans le registre sans faire de masque dans la mesure où 
les changements d'états se font dès qu'un \bold{1} est présent. Au tour d'horloge suivant, les bits sont réinitialisés à 0.

Lorsque \bold{state} est à 1, on veut donc écrire dans le bit BS7 qui force la broche à 1. 
D'ou le décalage de la pin uniquement. \\



\subsection{Instructions ODR}

\begin{Cpp}{Instruction ODR}
  
  #define pin 7 //Broche de la led sur le port C
  void green_led(uint32_t state) {

    GPIOC->ODR = (state) ? GPIOC->ODR | (0b1 <<pin) : GPIOC->ODR & ~(0b1 <<pin);
     
  }
  

\end{Cpp}

\subsection{Justification de l'instruction ODR}

Ce registre utilise les 16 premiers bits de poids les plus faibles pour mettre la sortie à 1 ou 0.

Lorsque \bold{state} est à 1, on veut donc écrire dans le bit ODR7 qui force la broche à 1. D'ou le décalage de la valeur 1 de la pin puis le \bold{OU} pour ne pas affecter les autres sorties. \\


Lorsque \bold{state} est à 0, on veut donc écrire dans le bit ODR7 qui force la broche à 0. 

Il suffit de réinitialiser le bit en le mettant à 0 avec un décalage du port d'un bit complémenté et en faisant un \bold{ET}
avec la valeur actuelle du registre.

\subsection{b)}

\begin{Cpp}{Instruction input}

uint32_t input() {

    uint32_t output;

    output = GPIOC->IDR & (0b1 << 0);  //Right
    output |= _GPIOC->IDR & (0b1 << 1); //Left
    
    return output;
}

\end{Cpp}

\subsection{Justification de l'instruction input}

Le registre \reg{GPIOC->IDR} est accessible en lecture seule.

Il suffit de faire un \bold{ET} avec la valeur 1 décalé de la valeur de la broche et de mettre le résulat dans une variable.

On effectue la même opération si ce n'est que l'on fait un \bold{OU} avec la variable \bold{output} afin de ne pas écraser le bit lu précédemment.


\subsection{c) Code final}


\begin{Cpp}{Code final}

  #define LED 7
  
  void green_led(uint32_t state){

    GPIOC->BSRR = (state)? 0b1 << LED : 0b1 << (16u) << LED;

  }//End green_led

  #define SW_RIGHT (1u)
  #define SW_LEFT (1u<<1)

  uint32_t input(){

    uint32_t output;
    output = _GPIOC->IDR & (0b1)); //Right
    output |= _GPIOC->IDR & (0b1 << 1); //Left
  
    return output;

  }//End input

  int main(){
  
    _RCC->AHB1ENR |= RCC_AHB1ENR_GPIOCEN; //Clock

    //Settings LED
    //Output
    GPIOC->MODER=GPIOC->MODER & ~(0b11 << (LED*2) ) | 0b01 << (LED*2); 
    //Type of output
    GPIOC->OTYPER = GPIOC->OTYPER & ~(0b1 << LED ) | 0b0 << LED; 
    //Medium speed
    GPIOC->OSPEED=GPIOC->OSPEED & ~(0b11 << (LED*2) ) | 0b01 << (LED*2);
    //no Pullup-down
    GPIOC->PUPDR=GPIOC->PUPDR & ~(0b11 << (LED*2) ) | 0b00 << (LED*2);


    //Settings buttons SW_LEFT (PC1) and SW_RIGHT (PC0)
    //Right button
    GPIOC->MODER=GPIOC->MODER & ~(0b11 << (0*2) ) | 0b00 << (0*2); 
    GPIOC->PUPDR=GPIOC->PUPDR & ~(0b11 << (0*2) ) | 0b00 << (0*2);
    //Left buttons
    GPIOC->MODER=GPIOC->MODER & ~(0b11 << (1*2) ) | 0b00 << (1*2); 
    GPIOC->PUPDR=GPIOC->PUPDR & ~(0b11 << (1*2) ) | 0b00 << (1*2);
  
    while (true){
  
      uint32_t button_value = input();
  
      if(button_value & (1u)){
  
        green_led(0);
  
      }//End if
  
      else if(button_value & (1u << 1) ){
      
        green_led(1u);

      }//End else if

    }//End while

  return 0;
  }//End main

\end{Cpp}\part{Les Timers}
\chapter{Présentation}

L'objectif de ce laboratoire est d'abord de développer une API (fichiers timer.h/.c) afin de gérer les timers (TIM2 à TIM5) du microcontrôleur STM32F411.\\
Dans un deuxième temps, on utilisera ces fonctions afin de détecter un appui long ou un appui court sur un bouton poussoir. Si l'appui est court, la couleur de la led RGB sera changée ; si l'appui est long la led RGB sera allumée ou éteinte selon un fonctionnement de type "flip-flop". La durée de l'appui sera affichée, pour information, sur l'afficheur LCD de la carte d'extension Appshield. \\

Une partie de la préparation de ce laboratoire a été faite en TD. Les interruptions ne sont pas utilisées dans ce laboratoire. \\
Les API permettant d'utiliser la led RGB, le joystick et l'afficheur LCD sont fournies
précompilées. Consulter leur fichier d'en-tête *.h pour prendre connaissance des fonctions de l'API disponibles.\\
Les documentations relatives à l'utilisation du microcontrôleur STM32F411 sont disponibles
sur les postes de travail et en ligne (Moodle).



\chapter{API timer.h/.c}


\section{II.1 Fonctions d'attente}


\subsubsection{a) Fonction timer\_wait\_us}

\begin{Cpp}{Prototype de la fonction\func{timer\_wait\_ms}} 
int timer_wait_us(TIM_t *tmr, uint32_t us, OnTick cb);
\end{Cpp}

La fonction utilise le timer tmr pour générer une attente de us microsecondes. Le paramètre cb n'est pas utilisé ici car nous n'utilisons pas d'interruption.\\
La fonction retourne 0 à la fin d'une exécution sans erreur. \\

\begin{Cpp}{Définition de la fonction\func{timer\_wait\_us}} 
int timer_wait_us(TIM_t *tmr, uint32_t us, OnTick cb) 
{

tmr -> ARR = us;			//End of timer at us   Auto Reload Register
		
tmr->SR = 0; 														//No update interrupt flag
tmr->CR1 |=  (1u << ONE_PULSE_MODE) | (1u << AUTO_RELOAD_MODE);		//One pulse-mode and Auto-reload preload enable

timer_start(tmr);

while (tmr->CR1 & 0x1){};//Tant que le compteur n'a pas fini de compter jusqu'à ARR
return 0;
}
\end{Cpp}

Que fait-on ? Dans un premier temps on écrit la valeur de us dans le registre \reg{ARR} (Auto-Reload Register).\\
Cela veut dire que le compteur va aller de 0 à la valeur de notre registre \reg{ARR}.\\
Cela est vrai si on est en Upcounting mode, il existe 3 modes : \\

\begin{items}{red}{\Triangle}
\item Upcounting mode : comptage de 0 à ARR (par default)
\item Downcounting mode : comptage de ARR à 0 
\item Center-align mode : comptage de 0 à ARR puis de ARR à 1.
\end{items}

On indique ensuite que nous ne mettrons pas à jour les drapeaux d'interruptions. Pour cela, on écrit \bold{0} dans le registre \reg{SR}\\
Il faut ensuite dire au compteur qu'il ne va compter que une fois, pour cela on utilise le One-Pulse-Mode en changeant le bits numéro 3 du registre \reg{CR1} 

\img{\rootImages/OPM.png}{fonctionnement du mode OPM}{0.5}

On utilise l'Auto-Reload Preload Enable \bold{ARPE} mode qui permet au compteur de s'arrêter à la valeur indiquée dans le registre \reg{ARR}

\img{\rootImages/ARPE.png}{fonctionnement du mode ARPE}{0.5}

\begin{Cpp}{Paramétrage du registre \reg{CR1}} 

#define ONE_PULSE_MODE 0x3 //One Pulse Mode in CR1
#define AUTO_RELOAD_MODE 0x7 //ARPE
//...
tmr->CR1 |=  (1u << ONE_PULSE_MODE) | (1u << AUTO_RELOAD_MODE);		//One pulse-mode and Auto-reload preload enable
\end{Cpp}

Le registre \reg{CR1} (Control Register) est le registre qui permet de paramétrer le compteur, il contient notamment le bit One Pulse Mode, le bit Auto Reload et le bit \bold{CEN}.\\
Ce bit permet de lancer le comptage et de savoir si le comptage est terminé (valeur de \reg{ARR} atteinte)

\img{\rootImages/tableauCR1.png}{éléments du registre CR1}{0.5}






\newpage
\subsubsection{Registre PSC}

\img{\rootImages/PSC.png}{Fonctionnement du registre PSC}{0.5}

La valeur de notre horloge est de 84MHz, mais étant donné que la valeur de notre prescalaire est codée sur 16 bits, il peut prendre une valeur allant de 0 à 65535 (2**16 possibilités). 
84MHz correspond à une période de 11,9ns. \\On cherche à mettre en entrée de notre compteur principal une période de 1 microseconde\\
Le compteur va donc réagir toutes les microsecondes.\\

Notre période d'horloge peut donc atteindre au maximum une valeur de 78ms. En effet, on divise notre fréquence d'horloge par 65535. 
On obtient la fréquence min que l'on a pour notre compteur, soit 65535/84*10**6 = 78ms.
On se rend donc compte de la limite de notre prescalaire.

La valeur de notre préscalaire vaut : 

\begin{equation}
PSC = TCK\_CNT*FCK\_PSC-1
\end{equation}

En choisissant une base de temps de 1 $\mu s$, on obtient un préscalaire valant 83.


\newpage
\subsubsection{b) Fonction timer\_wait\_ms}
\begin{Cpp}{Prototype de la fonction\func{timer\_wait\_ms}} 
int timer_wait_ms(TIM_t *tmr, uint32_t ms, OnTick cb);
\end{Cpp}

La fonction utilise le timer tmr pour générer une attente de ms millisecondes. Le paramètre cb n'est pas utilisé ici car il n'y a pas d'interruption. La fonction retourne 0 à la fin d'une exécution sans erreur.


Pour que le timer attende en ms, nous utilisons une boucle for qui va répéter ms fois la fonction \func{timer\_wait\_us} basée sur une attente de 1000 $\mu s$ \\


\begin{Cpp}{Définition de la fonction\func{timer\_wait\_us}} 
int timer_wait_ms(TIM_t *tmr, uint32_t ms, OnTick cb) 
{
		for (uint32_t i = 0; i < ms; i++)
		{
			timer_wait_us(tmr, 1000, NULL);
		}//End for
	    return 0;
}
\end{Cpp}





\newpage
\subsection{II.2 Tests : MAIN1}

\begin{Cpp}{Code main1} 
#define wait_us           1000*1000   //us

int main()
{    
    leds_init();
    leds(0);
    timer_count_init(_TIM2,1);//timebase of 1 micro-seconde
    while(1)
    {
        red_led(1);
        timer_wait_ms(_TIM2, 1000, NULL);
        red_led(0);
        timer_wait_ms(_TIM2, 1000, NULL);
    }        
}   
\end{Cpp}

Le MAIN1 allume la led rouge pendant 1s, l'éteint pendant 1s et ce de manière périodique.


\newpage
\subsection{II.3 Autres fonctions}
\subsubsection{a) Fonction timer\_count\_init}
\begin{Cpp}{Prototype de la fonction\func{timer\_count\_init}} 
int timer_count_init(TIM_t *tmr, uint32_t timebase_us);
\end{Cpp}

\begin{Cpp}{Prototype de la fonction \func{timer\_count\_init}} 
int timer_count_init(TIM_t *tmr, uint32_t timebase_us)  {

		//select timer
		if(tmr==_TIM2) {
			_RCC->APB1ENR |= (1u<<0);	
		}//End if
		else if (tmr==_TIM3) {
			_RCC->APB1ENR |= (1u<<1);
		}//End else if
		else if (tmr==_TIM4) {
			_RCC->APB1ENR |= (1u<<2);
		}//End else if		
		else if (tmr==_TIM4) {
			_RCC->APB1ENR |= (1u<<3);
		}//End else if	
        
    	tmr->SR = 0; 														//No update interrupt flag
    	tmr->CR1 |=  (1u << ONE_PULSE_MODE) | (1u << AUTO_RELOAD_MODE);		//One pulse-mode and Auto-reload preload enable

		/*Computing timebase
		//PSC = TCK_CNT*FCK_PSC-1 = 1*10(^-6)*84*10(^6)-1 = 83
		*/
		tmr->PSC = (uint32_t) (timebase_us*0.000001*84000000)-1; 

		return 0;

}
\end{Cpp}

Dans un premier temps cette fonction relie le timer passé en argument(tmr) à la clock correspondante. Pour cela on utilise le registre \reg{APB1ENR} présenté si dessous.
\img{\rootImages/tableau_APB1ENR.png}{Espace du registre RCC->APB1ENR}{0.5}
\img{\rootImages/APB1ENR_fonctionnement.png}{Bits respectifs d'activation}{0.5}

Ensuite on met le registre \reg{SR} à zéro car il n'y a pas d'interruption.\\
Puis \reg{CR1} en One Pulse Mode et Auto Reload Mode.
(expliqué avant)


\newpage
\subsubsection{b) Fonction timer\_start}
\begin{Cpp}{Prototype de la fonction\func{timer\_start}} 
void timer_start(TIM_t *tmr);
\end{Cpp}

\begin{Cpp}{Définition de la fonction\func{timer\_start}} 
void timer_start(TIM_t *tmr) {
		//Re-initialize the counter and generates an update of the registers
		tmr->EGR = 0x1;		// reset
		//Enable timer
		tmr->CR1 |= 0x1; 
}
\end{Cpp}

Comme expliqué dans le commentaire il faut mettre à 1 le premier bit de \reg{EGR} pour remettre le compteur "à zéros" et commencer correctement grâce au bit 0 de \reg{CR1} : CEN (Counter ENnable) qui \bold{doit être mis à 1 pour démarrer le comptage}.

\img{\rootImages/tableau_EGR.png}{Emplacement EGR}{0.5}

\img{\rootImages/fonctionnement_EGR.png}{Bit UG}{0.5}

\img{\rootImages/CEN.png}{Activation du compteur}{0.5}


\subsubsection{c) Fonctiontimer\_stop}
\begin{Cpp}{prototype de la fonction \func{timer\_stop}} 
void timer_stop(TIM_t *tmr);
\end{Cpp}

\begin{Cpp}{Définition de la fonction \func{timer\_stop}} 
void timer_stop(TIM_t *tmr) {
    tmr->CR1 &= ~(0x1);  //we put the bit 0 at 0 
}
\end{Cpp}

On utilise un \&= \~{}(0x1) pour mettre le bit 0 à 0 et uniquement celui là.
\~{}(0x1) donne (0x111..1110)\\





\subsubsection{d) Fonction read\_timer}
\begin{Cpp}{Prototype de la fonction\func{read\_timer}} 
uint32_t read_timer(TIM_t *tmr);
\end{Cpp}

\begin{Cpp}{Définition de la fonction\func{read\_timer}} 
uint32_t read_timer(TIM_t *tmr) {

	return tmr->CNT ;	//current value
}
\end{Cpp}

Le registre \reg{CTN} représente la valeur du compteur. On rappel qu'en fonction du timer utilisé, la capacité du compteur change (32bits ou 16bits).

\img{\rootImages/CNT.png}{registre CNT}{0.5}

\newpage
\subsection{II.4 : MAIN2}
\begin{Cpp}{Main 2} 
#define sampling_period 100         //us
#define timebase_us     10

int main()
{
    uint32_t delay = 0;
    
    sw_init();
    timer_count_init(_TIM3, timebase_us);
    timer_count_init(_TIM2, 1);
    lcd_reset();    
    
    while(1)
    {
        //TIM3 used for sampling button states
        timer_wait_us(_TIM3, sampling_period, NULL);
        if(sw_center())
        {
            //TIM2 used for delay measurement
            timer_start(_TIM2);
            while(sw_input() & SW_CENTER);
            timer_stop(_TIM2);
            delay = read_timer(_TIM2);
            cls();
            lcd_printf("duree appui : %d ms\r\n", delay/(1000));
        }
    }        
}
\end{Cpp}

Cette fonction nous indique combien de temps nous sommes restés appuyé sur la touche centrale du joystick.\\
Explication du code :
Si on appui sur la touche centrale du joystick, on lance le timer 2.\\
Tant que la touche centrale du joystick est appuyée, le timer 2 continue de s'incrémenter.\\
Une fois que l'appui est relaché, on arrête le timer 2.\\
On lit la valeur du timer 2 et on affiche sa valeur divisée par 1000 (car la fonction read\_timer retourne une valeur en microsecondes).\\ On obtient donc le temps que l'on est resté appuyé en millisecondes. 



\newpage
\section{III Programme complet : MAIN 3}
\begin{Cpp}{Main 3} 
#define sampling_period 100         //us
#define timebase_us     100
#define long_delay      1000        //ms

#define LONG_DELAY 1000
#define SHORT_DELAY 50


int main()
{
    uint32_t delay = 0;
    uint8_t color = 1;  //color from 1 to 7
    uint8_t leds_state = 1;

    
    leds_init();
    leds(color);
    sw_init();
    lcd_reset();
    
    //initialisation timer
    timer_count_init(_TIM3, timebase_us);
    timer_count_init(_TIM2, 1);
    
    while(1)
    {

        if(sw_center())
        {
            //TIM2 used for delay measurement
            timer_start(_TIM2);
            while(sw_input() & SW_CENTER);
            timer_stop(_TIM2);
            delay = read_timer(_TIM2);
            cls();
            lcd_printf("duree appui : %d ms\r\n", delay/(1000));

            if( (delay/1000)>LONG_DELAY) {
                leds_state= (leds_state) ? 0 : 1 ;
                if(leds_state) {
                    leds(color);
                }
                //set led
                else {
                    leds(0);
                }

            }//End if long_delay

            if( ((delay/1000)<LONG_DELAY) && ((delay/1000)>SHORT_DELAY)) {
                color = (color == 7) ? 1: color+1;
                if(leds_state) {
                    leds(color);
                }
                else {
                    leds(0);
                }
  
            }//End if long_delay
           lcd_printf("Couleur : %d", color);
        }
    }        
}
\end{Cpp}

Le MAIN3 sert à changer la couleur de la LED si on fait un appui court sur le joystick. Mais également à éteindre ou allumer cette même LED (en fonction de son état) si on fait un appui long.\\

Si on appui sur la touche centrale du joystick on déclenche le timer 2.\\
Tant que la touche est maintenu enfoncée, le timer 2 continu à s'incrémenter.
Une fois que l'on relache la touche, le timer 2 s'arrête.\\
On affiche le temps que l'on est resté appuyé.
Si ce délai est inférieur à LONG\_DELAY (qui est une variable que l'on a fixée) mais supérieur à SHORT\_DELAY, on change la couleur de la led.\\
Si on appui pendant plus de LONG\_DELAY ms, on inverse l'état de la LED.\part{Labo 3 - Les Interruptions}
\chapter{Présentation}

L'objectif de ce laboratoire est d'abord de développer une application utilisant les interruptions générées par un timer et par des boutons poussoirs. \\

L'API du timer est partiellement fournie sous forme pré-compilée, certaines fonctions sont à compléter.\\
Le bouton poussoir utilise les entrées d'interruptions extérieures (EXTI). \\

Une partie de la préparation de ce laboratoire a été
faite en TD. Les API permettant d'utiliser la led RGB, le joystick et l'afficheur LCD sont fournies précompilées. Consulter leur fichier d'en-tête *.h pour prendre connaissance des fonctions de l'API disponibles. \\

Les documentations relatives à l'utilisation du microcontrôleur STM32F411 sont disponibles sur les postes de travail et en ligne (Moodle).

\chapter{Interruptions générées par le timer}

\section{Génération d'une interruption périodique}

\subsection{a) io\_configure}


\begin{Cpp}{utilisation de \func{io\_configure}} 

#define IO_CFG_LED_RED  PIN_MODE_OUTPUT|PIN_OPT_OUTPUT_SPEED_MEDIUM|PIN_OPT_RESISTOR_NONE|PIN_OPT_OUTPUT_PUSHPULL

io_configure(_GPIOB,PIN_4,IO_CFG_LED_RED,NULL); //On initialise la led rouge
    
    
\end{Cpp}

\subsection{b) timer\_tick\_init}


\begin{Cpp}{utilisation de \func{timer\_tick\_init}} 
Les explciations détaillées sont dans le code source ci-dessous : 

int timer_tick_init(TIM_t *tmr, uint32_t tick_ms, OnTick cb)
{
	IRQn_t	 irqn;
	uint32_t irq_priority, clk;

	if (tmr == _TIM2) {
	
    callback2 = cb;     //Store callback function associated to TIMER2
		irqn = 28;          //Set IRQ Number from Table vector
		irq_priority = 35;  //Set IRQ priority level

		// enable timer clocking
    _RCC->APB1ENR |= 0x1; //Clock on
        
	} else if (tmr == _TIM3) {
	
	    //Indications are same as if(tmr==_TIM2)
	
		callback3 = cb;
		irqn = 29;
		irq_priority = 36;
		_RCC->APB1ENR |= (0x1<<1); //Clock on
		
	
	} else if (tmr == _TIM4) {
	
	    //Indications are same as if(tmr==_TIM2)
	    
		callback4 = cb;
		irqn = 30;
		irq_priority = 37;
		_RCC->APB1ENR |= (0x1<<2); //Clock on
	
	} else if (tmr == _TIM5) {
		
		//Indications are same as if(tmr==_TIM2)
		
		callback5 = cb;
		irqn = 50;
		irq_priority = 38;
		_RCC->APB1ENR |= (0x1<<3); //Clock on
	
	} else {
		return -1;
	}
	
	// clear pending interrupts
	tmr->SR &= ~0x1F;
	
	//Set mode
	tmr->CR1 |= (1u << 7);          //Auto-reload enable
	tmr->DIER |= 0x3;               //(...00011)
	
	// set prescaler 100us
	tmr->PSC = (uint32_t) (100*0.000001*84000000)-1; //100 micros secondes
	
	// set period
	timer_tick_period(tmr,tick_ms);
	
	if (cb) {
		NVIC_ClearPendingIRQ(irqn);  //remove interupt in waiting 
		NVIC_EnableIRQ(irqn);  			//Activate IRQ
		NVIC_SetPriority(irqn,irq_priority);  //set priority
	}
	
    return 0;
}

\end{Cpp}

Dans notre fonction \func{timer\_tick\_init}


\subsection{c) timer\_start}

\begin{Cpp}{utilisation de \func{timer\_start}} 
/* timer_start
 *   reset & enable counting
 */
void timer_start(TIM_t *tmr)
{
	// force update to reset counter and prescaler
	tmr->EGR = 0x1;		// reset
	
	// enable counting
	tmr->CR1 |= 0x1; 	
}
\end{Cpp}

Comme expliqué dans le commentaire il faut mettre à 1 le premier bit de \reg{EGR} pour remettre le compteur "à zéros" et commencer correctement grâce au bit 0 de \reg{CR1} : CEN (Counter ENnable) qui \bold{doit être mis à 1 pour démarrer le comptage}.\\

\subsection{d) timer\_tick\_period}

\begin{Cpp}{utilisation de \func{timer\_tick\_period}} 

int timer_tick_period(TIM_t *tmr, uint32_t tick_ms)
{
    // set period
	tmr -> ARR = tick_ms;//End of timer at us  
    
    // force update to reset counter and prescaler
	tmr -> EGR |= 0x1;
	tmr->PSC = (uint32_t) (100*0.000001*84000000)-1; //100 micros secondes
	return 1;
}

\end{Cpp}

On est obligé de redéfinir PSC car quand on effectue un reset, c'est à dire mettre le bit 0 de EGR à 1 le prescaler est aussi reset.

\newpage
\subsection{e) timer\_stop}

\begin{Cpp}{utilisation de \func{timer\_tick\_period}} 

/* timer_stop
 *   stop counting
 */
void timer_stop(TIM_t *tmr)
{
	// disable counting
	tmr->CR1 &= ~(0x1);
}

\end{Cpp}


On utilise un \&= \~{}(0x1) pour mettre le bit 0 à 0 et uniquement celui là.
\~{}(0x1) donne (0x111..1110)\\



\newpage



\section{Test}

\subsection{MAIN1}

\begin{Cpp}{MAIN1} 
#define MAIN1

#ifdef MAIN1

#define IO_CFG_LED_RED  PIN_MODE_OUTPUT|PIN_OPT_OUTPUT_SPEED_MEDIUM|PIN_OPT_RESISTOR_NONE|PIN_OPT_OUTPUT_PUSHPULL

#define BLINK_SPEED_BASE    1000

void tmr_cb()
{
    static uint32_t led_state = 0;
    led_state = !led_state;
	red_led(led_state);
}

int main()
{
    // Configure output LED_RED   --> PB4
	io_configure(_GPIOB,PIN_4,IO_CFG_LED_RED,NULL); //On initialise la led rouge
    red_led(0); // on reset la led

	timer_tick_init(_TIM2, BLINK_SPEED_BASE, tmr_cb);//On initialise le timer 2
	timer_start(_TIM2);//On commence 
	
	while(1){;}
    
	return 0;
}

#endif /* MAIN1 */
\end{Cpp}

On peut donc voir que la LED rouge clignote grâce aux interruptions car dans le main1, le bloc d'instruction \bold{while} est vide.



\chapter{Interruptions extérieures}


\section{Génération d'une interruption par appui sur un bouton poussoir}

\subsection{a) Appel io\_configure Led}

\begin{Cpp}{io\_configure} 
io_configure(_GPIOB,PIN_4,IO_CFG_LED_RED,NULL); //On initialise la led rouge
\end{Cpp}

\subsection{b) Appel io\_configure bouton}

\begin{Cpp}{\func{io\_configure} Bouton} 
io_configure(_GPIOB,PIN_5,PIN_MODE_INPUT,exti5_cb);
\end{Cpp}

\subsection{c) exti5\_cb}

\begin{Cpp}{\func{io\_configure} Bouton} 
void exti5_cb()
{
    static uint32_t timer_on = 0;
    timer_on = !timer_on;  //reverse state of timer on each call of exti5_cb function
    if(timer_on)
    {
        timer_stop(_TIM2); 
    }
    else
    {
        timer_start(_TIM2);
    }
}
\end{Cpp}

La génération d'une interruption par appui sur un bouton poussoir a été détaillé dans le TD3, nous ne mettrons donc que le code source détaillé.

\newpage
\subsection{MAIN2}

\begin{Cpp}{code MAIN2} 

int main()
{
    lcd_reset(); cls();
    // Configure output LED_RED   --> PB4
    io_configure(_GPIOB,PIN_4,IO_CFG_LED_RED,NULL); //On initialise la led rouge
    red_led(0);

    // Configure input SW_CENTER --> PB5, with callback
    io_configure(_GPIOB,PIN_5,PIN_MODE_INPUT,exti5_cb);

    
    //config timer _TIM2 
    timer_tick_init(_TIM2, BLINK_SPEED_BASE, tmr_cb);
    lcd_printf("program started"); 
    
    //_EXTI->IMR : Interrupt mask register
    //_EXTI->EMR : Event mask register
    //_EXTI->RTSR : Rising trigger Selection register Interruption sur front montant oui ou non
    //_EXTI->FTSR : Falling trigger selection register Interruption sur front descendant oui ou non

    // enable clock for SYSCFG, no need for EXTI (clock never switched off)
    _RCC->APB2ENR=_RCC->APB2ENR|(1<<14);
    
    // configure pin PB5 (4 pin config per EXTICR[] register, 4 bits per pin)
    //   PB5 --> EXTI5
    _SYSCFG->EXTICR[1]=((_SYSCFG->EXTICR[1])&~(0xF<<4))|(0x1<<4);
        
    // allow pin EXTI5 to send an IRQ
    _EXTI->IMR=_EXTI->IMR|(1<<5);
    
    // not a wakeup event
    _EXTI->EMR=_EXTI->EMR&~(0x1<<5);
    
    // Configure pin event IRQ on rising (RTSR)/falling (FTSR) edge (rising only here)
    _EXTI->RTSR=_EXTI->RTSR|(1<<5);
    _EXTI->FTSR=_EXTI->FTSR&~(0x1<<5);
    
    // reset any pending IRQ on PB5
    _EXTI->PR=(0x1<<5);
    
    /*************************** NVIC Config ******************************/
    //23  EXTI9_5 EXTI Line[9:5] interrupts 0x0000 009C
    // Vector Table ISR         : EXTI9_5_IRQHandler
    // IRQ Number (hard coded)  : EXTI9_5_IRQn = 23
    // Choose Priority          : 6
    
    // Set priority : 1 byte per NVIC IRQ input
    //EXTI9_5_IRQHandler(); // declare dans startup_stm32F411xe.s
    
    // Enable IRQ Input
    //core_cm0.h ligne 629
    NVIC_EnableIRQ(23);
    //core_cm4.h ligne 1698
    NVIC_SetPriority(23,6); 

    //code de test   
    while(1){;}    
}

\end{Cpp}

\section{Test}

\img{\rootImages/clock.png}{Horloge}{1}
\img{\rootImages/moder.png}{registre MODER}{1}
\img{\rootImages/pupd.png}{registre PUPDR}{1}
\img{\rootImages/sysconfig.png}{EXTICR}{01}
\img{\rootImages/imr.png}{registre IMR, EMR, RTSR et FTSR}{1}
\img{\rootImages/nvic2.png}{ICER, ISER et IP}{0.6}


\newpage
\subsection{MAIN3}

\begin{Cpp}{code MAIN3} 

#ifdef MAIN3

#define SAMPLING_PERIOD     100     //us                            



#define IO_CFG_CLASSIC_SW           PIN_MODE_INPUT|PIN_OPT_RESISTOR_NONE  

#define IO_CFG_SW_EXTI      PIN_MODE_INPUT|PIN_OPT_RESISTOR_NONE|PIN_OPT_IRQ_EDGE_RISE

#define BLINK_SPEED    100      //This variable refers to the incrementation used by the SW_UP and SW_DOWN buttons
#define NB_LED 3
volatile uint32_t blink_speed = 1000;  //variable used by timer_tick_period()
volatile uint32_t color = 4;  //On led red

static uint16_t led_color[NB_LED] = {4,2,1};  //001 or 010 or 100 values sent to leds() to turn-on each LED by each LED
volatile uint32_t index_led = 0; //index of led_color[] used to go from red to blue LED ...
volatile uint8_t ledState = 0; //led turn-on or turn-down


void tmr_cb()
{
    static uint32_t led_state = 0;
    led_state = !led_state;
	(led_state)?leds(led_color[index_led]):leds(0); //if the led must be turn-on we turn-on only ones, by using index_led.
}

//End blinking
void exti5_cb()
{
    static uint32_t timer_on = 0;  state counter
    timer_on = !timer_on;   //update counter state
    if(timer_on)
    {
        timer_stop(_TIM2);    //Stop timer
    }
    else
    {
        timer_start(_TIM2);   //Start timer
    }
}


void exti4_cb()
{
	if(blink_speed > BLINK_SPEED) //Avoid overrange
	{
		blink_speed -= BLINK_SPEED; //Remove period time
	}
	timer_tick_period(_TIM2,blink_speed); //Update tick period

}


void exti0_cb()
{
    blink_speed += BLINK_SPEED;         //add period time
	timer_tick_period(_TIM2,blink_speed);   //Update tick period

}

int main()
{
    lcd_reset(); cls();
    
    //We configure all leds
    leds_init();
    leds(0); //turn off each led
    
	// Configure input SW_CENTER --> PB5, with callback
	io_configure(_GPIOB,PIN_5,IO_CFG_SW_EXTI,exti5_cb);
    // Configure input SW_UP --> PA4, with callback
	io_configure(_GPIOA,PIN_4,IO_CFG_SW_EXTI,exti4_cb);
    // Configure input SW_DOWN --> PB0, with callback
	io_configure(_GPIOB,PIN_0,IO_CFG_SW_EXTI,exti0_cb);
    // Configure input SW_LEFT --> PC1, without callback
	io_configure(_GPIOC,PIN_1,IO_CFG_CLASSIC_SW,NULL);	
	// Configure input SW_RIGHT --> PC0, without callback
	io_configure(_GPIOC,PIN_0,IO_CFG_CLASSIC_SW,NULL);

    

    timer_tick_init(_TIM2, blink_speed, tmr_cb);  //call tmr_cb each blink_speed ms
	timer_start(_TIM2);                             //Start timer 

	while(1) {
	
        timer_wait_us(_TIM3, SAMPLING_PERIOD, NULL);
        
		if(sw_left()) {  //If left button is pushed

			if(index_led == 0) { //Avoid negative value
				index_led = NB_LED;
			}//End if
			index_led -= 1; //update index

			if(ledState) {  //If ledState == True
				leds(led_color[index_led]);
			}//End if
				
		}//End if sw_left

		if(sw_right()) {  //If right button is pushed

			index_led += 1; //Update index
			if(index_led == NB_LED) { //Avoid overrange index value [index in array can't be higher than LENGHT_MAX-1]
				index_led = 0;
			}//End if
				
			if(ledState) {       //If ledState == True
				leds(led_color[index_led]);
			}//End if
				
		}//End if sw_right

    }//End while    
}//End main

#endif /* MAIN3 */



\end{Cpp}\part{Les USARTS}
\chapter{Présentation}

L'objectif de cette section est de pouvoir communiquer par liaison série avec la maquette équipée d'un microcontrôleur STM32F411.\\
À cette fin, un terminal est utilisé sur le PC de développement pour gérer un des ports du PC. Il permettra de recevoir ou d'émettre des caractères depuis ou vers la maquette.\\

Sur la maquette, les signaux RxD et TxD de l'USART2 du microcontrôleur sont connectés au circuit STLINK, présent sur la carte NUCLEO, qui permet la connexion au PC de développement via une liaison USB. Cette liaison sera transparente pour l'utilisateur : seule la liaison série gérée par l'USART2 est étudiée. Aucun contrôle de flux ne sera pris en charge, seuls les signaux d'émission TxD et de réception RxD de caractères seront utilisés. \\

Les fonctions développées pour gérer une USART permettront de gérer les USART présentes dans
le microcontrôleur même si seule l'UART2 sera utilisée dans ce laboratoire. \\

Pour communiquer par liaison série avec la maquette, un terminal doit être ouvert sur le PC
de développement : Applications | Programmation | GtkTerm. \\
Lorsque la fenêtre de ce terminal est active, il est associé au clavier et à un port du PC. Avant de l'utiliser il est nécessaire de configurer le terminal : choix du port associé, format des trames utilisées, débit, ... S'assurer qu'un port série virtuel est disponible dans la liste des ports séries proposés par le terminal. Le sélectionner et le configurer pour avoir les mêmes spécifications que celles de l'USART.\\

\bold{Sélectionner le port ttyACM0}
\chapter{Fonctions de base}

\section{Émission et réception d'un caractère (coupleur géré par scrutation)}

\subsection{Définition de uart\_init}

Pour information, la présentation des registres et instructions utilisées ne tient pas compte des \bold{\#ifdef USE\_USARTX} pour éviter d'alourdir la présentation.\\
Cependant, le code finale de la fonction \func{uart\_init} comprendra les conditions.


\subsubsection{Activation de l'horloge}

\begin{Cpp}{Activation de l'horloge} 
//Activation de l'horloge sur USART1
_RCC->APB2ENR |= 1<<4;

//Activation de l'horloge sur USART2
_RCC->APB1ENR |= 1<<17;

//Activation de l'horloge sur USART6
_RCC->APB2ENR |= 1<<5;
\end{Cpp}

\img{\rootImages/clockUSART.png}{Registre APB1ENR}{0.6}

\img{\rootImages/usart16.png}{Registre APB2ENR}{0.6}


\subsubsection{Association des signaux}

\begin{Cpp}{Paramétrage du type de broche} 
#define USART_PIN_CONFIG (PIN_MODE_ALTFUNC | PIN_OPT_RESISTOR_NONE | PIN_OPT_AF7)
\end{Cpp}



On définit ici que ce sont des broches alternatives utilisée pour l'USART sans résistance de rappel.
\begin{Cpp}{\func{io\_configure}} 
//USART1
//Cette fonction ne pourra pas être appelée
io_configure(USART1_GPIO_PORT, USART1_GPIO_PINS, USART_PIN_CONFIG, NULL);

//USART2
io_configure(USART2_GPIO_PORT, USART2_GPIO_PINS, USART_PIN_CONFIG, NULL);
//USART_GPIO_PORT is PIN2 | PIN3

//USART6
//Cette fonction ne pourra pas être appelée
io_configure(USART6_GPIO_PORT, USART6_GPIO_PINS, USART_PIN_CONFIG, NULL);
\end{Cpp}


\subsubsection{Gestion du baudrate}

\begin{Cpp}{Paramétrage du baudrate}
//USART1
u->BRR = (sysclks.apb2_freq/baud);

//USART2
u->BRR = (sysclks.apb1_freq/baud);

//USART6
u->BRR = (sysclks.apb2_freq/baud);
\end{Cpp}

ici, chaque USART doit être paramétré avec la fréquence apb qui lui est propre.\\


\subsubsection{Activation de l'USART}

\begin{Cpp}{Activation de l'USART}
//Activation de l'USART
u->CR1 |=	(1 << 13);

//Activation de la transmission 
u->CR1 |=	( 1 << 3);
//Activation de la réception
u->CR1 |=	( 1 << 2);
\end{Cpp}

\img{\rootImages/13.png}{Registre CR, bit 13}{0.6}
\img{\rootImages/3.png}{Registre CR, bit 2}{0.6}
\img{\rootImages/2.png}{Registre CR, bit 3}{0.6}

\subsubsection{Configuration pour les interruptions}

Pour chaque USARt, nous allons préparer l'éventuelle utilisation de l'USART avec les interruptions sur RX.

\begin{Cpp}{Interruptions}
//USART1

usart1_cb = cb;     //On enregistre la fonction à appeler
irq_number = 37;    //Depuis la table des vecteurs
irq_priority = 44;  //Niveau de priorité

//USART2

usart2_cb = cb;
irq_number = 38;
irq_priority = 45;

//USART6

usart6_cb = cb;
irq_number = 71;
irq_priority = 78;

\end{Cpp}


Il ne reste plus qu'à autoriser les interruptions si \bold{cb} n'est pas null.

\begin{Cpp}{Autorisations d'interruptions}

if (cb) {
			
	u->CR1 |= USART_CR1_RXNEIE;

	NVIC_EnableIRQ(irq_number); //Active l'interruption
	NVIC_SetPriority(irq_number,irq_priority);
}//End if cb

\end{Cpp}

\subsection{Code uart\_init complet}

\begin{Cpp}{Code uart\_init complet}

int uart_init(USART_t *u, uint32_t baud, uint32_t mode, OnUartRx cb)
{
	IRQn_t	irq_number;
	uint32_t irq_priority;

	if (u == _USART1) {
#ifdef USE_USART1
		//Activation de l'horloge
		_RCC->APB2ENR |= 1<<4;
		io_configure(USART2_GPIO_PORT, USART2_GPIO_PINS, USART_PIN_CONFIG, NULL);
		u->BRR = (sysclks.apb2_freq/baud);
		//fonction d'interuption
		usart1_cb = cb;
		irq_number = 37;
		irq_priority = 44;
#else
	return -1;
#endif
	 } 
	 else if (u == _USART2) {
#ifdef USE_USART2
		//Activation de l'horloge
		_RCC->APB1ENR |= 1<<17;
		io_configure(USART2_GPIO_PORT, USART2_GPIO_PINS, USART_PIN_CONFIG, NULL);
		u->BRR = (sysclks.apb1_freq/baud);
		//fonction d'interuption
		usart2_cb = cb;
		irq_number = 38;
		irq_priority = 45;
#else
	return -1;
#endif

	} else if (u == _USART6) {
#ifdef USE_USART6
		//Activation de l'horloge
		// configure Tx/Rx pins
		_RCC->APB2ENR |= 1<<5;
		//io_configure(USART6_GPIO_PORT, USART2_GPIO_PINS, USART_PIN_CONFIG, NULL);
		u->BRR = (sysclks.apb2_freq/baud);
		//fonction d'interuption
		usart6_cb = cb;
		irq_number = 71;
		irq_priority = 78;
#else
	return -1;
#endif
	}
		//format des données 8/9bits
		u->CR1 |= ((mode & 0b1) << 12);
		//Bit de stop
		u->CR2 |= (((mode>>4) & 0b11) << 12); //move mode to left to get field
		//Parité
		u->CR1 |= (((mode>>8) & 0b111) << 8);
		//USART ENABLE
		u->CR1 |=	(1 << 13);
		//Transmitter Enable
		u->CR1 |=	( 1 << 3);
		//Receiver Enable
		u->CR1 |=	( 1 << 2);
 
	// Setup NVIC
	if (cb) {
			
		u->CR1 |= USART_CR1_RXNEIE;

		NVIC_EnableIRQ(irq_number); //Active l'interruption
		NVIC_SetPriority(irq_number,irq_priority);

	}
    return 1;
}

\end{Cpp}
	

\subsection{Définition de uart\_putc }
 
 \begin{Cpp}{Définition de la fonction \func{uart\_putc}}
 
void uart_putc(USART_t *u, char c)
{
	while (!(u->SR & (1<<6))) //on attend que le traitement du premier caractère
	{
		//Ne rien faire
	}
  	u->DR = c;
	while (!(u->SR & (1<<6))) //on attend que le traitement du premier caractère
	{
		//Ne rien faire
	}
}//End uart_putc
\end{Cpp}

Pour envoyer un caractère, il suffit de mettre un \bold{char} dans le registre \reg{DR}
\img{\rootImages/registre_DR.png}{Registre DR}{0.6}

\subsection{Définition de uart\_puts}

 \begin{Cpp}{Définition de la fonction \func{uart\_puts}}
void uart_puts(USART_t *u, char *s)
{
	while (!(u->SR & (1<<6))) //on attend que le traitement du premier caractère
	{
		//Ne rien faire
	}
    while (*s != 0)
    {
        u->DR = *s;  //On affecte au registre DR le contenu à l'adresse s
        s++;        //On applique l'arithmétique des pointeurs
		while (!(u->SR & (1<<6))) //on attend que le traitement du premier caractère
		{
			//Ne rien faire
		}
    }
}
\end{Cpp}

\subsection{Définition de uart\_getc}
\begin{Cpp}{Fonction getc()}
char uart_getc(USART_t *u) {

    //On attend que le bit 5 passe a 1 (donnée reçu)
	while(!(u->SR & (1<<5))){};
	return (char)u->DR;//la valeur est contenue dans le registre DR

}
\end{Cpp}

\img{\rootImages/registre_SR.png}{Registre SR}{0.6}
\img{\rootImages/registre_SR_Bit5.png}{Registre SR, bit 5}{0.6}

\section{Test de l'émission d'un caractère}

Pour vérifier l'émission d'un caractère sans interruption, nous allons tester le code du MAIN1 : 

\begin{Cpp}{Code MAIN1}
int main()
{
	uart_init(_USART2,115200,UART_8N1,NULL);//On initialise la communication à 115200 bauds, pas de bits de parité, 1 bit de stop.
	uart_puts(_USART2, "Entrez du texte ici : ");//On affiche une chaine de caractère sur le terminal GTkTerm

	uart_putc(_USART2, 'A');//On envoie le caractère 'A'
	uart_putc(_USART2, 'B');//On envoie le caractère 'B'
	uart_putc(_USART2, 'C');//On envoie le caractère 'C'
	
	uart_puts(_USART2,"\r\nC'est un message du STM32F411 :-)\r\n");

	uart_puts(_USART2, "Entrez du texte ici : ");

	while (1) {
		uart_putc(_USART2, uart_getc(_USART2));
	}
	//ici, on scrute tous les caractères entrant (du terminal vers la carte) et on les renvoie aussitôt sur le terminal, ce qui fait que cette boucle fait une recopie du clavier.

	return 1;
}
\end{Cpp}


\section{Réception d'un caractère par interruption}

Le code nécessaire à la configuration des interruptions par réception de caractère a été défini dans la fonction \func{uart\_init}.

\section{Test de la réception d'un caractère}


Pour vérifier l'émission d'un caractère avec interruption, nous allons tester le code du MAIN2 : 

\begin{Cpp}{Code MAIN2}
static void on_rx_cb(char c) //Fonction à appeler lors d'une réception d'un caractère.
{
	uart_putc(_USART2, c);//On renvoie le caractère du buffer vers le terminal.
}

int main()
{
	uart_init(_USART2, 115200, UART_8N1, on_rx_cb);
	//On définit que la réception d'un caractère provoque l'appel de la fonction on_rx_cb.

	uart_puts(_USART2, "Entrez du texte ici : "); //On affiche du texte

	while (1) ;

	return 1;
}
\end{Cpp}

A première vue, on peut penser que le code ne fait rien.\\
Or, à chaque appui sur une touche du clavier, la carte va recevoir une demande d'interruption par la broche \bold{RX} et va appeler la fonction\func{on\_rx\_cb.}. La recopie du clavier est donc transparente pour l'utilisateur.

\chapter{Gestion d'un terminal}

\section{Présentation}

Un terminal "VT100" prend en compte des séquences de caractères permettant de modifier certains de ses attributs.\\
On pourra, par exemple, effacer l'écran du terminal, positionner le curseur à un emplacement choisi, changer la couleur des caractères affichés, etc.\\
Les commandes VT100 commencent toutes par la séquence de caractères ESC + '[', soit la chaîne "\\x1b["

Il est possible de recevoir, selon la touche appuyée sur le clavier, plus d'un caractère hexadécimal.\\
Des caractères accentués ne faisant pas partie de la table ASCII (codage sur 7 bits) peuvent être obtenus par un codage sur plusieurs octets (UTF-8).\\
Dans ce cas, l'émission d'un caractère (lettre) accentué se traduit par plus d'un caractère hexadécimal à prendre en compte à la réception.\\
D'autres touches associées à des fonctions de contrôle, telles que "page up", flèches gauche/droite, etc, génèrent également des séquences de caractères hexadécimaux.\\
Dans tous les cas, pour interpréter correctement l'action sur le clavier, il est nécessaire de prendre en compte la séquence hexadécimale complète reçue.

\section{Tests}

\begin{Cpp}{Code MAIN3}
static void on_rx_cb(char c)
{
	char  s[34];				//Chaine de 34 caractère max
	num2str(s,c,16);			//Permet de prendre en compte la séquence hexadéciaml complète
	uart_puts(_USART2, " 0x");	//début de séquence
	uart_puts(_USART2, s);		//On envoie la séquence
}


int main()
{
	//Initialisation de la communication à 115200 bauds avec interruptions sur la broche RX.
	uart_init(_USART2,115200,UART_8N1,on_rx_cb);

	//On efface le terminal
	uart_puts(_USART2,"\x1B[2J\x1B[H");

	uart_puts(_USART2,"On affiche un message ici");

	// positionnement du curseur ligne 20, col 5
	uart_puts(_USART2,"\x1B[20;5H");

	// on écrit en couleur
	uart_puts(_USART2,"\x1B[31mA partir de maintenant, entrez du texte :\x1B[0m");

	while (1) ;

	return 1;
}
\end{Cpp}
\chapter{Fonction printf}

\section{Prise en compte d'un nombre variable d'arguments}

\begin{items}{black}{\Bullet}

\item void va\_start(va\_list ap, param) : la macro va\_start fait pointer ap
sur le premier argument variable fourni à la fonction. param est le nom du
dernier argument nommé

\item type va\_arg(va\_list ap, type) : la macro va\_arg renvoie le premier
argument variable et fait pointer ap sur l'argument suivant. type est le type de
l'argument qui va être lu. La macro va\_arg génère une expression de ce même
type
\item void va\_end(va\_list ap) : la macro va\_end remet tout à état initial avant
le retour à la fonction appelante.
\end{items}

\section{Codage de la fonction printf allégée}


Tout d'abord, on va créer des variables locales à la fonction.

\begin{Cpp}{Variables locales}
	char* tmp_string;		//Chaîne de caractère demandée
	int tmp_s_int;			//Entier signé
	unsigned int tmp_u_int; //Entier non signé
\end{Cpp}

\subsection{Les caractères}

\begin{Cpp}{Gestion des caractères}
	case 'c':
		ch = va_arg(ap, char);  	//On récupère le paramètre correspondant à "\%c" (caractère)
	    uart_putc(u,ch); 			//Envoie du caractère
		break;
\end{Cpp}


\subsection{Les chaînes de caractères}

\begin{Cpp}{Gestion des chaînes de caractères}
    case 's':
		tmp_string = va_arg(ap,char*);
		uart_puts(u,tmp_string); //On récupère le pointeur associé à la chaîne de caractère
		break;
\end{Cpp}

\subsection{Les entiers non-signés}

\begin{Cpp}{Gestion des entiers non-signés}
	case 'u':
		tmp_u_int = va_arg(ap,unsigned int);	//On récupère le paramètre corespondant à "\%u" (unsigned int)
		num2str(s,(unsigned int)tmp_u_int,10);	//on convertit le nombre en chaine de caractère base 10
					uart_puts(u,s);							//On envoie la chaine
					break;
\end{Cpp}

\subsection{Les entiers signés}

\begin{Cpp}{Gestion des entiers signés}
    case 'd':
	    tmp_s_int = va_arg(ap,int);
		if(tmp_s_int < 0) { //Si valeur négative
			uart_putc(u,'-'); 
			tmp_s_int = tmp_s_int *(-1);//Remet en valeur positive
		}//End if
		num2str(s,(unsigned int)tmp_s_int,10);	//on convertit le nombre en chaîne de caractère base 10
		uart_puts(u,s);						//On envoie la chaîne
		break;
\end{Cpp}

\subsection{Les caractères hexadécimaux}

\begin{Cpp}{Gestion des caractères hexadécimaux}
	case 'x':
	    tmp_u_int = va_arg(ap,unsigned int);	//On récupère le paramètre corespondant à "\%x" (hexa)
		num2str(s,(unsigned int)tmp_u_int,16);	//on convertit le nombre en chaine de caractère base 16
		uart_puts(u,s);							//On envoie la chaine
		break;
\end{Cpp}

\section{Code complet de la fonction uart\_printf}


\begin{Cpp}{Définition de uart\_printf}

	__gnuc_va_list ap;
	char          *p;
	char           ch;
	unsigned long  ul;
	char           s[34];

	char* tmp_string;		//Chaine de caractère demandée
	int tmp_s_int;			//Entier signé
	unsigned int tmp_u_int; //Entier non signé
	
	va_start(ap, fmt);
	while (*fmt != '\0') {
		if (*fmt =='%') {
			switch (*++fmt) {
				case '%':
					uart_putc(u,'%');
					break;
				case 'c':
					ch = va_arg(ap, char);  	//On récupère le paramètre corespondant à "%c" (caractère)
					uart_putc(u,ch); 			//Envoie du caractère
					break;
				case 's':
					tmp_string = va_arg(ap,char*);
					uart_puts(u,tmp_string); //On récupère le pointeur associé à la chaine de caractère
					break;
				case 'd':
					tmp_s_int = va_arg(ap,int);
					if(tmp_s_int < 0) { //Si valeur négative
						
						uart_putc(u,'-'); 
						tmp_s_int = tmp_s_int *(-1);//Remet en valeur positive
					}//End if
					num2str(s,(unsigned int)tmp_s_int,10);	//on convertit le nombre en chaine de caractère base 10
					uart_puts(u,s);						//On envoie la chaine
					break;
				case 'u':
					tmp_u_int = va_arg(ap,unsigned int);	//On récupère le paramètre corespondant à "%u" (unsigned int)
					num2str(s,(unsigned int)tmp_u_int,10);	//on convertit le nombre en chaine de caractère base 10
					uart_puts(u,s);							//On envoie la chaine
					break;
				case 'x':
					tmp_u_int = va_arg(ap,unsigned int);	//On récupère le paramètre corespondant à "%x" (hexa)
					num2str(s,(unsigned int)tmp_u_int,16);	//on convertit le nombre en chaine de caractère base 16
					uart_puts(u,s);							//On envoie la chaine
					break;
				default:
				    uart_putc(u, *fmt);
			}
		} else uart_putc(u, *fmt);
		fmt++;
	
	va_end(ap);
\end{Cpp}

\section{Tests}

Pour tester le code, nous allons exécuter le MAIN4.

\begin{Cpp}{Définition du MAIN4}

static void on_rx_cb(char c)
{
	char  s[34];
	num2str(s,c,16);
	uart_puts(_USART2, " 0x");
	uart_puts(_USART2, s);
}

int main()
{
	int a = 5, b = 8;

	uart_init(_USART2, 115200, UART_8N1, on_rx_cb);

	uart_puts(_USART2, "\x1B[2J\x1B[H");

	uart_printf(_USART2, "la somme de %d et %d est %d\n", a, b, a+b);
	uart_printf(_USART2, "\x1B[%u;%uHle pointeur _USART2 = 0x%x\n", 20,5,_USART2);

	while(1) {
	}

	return 0;
}
\end{Cpp}

Voici le résultat : 

\img{\rootImages/gtk.png}{Résultat du MAIN4}{0.6}\chapter{Introduction}
\section{Objectifs}


Ce projet vise à mettre en place une interface de supervision en langage \emph{Python}.\newline
Ainsi, une interface en Python sera réalisée pour un contrôle de l’API (Automate Programmable Industriel) à distance. \newline
Nous avons opté pour la réalisation de notre propre logiciel de supervision pour plusieurs raisons : \newline

\begin{enumerate}
\item Contrôle fin de la communication API-Ordinateur
\item Indépendance aux logiciels propriétaires (PC-Vue….) \newline
\end{enumerate} 

Cependant, nous devons être conscients que la place des éléments graphiques est plus complexe.

\section{Supports pédagogiques}

Ce projet vise à donner suite à l'expérimentation de la création d'une interface Python pour la supervision. \\
Le logiciel précédent, permettant de contrôler un vérin à distance, était basé sur la bibliothèque Python TKinter. \\
Le protocole de communication restera inchangé, seul le logiciel pour l'interface sera différent.

\chapter{Pré-requis}
\section{Logiciels}

Afin de bien débuter, il convient que quelques logiciels soient préalablement installés.
Il s'agit de : \newline


\begin{enumerate}
\item \textbf{Python} \newline
La version minimal requise est la 3.7 sous peine de mauvaises installations et compatibilités entre les logiciels. \newline
Le logiciel est disponible à l'adresse \url{https://www.python.org/downloads} \newline
\item \textbf{Bibliothèque Python Pip} \newline 
Pip est une bibliothèque permettant d'installer d'autres bibliothèques Python. Toutes les bibliothèques nécessaires au projet de supervision sont disponibles via Pip. \newline
La bibliothèque est disponible à l'adresse \url{https://pip.pypa.io/en/stable} \newline

Il est également possible d'installer pip via Anaconda (ouvrir un terminal ou console) :
\begin{lstlisting}
conda install pip
\end{lstlisting}

\item \textbf{Logiciel Unity Pro} \newline 
Unity Pro sera utilisé pour générer le grafcet de supervision. \newline 
\end{enumerate}

\chapter{Logiciels et outils}


L'interface graphique sera réalisée avec le logiciel QtDesigner, en complément de la bibliothèque Python PyQt5.
Le protocole de communication se basera sur la bibliothèque Python PyModBus.
L'API sera programmé avec le logiciel Unity-Pro

\section{PyQt5}

\subsection{Présentation}

Qt est une bibliothèque originellement développée pour le C++. Elle a pour vocation d'aider à développer des interfaces graphiques utilisateurs (GUI en anglais) et propose de nombreux outils pour manipuler des fichiers, des bases de données etc...\newline

Elle est distribuée sous deux versions : \newline
- l'une est commerciale et nécessite de payer un abonnement régulier\newline
- l'autre est distribuée sous licence LGPL (c'est cette version qui a été utilisée dans notre projet)
Les deux versions proposent les mêmes fonctionnalitées à version identique.\\

PyQt5 n'est autre qu'un portage de la bibliothèque Qt C++ dans sa version 5 sur Python.\newline
A noter que PyQt5 dispose lui aussi d'une version commerciale mais que nous avons utilisé la version distribuée sous licence GPL.

\subsection{Pourquoi ?}

Nous avons choisi Qt pour de nombreuses raisons :
\begin{enumerate}
    \item \colors{red}{\bold{Multi-plateforme}}\newline PyQt5 a l'énorme avantage d'être portable sur de très nombreuses plateformes. Un seul programme peut être utilisé sur mobile comme sur Windows ou Linux.\newline
    Par exemple, dans notre cas, nous avons programmé de manière indifférente sur Windows ou Linux pendant toute la durée du projet.
    
    \item \colors{red}{\bold{Polyvalence}}\newline Comme dit un peu plus haut, PyQt5 propose de nombreux outils permettant la gestion de base de données, de fichiers xml, d'interfaces graphiques, de programmes multi-thread et bien d'autres choses encore. Cette polyvalence permet d'éviter d'utiliser plusieurs bibliothèque différente. Dans ce cas, une seule bibliothèque permet de faire énormément de choses.
    
    \item \colors{red}{\bold{Licence}}\newline Nous l'avons aussi expliqué un peu plus haut, PyQt5 est disponible sous licence GPL.V3 ce qui permet de l'utiliser gratuitement (sous les conditions imposées par le licence GPLv3)
    
    \item \colors{red}{\bold{Expérience}}\newline Plusieurs membres du groupe ont déjà utilisés Qt à plusieurs reprises. Ainsi, même si nous utilisions la version Python, le temps d'accoutumance à cette version particulière était plus court que si nous avions dû apprendre à utiliser TKinter.
\end{enumerate}

\section{QtDesigner}

\subsection{Présentation}
QtDesigner est un logiciel pour créer des interfaces graphiques.\newline
L'interaction entre les différents éléments graphiques appelés "widgets" sera faite en langage Python. 
Un widget est un élément grapĥique comportant des propriétés telles qu'une couleur, une taille, etc. \newline \newline


QtDesigner permet donc de gagner en efficacité en terme de conception graphique. \\
Lorsque les éléments graphiques de base sont devenus insuffisants, nous avons développés nous même les élements graphiques (Vérin, moteur, etc)



\section{PyModBus}
\subsection{Présentation}
\lib{PyModBus} est une bibliothèque Python pour communiquer entre des périphériques avec le protocole ModBus analogue à celui de l'API.

\subsection{Améliorations et documentation}

Cependant, pour des questions de robustesse et de facilité, nous utiliserons un module (ENIBSupervision) que nous avons développé pour simplifier les communications entre l'API et l'ordinateur. \newline
Ce module utilise la bibliothèque \lib{PyModBus} en interne.
 Ainsi, toutes les fonctions d'écriture/lecture des données sont protégées des mauvaises manipulations de programmation. \newline
Un tutoriel de prise en main du module \lib{ENIBSupervision} est disponible en annexe.

\subsection{Installation}

Il est possible d'installer la bibliothèque \lib{Pymodbus} de deux manières : \newline

\subsubsection{Installation par pip}
La commande pour installer Pymodbus est la suivante :
\begin{lstlisting}
pip install pymodbus
\end{lstlisting}

Pour une installation sur les machines de l'ENIB, il est nécessaire de préciser le proxy pour l'installation. \newline 

La commande suivante est à saisir dans un terminal :
\begin{lstlisting}
pip install --proxy "http://proxy.enib" pymodbus
\end{lstlisting}

\subsubsection{Installation par Anaconda}
 Il est également possible d'installer Pymodbus avec Anaconda : 
\begin{lstlisting}
conda install -c auto pymodbus
\end{lstlisting}

La bibliothèque officielle ainsi que l'ensemble de sa documentation est disponible à l'adresse \url{https://pymodbus.readthedocs.io/en/latest/} \newline 

\section{Pyuic5}

\subsection{Présentation}

Une fois l'interface graphique est réalisée à l'aide de QtDesigner, il faut utiliser \bold{pyuic5} pour convertir le fichier \file{.ui} en fichier python exploitable.\newline

La commande pour transformer le fichier UI est la suivante (via un terminal/console) :
\begin{lstlisting}
pyuic5.py -x fichier_qtdesigner_entree.ui -o fichier_python_sortie.py
\end{lstlisting}

Vous n'aurez jamais besoin d'écrire à la main dans le fichier python généré par pyuic5. En effet, \textbf{ce fichier doit être re-généré à chaque fois que vous modifiez l'interface depuis QtDesigner}, si vous oubliez,  vous ne constaterez aucun changement.

\subsection{Améliorations}

Étant donné que le fait de régénérer le fichier .ui à chaque changement peut être pénible, nous avons rédigé un script python qui transforme tout les fichier QtDesigner présent dans un dossier en fichier python. \newline
Cette section sera abordée plus en détail par la suite.

\subsection{Installation}

La commande pour installer Pyuic5 est la suivante : \newline

\begin{lstlisting}
pip install pyqt5-tools
\end{lstlisting}
Il est possible d'installer la bibliothèque avec Anaconda : \newline
\begin{lstlisting}
conda install -c anaconda pyqt
\end{lstlisting}\chapter{Introduction}

\section{Présentation}

Ce tutoriel a pour but d'accompagner la mise en place du projet de supervision en Python avec le logiciel QtDesigner et les outils de Pyqt5. Ce document explique les bases du logiciel afin de faciliter sa compréhension.

\section{Pré-requis}

Ce tutoriel a été rédigé avec la version 5.14 de QtDesigner. \newline

\chapter{Prise en main de QtDesigner}

\section{Nouveau projet}

Tout d'abord, il faut ouvrir le logiciel QtDesigner, disponible après une recherche dans la barre de menu.

\img{\rootImages/designer_context_search_software.png}{Ouverture du logiciel}{0.4}

La commande suivante permet également de lancer QtDesigner via une console : 
\begin{lstlisting}
designer
\end{lstlisting}
Au démarrage, une fenêtre apparaît. Sélectionnez \bold{'MainWindow'} puis 'Créer'

\img{\rootImages/designer_context_new_window.png}{Fenêtre au démarrage}{0.4}


Il s'agit de déterminer le type de fenêtre que nous souhaitons implémenter dans le logiciel. Dans notre cas, nous souhaitons créer une fenêtre principale. Cet objet possède de base certaines propriétés pratiques comme un menu en en-tête de fenêtre, et beaucoup d'autres choses qui pourront nous servir pour la suite.

\img{\rootImages/designer_context_qt_designer_menu.png}{Menu possible avec une fenêtre 'MainWindow'}{0.8}
\bold{
A ce moment-là, nous vous invitons à choisir un nom pour le projet, comme par exemple \dir{UI\_demo} et a le sauvegarder dans un répertoire appelé \dir{Qt\_tutoriel.}}
\bold{Ce dossier sera notre répertoire de travail tout au long du tutoriel}. \newline
Le préfixe UI permet de repérer que ce fichier est un document QtDesigner (format .ui). \bold{Dans notre cas, le fichier s'appellera \file{UI\_demo.ui}}. \newline \newline 
{\color{red}Il est fortement conseillé de sauvegarder régulièrement votre travail, sous peine de perdre vos données.}




\section{Présentation de l'interface}

Une fois que le fichier \file{UI\_demo.ui} est ouvert, vous arrivez sur une page similaire à l'image suivante : \newline

\img{\rootImages/designer_context_main_window.png}{Fenêtre principale de QtDesigner avec ses outils}{0.25}

Cette page regroupe tous les élements permettant de faire une interface graphique minimaliste.


Tout d'abord nous avons une barre d'outils. \newline

\img{\rootImages/designer_context_toolbar.PNG}{Barre d'outils supérieure}{0.6}


Cette barre permet de gérer les fichier (Enregistrer, ouvrir un nouveau fichier...) et propose quelques utilisations plus spécifiques que nous verrons plus tard. \newline

En plus de ça, nous avons donc 5 zones d'outils, sans compter la barre d'outil supérieure: 

\begin{enumerate}

    %ITEM
    \item {\color{green}Une liste de widgets}
    Dans cette section sont disponibles l'ensemble des widgets communs que vous souhaitez inclure dans votre projet.
    \img{\rootImages/designer_widget_list.png}{Zone des widgets}{0.6}

    %ITEM
    \item {\color{blue}Une zone de travail}
    Cet espace de travail représente une vue de la fenêtre de votre futur logiciel avec ses widgets. \newline
    Au démarrage d'un projet, cet espace est vide.
    \img{\rootImages/designer_workspace.png}{La zone de travail}{0.6}


    %ITEM
    \item {\color{red}Un inspecteur d'objet que nous appellerons \textbf{arborescence} dans le document}
    Tous les widgets insérés dans la zone de travail viendrons s'ajouter automatiquement dans l'arborescence.
    \img{\rootImages/designer_tree.png}{Arborescence de la fenêtre}{0.5}

    
    %ITEM
    \item {\color{magenta}Un éditeur de propriétés}
    Chaque widget possède des propriétés que nous pouvons changer à tout instant avec cet éditeur.
    \img{\rootImages/designer_properties.png}{Éditeur de propriétés}{0.5}

    %ITEM
    \item {\color{gray}Un explorateur de ressource}, qui permettra par la suite de mettre en forme les Widgets proposés par le module \lib{ENIBSupervision} utilisé dans le projet.
    
\end{enumerate}


\subsection{Placer un widget}


Prenons un bouton (QPushButton) parmi la {\color{green}liste des widgets} et déplaçons le sur {\color{blue}zone de travail} (avec la souris, clic-gauche maintenu sur le widget pendant le déplacement), au centre de l'écran.


\img{\rootImages/designer_workspace_add_widget.png}{Ajouter un widget en le glissant vers l'espace de travail}{0.4}


Vous devriez obtenir un bouton similaire. \newline


\img{\rootImages/designer_workspace_new_button.png}{Premier bouton placé sur la fenêtre}{0.5}

\subsection{Renommer un widget}

Dans un souci de clarté pour la suite, nous vous invitons à tout de suite renommer l'élément avec un nom plus explicite. \newline
{\color{red}En effet, dans le programme python, le lien entre l'interface graphique et le programme sera fait par ce nom de widget.} \newline 
Pour cela, il faut aller dans la zone de droite qui contient l'arborescence des widgets de la fenêtre.

\img{\rootImages/designer_properties_rename_widget.png}{Emplacement pour renommer l'élément}{0.7}


Ici, le bouton "pushButton" a été renommé en "pb\_run" en double-cliquant sur "pushButton". Le texte passe en fond bleu, cela veut dire que vous pouvez renommer l'élément. La touche entrée valide le nouveau nom. \newline
Pour l'instant, veuillez ne pas toucher à la section de droite encadrée en rouge. Il s'agit des classes de chaque widgets. 

\img{\rootImages/designer_tree_forbidden_access.png}{Nom de classe à ne pas modifier}{0.7}


\subsection{Propriétés des widgets}

Une fois que le widget est placé, nous souhaiterions changer quelques unes de ses propriétés. \newline
Les propriétés d'un widgets sont disponibles dans le menu en bas à droite.
Pour afficher les propriétés d'un widget, il faut soit
\begin{enumerate}
    \item sélectionner le widget sur la zone de travail (clic-gauche)
    \item sélectionner le widget dans l'arborescence de la fenêtre (clic-gauche)
\end{enumerate}

\img{\rootImages/designer_properties_search_property.png}{Propriétés des widgets sélectionnés [encadré bleu]}{0.6}


\subsubsection{Définir la couleur d'un widget}
Pour changer la couleur d'arrière-plan d'un widget, il faut sélectionner la propriété "palette" puis cliquer dessus.

\img{\rootImages/designer_properties_color.png}{Couleurs des widgets}{0.5}


\subsubsection{Définir le contenu d'un widget}
Pour les widgets gérant un affichage pour l'utilisateur, toutes les informations se trouvent dans les propriétés avec un fond vert.\newline
Pour changer le texte du bouton par exemple, il faut modifier le champ "text".\newline

\img{\rootImages/designer_properties_text_content.png}{Contenu du widget "PushButton"}{0.6}


\section{Mise en forme d'un widget}

Maintenant que nous avons notre bouton, nous souhaiterions qu'il soit mieux placé et que sa taille s'adapte à celle de l'écran et des autres widgets. Pour cela, il faut utiliser les layouts, c'est à dire les widgets de mise en forme.
Ces widgets sont disponibles aux emplacements suivants : \newline

\img{\rootImages/designer_widget_layout.png}{Emplacements des layouts}{0.75}


Nous allons configurer notre zone de travail pour que tous les widgets adaptent leur taille à celle de l'écran.

Pour cela, il faut  d'abord qu'il y ait au moins un widget sur la fenêtre (un bouton par exemple) et que l'espace de travail soit sélectionné (Clic-gauche sur "MainWindow" dans l'arborescence). \newline
Ensuite, sélectionner le bouton "Mettre en page dans une grille" (raccourci "\textbf{ctrl+g}") dans la barre d'outil.

\img{\rootImages/designer_toolbar_grid_layout.png}{Configurer la fenêtre pour adapter son contenu}{1}


Et voila, notre widget prend automatiquement l'espace nécessaire au sein de la fenêtre. \newline


\img{\rootImages/designer_workspace_responsive_button.png}{Un bouton avec des dimensions automatiques}{0.6}



Si cette étape n'est pas faite, lorsque l'interface sera lancée, le widget aura toujours la même taille sur n'importe quel format d'écran (15", 17"...). L'avantage, c'est que cette étape n'est à faire qu'une seule fois, au début de tout nouveau projet. \newline

Nous allons placer un second bouton à coté du nôtre. On souhaite que les deux boutons aient les mêmes dimensions.

Il suffit de prendre un nouveau "pushButton" et de le glisser à coté du premier. Pour savoir l'emplacement du futur bouton, une ligne bleue apparaît au survol de la zone de travail avec le nouveau bouton.



\img{\rootImages/designer_worspace_blue_line.png}{Ligne de l'emplacement des widgets au survol}{0.7}

{\color{red}\bold{Le seconde bouton aura pour valeur "pb\_exit" (propriété du bouton dans l'éditeur de propriétés) et son nom dans l'arborescence sera "pb\_exit".\newline 
Notez également pour la suite que le premier premier bouton ("pb\_run") est appelé "pb\_run" dans l'arborescence. \newline 
Il est important de renommer un widget avec un nom pertinent dès l'ajout de ce dernier.}}
\img{\rootImages/designer_workspace_two_button.png}{Nos deux boutons}{0.6}

\subsection{Simuler l'interface graphique}

Pour visualiser un rendu du logiciel, il faut utiliser le raccourci clavier "\textbf{ctrl+r}". \newline Cela permet de donner une idée plus précise de l'interface.

\img{\rootImages/designer_workspace_run_two.png}{La fenêtre de simulation}{0.6}



Pour tester le résultat, nous vous invitons à dimensionner la fenêtre de simulation avec la souris. Vous pourrez constater que la taille des boutons s'adapte à la taille de la fenêtre.

\img{\rootImages/designer_workspace_responsive_two.png}{La fenêtre de simulation avec une taille variable}{0.6}

\section{Création du menu}

\subsection{Ajout de sous-menu}

Afin de proposer des outils aux futurs utilisateurs du logiciel, nous souhaitons créer un menu comportant des sous-menus.


\img{\rootImages/designer_context_qt_designer_menu.png}{Exemple de menu}{0.8}


Étant donné que la fenêtre est de type "MainWindow", un début de menu est déjà disponible. Pour créer le premier élément du menu, veuillez sélectionner le haut de l'espace de travail en cliquant sur "Éditer". \newline

\img{\rootImages/designer_workspace_add_menu.png}{Ajout de sous-menu}{0.8}


Une fois sélectionné, l'arrière-plan passe en bleu, vous pouvez éditer le nom du sous-menu puis valider avec la touche "entrée".

\subsection{Création des raccourcis clavier}

Il est possible de faire les raccourcis clavier du logiciel via l'interface QtDesigner. 


\section{Création d'une barre d'information}

Une barre d'information est disponible nativement pour afficher du texte sur les pages du logiciel. \newline Le widget associée est appelé \ib{QStatusBar}.



\img{\rootImages/designer_workspace_statusbar.png}{Ajout de barre d'information}{0.55}

La documentation est disponible à l'adresse suivante : \newline \url{https://doc.qt.io/qt-5/qstatusbar.html}

\chapter{Les principaux widgets}

Nous vous proposons de découvrir les principaux widgets et leurs propriétés spécifiques.
\newline
Nous vous recommandons de consulter la documentation Qt pour les différents widgets afin d'obtenir plus d'informations à leur sujets.

\section{Les widgets usuels}
\subsection{Widget QLabel}

Le widget \ib{QLabel} permet d'afficher du texte. 
Il est possible de rédiger du texte riche avec des tailles de polices, des polices et des couleurs différentes. \newline \newline

\img{\rootImages/designer_workspace_qlabel.png}{Un widget QLabel}{0.5}

La documentation du widget est disponible à l'adresse suivante : \newline  \url{https://doc.qt.io/qt-5/qlabel.html}


\subsection{Widget QLineEdit}

Le widget \ib{QLineEdit} permet à l'utilisateur de saisir du texte sur une seule ligne pour l'exploiter par la suite. 

\img{\rootImages/designer_workspace_lineedit.png}{Un widget QLineEdit}{0.8}

La documentation du widget est disponible à l'adresse suivante : \newline  \url{https://doc.qt.io/qt-5/qlineedit.html}


\subsection{Widget QComboBox}

Le widget \ib{QComboBox} est un outil de sélection d'un élément parmi une liste. \newline \newline
La documentation du widget est disponible à l'adresse suivante : \\  \url{https://doc.qt.io/qt-5/qcombobox.html} 

\img{\rootImages/designer_workspace_combobox.png}{Un widget QComboBox}{0.2}


\subsection{Widget QSpinBox}

Le widget \ib{QSpinBox} est une zone de saisie de nombre entier configurable.
Sa variante pour les nombres flottants est \ib{QDoubleSpinBox} 

\img{\rootImages/designer_workspace_spinbox.png}{Un widget QSpinBox}{0.8}
La documentation du widget est disponible à l'adresse suivante : \newline  \url{https://doc.qt.io/qt-5/qspinbox.html} 


\subsection{widget QTabWidget}

Le widget \ib{QTabWidget} permet de faire des onglets (un peu comme un navigateur internet)


\img{\rootImages/designer_workspace_tabwidget.png}{Un widget QtabWidget}{0.8} 
La documentation du widget est disponible à l'adresse suivante : \newline  \url{https://doc.qt.io/qt-5/qtabwidget.html} 

\section{Les boites de dialogue}

Il est parfois souhaitable d'afficher des informations à l'utilisateur par l'intermédiaire de boites de dialogue. \newline.

\subsection{QMessageBox}

Un type de boite de dialogue est la \ib{QMessageBox}. Cela permet d'afficher des informations de différentes natures.\newline

Le programme pour afficher ces fenêtres est expliqué, même si sa mise en place se fera plus tard. \newline
Il est conseillé de savoir que ces fenêtres existent car cela apporte des informations pour la supervision.\newline

Pour utiliser cette boite de dialogue, il faut importer le module suivant
\begin{lstlisting}[language=Python]
from PyQt5.QtWidgets import QMessageBox
\end{lstlisting}


\begin{enumerate}
    \item Une fenêtre d'information
    \img{\rootImages/designer_workspace_qmessagebox_information.png}{QMessageBox d'information}{0.8}
    L'instruction pour afficher la fenêtre est la suivante
    \begin{Python}
    QMessageBox.information(self, "Message PyQt5", "Ceci est une information")
    \end{Python}
    \item Une fenêtre d'avertissement
    \img{\rootImages/designer_workspace_qmessagebox_warning.png}{QMessageBox d'avertissement}{0.8}
    \begin{Python}
    QMessageBox.warning(self, "Message PyQt5", "Ceci est un avertissement")
    \end{Python}
    \item Une fenêtre d'erreur
    \img{\rootImages/designer_workspace_qmessagebox_critical.png}{QMessageBox d'erreur}{0.8}
    \begin{Python}
    QMessageBox.critical(self, "Message PyQt5", "Ceci est une erreur")
    \end{Python}
    \item Une fenêtre pour une question 
    \img{\rootImages/designer_workspace_qmessagebox_question.png}{QMessageBox pour une question}{0.8}
    \begin{Python}
    reponse = QMessageBox.question(self, "Message PyQt5", "Votre question ?", QMessageBox.Yes | QMessageBox.No, QMessageBox.No)
    \end{Python}
    Le dernier argument représente la valeur par défaut lors de l'appui sur la touche "Entrée". \newline
    Pour traiter la réponse, il suffit de regarder la valeur de "reponse"
    \begin{Python}
    if(reponse==QMessageBox.Yes):
        print("Réponse Oui")
    else:
        print("Réponse Non")
    \end{Python}
\end{enumerate}





\chapter{Les interactions}

\section{Les signaux et slots}

Une fois que notre interface (\file{MainWindow.ui}) est réalisée, nous souhaiterions effectuer des actions lorsque l'utilisateur interagit avec des widgets. \newline \newline
Pour cela, QtDesigner est basé sur un modèle signaux/slots, c'est à dire qu'un évènement choisi parmi une liste permet d'appeler une fonction existante. \newline
Plus précisément, un signal est émit lorsque l'utilisateur effectue une action. Il ne reste plus qu'a récupérer ce signal, un peu comme le système d'exception en C++ (try/catch).
L'évènement est appelé "signal" et la fonction "slot". \newline \newline


\img{\rootImages/designer_slots.png}{Un signal et un slot sur un bouton}{0.4}

Dans l'exemple précédent, on observe que l'appui sur le bouton "button" déclenche la fonction "quit" de l'interface principale.

La mise en place effective du système de signaux/slots sera effectué dans la partie  \ref{exemple_signal} (\textit{Connexion d'un bouton})

\section{Génération des fichiers python}

Avant de programmer les signaux/slots, il convient de convertir notre fichier .ui en un fichier python exploitable par la suite. C'est l'utilitaire \bold{Pyuic5} qui va l'effectuer. \newline

Ce programme attend en entrée un fichier au format .ui et va sortir un fichier Python. La commande générique est la suivante : 

\begin{lstlisting}[language=bash]
pyuic5 -o fichier_python.py -x fichier_qtdesigner.ui
\end{lstlisting}

Le "-o" permet de préciser le fichier de sortie (output), c'est à dire le nom du fichier que nous souhaitons générer en python. \newline \newline
Le "-x" permet de préciser le fichier d'entrée (eXecutable) que nous souhaitons convertir. \newline \newline
Dans notre cas, nous allons faire la commande suivante, toujours dans notre répertoire \dir{Qtdesigner\_tuto}. \newline.
On n'oubliera pas de sauvegarder notre projet QtDesigner au préalable.
\begin{lstlisting}[language=bash]
pyuic5 -o MainWindow.py -x UI_demo.ui
\end{lstlisting}
Et voila, dans le dossier \dir{Qt\_tutoriel}, un fichier python appelé \file{UI\_MainWindow.py} vient d'être crée par pyuic. \newline

En  principe,  vous  n’aurez  jamais  besoin  de  modifier  le  fichier  python généré par Pyuic. En  effet, \textbf{{\color{red}ce  fichier  doit être généré à chaque  fois  que  vous  modifiez l’interface depuis QtDesigner}}, auquel cas vous ne constaterez aucun changement. \newline

Dans le cas de notre projet, faire une interface graphique avec QtDesigner est très graphique mais il est possible de faire l'interface directement en programmation Python. \newline
Pour vous en convaincre, voici un extrait de fichier python généré par Pyuic5 : \newline

\begin{lstlisting}[language=python]
class Ui_MainWindow(object):
    def setupUi(self, MainWindow):
        MainWindow.setObjectName("MainWindow")
        MainWindow.resize(645, 434)
        self.centralwidget = QtWidgets.QWidget(MainWindow)
        self.centralwidget.setObjectName("centralwidget")
        self.gridLayout = QtWidgets.QGridLayout(self.centralwidget)
        self.gridLayout.setObjectName("gridLayout")
        self.sw_main = QtWidgets.QStackedWidget(self.centralwidget)
        self.sw_main.setObjectName("sw_main")
        self.page_4 = QtWidgets.QWidget()
        self.page_4.setObjectName("page_4")
\end{lstlisting}
Ainsi, si nous saisissons ces lignes dans un fichier Python, nous obtiendrons la même interface que celle réalisée avec QtDesigner, cependant, le temps de prise en main n'est pas le même. \newline

\section{Introduction à la Programmation Orientée Objet}
Afin de mieux comprendre le code généré et nécessaire à la création des interfaces graphiques sous QtDesigner, il convient d'expliquer quelques notions de \bold{Programmation Orientée Objet}. \\

La Programmation Orientée Objet (POO) est un concept de programmation qui vise à créer des "objets". \newline \newline
Ces objets possèdent des \textbf{attributs} (sorte de propriétés intrinsèques) et possèdent également des \textbf{méthodes}, c'est à dire des fonctions permettant d'interagir en interne et avec d'autres objets. \newline \newline
Prenons un exemple et considérons un objet "\ib{Véhicule}"\footnote{Par convention, les noms d'objets possèdent une majuscule.}. \newline
Cet objet possède des propriétés comme une couleur, des dimensions, un nombre de roues, etc. Ces élements forment les attributs de notre objet "\ib{Véhicule}". \newline


Maintenant, ou souhaite définir le comportement de notre objet "\ib{Véhicule}". Nous allons décréter que notre objet peut \italic{avancer}, \italic{reculer}, \italic{tourner à droite}, etc.
Ces actions forment les méthodes de notre objet.\newline \newline

 \img{\rootImages/designer_poo.png}{Un objet 'Véhicule'}{0.5}


La POO introduit en programmation la notion d'\textbf{héritage}. \newline
Cela signifie qu'un objet parent transmet tous ses attributs et ses méthodes à un ou plusieurs enfants. \newline
Par exemple, nous voulons créer une classe "\ib{Voiture}". Quelle est la manière la plus rapide de créer un objet Voiture ? Et bien il suffit de faire hériter notre objet "\ib{Véhicule}" à notre nouvel objet "\ib{Voiture}", ainsi, notre "\ib{Voiture}" aura une couleur, des dimensions, un nombre de roues, etc et pourra \italic{avancer}, \italic{reculer} et se déplacer de la même manière que le "\ib{Véhicule}". \newline Ce modèle est pertinent dans la mesure ou une voiture, un vélo ou même une trottinette ont des propriétés communes, ce sont tous des véhicules. \newline
Nous pourrions également appliquer le principe de POO à un objet "\ib{Animaux}" et créer des objets "\ib{Mammifères}", "\ib{Oiseaux}", "\ib{Poissons}" par héritage. \newline


\img{\rootImages/designer_poo_heritage.png}{L'héritage entre l'objet "\ib{Véhicule}" et l'objet \ib{Voiture}"}{0.5}


Qt utilise la POO car parmi tous les widgets, certains ont des propriétés communes (\ib{QSpinBox} et \ib{QDoubleSpinBox}) avec très peu de différences. Il est donc pertinent de partir d'un objet \textit{parent} (\ib{QWidget}) et de transmettre toutes les propriétés à ses \textit{enfants}, tout en modifiant parfois certaines de ses propriétés. \newline

Concrètement, la structure d'un objet est défini par une classe constituée de fonctions membres (méthodes) et de variables (attributs)

\section{Création d'un objet par héritage}

Pour résumer, l'utilitaire Pyuic créé un objet \lib{UI\_MainWindow} qui contient des attributs telles qu'une couleur d'arrière plan et des méthodes pour l'application. \newline
Nous voulons donc créer notre propre objet par héritage que nous appellerons \ib{MyObject} pour ajouter des fonctionnalités (méthodes et attributs) qui permettront notamment de gérer nos nouveaux boutons. \newline

Ouvrez un fichier que vous appellerez \file{MyModule.py}
Ensuite, importez le fichier Python généré par Pyuic avec l'instruction suivante :

\begin{lstlisting}[language=Python]
#On importe notre objet depuis le fichier UI_demo.py, généré par Pyuic
from UI_demo import Ui_MainWindow
\end{lstlisting}

puis importer les modules de base de PyQt :  
\begin{lstlisting}[language=Python]
from PyQt5 import QtCore, QtGui, QtWidgets
\end{lstlisting}

Maintenant, nous pouvons nous atteler à la création de notre classe \ib{MyObject} (structure de notre objet) qui hérite de \ib{QMainWindow}, afin d'exploiter notre interface graphique.


\begin{lstlisting}[language=Python]
class MyObject(QtWidgets.QMainWindow):
\end{lstlisting}

En programmation Python, l'héritage se définit lors de la création de la classe.\newline
Ici, avec la présence d'un argument entre les parenthèses, cela veut dire que \ib{MyObject} hérite de \ib{QtWidget.QMainWindow}.

La structure générale d'héritage en Python est donc la suivante : 
\begin{lstlisting}[language=Python]
class objet(parent):
\end{lstlisting}

\subsection{Déclaration du constructeur de classe}

Il nous faut maintenant définir un comportement lors de la création de notre objet. \newline
Pour cela, on va créer un constructeur de classe\footnote{En réalité un initialisateur, le constructeur est \_\_new\_\_.}
Le constructeur est une méthode appelée dès la création de l'objet, c'est même la première méthode qui crée l'objet. \newline
En python, le constructeur est repérée par le mot clé \bold{\_\_init\_\_} (préfixe et suffixe de init avec deux underscores).

Notre déclaration de constructeur de classe est donc la suivante : 

\begin{lstlisting}[language=Python]
    def __init__(self, parent = None):
\end{lstlisting}

On déclare que notre constructeur peut attendre en argument un parent mais que ce n'est pas obligatoire (présence d'un argument par défaut valant None). \newline Qt tolère des constructeurs avec aucun parent renseigné. \newline
L'argument \bold{self}\footnote{Le mot-clé self est utilisé par convention, mais on pourrai tout aussi bien choisir un autre mot.} est un argument obligatoire pour toute méthodes en python, il représente l'objet courant. 

\subsection{Définition du constructeur de classe}

Cependant, pour que notre objet possède les méthodes et attributs de l'objet \ib{QMainWindow} (héritage), il faut instancier notre objet parent, c'est à dire \ib{QMainWindow}.
Pour cela, on utilise la syntaxe suivante : 
\begin{lstlisting}[language=Python]
        super().__init__(parent)
\end{lstlisting}
L'instruction \italic{super.\_\_init\_\_(parent)} est un appel du constructeur parent. \newline
Et voila, notre future fenêtre aura toutes les méthodes et attributs de l'objet \ib{QMainWindow}, dont la méthode pour lancer l'interface et l'afficher. \newline.

Cependant, notre classe \ib{MyObject} ne possède pas les propriétés de notre interface créés sous QtDesigner. pour cela, il faut instancier l'objet importé depuis le fichier \file{UI\_demo.py} (module généré par Pyuic5) : 

\begin{lstlisting}[language=Python]
        self.__ui = UI_MainWindow()
\end{lstlisting}

Ici, \bold{self} fait toujours référence à notre objet courant (\ib{MyObject}) et le fait de mettre le symbole \bold{\_\_} en préfixe de variable permet à Python de considérer la variable comme étant privée. \newline 
Le fait de mettre une variable privée permet de rendre le code plus robuste dans la mesure ou le membre doit être manipulé par des méthodes spéciales.\newline


De ce fait, nous avons créer un membre de notre classe qui sera bientôt l'interface faite sous QtDesigner. \newline
Cependant, il est nécessaire de lier notre objet (\ib{MyObject}) à notre interface représentée par la variable membre \bold{self.\_ui} \newline
Il faut écrire la ligne suivante, ou \textit{self} est notre objet \ib{MyObject} : 

\begin{lstlisting}[language=Python]
        self.__ui.setuUI(self)
\end{lstlisting}



\bold{Et dans le fichier \file{MyModule.py}, vous devriez avoir les instructions suivantes :}

\begin{lstlisting}[language=Python]
from PyQt5 import QtCore, QtGui, QtWidgets
from UI_demo import UI\_MainWindow

#Objet MyObject qui hérite de QtWidgets.QMainWindow
class MyObject(QtWidgets.QMainWindow):
    
    #Constructeur de classe
    __init__(self, parent=None):
        
        #Instance de l'objet UI_MainWindow
        self._ui = UI_MainWindow()
        #On 'attache' l'interface à notre objet courant
        self.ui.setupUI(self)

\end{lstlisting}



\section{Lancement du programme}

\subsection{Création du fichier principal}

Nous avons actuellement créer un objet \ib{MyObject} qui est le rendu de l'interface faite sous QtDesigner. Nous souhaiterions l'exécuter comme un programme classique. \newline


Nous allons créer dans le \bold{répertorie \dir{Qt\_tutoriel}} un fichier \file{main.py} qui va représenter notre fichier principal, sous-entendu qui va lancer l'application à partir d'un terminal. \newline

\bold{Vous devriez obtenir, dans le répertoire \dir{Qt\_tutoriel} les fichiers suivants : }
\img{\rootImages/designer_files.png}{Fichiers dans le répertoire de travail}{0.4}

Dans le fichier \file{main.py}, il faut commencer par importer les modules courants de PyQt5 : 
\begin{lstlisting}[language=Python]
from PyQt5 import QtCore, QtGui, QtWidgets
import sys
\end{lstlisting}
Nous importerons également le module sys qui permet de gérer les sorties d'applications. \newline

Ici, nous allons importer notre classe \ib{MyObject} précédemment créée et contenue dans le fichier \file{MyModule.py}.
\begin{lstlisting}[language=Python]
from MyModule import MyObject
\end{lstlisting}


Ensuite, nous avons la ligne suivante pour autoriser à lancer le programme uniquement si ce dernier est lancé en tant que programme principal et non en tant que module.

\begin{lstlisting}[language=Python]
if(__name__ == "__main__"):
\end{lstlisting}


\begin{lstlisting}[language=Python]
    app = QtWidgets.QApplication(sys.argv)
    MyWindow = MyObject()
\end{lstlisting}

Ces deux lignes déclarent deux objets nommés "app" et "MyWindow" qui sont une instance respective de la classe \ib{QApplication} et \ib{MyObject}. \newline
Ici, "app" et "MainWindow" seront donc vus comme des entités ayant des propriétés.\newline
En argument de \ib{QtApplication}, nous avons "sys.argv", cela permet de transmettre les arguments de la ligne de commande, à l'image de la syntaxe suivante en C++ pour récupérer les arguments de la ligne de commande : \newline\newline
\begin{lstlisting}[language=bash]
   int main(int argc, char const *argv[]) {
        return 0;
   }
\end{lstlisting}


Maintenant, nous sommes en mesure  d'afficher la fenêtre de notre interface avec l'instruction suivante

\begin{lstlisting}[language=Python]
	MyWindow.show()
\end{lstlisting}

Maintenant que nous avons instancié notre objet \ib{MyObject}, la méthode \italic{show} permet uniquement d'afficher l'interface (mais pas de faire les traitements définit par l'utilisateur. \newline
Les traitements se font via la méthode "\italic{exec}" de l'objet "app".
Ainsi, on exécute les traitements de l'application et lorsque l'application se ferme (choix de l'utilisateur ou bien erreur de l'application), un code d'erreur est retourné à la fonction \italic{sys.exit()}.

\subsection{Lancement de l'interface}

Il ne vous reste plus qu'a saisir un terminal et de lancer la commande suivante : 
\begin{lstlisting}[language=bash]
	python main.py
\end{lstlisting}


Et voila, votre interface se lance.

%Image lancement


\section{Connexion d'un bouton}\label{exemple_signal}

Rappelez-vous, nous avons créée deux boutons (pb\_run et pb\_exit). Nous souhaiterions effectuer une action lors d'un appui sur les boutons. \newline
Nous allons donc connecter nos boutons par le système de signal/slot de Qt
Pour cela, \bold{nous nous plaçons dans le fichier d'interaction \file{MyModule.py}.}\newline

Il est généralement conseillé de faire les interactions dans le constructeur de la classe car cette fonction est appelée dès le lancement du programme. \newline
Avant de code, il convient de connaître l'évènement associé. Dans le cas d'un \ib{QPushButton}, le \textbf{signal} "clicked" est émis par le programme. \newline
Ce signal devra donc déclencher la fonction membre (slot) "\italic{test\_pb}" que nous allons coder à la suite du constructeur. \newline

Dans la fonction \_\_init\_\_, le code générique pour une interaction est  : \newline
\begin{lstlisting}[language=python]
	 self.__ui.objet.signal.connect(self.slot)
\end{lstlisting}
Où \textbf{objet}, \textbf{signal} et \textbf{slot} valent respectivement \textbf{pb\_run}, \textbf{clicked} et \textbf{test\_pb}
\begin{lstlisting}[language=python]
	 self.__ui.pb_run.clicked.connect(self.test_pb_run)
\end{lstlisting}
Tout au long du programme, le mot clé \bold{self\_\_ui} représentera l'objet courant dans le programme, c'est à dire la fenêtre de notre interface. \newline

\section{Ajout d'une fonction}

Une fois notre bouton connecté, il ne reste plus qu'a créer le slot (fonction appelée). \newline
Chaque ajout de fonction se fait à la suite du constructeur.
En python, une fonction se traduit par le mot-clé \textbf{def} suivi de son nom et du symbole ':' \newline
{\color{red}Dans le cas de la programmation python, il est impératif de mettre en premier argument le mot-clé \textbf{self} pour chaque nouvelle fonction-membre ajoutée.} \newline

Une mauvaise indentation provoquera une erreur d'exécution. 
Le mot clé "\textbf{def}" des fonction ajoutées sera toujours au même niveau d'indentation que le "\textbf{def}" du constructeur. (\_\_init\_\_)\newline

Notre fonction \italic{test\_pb\_run} se contentera d'afficher la bonne réception du signal. Vous devriez donc obtenir un code similaire : \newline

\begin{lstlisting}[language=Python]
def __init__(self,parent = None):
    super().__init__(self,parent)
    self.__ui = Ui_MainWindow()
    self.__ui.setupUi(self)
    
    #Connexion du bouton
    this.__ui.pb_run.clicked.connect(self.test_pb_run)
        
def test_pb(self):
    print("PushButton pb_run clicked")
        
\end{lstlisting}

je vous invite à lancer l'interface avec le fichier \file{main.py} et de constater le résultat dans le terminal lors de l'appui du bouton "pb\_run"
%image terminal python lancé
\section{Quelques signaux supplémentaires}

Pour connaître les signaux existants, on peut sélectionner le widget dans l'espace de travail puis avec un clic-droit, on sélectionne "Aller au slot". \newline
Tous les signaux associés au widget courant sont visibles.
Il est également possible de générer des signaux personnalisés (En savoir plus à l'adresse \url{https://www.pythoncentral.io/pysidepyqt-tutorial-creating-your-own-signals-and-slots/})

\img{\rootImages/designer_workspace_signals.png}{Les signaux pour une ComboBox}{0.6}


\chapter{Ajouts de widgets personnalisés}

Lors de la création de l'interface de supervision, nous serons amenés à utiliser des widgets qui nous avons crées. \newline
Ces widgets formerons des moteurs, vérins, voyant, etc. \\
Le fonctionnement de ces widgets est définis par le fichier \file{DynamicObject.py} au sein de la classe \ib{DynamicObject}.

\section{Importation d'un type de widget}

Nous allons vous montrez comment représenter un objet dynamique. Pour cette expérimentation nous présenterons l'utilisation d'un objet "vérin" mais le fonctionnement est similaire pour tous les autres objets.\\

Tout d'abord, ajoutez un widget sur la fenêtre d'interface.
On peut le renommer pour être plus explicite (fenêtre à droite).

Notre widget sera le parent de notre objet "vérin". Pour cela, on doit indiquer le fichier d'utilisation de notre classe \ib{DynamicObject}.

\img{\rootImages/programme_3.png}{Localisation du widget "Widget"}{0.25}

Puis on sélectionne notre widget et click Droit puis \textit{promote to}. 

\img{\rootImages/programme_4.png}{}{0.85}

On remplit nos champs comme ci-dessous:\\
-Promoted class name: \ib{DynamicObject}\\
-Header file: \file{ENIBSupervision/UI\_class/UI\_DynamicObject.py}

\img{\rootImages/programme_5.png}{Contenu des zones de saisi}{0.7}

On peut maintenant sauvegarder et fermer QtDesigner. \\

\bold{Cette étape est à faire une seule fois. Ensuite, pour chaque nouveau widget personnalisé, il faudra choisir dans \textit{promote to} la classe DynamicObject qui sera apparue.} \\

Pour les voyants qui serons abordés par la suite, il faudra promouvoir en \ib{IndicLight}\chapter{Introduction}

Ce document a pour but de vous initier à l'utilisation de PyQt5 à travers la réalisation d'un programme simple utilisant PyQt5 et les outils développés dans le module \lib{ENIBSupervision}.\newline
Ne seront pas abordés ici :
\begin{enumerate}
\item L'utilisation de QtDesigner
\item Le descriptif et le détail du code réalisé dans le module \lib{ENIBSupervision}
\end{enumerate}


La réalisation de ce projet a amené à la création d'un module \lib{ENIBSupervision} fournissant des outils facilitant la mise en oeuvre de logiciels de supervision en Python.\newline
Ce module propose des outils et une manière d'aborder la Supervision en Python, ce n'est qu'une manière parmi tant d'autres, le but était de simplifier le travail du programmeur en proposant des outils robustes et dont l'utilisation était accessible.


\chapter{Présentation}

\section{Types de variable principaux}

Cette section à pour but de faire une présentation rapide des types les plus importants disponibles dans ce module.

\subsection{Types non-graphiques}

\begin{enumerate}

\item \label{tag-presentation-PLCVar} \ib{PLCVar} \newline
Il s'agit du type principal de ce module, il représente une variable automate et possède les attributs nécessaires comme un \textbf{nom}, une \textbf{adresse}, une \textbf{description} etc... Ce type a été conçu pour fonctionner avec le type suivant : \ib{ModbusPLC}.\newline
Pour plus d'informations sur ce type, se référer à la documentation fournie en annexe.\newline
D'un point de vue organisation, le type \ib{PLCVar} est défini dans le sous-module \lib{PLC} puis dans le sous-module \lib{Variable}. \newline
Pour importer ce type, il faudra par exemple utiliser :
%"coloration" du code
\begin{lstlisting}[language=Python]
from ENIBSupervision.PLC.Variable import PLCVar
\end{lstlisting}

\item \ib{EventsLoop} \newline
Ce type permet la gestion pseudo-événementielle des variables. Son utilisation simplifie l'utilisation du type \ib{PLCVar} grâce à l'utilisation de fonctions connectées aux changements d'états d'une variable. Ce fonctionnement sera décrit en détail plus tard mais son utilisation est obligatoire pour profiter de tous les systèmes mis en place autour de cette gestion.\newline
Ce type permet de lancer en parallèle du programme principal une boucle qui cherchera à analyser l'état des variables dans l'automate à un intervalle de temps régulier. De la même manière, lorsque une variable est modifiée dans le programme et seulement si elle est modifiée, alors son état sera automatiquement envoyé vers l'automate. \newline
Si ce fonctionnement peut sembler compliqué, nous verrons dans la suite de ce document qu'il est en réalité extrêmement simple et que l'utilisation de ce type simplifie énormément la gestion de la communication avec l'automate. \newline
D'un point de vue organisation, le type \ib{EventsLoop} est défini dans le sous-module \lib{EventsLoop}.\newline
Pour plus d'informations sur ce type, se référer à la documentation fournie en annexe.\newline
Pour importer ce type, il faudra par exemple utiliser :
\begin{lstlisting}[language=Python]
from ENIBSupervision.EventsLoop import EventsLoop
\end{lstlisting}

\colors{red}{Il est important de noter que ce type n'est normalement pas à utiliser directement}. Il faut préférer l'utilisation du type \ib{ModbusPLC} qui gérera cette boucle événementielle automatiquement.

\item \label{tag-presentation-ModbusPLC} \ib{ModbusPLC} \newline
Il s'agit du second type principal de ce module, il représente un automate programmable industriel et possède les attributs nécessaires comme un \textbf{nom}, une \textbf{adresse IP}, une \textbf{description} etc... Ce type a été conçu pour fonctionner avec le type suivant : \ib{PLCVar}.\newline
Pour plus d'informations sur ce type, se référer à la documentation fournie en annexe.\newline
D'un point de vue organisation, le type \ib{ModbusPLC} est défini dans le sous-module \lib{PLC} puis dans le sous-module \lib{ModbusPLC}. \newline
Pour importer ce type, il faudra par exemple utiliser :
%"coloration" du code
\begin{lstlisting}[language=Python]
from ENIBSupervision.PLC.ModbusPLC import ModbusPLC
\end{lstlisting}

\end{enumerate}



\newpage



\subsection{Types graphiques}

\begin{enumerate}

\item \ib{AnimationTables}\newline
Ce type offre la possibilité de faire très facilement des tables d'animations à partir d'une liste de variables de type \ib{PLCVar}. Pour un bon fonctionnement des tables générées, il \colors{red}{est nécessaire} d'utiliser le type \ib{EventsLoop} ou \ib{ModbusPLC}.\newline
La fenêtre générée propose des fonctionnalités de forçage, d'actualisation automatique des valeurs lorsque couplé à une \ib{EventsLoop} ou un \ib{ModbusPMC}, d'affichage des tables d'entrées/sorties redimensionnables et la possibilité de la "docker" sur une fenêtre principale de Qt \href{https://doc.qt.io/qt-5/qmainwindow.html}{QMainWindow}.\newline
D'un point de vue organisation, le type \ib{AnimationTables} est défini dans le sous-module \lib{UI\_class} puis dans le sous-module \newline \lib{UI\_AnimationTables}.\newline
Pour plus d'informations sur ce type, se référer à la documentation fournie en annexe.\newline
Pour importer ce type, il faudra par exemple utiliser :
\begin{lstlisting}[language=Python]
from ENIBSupervision.UI_class.UI_AnimationTables import AnimationTables
\end{lstlisting}
Voici un exemple de tables que l'on peut obtenir :
\img{\rootImages/enibSup_window_animationTablesExample.png}{Exemple de tables d'animations}{0.4}


\item \ib{DynamicObject}\newline
Ce type offre la possibilité de représenter très facilement des éléments d'une partie opérative tels que des vérins ou des moteurs.\newline
D'un point de vue organisation, le type \ib{DynamicObject} est défini dans le sous-module \lib{UI\_class} puis dans le sous-module \newline \lib{UI\_DynamicObject}.\newline
Pour plus d'informations sur ce type, se référer à la documentation fournie en annexe.\newline
Pour importer ce type, il faudra par exemple utiliser :
\begin{lstlisting}[language=Python]
from ENIBSupervision.UI_class.UI_DynamicObject import DynamicObject
\end{lstlisting}
Voici un exemple de widget que l'on peut obtenir :
\img{\rootImages/enibSup_DynamicObject_moteur.png}{Exemple de résultat avec un moteur}{0.4}
\img{\rootImages/enibSup_DynamicObject_verin.png}{Exemple de résultat avec un vérin}{0.4}

\newpage

\item \ib{IndicLight}\newline
Ce type offre la possibilité de représenter très facilement des voyants avec un nombre d'états infinis.\newline
D'un point de vue organisation, le type \ib{IndicLight} est défini dans le sous-module \lib{UI\_class} puis dans le sous-module \newline \lib{UI\_IndicLight}.\newline
Pour plus d'informations sur ce type, se référer à la documentation fournie en annexe.\newline
Pour importer ce type, il faudra par exemple utiliser :
\begin{lstlisting}[language=Python]
from ENIBSupervision.UI_class.UI_IndicLight import IndicLight
\end{lstlisting}
Voici un exemple de voyants que l'on peut obtenir :
\img{\rootImages/enibSup_IndicLight.png}{Exemple de résultat avec deux voyants dans deux états différents}{0.4}

\end{enumerate}




\chapter{Réalisation d'un programme élémentaire}

Nous allons aborder dans ce chapitre la création d'un programme de base en utilisant PyQt5. A la fin de ce chapitre, vous serez en mesure de créer et d'afficher une fenêtre principale basique.\\

Il est très vivement conseillé de lire l'introduction à PyQt5 et QtDesigner avant de s'attaquer à cette partie. Aussi, il est considéré que les différents outils nécessaires sont déjà installés.



\section{Architecture type d'un programme}

Cette section a pour but de présenter \textbf{une} manière parmi tant d'autres d'organiser un programme de ce type utilisant Qt comme bibliothèque graphique.

L'utilisation de Qt en Python (c'est originellement une bibliothèque C++) impose certaines contraintes. En effet, cela impose la création de fichiers \textbf{*.ui}, l'utilisation de fichiers Python automatiquement générés et l'utilisation de fichiers rédigés par un programmeur.\newline
L'organisation qui va être présentée a l'avantage de séparer ces trois "types" de fichiers et de permettre l'utilisation d'outils déjà rédigés.

\subsection{Création d'un dossier de projet}

En premier lieu, nous allons créer un dossier de projet. On l'appellera la \textbf{racine du projet}. Ce dossier contiendra tous les fichiers nécessaires au programme.\newline
Pour notre exemple, je vais nommer le dossier "\dir{SupEx}".\newline

\subsection{Contenu essentiel de la racine du projet}

Nous pouvons ensuite copier le dossier \dir{ENIBSupervision} fourni dans la racine du projet.\newline

Dans la racine du projet, nous allons ensuite séparer les trois types de fichiers mentionnés plus haut (QtDesigner,python générés,python rédigés). Pour ce faire, nous allons créer  trois nouveaux dossiers. Pour pouvoir utiliser un script que nous verrons juste après, il sera nécessaire de les nommer comme suit :
\begin{enumerate}

\item \dir{UI\_formFiles} : Ce dossier contiendra les fichiers d'interfaces graphiques créés avec QtDesigner (fichiers \textbf{*.ui})\newline

\item \dir{UI\_pyFiles} : Ce dossier contiendra les fichiers Python générés depuis les fichiers \textbf{*.ui} du dossier \dir{UI\_formFiles} à l'aide de l'outil \textbf{pyuic}.\newline
C'est d'ailleurs ici que rentre en jeu un petit script que vous pouvez trouver dans le dossier du module \lib{ENIBSupervision}. Ce script python se nomme "\file{scriptExport.py}". Son fonctionnement est très simple, il fournit une fonction permettant de convertir automatiquement tous les fichiers \file{*.ui} d'un dossier en fichier \file{*.py} dans autre dossier. Consultez la documentation de ce module pour plus d'informations.\newline
Si vous lancez le script Python, il cherchera par défaut à appliquer ces traitements sur les dossiers mentionnés soit \dir{UI\_formFiles} et \dir{UI\_pyFiles}.

\item \dir{UI\_class} : Ce nom n'est ici d'aucune importance, vous pouvez le modifier comme bon vous semble sans avoir quoique ce soit d'autre à modifier.\newline
Ce dossier contiendra les fichiers de code Python que vous aurez rédigés et qui serviront dans votre programme pour créer des interfaces graphiques.

\end{enumerate}

Encore une fois, il s'agit de propositions, libre à vous de les renommer comme bon vous semble mais il vous faudra certainement adapter votre code à certains endroits.

\subsection{Fichier principal du programme}

N'oublions pas de rajouter le fichier qui servira à lancer le programme.Nous l'appellerons le fichier principal ou "main" en anglais.\newline
Ainsi, nous pouvons créer un fichier "\file{main.py}" avec son contenu essentiel dans la racine du projet :

\begin{Python}
# -*- coding: utf-8 -*-
#on explicite l'encodage du fichier

#importation des modules nécessaires à Qt
import sys
from PyQt5 import QtCore, QtGui, QtWidgets


if(__name__ == "__main__"): #si c'est ce module qui est lancé directement

	#code du programme

\end{Python}

\subsection{Résultat}

Vous devriez maintenant avoir dans votre racine du projet créé précédemment, quelque chose ressemblant fortement à ceci :

\img{\rootImages/enibSup_window_explorer_projectRoot.png}{Illustration d'une racine de projet}{0.4}

%new section

\section{La fenêtre principale}

\subsection{Création de l'interface graphique}

Nous utiliserons ici QtDesigner et PyQt5 avec leurs outils respectifs, si vous n'avez pas encore étudié leur fonctionnement, je vous invite à vous y intéresser avant de commencer cette section. Une annexe à ce sujet est disponible.\newline
En effet, même si nous rappellerons ici l'essentiel, vous aurez certainement besoin de plus de connaissances pour être à même de concevoir une interface vraiment utilisable.

\subsubsection{Lancement de QtDesigner}

Il est possible que ce logiciel ne soit pas "facilement" accessible. Ainsi, nous vous invitons à suivre la procédure suivante :
\begin{enumerate}
\item Ouvrir une console windows/Un terminal linux
\item Lancer QtDesigner par la commande suivante :
\begin{lstlisting}[language=bash]
designer
\end{lstlisting}
\end{enumerate}

Si vous avez installés les outils nécessaires, cette commande devrait vous lancer le logiciel et vous épargner de longues minutes de recherche du dossier d'installation.

\subsubsection{Choix de l'interface}

A l'ouverture du logiciel, vous devriez arriver sur une page vous demandant de choisir le type de "\bold{formulaire}" que vous voulez créer.\newline
Puisque nous voulons réaliser une fenêtre principale, nous sélectionnerons en toute logique le type "\ib{\colors{red}{MainWindow}}" :

\img{\rootImages/enibSup_window_designerWidgetSelection_MainWindow.png}{Sélection du type d'interface voulue}{0.3}

Je laisse à votre charge de réaliser le contenu de la fenêtre : pour cet exemple simple, nous allons simplement disposer un bouton dans la fenêtre et l'organiser dans un layout simple.\newline
Vous devriez obtenir à la fin une fenêtre ressemblant à ceci :

\img{\rootImages/enibSup_window_MainWindowExample.png}{Fenêtre principale de l'exemple}{0.4}

N'oubliez pas de sauvegarder votre réalisation
\footnote{Profitons-en ici pour rappeler que nous ne sauvegardons jamais assez. Dès que vous le pouvez, sauvegardez, la combinaison \bold{\colors{red}{Ctrl+S}} doit devenir un réflexe. Souvenez-vous que vous pouvez perdre tout votre travail sur un simple bug.}
dans le dossier adapté, soit \file{UI\_formFiles} dans la racine de votre projet. Pour cet exemple, je la nommerai \file{UI\_MainWindow.ui}\newline
Vous avez maintenant une interface graphique "dessinée" facilement. Il ne reste plus qu'à l'exploiter.


%End section

\section{Export de l'interface}

Pour pouvoir exploiter l'interface que nous avons créé, il nous faut convertir le fichier \file{*.ui} en fichier Python utilisable.\newline
Ceci est permis grâce à l'outil \italic{\bold{pyuic5}}.\newline
J'ai déjà mentionné un script permettant de réaliser cet export automatiquement. Nous allons nous en servir. Si vous avez suivi la section "\bold{Architecture type d'un programme}", vous devriez avoir dans la racine du projet ce script sous forme d'un fichier Python nommé \file{scriptExport.py}. Il vous suffit de le lancer. Si vous le lancez depuis un terminal
\footnote
{
Nous vous conseillons plutôt de manière générale de lancer les différents programmes python depuis un terminal lors du développement. Cela vous permet d'afficher facilement des informations pour contrôler la bonne exécution du programme lors du débogage.
}
, vous aurez le détail des fichiers exportés.\newline

\img{\rootImages/enibSup_window_explorer_projectRoot_scriptExport.png}{Script d'export dans la racine du projet}{0.4}

Une fois le script lancé, vérifiez que le dossier \file{UI\_pyFiles} contient bien un fichier dont le nom est identique au fichier \bold{*.ui} que vous avez édité précédemment. Notez que si vous avez enregistré un fichier avec un nom commençant par le préfixe \italic{UI\_}, celui-ci a été supprimé, c'est un comportement voulu. Libre à vous de modifier ce script simpliste.

\img{\rootImages/enibSup_window_explorer_UIPyFiles_mainWindow.png}{Fichier \bold{*.ui} exporté en fichier \bold{*.py}}{0.4}

%End section

\section{Exploitation de l'interface en python}

\subsection{Pré-requis}

Nous avons maintenant toutes les clefs en main pour faire un programme minimal exploitant cette interface.\newline
Nous allons nous rendre dans le dossier \file{UI\_class} dans la racine du projet pour créer un nouveau fichier qui correspondra au module contenant la définition de notre fenêtre principale. (Le coeur du programme)\newline
Pour ma part, ce module portera le même nom que son fichier \file{*.ui} associé soit \file{UI\_MainWindow.py}.

\img{\rootImages/enibSup_window_explorer_UIClass_basic.png}{Contenu du dossier \dir{UI\_class} en l'état}{0.4}

\subsection{Rédaction du code de la fenêtre principale}

Tout d'abord, n'oublions pas la ligne traditionnelle d'en-tête d'un fichier Python :
\begin{Python}
# -*- coding: utf-8 -*-
#on explicite l'encodage du fichier
\end{Python}
Puis l'importation des modules nécessaires à l'utilisation de PyQt
\begin{Python}
#importation des modules nécessaires à Qt
from PyQt5 import QtCore, QtGui, QtWidgets
\end{Python}

Ensuite, attaquons-nous au plus délicat.\newline
Afin d'augmenter notre liberté de programmation, nous allons ici déclarer notre propre \bold{classe} qui va permettre l'exploitation de l'interface générée précédemment. Nous utiliserons ici des concepts de Programmation Orientée Object qui ne sont abordés normalement qu'en S5 à l'Enib\footnote{Cette notion est abordée dans le chapitre 7.3}. Mais pas d'inquiétude, cela ne vous empêchera pas de mener à bien votre projet.\newline
La déclaration de notre classe qui  va représenter notre fenêtre principale nécessite l'importation du module Python généré depuis le fichier QtDesigner. Si vous avez utilisés les mêmes noms que ceux utilisés dans ce tutoriel, la ligne permettant l'importation de ce module sera celle-ci :
\begin{Python}
from UI_pyFiles.MainWindow import Ui_MainWindow
\end{Python}
Dans le cas contraire, c'est à vous que revient la responsabilité de faire les modifications nécessaires.\\ 


Pour le moment, votre fichier doit donc ressembler à ceci
\footnote{ Profitons-en pour vous rappeler de sauvegarder régulièrement votre travail, \colors{red}{\bold{Ctrl+S}} n'est pas un raccourci compliqué à retenir et peut vous épargner bien des déconvenues.}
:
\begin{Python}
# -*- coding: utf-8 -*-
#on explicite l’encodage du fichier

#importation des modules nécessaires à Qt
from PyQt5 import QtCore, QtGui, QtWidgets

#importation du module nécessaire à la création de notre fenêtre principale
from UI_pyFiles.MainWindow import Ui_MainWindow
\end{Python}


Maintenant, rentrons au coeur du sujet. Nous pouvons dorénavant déclarer notre classe sans que Python ne nous insulte copieusement lorsque nous lancerons le programme
\footnote{Notons que pour le moment, nous ne pouvons pas vraiment tester le programme dans le sens où il ne fait rien et notre fichier main n'est pas encore préparé. Exécuter le fichier seul en dehors de la racine du projet provoquera certainement des erreurs dans les importations (il faudrait donc l'exécuter depuis le fichier \file{main.py} par exemple pour éviter les problèmes).\newline Rappelons ici que plus vous exécuterez votre code souvent, moins vous aurez d'erreurs à corriger à la fois. N'hésitez pas à l'exécuter dès que vous le pouvez (Nous verrons cela ensemble dans quelques temps).}.\newline
La déclaration de notre classe se fera de la manière suivante :
\begin{Python}
class MainWindow(QtWidgets.QMainWindow):
    #code
\end{Python}
Où \ib{MainWindow} correspond au type représentant notre fenêtre principale
\footnote
{Vous pouvez modifier ce nom comme bon vous semble mais que celui-ci a l'avantage indéniable d'être explicite.}
et la portion de code \ib{(QtWidgets.QMainWindow)} permet d'indiquer à Python que notre type \ib{MainWindow} \italic{hérite} des propriétés du type \ib{QtWidgets.QMainWindow}.\newline
Concrètement, notre type pourra faire tout ce que faisait une \ib{QMainWindow} du module \ib{QtWidgets} plus ce que nous lui apprendrons.


\subsubsection{Constructeur de notre classe}

Tout comme en C++, nous pouvons définir un constructeur
\footnote{Une fonction membre \_\_init\_\_ en Python n'est pas vraiment un constructeur mais un "initialiseur". Cependant, pour simplifier la compréhension nous utiliserons ici abusivement le terme constructeur. Pour un peu plus d'information à ce sujet : \url{https://www.geeksforgeeks.org/__new__-in-python/}}
pour notre classe. Celui-ci sera appelé lors de l'initialisation d'un nouvel objet de notre type \ib{MainWindow}.\newline
En Python, le constructeur d'une classe se définit de la manière suivante :
\begin{Python}
def __init__(self):
    #code
\end{Python}
Et il sera toujours définit de cette manière (aux paramètres près).\\

Profitons de ce moment pour attirer votre attention sur le paramètre \colors{red}{\ib{self}} qui est un paramètre particulièrement important\footnote{Pour plus d'informations sur self : \url{https://www.geeksforgeeks.org/self-in-python-class/}}. Il représente l'instance de la classe. Pour avoir un équivalent dans un langage mieux connu des élèves, c'est un peu comme le mot-clé \ib{this} en c++. Sauf qu'en python \colors{red}{\ib{self}} est beaucoup plus important, nous verrons après pourquoi.\newline
Ce paramètre \colors{red}{\bold{doit}} figurer dans tous les prototypes des fonctions membres d'une classe.\\

Revenons-en au constructeur de notre classe \ib{MainWindow}, il existe avec Qt un système de widget parent/enfant trop complexe à expliquer ici. Le principal est de savoir que ce système existe et que avec Qt, la plupart des widgets\footnote{À noter qu'une \ib{QMainWindow} est aussi un widget} instanciés doivent avoir un parent (pour des raisons trop complexes à aborder ici encore une fois). Ce qui implique que tous les widgets aient dans leurs constructeurs un paramètre représentant un potentiel widget parent.\vskip 0cm %Nouveau paragraphe sans saut de ligne
Nous devrions donc en toute rigueur laisser au programmeur (vous) la possibilité d'initialiser son type avec un widget parent (Même si c'est hautement improbable dans le cas d'une fenêtre principale puisque ce sera le premier widget que nous allons créer). Mais puisque c'est une bonne habitude à prendre quand l'on programme en utilisant des widgets et Qt, nous allons le faire.\newline
Ceci se traduit simplement par un paramètre \italic{parent} dans le constructeur pouvant représenter le parent de notre type héritant d'un widget Qt.\newline
Concrètement, le prototype de notre constructeur ressemblera à ceci:
\begin{Python}
def __init__(self,parent = None):
\end{Python}
Le morceau de code "\ib{parent = None}" permet de signaler à Python quand dans le cas où le programmeur ne spécifierait pas ce paramètre, sa valeur serait "\bold{None}", on appelle ça une \colors{red}{valeur par défaut}.\newline
Puisque tous les widgets de Qt autorisent leurs instanciations sans parent spécifié (même si ce n'est pas une bonne pratique), il sera d'usage de proposer une valeur par défaut "\ib{None}" au paramètre "\ib{parent}" d'un constructeur d'un type héritant d'un widget de Qt.\\

Nous avons la déclaration de notre constructeur, nous devons maintenant le définir.\newline
La première chose à faire est d'appeler le constructeur du type hérité, il s'agit d'une forme de délégation. Et pour cela, Python vous fournit un outil tout fait : la fonction "\bold{super()}"
\footnote
{En réalité, la fonction "\bold{super()}" est beaucoup plus complexe que cela, si vous voulez en savoir plus : \url{https://www.stashofcode.fr/comment-marche-fonction-super-de-python/}}
. Son utilisation est la suivante (Le constructeur complet est écrit dans le code ci-dessous) :
\begin{Python}
def __init__(self,parent = None):
		super().__init__(parent)
\end{Python}
Dans notre cas, en faisant cela, nous initialisons notre class en appelant le constructeur de \href{https://doc.qt.io/qt-5/qmainwindow.html}{QMainWindow}\newpage


Pour une meilleure vision d'ensemble, voici à quoi devrait ressembler votre fichier de définition de votre classe \ib{MainWindow} :
\begin{Python}
# -*- coding: utf-8 -*-
#on explicite l’encodage du fichier

#importation des modules nécessaires à Qt
from PyQt5 import QtCore, QtGui, QtWidgets

#importation du module nécessaire à la création de notre fenêtre principale
from UI_pyFiles.MainWindow import Ui_MainWindow

class MainWindow(QtWidgets.QMainWindow): #déclaration de la class MainWindow

	#déclaration du constructeur avec un possible parent
	def __init__(self,parent = None):
		#on appelle le constructeur de la class parent
		super().__init__(parent)
\end{Python}

En l'état, nous avons une fenêtre vide. Nous allons maintenant voir comment utiliser l'interface que nous avons précédemment créé avec QtDesigner.\newline
C'est ici que notre ligne d'importation du module généré par \bold{pyuic5} va nous servir. Si vous ne vous en souvenez pas, c'est celle-ci :
\begin{Python}
from UI_pyFiles.MainWindow import Ui_MainWindow
\end{Python}
La première étape est de d'initialiser une variable membre "interface graphique" dont le type portera le nom du fichier \ib{*.ui} que vous avez créé.\newline
C'est cette variable qui nous permettra d'accéder aux différents éléments de l'interface que nous avons mis en place.\newline
Puisque nous n'avons pas à accéder à ces éléments en dehors de notre classe, cette variable sera privée.\newline
En pratique, cela se traduit par l'instruction suivante :
\begin{Python}
self.__ui = Ui_MainWindow()
\end{Python}
Explications : 
Pour accéder à des variables membres de la classe, il est nécessaire en Python de \colors{red}{systématiquement} utiliser "\colors{blue}{\ib{self.}}"
\footnote{Vous l'oublierez certainement à plusieurs reprise. En cas d'oubli, vous ne ferez qu'accéder à des variables locales ce qui amènera à des erreurs peu explicites}. Dans notre cas, nous créons une variable membre de nom \italic{\_\_ui}.\newline
Ce nom n'a pas été choisi par hasard, en Python, toute variable membre dont le nom commence par "\_\_" est une variable privée. Quant au nom en lui même,  "\colors{green}{\bold{ui}}", il s'agit de l'abréviation anglaise de \bold{UserInterface}.\newline
Cette variable est initialisée avec le type de l'interface graphique que nous avons conçu plus tôt.\newline
\bold{En résumé} : Nous créons une variable membre privée dans notre classe qui nous permettra d'accéder à l'interface graphique.\\

Il faut maintenant lier notre interface à notre fenêtre principale. Pour le moment, les deux existent mais rien ne les relie si ce n'est que l'UI est une variable membre de notre classe \ib{MainWindow}. Hélas, ce n'est pas suffisant. Nous devons appeler une fonction pour dire que notre interface s'applique à notre fenêtre. Cette fonction est la suivante :
\begin{Python}
self.__ui.setupUi(self)
\end{Python}
Il n'y a pas grand chose à dire dessus, elle ne fait qu'affecter l'interface à notre fenêtre, c'est une fonction de la bibliothèque Qt.\\

Voici à quoi devrait maintenant ressembler votre fichier de définition de notre type \ib{MainWindow} :
\begin{Python}
# -*- coding: utf-8 -*-
#on explicite l’encodage du fichier

#importation des modules nécessaires à Qt
from PyQt5 import QtCore, QtGui, QtWidgets

#importation du module nécessaire à la création de notre fenêtre principale
from UI_pyFiles.MainWindow import Ui_MainWindow

class MainWindow(QtWidgets.QMainWindow): #déclaration de la class MainWindow

	#déclaration du constructeur avec un possible parent
	def __init__(self,parent = None):
		#on appelle le constructeur de la class parent
		super().__init__(parent)

		#initialisation de l'interface graphique
		self.__ui = Ui_MainWindow()
		#Affectation de l'interface à notre fenêtre principale
		self.__ui.setupUi(self)
\end{Python}


Notre fenêtre principale est maintenant prête à être affichée, c'est ce que nous allons aborder dans la section suivante.


\subsection{Affichage de notre fenêtre principale.}

Nous allons délaisser notre fichier \file{UI\_MainWindow.py} au profit du fichier \file{main.py}. En effet, si la définition de la fenêtre s'est faite dans un fichier, l'initialisation et l'affichage de notre fenêtre \underline{principale} se fera depuis le fichier \file{main.py}.\\

Pour le moment, le contenu du fichier \file{main.py} doit ressembler à ceci :
\begin{Python}
# -*- coding: utf-8 -*-
#on  explicite l’encodage  du  fichier

#importation des modules nécessaires à Qt
import sys
from PyQt5 import QtCore, QtGui, QtWidgets

#importation des modules d'interfaces graphiques créés
from UI_class.UI_MainWindow import MainWindow


if(__name__ == "__main__"): #si c'est ce module qui est lancé directement

	#code
\end{Python}

\subsubsection{Création d'une application Qt}

L'utilisation de Qt impose l'initialisation et l'exécution d'une "application" Qt pour faire fonctionner tous les éléments. C'est ce que nous allons voir ici.\newline
C'est la première étape, nous allons déclarer une application Qt, cela se fait assez simplement :
\begin{Python}
app = QtWidgets.QApplication(sys.argv)
\end{Python}
Très succinctement, nous déclarons ici une \ib{QApplication} en lui passant en paramètre les arguments fournis au programme
\footnote{Il s'agit en réalité des arguments de la ligne de commande (plus d'informations ici : \url{https://en.wikipedia.org/wiki/Command-line_argument_parsing}}.\newline
Maintenant que nous avons notre application, nous pouvons l'exécuter. Nous le ferons d'une manière assez condensée avec l'instruction suivante :
\begin{Python}
sys.exit(app.exec())
\end{Python}
Cette ligne réalise en réalité deux opérations :
\begin{enumerate}
    \item \bold{Éxécution de l'application} : ceci est réalisé par l'appel de de "\italic{app.exec()}". Cette fonction retourne un "statut d'exécution de l'application Qt"\footnote{Il s'agit d'un code permettant de savoir si un programme s'est exécuté correctement.\newline
    Plus d'informations ici : \url{https://en.wikipedia.org/wiki/Return_statement}}.
    
    \item \bold{Quitter le programme python} : ceci est réalisé par la fonction "\italic{sys.exit()}"\footnote{Plus d'informations sur cette fonction ici \url{https://python101.pythonlibrary.org/chapter20_sys.html}} qui prend en argument un statut d'exécution à retourner au système d'exploitation.
\end{enumerate}
L'utilisation de "\italic{app.exec()}" en argument de "\italic{sys.exit()}" permet donc de faire quitter le programme Python en renvoyant au système le statut d'exécution de l'application Qt lorsque celle-ci est terminée.\\

Vous devriez dorénavant avoir un code ressemblant à ceci :
\begin{Python}
#si c'est ce module qui est lancé directement
if(__name__ == "__main__"):

	#déclaration de l'application Qt
	app = QtWidgets.QApplication(sys.argv)
	#exécution de l'application Qt
	sys.exit(app.exec())
\end{Python}
Le problème étant que ce code n'utilise pas encore notre fenêtre principale que nous avons définit plus tôt.\newline
Ce sera donc la prochaine étape, déclarer et afficher notre fenêtre.

\subsubsection{Affichage de la fenêtre principale}

Nous avons créé notre type \ib{MainWindow} pour pouvoir manipuler une fenêtre principale, il nous faut maintenant l'utiliser.\newline
Tout le code que nous allons écrire sera placé avant la ligne
\begin{Python}
    #exécution de l'application Qt
	sys.exit(app.exec())
\end{Python}
Puisque celle-ci signe la fin du programme. Tout le code placé après ne sera pas exécuté.\\

Pour cela, il nous suffit de déclarer une variable de notre type \ib{MainWindow} puis de l'afficher.\newline
Vérifiez tout d'abord que vous importez bien le type que nous avons créé depuis le bon module :
\begin{Python}
#importation du module d'interface graphique créé
from UI_class.UI_MainWindow import MainWindow
\end{Python}
Si c'est déjà le cas, vous n'avez plus qu'à déclarer une variable utilisant ce type, par exemple :
\begin{Python}
mainWindow = MainWindow()
\end{Python}
Et pour la voir apparaître, il suffit d'appeler une fonction : "\italic{show()}" sur cette variable, ce qui donne :
\begin{Python}
mainWindow.show()
\end{Python}



\subsubsection{Lancement du programme}
\label{tag-startProgFromCmdLine}
Il est maintenant possible de lancer notre programme et de voir le résultat de tout ce que nous avons fait jusqu'à maintenant.\newline
Pour cela, comme cela a été conseillé auparavant, nous passerons par un terminal pour lancer le programme en suivant ces étapes :
\begin{enumerate}
\item Lancez un terminal
    
\item Placez vous dans la racine du projet (à l'aide de la commande \colors{blue}{\bold{cd}})
    
\item Lancez le programme en utilisant la commande suivante qui fera exécuter le fichier "\bold{main.py}" :
\begin{Python}
    python main.py
\end{Python}
\end{enumerate}



Dans le cas où Python ne trouverait aucune erreur, vous devriez voir apparaître à l'écran quelque chose de ce type :

\img{\rootImages/enibSup_window_firstMainWindow.png}{Résultat de l'exécution de votre programme}{0.27}




\chapter{Réalisation d'un programme ENIBSupervision}

Dans ce chapitre, nous travaillerons principalement dans le fichier de définition de la fenêtre principale du programme. Dans notre cas il s'agit du fichier \ib{UI\_MainWindow.py}.\\




\section{Variable automate}

Les outils développés dans le module \bold{enibSupervision} ont été conçus pour fonctionner avec une liste de variables de type \ib{PLCVar}.\\

Dans notre cas, je vous invite à stocker cette liste de variables en tant que variable membre de notre classe \ib{MainWindow} (qui est maintenant au coeur de notre programme) afin que nous puissions nous en servir à d'autres occasions

\subsection{Pré-requis}

Afin de pouvoir utiliser le type \ib{PLCVar}, vous aurez besoin de l'importer, ceci peut se faire de la manière suivate :
\begin{Python}
from ENIBSupervision.PLC.Variable import PLCVar
\end{Python}

\subsection{Fonction d'initialisation}

Je vous propose de créer une fonction qui nous servira à initialiser nos variables. Bien que ce ne soit pas une obligation, cela améliorera la lisibilité de notre code.\newline
Cette fonction sera un membre de la classe \ib{MainWindow}.\newline
Il suffit pour cela de déclarer la fonction après le constructeur de la classe.\newline
Je vous propose d'appeler cette fonction \italic{initVarList}.\\

\begin{Python}

    def __init___(self, parent=None):
        # on appelle le constructeur de la class parent
        super().__init__(parent)
        #initialisation de l’interface graphique
        self.__ui = Ui_MainWindow()
        # Affectation de l’interface à notre fenêtre principale
        self.__ui.setupUi(self)    

    def initVarList(self):

        varList = []  #initialisation de la liste de variables
        #Déclaration des variables effectuées ici
        return varList  # on retourne la liste de variables

\end{Python}

Cette méthode retournera donc une liste contenant toutes les variables de l'automate.\\


\subsection{Ajout de l'automate}

\bold{Étant donné qu'il est possible de définir plusieurs automates avec le logiciel}, nous allons déclarer une liste dans le constructeur qui contiendra les potentiels automates, dont celui du projet. \\
La liste de variables ainsi obtenue doit être stockée dans une variable membre de notre classe \ib{MainWindow}\\
Pour le code d'exemple, nous allons créer deux automates appelés "Automate Test 0" et "Automate Test 1" depuis le constructeur de la classe.\\

Le premier argument passé est l'adresse IP de l'automate, le second le nom et le dernier concerne la liste des variables associées.

\begin{Python}

	# déclaration du constructeur avec un possible parent
	def __init__(self, parent=None):
		# on appelle le constructeur de la class parent
		super().__init__(parent)

		# initialisation de l’interface graphique
		self.__ui = Ui_MainWindow()
		# Affectation de l’interface à notre fenêtre principale
		self.__ui.setupUi(self)

		# déclaration de l’automate
		tempPLC = ModbusPLC("127.0.0.1","Test 0",self.initVarList())
		self.__plcClientList = [tempPLC]
		#index de l'automate actuellement sélectionné
		self.__plcSelected = 0

		#ajout d'un deuxième automate
		tempPLC = ModbusPLC("127.0.0.1","Test 1",self.initVarList())
		self.__plcClientList.append(tempPLC)
\end{Python}

Il ne nous reste plus qu'à compléter la fonction d'affectation des variables de l'automate.\footnote{\colors{red}{Ou presque !} Il faudra ensuite "lancer" l'automate mais ceci sera abordé dans la section "Gestion pseudo-événementielle"}


\subsection{Déclaration d'une variable}

Voici le prototype du constructeur du type \ib{PLCVar}\footnote{Pour plus d'informations sur ce type et son constructeur, se référer à la documentation} :
\begin{Python}
PLCVar(name,address,description,varType,varMode,f_connectedSlots = []):
\end{Python}
Pour un descriptif rapide des paramètres :
\begin{enumerate}
\item \bold{name} : C'est le nom de la variable, chaque nom doit être unique, on préférera éviter les caractères spéciaux et les espaces.

\item \bold{address} : C'est l'index de l'adresse dans l'automate. Par exemple 1 pour \%M1 ou \%MW1 (nous verrons après que l'adresse est aussi déterminée par le type de la variable). Ce paramètre attend un \bold{entier}.

\item \bold{description} : Il s'agit d'une description de la variable.

\item \bold{varType} : il s'agit du type de la variable aux yeux de l'automate. On ne peut pas utiliser n'importe quel type, pour le moment, seuls sont supportés : 

\begin{enumerate}
    \item "BIT"
    \item "WORD"
    \item "DWORD"
    \item "TIME"
    \item "INT"
\end{enumerate}

Ce type est très important, c'est lui qui va fixer les fonctions à utiliser pour communiquer avec l'automate et qui servira à convertir les données si besoin est.

\item \bold{varMode} : Il s'agit du mode de fonctionnement de la variable soit \ib{INPUT} ou \ib{OUTPUT}

\item \bold{f\_connectedSlots} : Il s'agit d'une liste de fonction à appeler lorsqu'un changement de valeur est détecté avec une \ib{EventsLoop} (nous verrons cela un peu plus tard). Cet argument est optionnel.
\end{enumerate}


Maintenant que nous savons ce qu'il faut fournir pour déclarer une variable de ce type, nous n'avons plus qu'à le faire. Nous allons aborder deux exemples qui donneront une idée de ce qu'il est possible de faire.

\begin{enumerate}


\item \bold{Variable "\italic{BIT}"}\newline
Nous allons ici déclarer une variable de type "\italic{BIT}" à l'adresse "\italic{\%M5}" qui représentera l'état d'un bouton "\italic{dcy}" qui fonctionnera donc comme une entrée.\newline
La déclaration de cette variable directement dans la liste liste \bold{varList} se fera de la manière suivante :
\begin{Python}
varList.append(PLCVar("dcy",5,"Bouton permettant de lancer un cycle","BIT","INPUT"))
\end{Python}

\item \bold{Variable "\italic{WORD}"}\newline
Puis une variable de type "\italic{WORD}" à l'adresse "\italic{\%MW0}" qui représentera la nouvelle valeur d'un compteur ("\italic{new\_cycle\_count}") qui fonctionnera donc comme une sortie.\newline
La déclaration de cette variable directement dans la liste liste \bold{varList} se fera de la manière suivante :
\begin{Python}
varList.append(PLCVar("new_cycle_count",0,"Nouveau nombre de cycle à exécuter","WORD","OUTPUT"))
\end{Python}

\end{enumerate}

Nous rajouterons une troisième variable, elle aussi de type "BIT" pour pouvoir exposer un autre élément du code un peu plus tard.

Le code de votre fonction d'initialisation devrait donc maintenant ressembler à ceci :
\begin{Python}
    def __init__(self, parent=None):
    
        #code constructeur...
        
    def initVarList(self):
	    varList = [] #initialisation de la liste de variables

    	#déclarations des différentes variables
	    varList.append(PLCVar("dcy",5,"Bouton permettant de lancer un cycle","BIT","INPUT"))

    	varList.append(PLCVar("new_cycle_count",0,"Nouveau nombre de cycle à exécuter","WORD","OUTPUT"))
    	
    	varList.append(PLCVar("alarmButton", 6, "Bouton d'alarme","BIT","INPUT"))

	    return varList  #on retourne la liste de variables
\end{Python}





\subsection{Affichage d'une variable dans le terminal}

Lors du débogage par exemple, vous pourriez avoir besoin d'afficher dans la console une variable. Nous allons voir comment afficher une variable présente dans une liste dans un terminal.\newline
Nous utiliserons le même code, donc les mêmes variables que dans les exemples ci-dessus.\newline
Le code que nous allons écrire\footnote{A l'exception de l'importation des modules bien entendu} prendra place dans le constructeur du type "\ib{MainWindow}", après l'initialisation de la liste de variables et de l'automate (cette ligne là : )
\begin{Python}
# déclaration de l’automate
self.__plcClientList = [ModbusPLC("127.0.0.1","Automate Test 0",self.initVarList())]
\end{Python}


Imaginons que nous souhaitions afficher la variable "\italic{dcy}". Deux solutions s'offrent à nous pour trouver cette variable dans la liste:
\begin{enumerate}
\item Vous vous souvenez de l'index de la variable et vous pouvez écrire cet index "en dur", directement dans le code. Cette solution n'est pas la meilleure, en effet, si pour une raison quelconque l'index de la variable change, le résultat obtenu ne sera plus celui attendu.

\item Vous utilisez une fonction fournie dans le module \\ "\ib{ENIBSupervision.PLC.Variable}" qu'il vous faudra donc \bold{importer}, en utilisant par exemple :
\begin{Python}
import ENIBSupervision.PLC.Variable as PLCVariable
\end{Python}
Et la fonction qui nous intéresse est "\ib{findVariableInList}" qui permet de retourner l'index de la variable recherchée dans une liste. Voici son prototype :
\begin{Python}
def findVariableInList(varList,varName):
\end{Python}
Cette fonction retourne l'index de la variable ou -1 si celle-ci n'a pas été trouvée.
\end{enumerate}


Nous préférerons ici utiliser la deuxième solution. Pour afficher la variable "\italic{dcy}", nous devons donc en premier lieu récupérer son index dans notre liste. Vous avez tous les éléments pour effectuer cette tâche, cette opération se traduit par exemple par ceci :
\begin{Python}
tmp_varList = self.initVarList()
#self.initVarList retourne la liste des variables de l'automate
dcyIndex = PLCVariable.findVariableInList(tmp_varList,"dcy")
\end{Python}
Une fois que nous avons son index, nous pouvons nous en servir pour afficher la variable dans le terminal :
\begin{Python}
print(str(tmp_varList[dcyIndex]))
\end{Python}
Explications :\newline
La fonction "\italic{print()}" permet d'afficher quelque chose dans le terminal.\newline
La fonction "\italic{str()}" permet de convertir un élément en chaîne de caractère.\newline
Et "\italic{tmp\_varList[dcyIndex]}" permet d'accéder à l'élément de la liste "\italic{tmp\_varList}" à l'index "\italic{dcyIndex}".\\





%%%%% HALTE
%%%%% Nico



Voici maintenant à quoi devrait ressembler le constructeur de votre type "\ib{MainWindow}" :
\begin{Python}

	# déclaration du constructeur avec un possible parent
	def __init__(self, parent=None):
        # on appelle le constructeur de la class parent
        super().__init__(parent)

        # initialisation de l’interface graphique
        self.__ui = Ui_MainWindow()
        # Affectation de l’interface à notre fenêtre principale
        self.__ui.setupUi(self)

        # déclaration de l’automate
        tempPLC = ModbusPLC("127.0.0.1","Test 0",self.initVarList())
        self.__plcClientList = [tempPLC]    
		#index de l'automate actuellement sélectionné
        self.__plcSelected = 0
        #lancement de l'automate sélectionné
        self.__plcClientList[self.__plcSelected].start()

        #ajout d'un deuxième automate
        tempPLC = ModbusPLC("127.0.0.1","Test 1",self.initVarList())
        self.__plcClientList.append(tempPLC)

        # récupération de l’index de la variable "dcy"
        tmp_varList = self.initVarList()
        #self.initVarList() retourne la liste des variables de l'automate
        dcyIndex = PLCVariable.findVariableInList(tmp_varList,"dcy")
        print(str(self.__plcClientList[self.__plcSelected].varList()[dcyIndex]))

\end{Python}


Vous n'avez maintenant plus qu'à lancer le programme
et vous devriez voir s'afficher un résultat de ce type :
\img{\rootImages/enibSup_result_printPLCVar.png}{Résultat du programme dans un terminal}{0.4}




\section{Gestion pseudo-événementielle}

Nous avons plusieurs solutions entre : 
\begin{enumerate}
\item Rédiger manuellement toutes les interactions avec l'automate : lecture et écriture des variables
\item Utiliser le type \ib{EventsLoop} du module \lib{ENIBSupervision} qui fera (presque) tout à votre place.
\end{enumerate}
Vous imaginez bien que nous préférerons ici la deuxième solution.\\
Nous avons décidés d'automatiser la communication des variables au sein du module 
\lib{ModbusPLC} afin de simplifier la gestion de ces dernières. \\
Si vous préférez la première, les outils de ce module ne fonctionneront pas ou mal.\\

Lors de la création d'un automate avec l'instruction suivante :
\begin{Python}
ModbusPLC("127.0.0.1","Automate Test 0",self.initVarList())
\end{Python}
Une boucle d'évènement est associée et permet d'appeler des fonctions lors de changements d'états des variables. \\
Cette boucle d'événement correspond au type \ib{EventsLoop} du module \lib{ENIBSupervision}. Elle existe mais l'utilisateur n'a normalement pas à intéragir directement avec elle. C'est pour cela que nous n'aborderons pas son fonctionnement exact ici.\\

Cependant, pour économiser de la puissance de calcul, lorsque l'automate est instancié, la boucle d'événements est par défaut "stoppée". Il faut donc la lancer pour que celle-ci puisse fonctionner. Cela se fait par le biais de la commande :
\begin{Python}
	#lancement de l'automate sélectionné
	self.__plcClientList[self.__plcSelected].start()
\end{Python}

\colors{red}{Si vous oubliez cette étape, votre programme risque de ne pas fonctionner} (c'est même le cas le plus probable)


Si vous exécutez le programme sans que l'automate ne soit accessible, vous devriez voir plusieurs messages d'erreurs apparaître comme ici :

\img{\rootImages/enibSup_error_cannotConnectToPLC.png}{Messages d'erreurs typiques}{0.3}

Ceux-ci ne font que prévenir l'utilisateur qu'il est impossible de se connecter à l'automate pendant l'écriture/la lecture d'une variable tout en précisant celle-ci.


Maintenant que nous avons mis en place les outils essentiels pour le bon fonctionnement de la suite, nous allons aborder les outils plus avancés mis à la disposition des utilisateurs du module \lib{ENIBSupervision}.\\

Mais avant ça, voici un petit rappel de ce à quoi votre fichier \\
\file{UI\_MainWindow.py} devrait ressembler au complet : %COMPLETE_FILE
\begin{Python}

# -*- coding : utf-8 -*-
# on explicite l’ encodage du fichier

# importation des modules nécessaires à Qt
from PyQt5 import QtCore, QtGui, QtWidgets

import time

# importation du module nécessaire à la création de notre fenêtre principale
from UI_pyFiles.MainWindow import Ui_MainWindow

# importation des modules de supervision
from ENIBSupervision.PLC.Variable import PLCVar
import ENIBSupervision.PLC.Variable as PLCVariable
import ENIBSupervision.EventsLoop as EventsLoop
from ENIBSupervision.UI_class.UI_AnimationTables import AnimationTables
from ENIBSupervision.PLC.ModbusPLC import ModbusPLC

import ENIBSupervision.PLC.Communication as Com


class MainWindow (QtWidgets . QMainWindow):  # déclaration de la class MainWindow

	# déclaration du constructeur avec un possible parent
	def __init__(self, parent=None):
        # on appelle le constructeur de la class parent
        super().__init__(parent)

        # initialisation de l’interface graphique
        self.__ui = Ui_MainWindow()
        # Affectation de l’interface à notre fenêtre principale
        self.__ui.setupUi(self)

        # déclaration de l’automate
        tempPLC = ModbusPLC("127.0.0.1","Test 0",self.initVarList())
        self.__plcClientList = [tempPLC]    
		#index de l'automate actuellement sélectionné
        self.__plcSelected = 0
        #lancement de l'automate sélectionné
        self.__plcClientList[self.__plcSelected].start()

        #ajout d'un deuxième automate
        tempPLC = ModbusPLC("127.0.0.1","Test 1",self.initVarList())
        self.__plcClientList.append(tempPLC)
        
       
		#lancement de l'automate sélectionné
		self.__plcClientList[self.__plcSelected].start()

        # récupération de l’index de la variable "dcy"
        tmp_varList = self.initVarList()
        #self.initVarList() retourne la liste des variables de l'automate
        dcyIndex = PLCVariable.findVariableInList(tmp_varList,"dcy")
        print(str(self.__plcClientList[self.__plcSelected].varList()[dcyIndex]))


    def initVarList(self):
	    varList = [] #initialisation de la liste de variables

        #déclarations des différentes variables
	    varList.append(PLCVar("dcy",5,"Bouton permettant de lancer un cycle","BIT","INPUT",self.dcyStateChanged))
        #On relie la variable à la méthode "dcyStateChanged" de MainWindow (dernier argument passé)

    	varList.append(PLCVar("new_cycle_count",0,"Nouveau nombre de cycle à exécuter","WORD","OUTPUT"))

        varList.append(PLCVar("alarmButton", 6, "Bouton d'alarme","BIT","INPUT", self.checkAlarm)) #ajout de la variable

	    return varList  #on retourne la liste de variables

\end{Python}



\section{Connexion d'une fonction à une variable}

Le module \lib{ENIBSupervision} permet d'associer une fonction à un changement d'état d'une variable
\footnote{Il est possible d'associer \bold{plusieurs fonctions} au changement d'état d'\bold{une} variable.}
.\newline

Nous verrons deux possibilités pour associer un changement d'état de variable à une fonction.\newline
\begin{enumerate}
    \item \bold{Association à l'instanciation}\newline Cette méthode, la plus simple, permet d'associer une fonction au changement d'état de la variable lors de la déclaration de celle-ci
    
    \item \bold{Indépendante}\newline Cette méthode, la plus générique, permet d'associer une fonction au changement d'état de la variable n'importe quand dans le programme.
\end{enumerate}


Pour la deuxième possibilité, nous allons donc créer une variable d'entrée "alarmButton" avec l'adresse 6, de type "BIT" et de désignation "Bouton d'alarme". \newline Cette variable sera crée dans la fonction initVarList et ajoutée à l'automate. \newline
\begin{Python}
    #... autres variables déja crées
    
    varList.append(PLCVar("alarmButton", 6, "Bouton d'alarme","BIT","INPUT", self.checkAlarm))
    
    return varList
\end{Python}

\subsection{Généralités}

Les fonctions associées au changement d'état d'une variable doivent recevoir un paramètre, celui-ci correspond à la variable modifiée.
Dans le cas d'une fonction non-membre, le prototype ressemblera à ceci :
\begin{Python}
def function(var):
\end{Python}
Et dans le cas d'une fonction membre :
\begin{Python}
def function(self,var):
\end{Python}

\subsection{Association à l'instanciation}

L'association à l'instanciation se fait extrêmement simplement en passant en dernier paramètre le nom de la fonction à associer.\newline
Pour l'exemple, nous allons tout d'abord créer une fonction à associer au changement d'état de la variable "dcy". Celle-ci ne fera qu'afficher un message avec la valeur de la variable dans la console mais elle sera une fonction membre de la classe \ib{MainWindow} pour se rapprocher d'un cas d'utilisation réél (impactant l'interface).\newline
Sa définition sera donc :
\begin{Python}
def dcyStateChanged(self,var):
		print("dcy state has changed : "+str(var.getVarValue()))
\end{Python}

Pour associer cette fonction au changement d'état de la variable dcy, il nous faut maintenant modifier la déclaration de celle-ci comme expliqué plus haut, ce qui se résume à \footnote{Dans la fonction \italic{initVarList}} :
\begin{Python}
#déclarations des différentes variables
varList.append(PLCVar("dcy",50,"Bouton permettant de lancer un cycle","BIT","INPUT",self.dcyStateChanged))
#On relie la variable à la méthode "dcyStateChanged" de MainWindow (dernier argument passé)
\end{Python}
 Et voilà ! Maintenant, dès que l'état de la variable "dcy" sera modifié dans l'automate, cette fonction sera appelée et affichera dans le terminal la valeur de "dcy".
 
 \subsection{Association "Indépendante"}
 
 Cette méthode permet d'associer le changement d'état d'une variable à une fonction n'importe où dans le programme.
\newline
Cette méthode est strictement identique à l'usage que l'on a des signaux et slots Qt. Ce qui est normal puisque ce sont des signaux Qt qui sont utilisés.

\colors{red}{\bold{Tous les signaux créés spécialement pour le module}} \lib{ENIBSupervision} \colors{red}{\bold{commencent par le préfixe "sig\_"}}


Pour cet exemple, nous allons associer notre nouvelle variable "alarmButton" à une fonction qui affiche son état.\newline
Il faut donc commencer par définir cette fonction (elle est aussi membre de \ib{MainWindow}) :
\begin{Python}
def checkAlarm(self,var):
		#alarme
		print("checking alarm")
\end{Python}

Puis il faut ensuite associer le changement d'état de notre variable à notre fonction. Cette fois, nous ne changerons pas la déclaration mais rajouterons une instruction pour les connecter.\newline
Cette instruction prendra place juste après sa déclaration et nous utiliserons le signal de \ib{PLCVar} : \italic{sig\_valueChanged} :
\begin{Python}
#On relie la variable à la méthode "checkAlarm" de MainWindow
varList[-1].sig_valueChanged.connect(self.checkAlarm)
\end{Python}
Cette instruction ne fait rien d'autre que relier le signal \italic{sig\_valueChanged} du dernier élément de la liste \bold{varList} à la fonction \italic{self.checkAlarm}.\newline
D'où l'importance de la placer juste après la déclaration de la variable "alarmButton", ce qui devrait vous donner au final pour la fonction \italic{initVarList} :

\begin{Python}
def initVarList(self):
	varList = []  #initialisation de la liste de variables


	#déclarations des différentes variables
	varList.append(PLCVar("dcy",50,"Bouton permettant de lancer un cycle","BIT","INPUT",self.dcyStateChanged))
	#On relie la variable à la méthode "dcyStateChanged" de MainWindow (dernier argument passé)

	varList.append(PLCVar("new_cycle_count",0,"Nouveau nombre de cycle à exécuter","WORD","OUTPUT"))

	varList.append(PLCVar("alarmButton", 51, "Bouton d'alarme","BIT","INPUT")) #ajout de la variable
	#On relie la variable à la méthode "checkAlarm" de MainWindow
	varList[-1].sig_valueChanged.connect(self.checkAlarm)

	return varList  # on retourne la liste de variables
\end{Python}


\section{Tables d'animations}

Nous arrivons maintenant dans les outils graphiques proposés par le module \lib{ENIBSupervision}.\newline
Nous allons voir dans cette section comment créer facilement et rapidement des tables d'animations utilisables.\newline
Ces tables d'animations se présentent sous la forme d'une fenêtre dockable.\\

La création de ces tables se fait en deux lignes. Il suffit de les déclarer et les affichers.\newline
Cependant, nous en avons maintenant l'habitude, il nous faut tout d'abord importer le type (\ib{AnimationTables}) nécessaire depuis le module adapté, le module \lib{ENIBSupervision.UI\_class.UI\_AnimationTables}, cela se traduit par :
\begin{Python}
from ENIBSupervision.UI_class.UI_AnimationTables import AnimationTables
\end{Python}


Voici le prototype du type \ib{AnimationTables} :
\begin{Python}
AnimationTables(plcVarList,parent = None,qdockWidgetArea = QtCore.Qt.RightDockWidgetArea)
\end{Python}
Et une description rapide des arguments :
\begin{enumerate}
    \item \bold{plcVarList} : Il s'agit d'une liste de variables de type "\ib{PLCVar}"
    \item \bold{parent} : Il s'agit du widget Qt parent de nos tables d'animations. Souvenez-vous, je vous avais dit qu'il était d'usage de fournir à un widget Qt un parent. Ici, \ib{AnimationTables} est un type pour lequel ce parent est important pour profiter de toutes les possibilités offertes.
    \item \bold{qdockWidgetArea} : il s'agit de la zone dans laquelle les tables d'animations seront dockées par défaut. C'est un paramètre un peu particulier, voici quelques exemples de valeurs acceptées :
    \begin{enumerate}
        \item \italic{QtCore.Qt.RightDockWidgetArea}
        \item \italic{QtCore.Qt.LeftDockWidgetArea}
        \item \italic{QtCore.Qt.BottomDockWidgetArea}
        \item \italic{QtCore.Qt.TopDockWidgetArea}
    \end{enumerate}
\end{enumerate}


Maintenant que nous voyons à peu près comment initialiser les tables d'animations, voici comment l'on pourrait faire en pratique :
\begin{Python}
self.__animTables = AnimationTables(self.__plcClientList[self.__plcSelected].varList(), self)
\end{Python}
\bold{Nous allons placer cette instruction à la fin du constructeur de classe}.
Si l'on analyse rapidement cette déclaration, on constate que nous ne faisons que initialiser une variable \bold{self.\_\_animTables} avec comme liste de variables \\ \italic{self.\_\_plcClientList[self.\_\_plcSelected].varList()} [en choisissant l'index de l'automate] et comme parent, notre \ib{MainWindow}.\newline
Notez que c'est à nouveau une variable membre de notre class \ib{MainWindow} car encore une fois, nous pourrions en avoir besoin dans d'autres fonctions.\\

Nous avons déclaré nos tables, nous n'avons plus qu'à les afficher, ce qui se fera à l'aide de la fonction membre \italic{.show()} (toujours à la fin du constructeur).
En mettant ce code dans le constructeur, nous instancions et affichons les tables d'animation.
\begin{Python}

def __init___(self, parent=None):

    #code précédent ...
    
    self.__animTables = AnimationTables(self.__plcClientList[self.__plcSelected].varList(), self)
    self.__animTables.show() #on les affiche
    
def initVarList(self):
    #...
\end{Python}



Vous devriez maintenant avoir des tables d'animations que vous pouvez "détacher" de la fenêtre principale, manipuler normalement. Je vous laisse explorer les possibilités.\newline
Voici le type de résultat que vous devriez obtenir :
\img{\rootImages/enibSup_window_animationTables.png}{Tables d'animations dans\protect\\la fenêtre principale}{0.4}


\subsection{Ouvrir les tables d'animations}

Il est possible de créer un bouton et de demander qu'à chaque appui, il ouvre les tables d'animations.

Pour cela, rien de plus simple :

\begin{enumerate}
    \item On créer un bouton avec QtDesigner que l'on appelle "start\_tableAnimat"
    \item On crée une fonction membre appelée \italic{showTables} qui, à chaque appel, se contentera d'ouvrir et d'afficher les tables d'animations de l'automate.
    
    \begin{Python}
        def initVarList(self):
        
            #...
        
        def showTables(self):
            #Ouverture des tables d'animations
            self.__animTables.show()
    \end{Python}
    \item On relie le signal du bouton à la fonction membre \italic{showTables()} \bold{dans le constructeur}' \footnote{En cas d'oubli de méthode, le rappel est au chapitre 8.6}
    
    \begin{Python}
        self.__ui.start_tableAnimat.clicked.connect(self.showTables)
    \end{Python}
   
\end{enumerate}

Et voila, à chaque appui sur le bouton, lorsque les tables d'animations seront fermées, elles s'ouvriront.

\subsection{Modifier l'état d'une variable de l'automate}

Nous allons maintenant voir comment modifier l'état d'une variable dans l'automate.\newline
Nous allons tout d'abord rechercher la variable qui nous intéresse puis modifier son état.

Pour l'exemple, nous modifierons la variable "new\_cycle\_count" de l'automate actuellement sélectionné.\newline
Nous ferons en sorte que lorsque nous appuyons sur le bouton "start" de l'interface graphique, cette variable soit incrémentée mais tout en maintenant sa valeur dans l'intervalle [0;10[ : lorsque la valeur de la variable atteint 9, elle vaudra 0 la prochaine fois.\newline
Pour cela nous allons créer une nouvelle fonction qu'il nous faudra \bold{connecter à l'appui sur le bouton "start"} : \italic{incrementNewCycleCount} qui exécutera l'action que nous avons expliqués plus haut.\\
Voici le code au complet détaillé de la fonction permettant cette action :

\begin{Python}
def incrementNewCycleCount(self):
	#on accède à la liste de variables visée : celle de l'automate sélectionné
	tempVarList = self.__plcClientList[self.__plcSelected].varList()

	#on récupère l'index de la variable dans cette liste
	varIndex = PLCVariable.findVariableInList(tempVarList,"new_cycle_count")

	#on calcule la nouvelle valeur
	newVal = (tempVarList[varIndex].getVarValue()+1)%10

	#on affecte la nouvelle valeur à la variable automate
	tempVarList[varIndex].setVarValue(newVal)
\end{Python}
Le code ci-dessus contient le détail de toutes les opérations nécessaires.\newline
Notez que l'affectation en elle-même ne se fait qu'en une seule ligne.\\

Encore une fois, n'oubliez pas de connecter cette fonction au click du bouton (par cohérence, nous ne pouvons que vous inviter à placer cette connexion juste après celle déjà existante) ce qui devrait vous donner :
\begin{Python}
self.__ui.pb_start.clicked.connect(self.showAnimTables)
self.__ui.pb_start.clicked.connect(self.incrementNewCycleCount)
\end{Python}


Et voilà ! Si vous lancez le programme, vous devriez constater que à chaque clic sur le bouton, cette variable s'incrémentera au niveau de l'automate.

\chapter{Code de l'exemple au complet}


\newpage
\section{main.py}

\begin{Python}

# -*- coding : utf-8 -*-
#on explicite l’ encodage du fichier

# importation des modules né cessaires à Qt
import sys
from PyQt5 import QtCore , QtGui , QtWidgets

# importation du module d’interface graphique créé
from UI_class.UI_MainWindow import MainWindow

from ENIBSupervision.Utils import Debug as EDebug
from ENIBSupervision.PLC import ModbusPLC


def main():
	app = QtWidgets.QApplication (sys.argv)

	mainWindow = MainWindow ()
	mainWindow.show ()

	#exécution de l’application Qt
	sys.exit(app.exec())

#si c’est ce module qui est lancé directement
if( __name__ == "__main__") :
	
	main()

	client = ModbusPLC.ModbusPLC("127.0.0.1","Auto")
	client.connect()
	EDebug.debuggingTool(client)


\end{Python}

\newpage
\section{UI\_class/UI\_MainWindow.py}

\begin{Python}

# -*- coding : utf-8 -*-
# on explicite l’ encodage du fichier

# importation des modules nécessaires à Qt
from PyQt5 import QtCore, QtGui, QtWidgets

import time

# importation du module nécessaire à la création de notre fenêtre principale
from UI_pyFiles.MainWindow import Ui_MainWindow

# importation des modules de supervision
from ENIBSupervision.PLC.Variable import PLCVar
import ENIBSupervision.PLC.Variable as PLCVariable
import ENIBSupervision.EventsLoop as EventsLoop
from ENIBSupervision.UI_class.UI_AnimationTables import AnimationTables
from ENIBSupervision.PLC.ModbusPLC import ModbusPLC

import ENIBSupervision.PLC.Communication as Com


class MainWindow (QtWidgets . QMainWindow):  # déclaration de la class MainWindow

	# déclaration du constructeur avec un possible parent
	def __init__(self, parent=None):
		# on appelle le constructeur de la class parent
		super().__init__(parent)

		# initialisation de l’interface graphique
		self.__ui = Ui_MainWindow()
		# Affectation de l’interface à notre fenêtre principale
		self.__ui.setupUi(self)

		# déclaration de l’automate
		self.__plcClientList = [ModbusPLC("127.0.0.1","Automate Test 0",self.initVarList())]
		#index de l'automate actuellement sélectionné
		self.__plcSelected = 0
		#lancement de l'automate sélectionné
		self.__plcClientList[self.__plcSelected].start()

		#ajout d'un deuxième automate
		self.__plcClientList.append(ModbusPLC("127.0.0.1","Automate Test 1",self.initVarList(),"Description automate 1"))


		#lancement de l'automate sélectionné
		self.__plcClientList[self.__plcSelected].start()

		# récupération de l’index de la variable "dcy"
		#dcyIndex = PLCVariable.findVariableInList(self.__plcClientList[self.__plcSelected].varList(), "dcy")
		# affichage de la variable
		#print(str(self.__plcClientList[self.__plcSelected].varList()[dcyIndex]))

		#déclaration des tables d’animations
		self.__animTables = AnimationTables(self.__plcClientList[self.__plcSelected].varList(), self)
		#self.__animTables.show()  # on les affiche

		self.__ui.pb_start.clicked.connect(self.showAnimTables)
		self.__ui.pb_start.clicked.connect(self.incrementNewCycleCount)

	
	#SLOTS UI
	def checkAlarm(self,var):
		#alarme
		print("checking alarm : "+str(var.getVarValue()))
	
	def dcyStateChanged(self,var):
		print("dcy state has changed : "+str(var.getVarValue()))

	def showAnimTables(self):
		self.__animTables.show()
	
	def incrementNewCycleCount(self):
		#on accède à la liste de variables visée : celle de l'automate sélectionné
		tempVarList = self.__plcClientList[self.__plcSelected].varList()

		#on récupère l'index de la variable dans cette liste
		varIndex = PLCVariable.findVariableInList(tempVarList,"new_cycle_count")

		#on calcule la nouvelle valeur
		newVal = (tempVarList[varIndex].getVarValue()+1)%10

		#on affecte la nouvelle valeur à la variable automate
		tempVarList[varIndex].setVarValue(newVal)

	def initVarList(self):
		varList = []  #initialisation de la liste de variables


		#déclarations des différentes variables
		varList.append(PLCVar("dcy",50,"Bouton permettant de lancer un cycle","BIT","INPUT",self.dcyStateChanged))
		#On relie la variable à la méthode "dcyStateChanged" de MainWindow (dernier argument passé)

		varList.append(PLCVar("new_cycle_count",0,"Nouveau nombre de cycle à exécuter","WORD","OUTPUT"))

		varList.append(PLCVar("alarmButton", 51, "Bouton d'alarme","BIT","INPUT")) #ajout de la variable
 		#On relie la variable à la méthode "checkAlarm" de MainWindow
		varList[-1].sig_valueChanged.connect(self.checkAlarm)

		return varList  # on retourne la liste de variables


def incrementNewCycleCount(self):
	#on accède à la liste de variables visée : celle de l'automate sélectionné
	tempVarList = self.__plcClientList[self.__plcSelected].varList()

	#on récupère l'index de la variable dans cette liste
	varIndex = PLCVariable.findVariableInList(tempVarList,"new_cycle_count")

	#on calcule la nouvelle valeur
	newVal = (tempVarList[varIndex].getVarValue()+1)%10

	#on affecte la nouvelle valeur à la variable automate
	tempVarList[varIndex].setVarValue(newVal)
		
\end{Python}
\chapter{Objet dynamique}

\section{Présentation}

Dans le cadre de l'enseignement Supervision de L'ENIB, nous avons développé dans le module \lib{ENIBSupervision}, un type \ib{DynamicObject}. Ce nouveau type hérite d'un Qwidget de la bibliothèque PyQt.\\

Il permet de représenter un objet de supervision (verin, moteur,...) et de l'afficher. Nous pourrons alors très simplement dans Qtdesigner afficher ce type d'objet.\\ 

\img{\rootImages/presentation_1.png}{exemple d'utilisation du type}{0.3}

Pour l'exemple nous avons crée un objet Moteur 1 que nous avons initialisé à l'état sens 1. 
Le widget affiche en partant du haut:
\begin{enumerate}
    \item Le nom de l'objet (choisi lors de l'initialisation) .
    \item Un bouton informations qui lorsque l'on place le curseur dessus affiche le nom de l'objet, son type, son état, la description de l'objet ainsi que s'il est en défaut.
    \item Une image représentant l'état actuel de l'objet.
\end{enumerate}

\img{\rootImages/presentation_2.png}{Objet en défaut}{0.3}

Lorsque qu'un défaut a été transmis à l'objet ou qu'il en a détecté un par lui même, le bouton informations devient rouge. Il indique à l'utilisateur qu'un défaut est actuellement présent sur l'objet. Si nous appuyons sur le bouton, une fenêtre s'ouvre indiquant les problèmes actuels. \\

Dans cet exemple nous avons simulé un vérin ayant ses capteurs S1 et S2 à l'état haut au même moment. Le programme a bien détecté que c'était un état impossible et à crée une erreur. Nous avons également transmis au vérin l'information qu'une erreur "test problème" était présente. 
 
 
 
 

 
\section{Utilisation simple du type}

Nous allons créer un programme simple permettant de représenter un objet dynamique. Pour cette expérimentation nous présenterons l'utilisation d'un objet vérin mais le fonctionnement est similaire pour tous les autres objets.\\

Nous allons commencer par un créer une fenêtre MainWindow sous QtDesigner (fonctionne pour tout type de fenêtre mais ici on l'utilise simplement pour un exemple simple).

\img{\rootImages/programme_1.png}{Choix de la fenêtre}{0.28}

On ajoute un layout à notre fenêtre pour que notre widget puisse prendre toute la place qui lui est disponible et puisse être redimensionné. On glisse l'icône sur la fenêtre et on le dimensionne pour prendre tout l'espace de la fenêtre.

\img{\rootImages/programme_2.png}{Emplacement des layouts}{0.26}

On ajoute ensuite un widget dans notre layout (on le glisse). On peut le renommer pour être plus explicite (fenêtre à droite).

\img{\rootImages/programme_3.png}{Nom du futur objet}{0.25}

On sélectionne notre widget, puis click-Droit + promote to. 

\img{\rootImages/programme_4.png}{Emplacement de promotion}{0.85}

Enfin, on sélectionne la classe \ib{DynamicObject}

\textcolor{red}{\bold{Si cette classe n'apparaît pas, il faut revenir au tutoriel  PyQt5 et ses outils, au chapitre 9 qui traite de l'importation des widgets personnalisés (localisé dans la classe \ib{DynamicObject})}} \\

On peut maintenant fermer QtDesigner et enregistrer notre MainWindow dans le dossier \dir{UI\_formFiles}. On exécute donc ensuite notre script \file{scriptExport.py}.\\

On peut maintenant ouvrir notre  fichier \file{UI\_MainWindow.py} present dans le dossier \dir{UI\_class}. On importe notre classe \ib{dynamicObject}.

\begin{Python}
from ENIBSupervision.UI_class.UI_DynamicObject import DynamicObject
\end{Python}


Si le fichier \lib{UI\_mainWindow.py} était vide jusqu'à présent on peut l'initialiser simplement comme ceci:

\begin{Python}
    super().__init__(parent)
    self.__ui = Ui_MainWindow()
    self.__ui.setupUi(self)
\end{Python}


Il faut maintenant initialiser l'objet. On utilise la fonction \italic{initObject()} interne à notre widget. En premier paramètre on fournit le type de l'objet (vérin, moteur, ...), puis le nom de l'objet et enfin la description de l'objet.

\begin{Python}
    self.__ui.verin_1.initObject("verin", "vérin 1", "Vérin pour déplacer la palette")
\end{Python}

On peut maintenant initialiser l'état de notre objet (on utilisera la même fonction pour actualiser plus tard l'objet). 

La fonction à utiliser diffère  des objets mais reprend la même structure. Pour un objet à n capteurs on utilisera la fonction \italic{Update} n**2 \italic{States} avec n paramètres.

Dans notre exemple la fonction à utiliser est \italic{Update4States()} avec en paramètres s1 et s2. 

\begin{Python}
    self.__ui.verin_1.update4States(0,0)
\end{Python}

A cette étape de l'expérimentation, vous devriez obtenir une fenêtre similaire en exécutant le programme.\\

\img{\rootImages/programme_10.png}{Vérin en position neutre}{0.6}

Notre objet est bien initialisé. Le nom apparaît au dessus, en passant le curseur sur l'objet le texte est conforme à l'objet et l'image affichée correspond bien à l'état transmis plus tôt (2 capteurs à 0).\\

Nous pouvons dorénavant actualiser notre objet dès qu'un capteur change de valeur. Pour ceci on utilisera la même fonction que précédemment.


Pour actualiser l'objet de manière synchrone à la table d'animation, vous pouvez vous inspirer du programme exemple.\\

La dernière fonctionnalité permettra de signaler un problème sur l'objet ( permettant d'afficher un bouton rouge avertissant l'utilisateur). Pour ceci on utilisera la fonction \italic{setProb()} avec en paramètre le problème à signaler.

\begin{Python}
    self.__ui.verin_1.setProb("test")
\end{Python}

On exécutant le programme, vous devriez constater qu'un bouton rouge est apparu. En cliquant dessus une fenêtre devrait s'ouvrir avec notre problème "test" bien signalé.

\img{\rootImages/programme_12.png}{Vérin en défaut}{0.8}

Lorsque le problème sera résolu, on pourra utiliser la fonction \italic{resetProb} avec en paramètre le problème pour le réinitialiser.
\begin{Python}
    self.__ui.verin_1.resetProb("test")
\end{Python}


\section{Création d'un nouvel objet}

Dans cette section nous aborderons la manière de créer un nouveau "type" d'objet qui pourra être représenté grâce à ce type \ib{dynamicObject}. Nous allons illustrer cela par la création de l'objet moteur.\\


On ouvre dans un éditeur de code le fichier \file{UI\_DynamicObject.py} present dans le dossier \dir{ENIBSupervision/UI\_class}.


Il faut d'abord ajouter dans la liste objectType, un string nommant le type de l'objet. Dans notre cas on ajoutera "moteur". 
\begin{Python}
        objectType = ["verin","moteur"]
\end{Python}


Ensuite, il nous faut créer une liste que nous nommerons dans notre exemple motorStates:\\

Son premier membre est un entier indiquant le nombre d'états que peut prendre l'objet. Dans notre cas un moteur à 2 capteurs, il peut donc prendre $ 2^2 $ états différents.
Son deuxième membre est une liste décrivant les états pris par l'objet :

\begin{enumerate}
    \item Les états sont du type str.
    \item On classe les états suivant l'ordre binaire naturel: (ckm1,ckm2) -> (0,0) ; (0,1) ; (1,0) ; (1,1).
    \item Les états sont écrits de la manière suivante : \\
    \bold{l'objet} ... (ex: ...est à l'arrêt ; ...tourne dans le sens 1).
\end{enumerate}

Dans notre exemple, on a donc : 

\begin{enumerate}
    \item élément 0: (0,0) - "est à l'arrêt"
    \item élément 1: (0,1) - "tourne dans le sens 2"
    \item élément 2: (1,0) - "tourne dans le sens 1"
    \item élément 3: (1,1) - "est en défaut"
\end{enumerate}

Il nous reste plus qu'à ajouter notre liste à la liste states (dans le même ordre que dans la liste objectType).

Nous obtenons donc:

\begin{Python}
    motorStates = [4, ["est à l'arrêt", "tourne dans le sens 2", "tourne dans le sens 1", "est en défaut"] ]
\end{Python}


Nous allons maintenant créer une liste permettant de signaler des états en défaut ou problématiques (ex: un verin qui aurait ses deux capteurs s1 et s2 à l'état haut).\\

Notre liste attend en paramètre:
\begin{enumerate}
    \item une liste contenant les numéros des états problématiques. Dans notre exemple le seul problème est lorsque les deux capteurs ckm1 et ckm2 sont à l'état 1. 
    \item Une seconde liste contenant des strings décrivant l'état signalée dans la liste précédente. Ici on aura simplement "ckm1 et ckm2 sont tous les 2 à l'état 1".
\end{enumerate}

A l'instar de states, on ajoute notre liste motorStateDefault (celle que l'on vient de créer) à la liste stateDefault.

\begin{Python}
    motorStateDefault = [ [3], ["ckm1 et ckm2 sont tous les deux à l'état 1"]]
    stateDefault = [verinStateDefault, motorStateDefault]
\end{Python}


La dernière étape consiste à créer des images pour représenter les différents états pris par l'objet. Les dimensions des images n'ont peu d'importance. Il est cependant recommandé de garder pour un même objet, des dimensions fixes. \\

Les images seront ensuite enregistrées au format png dans le dossier \dir{ENIBSupervision/UI\_class/images}  nommées comme ceci: \bold{monObjet\_numEtat}.\\

dans notre cas \file{moteur\_0.png} ; \file{moteur\_1.png} ; \file{moteur\_2.png} ; \file{moteur\_3.png}

\img{\rootImages/creation_4.png}{Images possibles d'un moteur}{0.6}


\newpage
\section{Utilisation des voyants}

Il est possible de placer des voyants qui changerons d'état en fonction des variables de l'automate. \\
La définition des voyants se situe dans le fichier \file{UI\_IndicLight.py}.\\
Le  nom de la classe promue est \ib{IndicLight}



Il convient tout d'abord de placer un widget de type "widget" sur la fenêtre. \\
Nous appellerons notre widget 'voyant\_capteur' \\

\img{\rootImages/dynamicObject_voyant.png}{Nom du voyant}{0.5}



Ensuite, il faut promouvoir le widget en \ib{IndicLight}.
Pour cela, on fait un click-droit sur l'arborescence des widgets en sélectionnant notre widget. \\
Dans "promote to" (promouvoir en) , il faut déclarer le fichier \file{UI\_IndicLight.py} de la même façon que le fichier \file{UI\_DynamicObject.py}

\img{\rootImages/dynamicObject_locate.png}{Importation de l'objet \ib{IndicLight}}{0.5}


L'emplacement du fichier \file{UI\_IndicLight.py} est le suivant : \\

\file{ENIBSupervision/UI\_class/UI\_IndicLight.py} \\


Une fois le widget promu, nous allons pouvoir enregistrer QtDesigner, fermer la fenêtre et actualiser l'interface avec le script \file{scriptExport.py}.\\ \\

La gestion des voyants se fera dans le fichier \lib{UI\_MainWindow.py} \\


Par défaut, lors de l'initialisation d'un voyant, ce dernier comporte deux états par défaut : 


\begin{enumerate}
    \item Un état '0' de couleur rouge sans texte
    \item Un état '1' de couleur verte sans texte
\end{enumerate}

Nous souhaitons maintenant modifier les propriétés de base de notre voyant

\subsubsection{Couleur du voyant}

\begin{Python}
self.__ui.voyant_capteur.changeState(0, [0,255,255]) 
\end{Python}
Cette instruction permet de redéfinir la couleur de l'état 0 du voyant 'voyant\_capteur' en cyan. \\
Le second argument de la fonction \italic{changeState} est un tableau comportant les valeurs de Rouge, Vert et Bleu du voyant (valeurs comprises entre 0 et 255) \\

\subsubsection{Texte du voyant}

Étant donné que le voyant hérite des labels (\ib{QLabel}), vous pouvez définir un texte pour le voyant de la manière suivante.

\begin{Python}
self.__ui.voyant_capteur.setText('capteur voyant')
\end{Python}


\subsubsection{Forme du voyant}

Le voyant peut être de forme rectangulaire (par défaut) ou arrondie avec l'instruction suivante :

\begin{Python}
self.__ui.voyant_capteur.setRoundCorner(True) #voyant arrondi
\end{Python}

\subsubsection{Couleur et taille du texte}

Deux fonctions sont à votre disposition pour changer la taille de la police (en pt) et sa couleur(RGB) : \italic{setFontSize} et \italic{setFontColor}
\begin{Python}
self.__ui.voyant_capteur.setFontSize(14)
self.__ui.voyant_capteur.setFontColor([150,150,150]) #gris
\end{Python}

Avec toutes ces instructions placées dans le constructeur de \\ \lib{UI\_MainWindow.py}, on obtient le voyant suivant.

\img{\rootImages/voyant.png}{Le voyant}{0.5}

\subsubsection{Un nouvel état}
Il est également possible d'ajouter un nouvel état.
\begin{Python}
self.__ui.voyant_capteur.setStateCount(2, [0,0,255]) 
\end{Python}
Cette instruction ajoute un troisième état appelé '2' de couleur bleue.

\subsubsection{Afficher un état}

Une fois que tous les états de notre voyant sont définis, il nous reste à changer l'état en fonction des conditions.
Pour définir l'état courant, on utilise l'instruction \italic{setState}
\begin{Python}
self.__ui.voyant_capteur.setState(1) 
\end{Python}
Le voyant est donc actualisé à l'état 1
\chapter{Conclusions}

\section{Capacités du programme}

A ce jour, le code fourni est en mesure de gérer un programme de supervision comportant des vérins, moteurs et voyants. \\
L'utilisateur est libre d'ajouter des objets comme bon lui semble. \\

Les tables d'animations sont également opérationnelles et permettent de visualiser à tout instant l'état des variables de l'automate. \\
Il est possible de changer d'automate pour une même interface. \\
Cependant, il nous est encore impossible de distinguer une variable forcé par l'utilisateur ou une variable à un état de repos. \\
Cet objectif sera, dans la mesure du possible, à prendre en compte. \\


\section{Améliorations}

L'un des objectifs serait de récupérer les données des variables sur une base de temps afin de les exploiter dans le futur (traitement puis graphique d'exploitation). Il faudrait donc sauvegarder les valeurs des variables soit dans un simple fichier au format CSV ou XML ou encore dans une base de données (SQL, SQlite...). \\
Il faut être conscient que la dernière méthode est plus à longue à configurer car une base de données n'est pas forcément installé sur les ordinateurs. \\

Le programme que nous avons codé permet d'utiliser le logiciel seulement sur un ordinateur. \\
Une version améliorée serait de faire une interface pour smartphone afin de la rendre plus portable. \\
On pourrait donc prendre le contrôle de l'automate à travers une interface WEB. Cependant, cela peut poser de graves problèmes de sécurité car la communication Interface-Automate ne se fait plus à travers un seul réseau local.


\section{Problèmes rencontrés}

Tout au long de ce semestre, de nombreux problèmes ont été rencontrés, notamment au niveau du langage en lui-même. \\
Nous devions nous baser sur le langage Python, cependant celui-ci a apporté de nombreux problèmes.
\newline
En effet, le premier était tout simplement notre mauvaise maîtrise du langage. Python est un langage simple à aborder mais dans le cadre d'une utilisation plus ambitieuse telle que notre projet, les compétences à posséder deviennent bien particulières et le langage expose des aspects qui sont loin d'être simples si nous n'y avons pas été formé. \newline
Une bonne partie du temps dont nous disposions a donc été employé à la résolution de bugs inhérents à notre mauvaise maîtrise de Python.\\



Ensuite, de nombreux choix ont dû être faits. En effet, avec la volonté de créer un module ré-utilisable de haut niveau, il a été nécessaire de faire des compromis entre performance et simplicité d'utilisation.\newline
Au début du projet, nous avions développés notre propre système de signaux/slots utilisant le multi-threading mais apportant des problèmes en terme de compatibilité avec Qt. C'est ceci qui nous a fait re-changer notre programme pour lui faire utiliser des signaux/slots Qt au dernier moment.\\



Le manque de possibilités de tester notre programme a aussi été un frein au développement de notre projet. Nous avons testé celui-ci avec Unity-PRO extrêmement tardivement.\newline
Puisque nous programmions sous Linux et sans moyen d'accéder facilement à un système Windows.\newline
De plus, nous n'avions pas non plus accès à la salle d'automatismes, ce qui nous aurait offert un moyen simple de tester notre programme en conditions réelles et de perdre moins de temps en fin de semestre à corriger tous les bugs existants dans le programme (n'ayant pas pu être testé avant). Cela nous aurait aussi permis de nous rendre compte des différents problèmes conceptuels qui ont dû être résolu très rapidement\footnote{Même si ces problème auraient dû être envisagés avant la rédaction du programme}.


Enfin, nous avons fait un mauvais usage de la bibliothèque PyModbus. En effet, celle-ci semble proposer de nombreuses fonctionnalités pour simplifier la gestion et la robustesse de la communication. Malheureusement, l'absence de documentation complète de la bibliothèque ne nous a pas permis de les découvrir avant la fin du projet. Sans compter que les documents qui nous ont été fournis comme base au début du semestre n'exploitaient pas ces fonctionnalités.
\chapter{Introduction à la conversion statique d'énergie électronique}

\section{Application des moteurs à courant continu}

Les moteurs à courant continu sont adaptés pour les systèmes de levage (grue). Le couple est trè élevé à l'arrêt.
La vitesse de rotation d'une machine dépend de la fréquence.
Il est pertinent de démarrer un moteur en douceur pour éviter les appels de courant.
\section{Les types de transistors}

\begin{items}{blue}{\Triangle}
    \item Les transistors BJT (Base Junction Transistor) sont des transistors bipolaires contrôlés en courant
    \item Les transistors \glossary{MOSFET} sont des transistors commandés en tension
    \item Les transistors IGBT sont des transistors combinant les avantages des  IGBT et des MOSFET
\end{items}

\section{Protection des circuits}


On protège les circuits avec des radiateurs, des fusibles, des condensateurs, etc\\
Pour s'opposer : 
\begin{items}{blue}{\Triangle}
    \item aux fortes variations de tension on utilise des condensateurs
    \item aux fortes variations de courant on utilise des inductances
\end{items}

\section{Qualité d'un signal}

\begin{items}{blue}{\Triangle}
    \item La distorsion harmonique individuelle (DHI) nous renseigne sur l’importance en amplitude de chaque harmonique individuellement par rapport au fondamental

    $$ DHI = \frac{X_{neff}}{X1_{eff}}$$
    \item La distorsion harmonique totale (DHT) nous renseigne sur l’importance en amplitude de chaque harmonique individuellement par rapport au fondamental

    $$ DHT = \frac{\sqrt{ \sum X_{neff}^2}}{X_{eff}}$$
    \item Le facteur de distorsion (FD) nous renseigne sur l’importance du fondamental par rapport au signal ondulé dans son intégralité
\end{items}

\subsection{Les signaux alternatifs}

Les signaux alternatifs ne contiennent que des harmoniques impairs. L’harmonique de
rang n=1, c’est-à-dire V1, est appelé le fondamental, et sa fréquence, dite fréquence
fondamentale, est celle du réseau (60 Hz ou 50 Hz).


$$ x(t) = 120 sin(wt)+40sin(3wt)-25sin(5wt) $$



$$ DHT = $$%\part{Electronique de puissance}
\chapter{Les composants semi‐conducteurs de puissance}

Les semi-conducteurs abordés içi seront utilisé en mode commutation (pas d'amplification).\\

Il sont classés en 3 catégories selon le mode de commutation d’un état à un autre : 


\begin{items}{blue}{\Triangle}
    \item Non commandable (la diode)
    \item Semi-commandable (le thyristor « classique », et le triac)
    \item Entièrement commandable (le thyristor blocable par la gâchette, et le transistor de
    puissance).
\end{items}

\section{Les diodes de puissance}

\subsection{Présentation}

La diode de puissance est le semi-conducteur qui présente une structure la plus simple
de toutes. \\
Elle est constituée de deux couches semi-conductrices dopées p-n
respectivement, qui forment ainsi une jonction pn. \\
Voici quelques applications des diodes de puissance.

\begin{items}{blue}{\Triangle}
    \item Les montages redresseurs
    \item Les alimentations à découpage
    \item Les diodes de roues libre (assurer la continuité de courant dans une charge inductive)
\end{items}

\subsection{Broches}

La diode de puissance présente deux électrodes dites anode et cathode. 

\begin{items}{blue}{\Triangle}
  \item La tension inverse
  \item Le courant moyen
  \item La vitesse de commutation
\end{items}

\img{\rootImages/diode.png}{Schéma d'une diode}{0.5}

\subsection{Les critères de conduction}

La diode de puissance entre en conduction dès que \bold{la tension vD entre l’anode et la
cathode est positive}. En mode conduction, la chute de tension directe vd entre l’anode
et la cathode est de l’ordre de 1,5 à 3 V. \\
Dans les études suivantes, la chute de tension aux bornes des diodes sera considérée comme nulle.


Elle se met en mode blocage à \bold{l’extinction de son courant iD}. Dans ce mode, la diode de puissance présente une tension inverse de
plusieurs kilovolts.

\img{\rootImages/carac.png}{Caractéristique d'une diode}{0.5}

\section{Le thyristor de puissance}

Du point de vue structure, le thyristor de puissance est constitué de quatre couches semi-
conductrices, respectivement dopées p-n-p-n, pour former trois jonctions.\\

\subsection{Broches}
Du point de vue utilisation, ce composant présente trois électrodes : \bold{l’anode, la cathode, et la
gâchette}

\begin{items}{blue}{\Triangle}
    \item Les convertisseurs de courant
    \item Les hacheurs, 
    \item les gradateurs
    \item Les onduleurs pour des applications grande puissance
\end{items}

À noter que les thyristors conçus pour des applications à 60 Hz (50 Hz), tels les
convertisseurs de coutant et les gradateurs, ont un pouvoir en tension et en courant
beaucoup plus grand que ceux conçus pour applications à fréquence élevée. Le pertes par commutations deviennent non négligeables.

\subsection{Les critères de conduction}

Deux conditions sont nécessaires pour qu’un thyristor entre en mode conduction : 


\begin{items}{blue}{\Triangle}
  \item Une tension vT positive entre l’anode et la cathode
  \item une impulsion de courant (ou un train
  d’impulsions), suffisante en amplitude et en durée, appliquée à la gâchette. La tension
  et le courant de gâchette sont de l’ordre de quelques volts et une centaine de
  milliampères respectivement. \\
\end{items}

Une fois à l’état passant, le thyristor conduit tant que son courant iT est supérieur au
courant de maintien im. La chute de tension directe vd entre l’anode et la cathode qui en
résulte est de l’ordre de 1,5 à 3 V.


Comme dans le cas de la diode de puissance, le thyristor de puissance se met en mode
blocage à l’extinction de son courant iT (Il est possible d'injecter un courant négatif pour couper le thyristor -> commutation forcée). Dans ce mode, le thyristor de puissance
présente une tension inverse de plusieurs kilovolts.

GTO : Gate Turn Off


\subsection{Commutation naturelle}



\section{Les transistors bipolaires}

Une des moyens pour créer notre circuit de puissance est le transistor bipolaire. \index{bipolaire}. Ce composant possède trois broches : 

\begin{items}{blue}{\Triangle}

  \item Le collecteur (C)
  \item la base (B)
  \item l'émetteur (E)

\end{items}

\img{\rootImages/bjt.png}{La représentation du transistor bipolaire}{0.1}

\subsection{Conventions}

Afin de simplifier les calculs par la suite, posons les normes suivantes : 

\begin{items}{blue}{\Triangle}

  \item Le courant entrant dans le Collecteur est appelé $I_{C}$
  \item Le courant entrant dans la Base est appelé $I_{B}$
  \item Le courant sortant de l'émetteur est appelé $I_{E}$

  \item La tension entre la Base et l’Émetteur est appelée $V_{be}$
  \item La tension entre le Collecteur et l’Émetteur est appelée $V_{ce}$
\end{items}

\img{\rootImages/courants.png}{Conventions du transistor bipolaire}{0.6}


Les flèches au sein du transistor indiquent le sens de déplacement du courant sur les broches.

\subsubsection{Les familles de transistors bipolaires}

Les transistors bipolaires sont classés en deux catégories : 

\begin{items}{blue}{\Triangle}

  \item Les transistors NPN\footnote{Le nom de ces familles provient du type de jonction utilisé en interne. Pour plus de renseignements, consulter les diodes et semi-conducteurs}
  \item Les transistors PNP

\end{items}

Le principe de fonctionnement est similaire entre ces deux familles, seul le branchement et le niveau de commande diffère.\\ Dans ce document, nous utiliserons essentiellement des transistors NPN car ces derniers utilisent des grandeurs positives.

\img{\rootImages/pnppnp.jpeg}{Transistors NPN et PNP}{0.6}


\subsection{Les paramètres de sélection du transistor}

Notre transistor doit dans un premier temps répondre à deux contraintes : 

\begin{items}{blue}{\Triangle}

  \item La tension admissible sur $V_{ce}$\footnote{Cette tension est indiquée dans les documentations techniques} doit être supérieure à la tension d'alimentation de notre circuit.\\
  Concrètement, si notre circuit est alimenté en 48V mais que le transistor ne supporte pas plus de 30V, il va être détruit.
  \item Le transistor doit supporter un courant plus élevé que le courant maximal transitant dans notre circuit.
  Pour contrôler un moteur consommant 1 Ampère, je dois donc choisir un transistor pouvant contrôler au moins 2 Ampère.
\end{items}

Pour la suite de la présentation, on supposera que notre transistor a été dimensionné pour répondre à ces deux contraintes.


\subsection{Le principe}

Ce type de transistor fonctionne comme une vanne pour une canalisation. Il est possible de réguler le débit de la canalisation avec la vanne.\\

Le transistor bipolaire permet de contrôler un courant important avec un faible courant.\\

\img{\rootImages/barrage.png}{Le rôle du transistor}{0.3}.

Ici, notre transistor joue le rôle de la vanne et permet de bloquer le courant (électrons) ou bien de les laisser passer. \\


Le courant de l'élément à contrôler (moteur, résistance de puissance) transite entre le collecteur et l'émetteur et le courant de commande passe par la base, comme l'illustre la figure suivante.\\

\img{\rootImages/courant_main.png}{Courant de commande et de puissance}{0.6}

La relation fondamentale reliant le courant de puissance et de commande est la suivante : 

$$ \boxed{ I_{C} = \beta \cdot I_{B} }$$

Le paramètre $\beta$, appelé \bold{gain du transistor}\footnote{le gain \index{gain (transistor)}est sans dimension (unité) et est appelé $ h_fe$ dans les documentations} est une caractéristique interne de notre transistor, c'est à dire qu'il dépend du type de transistor que nous choisissons.\\
Les courants $I_{C}, I_{B},I_{E}$ sont exprimés dans la même unité (Ampère, milliampères..) pour une formule homogène.\\

Les transistors de puissance possède des gains de l'ordre de la dizaine alors que les transistors de signal (faibles courants) ont un gain pouvant facilement atteindre 200 ou 300.

\messageBox{Remarque}{cyan}{white}{Plus notre $\beta$ est faible, plus il va falloir injecter un courant important dans notre base}{black}

\Question{Et que devient notre broche Émetteur" ?}

\begin{reponse}
  
  Notre émetteur est relié à la masse du circuit et permet de le fermer pour que les électrons puissent circuler.\\

  Le courant circulant dans l'émetteur est simplement la somme des courants entrant dans le transistor. \\
  d'où : $$ \boxed{ I_{E} = I_{B} + I_{C} }$$

  \end{reponse}



\subsection{Exemple}

On souhaite commander l'arrêt et la marche d'un moteur consommant au maximum 0.5A et alimenté avec une tension de 9V. \\
Nous choisissons un transistor permettant de commuter 1A (sécurité) avec $\beta=30$ \\

\Question{Quel doit-être le courant injecté dans la base ?}


\begin{reponse}
  On applique la formule précédent et on obtient : 

  $$  I_{B} = \frac{I_{C}}{\beta} = \frac{0.5}{30} = 16 mA $$

  \end{reponse}

 

\subsection{Mise en pratique}

\subsubsection{Branchements}

    Maintenant que nous connaissons les tensions et courants nécessaires à notre transistor et à notre moteur, nous allons le commander avec une carte Arduino. \\

    Tout d'abord, il convient de placer le moteur entre notre alimentation et le collecteur.\\
    

\messageBox{Remarque}{cyan}{white}{Toutes les charges à contrôler avec ce type de transistor se placent entre l'alimentation et le collecteur.}{black}

    Enfin, il ne nous reste plus qu'à relier une sortie numérique de l'Arduino vers notre base par l'intermédiaire d'une résistance.

    \bold{La résistance va servir à imposer le courant dans la base de notre transistor}.

    Nous obtenons donc le schéma suivant.

    \img{\rootImages/schema_pnp.png}{Branchement du transistor bipolaire}{0.4}

    \subsection{Dimensionnement de la résistance}

    On souhaite obtenir un courant de $16 mA$ dans notre base et on sait que l'Arduino délivre du $5V$ en sortie.\\

    Nous somme donc tentés de dire que $R_b = \frac{U_{arduino}}{ I_{B}} = \frac{5}{0.016} = 312 \Omega$ \footnote{On part de la loi de Ohm qui dit que $U=R.I$}\\


    Hélas, il y a peu de chance que votre moteur tourne dans les conditions optimales.\\
    Il convient d'avoir à l'esprit que notre $\beta$ trouvé dans la documentation n'est que théorique et qu'il peut être en réalité inférieur.

    \messageBox{Remarque}{cyan}{white}{Une des conventions non officielles admet que pour de la commutation en Tout ou Rien, on divise la valeur théorique de notre $\beta$ par 2. \\Nous allons donc prendre donc un $\beta$ valant 15.}{black}
    
    On refait donc les calculs.

    $$  I_{B} = \frac{I_{C}}{\beta} = \frac{0.5}{15} = 32 mA $$

    Une dernière chose : les transistors bipolaires entraînent une chute de tension entre la base et l'émetteur ($V_{be}$).\\
    Cette chute de tension dépend de la technologie des transistors bipolaires : 

    \begin{items}{blue}{\Triangle}

      \item $0.7V$ pour les transistors au silicium
      \item $0.3V$ pour les transistors au germanium
    \end{items}
    Dans l'extrême majorité des cas, on utilisera des transistors au silicium. La tension disponible aux bornes de la résistance est donc de $4.3V$ ($5-0.7$)

    D'où : 

    $$ \boxed{ R_{b} = \frac{U_{arduino}-V_{be}}{I_b} = \frac{4.3}{0.032} = 134 \Omega} $$


Il faut dissiper la chaleur du transistor


Protection contre les régimes transitoirs : Varistor 



\section{Les transistors MOSFET}

     Nous avons vu l'utilisation des transistors bipolaires. \\
     Ces derniers sont assez contraignants à mettre en oeuvre car ils sont commandés en courant.

     Nous allons utiliser cette fois-ci la technologie des \glossary{MOSFET} \footnote{MOSFET : Metal Oxide Semiconductor Field Effect Transistor = Transistor à effet de champ à structure métal-oxyde-semi-conducteur} car ces derniers ont l'avantage d'être contrôlés en \bold{tension}.

     Ce composant possède trois broches : 
     
     \begin{items}{blue}{\Triangle}
     
       \item Le drain (D)
       \item la porte (G)\footnote{G pour Gate}
       \item la source (S)
     
     \end{items}
     
     \img{\rootImages/mosfet.png}{La représentation du transistor MOSFET}{0.1}
     
     \subsection{Conventions}
     
     Afin de simplifier les calculs par la suite, posons également les normes suivantes : 
     
     \begin{items}{blue}{\Triangle}
     
       \item Le courant entrant dans le Drain est appelé $I_{D}$
       \item Le courant entrant dans la Porte est appelé $I_{G}$
       \item Le courant sortant de la Source est appelé $I_{S}$

       \item La tension entre la Porte et la Source est appelée $V_{GS}$
       \item La tension entre le Drain et la Source est appelée $V_{DS}$
     \end{items}
     
     \subsubsection{Les familles de transistors MOSFET}

     Les transistors MOSFET sont classés en deux catégories : 
     
     \begin{items}{blue}{\Triangle}
     
       \item Les transistors MOSFET à canal N \footnote{Le nom de ces familles provient du type de jonction utilisé en interne. Pour plus de renseignement, consulter les diodes et semi-conducteurs}
       \item Les transistors MOSFET à canal P
     
     \end{items}
     
     Le principe de fonctionnement est similaire entre ces deux familles, seul le branchement et le niveau de commande diffère.\\
     Dans ce document, nous utiliserons essentiellement des transistors MOSFET à canal N car ces derniers utilisent des grandeurs 
     positives.
     
     \img{\rootImages/mos.png}{Transistors à canal N et P}{0.6}

     \section{Les paramètres de sélection du transistor}
     
     Les paramètres de sélection de nos transistors MOSFET sont identiques aux transistors bipolaires, c'est à dire :
     
     \begin{items}{blue}{\Triangle}
     
       \item La tension admissible sur $V_{DS}$ du transistor
       \item Le courant admissible entre le Drain et la Source.
     \end{items}
     
     Pour la suite de la présentation, on supposera que notre transistor a été dimensionné pour répondre à ces deux contraintes.


     \subsection{Le principe}

     Ce type de transistor fonctionne comme les transistors bipolaires mais est commandé en tension et non en courant.

     Par analogie, le drain joue le rôle du collecteur, la source celui de l'émetteur et la porte celui de la base.\\
     Le courant de l'élément à contrôler (moteur, résistance de puissance) transite entre le drain et la source et la tension de commande est aux bornes de la porte.\\
     
     Les transistors MOSFET deviennent passant\footnote{Le transistor laisse passer tout le courant autorisé.} lorsque la tension sur la porte dépasse une tension de déclenchement appelée $V_{GS_{th}}$.
     Cette valeur est généralement comprise entre $2$ et $4$ Volts.\\

     \bold{Lorsque cette tension} $V_{GS_{th}}$ est atteinte, notre transistor peut être remplacé d'un point de vue électrique entre le drain et la source par une résistance de très faible valeur, appelée $R_{DS_{on}}$

    \section{Comparaison avec les transistors bipolaires}

    Par nature, la porte du MOSFET est vue comme un condensateur. Le transistor ne consomme pas de courant, excepté pendant les commutations.\\
    Ainsi, le courant est nul dans la porte pour maintenir le moteur en marche alors que pour un bipolaire, il faut maintenir un courant dans la base.\\

    Les MOSFET sont donc plus économes en énergie que les bipolaires.\\
    De plus, ils peuvent généralement supporter des courants plus importants que les bipolaires.\\

    En revanche, en hautes fréquences, les MOSFET sont moins réactifs du fait de leur capacité en entrée.
     \subsection{Mise en pratique}

     Nous souhaitons faire tourner le même moteur que celui utilisé avec notre transistor bipolaire.\\
     Nous allons le commander avec une carte Arduino.

     \subsubsection{Branchements}

     Tout d'abord, il convient de placer le moteur entre notre alimentation et le drain.\\
     
 
    \messageBox{Remarque}{cyan}{white}{Toutes les charges à contrôler avec ce type de transistor se placent entre l'alimentation et le drain.}{black}
 
     Enfin, il ne nous reste plus qu'à relier une sortie numérique de l'Arduino vers notre porte \bold{sans} résistance. Nous obtenons donc le schéma suivant.
 
     \img{\rootImages/schema_mosfet.png}{Branchement du transistor MOSFET}{0.45}



\section{Les redresseurs de puissance}

Transformer une tension alternative en tension continue.


% in, ia, iG, ifd et ifi sont respectivement le courant nominal en mode conduction, le courant
% d’accrochage, le courant de gâchette, le courant de fuite en mode blocage en
% © M. Ouhrouche, 2021polarisation directe, et le courant de fuite en mode blocage en polarisation inverse.
% vpdmax et vpimax sont les tensions maximales en mode blocage en polarisation directe et
% inverse respectivement. Le courant d’accrochage ia est le niveau minimal requis à
% atteindre pour le curant iT afin que l’amorçage ai lieu. Alors que l’application de vpdmax
% aux bornes du thyristor provoquerait un amorçage intempestif même en l’absence d’une
% impulsion de courant de gâchette.
% La figure 2.6 ci-dessous donne un exemple de formes d’ondes du courant et de la
% tension aux bornes d’un thyristor de puissance. La figure montre que le thyristor bloque
% aussi une tension positive. On dit alors que le thyristor est un interrupteur bidirectionnel
% en tension.


% \subsection{Amorçage du thyristor de puissance}

% Il existe divers circuits électroniques pour amorcer un thyristor de puissance. Ces
% circuits diffèrent entre autres les uns des autres par le moyen mis en œuvre pour assurer
% l’isolation galvanique entre l’électronique basse puissance et l’électronique de
% puissance. \\

% Le circuit dans la figure 2.7 ci-après donne un exemple d’un circuit de principe
% d’amorçage utilisant un transformateur d’impulsion TI. La diode au primaire de TI est
% une diode de roue libre pour assurer la continuité de courant au blocage du thyristor.
% Alors que la diode au secondaire de TI redresse le courant de celui-ci. Ces deux diodes
% sont de type rapide.
% © M. Ouhrouche, 2021VC C
% n:1
% TI
% Figure 2.7 Circuit d’amorçage avec transformateur d’isolation
% Le rapport de transformation n doit être judicieusement choisi, puisqu’il joue un rôle
% important dans le conditionnement de l’impulsion de la tension appliquée à la gâchette
% du thyristor.
% 2.3.2 Commutation de courant
% L’extinction du courant dans un thyristor menant au blocage de celui-ci peut se faire
% naturellement ou d’une façon forcée. On parle alors à propos de la commutation
% naturelle et de la commutation forcée selon le cas.
% La commutation naturelle a lieu dans les convertisseurs à entrée alternative, tels que les
% convertisseurs de courant et les gradateurs. Pour illustrer le principe de la commutation
% naturelle, considérons le circuit dans le figure 2.8 ci-après. Initialement, le thyristor T1
% étant passant, et le thyristor T2 en mode blocage. Dans ces conditions, le courant iT1
% dans le thyristor T1 est égal au courant i0. Le thyristor T2 peut être amorcé dès que la
% tension alternative v2 devient supérieure v1. À l’amorçage de T2, son courant iT2 croît
% linéairement de zéro à i0, alors que iT1 décroît de i0 à zéro conformément à la loi des
% courants de Kirchhoff.
% © M. Ouhrouche, 2021i0
% iT1
% iT2
% T2
% T1
% Xs
% v1
% Xs
% v2
% Figure 2.8 Commutation naturelle
% La commutation forcée a lieu dans les convertisseurs à entrée continu, comme les
% hacheurs de courant par exemple. Le blocage d’un thyristor nécessite l’utilisation d’un
% circuit dit d’aide à la commutation, formé à la base d’un circuit oscillant LC.
% Il existe une multitude de circuits d’aide à la commutation, et la figure 2.9 ci-dessous
% en donne un exemple. Ce circuit que nous avions construit dans le cadre d’un projet
% d’ingénierie durant nos études supérieures sera analysé en détail au chapitre 6.
% D
% iTa
% L2
% Tp
% L1
% C
% 
%  
%  
% Ta
% Ti
% Figure 2.9 Circuit d’aide à la commutation
% Tp, Ti, et Ta, désignent respectivement le thyristor principal (à bloquer), le thyristor
% d’inversion, et le thyristor auxiliaire. L’amorçage de Ti permet l’inversion de la polarité
% de la tension aux bornes du condensateur. Le courant du condensateur circule à travers
% © M. Ouhrouche, 2021C, L1, Tp et Ti lors de la première moitié de la période d’oscillation L’amorçage de Ta
% par la suite permet au courant du condensateur de circuler lors de la deuxième moitié
% de la période d’oscillation à travers le thyristor principal Tp en y entrant par sa cathode
% afin d’annuler le courant de celui-ci. La diode D offre un chemin pour le courant du
% condensateur après le blocage de Tp.
% 2.4
% LE THYRISTOR BLOCABLE PAR LA GÂCHETTE
% L’utilisation d’un circuit d’aide à la commutation pour bloquer un thyristor classique
% en résulte des montages encombrants. Le thyristor blocable par la gâchette, connu sous
% le vocable anglais Gate-turn-off (FTO), diffère du thyristor classique à l’effet qu’il est
% entièrement commandable par la gâchette; c’est-à-dire qu’une impulsion de courant de
% gâchette le met en mode passant, et une impulsion négative de courant de gâchette le
% met en mode blocage. Il offre ainsi un avantage par rapport au thyristor classique en
% réduisant l’encombrement. La figure 2.10 donne le symbole d’un thyristor GTO.
% Anode
% iT
% 
% vT
% 
% iG
% 
% Gâchette
% vG
% 
% Cathode
% Figure 2.10 Le thyristor blocable par la gâchette
% Les circuits d’amorçage du thyristor GTO sont similaires à ceux utilisés pour
% l’amorçage du thyristor classique. Quant au circuit de « blocage », il doit pouvoir
% générer une brève impulsion négative de courant (quelques microsecondes seulement),
% mais dont l’amplitude se compare au courant nominal. La figure 2.11 donne un
% exemple de circuit pour générer des impulsions négatives de courant de gâchette pour
% le blocage d’un GTO. Nous avertissons le lecteur qu’il ne s’agit là que d’un circuit de
% principe élaboré à partir des notions de base de circuits électriques et électroniques. Le
% condensateur était initialement lors de la mise en conduction du GTO, et la polarité de
% © M. Ouhrouche, 2021sa tension doit être telle qu’indiquée dans le schéma. La mise en conduction du photo-
% thyristor entraîne une décharge rapide du condensateur à travers la résistance et la
% gâchette du GTO.
% 
% iG  0
% Figure 2.11 Circuit de principe de blocage d’un GTO
% Alors que l’utilisation du thyristor classique s’impose dans des applications de grandes
% puissances à 60 Hz (50 Hz), le thyristor GTO est utilisé dans des applications à fort
% courant et vitesse de commutation élevée, telles les entraînements à courant alternatif,
% et les entraînements à courant continu par hacheur pour des applications en traction
% électriques notamment
\chapter{Introduction}

\section{Contexte de la Slovénie}
La Slovénie est un pays très marqué par ses paysages alpins. En effet de nombreux massifs y sont présents, on peut citer le massif du Pohorje ou bien les Alpes kamiques. Le point culminant de la Slovénie, le Triglav (2864m) figure même sur le drapeau du pays ou bien sur les pièces nationales de 50 centimes.\n

De ce fait, le ski alpin est le sport le plus populaire en Slovénie. De nombreux sportifs slovènes sont présents au niveau international. Nous pouvons par exemple citer Andrej Jerman et Tina Maze sportifs considérés comme faisant partie des meilleurs skieurs au monde.\n

Passée la saison, la neige laisse place aux grandes étendues d'herbe verdoyantes invitant les touristes à envahir le paysage pour pratiquer diverses activités telles que la randonnée, le vélo ou encore des promenades à cheval dans les zones rurales.\n

La Slovénie reste un pays très préservé de l'activité humaine, presque 60 \% de la superficie du pays est boisé. Elle possède un grand nombre d'espaces protégés (355 sites classés dans le réseau Natura 2000). Le pays se revendique comme une destination d'eco-tourisme idéal, il fait  par ailleurs partie des dix meilleures destinations écologiques selon Green Destination. \n






\section{Objectifs de l'entreprise}

Suite à l'arrivée du Coronavirus il y a déjà 5 ans, la Slovénie, pour qui le tourisme est un domaine important a rencontrée de nombreuses difficultés. \n 

Au vu de la nécessité de relancer l'économie locale et d'offrir à nouveau la possibilité de sortir et de profiter des différentes activités offertes par les paysages slovènes, notre société a pour but de proposer des solutions pour permettre ce retour à la normale dans les meilleures conditions malgré l'épidémie qui sévit.\n

Notre société proposera un ensemble d'applications mobiles pour les stations de skis: \n
\begin{enumerate}
    \item carte de densité des clients sur la station. 
    \item redirection des utilisateurs vers des zones moins fréquentées.
    \item gestion du matériel des stations (matériel disponible , matériel à nettoyer, ...)
\end{enumerate}
  
L'objectif étant de permettre aux touristes de profiter aux mieux des activités proposées sur le site. Tout en croisant le moins de personnes possible et ainsi limiter les risques de propagation du virus. \n   
  
Notre entreprise s'engage à préserver la biodiversité locale ainsi qu'à sensibiliser tous les utilisateurs de nos services aux problèmes environnementaux. \n

Nous nous engageons également à promouvoir au maximum les sociétés locales, et si ce n'est pas possible, des sociétés européennes. 







\chapter{Organisation de l'entreprise}



\section{Emplacement de l'entreprise}

Notre entreprise proposant des services personnalisés pour chaque station de ski (ou autre), son emplacement sera donc fortement influencé par la proximité avec ces stations.\n 

\img{\rootImages//carte.png}{corona-map mai 2020}{0.25}

Comme nous le montre cette infographie, l'ensemble des stations de ski se trouve au Nord-Ouest du pays (où se trouvent les principaux pics montagneux du pays). Nous souhaitons donc nous installer dans le périmètre du cercle tracé. \\




\section{Fonctionnement de l'entreprise}

Notre société "Coronavacances" n'est composée que de cinq associés travaillant en collaboration dans leur domaine respectif. Notre société se définit comme start-up. 
Toute la gestion, création et mise à jour des applications ainsi que la gestion humaine et financière de l'entreprise sont réalisées par nos cinq associés.\\

Nous travaillons en collaboration avec de nombreuses entreprises locales et partenaires pour la production matérielle.
Nous travaillons évidemment en collaboration avec le client lors de la réalisation d'une application personnalisée.\\
 
Chaque associé est responsable d'un département spécifique, choisi suivant les goûts et aptitudes de chacun. Les responsabilités sont les suivantes : \\


\img{\rootImages/membres.png}{Répartition des rôles}{0.18}

\textbf{Alexis MAQUIGNON (Département Commercial)} \italic{\n "Je suis attiré par le contact avec le client et la construction d'un projet complet avec celui-ci. Je suis là pour accompagner chaque projet individuellement et conseiller du mieux possible."} \n

\textbf{Baptiste LÉO (Département Production \& Logistique)} \italic{\n "J'adore me rendre sur chaque site et imaginer le futur de celui-ci. Je me charge de l'élaboration et de l'installation de la logistique et je suis particulièrement proche du terrain et de ses réalités."} \n

\textbf{Nicolas GAUTIER (Département Communication \& design)} \italic{\n "Passionné par le design et les arts graphiques, je me charge de la conception graphique des applications ainsi que de la communication."} \n

\textbf{Mathieu CHARLES (Département Informatique)} \italic{\n "J'aime l'informatique et les possibilités que cette technologie offre. Fervent défenseur du libre sur internet, je tiens à ce que nos solutions développées suivent cette éthique. Je gère le développement des solutions logicielles et l'assistance informatique de l'entreprise."} \n

\textbf{Nicolas LE GUERROUÉ (Département Électronique):} \italic{"Je suis passionné d'électronique depuis mon plus jeune âge. Je m'occupe de la conception électronique des modules de communication sur sites en collaboration avec mon collègue Mathieu C."}\n

\section{Organisation interne}

Si nous avons décidé de nous répartir les tâches en fonction de nos prédispositions personnelles, nous avons aussi choisi de mettre en place une hiérarchie horizontale au sein de notre entreprise.\\
En effet, nous avons la conviction qu'une entreprise dans laquelle chaque membre possède la même force est un bon moyen d'amener à des discussions et de tirer le niveau vers le haut pour proposer le meilleur service possible. \\
C'est pour cela que nous persisterons à conserver l'équité des salaires et des responsabilités, si notre entreprise venait à s'agrandir.\\
Ceci toujours dans le but de conserver notre éthique et de promouvoir des relations saines entre les associés de l'entreprise.


\chapter{Services}

\section{Convictions}

Parce que nous souhaitons instaurer une relation de confiance avec les utilisateurs de nos services, nous publierons l'intégralité de nos logiciels sous une licence libre.\n
Nous sommes en effet persuadés que cette solution apportera de nombreux avantages tels que :
\begin{enumerate}
    \item La possibilité pour n'importe qui le souhaitant de consulter le code source des logiciels proposés afin de vérifier que ce que nous faisons ne va pas à l'encontre de ses convictions
    \item La possibilité que des personnes extérieures à l'entreprise contribuent activement à l'amélioration du système. Ceci pourrait apporter par exemple des détections et des corrections de failles de sécurité beaucoup plus rapides qu'à la normale, des résolutions de bogues simplifiés pour nos équipes et bien d'autres.
    \item La possibilité pour les utilisateurs de personnaliser relativement facilement notre solution pour l'adapter exactement à ses besoins si jamais nous n'en avons pas la possibilité.
    \item La possibilité que n'importe quel domaine puisse en profiter, y compris si celui-ci ne possède pas les moyens de payer les services de suivi que nous proposons. Nous souhaitons en effet rendre notre solution accessible au plus grand nombre afin de promouvoir un tourisme plus responsable et plus sûr. \footnote{La section Service "Sponat" aborde une solution de développement d'entreprise.}
\end{enumerate}

Ainsi, même si nous proposons des produits "logiciels", ce que nous vendons sont des services. L'accompagnement des entreprises dans la mise en place de nos solutions logicielles.
Un service de suivi et d'aide à l'utilisation de nos solutions logicielles.



Notre entreprise met à la disposition des usagers différents services. Ces services sont les suivants :

\section{Service "LOGAL"}

\subsection{Principe}

Le service "LOGAL" \footnote{"LOcalisation par GALiléo"} utilise les nouvelles technologies pour ré-orienter les flux de touristes vers les zones les moins convoitées actuellement de la station. \newline


Notre société a mis au point une application tout à fait révolutionnaire. Cette application utilisera le système Galiléo de ses utilisateurs afin de lui transmettre des données en temps réel sur le flux des touristes, et permettra à l’utilisateur en question de se diriger vers une zone peu fréquentée et contribuer à une sécurité accrue.\n
L'utilisateur pourra donc récupérer de nombreuses informations en temps réel. Ces informations concerneront aussi bien les amateurs que les grands sportifs.
En effet, en renseignant leur capacité sportive et leur âge\footnote{A condition que l'utilisateur l'accepte}, cela leur permettra de se diriger vers les pistes adéquates tout en tenant compte de la fréquentation

\img{\rootImages//application.png}{prototype application}{0.18}



\newpage



\subsection{Système de localisation}

Nous avons opté pour le système satellite de géo-localisation européen appelé Galiléo. \newline 
Ce système, mis en place en 2020 est stable et performant (précision de base de 4 m) et évite la dépendance du réseau américain GPS.

\subsection{Critères requis}
L’efficacité d’une telle application réside dans le nombre d’utilisateurs. Il faut donc un nombre supérieur à 65\% de touristes qui adhèrent à ce projet de manière à ce que celui-ci soit profitable.\n

\subsection{Charte éthique}
Nous tenons très rigoureusement à vous informer des normes étiques de l’application. En effet ce type de projet suscite généralement de nombreux contestataires. Notre société conçoit que des inquiétudes demeurent chez certains utilisateurs. Il est donc nécessaire pour nous d’afficher une totale transparence vis-à-vis de vous et de vos données collectées.\n
Concrètement, l’unique donnée récoltée par l’application est votre position Galiléo. Dans le seul but de vous proposer un séjour plus sûr, votre position est récoltée seulement si vous nous l’autorisez et seulement dans les horaires d’activité du site. \newline 
Une fois votre séjour terminé, il vous suffira de désinstaller l’application.\n

\section{Service "SPONAT"} 

\subsection{Principe}

Le service "SPONAT" \footnote{"SPOrts NATure} est un service qui permettra à l'usager de profiter pleinement du milieu montagneux. \n
En cas d'obstacle sur une piste par exemple, l'utilisateur sera aussi tôt averti par l'intermédiaire de la fonction "talk-to-speech".
Les endroits remarquables seront également répertoriés par l'intermédiaire des autres utilisateurs qui souhaitent faire découvrir un nouvel endroit, par exemple un joli panorama. \n

Parce que le sport n'a pas vocation à être toujours fatiguant, l'application détecte votre temps d'activité physique et vos performances et détecte automatiquement une baisse des performances. Une baisse importante signifie généralement une fatigue. \n \n
De ce fait, il convient de se reposer ou bien de changer d'activité, pour en faire une moins physique. \n
C'est là que notre application intervient de nouveau et propose un panel d'activités adaptées en valorisant au mieux les activités locales.

\img{\rootImages//application2.png}{prototype application}{0.18}

\section{Extension du réseau}

Ce service proposé permettra à de jeunes entreprises ayant les mêmes intérêts pour la nature et la santé de se développer avec des bases saines.
En effet, chaque entreprise de service (culturel, culinaire...) peut, si elle le souhaite, faire partie du réseau et promouvoir ses valeurs aux utilisateurs. \n
Pour y parvenir, il suffira simplement d'en faire la demande à notre entreprise qui déterminera si l'entreprise en question partage la même politique que le réseau d'entreprise.\chapter{Jeu de vérification}



\begin{tabular}{|c|l|l|}
    \hline
    \bold{Code} & \bold{Cible} & \bold{Informations}\\
    \hline
    01 & Imprimante & Envoi de données si l'imprimante est disponible\\
    02 & RS232 & Envoi de données via le port RS232\\
    03 & Clavier & Recopie des caractères du clavier sur l'écran LCD\\
    04 & Chenillard & Démarre un chenillard avec les 8 LEDs\\
    05 & Relais & Active successivement les 4 relais puis les désactive\\
    06 & CDA & \\
    07 & CAD & Tension trop élevée\\
    08 & Mémoire & Opérations sur la mémoire\\
    09 & DIP-Switches & Allume la LED correspondante au bouton\\
    10 & PIA1 & Mettre le DIP-Switches\\
    11 & PIA1 & CA2-CB2\\
    12 & Darlingtions & Active successivement les 4 Darlingtions puis les désactive\\
    13 & 0 -> K7 & Protocole cassette\\
    14 & 1 -> K7 & Protocole cassette\\
    15 & PIAY A &\\
    16 & IF. Externes & \\
    17 & Dump mémoire & \\
    18 & PIAX A/B & \\
    19 & PIAX CA2-CB2 & \\
    20 & Buzzer & Active le buzzer intégré\\
    24 & 25V & Active la tension à 25V\\
    23 & 21V & Active la tension à 21V\\
    24 & 12V & Active la tension à 12V\\
    25 & VPP2 & ?\\
    26 & VPP1 & ?\\
    \hline
\end{tabular}

\section{Emplacement mémoire}

\begin{tabular}{|c|l|l|}
    \hline
    \bold{Fonctions} & \bold{Tailles} & \bold{Informations}\\
    \hline
    Led & 8 bits & \$8682\\
    Relais & 4 bits & \$8640\\
    \hline
\end{tabular}

\begin{graphic3D}{title}
\end{graphic3D}\chapter{Contenu}

%######################################################
\section{Partie I - Les bases}

\begin{items}{red}{\Circle}
\item Présentation des périphériques (schéma)
\item Le bureau Windows
\item Le menu Démarrer
\item La barre des tâches
\item Quizz Ordinateur Débutant ou exercice concret
\end{items}



%######################################################
\section{Partie II - Souris et clavier}

\begin{items}{red}{\Circle}
\item Clic, double clic, clic droit
\item Présentation d’un clavier (chercher touche exotique, clavier numérique verrouillé)
\messageBox{Remarque}{orange}{white}{Désactiver les pavés numériques avant la session ! }{black}
\item Ecrire et modifier un texte (curseur, saisie de texte)
\item Les raccourcis clavier (evocation copier coller, équivalent clic-droit)



\item Quizz souris et clavier
\end{items}


\section{Partie III - Les fichiers et dossiers}

\begin{items}{red}{\Circle}
 \item Arborescence des dossiers (Espace personnel) 
 \messageBox{Remarque}{orange}{white}{Exo : télécharger un document et l'enregistrer dans un dossier nommé "..."}{black}
 \item Gestion des dossiers et fichiers (suppression, copie , déplacement)
\item Les icônes
\item Les fenêtres (retour, fermeture, gestuelle Windows, déplacement des fenêtres)
\item Clé USB, carte SD, disque dur externe
\end{items}



\section{Partie IV - Les mails et Internet}

\subsection{Organisation boîte mail}

\begin{items}{red}{\Circle}
\item Boîte de réception: tous vos nouveaux messages arriveront dans ce dossier
\item Boîte d’envoi : les messages qui sont en train d’être envoyés par Internet
\item Brouillons : les messages que vous avez commencé à rédiger mais pas envoyé
\item Éléments envoyés : un historique de vos messages envoyés
\item Éléments supprimés : les e-mails, reçus ou envoyés, que vous avez supprimé
\item Courrier indésirable : également appelé spam, ce sont des messages à ignorer. 

\end{items}

\subsection{Écrire un mail}

\begin{items}{red}{\Circle}
\item Objet : c’est le titre du message. Il doit être concis
\item Expéditeur : C’est la personne qui envoie le message
\item Destinataire(s) : La ou les personnes recevant le message
\item Corps du message : le contenu de l’e-mail
\item Pièces jointes : Les fichiers attachés au message
\item Répondre : la zone pour écrire votre réponse
\end{items}

\subsubsection{Ajouter un fichier joint dans son mail}

\begin{items}{red}{\Circle}

\item Repérez le bouton Joindre ou l’icône en forme d’agrafe lorsque vous tapez votre message.
\item Une fenêtre s’ouvre alors, vous demandant de choisir le ou les fichiers voulus.
\item Cliquez sur Ouvrir ou Joindre pour joindre le message

Une nouvelle ligne apparaît dans votre e-mail : votre fichier est joint et prêt à être envoyé

\end{items}






\subsection{Recherche Internet}
\begin{items}{red}{\Circle}
\item Ouvrir un navigateur
\img{\rootImages/Capture.PNG}{Vue globale du navigateur}{0.8}
\item Naviguer sur une page internet
\img{\rootImages/navigation.PNG}{Navigation sur une page}{0.9}
\end{items}

\subsubsection{Rechercher une information utile}
\begin{items}{red}{\Circle}

\item Un horaire d'ouverture, se renseigner sur un sujet (foot, wikipedia, informations...)
\item Rechercher une réponse à un problème

\end{items}

\newpage

\subsection{Bureautiques}
\messageBox{Remarque}{red}{white}{Vérifier que l'on a bien Libre office à l'ENIB }{black}



\begin{items}{red}{\Circle}
\item Comparaison entre Libre Office et Microsoft Office
\item utilisation du traitement de texte. (libreOffice Writer) :\\
élements de base (Titre, sous titre pour le formalisme), mettre un passage en gras/italique/ en couleur...
\item Element un peu plus technique\\
Insérer un tableau, une image (changer l'adaptation d'une image)

\item Libre Office Impress
\item Insérer une image, nouvelle diapositive, mise en page
\end{items}

Manipulation pour les plus expérimentés:

imprim écran.

paint extrait le contour (image voulu).

copier coller dans un document writer.

Puis pourquoi pas l'imprimer.


\subsection{Périphériques}

\begin{items}{red}{\Circle}
\item Imprimantes
\end{items}
\section{Fin de séance}

Petit goûter 
Demande des thèmes futurs



A la fin de la séance on leur demande sur quoi ils veulent travailler la prochaine fois, s'il y a des demandes particulières, d'autre thèmes, un approfondissement... 


\section{Organisationnel}

- Pauses sur demande, quand on le souhaite, et que l'on sent qu'ils ont du mal à se concentrer. Pause d'environ un quart d'heure.


\section{mails}

- mail pour service réception.
- Relance Anne-Marie, appel dès réception de la convention


\section{Proposition de la permanence}

\begin{items}{red}{\Circle}
\item Bureautique
\item Multimédia
\item Imprimante
\item Bonne pratiques (fichiers temporaires sur le bureau....)
\end{items}



\section{Devoirs}

On peut leur demander de réaliser quelques actions chez eux, pour ceux qui le souhaitent.

- 
- envoyer un mail
- écrire dans un bloc note leur retour d'expérience et nous l'envoyer par mail



\section{Répartition des rôles}

Nicolas : Souris et claviers

Théo : Fichier et dossier

Romain : Mails et Internet

Corentin : Les Bases


\chapter{Lettre}

\subsection{L'énergie}

Tout d'abord nous voyons l'avenir comme une époque d'avancées technologiques dans les domaines de l'énergie renouvelable et de l'hydrogène. Dans notre groupe nous misons particulièrement sur l'hydrogène. On a pu également aborder le sujet de la fusion nucléaire comme autre avancée majeure.\\

Pour ce qui est des ressources,  certaines matières premières n’existent quasiment plus, telles que le pétrole. Il y a donc des alternatives au pétrole, telles que les plastiques d’origine végétale ou encore des carburants synthétiques (c'est le tout début en ce moment avec Porsche), il reste pour nous encore du cuivre car on a amélioré notre manière de concevoir pour prendre en compte le recyclage de ces métaux.
Le recyclage est omniprésent. On ne jette rien sans le recycler. Tout est démonté pour ensuite être réutilisé et cela presque à l’infini.\\



Chaque régions du globe est auto suffisante en terme d’énergie. Chacun utilise l’énergie la plus adéquate. Le solaire pour les pays chaud, l’hydraulique et l’éolien dans certaines régions. Les technologies utilisées sont bien dimensionnées. Utilisation du low tech quand pas besoin de plus et vice versa. Ce qui a permis de sauver la planète, mais au dernier moment (OUF).


\subsection{La société}

Pour ce qui est de l'aspect sociétal, nous ne voyons pas une société comme \underline{1984}\footnote{George Orwell}\\
En Europe, il n'y a que des démocraties (des vrais pas comme en Russie), même les royautés fonctionnent sous un régime démocratique. Les titres royaux existent toujours mais sont plus honorifiques, par exemple l'Espagne actuelle. 
Le Moyen Orient reste toujours une zone instable.\\


La Bretagne est la région la plus prisée de France, elle est très touristique mais du coup le coût de la vie est plus chère. En effet, il fait aussi chaud que dans le sud de la France (de notre époque). Pour ce qui est du monde en général les évènements climatiques sont de plus en plus fréquents et de plus en plus forts. Résultat du réchauffement climatique, mais les choses s'améliorent.

\subsection{Les loisirs}

Pour ce qui est des loisirs, le foot est toujours prédominant, néanmoins les salaires ont diminué.\\ 
Pour l'aspect culturel, les domaines classiques (Opéra, théatre, etc) ont disparu pour laisser place à des expositions (histoire, technologie ...).\\

Pour ce qui est du 7ème art nous espérons de très bon films à l'instar de Star Wars, Avatar, Interstellar, le Seigneur des Anneaux ou encore Iron Man. Les films sont passés en réalité virtuelle, le spectateur devient le héros du film. Les salles de cinéma deviennent alors de plus en plus prisées de pars cette évolution technologique.

\newpage
\section{Les missions de l’ingénieur}
%
%La société attend toujours plus d’innovations de la part des ingénieurs et tous les domaines. Ceux-ci sont donc sous-pression et sont désignés comme étant les responsables des échecs et des réussites de toute la société. \\
%
%
%Quelques ingénieurs fous osent se risquer dans le domaine de la politique, tentant, souvent en vain, d’apporter un peu de raison et de réalisme dans les décisions prises. Encore une fois, les rares s’y risquant endossent les responsabilités du politique associés à celles de l’ingénieur.\\
%
%Il y a un retour aux écoles d’ingénieurs spécialisées dans certaines industries. Les gros secteurs de l’industrie créer leur propre école d’ingénieurs (style Amazon). La spécialisation du travail de l’ingénieur aamené la création de nombreuses écoles récentes. Certaines créés par les descendants directs des GAFAM.\\
%
%Elles forment les ingénieurs à ne réfléchir que d’une manière et pour une seule chose.
%Cependant, les ingénieurs style ENIB se démarquent par leur vision du monde plus globale et construisent la société de demain. Malheureusement le profit et l’argent reste au cœur de la société.\\
% 
%Le rôle de l’ingénieur généraliste est dévalorisé car souvent perçus comme moins "utiles" à la société et moins "utilisables" par les employeurs. Ceux-ci sont pourtant souvent les plus avisés et responsables dans leurs décisions car ils possèdent une bien meilleure vision de l’état du monde actuel.\\
%
%Dans 40 ans, les entreprises prennent conscience de l’importance de l’ingénieur, qui devient le pilier des entreprises, on ne forme plus de manager ou commercial sans un minimum de connaissance technique, cela permet une meilleur communication dans l’entreprise. En effet les managers connaissent désormais les contraintes rencontrées par les techniciens et ouvriers et prennent des décisions en tenant compte de la réalité du terrain. \\
%
%Dans l’entreprise, il n’y a plus de séparation aussi stricte entre les ingénieurs, les techniciens et les ouvriers. De grandes salles avec 4 ou 5 personnes, regroupées par service, existent.\\
%Le télétravail est de mise et est vu comme un atout pour les entreprises. En effet il permet au personne loin géographiquement de prendre part aux activités de plusieurs entreprises.
%
%
%Définir et approfondir les mots : 
%\begin{items}{blue}{\Triangle}
%\item \bold{Responsabilité} : 
%\item \bold{Communication} : il y a de plus en plus de communication entre service, ce qui facilite le travail de groupe.
%\item \bold{Innovation} : Toutes les nouvelles méthodes sont testés et encouragés par les entreprise
%\item \bold{Intégrité} : Toutes les décisions sont prises en connaissance de cause et assumées. L'honnêteté et la transparence sont primordiaux pour les postes à responsabilité.
%\item \bold{Résilience} : Les ingénieurs de 2061 font preuve de beaucoup de résilience par rapport aux erreurs commises auparavant. Ils arrivent à trouver des solutions pour résoudre des problèmes qui étaient mal engagés tels que ceux liés à l'environnement.
%\end{items}

%\newpage

Mon très cher ami,

Je conçois parfaitement que vous soyez assailli de doutes lors de votre entrée à l'ENIB par ces temps incertains.

Il relève donc de mon devoir d'essayer de vous aider et ainsi de vous apporter mes maigres connaissances et ma vision de votre futur.

Il ne vous sera pas rare d'entendre que nous vivons les heures les plus sombres de l'humanité, que votre génération doit composer avec les erreurs de
toutes les précédentes dans une société ravagée, sur une planète à l'agonie.
Laissez-moi vous rassurer, ce discours est plus ou moins similaire depuis plusieurs dizaines d'années. A tort, ceci dit.

En effet, selon moi, les heures les plus sombres de l'humanité ne surviendront que lorsque celle-ci n'aura plus d'espoir, plus de solution.
C'est justement là qu'intervient le métier d'ingénieur tel que vous vous apprêtez à le découvrir.

Ma génération a assistée à la métamorphose de notre métier. Notre simple rôle de concepteur technique a finalement aussi endossé le rôle de politique.
Lors de la crise de 2040, la société s'est reposée sur les ingénieurs généralistes et leur vision globale de ce monde pour le reconstruire.
Ceux-ci ont alors jouis du prestige des réussites mais également subis la honte des échecs.

Les ingénieurs étaient désignés d'office responsables de la société. Cette situation n'a depuis, jamais été remise en cause.

Cela a bouleversé toute l'organisation mondiale. Il était alors inacceptable que dans une entreprise, un rôle de manager, de responsable soit confié à
une personne sans aucune formation technique. Celle-ci était et reste considérée comme obligatoire pour que la hiérarchie ait conscience des contraintes
imposées à une équipe et de leurs conséquences.

Paradoxalemenent, le rôle de l'ingénieur généraliste a été peu à peu dévalorisé au profit des ingénieurs spécialisés.
Ces derniers sont issus des "grandes écoles" fondées par les géants de l'industrie (que l'on appelait alors encore les GAFAM). C'est dans cette période
que de telles formations ont pris leur essors. Faciles d'accès, ammenant systèmatiquement à un travail et un bon salaire, elles ne sont cependant pas
conçues pour apprendre aux jeunes citoyens à réfléchir et à aborder le monde avec curiosité. En réalité, je me permettrai de les qualifier de "stériles".
Ne servant que les intérêts des géants, leur unique but est de fournir de la main d'oeuvre facilement utilisable et ne cherchant pas à remettre en cause
les institutions en place.

Alors pourquoi ceux-ci sont-ils valorisés malgré ce portrait bien peu flatteur ? La raison est très simple : ils sont présentés comme plus utiles à la
société. Réalisant concrétement des actions. Ils conçoivent, prototypent et concrétisent des demandes de la société.
Leur vision très limitée de notre monde ne leur permettent cependant, de ne créer que des projets à court terme et sur un domaine bien précis.

J'estime que cette présentation historique, cette explication du cheminement parcouru pour en arriver à notre situation est essentielle pour vous parler
de votre futur.
Comme vous aurez pu le constater, nous avions l'espoir que, enfin, la société se repose sur des personnes ayant conscience des problèmatiques à résoudre
et capables d'apporter des solutions.
Cela s'est réalisé, sur une période très courte. Puis nous sommes de nouveau retombé dans une vision à court terme.
C'est ici que vous, futur ingénieur généraliste, intervenez. Ce n'est pas parce que des écoles comme l'ENIB sont en perditions que vous devez perdre
ce qui fait leur force.
Ces écoles ont toujours visés à former des ingénieurs conscients et responsables.

Le futur de votre métier, selon moi, sera donc de faire profiter le monde de votre formation devenue si rare. Simplement partager votre point de vue,
amener à la réflexion sur la société en place, lier le technique et l'humain pour parvenir à créer un système fiable sur le long terme.
Votre vision globale de ce monde vous permettra d'obtenir le meilleur de vous même et des ressources que vous avez à votre disposition.

Ces possibilités sont à prendre avec les responsabilités qui les accompagnent. C'est à vous que l'on attribuera les futurs échecs et réussites de la société.

Plus que jamais, votre rôle est primordial. Vous avez, littéralement, la possibilité de changer le monde.

J'espère de tout coeur ne pas vous avoir découragé. Beaucoup de chose restent à accomplir.
Je vous souhaite bon courage et de réussir, quel que soit la voie que vous choisirez.

Amicalement vôtre,



\chapter{Rapport d'étonnement}

\newcommand{\pd}{Petits Débrouillards }

\section{La Fresque du Climat}

Probablement l'une des activités les plus marquantes de cet intersemestre.\\

Bien que je doutais d'apprendre beaucoup plus de choses que ce qui était déjà de l'ordre de ma connaissance, j'en suis ressorti profondément marqué. En effet, cet atelier m'a appris et fait réalisé énormément de choses.
Il était par exemple intéressant de savoir que l'impact de l'Homme sur le changement climatique a pu être mesuré. Cela m'a permis de me rendre compte à quel point nos activités ont un impact. Ce lien entre les "on dit que" et la réalité a été extrêmement puissant.\\

L'apprentissage sous forme de cartes avec une interaction active entre les participants nous a permis de confronter nos avis et nos connaissances sur le sujet. \\

Les remarques de la part de l'intervenant à la fin de l'atelier, bien que peu joyeuses de premier abord, nous offrent un moyen de quantifier approximativement notre impact individuel et nous ont offertes un peu d'espoir quant à l'avenir.\\

J'en ressors avec beaucoup d'idées de progrès que je peux faire dans mon quotidien pour améliorer les choses à mon échelle.

\section{Les \pd}

\subsection{L'expérience avec les enfants}

J'abordais cet atelier avec autant d'appréhension que d'envie. Cette activité de médiation scientifique était pour moi l'occasion de partager mon goût des sciences aux générations futures en espérant susciter des vocations.\\
C'était l'occasion pour moi de me plonger dans l'animation et la médiation scientifique auprès d'un jeune public. J'espère avoir réussi à transmettre un peu de savoir et beaucoup d'envie de s'intéresser aux sciences à et l'expérimentation.\\

Nous avions à charge de présenter le thème "Mélanges et solutions" à une classe de CM2 et de leur présenter le principe de densité à travers diverses manipulations mettant en scène des réactions chimiques.\\

Ce fut pour moi intéressant de réfléchir à la manière la plus appropriée de présenter à des enfants des concepts scientifiques qui sont beaucoup plus compliqué que ce qui est normal d'aborder à leur âge.\\
Cette capacité à rendre intelligible par le plus grand nombre des éléments complexes compte parmi les plus importante pour un ingénieur généraliste qui sera plus tard amener à travailler sur différents domaines et à faire le lien entre ceux-ci.\\

En revanche, l'organisation a, d'une manière générale, été déplorable. Bien que les conditions sanitaires n'aient sans doute pas aidées, cela n'excuse pas tout.\\
En effet, il me semble inacceptable que l'enseignant n'ait eu à sa disposition que une soirée (en dehors de ses horaires habituels) pour organiser vaguement l'intervention du lendemain.\\
Même si il est possible de rejeter une partie de la responsabilité de ce problème sur la communication interne de l'école qui ne semblait pas avoir transmise correctement les informations, la livraison du kit de manipulation la veille dans l'après midi empêche une bonne organisation et une bonne intervention auprès des enfants.\\
Par exemple, les fluides fournis ne se trouvaient que dans un seul gros contenant.\\ Les \pd nous ont ensuite gentiment expliqués après l'intervention que nous devions trouver un moyen de nous organiser avec l'enseignant (qui s'est trouvé être particulièrement aidant ceci dit) pour distribuer ces liquides. Ce qui était parfaitement impossible étant donné que nous avions cours en présentiel tout l'après midi et que l'intervention se tenait le lendemain matin.\\
Tout ceci sachant que la première journée d'intervention a eu une utilité relativement faible et qu'il aurait été préférable de commencer à travailler sur celle-ci dès le début.\\

Tout cela pour dire que cette intervention qui s'annonçait intéressante et constructive s'est terminée en une intervention bâclée, faite avec les moyens du bords, stressante pour l'enseignante qui semblait baigner dans l'inconnu et d'une qualité moyenne pour les enfants.

\subsection{Le Grand Jeu}

Suite à cette première expérience, nous devions créer et organiser un grand jeu dans le bassin de Brest pour un public donné. Dans notre cas, il s'agissait d'une famille avec deux enfants. En conséquent, les activités devaient être adaptées à ce public.\\

Je devais, avec mon groupe, faire découvrir un lieu historique. Nous avons choisi les Ateliers des Capucins et à travers les différentes machines, nous leur avons fait un jeu de piste se basant sur des énigmes et des photos. A chaque énigme résolue, quelques informations étaient dispensées à l'aide d'une page internet que nous avions rédigés au préalable.\\

En parallèle, mon groupe devait également participer à un grand jeu organisé par d'autres étudiants de l'ENIB. Le jeu était fort sympathique, nous devions découvrir un ensemble de scientifiques par l'intermédiaire des rues et places de la technopôle. Nous avons cependant regretté que l'aspect éducatif du jeu passe uniquement par des liens redirigeant vers des pages wikipédia.\\

J'ai eu les même regrets que lors de la première activité. On nous a toujours présentés ce jeu comme étant une activité que nous aurions eu le temps de préparer. Or, celui-ci était en réalité un hackaton avec une seule journée pour préparer de A à Z en sachant qu'il fallait faire du repérage, installer et tester le jeu dans un délai très court.\\
Cependant de pars les contraintes choisis, le jeu s'est transformé en balade avec quelques informations dispensées maladroitement, pour ma part cette activité ne m'a rien apporté si ce n'est de la frustration.\\

Pourquoi nous faire faire deux activités avec les \pd et donc réaliser deux actions "baclées" au lieu d'en faire une seule organisée, préparée et réfléchie, ce qui aurait pu donner un très bon rendu.\\

\addQuote{Bonne chance !}{L'équipe des \pd}




\section{Négociations}

L'art de la négociation est très vaste et l'intervention m'a permis de me rendre compte à quel point il peut être difficile d'argumenter dans certaines conditions.\\
Cependant, j'ai compris quelque chose d'essentiel, c'est que dans la négociation il n'y a ni gagnant ni perdant. L'objectif est de trouver un accord pour trouver satisfaction et trouver la solutions la moins contraignante.\\

En effet, dans notre métier nous serons amené à travailler en équipe et donc à se mettre d'accord.
Nous avons les cinq techniques de négociation qui sont le \bold{compromis}, le \bold{consensus}, l'\bold{abandon}, la \bold{fuite}, et le fait d'\bold{imposer son point de vue} en cas d'urgence. Nous avons aussi vu la méthode de Fisher et Ury pour réussir sa négociation.\\

Les notions étaient toujours introduites par des mises en situations afin de voir comment on réagit.\\ Ensuite, une méthode nous était présentée afin de voir comment nous aurions pu procédé.\\
Je pense que cet atelier m'a été bénéfique et me sera profitable autant dans ma vie quotidienne que dans mon futur métier.


\section{Collapsologie}

J'ai trouvé cet atelier très intéressant, notamment le fait de parler des problèmes liés aux croisements des enjeux.\\
Pour illustrer ce fait, nous avons parlé de l'obsolescence programmé, ce qui selon moi résume bien la manière de penser de notre société.\\
En effet, nous sommes partagé entre l'envie de faire des efforts au point de vue écologique et l'envie de créer de l'emploi. Nous avons vu que la création ou le maintient d'emploi a toujours été privilégié.\\
Ce fait peut s'illustrer par les fabricants d'ampoule, qui se sont mis d'accord pour limiter la durée de vie des ampoules afin de pouvoir vendre plus, et donc créer des emplois. L'ultra-consumérisme est un phénomène intéressant à traiter car il soulève beaucoup de question.\\

Le rappel des neuf frontières planétaires était aussi très intéressant. Cet atelier, tout comme celui sur la fresque du climat nous a amené à se poser beaucoup de questions sur notre mode de vie et sur ce que l'on doit faire pour améliorer les choses.



\section{Management d'Équipe}

Cette activité m'a permis de me rendre compte des différentes étapes de la création d'une entreprise jusqu'à sa gestion.

Le jeu interactifs m'a permis de réaliser que la gestion d'une entreprise repose beaucoup sur la communication. \\
Sans cette dernière, que ce soit en interne ou bien pour les intervenants externes (fournisseurs, clients), la viabilité d'une entreprise est compromise.\\

De plus, elle nous a permis de découvrir certains aspects auxquels il est nécessaire de penser quand on créer notre entreprise, notamment en ce qui concerne les frais liées à celle-ci.





\section{Le Court-Métrage}

Après avoir visionné des courts-métrages durant notre première matinée, nous avons été mis dans le bain car je devais réaliser un scénario avec mon groupe de tournage. \\ Après de nombreuses délibérations, nous avons pu partir sur une histoire de vol de matériel à l'ENIB.\\

Les jours suivants furent encore plus intéressants car nous avons commencé le tournage sur différents lieux de tournage. La partie plus pénible concernait tous les plans avec des sons car la mise en place fut beaucoup plus longue et la prise de sons étaient souvent compliquée avec les conditions en extérieur.\\
Cependant, l'ambiance était très bonne au sein du groupe et cela nous a permis de nous amuser tout en étant efficace.\\

L'utilité de l'intervenant lors de cet atelier pourrait être questionnée. Même si regarder des courts métrages réalisés auparavant peut apporter quelque chose, on peu soulever la question de la pertinence de nous faire faire ceci en amphi. Mais ne pas nous apprendre à filmer, je trouve ça dommage. Mettre a dispositions des élèves des guides et des astuces tant pour le montage que pour la prise son et vidéo aurait été une bonne chose.



\section{Délibération et Débats Éthiques}

J'ai trouvé que chacun des débats était très intéressant, car il y avait toujours deux groupes de personnes qui ne voyaient pas les choses de la même manière.\\


De plus, lorsque le débat traite de l'éthique, il convient de peser le pour et le contre bien attentivement car les situations peuvent s'avérer dangereuses.\\
La notion de débat amène bien souvent à une longue phase de délibération au sein du groupe afin de réfléchir à la meilleure proposition. \\

L'incertitude morale a lieu en présence d'un groupe ou ce dernier est obligé de prendre une décision collective afin de résoudre un problème. Lorsque ce dernier semble insoluble, cette décision tourne au dilemme et il convient de choisir la "meilleure solution".
Cependant, la meilleure solution est-elle celle de la majorité ?\\

Nous avons cherche ensemble des solutions parfois insolubles, ce qui a permis de mettre en place un dialogue constructif, même si au début, lors des premiers exemples, chaque personne restait sur ses positions ce qui formait un débat avec des arguments "creux".\\

La prise de conscience du type de discussion m'a fait réfléchir à ma façon de discuter au sein d'un groupe, ce qui m'a permis de moins me braquer sur mes positions.\\


Pour ma part, cette activité s'est révélée décevante. En effet, quelques soucis techniques nous ont malheureusement empêchés de profiter pleinement de cette intervention. Outre ceci, bien qu'étant intéressante, j'ai regretté que cette intervention ne nous laisse pas plus de temps pour débattre entre nous de différents sujets (je pense notamment à la fabrication d'arme(s) par exemple).

\section{Cyberdéfense}

Même s'il me paraissait, au départ, inadéquat de proposer cet atelier en présentiel, il s'est au final avéré que Olivier BALD a sut tirer profit de ce privilège pour apporter une interactivité plaisante.\\
Il m'a rarement été donné d'assister à une conférence aussi intéressante et utile, je me suis même dit que cela pourrait être pertinent d'en faire une matière enseignée à l'ENIB. En effet la cyberdéfense est pour moi un des enjeux majeurs de notre société actuelle auquel nous serons confronté en tant que ingénieur.



\section{SST}


La formation que j'ai effectué était intéressante pour connaître les responsabilités au sein de l'entreprise. 

L'avantage de l'auto-formation est que je pouvais la faire en dehors des temps dédiés afin d'assouplir mon emploi du temps d'intersemestre. \\Je pouvais donc me former pendant les temps creux. \\

La pertinence du distanciel est d'autant plus justifié que l'on apprend tout autant avec un intervenant présent physiquement que sur un écran.


\section{Sensibilisation à la différence}

Nous étions répartis en groupe de 4-5 et nous devions rédiger une charte pour améliorer le comportement des élèves à l'ENIB sur le sexisme, discrimination, etc.\\

Après avoir proposé différentes actions pour améliorer nos comportements, l'intervenant a fait une synthèse et nous avons accepté ou non la charte.\\

Pour notre dernière journée d'intersemestre, nous avons pu assister à plusieurs représentations de mini-pièces afin de sensibiliser aux discriminations. Les intervenants ont réussi à amener beaucoup d'interactions lors des interventions

Enfin, nous avons pu mettre en scène une pièce et nous avons choisi le thème "État de santé" où nous avons exprimé un problème lié aux vacances et aux allergies.\\

Ces interventions m'ont permises de me rendre compte que même aujourd'hui, à l'ENIB, il y avait malheureusement encore des comportements discriminatoires et/ou blessants.


\section{Test Sportif UBO}

Le test sportif est un bon moyen de voir si notre forme physique est bonne. En tout qu'étudiant et surtout en période de confinement, nous passons beaucoup de temps assis derrière notre bureau.

\section{Atelier Nutrition}

J'ai trouvé cet atelier très intéressant car étant étudiant tout conseil nutritionnel est le bienvenu. On avait la possibilité de poser des questions à des professionnels ce qui est pour moi une très bonne chose. Pour ma part j'ai appris des choses et les conseils donnés étaient les bienvenus.

\newpage
\section{Divers}

La multitude des supports d'expressions et de liens de communications a été un calvaire pour cet intersemestre. En effet, le nombre de supports dont voici un extrait : 

\begin{itemize}
    \item Zoom
    \item BigBlueButton
    \item Jitsi
    \item RocketChat
    \item Mail
    \item Moodle
    \item Wiki(s)
\end{itemize}


\chapter{Conclusions}

Dans l'ensemble, cet intersemestre  qui s'annonçait prometteur et que j'attendais avec enthousiasme s'est révélé entaché par des problèmes d'organisations.\\

Si certains n'étaient que peu gênants, les déboires avec Les \pd, qui constituaient une partie très importante de nos activités, m'ont très sérieusement refroidis. Ceux-ci ne nous ont au final apportés que peu de choses par rapport au stress engendré et au temps demandé.\\

Il reste important de noter que de nombreuses choses ont été vues dont je me souviendrais pendant longtemps et qui me seront sans aucun doute d'une grande utilité.\part{Mise en place du répertoire}

\chapter{Introduction}

\section{Présentation}
Ce document a pour but de présenter les fonctionnalités de la bibliothèque Utils, qui n'est qu'un 
regroupement de bibliothèques pour simplifier l'utilisation de Latex. \\

Cette documentation, dans un contexte plus général, présente la mise en place et l'utilisation d'un répertoire de travail Latex. \\
Voici les bibliothèques disponibles: 

\begin{items}{darkBlue}{\faviconLeaf}
\item Badges
\item Bibliography
\item Colors
\item Debug
\item Electronic
\item Figures
\item Fonts
\item Footnote
\item Glossaries
\item Graphics
\item Header
\item Images
\item Index
\item Items
\item Labels
\item Layout
\item Links
\item Lipsum
\item Maths
\item MessageBox
\item Nomenclature
\item Objects3D
\item Parts
\item Pdf
\item Programming
\item Quotes
\item TableOfContent
\item Tables
\item Theorems
\item Titles
\item Tree
\end{items}\chapter{Installation}

\section{Installation des outils}


La bibliothèque \lib{Utils-latex} regroupe les outils pour installer et compiler un répertoire de travail Latex.
\messageBox{\faviconInfo}{green}{green}{L'ensemble des outils présentés est optimisé pour une utilisation avec le logiciel Visual Studio Code}{black}

Il faut donc saisir la commande suivante dans le dossier où l'on souhaite créer le répertoire de travail : 

\begin{Bash}{Clone de la bibliothèque et démarrage de l'installation}
git clone https://github.com/nicolasleguerroue/Utils-latex.git && Utils-latex/tools/init
\end{Bash}

On vous demande ensuite si vous souhaitez mettre à jour le système.
\img{\rootImages/acceptInstall.png}{Installation des paquets}{0.7}
Répondre \bold{y} est fortement conseillé. A ce moment là, l'ensemble des logiciels et paquets nécessaires vont être installés.\\
Voici les paquets installés : \\
\begin{items}{blue}{\faviconLeaf}
\item texlive-full
\item git
\item texlive-lang-european
\item okular
\item gnuplot
\end{items}

Enfin, on vous demande si vous souhaitez installer les extensions VScode, encore une fois, l'acceptation est vivement recommandée.
\img{\rootImages/installExtensions.png}{Installation des extensions VSCode}{0.7}

Le logiciel VSCode se lance une fois que l'installation est terminée.


\section{Configuration des tâches}

Lors de l'ouverture du répertoire de compilation, un script de vérification va se lancer automatiquement.
Pour ce faire, il va falloir activer le lancement des tâches.\\ 
Il faut faire le raccourci clavier \shortcut{CTRL+SHIFT+P} et saisir \bold{Manage Automatic tasks in Folder} 
\img{\rootImages/manage.png}{Lancement des tâches au démarrage}{0.5}

Puis valider l'action avec \bold{Manage Automatic tasks in Folder}

\img{\rootImages/allowManager.png}{Activation des tâches au démarrage}{0.5}

Ce script exécuté au démarrage permet de vérifier l'intégrité des fichiers (paramètres, outils) avant de lancer une compilation.\chapter{Architecture}

\section{Organisation du projet}

\createNoCenteredFigure{Arborescence du projet}{
\dirtree{%
.1 \dir{Projet}. 
.2 \dir{Images}.
.3 \dir{Intro}.
.3 \dir{Content}.
.3 \dir{OtherDirectory}.
.2 \dir{Make}.
.3 \file{Alias.tex}.
.3 \file{Bibliography.bib}.
.3 \file{Colors.tex}.
.3 \file{Contacts.tex}.
.3 \file{Glossaries.tex}.
.3 \file{Index.tex}.
.3 \file{Nomenclature.tex}.
.3 \file{Rules.tex}.
.3 \file{Versions.tex}.
.2 \dir{Output}.
.2 \dir{Parts}.
.3 \dir{0.Intro}.
.3 \dir{1.Content}.
.3 \dir{2.OtherDirectory}.
.2 \dir{Settings}.
.2 \sym{Utils}.
.2 \dir{Utils-latex}.
.3 \dir{bash}.
.3 \dir{HTML}.
.3 \dir{tools}.
.3 \dir{Utils}.
.3 \dir{.vscode}.
.3 \file{make}.
.2 \sym{.vscode}.
.2 \file{main.tex}.
.2 \sym{make}.
}
}
 
Chaque projet est constitué de 8 dossiers et de 2 fichiers situés à la racine du projet.\\
Les fichiers ou dossiers violets (SYM) sont des liens symboliques dont la source est située dans le dossier \dir{Utils-latex}.


    \begin{items}{gray}{\faFolder}
    \item Le dossier \dir{Images} contient l'ensemble des images du projet.
    Chaque image doit faire partie de la même partie que son document source associé.\\

    La gestion des emplacements des images est indiqué dans la section \link{\nameref{handleImages}}\\

    \item Le dossier \dir{Make} contient les fichiers annexes du projet: 
    \begin{items}{white}{}
        \item Le fichier \file{Alias.tex} regroupe les nouvelles commandes utilisées pour les abréviations.

        \item Le fichier \file{Bibliography.bib} recense la bibliographie du projet. \\Pour plus d'informations, consulter la section \link{\nameref{biblio}}.

        \item Le fichier \file{Colors.tex} est un fichier pour centraliser les nouvelles couleurs définies.
        Pour ajouter une couleur, veuillez vous référer à la section \link{\nameref{colors}}

        \item Le fichier \file{Contacts.tex} est une page pour contacter l'auteur et contient les informations sur les 
        droits et les licences du projet.

        \item Le fichier \file{Glossaries.tex} contient le glossaire.\\ Pour ajouter une définition, 
        veuillez vous référer à la section \link{\nameref{addDef}}
        
        \item Le fichier \file{Index.tex} contient l'index. \\Pour plus d'informations, consulter la section \link{\nameref{index}}.

        \item Le fichier \file{Nomenclature.tex} contient la structure de la nomenclature\footnote{Les unités et 
        grandeurs physiques par exemple}.\\
        Pour ajouter un élément, consulter la section \link{\nameref{addNomenclature}}

        \item Le fichier \file{Rules.tex} contient les conventions pour le projet. Il peut contenir les types de commandes, 
        les conventions de nommage du projet \ldots

        \item Le fichier \file{Versions.tex} contient les différentes versions du projet. \\ Pour plus d'information, 
        consulter la partie \link{\nameref{addVersion}}

    \end{items}
    \item Le dossier \dir{Output} contient les fichiers de compilation générés de manière automatique. 
    \bold{Vous n'aurez pas à modifier les fichiers à cette emplacement.}

    \item Le dossier \dir{Parts} contient les différentes parties du projet. Il est possible de scinder son projet 
    en grandes parties (Introduction, Chapitre1, Chapitre2, Conclusion), chaque dossier contenu dans le 
    dossier \bold{Parts} représente ces parties.\\

    Dans chacun de ces dossiers, vous pouvez créer autant de fichiers Latex que vous voulez, il seront compilés dans 
    l'ordre croissant si vous mettre un numéro au début du nom de fichier.\\

    Pour nommer les dossiers dans le dossier \dir{Parts}, \colors{red}{il faut impérativement commencer le nom avec un 
    numéro suivi d'un point.} Par exemple \dir{0.Intro} puis \dir{1.Content}.\\
    \colors{red}{Les espaces sont interdits dans les noms des dossiers mais les symboles ~\_~ et - sont acceptés.}\\

    Pour chaque dossier crée dans le dossier \dir{Parts}, il faudra créer un dossier avec le même nom (sans le numéro et le point) dans le dossier 
    \dir{Images}, sous peine de voir une volée d'erreurs lors de la compilation.\\

    \item Le dossier \dir{Settings} qui contient les fichiers de configuration du projet.\\
    Pour configurer le projet, reportez-vous à la section \link{\nameref{setSettings}}

    \begin{items}{white}{}

        \item Le fichier \file{ChapterAlias.tex} enregistre le nom des chapitres ('Section' au lieu de 'Chapitre' par exemple).
        \item Le fichier \file{DocumentClass.tex} sauvegarde la classe du document.
        \item Le fichier \file{FHeaderLine.tex} s'occupe de l'épaisseur des lignes entre l'en-tête et le pied de page.
        \item Le fichier \file{Fonts.tex} sélectionne la police du document.
        \item Le fichier \file{Header.tex} affiche la première page
        \item Le fichier \file{Hyperref.tex} enregistre les métadonnées du fichier.
        \item Le fichier \file{Includes.tex} est un fichier généré automatiquement pour importer tous les paramètres cités.
        \item Le fichier \file{ListMargin.tex} règle l'indentation des listes.
        \item Le fichier \file{LOF.tex} autorise l'affiche de la liste des figures
        \item Le fichier \file{Margins.tex} s'occupe des marges du document.
        \item Le fichier \file{NomenclatureName.tex} enregistre le nom de la nomenclature.
        \item Le fichier \file{Theme.tex} enregistre le thème des pages.
        \item Le fichier \file{TocDepth.tex} enregistre la profondeur du sommaire.
        \item Le fichier \file{TocSize.tex} enregistre l'agencement du sommaire.
        \item Le fichier \file{SectionColor.tex} enregistre la couleur des sections.
        \item Le fichier \file{SubSectionColor.tex} enregistre la couleur des sous-sections.
        \item Le fichier \file{TitlePrefix.tex} enregistre le préfixe des sections et sous-sections.

    \end{items}
    \item Le dossier \sym{Utils} est un dossier symbolique qui contient les bibliothèques Latex du projet. Le fichier \file{Utils.sty} est généré 
    dynamiquement, toute écriture manuelle sera écrasée à la prochaine compilation.

    \item Le dossier \dir{Utils-latex} contient toutes les bibliothèques du projet ainsi que les outils de compilation. 
    Il est configuré en tant que sous-module Git afin de séparer le contenu des bibliothèques et le contenu Latex à compiler.
    Ce dossier contient :
    \begin{items}{gray}{\faFolder}

        \item Le dossier \dir{bash} qui regroupe plusieurs bibliothèques : 

        \begin{items}{blue}{}
            \item La bibliothèque \lib{Charts.sh} qui permet de générer des graphiques
            \item La bibliothèque \lib{Colors.sh} qui gère les couleurs dans le terminal
            \item La bibliothèque \lib{Directories.sh} qui permet de gérer les fichiers et dossiers
            \item La bibliothèque \lib{Networks.sh} qui surveille l'état de la connexion Internet
            \item La bibliothèque \lib{System.sh} qui permet de faire des fonctions System
            \item La bibliothèque \lib{Time.sh} qui gère les dates
        \end{items}

        \item Le dossier \dir{HTML} qui regroupe plusieurs bibliothèques utilisées pour convertir le code source Latex en fichier HTML : 

        \begin{items}{blue}{}
            \item La bibliothèque \lib{Badge.py} qui gère les badges
            \item La bibliothèque \lib{Color.py} qui gère les couleurs
            \item La bibliothèque \lib{Command.py} qui gère les types de commandes disponibles
            \item La bibliothèque \lib{Glossary.py} qui gère le glossaire
            \item La bibliothèque \lib{Image.py} qui gère les images et leur intégration au sein du fichier HTML\footnote{Compatibilité Wordpress}
            \item La bibliothèque \lib{Label.py} qui gère labels
            \item Le fichier \lib{generateHTML.py} qui génère les pages HTML
            \item Le fichier \lib{startWebServer.py} qui démarre un serveur Web pour afficher la page Web de rendu
            \item Le dossier \dir{HTML\_render} contient les pages Web générées
        \end{items}
        \item Le dossier \dir{tools} regroupe plusieurs fichiers : 

        \begin{items}{blue}{}
            \item Le fichier \lib{checking} qui permet de vérifier l'intégrité du dossier de projet lors du lancement de VScode
            \item Le fichier \lib{init} qui initialise le dossier du projet
            \item Le fichier \lib{install} qui installe les paquets et utilitaires pour la compilation
            \item Le fichier \lib{compileAnyFiles.py} désactive la compilation pour l'ensemble des dossiers contenus 
            dans le dossier \dir{Parts}. \footnote{Concrètement, cela revient à ajouter un point devant le nom du 
            dossier pour que le compilateur ignore le dossier.}
            \item Le fichier \file{compileAllFile.py} autorise la compilation des dossiers contenus dans le dossier \footnote{On retire les points devant les noms.}
            \item Le fichier \file{generateSnippets.py} créer un fichier de snippets VScode
            afin de gérer l'autocomplétion VSCode. \bold{Ce fichier doit obligatoirement être appelé depuis le 
            fichier \lib{make}}
        \end{items}


    \end{items}

    \item Le dossier \sym{.vscode} contient tous les fichiers de configuration du répertoire VScode : 
    \begin{items}{cyan}{}

        \item Le fichier \file{settings.json} contient les tâches exécutables VScode via un bouton \footnote{Cf. \link{\nameref{allTasks}}}. Ces tâches permettent de lancer la compilation et les utilitaires du répertoire.
        \item Le fichier \file{task.json} est le fichier qui recense les tâches exécutables sous VSCode.
    \end{items}


    Et voici les deux fichiers situés à la racine: 
    \begin{items}{black}{\Triangle}

        \item Le fichier \file{main.tex} est le fichier principal du projet. C'est dans ce fichier qu'on définit notamment :

        \begin{items}{darkBlue}{\Triangle}
            \item L'import de la classe du document
            \item Le titre de la page
            \item Le choix de la disposition du document
            \item Le choix de la présence des fichiers dans le dossier \dir{Make}, c'est à dire les fichiers 
            personnalisables tels que la bibliographie, l'index, le glossaire\ldots
        \end{items} 
        \item Le fichier \sym{make} est le fichier de compilation. \bold{Vous n'aurez pas besoin de modifier ce 
        fichier pour une utilisation classique}
    \end{items}
\end{items}\chapter{Compilation}

La compilation du projet se fait grâce au fichier \lib{make} situé à la racine du projet.\\
L'ensemble des outils de compilation sont disponibles de deux façons :

\begin{items}{blue}{\Bullet}
    \item Via un terminal
    \item Via le logiciel VSCode
\end{items}

L'avantage du logiciel VScode est qu'il fournit des raccourcis clavier et une interface graphique plus évoluée (boutons)


\section{Compilation avec un terminal}


\subsection{Compilation classique}

Une compilation classique a pour objectif de générer le fichier PDF de rendu, appelé \file{main.pdf} et situé à la 
racine du projet.\\

La commande est la suivante :

\begin{Bash}{Compilation complète du projet}
./make --full
\end{Bash}

Lors de la compilation, plusieurs fichiers sont générés à la racine, dont : 

\begin{items}{darkBlue}{\Triangle}
    \item Le fichier \file{.render\_report.tex} (fichier caché) qui contient la première partie des fichiers journaux de compilation
    \item Le fichier \file{.render\_report\_logs.tex} qui contient la seconde partie des fichiers journaux de compilation\footnote{Les messages de compilation générés par la bibliothèque Utils sont situés dans ce fichier.}
    \item Une image \italic{Part.png} qui affiche le nombre de ligne pour chaque fichier compilé contenu dans le dossier \bold{Parts}
    \img{\rootImages/Part.png}{Nombre de ligne pour les parties}{0.7}
    \item Une image \italic{Utils.png} qui affiche le nombre de ligne pour chaque fichier contenu dans le dossier \bold{Utils}
    \img{\rootImages/Utils.png}{Nombre de ligne pour les bibliothèques}{0.7}
    \item Un fichier \file{standlone.tex} qui contient l'ensemble du code latex généré. Ne pas supprimer ce fichier, il est utilisé pour la conversion du code Latex en fichier source HTML.
\end{items}

Lors de la compilation, différents messages s'affichent : 

\img{\rootImages/messages.png}{Message d'ajout d'élements de la bibliothèque Utils}{0.5}
\img{\rootImages/warnings.png}{Message d'avertissements}{0.5}

\subsection{Ajout de version}\label{addVersion}

Il est possible d'ajouter une version de projet en invoquant la commande suivante : 

\begin{Bash}{Mise à jour Git}
./make --version
\end{Bash}

La date de la mise à jour vous sera demandée ainsi que le contenu de la mise à jour.

\img{\rootImages/addVersion.png}{Ajout d'une version}{0.5}


\label{setLayout}
\subsection{Mise à jour de l'autocomplétion}

Il est possible de mettre à jour l'autocomplétion sous VScode pour les bibliothèques Utils.
En invoquant le paramètre \bold{--snippet}, il est possible de générer le fichier VScode qui va ajouter l'autocomplétion.\\
Ce fichier est appelée \file{output.snippet-code} et se situe dans le dossier \dir{.vscode}

\begin{Bash}{Mise à jour de l'autocomplétion}
./make --snippet
\end{Bash}

La commande se termine en affichant le nombre de commandes documentées.

%\img{\rootImages/snippetsCount.png}{Fin de la commande de génération de l'auto-complétion}{0.3}






\section{Compilation avec VSCode}

L'ensemble des commandes présentées précédemment sont disponibles sous VSCode.\\

\subsection{Ouverture d'un projet}

Il faut ouvrir un terminal à la racine du projet et lancer la commande : 

\begin{Bash}{Ouverture de l'arborescence avec VScode}
code .
\end{Bash}

\messageBox{\faviconInfo}{green}{green}{Lors de chaque ouverture du répertoire de projet VSCode, un script de vérification des fichiers va se lancer. Les fichiers manquants seront regénérés à leur valeur par défaut.}{white}

Le logiciel se lance avec une interface similaire :

\img{\rootImages/vscode_opened.png}{Le logiciel VSCode ouvert}{0.45}

On observe sur la gauche l'arborescence du projet. En cliquant sur les dossiers, ces derniers se déroulent et affichent leur contenu.

\img{\rootImages/vscode_part.png}{L'arborescence du projet}{0.5}

    
\subsection{Lancement de la compilation}

Il y deux méthodes pour lancer les outils de compilation sous VSCode :

\begin{items}{blue}{\Bullet}
    \item Via les raccourcis clavier (Tâches)
    \item Via les boutons sur l'interface graphique
\end{items}

\subsection{Les raccourcis clavier}

\label{allTasks}
L'ensemble des commandes et outils sont disponibles en saisissant le raccourci \shortcut{CTRT+SHIFT+B} \img{\rootImages/example.png}{Visualisation des commandes}{0.35}


Les commandes sont classées par catégorie, à savoir : 

\begin{items}{blue}{\Triangle}

    \item \bold{Compilation}

    Les commandes pour compiler le projet. 
    \item \bold{Settings}

    Les commandes pour définir les paramètres du projet.
    \item \bold{Display}

    Les commandes pour afficher ou non des éléments (liste des figures...)
    \item \bold{Part}

    Les commandes pour gérer les parties
\end{items}

\subsection{Les commandes de compilation}

Les différentes commandes sont de 3 types :

\begin{items}{green}{\faviconLeaf}
\item Une commande qui lance un script en arrière-plan, sans argument, repérée avec la mention \badge{white}{darkOrange}{script}
\item Une liste avec valeurs déterminées, repérées avec la mention \badge{white}{cyan}{élement}.\\La valeur par défaut est de la couleur bleue foncée (\badge{white}{blue}{Defaut})
\item Zone de saisie utilisateur, repérée avec la mention \badge{white}{purple}{Entrée utilisateur}
\end{items}

\begin{items}{blue}{\Triangle}

    \item Compilation
    \begin{items}{cyan}{\Triangle}
        \item \bold{Full}

        Lance une compilation complète\\ \badge{white}{darkOrange}{script}
        \item \bold{Display HTML render}

        Lance la page d'affichage du rendu HTML du code Latex. Avant de faire cette commande, il faut faire la commande \bold{Compilation > Convert Latex to HTML}\\ \badge{white}{darkOrange}{script}
        \item  \bold{Enable all files}

        Autorise la compilation complète du répertoire \dir{Parts}\\ \badge{white}{darkOrange}{script}
        \item  \bold{Disable all files}

        Empêche la compilation complète du répertoire \dir{Parts}\\ \badge{white}{darkOrange}{script}
        \item  \bold{Display PDF}

        Ouvre le PDF de sortie (main.pdf) avec le logiciel \lib{okular}\\ \badge{white}{darkOrange}{script}
        \item  \bold{Display errors}

        Affiche le fichier de sortie de compilation\\ \badge{white}{darkOrange}{script}
        \item  \bold{Convert Latex to HTML}

        Lance les scripts python pour convertir le Latex en HTML\\ \badge{white}{darkOrange}{script}
        \item  \bold{Light (without bibliography, index and nomenclature)}

        Lance une compilation rapide sans bibliographie, index et nomenclature. Cette compilation ne compile pas l'intégralité du document, la table des matière sera donc absente mais cela a le mérite de compiler rapidement.\\ \badge{white}{darkOrange}{script}
    \end{items}
\end{items}

Pour trier les commandes disponibles, il faut saisir le type de commande (Compilation, Settings...) et les commandes seront triées.

\img{\rootImages/categories.png}{Trie des commandes}{0.5}

\subsection{Les commandes de configuration du projet}\label{setSettings}

Il est possible d'éditer de nombreux paramètres de manière graphique sous VScode.
Les configurations se font via les commandes de type \bold{Settings}

    \begin{items}{black}{\faGear}
        
        \item \bold{Depth of TOC}

        Définit la profondeur du sommaire.

        \badge{white}{cyan}{-1} \badge{white}{cyan}{0} \badge{white}{blue}{1} \badge{white}{cyan}{2}

        La profondeur du sommaire correspond aux types de titre affichés.

        \begin{tabular}{|c|c|c|c|c|}\hline
         Profondeur & Parties & Chapitres & Sections & Sous-sections\\ \hline
        -1 & \colors{green}{\faviconCheck} & \colors{red}{\faviconClose} & \colors{red}{\faviconClose} & \colors{red}{\faviconClose}\\ \hline
        0 & \colors{green}{\faviconCheck} & \colors{green}{\faviconCheck} & \colors{red}{\faviconClose} & \colors{red}{\faviconClose}\\ \hline
        1 & \colors{green}{\faviconCheck} & \colors{green}{\faviconCheck} & \colors{green}{\faviconCheck} & \colors{red}{\faviconClose}\\ \hline
        2 & \colors{green}{\faviconCheck} & \colors{green}{\faviconCheck} & \colors{green}{\faviconCheck} & \colors{green}{\faviconCheck}\\ \hline
        \end{tabular}
        \item \bold{Update of font}

        Définit la police du document

        \badge{white}{blue}{calibri} \badge{white}{cyan}{default}

        \item  \bold{Update of theme}

        Définit le thème du document

        \badge{white}{blue}{Lenny} \badge{white}{cyan}{Glenn} \badge{white}{cyan}{Sonny}
        \badge{white}{cyan}{Conny} \badge{white}{cyan}{Rejne} \badge{white}{cyan}{Bjarne}

        \item  \bold{Update of margins}

        Définit les marges en centimètre du document. Il est possible de définir les marges verticales et horizontales.

        Marges horizontales : \badge{white}{blue}{2} \\
        Marges verticales : \badge{white}{blue}{2}

        \item  \bold{Update of metadata}

        Ouvre le fichier de définition des métadonnées

        \begin{tabular}{cc}
            Titre du fichier PDF & \badge{white}{blue}{main} \\
            Auteur du fichier & \badge{white}{blue}{username}\footnote{Pour ajouter des auteurs, il faut séparer avec une virgule} \\
            Sujet du document & \badge{white}{blue}{main}\\
        \end{tabular}

        \item  \bold{Update of line widht}

        Définit l'épaisseur des traits pour les en-tête et pied de page.

        \badge{white}{purple}{Valeur à saisir} \badge{white}{blue}{0.2}
        \item  \bold{Update of document class}

        Définit la classe du document

        \badge{white}{blue}{utils\_report} \badge{white}{cyan}{report} \badge{white}{cyan}{utils\_article} \badge{white}{cyan}{article}
        \badge{white}{cyan}{beamer} \badge{white}{cyan}{utils\_book} \badge{white}{cyan}{book}
        \item  \bold{Update of nomenclature}

        Définit le nom de la nomenclature.

        \badge{white}{purple}{Valeur à saisir} \badge{white}{blue}{Nomenclature}

        \item  \bold{Update of section color}

        Définit la couleur des sections

        \item  \bold{Update of subsection color}

        Définit la couleur des sous-sections

    \end{items}

\subsection{Les boutons}

Au lieu d'utiliser les raccourcis avec \shortcut{CTRT+SHIFT+B}, il est possible d’exécuter les outils avec les boutons en bas de VSCode : 

\img{\rootImages/buttons.png}{Visualisation des boutons}{0.4}



\section{Autocomplétion des commandes}

Lors du démarrage de l'espace de travail, un script va générer le fichier pour l'autocomplétion des commandes.\\
Chaque commande commence par le mot clé "Utils" puis un point et le nom de la bibliothèque associée. \\

Par exemple, pour obtenir les commandes de la bibliothèque \lib{Images}, en écrivant "Images" dans un document Latex vous obtiendrez le résultat suivant : 

\imgn{\rootImages/Utils_lib.png}{Autocomplétion des commandes}{0.4}{autocompletion}

Vous pouvez parcourir les commandes disponibles puis saisir la touche \shortcut{Enter}.\\
La commande sera écrite à la place du curseur.\chapter{Fusion de projets}

Le choix d'un dossier par partie (Parts/XXX) permet de fusionner très facilement des projets.\\

Pour fusionner deux projets, il suffit de copier-coller le contenu du dossier \dir{Images} et \dir{Parts} du projet A 
dans le dossier de projet qui contiendra la fusion (projet B). Lors de la compilation, \lib{make} va gérer la 
fusion automatiquement.


\chapter{Ajout de bibliothèques personnelles}


Après avoir extrait les 2 dossiers, lancer dans chaque dossier la commande
\begin{Bash}{Création du fichier .sty}
pdflatex *.ins
\end{Bash}

Puis remonter dans le dossier contenant les 2 dossier puis
\begin{Bash}{Création du fichier .sty}
sudo cp -r acrotex /usr/share/texmf/tex/latex
sudo cp -r eq-save /usr/share/texmf/tex/latex
cd /usr/share/texmf/tex/latex
sudo texhash
\end{Bash}
    \section{Conventions}

\loc{Header} veut dire que le code est à mettre avant \bold{begin\{document\}}\\
\loc{Body} veut dire que le code est à mettre entre \bold{begin\{document\}} et \bold{end\{document\}}\\
\loc{main.tex} veut dire que le code est à mettre dans le fichier \file{main.tex}\\
\loc{Make/Nomenclature.tex} veut dire que le code est à mettre dans le fichier \file{Nomenclature.text} situé dans le dossier \dir{Make}\\
\loc{Make/Bibliography.bib} veut dire que le code est à mettre dans le fichier \file{Bibliography.bib} situé dans le dossier \dir{Make}\\\part{Documentations des bibliothèques}

\chapter{Bibliothèque Badges}

La bibliothèque \lib{Badges} gère les badges de différentes couleurs. \\Les couleurs disponibles sont présentées dans la section \link{\nameref{colors}}

\section{Création de badges avec des couleurs}

\badge{white}{black}{Electronique}
\badge{white}{blue}{Mécanique}
\badge{white}{green}{Informatique}

Ceci est un exemple de paragraphe avec un \badge{white}{green}{badge} intégré 
avec du texte. Ce badge est bien affiché même avec un paragraphe multiligne.\\


\loc{Body}
\begin{Latex}{Code pour la création de badges avec des couleurs}
\badge{white}{black}{Electronique}
\badge{white}{blue}{Mécanique}
\badge{white}{green}{Informatique}

Ceci est un exemple de paragraphe avec un \badge{white}{green}{badge} intégré avec du texte. Ce badge est bien affiché même avec un paragraphe multiligne.

\end{Latex}

\input{Utils/Badges.info}\chapter{Bibliothèque Bibliography}
\label{biblio}

La bibliothèque \lib{Bibliography} gère la bibliographie du document.

\section{Format de la bibliographie}

La bibliographie contenue dans le fichier \dir{Make}/\file{Bibliography.bib} doit être au format \bold{Bibtex} : \\

\loc{Make/Bibliography.bib}
\begin{Bash}{Format BibTex}
    @book{ID,
    title={Titre},
    author={Auteur},
    year={2007},
    note={Une description},
    publisher={Editeur}
},
 ...
\end{Bash}

Le mot-clé \bold{ID} permettra par la suite de référencer l'élément dans la bibliographie.


Le format Zotero se base sur cette architecture.

\section{Affichage de la bibliographie}

Pour afficher la bibliographie située dans le dossier \dir{Make}/\file{Bibliography.bib}, il faut saisir la commande suivante : \\

\loc{main.tex}
\begin{Latex}{Code pour l'affichage de la bibliographie}
\displayBibliography{Bibliographie}{Make/Bibliography}
\end{Latex}

\messageBox{\faviconWarning}{orange}{orange}{L'extension du fichier .bib ne doit pas être précisée !}{black}


\img{\rootImages/bib.png}{Un rendu de la bibliographie}{0.5}


\input{Utils/Bibliography.info}\chapter{Bibliothèque Colors} \label{colors}

La bibliothèque \lib{Colors} gère les couleurs dans le document.

\section{Afficher du contenu en couleur}

\colors{blue}{Ceci est du texte en bleu}

\colors{red}{Ceci est du texte en rouge}

\colors{green}{Ceci est du texte en vert}\\


\loc{Body}
\begin{Latex}{Code pour l'affichage en couleur}
\colors{blue}{Ceci est du texte en bleu}
\colors{red}{Ceci est du texte en rouge}
\colors{green}{Ceci est du texte en vert}
\end{Latex}


\section{Liste des couleurs disponibles}


\begin{items}{white}{\Bullet}
    \item \colors{red}{red}
    \item \colors{green}{green}
    \item \colors{blue}{blue}
    \item \colors{orange}{orange}
    \item \colors{yellow}{yellow}
    \item \colors{gray}{gray}
    \item \colors{brown}{brown}
    \item \colors{cyan}{cyan}
    \item \colors{black}{black}
    \item \colors{purple}{purple}
    \item \colors{magenta}{magenta}


    \item \colors{rose}{rose}
    \item \colors{darkBlue}{darkBlue}
    \item \colors{darkBrown}{darkBrown}
    \item \colors{darkRed}{darkRed}
    \item \colors{darkOrange}{darkOrange}
    \item \colors{darkGray}{darkGray}

\end{items}


\section{Création de couleurs personnalisées}

Les nouvelles couleurs doivent être placées dans le fichier \file{Make/Colors.tex} avec la syntaxe suivante : 
\loc{Make/Colors.tex}

\begin{Latex}{Une couleur personnalisée}
\definecolor{colorName}{RGB}{valueRED, valueGREEN, valueBLUE}
\end{Latex}

Où 
\begin{items}{blue}{\Bullet}
    \item valueRED représente la couleur \colors{red}{Rouge} sur un niveau compris entre 0 et 255
    \item valueGREEN représente la couleur \colors{green}{Verte} sur un niveau compris entre 0 et 255
    \item valueBLUE représente la couleur  \colors{blue}{Bleue} sur un niveau compris entre 0 et 255
\end{items}


\input{Utils/Colors.info}\chapter{Bibliothèque Debug} 

La bibliothèque \lib{Debug} gère les message de version de projet.

\input{Utils/Debug.info}\chapter{Bibliothèque Electronic}

La bibliothèque \lib{Electronic} permet de générer des chronogrammes et des schémas électriques



\section{Création de chronogrammes fixes}

\begin{numeric}{Exemple 1}
    D1 &  20{C}   \\
    D2 &  [green] 1H1L1L1L1H1L1L1H1L1H1L1H1L1H1L1H  \\
    D7 &  [black] 1H1L1L1L1H1L1L1H1L1H1L1H1L1H1L1H  \\
    D8 & 8D5U7U5D \\
    D9 & LLL 2{0.1H 0.1L} 0.6H HH \\
    D10 & ZZ G ZZ G XX G X \\
    D11 & [d] 4{5D{Text}} 0.2D \\
    D12 & [L][timing/slope=1.0] HL HL HL HL HL \\
  \end{numeric}


\loc{Body}
\begin{Latex}{Code pour la création de chronogrammes fixes [exemple 1]}
  \begin{numeric}{exemple 1 - chronogramme fixe}
    D1 &  20{C}   \\
    D2 &  [green] 1H1L1L1L1H1L1L1H1L1H1L1H1L1H1L1H  \\
    D7 &  [black] 1H1L1L1L1H1L1L1H1L1H1L1H1L1H1L1H  \\
    D8 & 8D5U7U5D \\
    D9 & LLL 2{0.1H 0.1L} 0.6H HH \\
    D10 & ZZ G ZZ G XX G X \\
    D11 & [d] 4{5D{Text}} 0.2D \\
    D12 & [L][timing/slope=1.0] HL HL HL HL HL \\
  \end{numeric}
\end{Latex}


  \begin{numeric}{Exemple 2 - Chronogramme du compteur 4 bits}
    INPUT &  CC [blue]16{CC} CCC   \\
    D0 &  HL 8{LHHL} LHL   \\
    D1 &  H  4{LLLLHHHH} LLLL \\
    D2 &  H 2{LLLLLLLLHHHHHHHH} LLLL   \\
    D3 &  H{LLLLLLLLLLLLLLLLHHHHHHHHHHHHHHHH} LLLL  \\
    END &  LL [green]14{LL} LHHLLL  \\
    VALUE & L 2D{0} 2D{1} 2D{2} 2D{3} 2D{4} 2D{5} 2D{6} 2D{7} 2D{8} 2D{9} 2D{10} 2D{11} 2D{12} 2D{13} 2D{14} 2D{15} 2D{0} 2D{1}  \\
  \end{numeric}%

\loc{Body}
\begin{Latex}{Code pour la création de chronogrammes fixes [exemple 2]}
  \begin{numeric}{Exemple 2 - Chronogramme du compteur 4 bits}
    INPUT &  CC [blue]16{CC} CCC   \\
    D0 &  HL 8{LHHL} LHL   \\
    D1 &  H  4{LLLLHHHH} LLLL \\
    D2 &  H 2{LLLLLLLLHHHHHHHH} LLLL   \\
    D3 &  H{LLLLLLLLLLLLLLLLHHHHHHHHHHHHHHHH} LLLL  \\
    END &  LL [green]14{LL} LHHLLL  \\
    VALUE & L 2D{0} 2D{1} 2D{2} 2D{3} 2D{4} 2D{5} 2D{6} 2D{7} 2D{8} 2D{9} 2D{10} 2D{11} 2D{12} 2D{13} 2D{14} 2D{15} 2D{0} 2D{1}  \\
  \end{numeric}%
\end{Latex}


\section{Création de chronogrammes flottants}

Notre signal d'horloge (\texttiming{[blue]CCCCCC}) provient d'un oscillateur à quartz.\\
Notre signal d'horloge (\texttiming[timing/draw grid]{LHLHLHLHLHLHLHL}) provient d'un oscillateur à quartz. 

\loc{Body}
\begin{Latex}{Code pour la création de chronogrammes flottants}
  Notre signal d'horloge (\texttiming{[blue]CCCCCC}) provient d'un oscillateur à quartz.\\
  Notre signal d'horloge (\texttiming[timing/draw grid]{LHLHLHLHLHLHLHL}) provient d'un oscillateur à quartz. 
\end{Latex}



\section{Création de schémas électriques}

  
  \begin{schema} {Exemple de schéma électrique}
  
    \addPower{6,5}{power1}{$+5V$}
    \addGround{4,0}{gnd1}{}
  
    \setDeviceBackgroundColor{white}
    \setRotate{0}
    \addLogicGate{0,0}{mynor}{nor}{}{A}{B}{G1}
  
    \setDeviceBackgroundColor{green}
    \addLogicGate{0,2}{mynand}{nand}{}{C}{D}{G2}
    \addLogicGate{2,1}{myor}{or}{}{}{}{G3}
    \resetColors
            
    \addTransistor{6,1}{npnA}{nmos}{B}{C}{E}
    \addTransistor{6,3}{pnpA}{pmos}{b}{e}{c}
  
    \resetColors
    \addTransistor{10,2}{npnR}{nmos}{b}{e}{c}
  
    \addWire{mynor.out}{myor.in 2}{\orthogonalWireA}
    \addWire{mynand.out}{myor.in 1}{\orthogonalWireA}

    \addWire{mynand.out}{pnpA.B}{\orthogonalWireA}
    \addWire{pnpA.C}{npnA.C}{\orthogonalWireA}
  
    \addWire{pnpA.E}{power1}{\orthogonalWireA}
  
    \addWire{npnA.E}{gnd1}{\orthogonalWireA}
  
    \addNode{$(pnpA.C)+(1,0)$}{node1}{}
    \addWire{pnpA.C}{node1}{\orthogonalWireA}
  
    \setDeviceBackgroundColor{red}
    \addLed{myor.out}{\Right}{npnA.B}{\orthogonalWireA}{L1}
    \addResistor{node1}{\Right}{npnR.B}{\orthogonalWireA}
            
  \end{schema}
  
  \loc{Body}
  \begin{Latex}{Code pour la création de schémas électriques}
    \begin{schema} {Exemple de schéma électrique}
  
      \addPower{6,5}{power1}{$+5V$}
      \addGround{4,0}{gnd1}{}
    
      \setDeviceBackgroundColor{white}
      \setRotate{0}
      \addLogicGate{0,0}{mynor}{nor}{}{A}{B}{G1}
    
      \setDeviceBackgroundColor{green}
      \addLogicGate{0,2}{mynand}{nand}{}{C}{D}{G2}
      \addLogicGate{2,1}{myor}{or}{}{}{}{G3}
      \resetColors
              
      \addTransistor{6,1}{npnA}{nmos}{B}{C}{E}
      \addTransistor{6,3}{pnpA}{pmos}{b}{e}{c}
    
      \resetColors
      \addTransistor{10,2}{npnR}{nmos}{b}{e}{c}
    
      \addWire{mynor.out}{myor.in 2}{\orthogonalWireA}
      \addWire{mynand.out}{myor.in 1}{\orthogonalWireA}
  
      \addWire{mynand.out}{pnpA.B}{\orthogonalWireA}
      \addWire{pnpA.C}{npnA.C}{\orthogonalWireA}
    
      \addWire{pnpA.E}{power1}{\orthogonalWireA}
    
      \addWire{npnA.E}{gnd1}{\orthogonalWireA}
    
      \addNode{$(pnpA.C)+(1,0)$}{node1}{}
      \addWire{pnpA.C}{node1}{\orthogonalWireA}
    
      \setDeviceBackgroundColor{red}
      \addLed{myor.out}{\Right}{npnA.B}{\orthogonalWireA}{L1}
      \addResistor{node1}{\Right}{npnR.B}{\orthogonalWireA}
              
    \end{schema}
  \end{Latex}
  

\section{Création de modèles de Thévenin et Norton}


\subsection{Modèle de Thévenin}

\thevenin{E}{Z}[A][B]

\loc{Body}
\begin{Latex}{Un modèle de Thévenin}
  \thevenin{E}{Z}[A][B]
\end{Latex}

\subsection{Modèle de Norton}

\norton{I}{Z}[C][D][-3]

\loc{Body}
\begin{Latex}{Un modèle de Norton}
  \norton{I}{Z}[A][B][-3]
\end{Latex}

\section{Création de moteur à courant continu}

\begin{tikzpicture}
  \mcc{(0,0)}
\end{tikzpicture}

\input{Utils/Electronic.info}\chapter{Bibliothèque Favicons} \label{Fonts}

La bibliothèque \lib{Favicons} permet d'intégrer des icônes.

\section{Ajout d'icônes}

\faviconGithub~
\faviconCheck~
\faviconBookmark~
\faviconLeaf~
\faviconFile~
\faviconGear~
\faviconClose~
\faviconWarning~
\faviconInfo~
\faviconSearch~
\faviconLink~
\faviconClock~
\faviconChat~
\faviconSymbolicLink


\loc{Body}
\begin{Latex}{Code pour l'intégration de Favicon}
\faviconGithub~
\faviconCheck~
\faviconBookmark~
\faviconLeaf~
\faviconFile~
\faviconGear~
\faviconClose~
\faviconWarning~
\faviconInfo~
\faviconSearch~
\faviconLink~
\faviconClock~
\faviconChat~
\faviconSymbolicLink
\end{Latex}

Pour plus d'exemple, se reporter à la documentation officielle du paquet \lib{fontawesome}.

\section{Ajout d'icônes avec des couleurs}

Les icônes peuvent prendre la couleur courante du texte.

\colors{red}{\faviconClose}~~\colors{green}{\faviconCheck} \newpage

\loc{Body}
\begin{Latex}{Code pour l'intégration de Favicons avec des couleurs}
\colors{red}{\faviconClose}~~\colors{green}{\faviconCheck} 
\end{Latex}

\input{Utils/Favicons.info}\chapter{Bibliothèque Figures}

La bibliothèque \lib{Figures} permet de créer des figures et d'afficher la liste des figures dans le document

\section{Création d'une figure centrée}

\createFigure{Figure en exemple}{Ceci est un contenu de figure}

\loc{Body}
\begin{Latex}{Code pour la création de figure}
\createFigure{Figure en exemple}{Ceci est un contenu de figure}
\end{Latex}



\section{Création d'une figure non centrée}

\createFigure{Figure en exemple}{Ceci est un contenu de figure non centrée}

\loc{Body}
\begin{Latex}{Code pour la création de figure non centrée}
\createNoCenteredFigure{Figure en exemple}{Ceci est un contenu de figure}
\end{Latex}

\section{Affichage de la liste des figures}

\loc{main.tex}
\begin{Latex}{Code pour l'affichage de la liste des figures}
\displayListOfFigures{Liste des figures}
\end{Latex}



\section{Références des figures}

Il est possible de faire référence à une figure si celle-ci est explicité avec la commande \bold{createFigureref}.\\

% \createFigureRef{Figure en exemple}{Ceci est un contenu de figure}{ref}
% Ceci est une référence à la \figureName{ref}.\\

\loc{Body}
\begin{Latex}{Code pour la référence d'une figure}
  Ceci est une référence à la figure \figureName{Fonts}.
\end{Latex}

\input{Utils/Figures.info}\chapter{Bibliothèque Glossaries}
\label{addDef}
La bibliothèque \lib{Glossaries} permet de manipuler un glossaire


\section{Ajout d'une définition au glossaire}

\loc{Make/Glossaries.tex}
\begin{Latex}{Ajout d'une définition au glossaire}
\newglossaryentry{Definiton}{name=Identifiant,description={Description}}
\end{Latex}

\section{Référence au glossaire}

Pour faire référence au glossaire (pour qu'il soit affiché au glossaire), il faut saisir la commande suivante : \\
\loc{Body}
\begin{Latex}{Référence d'un terme au glossaire}
\glossary{Identifiant}
\end{Latex}

\messageBox{\faviconInfo}{green}{green}{Toute référence au glossaire provoquera un affichage de la définition en note de bas de page}{white}

\section{Affichage du glossaire}

Pour afficher le glossaire située dans le dossier \dir{Make}/\file{Glossaries.tex}, il faut saisir la commande suivante : \\

\loc{main.tex}
\begin{Latex}{Code pour l'affichage du glossaire}
\displayGlossaries{Glossaire}
\end{Latex}

\subsection{Rendu du glossaire}
\img{\rootImages/glossaire.png}{Un rendu du glosssaire}{0.6}

\input{Utils/Glossaries.info}\chapter{Bibliothèque Graphic}

La bibliothèque \lib{Graphic} permet de générer des graphiques depuis diverses sources de données.

\section{Affichage d'un graphique 2D avec insertion des données depuis un fichier txt (csv)}

\begin{graphic}{0.8}{0.6}{0}{2.1}{-1.1}{1.1}{t(ms)}{vs}{Oscilloscope}
\addPointsFromCSV{red}{comma}{src_examples/input_1.txt}
\addLegend{voie A}
\end{graphic}

\loc{Body}
\begin{Latex}{Code pour l'affichage d'un graphique 2D avec insertion des données depuis un fichier txt (csv)}
\begin{graphic}{0.8}{0.6}{0}{2.1}{-1.1}{1.1}{t(ms)}{vs}{Oscilloscope}
  \addPointsFromCSV{red}{comma}{src_examples/input_1.txt}
  \addLegend{voie A}
\end{graphic}
\end{Latex}



\section{Affichage d'un graphique 2D avec insertion des données depuis une liste de points}

\begin{graphic}{0.8}{0.4}{0}{40}{-1}{6}{t(s)}{Tension (V)}{Signal numérique}
\addPoints{blue}{(0,0)(10,0)(10,5)(15,5)(15,0)(20,0)(20,5)(25,5)(25,0)(30,0)(30,5)(35,5)(35,0)(100,0)}
\addLegend{Tension (V)}
\end{graphic}

\loc{Body}
\begin{Latex}{Code pour l'affichage d'un graphique 2D avec insertion des données depuis une liste de points}
\begin{graphic}{0.8}{0.4}{0}{40}{-1}{6}{t(s)}{Tension (V)}{Signal numérique}
  \addPoints{blue}{(0,0)(10,0)(10,5)(15,5)(15,0)(20,0)(20,5)(25,5)(25,0)(30,0)(30,5)(35,5)(35,0)(100,0)}
  \addLegend{Tension (V)}
\end{graphic}
\end{Latex}


\section{Affichage d'un graphique 2D avec insertion des données depuis une équation}

La variable est $x$ est les fonction trigonométriques sont en degrés.\\

\setSamples{1000}
\setMarker{markerNone}
\setFillColor{darkBlue}
\begin{graphicFigure}{0.4}{0.4}{0}{3}{-1}{5}{t(s)}{Tension V}{Signal analogique}

  
  \addTrace{green}{-10}{10}{sin(360*x)}
  \addTrace{blue}{-10}{10}{2*sin(720*x)}
  \addLegend{sin(360*x)}
\end{graphicFigure}
\setDefaultFillColor
%\enableGrid

\loc{Body}
\begin{Latex}{Code pour l'affichage d'un graphique 2D avec insertion des données depuis une équation}
  \setSamples{1000}
  \setMarker{markerNone}
  \begin{graphicFigure}{0.4}{0.4}{0}{3}{-1}{5}{t(s)}{Tension V}{Signal analogique}
    \addTrace{green}{-10}{10}{sin(x)}
  \addLegend{Legende}
  \end{graphicFigure}
\end{Latex}

\newpage
\section{Affichage de deux graphiques}

  \begin{figure}[h!]  
    \centering 
      \begin{subfigure}[b]{0.4\linewidth}
        \begin{graphic}{0.8}{1}{0}{1.2}{-1}{5}{t(s)}{Tension V}{h}
          \addTrace{green}{-10}{10}{sin(x)/x}
          \addLegend{sin(t)}
          \end{graphic}%NO END  LINE HERE
        \caption{Origine} 
      \end{subfigure}
    \begin{subfigure}[b]{0.4\linewidth}
      \begin{graphic}{0.8}{1}{0}{4}{-0.3}{0.3}{t(s)}{Tension V}{g}
        \addPointsFromCSV{blue}{comma}{src_examples/jack01.txt}
        \addLegend{g(t)}
        \end{graphic}%NO END  LINE HERE
    \caption{Bruit}
    \end{subfigure}
    \caption{Les tensions de service}
    \end{figure}  


  
    \loc{Body}
    \begin{Latex}{Code pour l'affichage d'un graphique 2D avec insertion des données depuis plusieurs sources}

      \begin{figure}[h!]  
        \centering 
          \begin{subfigure}[b]{0.4\linewidth}
            \begin{graphic}{0.8}{1}{0}{1.2}{-1}{5}{t(s)}{Tension V}{h}
              \addTrace{green}{-10}{10}{sin(x)/x}
              \addLegend{sin(t)}
              \end{graphic}%NO END  LINE HERE
            \caption{Origine} 
          \end{subfigure}
        \begin{subfigure}[b]{0.4\linewidth}
          \begin{graphic}{0.8}{1}{0}{4}{-0.3}{0.3}{t(s)}{Tension V}{g}
            \addPointsFromCSV{blue}{comma}{src_examples/jack01.txt}
            \addLegend{g(t)}
            \end{graphic}%NO END  LINE HERE
        \caption{Bruit}
        \end{subfigure}
        \caption{Les tensions de service}
        \end{figure}  
    \end{Latex}

  

\section{Paramètres des graphiques}

\subsection{Affichage de la grille}
Il est possible d'afficher ou non la grille avec les directives suivantes : 

\loc{Body}
\begin{Latex}{Affichage de la grille}
\enableGrid
\disableGrid
\end{Latex}


\subsection{Résolution des tracés}
Il est possible de modifier le nombre de points affichés pour une courbe :\\

\loc{Body}
\begin{Latex}{Définition du nombre d'échantillons}
\setSamples{1000}
\end{Latex}

\subsection{Modification des marqueurs}

Il est possible de changer les marqueurs des points avec la directive suivante : 


\loc{Body}
\begin{Latex}{Changement des marqueurs}
\setMarker{\markerCircle}
\end{Latex}

Les marqueurs disponibles sont les suivants : \\

\loc{Body}
\begin{Latex}{Liste des marqueurs}
\markerNone
\markerCircle
\markerSquare
\markerTriangle
\markerDiamond
\markerStart
\end{Latex}

\subsection{Modification de la couleur de remplissage}

Il est possible de mettre une couleur de remplissage des graphiques :

\loc{Body}
\begin{Latex}{Modifications de la couleur de remplissage}
\setFillColor{red}
\end{Latex}

On peut restaurer la couleur par défaut avec la directive : \\

\loc{Body}
\begin{Latex}{Restauration de la couleur d'origine}
\setDefaultFillColor
\end{Latex}

\subsection{Modification de l'épaisseur des lignes}

Il est possible de changer l'épaisseur des lignes (en mm) avec la commande suivante :

\loc{Body}
\begin{Latex}{Modifications de l'épaisseur des lignes}
\setLineWidth{0.2}
\end{Latex}

\input{Utils/Graphics.info}\chapter{Bibliothèque Header}

La bibliothèque \lib{Header} permet de gérer la mise en page globale du document, en particulier : 

\begin{items}{blue}{\Triangle}
  \item Le type de page de garde : 
  \begin{items}{green}{\Triangle}
    \item Page de garde avec une image
    \item Page de garde sans image
  \end{items}
  \item Créer des parties avec des images (commande \lib{part} améliorée)
  \item Définit l'en-tête et le pied de page
\end{items}
\section{Mise en forme de la page de garde avec une image}

\loc{Header}
\begin{Latex}{Code pour la mise en forme de la page de garde avec une image}
\setHeaderImage{Emplacement_image}{0.8}{Titre}{sous-titre}{Auteurs}{\today \\ \pageref{LastPage} pages}
\end{Latex}


\section{Mise en forme de la page de garde sans image}

\loc{Header}
\begin{Latex}{Code pour la mise en forme de la page de garde sans image}
  \setHeader{Titre}{Auteur 1 \\ Auteur 2}{Date}
\end{Latex}

\section{Mise en forme de la page des parties}

\subsection{Ajout d'une image}
\loc{Body}
\begin{Latex}{Code pour la mise en forme de la page des parties}
  \partImg{Partie}{Images/file.png}{0.2}
\end{Latex}


\subsection{Ajout d'un texte sous l'image}
La commande \lib{addPartText} doit impérativement être appelée avant la commande \lib{partImg}

\loc{Body}

\begin{Latex}{Code pour la mise en forme du texte sous la partie}
\addPartText{Texte sous l'image}
\partImg{Partie}{Images/file.png}{0.2}
\end{Latex}


\section{Ajout d'un trait entre l'en-tête et le corps de la page}

\loc{Settings/FHeaderLine.tex}
\begin{Latex}{Code pour l'ajout d'un trait entre l'en-tête et le corps de la page}
  \setHeaderLine{0.2}
\end{Latex}

Ce code est généré automatiquement lors de l'ouverture du projet. Pour le modifier, il faut configurer les paramètres du projet en allant à la section \link{\nameref{setSettings}}.

\section{Ajout d'un trait entre le corps de la page et le bas de page}

\loc{Settings/FHeaderLine.tex}
\begin{Latex}{Code pour l'ajout d'un trait entre le corps de la page et le bas de page}
  \setFooterLine{0.2}
\end{Latex}

Ce code est généré automatiquement lors de l'ouverture du projet. Pour le modifier, il faut configurer les paramètres du projet en allant à la section \link{\nameref{setSettings}}.



\section{Définition de la présentation globale des pages}

\loc{Header}
\begin{Latex}{Code pour la définition de la présentation globale des page}
  \addPresentation
  {Titre} {Centre} {\currentChapter}
  {Gauche} {} {\currentPage}
\end{Latex}

\section{Redéfinition des titres des chapitres}

Par défaut, l'utilisation du mot clé \lib{chapter} force à utiliser le mot-clé \bold{Chapitre X}. Pour utiliser un autre nom, utiliser la commande suivante : 

\loc{Settings/ChapterAlias.tex}
\begin{Latex}{Code pour la redéfinition des titres des chapitres}
  \setAliasChapter{Section}
\end{Latex}
Ce code est généré automatiquement lors de l'ouverture du projet. Pour le modifier, il faut configurer les paramètres du projet en allant à la section \link{\nameref{setSettings}}.



\section{Mettre le document en pleine page}
\loc{Header}
\begin{Latex}{Code pour mettre le document en pleine page}
\setFullPage
\end{Latex}

\section{Récupérer le chapitre courant}

Le chapitre courant sera en majuscule.
\loc{Body}
\begin{Latex}{Code pour récuperer le chapitre courant}
\currentChapter
\end{Latex}


\input{Utils/Header.info}\chapter{Bibliothèque Images}

La bibliothèque \lib{Images} permet d'ajouter des images.

\section{Définition de l'espace de nommage}
\label{handleImages}

Lors de l'ajout d'une image, il n'est pas nécessaire de connaître le nom du dossier courant.\\

Pour les commandes \lib{img}, \lib{imgr} et \lib{imgf}, l'argument \bold{Référence} doit être de la forme \bold{\\rootImages+NomImage.extension}.

La macro \lib{\\rootImages} prendra lors de la compilation la valeur du dossier courant.

Par exemple, pour ajouter une image appelée \file{monImage.png} provenant du dossier \\
\dir{Images/Part1}, il suffit d'écrire : 

\begin{Latex}{Code pour l'espace de nommage}
\img{\rootImages/monImages.png}{Ma légende}{0.5}
\end{Latex}

Le troisième argument représente le rapport de taille de l'image.


\section{Ajout d'une image non-flottante}

\img{\rootImages/tux.png}{Légende de l'image}{0.5}

\loc{Body}
\begin{Latex}{Code pour l'ajout d'une image non-flottante}
\img{\rootImages/tux.png}{Légende de l'image}{0.5}
\end{Latex}

\section{Ajout d'une image non-flottante avec une rotation}

\imgr{\rootImages/tux.png}{Légende de l'image}{0.5}{45}

Le dernier argument de la commande représente l'angle de rotation en °.

\loc{Body}
\begin{Latex}{Code pour l'ajout d'une image non-flottante avec une rotation}
\imgr{\rootImages/tux.png}{Légende de l'image}{0.5}{45}
\end{Latex}


\section{Ajout d'une image référencée}

\subsection{Afficher l'image référencée}

Il est possible de faire référence à une image avec la commande suivante : 

\loc{Body}
\begin{Latex}{Code pour référencer une image}
\imgn{\rootImages/tux.png}{Une image référenceée}{0.5}{tux}
\imgn{\rootImages/tux.png}{Une autre image référencée}{0.5}{tux2}
\end{Latex}

\imgn{\rootImages/tux.png}{Une image référenceée}{0.5}{tux}
\imgn{\rootImages/tux.png}{Une autre image référencée}{0.5}{tux2}

\subsection{Faire référence dans le document}

Il existe 2 façons de référencer une figure : 

\begin{items}{blue}{\Triangle}
    \item Via une référence explicite
    \begin{Latex}{Référence par le numéro}
La \figureName{tux} représente Tux.
\end{Latex}
    La \figureName{tux} représente Tux.
    \item Via une référence entre parenthèse
\begin{Latex}{Référence entre parenthèse}
L'image de Tux apparaît sur le document \figureRef{tux2}
\end{Latex}
    L'image de Tux apparaît sur le document \figureRef{tux2}
  \end{items}

\section{Ajout d'une image flottante}

Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Ut purus elit, vestibulum
ut, placerat ac, adipiscing vitae, felis. Curabitur dictum gravida mauris. Nam arcu li-
bero, nonummy eget, consectetuer id, vulputate a, magna. Donec vehicula augue eu
neque. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac
turpis egestas. Mauris ut leo. Cras viverra metus rhoncus sem. Nulla et lectus vestibu-

\imgf{\rootImages/tux.png}{Légende}{0.5}{0.5}{r}{10}

lum urna fringilla ultrices. Phasellus eu tellus sit amet tortor gravida placerat. Integer
sapien est, iaculis in, pretium quis, viverra ac, nunc. Praesent eget sem vel leo ultrices
bibendum. Aenean faucibus. Morbi dolor nulla, malesuada eu, pulvinar at, mollis ac,
nulla. Curabitur auctor semper nulla. Donec varius orci eget risus. Duis nibh mi, congue
Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Ut purus elit, vestibulum
ut, placerat ac, adipiscing vitae, felis. Curabitur dictum gravida mauris. Nam arcu li-
bero, nonummy eget, consectetuer id, vulputate a, magna. Donec vehicula augue eu
neque. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac
turpis egestas. Mauris ut leo. Cras viverra metus rhoncus sem. Nulla et lectus vestibu-


\loc{Body}
\begin{Latex}{Code pour l'ajout d'une image lottante}
\imgf{\rootImages/tux.png}{Légende}{0.5}{0.5}{r}{10}
\end{Latex}


\section{Ajout d'une image dans les parties}

Il est possible d'ajouter une image dans les pages présentant les parties du document (Commande \bold{part}).



\input{Utils/Images.info}\chapter{Bibliothèque Index} \label{index}


La bibliothèque \lib{index} permet de gérer des index.

\input{Utils/Index.info}\chapter{Bibliothèque Items} \label{Items}

La bibliothèque \lib{Items} permet de gérer les listes à puce.

\section{Création d'un liste}

\begin{items}{orange}{\Triangle}
    \item A
    \item B
    \item C
\end{items}

\loc{Body}
\begin{Latex}{Code pour la création d'une liste}
\begin{items}{orange}{\Triangle}
    \item A
    \item B
    \item C
\end{items}
\end{Latex}


\subsection{Options}

\begin{items}{orange}{\Triangle}
    \item Triangle
    \item Circle
    \item Bullet
    \item \faGear
    \item \faFileText
    \item ...
\end{items}

\begin{Latex}{Options disponibles}
\Triangle
\Bullet 
\Circle
\faGear
\faFileText
\end{Latex}

\messageBox{\faviconInfo}{green}{green}{Il est possible de personnaliser les puces en utilsant la bibliothèque \lib{Fonts} (Section \italic{\titleName{Fonts}})
Par exemple, on peut créer une liste avec le symbole \faFileText~et obtenir le résultat suivant :
\begin{items}{orange}{\faFileText}
    \item Settings
    \item Files
    \item Directory
\end{items}

}{white}

\begin{Latex}{Personnalisation des puces}
    \begin{items}{orange}{\faFileText}
        \item Settings
        \item Files
        \item Directory
    \end{items}
\end{Latex}


\input{Utils/Items.info}\chapter{Bibliothèque Labels} \label{Labels}

La bibliothèque \lib{Labels} permet de créer des labels.

\section{Création de labels générique}

Il est possible d'utiliser les labels génériques : \\


\lbl{orange}{LIB}{Label}  %Label orange
\lbl{red}{LIB}{Label} %Label rouge 
\lbl{green}{LIB}{Label} %...
\lbl{magenta}{LIB}{Label}
\lbl{purple}{LIB}{Label}
\lbl{cyan}{LIB}{Label}
\lbl{blue}{LIB}{Label}
\lbl{brown}{LIB}{Label}
\lbl{yellow}{LIB}{Label}
\lbl{black}{LIB}{Label}\\
\lbl{rose}{LIB}{Label}
\lbl{darkBlue}{LIB}{Label}
\lbl{darkBrown}{LIB}{Label}
\lbl{darkRed}{LIB}{Label}
\lbl{darkOrange}{LIB}{Label}
\lbl{darkGray}{LIB}{Label}\\

\bold{Vous pouvez mettre le mot clé souhaité à la place de LIB}.


\loc{Body}
\begin{Latex}{Code pour la création de labels génériques}
\lbl{orange}{LIB}{Label}  %Label orange
\lbl{red}{LIB}{Label} %Label rouge 
\lbl{green}{LIB}{Label} %...
\lbl{magenta}{LIB}{Label}
\lbl{purple}{LIB}{Label}
\lbl{cyan}{LIB}{Label}
\lbl{blue}{LIB}{Label}
\lbl{brown}{LIB}{Label}
\lbl{yellow}{LIB}{Label}
\lbl{black}{LIB}{Label}
\lbl{rose}{LIB}{Label}
\lbl{darkBlue}{LIB}{Label}
\lbl{darkBrown}{LIB}{Label}
\lbl{darkRed}{LIB}{Label}
\lbl{darkOrange}{LIB}{Label}
\lbl{DarkGray}{LIB}{Label}
\end{Latex}


\section{Création de labels spécifiques}

\subsection{Contenu de fichiers}

\file{Fichier}
\dir{Dossier}
\link{Lien}
\lib{Bibliothèque ou Logiciel}
\shortcut{Raccourci-clavier ou touche}



\subsection{Réseaux}
\ip{Adresse IP}
\mac{Adresse MAC}
\bin{Représentation binaire}
\hexa{Représentation hexadécimale}



\subsection{Documentation}

\loc{Localisation}
\deprecated{Information périmée}



\subsection{Electronique}

\genericPin{Broche générique}
\inputPin{Broche d'entrée}
\outputPin{broche de sortie}
\reg{Registre}
\func{Fonction}
\adr{Addresse}\\



\loc{Body}
\begin{Latex}{Code pour la création de labels spécifiques}
\file{Fichier}
\dir{Dossier}
\link{Lien}
\lib{Bibliothèque ou Logiciel}
\shortcut{Raccourci-clavier ou touche}

\ip{Adresse IP}
\mac{Adresse MAC}
\bin{Représentation binaire}
\hexa{Représentation hexadécimale}

\loc{Localisation}
\deprecated{Information périmée}

\genericPin{Broche générique}
\inputPin{Broche d'entrée}
\outputPin{broche de sortie}
\reg{Registre}
\func{Fonction}
\adr{Addresse}
\end{Latex}


\input{Utils/Labels.info}\chapter{Bibliothèque Layout}

La bibliothèque \lib{Layout} gère la page de garde et la mise en forme du text (gras, italique...).

La mise en page est séparée en 4 parties : frontmatter (début du document, numéroation romaine), mainmatter (avant le premier chapitre), appendix (annexes) et backmatter avant les tables et bibliographies

\section{Mise en gras}

\bold{Texte en gras}
\sn

\loc{Body}
\begin{Latex}{Code pour mettre le texte en gras}
\bold{Texte en gras}
\end{Latex}

\section{Mise en italique}

\italic{Texte en italique}
\sn
\loc{Body}
\begin{Latex}{Code pour mettre le texte en italique}
\italic{Texte en gras}
\end{Latex}

\section{Mise en gras et italique}

\ib{Texte en gras et italique}
\sn

\loc{Body}
\begin{Latex}{Code pour mettre le texte en gras et italique}
\ib{Texte en gras et italique}
\end{Latex}


\section{Ajout d'un espace vertical}

Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Ut purus elit, vestibulum
ut, placerat ac, adipiscing vitae, felis. Curabitur dictum gravida mauris. Nam arcu li- \sn

bero, nonummy eget, consectetuer id, vulputate a, magna. Donec vehicula augue eu
neque. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac
turpis egestas. Mauris ut leo. Cras viverra metus rhoncus sem. Nulla et lectus vestibu-

\loc{Body}
\begin{Latex}{Code pour ajouter un espace vertical}
\sn
\end{Latex}

\input{Utils/Layout.info}\chapter{Bibliothèque Links}

La bibliothèque \lib{Links} gère les métadonnées.

\section{Paramétrage des liens et des méta-données}

\loc{Settings/Hyperref.tex}
\begin{Latex}{Code pour paramétrer les liens et les métadonnées}
%@input Titre du PDF
%@input Auteur(s)
%@input Sujet du fichier PDF (courte phrase)
%@input Créateur du fichier PDF
%@input Producteur du fichier PDF
%@input Mots-clés (liste)
%@input Couleurs des liens
%@input Couleurs des citations dans la bibliographie
%@input Couleurs des liens de fichier
\setParameters {Tutoriel Latex} {Nicolas Le Guerroué} {Bibliothèque Utils} {Nicolas Le Guerroué}{Latex}{green}{blue}{blue}
    
\end{Latex}


\input{Utils/Links.info}\chapter{Bibliothèque Maths}

La bibliothèque \lib{Maths} gère les torseurs et matrices.

\section{Création d'une matrice 3*3}

$$\emat{a & b & c}{d & e & f}{g & h & i}  $$
\vskip 0.5cm

\loc{Body}
\begin{Latex}{Code pour la création d'une matrice 3*3}
    $$\emat{a & b & c}{d & e & f}{g & h & i}  $$
\end{Latex}

\section{Création d'un vecteur à trois dimensions}

$$\evec{a}{b}{c}  $$
\vskip 0.5cm

\loc{Body}
\begin{Latex}{Code pour la création d'un vecteur à trois dimensions}
    $$\evec{a}{b}{c}  $$
\end{Latex}


\section{Création d'un torseur à trois dimensions}

$$\torsor{a & d}{b & e}{c & f}  $$
\vskip 0.5cm

\loc{Body}
\begin{Latex}{Code pour la création d'un torseur à trois dimensions}
    $$\torsor{a & d}{b & e}{c & f}  $$
\end{Latex}

\input{Utils/Maths.info}\chapter{Bibliothèque MessageBox}

La bibliothèque \lib{MessageBox} gère les boites de message pour afficher des informations.\\


\section{Création de boites de dialogues}

\messageBox{\faviconGear}{orange}{orange}{Voici un message}{black}
\messageBox{\faviconWarning}{red}{red}{Et un autre message}{black}
\messageBox{\faGlobe}{darkBlue}{darkBlue}{\bold{Et un autre message avec un texte en gras}}{white}
\messageBox{\faviconCheck}{green}{green}{bref...}{white}

\loc{Body}
\begin{Latex}{Code pour la création de boites de dialogues}
\messageBox{Favicon}{orange}{orange}{Voici un message}{black}
\end{Latex}



\input{Utils/MessageBox.info}\chapter{Bibliothèque Nomenclature}
\label{addNomenclature}

La Bibliothèque \lib{Nomenclature} permet de générer des nomenclatures.

\section{Ajout d'un élément dans la nomenclature}

Chaque élément est de la forme :\\

\loc{Make/Nomenclature.tex}
\begin{Latex}{Format pour la nomenclature}
\nomenclature[category]{$symbole$}{définition}

%Par exemple
\nomenclature[E]{$r$}{Rapport cyclique d'un signal périodique}
\end{Latex}
et doit être rajouté dans le fichier \dir{Make}/\file{Nomenclature.tex}\\


Dans la commande, \bold{category} indique le type de grandeur. Il y a actuellement 6 types de grandeurs définies dans le fichier \dir{Utils}/\file{Nomenclature.sty}\footnote{Cependant, rien ne vous empêche d'en ajouter en modifiant la bibliothèque}: 

\begin{items}{blue}{\Bullet}
\item P pour les \bold{Constantes physiques}
\item O pour les \bold{Autres symboles}
\item N pour les \bold{Nombres spéciaux}
\item A pour les \bold{Amplificateurs Opérationnels}
\item M pour les \bold{Mécanique}
\item E pour les \bold{Électronique}
\end{items}  


\subsection{Ajout des unités}

Pour ajouter une unité, il suffit d'invoquer la commande \lib{addUnit} à la fin du dernier argument de la commande \lib{nomenclature}.

\subsection{Ajout d'une unité}

\loc{Make/Nomenclature.tex}
\begin{Latex}{Ajout d'une unité}
\nomenclature[A]{$\varepsilon$}{Tension différentielle $(\varepsilon = E_+ - E_-)$\addUnit{V}}
\end{Latex}
    

\subsection{Exemple de nomenclature}

La nomenclature est dans le fichier \dir{Make}/\file{Nomenclature.tex}.\\

\loc{Make/Nomenclature.tex}
\begin{Latex}{Exemple de nomenclature}

\nomenclature[E]{$r$}{Rapport cyclique d'un signal périodique}
\nomenclature[A]{$A_d$}{Coefficient d'amplification, gain différentiel }
\nomenclature[A]{$\varepsilon$}{Tension différentielle $(\varepsilon = E_+ - E_-)$\addUnit{V}}
\nomenclature[A]{$E_+$}{Tension entrée non inverseuse \addUnit{V}}
\nomenclature[A]{$E_-$}{Tension entrée inverseuse \addUnit{V}}
\nomenclature[E]{$\eta$}{Rendement d'un mécanisme \addUnit{\%}}
\nomenclature[E]{$\varphi$}{Déphasage entre deux signaux \addUnit{rad}}
  
\end{Latex}



\section{Affichage de la nomenclature}

Pour afficher la nomenclature, il suffit de faire la commande : \\

\loc{main.tex}
\begin{Latex}{Code pour l'affichage de la nomenclature}
\displayNomenclature{Nomenclature}{Make/Nomenclature.tex}
\end{Latex}

\img{\rootImages/nomenclature.png}{Rendu d'une nomenclature}{0.5}


\input{Utils/Nomenclature.info}\chapter{Bibliothèque Object3D}

La bibliothèque \lib{Object3D} gère les figures 3D et les graphiques 3D.

\section{Affichage d'un graphique 3D avec insertion des données depuis une équation}

\plot{Titre 3D}{sin(x)*cos(y)}


\loc{Body}
\begin{Latex}{Code pour l'affichage graphique 3D avec insertion des données depuis une équation}
\plot{Titre 3D}{sin(x)*cos(y)}
\end{Latex}

\section{Affichage de sphères en 3D}

\ball{red}{2}
\ball{green}{3}
\ball{blue}{4}
\ball{darkBlue}{5}

\loc{Body}
\begin{Latex}{Code pour l'affichage de sphères en 3D}
\ball{red}{2}
\ball{green}{3}
\ball{blue}{4}
\end{Latex}

Il est possible d'utilise ces balles pour décorer les listes : \\

\begin{items}{darkBlue}{\ball{blue}{1.5}}
    \item A
    \item B
    \end{items}

\loc{Body}
\begin{Latex}{Code pour décorer les listes avec les balles}
\begin{items}{darkBlue}{\ball{blue}{1.5}}
\item A
\item B
\end{items}
\end{Latex}


\input{Utils/Objects3D.info}\chapter{Bibliothèque Pdf}

La bibliothèque \lib{Pdf} gère l'insertion de pages PDF dans le document.

\section{Insertion d'un document PDF}

\loc{Body}
\begin{Latex}{Code pour ajouter un document au format PDF}
\includepdf[page=1,2,3]
\end{Latex}

\section{Insertion d'un ensemble de pages d'un document PDF}

\loc{Body}
\begin{Latex}{Code pour ajouter un ensemble de page d'un document au format PDF}
\includepdf[page=1,2,3]
\end{Latex}

\input{Utils/Pdf.info}\chapter{Bibliothèque Programming}

La bibliothèque \lib{Programming} gère l'affichage de code source dans le document.\\

\section{Affichage d'un code C/C++ avec titre}


\begin{Cpp}{Titre}
#include <iostream>

#define CONST 1

int var = 1;
float 

int main() {
  
  call();
  return 0;

}//End main

\end{Cpp}

\loc{Body}
\begin{Latex}{Code pour l'affichage d'un code C/C++ avec titre}
    \begin{Cpp}{Titre}
        #include <iostream>
        
        #define CONST 1
        
        int var = 1;
        float 
        
        int main() {
          
          call();
          return 0;
        
        }//End main
        
        \end{Cpp}
\end{Latex}

\section{Affichage d'un code C/C++ sans titre}


\begin{Cpp}
#include <iostream>

#define CONST 1 #const var

int var = 1;
float g = 2.5;
...

\end{Cpp}

\loc{Body}
\begin{Latex}{Code pour l'affichage d'un code C/C++ sans titre}
    \begin{Cpp}
        #include <iostream>
        
        #define CONST 1 #const var
        
        int var = 1;
        float g = 2.5;
        ...
        
        \end{Cpp}
\end{Latex}


\section{Affichage d'un code Python avec titre}


\begin{Python}{Titre du code}
def call(input):

  """docstring"""
  a = input
  for elem in a:
    print(elem) #show
\end{Python}

\loc{Body}
\begin{Latex}{Code pour l'affichage d'un code Python avec titre}
  \begin{Python}{Titre du code}
    def call(input):
    
      """docstring"""
      a = input
      for elem in a:
        print(elem) #show
    \end{Python}
\end{Latex}

\section{Affichage d'un code Python sans titre}


\begin{Python}
def call(input):

  """docstring"""
  ...
\end{Python}

\loc{Body}
\begin{Latex}{Code pour l'affichage d'un code Python sans titre}
  \begin{Python}
    def call(input):
    
      """docstring"""
      ...
    \end{Python}
\end{Latex}


\section{Affichage d'un code Bash avec titre}


\begin{Bash}{Titre du code}
sudo apt-get -y update
sudo apt-get -y upgrade
echo -e "content"
\end{Bash}

\loc{Body}
\begin{Latex}{Code pour l'affichage d'un code Bash avec titre}
  \begin{Bash}{Titre du code}
    sudo apt-get -y update
    sudo apt-get -y upgrade
    echo -e "content"
    \end{Bash}
\end{Latex}

\section{Affichage d'un code bash sans titre}

\bold{Ce type d'affichage n'est pas encore supporté par la bibliothèque.}

\input{Utils/Programming.info}
\chapter{Bibliothèque Quotes}

La bibliothèque \lib{Quotes} gère les citations

\section{Création d'une citation}

Il est possible de créer des citations uniquement dans la classe \bold{book}, \bold{report} et \bold{utils\_report}

\addQuote{Ceci est une citation}{Nicolas LE GUERROUE}

\loc{Body}
\begin{Latex}{Code pour la création d'une citation}
\addQuote{Nicolas LE GUERROUE}{Ceci est une citation}
\end{Latex}\chapter{Bibliothèque TableOfContent}

La bibliothèque \lib{TableOfContent} gère le sommaire et son affichage.


\section{Affichage du sommaire}

\loc{main.tex}
\begin{Latex}{Code pour l'affichage du sommaire}
\displayTableOfContent{Table des matières}
\end{Latex}

L'argument passé à la macro est le nom visible sur la page ainsi que dans la table des matière.


\section{Configuration de la taille du sommaire}

\loc{Settings/TocSize.tex}
\begin{Latex}{Code pour la configuration de la taille du sommaire}
\smallTableOfContent
%Or \classicalTableOfContent
\end{Latex}


\input{Utils/TableOfContent.info}\chapter{Bibliothèque Tables}


La bibliothèque \lib{Table} gère les tableaux.

\section{Création d'un tableau}
  

\begin{tableFigure}{|c|c|c|c|}{Réponse sur le sens du courant en fonction des tensions $U_A$ et $U_B$}
    \rowcolor{darkBlue}  
    \hline
    \color{white}{$U_A$ (V)} & \color{white}{$U_B$ (V)} & \color{white}{Sens du courant} & \color{white}{$U_A-U_B$}\\
    \hline
    10 & 5 & \colors{blue}{De A vers B} & \cellcolor{green} 5\\
    \hline
    5 & 10 & \colors{blue}{de B vers A} & -5\\
    \hline
    5 & 5 & \colors{blue}{Aucun courant ne circule} & 0\\
    \hline
  \end{tableFigure}

  
  \loc{Body}
  \begin{Latex}{Code d'exemple}
    \begin{tableFigure}{|c|c|c|c|}{Réponse sur le sens du courant en fonction des tensions $U_A$ et $U_B$}
      \rowcolor{darkBlue}  
      \hline
      \color{white}{$U_A$ (V)} & \color{white}{$U_B$ (V)} & \color{white}{Sens du courant} & \color{white}{$U_A-U_B$}\\
      \hline
      10 & 5 & \colors{blue}{De A vers B} & \cellcolor{green} 5\\
      \hline
      5 & 10 & \colors{blue}{de B vers A} & -5\\
      \hline
      5 & 5 & \colors{blue}{Aucun courant ne circule} & 0\\
      \hline
    \end{tableFigure}
\end{Latex}

\section{Personnalisation des tableaux}

\subsection{Couleur d'arrière-plan d'une ligne}


La commande suivante permet de changer l'arrière-plan d'une ligne du tableau :

\begin{Latex}{Couleur d'arrière-plan des tableaux}
\cellcolor{red} 5
\end{Latex}

\subsection{Couleur d'arrière-plan d'une cellule}


La commande suivante permet de changer l'arrière-plan d'une cellule du tableau :

\begin{Latex}{Couleur d'arrière-plan des tableaux}
\rowcolor{darkBlue} 
\end{Latex}


\section{Affichage de la liste des tables}

\loc{main.tex}

\begin{Latex}{Code pour l'affichage de la liste des tables}
\displayListOfTables{Liste des tables}
\end{Latex}

L'argument passé à la macro est le nom visible sur la page ainsi que dans la table des matière.



\input{Utils/Tables.info}\chapter {Bibliothèque Theorems}

La bibliothèque \lib{Theorems} gère les théorèmes.\\

Les Théorèmes sous Latex sont des sections d'informations précises (remarque, question, réponse, propriété\ldots) mais dont la mise en page est transparente tout comme la numérotation.\\


\section{Utilisation avec les environnements}

Cette méthode n'est pas la plus conseillée, elle peut provoquer des erreurs d'affichage lors de la compilation Latex vers HTML.
Cependant, quand le paragraphe est conséquent, cette méthode est à privilégier par rapport à l'utilisation avec des commandes classiques.


Par exemple, on souhaite créer une question : 

\subsection{Création d'une question}

\begin{question}
    Quelle heure est-il ?
\end{question}

\loc{Body}
\begin{Latex}{Code pour la création d'une question}
\begin{question}
    Quelle heure est-il ?
\end{question}
\end{Latex}

L'ajout d'une deuxième question se fait en ajoutant le même code.

\begin{question}
    Quelle est ma deuxième question ?
\end{question}


\subsection{Création d'une réponse}

\begin{reponse}
    il est 18 h.
\end{reponse}

\loc{Body}
\begin{Latex}{Code pour la création d'une reponse}
\begin{reponse}
    il est 18 h.
\end{reponse}
\end{Latex}

\subsection{Création d'une propriété}

\begin{propriete}
    Un produit scalaire est commutatif.
\end{propriete}

\loc{Body}
\begin{Latex}{Code pour la création d'une propriete}
\begin{propriete}
    Un produit scalaire est commutatif.
\end{propriete}
\end{Latex}

\subsection{Création d'une proposition}

\begin{proposition}
    Les chats sont des mammifères.
\end{proposition}

\loc{Body}
\begin{Latex}{Code pour la création d'une proposition}
\begin{proposition}
    Les chats sont des mammifères.
\end{proposition}
\end{Latex}

\subsection{Création d'une remarque}

\begin{remarque}
remarque sur Latex
\end{remarque}

\loc{Body}
\begin{Latex}{Code pour la création d'une remarque}
\begin{remarque}
remarque sur Latex
\end{remarque}
\end{Latex}

\subsection{Création d'un exemple}

\begin{exemple}
    Ceci est un exemple d'exemple
\end{exemple}

\loc{Body}
\begin{Latex}{Code pour la création d'une exemple}
\begin{exemple}
    Ceci est un exemple d'exemple
\end{exemple}
\end{Latex}

\subsection{Création d'une définition}

\begin{definition}
    Une phrase est un ensemble de mots.
\end{definition}

\loc{Body}
\begin{Latex}{Code pour la création d'une definition}
\begin{definition}
    Une phrase est un ensemble de mots.
\end{definition}
\end{Latex}


\subsection{Création d'une solution}

\begin{solution}
   La solution est triviale
\end{solution}

\loc{Body}
\begin{Latex}{Code pour la création d'une solution}
\begin{solution}
    La solution est triviale
\end{solution}
\end{Latex}



\input{Utils/Theorems.info}\chapter{Bibliothèque Titles}

La bibliothèque \lib{Titles} gère les titres.\\

\subsection{Titre de chapitre}
\loc{Body}
\begin{Latex}{Code pour l'ajout d'un titre}
\chapter{Titre}
\end{Latex}

\section{Titre de section}
\loc{Body}
\begin{Latex}{Code pour l'ajout d'une section}
\section{Titre de section}
\end{Latex}

\section{Couleur de section}

Il est possible de changer la couleur des sections avec la commande suivante : \\

\loc{Settings/SectionColor.tex}
\begin{Latex}{Code pour la modification des couleurs des section}
\setColorSection{blue}
\end{Latex}


\subsection{Titre de sous-section}

\loc{Body}
\begin{Latex}{Code pour l'ajout d'une sous-section}
\subsection{Titre de sous-section}
\end{Latex}

\section{Couleur de sous-section}

Il est possible de changer la couleur des sous-sections avec la commande suivante : \\

\loc{Settings/SubSectionColor.tex}
\begin{Latex}{Code pour la modification des couleurs des section}
\setColorSubSection{blue}
\end{Latex}


\subsubsection{Titre de sous-sous-section}
\loc{Body}
\begin{Latex}{Code pour l'ajout d'une sous-sous-section}
\subsection{Titre de sous-sous-section}
\end{Latex}


\section{Références des titres}

Il est possible de faire référence au nom du chapitre ci celui-ci est explicité avec la mention \bold{label}.\\

Ceci est une référence à la section appelée \titleName{Fonts}.\\

\loc{Body}
\begin{Latex}{Code pour la référence à un titre}
Ceci est une référence à la section appelée \titleName{Fonts}.
\end{Latex}

Avec la bibliothèque \lib{Labels}, vous pouvez mettre un label pour rendre plus visible le lien : 

Un lien la bibliothèque \link{\titleName{Fonts}}.

\loc{Body}
\begin{Latex}{Code pour la référence à un titre}
Un lien vers la bibliothèque \link{\titleName{Fonts}}.
\end{Latex}

\section{Paramétrage de la numérotation des titres}

\loc{Settings/TitlePrefix.tex}
\begin{Latex}{Code pour la numérotation des sections}
\enableSectionPrefix
%\disableSectionPrefix
\end{Latex}

\input{Utils/Titles.info}\chapter{Bibliothèque Tree}

La bibliothèque \lib{Tree} permet de générer des arborescences de dossiers et fichiers.

\section{Création d'une arborescence simple}

\dirtree{%
.1 Root1. 
.2 SubRoot1.
.3 SubSubRoot1.
.3 SubSubRoot2.
.3 SubSubRoot3.
.2 SubRoot2.
.2 SubRoot3.
} 

\loc{Body}
\begin{Latex}{Code pour la création d'un arbre simple}
\dirtree{%
.1 Root1. 
.2 SubRoot1.
.3 SubSubRoot1.
.3 SubSubRoot2.
.3 SubSubRoot3.
.2 SubRoot2.
.2 SubRoot3.
}
\end{Latex}


Le \bold{.Numéro} représente la profondeur de l'arborescence, c'est à dire le niveau. \\
Chaque fin de ligne doit impérativement se terminer par un point et la ligne \bold{\\dirtree\{} doit se terminer par un symbole '\%'.


\section{Création  d'une arborescence plus évoluée}

Avec l'utilisation de la bibliothèque \lib{Labels} \footnote{Se référer à la section \link{\titleName{Labels}}}, il est possible de mettre des couleurs très facilement.\\

\dirtree{%
.1 \dir{Root1}. 
.2 \dir{SubRoot1}.
.3 \file{SubSubRoot1}.
.3 \file{SubSubRoot2}.
.3 \file{SubSubRoot3}.
.2 \dir{SubRoot2}.
.2 \dir{SubRoot3}.
}


\loc{Body}
\begin{Latex}{Code pour la création d'une arborescence plus évoluée}
\dirtree{%
.1 \dir{Root1}. 
.2 \dir{SubRoot1}.
.3 \file{SubSubRoot1}.
.3 \file{SubSubRoot2}.
.3 \file{SubSubRoot3}.
.2 \dir{SubRoot2}.
.2 \dir{SubRoot3}.
}
\end{Latex}


\section{Création  d'une arborescence dans une figure}

Avec la bibliothèque \lib{Figures}, on peut intégrer une arborescence au sein d'une figure non centrée.\\
Actuellement, on ne peut pas centrer l'arbre sous peine de dégrader le rendu.


\createNoCenteredFigure{Exemple d'arborescence}{
    \dirtree{%
    .1 \dir{Root1}. 
    .2 \dir{SubRoot1}.
    .3 \file{SubSubRoot1}.
    .3 \file{SubSubRoot2}.
    .3 \file{SubSubRoot3}.
    .2 \dir{SubRoot2}.
    .2 \dir{SubRoot3}.
    }
}

\loc{Body}
\begin{Latex}{Code pour la création d'une arborescence dans une figure}
    \createNoCenteredFigure{Exemple d'arborescence}{
        \dirtree{%
        .1 \dir{Root1}. 
        .2 \dir{SubRoot1}.
        .3 \file{SubSubRoot1}.
        .3 \file{SubSubRoot2}.
        .3 \file{SubSubRoot3}.
        .2 \dir{SubRoot2}.
        .2 \dir{SubRoot3}.
        }
    }
\end{Latex}

\input{Utils/Tree.info}\chapter{Introduction}

\section{Objectif}

L'objectif est d'automatiser le feutrage de la laine, étape fastidieuse à la main.

On part du principe que si, sur une surface en laine ( 80\% ), on pose une petite quantité de laine pure, on pourra avec une aiguille spéciale enfoncer des brins de laine dans le support et ceux-ci y resteront à la remontée de l’aiguille ( les brins de laine s’accrochent entre eux avec une facilité incroyable ).\\
 Pour une petite surface on utilise un support avec 6 à 9 aiguilles et tenir dans la main le dit support avec un aller et retour vertical devient fastidieux avec des risques de blessures.\\
\bold{C’est cette action qu’il faut automatiser. }


\section{Les versions}

Une premiere version comporte un simple balayage du plateau.\\
La seconde version devrait comporter un traitement d'image avec une caméra pour adapter le balayage.


\section{État des lieux}

Actuellement, des essais ont été réalisés avec la CNC qui était stocké au FabLab.\\

\section{Liste du matériel}


\begin{items}{blue}{\Triangle}
    \item Une ancienne CNC (modèle de Xavier Hinault)
    \item Support d'aiguilles
\end{items}


\section{Communication avec la CNC}

L'ensemble des communications ont lieu avec une liaison série (UART)


La liaison \glossary{UART} est une liaison série avec deux broches :

\begin{items}{green}{\Triangle}
   \item RX
   \item TX
\end{items}

\subsubsection{Protocole}

\begin{items}{blue}{\Circle}
   \item Un bit de start toujours à 0 pour synchroniser la communication
   \item Un champ de données de 8 bits
   \item Un bit de parité (dans notre cas aucune parité)
   \item Un bit de stop
\end{items}

\subsubsection{Vitesse de communication}

La liaison étant asynchrone, il faut que les périphériques communiquent à la même vitesse. Cette dernière est normalisée et représente le nombre de bit par seconde (baud\footnote{1 baud représente 1 symbole par seconde.})

En l’occurrence, la CNC communique à 115200 bauds.


\chapter{Rappels du G-Code}

Le G-Code est un langage machine utilisé par les machines numériques.
Chaque instruction G-Code se termine un retour à la ligne (valeur 13 dans la table ASCII). Par souci de lisibilité, il ne sera pas affiché.
\section{Le référentiel}
Soit on effectue les déplacements de manière relative (+xmm depuis la position actuelle) ou absolue (depuis l'origine avec les capteurs fin de course)
Pour définir le référentiel, on utilise soit la commande suivante pour le référentiel absolu:

\begin{Cpp}{Référentiel absolu}
G90
\end{Cpp}
et pour le référentiel relatif : 
\begin{Cpp}{Référentiel relatif}
G91
\end{Cpp}

Par la suite, on va utiliser le mode relatif.

\section{Les déplacements}

Pour se déplacer on va utiliser la commande suivante : 

\begin{Cpp}{La commande de déplacement}
G01 X[mm] Y[mm] Z[mm]
\end{Cpp}

Les arguments entre crochets correspondent aux déplacements voulus sur les axes concernés.\\
Ainsi, si on souhaite se déplacer de 20 mm vers le centre sur l'axe X, on va utiliser la commande : 

\begin{Cpp}{Les déplacements}
G01 X20
\end{Cpp}

Les axes non concernés par le déplacement ne sont pas présents dans la commande.

\section{Le retour à l'origine}

Le retour en position d'origine se fait via la commande suivante : 

\begin{Cpp}{Retour à l'origine}
G28 [X] [Y] [Z]
\end{Cpp}

Ainsi, pour effectuer un retour à l'origine sur l'axe X on fait la commande 

\begin{Cpp}{Retour à l'origine sur X}
G28 X
\end{Cpp}

\chapter{Algorithme de déplacement}

L'objectif est de ne pas faire de déplacement sur X ou Y lorsque le moteur Z est activé afin d'éviter de casser les aiguilles.


Au début du programme, le porte-aiguille est placé aux coordonnées (0,0) avec le porte-aiguille en position de repos (position haute).\\
Pendant toutes les durées des déplacements en X et Y, le porte-aiguille reste en position de repos.
\begin{items}{blue}{\Triangle}
\item Le porte-aiguille se déplace en Y de la moité de la largeur de la tête contenant les aiguilles (disons 8mm)
\item Le cycle Z correspond à plusieurs aller-retour du porte-aiguille et à leur retour en position de départ (capteur de fin de course activé)
\end{items}

Ce cycle se reproduit pour balayer l'ensemble du plateau.

\img{\rootImages/cycle.png}{Cycle de poinçonnage}{0.5}


\chapter{Programmation Python}

\section{L'interface graphique}

Le choix de l'interface graphique s'est porté sur les bibliothèques PyQt5.\\


\section{Installation des outils}


\begin{Bash}{Installation des outils}
sudo apt install python-pip
sudo apt-get install python-qt5
sudo apt-get install pyqt4-dev-tools 
pip install pyserial
sudo apt-get install qt4-designer
\end{Bash}


    
\section{Un premier programme}

Ce premier programme, sans interface graphique (juste dans un terminal) permet de vérifier le bon déplacement de la tête sur l'ensemble du plateau.

\img{\rootImages/algo.png}{Déplacement de la tête}{0.4}


Pour lancer le programme, il faut saisir la commande suivante : 
\begin{Bash}{Lancement du programme}
python GCode.py
\end{Bash}

Le programme demande ensuite les dimensions du plateau (X et Y) et il va générer au fur et à mesure le G-Code pour balayer le plateau.

\subsection{Code source}

\begin{Python}
#!/usr/bin/python
# -*- coding: utf-8 -*-

from math import floor
import serial
import time

ser = serial.Serial( '/dev/ttyACM0', 115200,serial.EIGHTBITS, serial.PARITY_NONE, serial.STOPBITS_ONE, timeout=0.1)
ser.flushInput()  #Vide le buffer

if(open):
    print("Communication fonctionnelle !")
else:
    print("Mauvaise communication")

decalagePas = 8 #moitie du porte outil en mm

yWidth = input("Quelle est la longueur du plateau ? (mm) : ")
xWidth = input("Quelle est la largeur du plateau ? (mm) : ")

yIter = floor(int(yWidth)/8)
xIter = floor(int(xWidth)/8)

nbBlocX = xIter/2
deplacementZ = 10 #mm
vitesse=4 #max 6

print("Nombre d'arret sur X : "+str(xIter))
print("Nombre d'arret sur Y : "+str(yIter))

def sendCommand(command):
    print("Commande : "+str(command))
    ser.write(command+'\n')
    result=""
    waitingOK = True
    while (waitingOK==True): # tant que au moins un caractère en réception
        char=ser.read() # on lit le caractère
        if char=='\n': # si saut de ligne, on sort du while
            result=""
        else: #tant que c'est pas le saut de ligne, on l'ajoute à la chaine 
            result=result+char	
            if(result=="<ok>"):
                print("Commande valide")
                waitingOK = False


#Init
print("Mode relatif")
sendCommand("G91") #Mode relatif

#Retour Home
print("Retour origine")
sendCommand("G28 X")
sendCommand("G28 Y")


#Generation du GCode
gcode =""
for xBloc in range(0, int(nbBlocX)):
    #Code bloc
    
    for xStep in range(0,int(yIter)):
        gcode += "G01 Y"+str(decalagePas)+" F4"+"\n"
        gcode += "G04 P0.1"+"\n"
    
    gcode += "G01 X"+str(decalagePas)+" F"+str(vitesse)+"\n"
    
    for xStep in range(0,int(yIter)):
        gcode += "G01 Y-"+str(decalagePas)+" F4"+"\n"
        gcode += "G04 P0.1"+"\n"
    
    gcode += "G01 X"+str(decalagePas)+" F"+str(vitesse)+"\n"
    

print(gcode)

allCommands = gcode.split("\n")
print("Nombre d'instructions a executer :" +str(len(allCommands)))

for line in allCommands:
    sendCommand(line)
        
 

\end{Python}



\section{Une première interface}

Voici la première version d'une interface graphique réalisée avec PyQt4.

Le code est disponible sur le Git du club à \\
l'adresse \link{\url{https://github.com/CREPP-PLOEMEUR/Feutrage-de-laine}}

\subsection{Utilisation de l'interface}

Tout d'abord, veuillez télécharger le dossier complet puis se rendre dans le dossier \dir{V4\_GUI\_PyQt4}

Ensuite, faire click-droit et \bold{Ouvrir un terminal ici}

Ensuite, saisir la commande suivante pour lancer l'interface : 

\begin{Bash}{Ouverture de l'interface}
python GUIMain.py
\end{Bash}

L'interface se lance. Elle se compose de 3 onglets : 

\begin{items}{blue}{\Triangle}
    \item Présentation
    \item Paramètres
    \item Lancement du cycle
\end{items}

Veuillez vous rendre à l'onglet \bold{Présentation}

\img{\rootImages/c1.png}{Onglet Présentation}{0.25}

Il détaille le déplacement du porte aiguilles sur le schéma.\\

Une barre de statut est disponible sur tous les onglets et indique l'état courant du cycle. Au démarrage de l'application, il indique \bold{Non connecte}.\\

il faut donc se connecter à la machine.\\
Pour cela, il faut sélectionner le port série disponible dans la liste (ttyACMX généralement) et cliquer sur \shortcut{Connect}.\\
En cas de bonne connexion, la barre de statut indique \bold{Connecte}.

\img{\rootImages/c2.png}{Connexion effectué}{0.5}

Il faut ensuite cliquer sur l'onglet \bold{Paramètres}

\img{\rootImages/c3.png}{Paramètres du cycle}{0.25}

Voici les différents paramètres du cycle
\begin{items}{blue}{\Triangle}
    \item La longueur du plateau en mm [0-300mm comme valeur possible]
    \item La largeur du plateau en mm [0-300mm comme valeur possible]
    \item Déplacement du porte-aiguilles : Cela correspond à la distance parcourue (en mm) par le porte-aiguilles entre deux séquences de poinçonnage
    \item Déplacement de l'axe Z : Cela correspond à l'image de la distance pour effectuer une rotation pour planter le porte-aiguilles et le faire remonter en position de repos. Il faudra jouer avec cette valeur pour que le porte-aiguilles fasse précisément un aller-retour jusqu'à la position de repos.
    \item Nombre d'actions de l'outil-aiguilles : Cela correspond au nombre d'aller-retour effectués par le porte aiguilles entre 2 déplacements (X ou Y) sur le plateau
    \item Vitesse sur l'axe X et Y : La vitesse de déplacement sur l'axe X et Y comprise entre 1 et 6
    \item Vitesse sur l'axe Z : La vitesse de déplacement sur l'axe Z comprise entre 1 et 10
\end{items}

Une fois tous les paramètres renseignés, nous allons pouvoir lancer un cycle. Pour cela, il faut se rendre dans l'onglet \bold{Lancement du cycle}

Il ne reste plus qu'à lancer le cycle en appuyant sur le bouton \shortcut{Lancer le cycle}.

\img{\rootImages/c4.png}{Lancement d'un cycle}{0.25}

Une fois le cycle lancé, il est possible de l’arrêter en cliquant sur \shortcut{Arreter le cycle}.

\img{\rootImages/c5.png}{Un cycle en cours}{0.25}

Lorsque le cycle est arrêté, si vous cliquez sur \shortcut{Lancer le cycle}, ce dernier va reprendre du début, c'est à dire en coordonnées (0,0).\chapter{Poulailler}

\section{Calculs des condensateurs}

\chapter{Cahier des Charges}

\section{Contrainte de contrôle}

Il y a différentes solutions pour activer la séquence du poulailler 
Voici les avantages et les inconvénients :

\begin{items}{blue}{\Triangle}
    \item Contrôle par télécommande infrarouge
    \begin{items}{green}{\Bullet}
        \item Système assez fiable
    \end{items}
    \begin{items}{red}{\Bullet}
        \item Présence obligatoire
        \item Distance faible
    \end{items}
    \item Contrôle par smartphone
    \begin{items}{green}{\Bullet}
        \item Système ergonomique
    \end{items}
    \begin{items}{red}{\Bullet}
        \item Présence obligatoire
        \item Distance faible
    \end{items}
    \item Contrôle par la lumière ambiante
    \begin{items}{green}{\Bullet}
        \item Système autonome
    \end{items}
    \begin{items}{red}{\Bullet}
        \item Moins souple
    \end{items}
\end{items}


Le système par la lumière ambiante permet donc d'avoir un système autonome sans caliberer une horloge pour régler le lever et le coucher des poules.

\section{Contrainte d'ouverture/fermeture}

Un système de herse mobile sera utilisé pour ouvrir et fermer le poulailler.
Un moteur entraînera une poulie afin d'effectuer la séquence.

\section{Contrainte d'autonomie}


Il y a différentes solutions pour alimenter le poulailler
Voici les avantages et les inconvénients :


\begin{items}{blue}{\Triangle}
    \item Alimentation par prise secteur
    \begin{items}{green}{\Bullet}
        \item Système rapide à mettre en place
    \end{items}
    \begin{items}{red}{\Bullet}
        \item Peu pratique
        \item Dépend du courant dans la maison
    \end{items}
    \item Alimentation par batteries
    \begin{items}{green}{\Bullet}
        \item Autonomie
    \end{items}
    \begin{items}{red}{\Bullet}
        \item Système de recharge 
    \end{items}
\end{items}

L'alimentation va reposer sur des supercondensateurs qui vont jouer le rôle de réservoir d'energie.
En journée, les supercondensateurs vont se charger et à la tombée de la nuit, une partie de leur énergie ira au moteur pour fermer la porte.
Ayant stocké assez d’énergie, il restera suffisamment d’énergie au lever du jour pour effectuer une ouverture de la porte.\chapter{Cahier des Charges}
\newcommand{\constrain}[1]{\lbl{blue}{CON}{#1}}

Ce logiciel permettra de gérer efficacement les composants électroniques.

\begin{items}{blue}{\Triangle}
    \item Une bibliothèque commune de composants
    \item Une bibliothèque personnelles
\end{items}


\begin{items}{green}{\Bullet}
    \item Un identifiant unique \\
    \constrain{PRIMARY KEY}
    \item Une référence unique \\
    \constrain{ALPHANUM} \constrain{UPPERCASE}
    \item Une désignation 
    \item Une catégorie
    \item Une sous-catégorie
    \item Un boîtier
    \item Une plage d'alimentation
    \item Une documentation technique
    \item Une image
\end{items}

Les images et documents ne seront pas stockés au format binaire dans la base de données, cela prend trop de place et ralentis considérablement le temps d'accès aux données.



\section{Cas d'usages}
\begin{items}{blue}{\Triangle}

    \item L'utilisateur souhaite ajouter un composant non existant dans la bibliothèque
    \item L'utilisateur souhaite ajouter un composant dans sa base de données personnelle.
    \begin{items}{blue}{\Bullet}
        \item Le composant existe, il l'ajoute dans son espace personnel.
        \item Le composant n'existe pas dans la bibliothèque, il doit l'ajouter manuellement dans la bibliothèque puis l'ajouter dans son espace personnel.
    \end{items}
    \item L'utilisateur souhaite consulter un composant dans la bibliothèque
    \item L'utilisateur souhaite consulter un composant dans son espace personnel
\end{items}

\chapter{Processus global}


Lien du planning  :\url{https://docs.google.com/spreadsheets/d/1A7SzA6MrE79ad0Wu_JOUoUsbwYkRI9X0kK3oco4b4y0/edit?usp=sharing}

Voici les différentes étapes et axes de travail du projet de stage. Toutes ces étapes sont détaillées par la suite.

\section{Processus Devis}

\begin{items}{orange}{\Bullet}

\item Extraction des données clients (OCR). 
Depuis plusieurs supports clients (PDF, mails, Excel),pouvoir extraire les données pour les manipuler plus facilement (codification, recherche des prix en ligne...)

\item Récupération des prix, des délais de livraison et des durées de vie des composants par les fournisseurs et distributeurs.

\item Gestion des devis PCB

\item (Gestion des données documentaires (accès simplifié des plans, datasheets pour les services suivants))

\end{items}


\section{Processus Codification}

\begin{items}{orange}{\Bullet}

\item Reduction de l’utilisation d’Excel via la mise en place d’outils de traitement plus automatiques. Ces outils visent à importer automatiquement les données en provenance des fournisseurs (API) pour faire une codification automatique.

\item En découle une gestion attentive des doublons de référence lors de la codification automatique.

\end{items}

\section{Processus Approvisionnement}

\begin{items}{orange}{\Bullet}
\item Mise à jour régulière des prix et délai pour les commandes.
\end{items}

\section{Synthèse du processus}

\img{\rootImages/processus.PNG}{Processus de traitement global}{0.9}

\section{Les limites actuelles}

Voici la liste des limites et des contraintes pour la mise en place des outils :
\begin{items}{red}{\Triangle}

\item Il y a une limitation du nombre de licences X3, actuellement, tout le monde ne peux pas
utiliser X3
\item Taille du serveur pour stocker des fichiers (datasheets et plans peuvent poser un problème
de taille, 7000 fichiers. Avec une moyenne de 10 Mo par fichier, cela fait plus de 70 Go de stockage nécessaires. Ce point sera abordé dans la gestion des datasheets lors de la récupération des données en ligne.
\item Pour chaque API, nous sommes limités à 1000 requêtes par jour.
\end{items}
%\part{Annexes}
\chapter{Connexions aux API}

\section{Informations API}

Ce tableau récapitule l'ensemble des informations des API utilisées\footnote{Utile en cas de mise à jour de l'API}\\

\subsection{DigiKey}

\begin{tabular}{|p{3cm}|p{13cm}|}
  \hline
  \bold{Nom} & \bold{Valeur} \\
  \hline
Url access & \url{https://sandbox-api.digikey.com/v1/oauth2/authorize}\\
  \hline
ClientID\footnote{Données via l'application API sur le compte \url{www.digi-key.com}} & h7E4dTHl4UNGf6SV7byTr05JS3KyKrGr\\
 \hline
 SecretKey & PwhcS2Hmi0HhNoAG\\
 \hline
 CustomerID & 8509437 \\
  \hline
 API version & 3.0\\
  \hline
  Output Format & JSON\\
  \hline
  Requests / day & 1000\\
  \hline
\end{tabular}

Le service d'authentification de Digi-key nécessite un serveur pour rediriger le premier résultat de Digi-key (code).


\subsection{Mouser}

\begin{tabular}{|p{3cm}|p{13cm}|}
  \hline
  \bold{Nom} & \bold{Valeur} \\
  \hline
Url & \url{https://api.mouser.com/api/v1.0/search/partnumber}\\ 
 \hline
ApiKey &9b4489a8-bea0-48ec-9e51-60e5117ebf7b\\
  \hline
Api version & 1.0 \\
  \hline
  Output Format & JSON\\
  \hline
  Requests / day & 1000\\
  \hline
\end{tabular}



\subsection{Farnell} Compte ALine => pettona
E14 : 
login : nicolasleguerroue2
MOT DE PASSE : Bk8WPDkxpkACPqN
API\_KEY = rc772yuvs86tvjnrsvah6z5e 



\begin{tabular}{|p{3cm}|p{13cm}|}
  \hline
  \bold{Nom} & \bold{Valeur} \\
  \hline
Url & \url{https://api.element14.com/catalog/products}\\
 \hline
 ApiKey & ndukznmj3n4yq524y6hnxnme\\
  \hline
 CustomerId & 5174230003\\
  \hline 
  SecretKey & gaD8uChe\\
  \hline
  Output Format & JSON\\
  \hline
  Requests / day & 1000\\
  \hline
\end{tabular}


\subsection{Arrow}

\begin{tabular}{|p{3cm}|p{13cm}|}
  \hline
  \bold{Nom} & \bold{Valeur} \\
  \hline
Url & \url{http://api.arrow.com/itemservice/v3/en/search/token}\\
 \hline
 Login & techwavemanufacturing2\\
  \hline
 CustomerId & 5174230003\\
  \hline 
  ApiKey & 7917a314eaea1f70cb0348157a001fd0e4874e6647bfb33f6c12210e4fb4e2a5\\
  \hline
  Api version & 3 \\
  \hline
  Output Format & JSON\\
  \hline
  Requests / day & 1000\\
  \hline
\end{tabular}

\subsection{Future}

\begin{tabular}{|p{3cm}|p{13cm}|}
  \hline
  \bold{Nom} & \bold{Valeur} \\
  \hline
Url & \url{https://api.futureelectronics.com/api/v1/pim-future/lookup}\\
 \hline
ApiKey & 9b4489a8-bea0-48ec-9e51-60e5117ebf7b\\
  \hline
Api version & 1 \\
  \hline
  Output Format & JSON\\
  \hline
  Requests / day & 1000\\
  \hline
\end{tabular}



\section{Formats de sortie après recherche des API}

Il est possible d'exporter les résultats sous 3 formes : 

\begin{items}{orange}{\Triangle}
\item JSON
\item CSV
\item HTML
\end{items}

\subsection{Format JSON}

Ce format sera utilisé pour communiquer entre le serveur Web et le programme récupérant les données en provenance des API.

\begin{Python}{Fichier de sortie JSON}

{
    "status" : "OK"
    "message" : "Message",
    "result" : 
    [{
        "fabricantPartNumber": "fabricantPartNumber",
        "wishedFabricantPartNumber": "wishedFabricantPartNumber",
        "unitPrice": "0.058",
        "isBestPrice": "true",
        "availableOrderQuantity": "true",
        "isAvailableForOrder": "true",
        "wishedQuantity": "10",
        "directOrder": "true",
        "minimalOrderQuantity" : "1",
        "groupeOrder" : "1",
        "apiName": "apiName",
        "warning": "warning message from API",
        "realItem": "true",
        "similarItem" :"false",
        "isObsolete" : "false"
    
    },
    {...}
    ]
}

\end{Python}

\subsection{Format CSV}

Ce format a été développé pour une utilisation particulière afin de réaliser des devis sans l'interface Web proposée par la section \bold{Architecture}

\begin{verbatim}
    Reference demandee;Reference trouvee;PU Mouser;PU Farnell;PU Future;
    MOQ Mouser;MOQ Farnell;MOQ Future;Quantitee Mouser;Quantitee Farnell;
    Quantitee Future;Delais Mouser;Delais Farnell;Delais Future;
    Description Mouser;Description Farnell ;Description Future;Obsolete
    Mouser ?;Obsolete Farnell ?;Obsolete Future ?
    1UX99;Aucune reference trouvee;0.0;0.0;0.0;;;;
    0;0;0;2 semaines;2 semaines;2 semaines;Inconnue;Inconnue;
    Inconnue;False;False;False

\end{verbatim}



\subsection{Format HTML}

Ce format peut être utilisé pour le développement du programme et pour garder un historique des résultats\footnote{Le format est plus lisible que le JSON ou CSV}

\img{\rootImages/bestPrice.PNG}{Format HTML}{0.52}



\chapter{Connexion à la base de données d'X3}

\section{Formats d'entrée / sortie de l'utilitaire de lecture de la BDD X3}

\subsection{Exécution du programme}

Le programme de lecture de la BDD X3 devra être exécuté comme suis :

\begin{verbatim}
    java -jar LectureBDDX3 input.json output.json
\end{verbatim}

Le fichier input.json pourra être remplacer par stdin pour que le programme récupère le JSON à partir de l’entrée standard.

Le fichier output.json pourra être remplacer par stdout pour que le programme écrive son résultat dans la sortie standard.

Si le programme est invoqué sans paramètres, le programme utilisera stdin et stdout par défault.


\subsection{Format d'entrée}

Le format du fichier input.json sera (exemple) :

\begin{Python}{Fichier d'entrée JSON}
    {
        "request" :  "SELECT ab, cd, ef FROM test WHERE abc = ? AND cde = ?",
        "result_values" : [
            { "type" : "string", "out_name" : "ijk", "db_name" : "ab" },
            { "type" : "bool", "out_name" : "lmn", "db_name" : "ab" },
            { "type" : "int", "out_name" : "opq", "db_name" : "ab" }
        ],
        "params" :  [
            { "type" : "string", "value" : "abc_val" },
            { "type" : "int", "value" : 123 }
        ]
    }

\end{Python}

Types supportés par les paramètres : string, int, float, bool, date

\subsection{Format de sortie}

Le format du fichier output.json sera (exemple) :

\begin{Python}{Fichier de sortie JSON}
    {
        "status": "OK",
        "message" : "OK",
        "results" : {
            "ijk":"test",
            "lmn": true,
            "opq": 123   
        }
    }
\end{Python}

Le noms des clées dans l'objet results doit correspondre à la valeur de out\_name dans la configuration d'entrée.
\\ \\
En cas d’erreur le fichier output.json sera de la forme :

\begin{Python}{Fichier de sortie JSON Erreur}
    {
        "status": "NOK",
        "message": "Error message"
    }
\end{Python}


\section{Formats d'entrée / sortie de l'utilitaire d'écriture à la BDD X3}

\subsection{Exécution du programme}

Le programme d’écriture de la BDD X3 devra être exécuté comme suis :

\begin{verbatim}
    java -jar EcritureBDDX3 input.json output.json
\end{verbatim}

Le fichier input.json pourra être remplacer par stdin pour que le programme récupère le JSON à partir de l’entrée standard.

Le fichier output.json pourra être remplacer par stdout pour que le programme écrive son résultat dans la sortie standard.

Si le programme est invoqué sans paramètres, le programme utilisera stdin et stdout par défault.

Ce programme aura aussi un fichier config.json décrivant les caractéristiques de chacune des commandes acceptées.

\subsection{Format du fichier de config}

Le format du fichier config.json sera (exemple) :

\begin{Python}{Fichier de config JSON}
    [
        {
            "command" : "ABCDE",
            ...
        },
        { ... }
    ]
\end{Python}
	
Ici chaque objet de la liste représente une commande disponible.
Ce fichier sera fixe et n'est pas sensé être modifié par le programme, juste lu.

\subsection{Format d'entrée}

Le format du fichier input.json sera (exemple) :

\begin{Python}{Fichier d'entrée JSON}
    {
        "command":  "ABCDE",
        "params":  [
            { "name": "abc", "value": "abc_val" },
            { "name": "def", "value": 123 }
        ]
    }
\end{Python}

On y précise la commande que l'on souhaite exécuter, puis les paramètres de cette commande. Les paramètres serons souvent composés de la liste des objets à insérer dans la BDD mais peuvent aussi différer d'une commande à l'autre au besoin.

\subsection{Format de sortie}

Ce programme ne faisant qu’écrire dans la BDD, il n’a rien d’intéressant à revoyer. Toutefois on revoie quand même quelque chose pour pouvoir gérer les éventuelles erreurs. Le format du fichier output.json sera donc simplement (exemple) :

\begin{Python}{Fichier de sortie JSON}
    {
        "status": "OK" / "NOK",
        "message": "Message d’erreur si erreur",
    }
\end{Python}



\chapter{Structure et chemins du site web}

\section{Page d’accueil}

\subsection{./ (ou ./index.html)}

Page d’accueil contenant des infos générales sur le site ainsi qu’un accès simple à chacune des fonctionnalités du site.

\section{Recherche des composants sur l’API fournisseur}

\subsection{./rechercheAPIFournisseur.html}

Page permettant d’importer un BOM sous format CSV et de vérifier l’intégralité des composants de cette BOM sur les API des fournisseurs. Une fois les requêtes aux API terminées, l’utilisateur est redirigé vers la page resultatAPIFournisseur.html. Les résultats de l’API est sauvegardé sous forme d’un fichier html sur le serveur pour garder une trace de la requête si on veut la revoir plus tard et être récupéré par la page resultatAPIFournisseur pour l’affichage.
\\ \\
Le fichier CVS importé doit être sous ce format :

\begin{items}{orange}{\Triangle}
\item Séparé avec des ; | String échappés avec des " (Format par défaut d’export Excel en CSV)
\item Si le CSV ne vient pas de l’export d’Excel, ces options sont modifiables au moment de l’exportation
\item Chaque ligne du fichier CVS correspond à un composant de la BOM
\item Les 3 colonnes du CSV doivent correspondent, dans l’ordre à : (La référence fabricant du composant, la quantité de ce composant requis par carte, une description de ce composant)
\item Le fichier ne doit pas comporter de 1ere ligne nommant chacune des colonnes
\end{items}

\subsection{./resultatAPIFournisseur.html}

Sur cette page, l’utilisateur peut consulter les résultats des API pour chaque composant :

\begin{items}{orange}{\Triangle}
\item Il peut consulter les informations de prix, disponibilité, livraison, … pour chaque composant 
\item Pour les composants concernés, il peut choisir parmi les composants alternatifs trouvés par les API et en sélectionner un comme remplacement.
\end{items}

\section{Gestionnaire des fiches composants}

\subsection{./fichesCompo.html}

Sur cette page l’utilisateur peut rechercher des fiches composant préalablement enregistrées. Cette recherche se fait dans un champ unique, avec une liste déroulante de choix correspondants à la recherche se mettant à jour à mesure que l’utilisateur tape. La recherche se fait sur :

\begin{items}{orange}{\Triangle}
\item La référence fabricant (Contenue dans la BDD MySQL)
\item La description du composant (Contenue dans la BDD MySQL)
\item La référence AODE (Recherche dans la BDD X3 à partir des références fabricant présentes dans la BDD MySQL)
\end{items}

Une fois la recherche terminée, l’utilisateur peut télécharger la fiche composant correspondante.

L’utilisateur a aussi à disposition une interface pour ajouter manuellement une fiche ou en supprimer une de la base.


\section{Utilitaire transcription de tableaux PDF}

\subsection{./transcriptionPDF.html}

Sur cette page, l’utilisateur peut upload un fichier PDF contenant un tableau de données et récupérer un fichier CSV avec les dites données. La page informe l’utilisateur de l’avancement de la transcription pendant le traitement puis lui permet de télécharger le fichier CSV.

\section{Utilitaire relances fournisseurs}

\subsection{./relancesFournisseurs.html}

Sur cette page, l’utilisateur peut consulter les dernières relances fournisseurs envoyées automatiquement. Plusieurs pages sont disponibles pour ne pas à avoir à charger l’intégralité des données à chaque visite de la page.


\chapter{Structure du répertoire Python}

\begin{items}{orange}{\Triangle}
\item API
\begin{items}{blue}{\Triangle}
\item \lib{ArrowAPI.py} : Connexion à l'API Arrow et gestion des composants
\item \lib{ArrowItem.py} : Extraction des information pour les composants Arrow
\item \lib{AvnetAPI.py} : Connexion à l'API Avnet et gestion des composants
\item \lib{AvnetItem.py} : Extraction des information pour les composants Avnet
\item \lib{DigiKeyAPI.py} : Connexion à l'API Arrow et gestion des composants
\item \lib{DigiKeyItem.py} : Extraction des information pour les composants Digi-key
\item \lib{FarnellAPI.py} : Connexion à l'API Arrow et gestion des composants
\item \lib{FarnellItem.py} : Extraction des information pour les composants Farnell
\item \lib{FutureAPI.py} : Connexion à l'API Arrow et gestion des composants
\item \lib{FutureItem.py} : Extraction des information pour les composants Future
\item \lib{MouserAPI.py} : Connexion à l'API Arrow et gestion des composants
\item \lib{MouserItem.py} : Extraction des information pour les composants Mouser
\item \lib{Item.py} : Informations d'un Item
\item \lib{ItemManager.py} : Gestionnaire de liste d'Item
\item \lib{ThreadAPI.py} : Bilbiothèque pour la recherche API en multi-threading
\end{items}
\item Backups
\begin{items}{orange}{\Triangle}
\item 2021
\item ....
\end{items}
\begin{items}{blue}{\Triangle}
\item counter.txt : Compteur de requêtes API  journalières\footnote{Remis à zéro tous les jours}
\end{items}
\item JSON
\begin{items}{blue}{\Triangle}
\item inputPartNumbers.json : Fichier d'entrée des composants à chercher
\item outputPartNumbers.json : Fichier de sortie des résultats des API
\end{items}
\item Utils
\begin{items}{blue}{\Triangle}
\item \lib{CSV.py} : Bibliothèque de lecture/Ecriture de fichiers CSV
\item \lib{Utils.py} : Bilbiothèque avec des fonctions de traitement
\item \lib{Mail.py} : Bibliothèque d'envoi de mails
\end{items}
\end{items}
\begin{items}{green}{\Triangle}
\item \file{main.py} : Code principal

\end{items}


\section{Notes sur le multi-threading} 

Chaque \label{multithrading} requêtes API est exécutée en parallèle pour optimiser le temps global d'exécution.

La classe \file{ThredAPI} est instanciée dans \file{main} et le constructeur attend les paramètres suivants : 
\begin{items}{green}{\Triangle}
\item threadID : Identifiant du thread [0...N]
\item threadName : Nom du thread ("Mouser Thread"...)
\item ItemManager : Instance de la classe \file{ItemManager}, par héritage les classes des API (\file{MouserAPI}, \file{FarnellAPI}...)
\item references : Liste des références à chercher avec les API
\item quantities : Liste des quantités souhaitées pour chaque référence demandée
\item exportFile : Fichier de sortie HTML (logs)
\item itemList : Liste vide qui stockera tous les composants trouvés (passage par référence)
\item function : Fonction à appeler en multi-threading
\end{items}

\section{Modules Python nécessaires}

Le code pour récuperer les données en provenance des API est disponible pour les versions python 2.X et 3.X

Le module \lib{requests} est nécessaire, tout comme les modules 
\lib{datetime}, \lib{os}, \lib{threading}, \lib{time} et \lib{json} qui sont inclus par défaut.

\chapter{A faire}


- Récupérer information compte Farnell 

- Relance clé API Avnet !

- Gestion si plusieurs composants trouvés mais le meilleurs prix est obsolète !

- Finir documentation code (Avnet+Digi-key)+ diagrammes

- Vérifier code d'erreur execThread si len(quantities)!=len(references)%\part{Processus Approvisionnement}

\chapter{Mise à jour des informations devis}

\section{Présentation du besoin}

Entre la création d'un devis et la commande, il peut se passer plusieurs jours voir plusieurs semaines. Il convient donc de mettre à jour les informations du devis car le service Approvisionnement se base sur les données Devis.

\section{Pistes suggérée}

En faisant une recherche en ligne avec les API, il est possible de récupérer les prix et informations des composants du devis.\\
En cette période ou les composants change de prix et les disponibilité fluctuent rapidement, il se peut que certains composants n'existent plus entre le devis et la commande.

\section{Fréquence de rafraîchissement}

La fréquence de rafraîchissement maximale dépend du nombre de requêtes possibles par API. En moyenne, ce nombre vaut 1000.

Deux politiques de rafraîchissement envisagées : 

\begin{items}{orange}{\Triangle}
\item Une mise à jour automatique tous les X jours.
\item Une mise à jour sur demande.
\end{items}


\subsection{Mise à jour automatique}

Ce choix semble compliqué car au vu du nombre maximal de requêtes, nous pouvons avoir le scénario suivant : 


\begin{items}{blue}{\Triangle}
\item Lundi : devis de 45 lignes réalisé, cela implique 45 requêtes.
\item Mardi : 3 devis de 25 lignes. Si mise à jour du devis de lundi, cela fait 120 requêtes à la journée
\item Mardi : 2 devis de 30 lignes. Si mise à jour du devis de lundi et mardi, cela fait 180 requêtes à la journée
\item Mardi : 4 devis de 20 lignes. Si mise à jour du devis de lundi,mardi mardi et mercredi, cela fait 260 requêtes à la journée
\end{items}
En suivant ce rythme, on voit bien qu'au bout d'une semaine ou deux, le nombre de requêtes par jour dépasse les 1000.

\subsection{Mise à jour sur demande}

Avant de faire une commande pour une BOM, il faudrait mettre à jour la BOM spécifique.

Avec une moyenne de XX lignes de commande par jour, cela représente XXX requêtes par jour, ce qui est plus acceptable.%\part{Processus Codification}

\chapter{Importation des composants}

\section{Définition du besoin}

Pour chaque nouveau composant venant d'un devis, il faut le codifier selon un format de donnée précis (cf GEN).

Lorsque le devis est terminé, on récupère les composants au format JSON ou CSV et on importe les composants en "masse". Cela permet d'automatiser la codification car les données en provenance des API sont fiables.%\part{Processus Devis}

\chapter{Gestion des formats client}

Les données des clients proviennent de différents supports (PDF, Excel...)

En ce qui concerne les fichiers PDF, il est souhaitable de lire les données du document pour les mettre dans un format exploitable (Fichier CSV, JSON...).


\chapter{Gestion des composants de la BOM}
\section{Présentation du besoin}

Il faut saisir et mettre à jour régulièrement le prix des composants. Le temps de recherche est long et fastidieux. Les composants sont recherchés sur les fournisseurs/distributeurs suivants  :

\begin{items}{orange}{\Bullet}
\item Farnell (1000 requêtes par jour, clé disponible, en attente de la \bold{secretKey} et \bold{custormerID})
\item Mouser ( 1000 requêtes par jour, clé disponible, pas de réduction pour Techwave)
\item Digi-key (1000 requêtes par jour, clé disponible, prix réduits)
\item Arrow (clé disponible, prix réduits)
\item Future (clé disponible, prix réduits)
\item Avnet (en attente de clé)
\end{items}


 RS-Component ne possède pas d'API et TTI met en place une API pour l'Europe cet été.
 
\section{Piste suggérée}

En récupérant les données fournisseurs avec des API\footnote{Interface de Programmation d'Application}, il est possible de connaitre la quantité, le prix et le temps de livraison estimé en temps réel.Une recherche d'un composant est considéré par la suite comme étant une requête.\\

Comme énoncé dans les limites, chaque API limite à 1000 requêtes par jour.

L’objectif est d’obtenir des prix fiables car ces derniers sont en provenance des fournisseurs.\\

Pour les composants obsolètes, recherche dans le stock (référence, type [CMS]...) et en cas de non correspondance, recherche en ligne.


\section{Gestion des API}

\subsection{format d'entrée des API}

Lors d'une recherche d'un composant pour une API, il convient de donner les éléments suivants : 

\begin{items}{blue}{\Bullet}
\item Référence fabricant souhaitée
\item Quantité souhaitée
\end{items}

\subsection{Format de sortie des API}
Pour une référence de composant données, chaque API va nous retourner une liste de composants ayant les attributs suivants : 

\begin{items}{blue}{\Bullet}
\item Référence fabricant
\item Catégorie
\item Lien de la documentation
\item Cyle de vie (Obsolète, nouveau produit...)
\item Description
\item Fabricant
\item Disponibilité
\item MOQ
\item Group Order\\
\end{items}

Les données en provenance des API sont au format JSON ou XML.


Les données sont récupérées via les API en multithreading\footnote{Se reporter à la page \pageref{multithrading} pour plus d'informations}, c'est à dire que les n fournisseurs/distributeurs sont solicités en même temps pour réduire le temps d'attente.\\

Une fois que les données brutes ont été reçues, ces données sont traitées et mises en forme sous forme de liste de composants dans un format spécifique (JSON)

\img{\rootImages/LectureAPI.png}{Utilisation des API}{1}

\subsection{Données composées}

Ces données peuvent avoir un format non conforme mais après traitement, nous pouvons en déduire les attributs suivants :\\

\begin{items}{blue}{\Bullet}
\item Prix unitaire
\item Quantité disponible
\item Etat du composant (obsolète, nouveau produit...)
\end{items}


\subsection{Traitement des données}


Les composants sont traités de la façon suivante :

\begin{items}{blue}{\Triangle}
\item On recherche tous les composants disponibles en quantités suffisante et on met de coté les composants oboslètes et similaires
\item On cherche le meilleur prix parmi les composants trouvés en tenant compte des MOQ\footnote{Minimal Order Quantity}
\item Si aucun composant n'est trouvée, on retourne un composant "inexistant"
\end{items}

En analysant ces données, nous pouvons définir des statuts pour chaque composant : 

\begin{items}{orange}{\Bullet}
\item Composant existant / inexistant
\item Composant obsolète/ non obsolète
\item Composants similaire / non similaire
\item Composant au meilleur prix
\end{items}

Un composant est défini come non existant si aucune référence pour le composant demandé n'est trouvée.\\

Si des composants sont trouvés mais sont tous en quantité insuffisante, le programme retourne le composant avec le meilleur prix.\\

Un composant est défini comme "similaire" lorsque la référence demandée n'est pas strictement incluse dans la référence trouvée.\\
Par exemple, si on cherche un composant \bold{BC337} et que l'API retourne une référence \bold{BC537}, le composant est considéré comme "similaire".

\img{\rootImages/MethodeAPI.png}{Processus de traitement des données}{1.1}

\subsubsection{Gestion des composants obsolètes}
Les composants avec la référence exacte mais obsolètes sont supprimés de la liste principale mais apparaissent dans une liste "obsolète"


\subsubsection{Gestion  des composants similaires}

Les composants similaires sont traités de la même manière que les composants avec la référence exacte

\subsubsection{Quelques cas d'usage}

Cas d'usage 1 : \\


Pour un composant demandé, on peut avoir : 

\begin{items}{orange}{\Bullet}
\item 0 composant avec la référence exacte trouvée
\item 1 composants avec la référence exacte obsolète
\item 2 composants similaires
\end{items}

\bold{Le choix devra donc se porter sur le meilleur composant similaire}\\

Cas d'usage 2 : \\

\begin{items}{orange}{\Bullet}
\item 1 composant avec la référence exacte trouvée
\item 0 composant avec la référence exacte obsolète
\item 5 composants similaires
\end{items}
\bold{Le choix devra se porter entre le meilleur prix du composant exact ou la référence similaire.}



\chapter{Devis PCB}

\section{Présentation du besoin}

Actuellement, les demandes de prix sont envoyé par mail aux fabricants des PCB (SAve, ICAP, Wurth PCB). L'entreprise est donc dépendante du temps de réponse des fabricants.

\section{Piste suggérée}

En fonction du type de PCB demandée, il convient d'aller sur le site du fabricant et d’utiliser l'outil de demande de prix en ligne.

Cet outils est une page WEB ou il faut saisir les paramètres du PCB (technologie multicouche, flex, hyper-fréquence)
.

Nous avons essayé de faire le processus avec une APi (Safe en l’occurrence) mais en dehors des circuits double-face, le nombre de paramètre est beaucoup trop important pour pouvoir être renseigné par notre site internet.


Les fabricants avec les outils de demande de prix sont les suivants : 

\begin{items}{orange}{\Bullet}
\item Safe
\item ICAP
\item Wurth PCB
\end{items}



\chapter{Gestion de la documentation}
\section{Présentation du besoin}

Le service Devis a parfois besoin de la datasheet ou d’un plan, le service Codification aussi
pour visualiser le composant. Il est donc souhaitable d’éviter le doublon de l’étape "recherche de datasheet" sur le Web.


\section{Piste suggéré}

Une première piste est la récupération des datasheets par certaines API fournisseurs. Il ets possible de récupérer le lien des datasheets et de les afficher sur le site\footnote{Recherceh par référence fabricant}


Idéalement, il faudrait supprimer les datasheets considérées comme obsolètes.\\


L’outil X3 n'est pas capable de supporter l’importation de fichier PDF.

Nous pourrions utiliser un CMS pour la gestion des Documents (GED) mais ceux si sont parfois payants et la taille des données manipulées (lien HTML) ne justifie pas l'utilistion d'un GED.

Parmi les GED existants, notons : 

\begin{items}{orange}{\Bullet}
\item Xoops
\item Nuxeo
\item Alfresco
\item KnowledgeTree
\item Drupal
\end{items}
\chapter{Gestion des relances}


\section{Présentation du besoin}

Il faut relancer régulièrement les fournisseurs lorsque le temps de la réponse pour la validation de la commande est trop long.

\section{Piste suggérée}

En se connectant à la base de données, on peut récupérer les "gap ARC" et envoyer le mail approprié en conséquent via des bibliothèques Python. Le tout encapuslé dans un script, avec un fichier logs pour la tracabilité des mails.\\

L’envoi se ferait à partir d’un serveur SMTP Outlook basé sur une adresse mail de l’entreprise (adresse mail d'Aline)

\section{Vérifications}

Le serveur SMTP s’occupe de l’envoi des mails mais normalement, les mails non envoyés sont renvoyés dans la messagerie d’envoi, ce qui permet de vérifier le bon envoi des mails.




\section{Structure du code}

Sur l'interface principale, le bouton "Mettre à jour" se contente d'appeler un script python qui, lui, va lire la base de données et sauvegarder le contenu dans un fichier au format JSON.

Respectivement, pour :


- les relances ARC : rawARC.json

- les relances retards : rawLate.json


Ensuite, l'interface Web se contente d'afficher le fichier et de pré-cocher les relances sans erreur (c'est à dire avec une adresse mail, principale ou non).

Une fois les postes cochés, l'utilisateur valide avec le bouton "Valider" et la phase de relecture peut commencer. Il suffit juste à l'utilisateur de vérifier si une adresse mail est bien présente.

Enfin, il ne lui reste plus qu'à envoyer les mails en cliquant sur "Envoyer"

Un mail génère une erreur quand l'adresse d'envoi est vide ou bien il y a un espace. %
%\part{Architecture}

\chapter{Machine linux}
	
Le composant technique le plus important de ce projet est un serveur/VM linux où serons hébergées l’intégralité des fonctionnalités du projet. Ce serveur devra :

\begin{items}{orange}{\Bullet}
\item Pouvoir être accédé depuis le réseau interne de l’entreprise (Accès à un service web)
\item Pouvoir avoir accès à Internet (Pour aller interroger les API fournisseurs)
\item Pouvoir avoir accès au serveur interne brzadx01 (serveur host du système X3 / BDD X3) 
\end{items}

\begin{tabular}{|p{1.5cm}|p{6cm}|p{6cm}|p{2cm}|}
  \hline
  \bold{N°} & \bold{Tâche} & \bold{Description} & \bold{Nécessite} \\
  \hline
 1-1 & Déploiement du serveur /VM linux & La machine linux est déployée & - \\
 \hline
1-2 &	Accès par le réseau local de l’entreprise &	La machine linux doit être joignable par le réseau interne de l’entreprise & - \\
  \hline
1-3	& Accès à Internet & La machine linux doit avoir accès à Internet & - \\
\hline
1-4	& Accès à brzadx01 & La machine linux doit avoir accès au serveur brzadx01 & - \\
\hline
\end{tabular}

\section{Composant de lecture de la BDD X3}


Notre application a besoin d’accéder en lecture à la base de données de X3. Pour cela, nous allons utiliser une liaison directe avec la BDD Oracle avec un petit programme codé en (Java/PHP/Python ? TBD). Ce programme prendra en entrée :

\begin{items}{orange}{\Bullet}
\item Une requête SQL (Nous utiliserons principalement les vues fournies par Yves)
\item Des arguments pour la requête (Dépendant de la requête en question)
\end{items}

Et donnera en sortie : \\

\begin{items}{blue}{\Bullet}
\item Le résultat de la requête sous la forme d’un tableau d’objets JSON
\item Un statut OK/KO et un message d’erreur s’il y en a une
\end{items}

\begin{tabular}{|p{1.5cm}|p{6cm}|p{6cm}|p{2cm}|}
  \hline
  \bold{N°} & \bold{Tâche} & \bold{Description} & \bold{Nécessite} \\
  \hline
 2-1 & Récupération des données & La récupération des données par le programme doit être fonctionnelle & - \\
 \hline
2-2 &	Gestion des erreurs &	Le programme doit correctement renvoyer le statut KO et le message d’erreur s’il en est survenue & - \\
  \hline
\end{tabular}


\section{Composant d’écriture de la BDD X3}

Notre application a besoin d’écrire et de mettre à jour des données dans la BDD d’X3 (Notamment des articles). Pour cela, nous écrivons les données que nous voulons importer dans des fichiers CSV avant d’importer ces fichiers CVS dans le système X3.

Par mesure de sécurité et de simplicité d'utilisation de cet utilitaire, seul des commandes prédéfinies correspondantes aux différents options d'importation vers la BDD que nous offrira Yves. \\

\begin{tabular}{|p{1.5cm}|p{6cm}|p{6cm}|p{2cm}|}
  \hline
  \bold{N°} & \bold{Tâche} & \bold{Description} & \bold{Nécessite} \\
  \hline
 3-1 & Écriture des données & L’écriture des données par le programme doit être fonctionnelle & - \\
 \hline
3-2 &	Gestion des erreurs &	Le programme doit correctement renvoyer le statut KO et le message d’erreur s’il en est survenue & - \\
  \hline
\end{tabular}


\section{Base de données MySQL}

Afin de stocker les noms des fiches des composants pour permettre de le retrouver facilement, notre projet a besoin d’une base de données. \\

Cette base de données sera basée sur MySQL et sera host sur la même machine linux que le serveur web. Cette DBB servant uniquement pour cette fonctionnalité et dans le but de limiter un maximum les données redondantes avec la BDD d’X3, le MCD est très simple :\\

\begin{tabular}{|p{12cm}|}
  \hline
  \bold{Fiche} \\
  \hline
ref\_fab VARCHAR(30) PK \\
desc VARCHAR(100) \\
fiche VARCHAR(30) \\
  \hline
\end{tabular} \\

Et les tâches à réaliser : \\

\begin{tabular}{|p{1.5cm}|p{6cm}|p{6cm}|p{2cm}|}
  \hline
  \bold{N°} & \bold{Tâche} & \bold{Description} & \bold{Nécessite} \\
  \hline
 4-1 & Installation de MySQL-server & Installation de la BDD MySQL sur le serveur linux & 1-1 \\
 \hline
3-2 &	Création de la BDD &Création de la BDD décrite plus haut & - \\
  \hline
\end{tabular}

\section{Composants généraux serveur WEB}

Un serveur web va être nécessaire pour fournir une interface utilisateur pour chacun des éléments de ce projet. Nous allons donc pour cela :

\begin{items}{orange}{\Bullet}
\item Déployer un serveur web basé sur apache2 et PHP sur la machine linux
\item Développer un ensemble de composants JS spécifique aux besoins de ce projet :

\begin{items}{blue}{\Triangle}
\item Un composant permettant l’affichage et un peu de manipulation de données en tableau exemples : BOM, Résultats API, …
\item Un composant permettant de faire un appel direct en JS au composant de lecture de la BDD X3 sur le serveur.
\item Un composant permettant de faire un appel direct en JS au composant d’écriture dans la BDD X3 sur le serveur.
\end{items}

\end{items}


\begin{tabular}{|p{1.5cm}|p{6cm}|p{6cm}|p{2cm}|}
  \hline
  \bold{N°} & \bold{Tâche} & \bold{Description} & \bold{Nécessite} \\
  \hline
 5-1 & Déploiement du serveur WEB & Déployer le serveur web sur la machine linux & 1-1 \\
 \hline
5-2 &	Composant JS accès lecture BDD & Réalisation d’un composant JS permettant de faire le lien avec le composant de lecture de la BDD X3 sur le serveur & - \\
  \hline
5-3 & Composant JS accès écriture BDD & Réalisation d’un composant JS permettant de faire le lien avec le composant d’écriture de la BDD X3 sur le serveur & - \\
  \hline
5-4 &	Composant JS Tableau BDD & Réalisation d’un composant JS permettant l’affichage de données en tableau (BOM, Résultats API, …) & - \\
  \hline
5-5 &	Page d’accueil & Création d’une page d’accueil au site pour naviguer à travers ses différentes fonctionnalités & - \\
  \hline
\end{tabular}\\


Pour pouvoir faire le devis d’une BOM, le service achats a besoin des prix de chacun des composants de la BOM. La recherche de ces prix est coûteuse en temps. Or les fournisseurs nous donnes accès a des API permettant de récupérer des informations de prix, MOQ, etc relatives à ces composants automatiquement. Il serait donc intéressant d’aller rechercher ces informations automatiquement afin de réduire la charge de travail du service achats.\\

Pour cela, il nous semble pertinent de fournir au service achat une page web sur laquelle :


\begin{items}{orange}{\Bullet}
\item L’utilisateur doit entrer ces informations sur la page :
\begin{items}{blue}{\Triangle}
\item Une BOM sous format CSV composé de : (Ref Fabricant, Quantité par carte, Description).
\item Un nombre de cartes à produire
\end{items}

\item La page doit prendre ces données et :
\begin{items}{blue}{\Triangle}
\item Comparer les composants de la BOM à la BDD X3 existante pour voir s’ils y figurent
\item Aller vérifier grâce aux API des fournisseurs :
\begin{items}{black}{\Triangle}
\item Vérifier la présence des composants de la BOM, et si on les trouve, les trouver au meilleur prix, en prenant en compte des infos comme les MOQ.
\item Si on ne trouve pas ces composants, vérifier si les fournisseurs on des équivalences. Ces équivalences seront affichées sur la page web et devront être vérifiées à la main via la page web avant d’être validées.
\end{items}
\end{items}
\begin{items}{blue}{\Triangle}
\item Vérifier les stocks potentiels des composants de la BOM
\end{items}
\item Une fois ce traitement valider l’utilisateur peut :
\begin{items}{blue}{\Triangle}
\item Récupérer ces données sous la forme d’un fichier CSV
\item Déclencher une codification automatique de tout les composants découverts grâce aux API des fournisseurs
\end{items}
\end{items}

\begin{tabular}{|p{1.5cm}|p{6cm}|p{6cm}|p{2cm}|}
  \hline
  \bold{N°} & \bold{Tâche} & \bold{Description} & \bold{Nécessite} \\
  \hline
 6-1 &Recherche automatique des nouveau composants & Récupération des informations des API à propos d’un composant & -  \\
 \hline
6-2 & Recherche dans la base X3 des composants connus &Récupération des informations des composants connus par la BDD X3  & 2-1 \\
  \hline
6-3 & Front Web Page Entrée des informations & Réalisation de la page HTML / CSS d’entrée des informations & - \\
  \hline
6-4 &	Front Web Page Résultats & Réalisation de la page HTML / CSS d’affichage des résultats & - \\
  \hline
6-5 &Back web & Réalisation de la gestion de la requête AJAX au niveau du serveur (PHP) & - \\
  \hline
6-6 & Importation des CSV &L’utilisateur doit pouvoir importer un CSV contenant la BOM simplifiée sur la page WEB  & 4-4 \\
  \hline
6-7 & Téléchargement des résultats &	L’utilisateur doit pouvoir télécharger les résultats sous forme d’un CSV & 4-4 \\
  \hline
6-8 & Codification automatique des résultats API &L’utilisateur doit pouvoir déclencher la codification automatique des résultats découverts par API  & 3-1 \\
  \hline
\end{tabular}\\


\section{Organisation des fiches de composants}

Afin de faciliter l’accès aux fiches des composants à tous les utilisateurs, notre projet intègre un page de recherche des fiches composants. A partir de cette page l’utilisateur peut :
\begin{items}{black}{\Triangle}
\item Rechercher la fiche d’un composant à partir soit de sa référence fabricateur soit de sa référence AODE, soit de sa description.
\item Ajouter manuellement une fiche
\item Supprimer manuellement une fiche
\end{items}

L’avantage d’incorporer cette fonctionnalité à notre application est, en plus que d’être plus pratique à recherchée qu’un dossier, que des fiches peuvent êtres rajoutés automatiquement au moment des recherches par API.\\


\begin{tabular}{|p{1.5cm}|p{6cm}|p{6cm}|p{2cm}|}
  \hline
  \bold{N°} & \bold{Tâche} & \bold{Description} & \bold{Nécessite} \\
  \hline
 7-1 & Recherche des fiches à partir de la référence fabriquant ou la description &L’utilisateur peut rechercher une fiche précise à partir de la référence fabricant ou la description du composant & -  \\
 \hline
7-2 & Recherche des fiches à partir de la référence AODE &L’utilisateur peut rechercher une fiche précise à partir de la référence AODE  & 2-1 \\
  \hline
7-3 &Ajout manuel d’une fiche &L’utilisateur peut rajouter une fiche à la BDD manuellement & - \\
  \hline
7-4 & Suppression manuelle d’une fiche & L’utilisateur peut supprimer une fiche de la BDD manuellement & - \\
  \hline
\end{tabular}\\


\section{Utilitaire de gestion des Relances}

Afin de simplifier la gestion des relances, notre projet prévois un petit composant en permettant leur gestion. Le but de se composant est de regarder automatiquement dans la BDD d’X3, et d’envoyer un mail de relance aux fournisseurs n’ayant pas envoyés leur commande dans les temps. Pour cela, nous comptons mettre en place un programme python s’exécutant en continu en arrière-plan sur la machine linux. De plus il nous semblerait intéressant de créer avec cet utilitaire une interface web montrant les relances envoyées récemment. 
\\ \\
\begin{tabular}{|p{1.5cm}|p{6cm}|p{6cm}|p{2cm}|}
  \hline
  \bold{N°} & \bold{Tâche} & \bold{Description} & \bold{Nécessite} \\
  \hline
 8-1 & Déploiement du composant & Le composant doit tourner en permanence en arrière-plan sur la machine linux & 1-1  \\
 \hline
8-2 & Envois de mails &Le composant peut envoyer des mails automatiquement via le serveur SMTP d’AODE & - \\
  \hline
8-3 & Récupération des commandes en retard & Le composant arrive à récupérer les commandes en retard ainsi qu’une adresse mail de contact liée à cette commande & - \\
  \hline
8-4 & Interface WEB & Création d’une interface web liée à ce composant pour permettre aux utilisateurs de tracker les messages envoyés & 8-2 \\
  \hline
\end{tabular}\\

\newcommand{\cl}{client }
\newcommand{\cls}{clients }

\chapter{Introduction}

\section{Principe}

Notre projet consiste en la création d’un logiciel de partage de connaissance sur un ordinateur.\\
L’utilisateur recherche un sujet, par exemple « Le fonctionnement d'un moteur thermique» soit via une recherche par mots clés ou par type, ce qui l’amène à plusieurs supports hébergés sur le serveur.\\
Il lui est donc possible de visionner des supports de cours mais également d'en rédiger avec notre éditeur de support intégré.

\section{L'objectif du Développement Durable}

Notre projet répond à l'objectif du développement durable n°4, "Éducation de Qualité" qui se bat pour : "Assurer l'accès de chacun à une éducation de qualité, sur un pied d'égalité, et promouvoir les possibilités d'apprentissage tout au long de sa vie."

\chapter{Cahier des Charges}

\section{Conventions}

Par souci de clarté, les personnes utilisant notre logiciel seront appelées les \cls \footnote{Référence au type de communication client-serveur} car ces derniers se connectent en réalité à un serveur à distance.

Les documents que les \cls seront amenés à visionner seront appelés des supports.

\section{Les supports}

Un support est écrit par un créateur qui peut être un utilisateur lui-même.\\ Le support contient du texte agrémentés de vidéos ou de photos pour faciliter la compréhension. \\
Les supports seront affichés sous forme de rendu WEB et pourront contenir :

  \begin{items}{red}{\Circle}
    \item Des titres et sous-titres
    \item Des paragraphes
    \item Des listes
    \item Des liens
    \item Des images
    \item Des vidéos youtube
    \item Des équations \LaTeX
 \end{items}
 
 
 %Nous comptons également mettre en place un système de certification afin de spécifier à l’utilisateur que le contenu qu’il regarde a été validé.\\ 
 Il y aura également potentiellement \footnote{Sous réserve que suffisamment de temps soit à notre disposition} un système de notes afin d’augmenter le référencement des supports les mieux notés. 

\section{L'utilisation}

Le logiciel se doit d'être simple d'utilisation pour les clients. Il doit également être intuitif et ergonomique.

Les clients pourront donc : 

  \begin{items}{red}{\Circle}
    \item Consulter les supports publiés par les autres utilisateurs
    \item Rédiger facilement un support de façon textuelle : Un éditeur MarkDown sera intégré au logiciel pour générer les supports avec les instructions MarkDown. Le HTML est également interprété.
    \item Modifier ses supports
    \item Supprimer ses supports
    \item Commenter les supports publiques
 \end{items}


\section{Système de connexion}

Il faut un compte pour publier des supports\footnote{La modification se fait par le propriétaire du document, c'est-à-dire celui qui l'a rédigé} mais aucun compte n'est demandé pour visualiser un support.

\section{Système de téléchargement}

Si un support plaît particulièrement au client, il pourra le télécharger sur sa machine locale afin de visionner le support même avec une absence de réseau Internet.

En local, l'utilisateur peut également rédiger des supports\footnote{Sous réserve de réussir l'utilisation de MathJax en local.}.

\section{Maintenance du projet}

Le code devra être lisible et bien commenté, afin de simplifier sa maintenance.
Une documentation complète des classes rédigées sera disponible au format HTML et \LaTeX


\section{Plateforme}

Notre application devra fonctionner sur un ordinateur desktop Windows ou Linux (et sera en théorie compatible MacOS).


\chapter{Choix techniques}

\section{Bibliothèques}

Notre projet sera basé sur le framework Qt 5.15.2 (LTS) C++, celui-ci étant multi-plateforme.

L'utilisation de ce framework impacte grandement notre projet.

En effet, de nombreuses classes sont alors à notre disposition et le code s'en retrouvera modifié. Par exemple, toutes les classes standards du C++ (ou presque) ont leur équivalent Qt : 
\begin{items}{black}{\Circle}
    \item std::vector<T> devient QVector<T>
    \item std::string<T> devient QString<T>
    \item ...
\end{items} 

Ces types propres au framework doivent être privilégiés lorsque l'on programme avec.

Ainsi, dans notre diagramme UML ou dans notre code, il ne sera pas rare de voir des classes dont le nom commence par la lettre "Q" en Majuscule, cela signifie qu'il s'agit d'une classe du framework Qt.

\section{Les serveurs}

Le serveur distant hébergera un service : 
  \begin{items}{red}{\Circle}
    \item Le serveur MySql (base de données)
 \end{items}

Le serveur sera donc accessible à distance 24h/24 afin que les clients puissent utiliser le logiciel quand ils le souhaitent.\\
Une utilisation du logiciel en local\footnote{Absence de connexion Internet} sera détaillée dans la partie locale.

\subsection{Le serveur MySql}

Une base de données MySql\footnote{Sous licence libre} sera utilisé sur le serveur afin de stocker les informations nécessaires au bon fonctionnement du logiciel.\\

Ce serveur permet de stocker l'intégralité des supports accessibles par les clients.\\
Lorsqu'un client souhaite donc visionner un support, le logiciel devra d'abord télécharger le support sur la machine du client. \\
Ensuite, l'affichage est généré et le client peut visionner le support.


\subsubsection{Compression des données}

Un support devra être transportable du serveur au client sous forme de fichier compressé. Ce fichier contient toutes les informations nécessaires au bon affichage du support.

Étant donné que le client peut modifier ou consulter des supports, l'envoi des fichiers compressés sera multi-directionnel.

C'est le logiciel qui se chargera de compresser les fichiers qu'il reçoit et qu'il envoit.


\section{Ajout de formules en \LaTeX}

Lors de l'édition des supports, les formules \LaTeX sont intégrées entres deux balises \$\$.


\chapter{Choix graphiques}

\section{Interface}

L'interface est décomposable en trois parties principales :

\begin{items}{blue}{\Triangle}
\item La barre de menu propre aux propriétés de la fenêtre. Il comprendra des sous-menus : 
 \begin{items}{orange}{\Circle}
    \item Fichier
    \item Éditions
    \item Fenêtre
    \item Aide
 \end{items}
 
 \item Le menu de navigation latérale de l'application. Il est accessible via l'appui sur un bouton et il est possible de le rétracter par l'appui sur ce même bouton.
 \item La fenêtre de navigation qui contiendra, à tour de rôle et sur demande : 
  \begin{items}{orange}{\Circle}
    \item l'accueil avec une liste de vidéo
    \item L'affichage des supports
    \item Les informations sur le compte client
    \item les paramètres
 \end{items}
 
 \item Une barre de statut
 \item Une barre de recherche permanente
\end{items}

La page suivante contient une proposition d'interface.

A déplacer
Les informations sur le compte client :
Nom
Cours fait par la personne + nombre de cours
Nombre de likes par cours et totale
Possibilité de modifier les cours de l'utilisateur

\section{Améliorations}


\begin{items}{red}{\Triangle}
\item Gestion des dates ->  agenda ++
\item Ajout de thèmes
\item Ajout d'un système de notation
\item Ajout d'un système de miniature pour les supports
\end{items}



\imgr{\rootImages/interface.png}{Interface}{0.7}{0}




\chapter{Tables SQL}

\section{Contenu des tables}

\begin{items}{red}{\Triangle}

\item Voici une projection de la table "Files"\footnote{Table contenant l'ensemble des supports}

\begin{items}{blue}{\Triangle}
\item \integer{ID}  : L'identifiant du support
\item \str{TITLE}  : Le titre du support
\item \str{OWNER}  : Le nom du propriétaire
\item \str{FILENAME}  : Le nom du fichier (et son emplacement) contenant le support
\item \str{FILE}  : Le contenu du fichier compressé
\item \str{IMAGE}  : Le nom de l'image (et son emplacement) contenant l'image miniature
\item \integer{LEVEL} : Le niveau de difficulté
\item \Date{DATE} : Dernière date de modification
\item \integer{LIKE} : Nombre de J'aime sur le support
\item \str{DESCRIPTION}  :Brève description du support
\end{items}
\item Voici une projection de la table "Users"\footnote{Table contenant l'ensemble des utilisateurs}

\begin{items}{blue}{\Triangle}

\item \integer{ID}  : L'identifiant du client (ordre de création de compte)
\item \str{LAST\_NAME}  : Le nom du client
\item \str{FIRST\_NAME}  : Le prénom du client
\item \str{MAIL}  : L'adresse mail du client
\item \str{LOGIN}  : L'identifiant de connexion du client
\item \str{PASSWORD}  : Le mot de passe du client (crypté)
\item \str{PHONE} : Numéro de téléphone
\end{items}

\end{items}



\newpage

\chapter{Modélisations UML}

\section{Scénarios}

\subsubsection{Scénario nominal : Consulter un cours}
    \begin{enumerate}
    
        \item L'utilisateur souhaite consulter un cours. Il n'a pas besoin de se connecter, il lui suffit de saisir un nom de cours dans la barre de recherche.
        \item Il valide sa recherche et la liste des supports \footnote{Recherche par mot-clés} apparaît.
        \item L'utilisateur valide le support qu'il souhaite consulter et le support complet se télécharge sur la machine client.
        \item L'utilisateur peut consulter le support à volonté.
        
    \end{enumerate}


\subsubsection{Scénarios alternatifs : Créer un support}
    
    \begin{enumerate}

        \item L'utilisateur souhaite créer un cours. Il a besoin de se connecter au serveur.
        \item Une fois l'identifiant et le mot de passe saisi, une requête est envoyé au serveur pour valider l'authentification.
        \item Une fois connecté, l'utilisateur peut éditer un cours en saisissant du code Markdown et des balises HTML.
        \item L'utilisateur valide ses modifications.
        
        %\img{}{}{}{} Exemple image code
    \end{enumerate}
        
\subsubsection{Scénarios alternatifs : Modifier  un support}

    \begin{enumerate}
        
        \item L'utilisateur souhaite modifier une de ses publications. Il a besoin de se connecter au serveur.
        \item Une fois l'identifiant et le mot de passe saisi, une requête est envoyé au serveur pour valider l'authentification.
        \item L'utilisateur modifie le code Markdown ou HTML qu'il a saisi lors de la création de son support.
        \item L'utilisateur valide ses modifications.
\end{enumerate}

\subsubsection{Scénarios d'erreur : Problème d'authentification}

    \begin{enumerate}
        \item Code d'identification erroné
        \item Retour au scénario alternatif courant(étape 1)
\end{enumerate}

\subsubsection{Scénarios d'erreur : Absence de connexion internet}

    \begin{enumerate}
        \item Téléchargement des supports impossibles
        \item Consultation des supports déjà téléchargés 
        \item Attente de réseau Internet
\end{enumerate}

\newpage

\section{Diagramme de cas d'utilisation}

\img{\rootImages/cas_d_utilisation.png}{Cas d'utilisation}{1}


\section{Diagramme d'activité}

\imgr{\rootImages/activite.png}{Diagramme d'activité}{0.80}{-90}

\section{Diagramme de classes}

\imgr{\rootImages/classes.png}{Diagramme d'activité}{0.306}{-90}

%\chapter{ne pas compiler}


%Barre de chargement quand on scroll l'écran
%stylesheet foc doxygen
%interpréter latex en markdown avec dollars simple.
%javascript local


\chapter{Présentation finale}

\begin{items}{black}{\Bullet}
\item Présentation de la vidéo

5 min de vidéo : 

- Mode pub : 

- Une utilisation simple et intuitive MAIS des fonctionnalités poussées : 

- Un éditeur Markdown/HTML
- Gestion des vidéos, images et documents PDF
- Un accès sécurisé à tout moment
- Une utilisation possible sans réseau via la possibilité de télécharger le contenu qui VOUS intéresse.
- Une visualisation des cours par catégorie
- La possibilité d'apprendre de nouvelle chose via l'onglet tendances.
- et un classement de qualité fait par les utilisateur
- Gestion de vos paramètres personnels


Notre projet consiste donc en la création d’un logiciel de partage de connaissance sur un ordinateur.\\
L’utilisateur recherche un sujet, par exemple « Le fonctionnement d'un moteur thermique» soit via une recherche par mots clés ou par type, ce qui l’amène à plusieurs supports hébergés sur le serveur.\\
Il lui est donc possible de visionner des supports de cours mais également d'en rédiger avec notre éditeur de support intégré.

\item Introduction et contexte du projet : (1min10)

Dans notre groupe de projet nous sommes un groupe de quatre étudiants. Il y a Mathieu Charles, Nicolas Le Guerroué, Théo Mainguené et Romain Possémé. 

Dans le cadre du projet de CPO nous avions tous à coeur de faire un projet en lien avec l'éducation, car nous avons constaté un réel besoin de créer quelque chose qui permette de rassembler des connaissances. Notre projet est donc en lien avec l'Objectif de Développement Durable numéro 4 ; à savoir une "Éducation de Qualité" dont l'objectif est "Assurer l'accès de chacun à une éducation de qualité, sur un pied d'égalité, et promouvoir les possibilités d'apprentissage tout au long de sa vie."
Nous sommes parti du principe que le partage des connaissances fait que l'on progresse mieux dans l'apprentissage. C'est pour cela que nous avons voulu créer un logiciel permettant aux étudiants de rédiger s'ils le souhaitent des sortes de cours ou bien directement des fiches résumés. 

Nous avons souhaité faire un logiciel non seulement simple pour récupérer des documents et cours mais aussi avec une partie rédaction de cours/tutoriel qui est grandement simplifiée par l'éditeur MarkDown.
Ce langage est simple d'utilisation, plus rapide à prendre en main que le HTML. Cependant, le balisage HTML est supporté.

\item Vidéo de présentation


\item Présentation de Qt et choix des bibliothèques

Qt est une plateforme de développement d’interfaces graphiques GUI.\\

Qt fournit un ensemble de classes décrivant des éléments graphiques (widgets) et des éléments non graphiques : accès aux données (fichier, base de données), connexions réseaux …\\

Qt permet la portabilité des applications (Linux,Windows,mac Os).\\
Les widgets peuvent être utilisés pour créer ses propres fenêtres et boîtes de dialogue complètement prédéfinies (ouverture/enregistrement de fichiers, progression d’opération, etc). \\

\img{\rootImages/ui.png}{Une interface graphique}{0.4}

Les interactions avec l’utilisateur sont gérées par un mécanisme appelé signal/slot. Ce mécanisme est la base de la programmation événementielle des applications basées sur Qt.

Exemple : Fonction pb\_clicked qui renvoie a une action de l’utilisateur

Le programme sera principalement défini par ses réactions aux différents événements qui peuvent se produire

\img{\rootImages/all.png}{Arborescence du projet}{0.4}


\item Fonctionnement global comment les fenêtres interagissent entre elles

Le fonctionnement global de notre application est simple, nous avons une classe mainwindow qui gère notre affichage principal, c’est la fenêtre qui se charge quand on lance le code.

image point de vu utilisateur et point de vu ui

Comme on peut le voir cette fenêtre est composé de deux éléments, qui sont en réalité des contenants, des QstackedWidget. La particularité de ce contenant c’est qu’il fournis une zone graphique sous forme de page, on peut donc créer une page dédiée à la connexion puis une page pour l’affichage des cours et jongler entre ces pages via le code de notre classe principale.
Le premier avantage de cette méthode est que l’on peut créer autant de page que l'on veut et donc de fonctionnalité que l’on veut. La deuxième force est que chaque page peut hériter d’une classe et donc d’une partie graphique complexe, cela facilite le codage et permet d’avoir de nombreuses fonctionnalités compactes d’un point de vue graphique.



\newpage
\section{Présentation graphique -> Fonctionnement de l'interface} (1m50)

Pour la partie graphique, il y a trois types de fichiers : le fichier "source", le fichier d'en-tête "header" et le fichier "forms" qui correspond à l'interface graphique.\\

Le principe est le même que pour les fichiers "Headers" et "Sources", il y un fichier Main qui est appelé à la compilation. Le fichier "Mainwindow.ui" contient une grande fenêtre de la classe QMainWindow dans laquelle on a plusieurs petites fenêtres et éléments graphiques que l'on appelle des Widgets. Ces petites fenêtres sont ensuite designer de manière graphique. \\
Il y a tout en tas d'éléments graphiques que l'on peut insérer (Cf photo).\\
Les widgets que l'on a le plus utilisé dans notre projet sont les QPushButton pour valider une information, les QLabel pour afficher le texte, QLineEdit pour écrire du texte.\\

Ensuite pour une utilité à ces widgets, il est nécessaire de lier ceci à une action. C'est ce que l'on appelle le principe de signaux/slots.\\
Par analogie, le principe de signaux/slots correspond aux interruptions. Dès qu'un évènement est capté, une fonction que l'on aura définie et qui lui sera liée sera appelée.\\

Nous avons placé graphiquement avec le logiciel QtDesigner des widgets mais nous en avons également généré une bonne partie de manière dynamique. C'est-à-dire qu'ils ont été généré via une ligne de code.\\

Nous avons créer nos propre Widgets personnalisés lié a une classe, par exemple la classe userprofile, connectionwindow ou encore foldablemenubar, qui contiennent eux même un ensemble de widgets.\\
Dans notre affichage principal, le mainwindow hérite de ces classes.\\ 
Via des accesseurs et des mutateurs les boutons liés aux signaux et slots de la mainwindow sont insérer via pointeur dans nos classes peronnalisés. Ces boutons constituent donc le lien entre notre mainwindow et nos classes personnalisé.\\



\section{Problème rencontré}

Nous avons rencontré quelque problème au cours de ce projet. Majoritairement des problèmes liés aux classes très spécifique de Qt, en effet dans notre projet nous utilisons des classes afin de simplifier la représentation graphique de nos éléments or il arrive que ces éléments soient compliqués à gérer. Par exemple nous sommes restés assez longtemps bloqué sur un problème de layout qui ne s’était pas complètement vide et qui donc empêchait toute réécriture. Il y a eu également des problèmes quant à l’encapsulation de notre code, en effet certains éléments avaient besoin d’être déclarés dans la mainWindow mais étaient lié à une classe dont héritait notre MainWindow.


\section{Base de données}

Pour sauvegarder l'ensemble des données du logiciel, nous avons fait le choix de stocker les informations dans une base de données distante : Une BDD basée sur MySql est hébergé sur un serveur personnel et permet d'accéder aux données à n'importe quel moment et pour tous les utilisateurs.

Après avoir essayé de compiler les drivers MySql sous Windows (6 h sans succès, on a essayé différentes bases de données (SQLite, PostgreSQl), nous sommes tous passé sous Linux pour compiler le projet.


Après avoir ouvert le port de connexion (5000) sur le serveur, il a fallu coder la classe DBManager qui permet de faire des requêtes SQL protégées contre les injections SQL. (Pour cela, on utilise des requêtes préparée). 
Avec DBmanager, on est capable de faire les requêtes classique (création, suppression des tables, des bases. 

L'utilisation de la bdd sous Qt repose sur le système de modèle. En faisant une requête, on met à jour le modèle et il ne nous reste plus qu'à manipuler ce modèle pour extraire les données?\\


Nous avons fait le choix de sauvegarder les fichiers contenant les cours sous format binaire sur la bdd afin de centraliser les infos.\\
A court terme, cette solution semble assez pratique mais la consultation des données est ralenti.\\
A long terme, il est souhaitable de passer par un serveur SFTP mais après de nombreuses tentatives sous Qt pour se connecter à ce serveur, nous avons choisi la solution de sauvegarde des données sous SQL.\\

Dans les soucis rencontrés sous SQl, il a fallu augmenter la capacité maximale du fichier binaire à insérer dans la base de données.\\

Lorsqu’un client souhaite donc visionner un support, le logiciel devra d’abord télécharger le support distant sur la machine du client.

Toutes les infos sur le cours sont contenu dans le fichier ZIP correspondant, ce dernier ayant un fichier de méta données propre.


Enfin, pour visualiser les données sur le serveur, une interface Web a été mise en place sur le serveur distant pour que tous le monde puisse consulter la base de données.\\

En ce qui concerne les points d'amélioration, le premier serait de chiffrer les mots de passe contenus dans la BDD. Cependant, par manque de temps, cela n'a pas été fait.



\section{Rapport personnel Nicolas}

En plus d'un enrichissement des connaissances sur Qt, ce projet m'aura permis de prendre en main l'outil Git qui s'est avéré très utile.\\

Le choix de faire un projet à plusieurs est un format nouveau et bienvenu 
par rapport aux anciens projets Informatique lors des derniers semestres.

Ce projet a pu conforter mes acquis en base de données et m'a permis de mettre en place un serveur SQL distant avec une interface Web conçue pour visualiser la base de données. \\

J'ai éprouvé plus de difficulté à faire le lien entre les différentes parties graphiques car nous avons choisi de faire des Widgets personnalisés.\\

Je trouve dommage que autant d'heures passés sur ce projet soit si peu valorisées.\\
De plus, je trouve que passer une période pour l'UML est trop long, sachant que personnellement, je n'ai pas tenu compte des diagrammes UML.\\





\item Description de chaque classe

\begin{items}{black}{\Triangle}

\item Base de données

\begin{items}{black}{\Bullet}

\item DBElement : représente un élement de la base de données
\item DBFilter : représente un filtre de sélection de données
\item DBManager : permet de gérer la connexion à la base de données ainsi que la récupération et l'envoi de données depuis la base de données 
\item LocalManager : Gestion des fichiers téléchargés en local
\end{items}

\item Fenetres graphiques

\begin{items}{black}{\Bullet}

\item ConnectionWindow : Gère la connexion d'un utilisateur pour éditer des cours
\item FoldableMenuBar : Gère le menu latéral gauche
\item HomeWindow : Affiche la page principale
\item Settings : Gére la page des paramètres utilisateurs
\item UserWindow : Affiche les cours de l'utilisateur
\end{items}


\item Editeur markdown

\begin{items}{black}{\Bullet}
\item MarkDwonDocument : Gère un document markdown
\item markDownEditor : permet d'éditer un document markdown
\item MarkDownPage : ?
\item MarkDownPreview : Affiche un document markdown
\end{items}

\item Cours

\begin{items}{black}{\Bullet}
\item Course : Gère un cours
\item CourseInfo : Gestion des métadonnées du cours
\end{items}

\item Utilisateur

\begin{items}{black}{\Bullet}
\item UserProfile : Gère un utilisateur
\end{items}

\end{items}

\end {items}\chapter{Introduction}
Les robots sont de plus en plus présents dans notre quotidien sous différentes formes. Ils existent sous forme de machine, d'objet ou bien sous forme humanoïde. 
Leur importance se démontre dans de nombreux domaines tels que l'éducation, la santé, le travail, etc... \\
Leur rôle est d'aider l'humain dans une tâche, que ce soit pour apprendre, travailler ou accomplir diverses tâches.  La tendance va vers un monde dans lequel on ne peut pas se passer des robots. \\

Dans le cadre de ce cours nous nous sommes consacrés à la conception d'un robot facilitant aux déplacements des personnes à mobilités réduites. Le domaine de la santé et de l'aide à la personne nous tient beaucoup à coeur de par son importance. \\

Ainsi, nous avons essayé de s'imaginer à la place d'une personne rencontrant des difficultés à se déplacer afin de comprendre les difficultés qu'elle peut rencontrer. Le contexte dans lequel le robot va évoluer est très important à prendre en compte car il est lié à de nombreuses contraintes. 

L'objectif de ce rapport est de présenter le travail que nous avons fait pour répondre à la problématique suivante : \\

\bi{Dans quelle mesure un robot peut-il faciliter le déplacement d'une personne à mobilité réduite pour effectuer des tâches du quotidien ?}

 %\img{\rootImages/header.png}{Notre projet}{0.05}


\chapter{Solution proposée}

Cette section détaille les solutions techniques pour mener à bien le projet.\\

Nous avons pensé à développer une solution permettant aux personnes à mobilités réduites (personnes âgées, personnes en situation d'obésité, personnes malades, personnes en fauteuil roulant,...) de se déplacer ou de faire déplacer un robot sur des distances relativement courtes. \\
L'objectif est de minimiser les efforts à faire pour se déplacer et de rendre le système intuitif. En effet, notre solution se doit d'être simple d'utilisation et sans risque pour l'utilisateur. Ainsi, lors de la conception de notre robot nous avons imaginé des sécurités évitant au maximum le risque d'incident. \\

Afin de répondre au mieux à la problématique et de prendre en compte les contraintes liées au contexte nous avons imaginé une solution. \\

Notre système est un robot qui se commande à distance avec un gant permettant de le contrôler.
Nous avons conçu un système sans fil car il évite le risque pour la personne de se prendre les pieds dedans. De plus, le gant permettant le pilotage se veut léger et ergonomique. Le but est que la personne se sente à l'aise et produise le moins d'effort possible. \\

\img{\rootImages/header.png}{Le rover et le gant avec le module de contrôle}{0.05}



\section{Principe d'utilisation}

L'utilisateur enfile un gant comprenant un capteur qui mesure l'inclinaison de sa main suivant trois axes. Pour notre cas on utilisera seulement deux axes, celui correspondant à l'angle de tangage permettant de tourner à droite et à gauche ainsi que l'angle de roulis pour avancer ou reculer. \\

Sur ce gant il y a un module permettant de communiquer avec le robot pour le contrôler à distance.
Il y a donc un émetteur situé sur le gant et un récepteur sur le robot.
Les deux doivent être autonomes en énergie donc ils possèdent chacun une batterie. \\

Le robot quant à lui est constitué de quatre moteurs. Pour le faire avancer nous pilotons les moteurs via une carte Arduino. Cette carte récupère les informations transmises par le module de communication venant du gant. \\

Ainsi, lorsque l'utilisateur incline sa main vers l'avant le robot avance en faisant tourner les quatre roues dans le sens horaire. Pour faire reculer le robot c'est l'inverse.
Pour faire tourner le robot, l'utilisateur doit incliner sa main dans un sens. Cela a pour effet de faire tourner les deux roues de gauche dans le sens inverse de celles de droite. \\

Enfin, lorsque l'utilisateur incline sa main vers l'avant et sur un coté, le robot se déplace en avant en se décalant légèrement sur le coté concerné (trajectoire plus diagonale).

\section{La communication sans fil}

Nous avons opté pour un module de communication sans fil afin de faire transiter les informations de la position de la main au module gérant le moteur pour éviter d'utiliser un câble.\\
Plusieurs technologies étaient disponibles telles que :

\begin{items}{blue}{\Triangle}
    \item Les modules Bluetooth (Crius, HC-05, HC-06)
    \item Les modules radio 433 MHz
    \item Les modules radio 2.4 GHz (Xbee, ESP-02…)
\end{items}


Nous avons refusé les modules Bluetooth car ils sont plus appropriés pour des applications avec un téléphone (phase d'appairage). Il nous restait donc les modules radios, il fallait donc choisir les fréquences de fonctionnement.\\

Les modules radio à 433 MHz possèdent moins de fonctionnalités, nous avons opté pour utiliser un module Xbee. L’UQAC en possède, cela nous a permis de commencer rapidement le projet sans attendre une livraison de matériel.\\

 \img{\rootImages/xbee.png}{Un module Xbee}{0.5}
 
Le module Xbee est un module de communication 2.4 GHz. Il se base sur une liaison série.
Après avoir configuré le module avec le logiciel \lib{XCTU}, il suffit d’envoyer les données sur la broche Rx du module afin qu’il envoie les données à l’autre module.\\
Le mode API du module n’est pas activé afin qu’il communique avec un module ayant une adresse spécifique (on souhaite éviter une diffusion de type broadcast afin de ne pas interférer avec d’autres modules présents dans la salle).\\

La configuration des modules Xbee est détaillée en annexe à la section  \link{\ref{xbee}}

\section{Le positionnement de la main}

Pour récupérer la position dans l’espace de la main, nous avons opté pour un accéléromètre comportant un compas et magnétomètre. Il s'agit d'une centrale IMU \footnote{Inertial Measurement Unit} 9 axes, chaque grandeur est disponible sur l'axe x, y et z.\\

 \img{\rootImages/imu.jpg}{Les axes de la centrale IMU}{0.5}
 
Cette solution permet de réduire l'encombrement car les modules présents à l'UQAC sont de petites tailles et peuvent s'intégrer sur un gant.\\

Afin d'obtenir la position dans l'espace, nous récupérons les valeurs des accélérations, des vitesses angulaires et des valeurs du champ magnétique terrestre sur les 3 axes. \\
Ensuite, en utilisant l’algorithme de Mahony (ou bien celui de Madgwick) et en nous basant sur les quaternions, nous pouvons déterminer la position angulaire dans l'espace à condition d'échantillonner suffisamment vite \footnote{L'algorithme de Mahony compense l'erreur avec un correcteur PI contrairement à l'algorithme de Madgwick. Il faut donc réduire le temps d'échantillonage pour avoir une intégration plus précise.} (moins de 50 ms entre deux lectures) et cela nous permet d'avoir une résolution de moins d’un degré, ce qui est largement suffisant pour notre projet.\\

Dans le cadre de ce projet, nous avons utilisé le module \bold{MPU9250}

 \img{\rootImages/mpu.jpg}{Un module MPU9250}{0.5}
 
 Le capteur communique en I2C \footnote{Inter Integrated Circuit}.\\
C'est un bus série synchrone bidirectionnel half-duplex avec 2 broches utilisées pour communiquer :
\begin{items}{green}{\Triangle}
    \item SDA : Serial Data (ligne de données) \index{SDA}
    \item SCL : Serial Clock (ligne d'horloge) \index{SCL}
\end{items}

Une masse est commune aux périphériques.\\

Les échanges ont toujours lieu entre un seul maître et un (ou tous les) esclave(s), toujours à l’initiative du maître \footnote{Jamais de maître à maître ou d’esclave à esclave, cependant, rien n’empêche un composant de passer du statut de maître à esclave et réciproquement} et pour éviter les conflits électriques les broches SDA et SCL sont de type \bold{Collecteur Ouvert}.\\ 
Il faut donc ajouter des résistances de tirage mais ces dernières sont généralement intégrées, comme dans notre cas.

A chaque composant est attribué une adresse physique qui permettra les échanges. L'adresse de notre capteur vaut \bold{0x68}. Cette adresse est codée sur 7 bits, ce qui fait que le bus I2C peut supporter en théorie 127 périphériques \footnote{en  réalité moins car il faut tenir compte de la capacité de ligne}.\\

\subsubsection{Précision du module}

Afin de gagner en précision, nous calibrons le capteur avant de lancer un cycle. \\Il existe bien une fonction de calibration pour le capteur mais l'intégration et la proportionnelle du correcteur engendre un dépassement sur les premières acquisitions. 

La figure suivante représente l'allure des valeurs du roulis sur les premiers échantillonnages du gyroscope lorsque ce dernier possède un roulis réel de $0^{\circ}$. La fréquence d'échantillonage est de 1 kHz.

\begin{graphicFigure}{0.6}{0.6}{-100}{1000}{-1}{35}{Échantillons}{Angle de roulis($\circ)$}{Le régime transitoire du gyroscope}
    \addTrace{red}{0}{1000}{32*(exp(-x/200)+0.01*sin(1*x)}
    \addTrace{blue}{0}{1000}{0}
    \addLegend{Angle mesuré ($^\circ$), Angle réel ($^\circ$)}
\end{graphicFigure}

Afin d'éviter ce régime transitoire, nous faisons une salve de mesures pour revenir au régime permanent \footnote{A condition que le capteur ne bouge pas} puis nous lisons les valeurs sur un nombre d'échantillons afin de déterminer les angles au repos. \\

\bold{Cette phase de calibration permet à l'utilisateur de choisir la position au repos du gant, cela évite qu'il soit forcément calibré à l'horizontal.}\\

Pour cela, lors du démarrage de l'émetteur, nous envoyons au robot un mot clé afin que le robot joue une musique pendant la calibration. Il ne faut pas bouger le capteur de position car cela fausserait les commandes. \\

Enfin, pour améliorer la précision du capteur, nous avons modifié l'offset du compas en tenant compte de la déclinaison magnétique qui est de 15 ° environ à Chicoutimi \cite{mag}.


\section{Le contrôle du robot}


\subsection{La lecture des données}
Une fois que le robot lit les données en provenance du Xbee, il doit décoder la trame reçue. Cette dernière est au format suivant : \\

Trame = "\bold{XXXX}"\\

Chaque "X" prend la valeur \bold{0} ou \bold{1} et représente respectivement l'ordre d'activation pour :

\begin{items}{blue}{\Bullet}
    \item Tourner à gauche
    \item Tourner à droite
    \item Avancer
    \item Reculer
\end{items}


Ainsi, si le robot reçoit la trame \bold{0010}, il va avancer.

\subsection{Le contrôle des moteurs}

La vitesse du robot est contrôlable en modifiant la vitesse et le sens de rotation des moteurs droits et gauches. Il nous faut donc 2 broches de signal pour contrôler le robot.\\

Ce contrôle se fait via un signal PWM\footnote{Pulse Widht Modulation}. 
La figure suivante représente le sens de rotation et la vitesse d'un bloc moteur (gauche ou droit). L'axe des ordonnées représente la vitesse en \% en fonction de la valeur du rapport cyclique envoyé au moteur. Cette valeur est comprise entre 0 et 255.
Si la valeur de vitesse est positive, le moteur tourne dans un premier sens et si elle est négative, le moteur tourne dans l'autre sens.

\label{moteur}
\begin{graphicFigure}{0.6}{0.6}{-1}{256}{-100}{100}{Ordre de vitesse}{Vitesse (\%)}{Commande des moteurs}
    \addPoints{blue}{(0, 30) (100,30) (100, -100) (180, 0) (255, 100)}
     \addPoints{green}{(0, 0) (255,0)}
     \addLegend{Vitesse du moteur, Vitesse nulle}
\end{graphicFigure}

Aussi, si nous souhaitons faire avancer le robot à la vitesse maximal, nous envoyons la valeur \bold{255} sur le bloc gauche et droit. \\
Si nous souhaitons faire tourner le robot à vitesse faible, nous pouvons envoyer la valeur \bold{170} sur le bloc droit et \bold{190} sur le bloc gauche.\footnote{La valeur de repos est de 180}

\section{Les mesures de sécurité}

Afin de rendre plus sûr le robot et son utilisation, nous avons mis en place des mesures de sécurité sur plusieurs niveaux.
Tout d'abord, nous avons fait en sorte que le robot puisse se déplacer \bold{uniquement} si l'utilisateur calibre le module de positionnement (MPU9250). La condition de calibration est validée si l'utilisateur entend la musique sur le robot.\\

Une autre sécurité ajoutée est l'arrêt du robot lorsque la connexion entre les 2 Xbee n'est plus assurée.
Nous avons crée une fonction de lecture qui attend de recevoir des données sur le port série. En revanche, une variable interne fixe un \bold{timeout} maximal au dessus du quel la fonction de lecture renvoie une chaîne de caractère vide. Une chaîne de caractère vide signifie donc une perte de connexion.\\
Le code suivant permet de gérer la perte de connexion du module : 

\begin{Cpp}
  String message = xBee.read(WAIT_DATA);  
  if(message.length()==0)
  {
    Serial.println(">>> Xbee disconnected");
    rover.stop();
  }
\end{Cpp}

Nous envoyons des données au robot toutes les 5 ms et nous avons fixé un \italic{timeout} de 200 ms.\\

Ensuite, le robot ne peut avancer que si il n'a pas d'obstacle trop proche de lui sur sa route.\\
Différentes technologies sont utilisées pour mesurer une distance, cependant elles possèdent leurs avantages et inconvénients. Nous allons dresser les principaux avantages et inconvénients puis nous pourrons déterminer la technologie.

\begin{items}{blue}{\Circle}
    \item Infrarouge
    \begin{items}{green}{\Circle}
        \item Bon marché
        \item Assez précis
    \end{items}
    \begin{items}{red}{\Circle}
        \item Non-linéaire
        \item Sensibilité à la lumière ambiante
        \item Dépend du coefficient de réflexion lumineuse de la surface en face du capteur
    \end{items}

    \item Laser
    \begin{items}{green}{\Circle}
        \item Très précis
        \item Longue distance
    \end{items}
    \begin{items}{red}{\Circle}
        \item Prix
    \end{items}

    \item Ultra-sonore
    \begin{items}{green}{\Circle}
        \item Prix
        \item Ne dépend pas de la couleur de la surface en face du capteur
    \end{items}
    \begin{items}{red}{\Circle}
        \item Précision parfois arbitraire
    \end{items}
\end{items}

Ayant besoin de précision et une distance de mesure assez précise, nous allons opter pour une technologie laser.
Le module choisi est un LiDAR (Light Detection And Ranging).\\

Le LiDAR est composé d'un émetteur et d'un récepteur. L'émetteur envoie une impulsion laser et celle-ci est réfléchie contre une paroi (obstacle) pour être captée par le récepteur. Étant donné que l'on connaît la vitesse de la lumière qui correspond à la vitesse à laquelle se déplace le faisceau lumineux, nous pouvons en déduire la distance de l'obstacle en mesurant le temps mis par le faisceau émis par le laser pour faire l'aller retour. 



\section{Liste du matériel}

\begin{items}{green}{\faLeaf}
    \item Un robot Rover avec les moteurs, les drivers et la batterie
    
     \img{\rootImages/rover.png}{Le rover}{0.3}
     
    \item 2 modules Xbee
    \item Un accéléromètre MPU9250
    \item 1 carte Arduino Duemilanove (partie robot)
    \item 1 carte Arduino Pro Mini pour l'émetteur
    \item 1 module FTDI pour programmer la carte Pro Mini
    \item 1 batterie pour le circuit émetteur 
    \item 2 shields pour les Xbee
    \item 1 capteur de distance LiDAR
\end{items}

\section{Organisation du code}

Nous avons choisi d'utiliser un seul fichier qui gère le code les 2 cartes Arduino. Le code approprié est sélectionné avec la directive de pré-compilation \bold{\#define}.

Une approche orientée objet a été choisie car cela permet de rendre plus souple le code en cas d'ajout de fonctionnalités (on ajoute des "modules" au robot).\\

Ainsi, par exemple, nous créons des instances des différentes classes afin de les manipuler par la suite.
\begin{Cpp}

  //Xbee
  UART xBee = UART(RX_XBEE, TX_XBEE);
  //Gyro
  
  #define SAMPLING_PERIOD_MS 100
  Gyro gyroscop = Gyro(ADDRESS_GYRO);   //New instance of Gyro class, provides tools to read gyro
  
  //Led
  #define PIN_LED 13
  LED led = LED(PIN_LED);    
\end{Cpp}


La figure suivante détaille les classes utilisées en fonction du code émetteur ou récepteur. \\
Les classes rouges concernent le positionnement de la main et les classes bleues l'envoi et la réception des données.\\

 \img{\rootImages/call.png}{Les différentes classes du projet}{0.5}
 
 Le code principal du programme est disponible en annexe à la section \ref{code}


\section{Schéma électrique du circuit émetteur}

    \img{\rootImages/sender.png}{Le branchement du circuit émetteur}{0.5}
    
    Pour l'émetteur, nous avons donc un module Xbee, une centrale IMU et une carte Arduino. Une batterie est intégrée au gant pour rendre le système autonome.
    
\section{Schéma électrique du circuit récepteur}

    \img{\rootImages/receiver.png}{Le branchement du circuit receveur}{0.5}
    
    Sur ce schéma, la partie de contrôle des moteurs est simulée par 2 transistors MOSFET.



\chapter{Discussions}


Nous avons pu expérimenter les algorithmes de Mahony et Madgwick afin de comparer leurs performances\cite{algo}. Lors d'échantillonnages à hautes fréquences, les 2 algorithmes semblent similaires \footnote{Pas de différences de performances évidentes}. En revanche lors d'échantillonnages à faibles fréquences (<20 Hz), l'algorithme de Mahony n'est plus adapté car la dérive est trop importante (>$50^{\circ}$).\\

Ensuite, lors de la calibration du capteur, nous avons remarqué que mettre une musique pendant la phase de calibration n'est pas la meilleure idée. En effet, nous étions tenté de danser sur l'aire de la musique. Or, il ne faut pas bouger la main pendant la calibration.\\

Lors des essais dans les couloirs, l'envoi et la réception des données était étrange dans la mesure où lors des essais en laboratoire, le comportement du robot était normal et dès que nous sortions dans les couloirs, il se comportait de manière imprévisible. Les commandes de direction n'étaient pas reçues par le robot.\\
Nous avons donc ajouté des outils de débugage dans le code mais malgré ces derniers, il nous a été impossible de distinguer la ou les causes des comportements étranges.\\

Nous aurions bien aimé faire avancer le robot avec une vitesse proportionnelle à l'inclinaison de la main. Le problème pour mettre en place cette idée ne venait pas de l'accéléromètre (précision inférieure au degré) mais bien de la courbe de réponse du moteur.En effet, la réponse du moteur (cf section \ref{moteur}) a été tracée à vide et la vitesse n'est plus proportionnelle sur la phase [100-255]. Nous avons donc abandonné cette idée. \\
De plus, parmi les grandes étapes du projet (gyroscope, Xbee, moteur), la phase de contrôle du moteur a été la plus compliquée car le comportement du robot était parfois étrange. Nous avons vu que le robot était en mode \italic{Contrôle PWM} façon engin radio commandé, c'est à dire que l'un des signal contrôle la vitesse du Rover (avancer ou reculer ) et le second signal contrôle le différentiel de la vitesse des roues. Si le différentiel est nul, le Rover avance dans une direction et si le différentiel est maximal, le coté droit sera en opposition de phase par rapport au coté gauche et le robot fera demi-tour sur place.\\

Enfin, nous aurions pu ajouter une fonctionnalité pour arrêter le robot en tapant sur la main. Cela aurait permit d'ajouter une sécurité pour éviter que le robot ne se déplace de manière imprévue.
Il aurait aussi été possible d'arrêter le robot en retournant la main.




\chapter{Conclusion}

Nous avons vraiment apprécié la réalisation de ce projet car il était très plaisant et intéressant à faire. La conception de ce projet a nécessité une petite phase de réflexion pour décider des meilleurs choix techniques. Cette phase était très intéressante car nous avons pu discuter des meilleures technologies à utiliser. 
Ensuite, nous sommes passés à la réalisation du projet. Nous avons rencontrés quelques difficultés notamment liés à des problèmes d'interférences qui perturbait les communications entre le robot et le gant. 
Étant donné que nous avons réussi à le faire fonctionner assez vite, nous avons pu lui rajouter des fonctionnalités.
Cependant, la partie du début du cours sur l'asservissement n'a pas été utile à ce projet.\chapter{Annexes}

\section{Liste des bibliothèques}

\begin{items}{orange}{\faFile}
    \item \lib{UART}
    Cette bibliothèque gère la communication série avec des périphériques en liaison série émulée. La bibliothèque utilise en interne la bibliothèque \lib{SoftwareSerial} pour émuler une liaison série.
    \item \lib{RS232}
    Cette bibliothèque gère la communication série avec des périphériques en liaison série native.
    \item \lib{Gyro}
    Cette bibliothèque gère le capteur MPU9250 afin de récupérer les données de la centrale IMU.
    \item \lib{SpaceViewer}
    Cette bibliothèque transforme les valeurs des angles obtenus par la centrale IMU en chaîne de caractère pouvant être transmise sur une liaison série.
    \item \lib{Rover}
    Cette bibliothèque gère le contrôle du Rover UQAC
    \item \lib{LED}
    Cette bibliothèque gère les LED.
    \item \lib{MusicPlayer}
    Cette bibliothèque gère les tonalités pouvant être générées sur un buzzer.
    \item \lib{LIDARLite}
    Cette bibliothèque gère les modules LIDAR.
\end{items}




\section{Installation de XCTU (Linux)}
\subsection{Lien de téléchargement}

\begin{enumerate}
 \item Se rendre à la page suivante : 
\url{https://hub.digi.com/support/products/xctu/?path=/support/asset/xctu-v-655-linux-x64/}

\item Puis Cliquer sur \bold{download}
\end{enumerate}

\img{\rootImages/download.png}{Image à télécharger}{0.5}


Un fichier au format \bold{.run} se télécharge à ce moment là. Il est appelé \italic{40002881\_AC.run}

\subsection{Don des permissions}

\begin{enumerate}
    \item Se placer dans le répertoire contenant le fichier téléchargé \\
    \item Ouvrir un terminal et lancer la commande \\
\end{enumerate}

\begin{Bash}{Don des droits}
chmod +x 40002881_AC.run
\end{Bash}
\subsection{Lancement de l'installateur}

\begin{enumerate}

    \item Exécuter le programme en saisissant 
    
\begin{Bash}{Lancement de l'installation de XCTU}
./40002881_AC.run
\end{Bash}

    \item Veuillez éviter d'installer le logiciel dans le répertoire `/opt/`, des problèmes de droits d'accès pourraient survenir. \\
    Il est recommandé de l'installer dans son répertoire personnel (/home/user)

    \item Valider toutes les étapes. 

\end{enumerate}

\subsection{Première ouverture du logiciel}

\begin{enumerate}

    \item Se placer dans le répertoire où est installé le logiciel (choisi par vos soins lors de l'installation) 

\item Lancer la commande :
\begin{Bash}{Lancement de XCTU}
./app
\end{Bash}

(Si la commande ne se lance pas, répéter l'opération 1.2 avec le fichier \file{app}
    
\end{enumerate}

\subsection{Création du raccourci}

Il est possible que le raccourci sous Linux pour lancer XCTU ne se créer pas. Pour cela, éditer le fichier \file{bash\_aliases} via les commandes suivantes : 

\begin{Bash}{Édition des alias}
cd ~
sudo nano .bash_aliases
\end{Bash}

Puis ajouter la ligne 
\begin{Bash}{Ajout de l'alias}
alias xctu=Emplacement_dossier_XCTU/XCTU-NG/app
\end{Bash}
(Ctrl+X permet de sauvegarder le script)

puis 
\begin{Bash}{Mise à jour de l'alias}
source .bashrc
\end{Bash}

\subsection{Lancement du logiciel}

Dans un terminal, saisir
\begin{Bash}{Lancement de XCTU}
xctu &
\end{Bash}


\section{Reconnaissance des modules Xbee}

\subsection{Ouverture de la liaison}

\begin{enumerate}
\item  Brancher le module XBee coté ordinateur au module FTDI 

\item Cliquer sur l'image avec la loupe pour ajouter un appareil 


\img{\rootImages/loop.png}{Ajouter un appareil}{1}


Une liste avec un nombre de port série trouvés apparaît.

\img{\rootImages/select_usart.png}{Afficher les ports}{0.4}

\item Il suffit de sélectionner celui du module puis cliquer sur \bold{Next}.

Un scan pour détecter le type de module se lance.

\img{\rootImages/found.png}{Scan des modules}{0.7}

Lorsque qu'il a trouvé le module, faire \bold{Next}

\item Une fenêtre de paramétrage apparaît.

\img{\rootImages/default.png}{fenêtre XCTU}{0.5}

On ne touche pas aux paramètres par défaut qui sont : 

\begin{items}{gray}{\faGear}
    \item Aucun bit de parité
    \item Vitesse de communication à 9600
    \item 8 bits de données
    \item 1 bit de stop
\end{items}

Puis \bold{Next}

Les modules ajoutés de cette manière seront visibles sur le menu latéral gauche.

\img{\rootImages/left_menu.png}{Un module sélectioné}{0.5}


En cliquant dessus, le menu de paramétrage du module devient visible sur le coté droit du logiciel.

L'onglet des paramétrages ressemble à ceci : 

\img{\rootImages/right.png}{L'onglet de paramétrage}{0.7}

C'est ici que nous allons définir les paramètres de communication \bold{entre 2 modules Xbee}

\end{enumerate}

\label{xbee}
\section{Paramétrage des modules Xbee}

\subsection{Choix des paramètres}

Pour pouvoir communiquer, les modules doivent être sur le même canal (channel) et avoir le même identifiant PAN (Personnal Area Network, qui peut être vu comme un sous-réseau).\\


Utilisons le canal \bold{C} (via \bold{CH Channel}) et  \bold{PAN ID} à $2000$.\\
Chaque module possède une adresse propre. Mettons là à $1001$ via l'onglet \bold{MY}.
Ce module communiquera avec un module ayant une adresse de $1000$.
 Nous mettons donc le champ \bold{DL} à $1001$.

En résumé, nous avons ces paramètres :

\img{\rootImages/settings.png}{paramètres du Xbee}{0.7}


\messageBox{Remarque}{orange}{white}{
Il faut bien vérifier que le mode API est désactivé, ce qui permet au module XBee de renvoyer toutes les données reçues.\\
Il faut mettre le mode \bold{API Mode à 0} dans la partie \bold{Serial interfacing}
}{black}

\img{\rootImages/api_mode.png}{Désactivation du mode API}{0.7}


Le module est configuré, il ne reste plus qu'à transférer les paramètres

\subsection{Transfert des paramètres}

Nous allons envoyer les paramètres au module Xbee via le logiciel.

Il suffit de cliquer sur le bouton \bold{Write}

\img{\rootImages/write.png}{Transfert des paramètres}{0.8}

Nous allons procéder aux mêmes opérations pour le deuxième module Xbee.

Celui-ci aura pour paramètres : 

\begin{items}{gray}{\faGear}
\item CHANNEL : C
\item PAN ID : 2000
\item DL : 1001
\item MY : 1000
\end{items}


\section{Communication entre deux modules Xbee}

Une fois les deux modules correctement configurés, nous allons mettre en évidence les échanges de données.\\

Pour cela, nous pouvons utiliser :

\begin{items}{green}{\faLeaf}
 \item XCTU
\item  GTKterm
\item  Minicom
\item  Putty
\item  Screen
\end{items}

Par simplicité, nous utiliserons le logiciel \ib{XCTU}

\subsection{Configuration minimale}

Il faut au préalable que les deux modules soit ajoutés dans le logiciel XCTU comme suivant

\img{\rootImages/all.png}{}{0.5}


\subsection{Lancement de la console XCTU}

Le logiciel XCTU propose une console pour échanger des données.

La console est disponible pour chaque module.

\begin{enumerate}
    
    \item Cliquer sur un des modules

    \item Faire \shortcut{Alt+c} ou bien cliquer sur l'image de la console en haut à droite

\img{\rootImages/console.png}{Afficher la console}{0.5}


La console occupe désormais la page centrale 

\img{\rootImages/console_2.png}{Console XCTU}{0.3}

\item Cliquer sur le bouton \bold{Open}

\img{\rootImages/open.png}{Bouton Open}{0.8}

\item La console passe de gris clair à blanc. 

\item Procéder de la même façon pour le second module (de l'étape 1 à la 4)
\end{enumerate}
\subsection{Écriture-lecture}

\begin{enumerate}
    
    \item Cliquer sur une des console ouverte et saisir un texte dans la page de gauche.\\
    On constate à ce moment-là que le texte est envoyé via la liaison série vers le module Xbee. Celui ci va envoyer le message à l'autre module, caractère par caractère.

\img{\rootImages/send.png}{Réception et écriture}{0.15}

\item  Les données envoyés sont en bleu, celles reçues sont en rouge.

\item En cliquant sur la console du second module, on constate que le texte envoyé (en bleu) est bien reçu car en rouge.

\img{\rootImages/receive.png}{message reçu}{0.3}

La communication est fonctionnelle entre les modules.
\end{enumerate}


\label{code}
\section{Code principal}

\begin{Cpp}{Code principal}
#include "UART.h"
#include "RS232.h"
#include "Gyro.h"
#include "Rover.h"
#include "SpaceViewer.h"
#include "LED.h"
#include "MusicPlayer.h"
#include "LIDARLite.h"
 
//#define SENDER  
#define RECEIVER

#define XBEE_UART
//#define XBEE_RS232 

//Xbee
#define RX_XBEE 10   //Rx pin of Xbee
#define TX_XBEE 8  //Tx pin of Xbee
#define BAUDRATE_XBEE 9600    //Baudrate of serial port
#define BAUDRATE_DEBUG 9600   //baudrate of xBee device


//#define NO_XBEE_UART 

#ifdef XBEE_UART
UART xBee = UART(RX_XBEE, TX_XBEE);                     //New instance of UART class, provides tools to communicate between microcontroleur and Xbee
#endif


#ifdef XBEE_RS232
RS232 xBee = RS232();                     //New instance of UART class, provides tools to communicate between microcontroleur and Xbee
#endif

#ifdef SENDER

  //Gyro
  #define SAMPLING_PERIOD_MS 100
  Gyro gyroscop = Gyro(ADDRESS_GYRO);                         //New instance of Gyro class, provides tools to read gyro
  //Led
  #define PIN_LED 13
  LED led = LED(PIN_LED);                                 //New instance of Led class

#endif


#ifdef RECEIVER

  //Rover
  #define ROVE_PWM_FORWARD 3
  #define ROVER_PWM_TURN 9

  #define BUZZER 5

  #define SECURITY_DISTANCE 70
  
  Rover rover = Rover(ROVE_PWM_FORWARD, ROVER_PWM_TURN);  //New instance of Rover class, provides tools to control rover
  MusicPlayer music = MusicPlayer(BUZZER);
  LIDARLite lidarLite;
 

#endif


/*!
  Setup function
  Used to setting up all devices and init instance
  This function is called one time
*/

void setup() {

#ifdef XBEE_UART
  Serial.begin(BAUDRATE_DEBUG);
	Serial.println(">>> Start");
#endif
	xBee.begin(XBEE_9600);
  xBee.setExitTime(200);


#ifdef SENDER
  
  gyroscop.setAlgorithm(Algorithm::Mahony);

#ifdef XBEE_UART
  Serial.println(">>> Init MPU9250");
  Serial.println(">>> Send calibrating order");
#endif

  xBee.send("START");

  gyroscop.begin();  
  delay(10);

#ifdef XBEE_UART  
  Serial.println(">>> End init MPU9250");
#endif
  led.on();  
  gyroscop.setMagneticDeclination(+15.9);
  gyroscop.calibrate(50);
  led.off();
  xBee.send("END");
#ifdef XBEE_UART
  Serial.println(">>> Send end calibrating order");
#endif
  
  
#endif


#ifdef RECEIVER

  rover.setDebug(true);

#ifdef XBEE_UART
  rover.addDebugChannel(&Serial, BAUDRATE_DEBUG);
#endif

  lidarLite.begin(0, true);   //set config to default and I2C to 400kHz, starts I2C
  lidarLite.configure(0);     //there are 6 different configs available
  
  rover.stop();
  delay(1000);
  music.addUARTDevice(&xBee, "START", "END");
  music.play();   //Wait until calibration
#endif

}//End setup

void loop() {

#ifdef SENDER

  gyroscop.readAll();

  float gx, gy, gz;

  float relativeRoll = gyroscop.relativeRoll();
  float relativePitch = gyroscop.relativePitch();

  float temp = gyroscop.getTemperature();
  
  String spacePosition = SpaceViewer::getSpacePosition(relativeRoll, relativePitch);
  //Serial.println("Pitch = "+String(relativePitch)+"\t Roll = "+String(relativeRoll)+"\t"+String(spacePosition)+"\t"+String(temp));
  xBee.send(spacePosition);
  delay(SAMPLING_PERIOD_MS);

#endif

#ifdef RECEIVER
  
	String message = xBee.read(WAIT_DATA);  //NO_WAIT_DATA

  
#ifdef XBEE_UART
	Serial.println(message);
#endif

  if(message.length()==6) 
  {
    //Gestion des commandes de base => un seul ordre à la fois    
    if(message[0]=='0' && message[1]=='0' && message[2]=='0' && message[3]=='0')
    {
      rover.stop(); //arreter
    }
    else if(message[0]=='1' && message[1]=='0' && message[2]=='0' && message[3]=='0')
    {
      rover.left(); //gauche
    }
    else if(message[0]=='0'&& message[1]=='1' && message[2]=='0' && message[3]=='0')
    {
      rover.right(); //droite
    }
    else if(message[0]=='0' && message[1]=='0' && message[2]=='1' && message[3]=='0')
    {
      if(lidarLite.distance() < SECURITY_DISTANCE)
      {
        rover.stop();
      }
      else
      {
        rover.forward(); //avancer
      }       
    }
    else if(message[0]=='0' && message[1]=='0' && message[2]=='0' && message[3]=='1')
    {
       rover.backward(); //reculer
    }

    //Gestion des diagonales => deux ordres en même temps    
    else if(message[0]=='1' && message[1]=='0' && message[2]=='1' && message[3]=='0') //Avancer à gauche
    {
    if(lidarLite.distance() < SECURITY_DISTANCE)
      {
        rover.stop();
      }
      else
      {
        //Serial.println("diagonale gauche");
       rover.left_forward();
      }             
    }

    //Gestion des diagonales => deux ordres en même temps    
    else if(message[0]=='0' && message[1]=='1' && message[2]=='1' && message[3]=='0') //Avancer à droite
    {
      if(lidarLite.distance() < SECURITY_DISTANCE)
      {
        rover.stop();
      }
      else
      {
        //Serial.println("diagonale gauche");
       rover.right_forward();
      }   
    }    

    else {}
     
  }
  else if(message.length()==0)
  {
    Serial.println(">>> Xbee disconnected");
    rover.stop();
  }
  else 
  {
    Serial.println(">>> Bad frame input");
  }//End else

  
#endif

}//End loop

\end{Cpp}\chapter{Réveil}

\begin{items}{red}{\faviconBookmark}
\item Module Bluetooth HC-XX pour le contrôle du réveil
\item Module Bluetooth pour la musique
\end{items}
\part{Annexes}
\chapter{Configuration de l'ESP12 sous Arduino}

\img{\rootImages/nodemcu.png}{ESP12 NodeMCU}{0.8}

\section{Installation des bibliothèques et cartes ESP8266}

La carte ESP12 NodeMCU est prévue pour être programmée directement via l'\glossary{IDE} Arduino.\\
Cette carte fait partie de la grande famille des ESP8266.\\

\messageBox{\faviconInfo}{green}{green}{L'installation est strictement identique avec la version 1.X ou 2.X d'Arduino, que ce soit sous Windows, Linux ou MAC}{black}
Pour installer les bibliothèques et cartes sur le logiciel Arduino, il faut réaliser les étapes suivantes : 


\begin{items}{blue}{\Triangle}

    \item Ouvrir les préférences du logiciel Arduino dans \lbl{blue}{KEY}{Fichiers - Préférences}
    \img{\rootImages/preference.png}{Préférences Arduino}{0.5}

    \item Dans le champ \bold{URL de gestionnaire de cartes supplémentaires}, mettre le lien suivant : \\

    \link{\url{http://arduino.esp8266.com/stable/package_esp8266com_index.json}}
    
    \messageBox{\faviconWarning}{orange}{orange}{Veuillez vérifier l'URL après le copier-coller car les underscores ("tirets du 8") peuvent disparaître.}{black}
    \img{\rootImages/url.png}{Lien pour les cartes ESP8266}{0.5}
    
    Puis faire \lbl{blue}{KEY}{OK}

    \item Fermer le logiciel Arduino

    \item Lancer le logiciel Arduino
    \item Allez dans \lbl{blue}{KEY}{Outils - Type de carte - Gestionnaire de carte} 
    \img{\rootImages/boardManager.png}{Gestionnaire des cartes ESP8266}{0.5}
    
    et faire une recherche avec le mot clé \lbl{blue}{KEY}{esp8266}

    \img{\rootImages/install.png}{Installation des bibliothèques ESP8266}{0.5}

    Il ne vous reste plus qu'à cliquer sur \lbl{blue}{KEY}{Installer} et redémarrer le logiciel Arduino.
\end{items}

\section{Installation du driver CH340 sous Windows}

La plupart des nouvelles cartes ESp12 (et Arduino) utilisent le module CH340 pour communiquer entre la carte et l'ordinateur.
Installons les pilotes. Tout d'abord, se rendre à l'adresse suivante pour télécharger le pilote :
\link{\url{https://www.arduined.eu/ch340-windows-10-driver-download/}}

\img{\rootImages/link.png}{téléchargement du driver CH340}{0.6}

En cliquant sur \bold{Driver CH340 for Windows 10}, un fichier compressé au format ZIP se télécharge. Il ne vous reste plus 
qu'à le décompresser \footnote{Clic-droit sur le fichier et "extraire ici"}.
Les fichiers suivants devraient apparaître dans le dossier : 

\img{\rootImages/dir.png}{La liste des fichiers pour le driver}{0.8}

Il faut clicker sur le fichier \file{SETUP.exe} et ensuite, l'interface suivante apparaît : 

\img{\rootImages/installCH340.png}{L'installation du driver CH340}{0.6}

Faites \bold{INSTALL} et après quelques secondes, la fenêtre suivante apparaît : 

\img{\rootImages/installed.png}{L'installation effectuée du driver CH340}{0.8}

Vous pouvez revenir au logiciel Arduino.

\section{Recherche des cartes ESP8266}

\bold{A cette étape, ne pas oublier de brancher la carte ESP12 à l'ordinateur avec un câble USB-micro}

\img{\rootImages/micro.jpg}{Un câble USB-micro}{0.6}
\messageBox{\faviconWarning}{red}{red}{Certains câbles USB sont prévus uniquement pour alimenter un appareil, pas pour communiquer. En cas d'erreur par la suite, n'hésitez pas à changer de câble si vous avez un doute.}{white}
Lors de la programmation d'une carte ESP8266 NodeMCU, il faudra donc aller dans \\
\lbl{blue}{KEY}{Outils - Type de carte - ESP8266 Boards NodeMCU X.X (ESP12 Module)} 

\img{\rootImages/espFull.png}{Sélection de la carte ESP12}{0.4}


Afin de tester le bon fonctionnement, nous vous invitons à tester le programme \bold{Blink} disponible dans les exemples.

\img{\rootImages/blink.png}{Emplacement de l'exemple Blink}{0.4}

La led bleue de l'ESP12 devrait clignoter si l'installation s'est correctement effectuée.

\section{Recherche des cartes Arduino}

Pour la programmation des cartes Arduino, il suffira de sélectionner \\
\lbl{blue}{KEY}{Outils - Type de carte - Arduino AVR Boards - Carte X} en fonction du modèle de votre carte.\chapter{Langage HTML}

Le \glossary{HTML} est un langage contenant des balises, c'est à dire des 
marqueurs spécifiques pour organiser la page Web.

Il existe deux types principaux de balises: 

\begin{items}{blue}{\Triangle}
\item Les balises en paire (Par exemple $<h1></h1>$)
\item Les balises orphelines (Par exemple $<img>$)
\end{items}

Une balise commence par un chevron ouvrant et se termine par un chevron fermant.
Toutes les balises fermantes (pour les balises en paire) sont de la forme $</nom\_balise>$ \\

Toute page HTML commencer par la balise \lbl{blue}{html}{html}

\messageBox{\faviconInfo}{darkBlue}{darkBlue}{Pour mettre du code en commentaire, c'est à dire ne pas le visualiser dans la page Web de rendu, il faut mettre le code entre $<--!$ et $-->$}{white}


\begin{Html}{Première balise HTML}
<html>
    <!-- Ceci est mon début de page HTML --> 
</html>
\end{Html}

\section{La forme de la page}

La page Web est scindée en 2 entités: 

\begin{items}{blue}{\Triangle}
\item L'en-tête (header), marqué avec la balise \lbl{green}{CMT}{$<head></head>$}
\item Le corps (body), marqué avec la balise \lbl{green}{CMT}{$<body></body>$}
\end{items}

\begin{Html}{Page minimaliste HTML}
<html>
    <head>
        <!-- Ceci est un header --> 
    </head>

    <body>
        <!--! Ceci est un body -->
    </body>
</html>
\end{Html}


\section{L'en-tête}

L'en-tête va contenir les informations et les paramètres de la page, notamment : 

\begin{items}{blue}{\Triangle}
    \item Le titre de la page
    \item Les importations des bibliothèques (feuilles de style)
    \item Les icônes
    \item L'encodage de la page (UTF-8)
    \end{items}


\begin{Html}{L'en-tête}
<head>
        <--! Titre en haut de la page -->
        <title>Titre de la page</title> 

        <--! Ajout d'une feuille de style -->
        <link rel="stylesheet" href="style.css" type="text/css"> 

        <--! Ajout d'une icone -->
        <link rel="icon" href="icone.ico">  
        
        <--! Encodage UTF-8 -->
        <meta charset="utf-8">  

</head>
    \end{Html}



\section{Le corps}

Le corps va contenir l'ensemble des informations affichées sur la page
    
\begin{items}{blue}{\Triangle}
    \item Les titres, sous-titre, sous-sous-titre
    \item Les paragraphes 
    \item Les images
    \item Les liens
    \item Les sections de code
    \item ...
\end{items}
    
    
\subsection{Ajout des titres}

Un titre en HTML est vue avec un niveau hiérarchique. 
Un titre de page est au niveau 1, un sous-titre avec un niveau 2, etc...

Pour mettre un titre, il faut donc écrire \lbl{green}{CMT}{$<h1>Titre</h1>$}, un sous-titre 
c'est \\
\lbl{green}{CMT}{$<h2>Sous-titre</h2>$}


\subsection{Ajout des images}

Pour ajouter une image, il faut connaître son emplacement dans le système (ordinateur) ou bien sur Internet (url).

Il s'agit de la balise orpheline \lbl{green}{CMT}{$<img>$}

\begin{Html}{Ajout d'une image}
<--! Image locale -->
<img src="monImage.png" alt="Impossible de charger l'image">

<--! Image Internet -->
<img url="www.crepp.oreg/image.png" alt="Impossible de charger l'image">
\end{Html}


\subsection{Ajout des liens}

Pour ajouter une image, il faut connaître son emplacement dans le système (ordinateur) ou bien sur Internet (url).

Il s'agit de la balise orpheline \lbl{green}{CMT}{$<img>$}

\begin{Html}{Ajout d'un lien}
<--! Lien -->
<a href="monChemin" > Texte du lien</a>
\end{Html}
Les liens permettent de pointer sur d'autres pages, que ce soit sur le serveur courant ou bien un autre. \chapter{Installation de Discord}
\section{Connexion au serveur}


Une fois le lien cliqué,vous tombez sur une interface similaire : 

\img{\rootImages/discord_welcome.png}{Accueil du site Discord}{0.2}

Ensuite, veuillez cliquer sur "\bold{Ouvrir dans votre navigateur}"

\img{\rootImages/discord_browser.png}{Lancement de Discord}{0.6}


Veuillez choisir un identifiant, qui sera votre nom visible par les membres de la session vocale, sans oublier de cocher la case "\bold{J'ai lu et accepte les Conditions Générales d'Utilisation}"

\img{\rootImages/discord_login.png}{Choix de votre identifiant Discord}{0.35}

Ensuite, le site va vous demander si vous êtes un robot. Cochez la case "\bold{Je ne suis pas un robot}" \footnote{Parfois, une sélection d'images diverses va vous être imposée.} \\
\img{\rootImages/discord_captcha.png}{Vérification Captcha}{0.5}

Votre date de naissance va vous être demandée.

\img{\rootImages/discord_birth.png}{Date de naissance}{0.5}



On va vous demander le type de serveur que vous voulez créer. Dans notre cas, sur la fenêtre qui s'affiche, veuillez cliquer sur \bold{"Rejoindre un serveur"}



\img{\rootImages/discord_join.png}{Rejoindre un serveur}{0.5}

\messageBox{Adresse du serveur}{orange}{white}{A ce moment, veuillez renseigner l'adresse du serveur : https://discord.gg/Fm97K3Se. Attention, ce lien est valable 24 h et est est actif uniquement le 21 novembre 2020. Lorsque vous essayez ce tutoriel à une autre date, veuillez envoyer un SMS au 06.28.88.75.12 en demandant une nouvelle invitation sur Discord. A partir du moment où vous recevrez le lien, vous aurez de nouveau 24 h pour vous connecter}{black}

\img{\rootImages/discord_enter.png}{Saisir l'adresse du serveur, celle dans l'encadré orange}{0.6}

Cliquer ensuite sur \bold{Rejoindre} \\


Une fenêtre avec un fond noir apparaît. Cette fenêtre demande à enregistrer votre compte. \\

\bold{Il faut renseigner une adresse mail et un mot de passe.}

\img{\rootImages/discord_account.png}{Saisir une adresse mail et un mot de passe}{0.6}



\bold{Veuillez noter précieusement l'adresse mail et le mot de passe utilisé. Cela vous permettra de vous connecter au serveur à tout moment.} \\

Une fenêtre de confirmation s'affiche. \\



\img{\rootImages/discord_email.png}{Confirmation de l'adresse mail}{0.5}

En cliquant sur le bouton \bold{Télécharger l'application de bureau}, un fichier va se télécharger.

Le format du fichier va dépendre du système d’exploitation.

\begin{items}{blue}{\Triangle}
	\item Pour Windows, un fichier executable (.exe) va se télécharger. 


	Il suffit de cliquer dessus pour lancer l'installation du logiciel.

	\item Pour Linux, un fichier compressé se télécharge. Il suffit de le décompresser, de se rendre dans le dossier décompressé puis dans le dossier Discord. \\

	\img{\rootImages/discord_zip.png}{Dossier compressé}{0.6}

	Vous trouvez normalement un fichier appelé Discord :

	\img{\rootImages/discord_down.png}{Emplacement de l'éxécutable}{0.6}

	Puis click-droit sur le fichier \bold{Discord > Permissions}  et cocher la case \bold{Autoriser l'éxécution du fichier comme un programme}

	\img{\rootImages/discord_droits.png}{Droit d'éxécution du fichier}{0.6}

	Puis click-gauche sur le fichier \bold{Discord} pour le lancer.
\end{items}

\subsection{Enregistrement du compte}

je vous invite à consulter votre messagerie pour recevoir le mail de confirmation. \\


Une fois sur votre messagerie, vous recevrez un message similaire.

Veuillez cliquer sur \bold{Vérifier l'adresse e-mail}

\img{\rootImages/discord_check.png}{Vérification de l'adresse mail}{0.6}

Un message de confirmation devrait apparaître 

\img{\rootImages/discord_link.png}{Confirmation de l'adresse mail}{0.5}

En cliquant sur \bold{Continuer vers Discord}, la page suivante s'affiche. Il s'agit de la page d'accueil avec votre compte permanent.\\

\bold{Nous n'avons plus besoin du navigateur internet. Vous pouvez le fermer.}


\bold{Dorénavant, pour se connecter, il suffira d'aller dans la barre de recherche de vos logiciels et de saisir "Discord"}. \\

\img{\rootImages/discord_s.png}{lancement du logiciel}{0.5}


La page suivante apparaît et vous permet de vous connecter avec vos identifiants.

\img{\rootImages/discord_new_login.png}{Connexion avec vos identifiants}{0.5}


\newpage


\section{Navigation et utilisation du serveur}

\subsection{Première vue}

Une fois que vous êtes connecté sur le serveur, voici l'interface que vous devez avoir : 

\img{\rootImages/discord_home_own.png}{Accueil du serveur}{0.3}


\subsection{Accéder à l'Atelier Arduino}

Pour faire partie de l'Atelier Arduino, il faut cliquer sur le bouton \bold{AA} dans le menu de gauche. \\

\img{\rootImages/discord_aa.png}{logo de l'Atelier Arduino non actif}{0.6}


Le logo "AA" en bleu vous indique que vous êtes bien dans le salon "Atelier Arduino"

\img{\rootImages/discord_workshop.png}{logo de l'Atelier Arduino actif}{0.6}

\subsection{Présentation}

Discord se décompose en trois parties. 

\begin{items}{blue}{\Triangle}
	\item L'accès aux salons du serveur [menu de gauche]

	\img{\rootImages/discord_salons.png}{Les types de salons}{0.6}

	Le serveur est composé de deux types de salons : 

	\begin{items}{blue}{\Bullet}
		\item Les salons textuels pour noter et faire partager des informations \bold{écrites}.
		\item Les salons vocaux pour discuter de \bold{vive voix}
	\end{items}


	\item Le contenu du salon
	\img{\rootImages/discord_content.png}{Le contenu du salon}{0.3}
	\item Les membres connectés
	\img{\rootImages/discord_members.png}{Les membres du salon}{0.6}
\end{items}



\subsection{Entrer dans un salon}

Pour pouvoir discuter avec les autres membres, il suffit de cliquer sur le bouton \bold{Salon} parmi les salons vocaux.

\img{\rootImages/discord_vocal.png}{L'accès à un salon vocal}{0.8}

Une fois rentré dans ce salon, votre identifiant apparaît, signifiant que vous pouvez discuter avec les autres membres si ces derniers sont dans le même salon.

\subsection{Activer votre microphone}

Par défaut, quand vous rentrez dans un salon vocal, le microphone est désactivé. Pour l'activer, il faut cliquer sur le petit microphone barré 

\img{\rootImages/discord_micro.png}{Activer le microphone}{0.8}



\subsection{Partager son écran}.

La première condition pour partager son écran est de rejoindre un salon vocal. \\

Pour partager son écran, il faut cliquer sur le bouton \bold{Ecran} en bas à gauche.

\img{\rootImages/discord_screen.png}{Le partage d'écran}{0.8}

A partir de cette fenêtre, vous pouvez choisir ce que vous voulez partager : 

	\begin{items}{blue}{\Triangle}
		\item Votre écran courant
		\item Une application en particulier (et seulement cette application)
	\end{items}

	Vous cliquez sur l'image correspondante à votre choix puis \bold{Partager}

\img{\rootImages/discord_share.png}{Le partage d'écran - validation}{0.4}

\section{Accéder aux paramètres}

Les paramètres de microphone, des écouteurs (ou casque) et de divers éléments sont accessibles avec le bouton en forme d'engrenage en bas à gauche, à coté de votre identifant.

\img{\rootImages/discord_setup.png}{Accès aux paramètres}{0.8}

Les paramètres pour le matériel audio est disponible à la section suivante (page de paramètres)

\img{\rootImages/discord_setup_song.png}{Accès aux paramètres sonores}{0.8}


\section{Déconnexion du serveur}

Pour quitter le serveur proprement, il suffit de se rendre sur la page \bold{Paramètres} comme indiqué précédemment et de se rendre en bas de la page pour cliquer sur \bold{{\color{red}Déconnexion}}.

\img{\rootImages/discord_logout.png}{Déconnexion du serveur}{0.8}
\newpage
\addcontentsline{toc}{section}{Table des figures}
% \part{Annexes}
\chapter{Installation de Domoticz}
\section{Installation de Domoticz sur Linux}

Veuillez ouvrir un terminal puis saisir les commandes suivantes : 

\begin{Bash}{Installation de domoticz}
sudo apt-get -y install cmake make gcc g++ libssl-dev git libcurl4-openssl-dev libusb-dev python3-dev curl zlib1g-dev zlib1g
\end{Bash}

Puis lancez le script d'installation avec la commande suivante

\begin{Bash}{Installation de domoticz}
  sudo curl -L https://install.domoticz.com | bash
\end{Bash}

Le terminal devrait afficher un contenu similaire : 

\img{\rootImages/load.png}{Vérification des bibliothèques}{0.3}

Ensuite, une interface utilisateur se lance dans le terminal:


\img{\rootImages/l1.png}{Présentation de Domoticz}{0.4}

Il faut saisir la touche \lmagenta{KEY}{ENTREE} pour afficher la fenêtre suivante.
Une deuxième fenêtre apparaît. Veuillez sélectionner le service HTTP (par défaut) puis \lmagenta{KEY}{ENTREE}

\img{\rootImages/l2.png}{Choix du protocole par défaut}{0.4}

Nous allons ensuite choisir le port 8080 pour communiquer sur le réseau (par défaut : 8080)

\img{\rootImages/l3.png}{Choix du port}{0.4}

Nous utiliserons le port 443 (HTTPS) pour un protocole plus sécurisé.

\img{\rootImages/l4.png}{Protocole HTTPS}{0.4}

Il ne vous reste plus qu'à choisir l'emplacement du logiciel Domoticz.\\
Par défaut, Domoticz le place dans vos documents personnels (/home/nom\_utilisateur)

\img{\rootImages/l5.png}{Emplacement des fichiers Domoticz}{0.4}

Il ne vous reste plus qu'à valider l'installation : 

\img{\rootImages/l6.png}{Validation de l'installation}{0.4}

Puis dans votre navigateur internet, saisir :

\begin{Bash}{Lancement de Domoticz}
  localhost:8080
\end{Bash}% \addPartText{Gravure de circuits imprimés}

% \part{Gravure}

\chapter{Gravure de circuits imprimés}

\section{Liste du matériel}

\begin{items}{blue}{\Bullet}
	\item Perchlorure de fer
	\item Carbonate de Sodium
	\item Acétone
	\item Plaque de cuivre 
	\item Perceuse à colonne
	\item Forêts (8-12.5 mm)
	\item Une insoleuse
	\item Un ordinateur
	\item Une imprimante laser
	\item Du papier calque ou transparent
\end{items}

\subsection{Dessiner son circuit imprimé}

Avant de se lancer dans la fabrication de son circuit imprimé, il convient de le concevoir sur un logiciel de CAO electronique.
Il existe de nombreux logiciels tels que:

\begin{items}{blue}{\Bullet}
	\item Kicad
	\item Eagle
	\item EasyEDA
	\item Altium 
	\item Target 3001
	\item Proteus-ISIS
	\item CircuitMaker
\end{items}

\subsection{Impression en noir inversé}

Une fois votre circuit réalisé sur l'ordinateur, il vous suffit de l'imprimer
Imprimer votre circuit à l'imprimante laser pour avoir un tracé noir, dense et sans manques, à haute résolution, sur un transparent (calque).\\
Pour plus de précision, on utilisera ce tracé sur la face inférieure (à cause de la légère épaisseur du transparent).\\

Marquer les 4 coins pour le repérage de position de typon si on fait un circuit double face. (Attention, les imprimantes à jets d'encre ne font pas toujours des détails précis, les gouttes d'encre ont tendance à diffuser).\\

Le film est un négatif donc inverser l'image avec Photoshop.\\

Imprimer en noir tout ce qui doit rester en cuivre (les pistes, les pastilles de soudure, le plan de masse).

\subsection{Découpe du cuivre}
Choisir du cuivre entre simple face au double face selon le circuit souhaité.
Couper votre plaque de cuivre.

\subsection{Découpe du film}
Découper un morceau de film bleu photosensible à la bonne taille, qui dépasse de 1 cm (un cutter et une bonne surface de coupe sont recommandés, sinon aux ciseaux). N'ouvrir l'emballage du film sensible que le temps nécessaire (ne pas laisser au soleil).

Le film photosensible est pris en sandwich entre deux protections : soft, en face interne du rouleau (mat), et hard, sur le dessus (brillant)

Décoller et retirer le film de protection soft du film photosensible (astuce, le tirer avec un bout de scotch depuis un coin) et appliquer cette face soft, coté collant, sur le cuivre. Eviter les bulles et les vagues, bien à plat. Le cuivre doit être bien propre, sans trace de doigts (nettoyer à l'acétone et gratter au préalable, le cuivre doit être dégraissé).
Replier et coller le film sur la seconde face du cuivre si on fait un PCB double face.

\subsection{Chauffer}
Passer la plaque plastifiée dans la plastifieuse à chaud (2 fois) pour une bonne adhésion. Ou au fer à repasser réglage léger.

\subsection{Couper les bords}
Couper le surplus, pas trop près des bords de la plaque.
Elle est alors sensibilisée, prête à l'emploi.

\subsection{Exposition}
Exposer la plaque à la lumière.
Le circuit PCB à réaliser est imprimé en négatif avec une imprimante. Poser le calque sur sa plaque, soigneusement aligné. Une plaque de verre (sans poussière) permet de le bloquer dessus si besoin.
Exposer à la lumière du jour ou un tube fluo 15 w pendant 15 minutes. Le papier qui est vert clair avant exposition passe au bleu sombre.
Faire le second côté éventuel (avec des repères de calage).

30 minutes avec une lampe à économie d'énergie, probablement 15 minutes si exposé au soleil. Le circuit apparaît imprimé sur la plaque.

\subsection{Révélation}

Après exposition, retirer la seconde couche protectrice (hard) et le masque. Puis développer chimiquement le cuivre au carbonate de sodium (0.85 %), on peut s'aider d'une brosse à dents pour les pistes fines. ("lessive de soude" à 30% mettre 3 cuillères / litre) 5 minutes à 15-35 °C, le produit se conserve.

\subsection{Gravure}
Puis préparer une solution de gravure à 2-5 \% d'hydroxyde de sodium (soude : utiliser avec des gants, attention aux vapeurs).
Plonger la plaque dedans et attendre que ça devienne transparent, retirer la plaque (avec une pince), rincer à l'eau et peler le papier.

9bis - Autre méthode de gravure sans perchlorure
\url{http://www.bidouille.org/elec/gravure}
\url{http://wiki.jelectronique.com/realisation_de_circuits_imprimes}

Mélanger 3 volumes d'eau chaude, 2 volumes d'acide chlorhydrique 23\% et 2 d'eau oxygénée 110 volumes (ou dosage 1 + 0.6 + 0.3) (+ gants et protections, ne pas verser l'eau dans l'acide), pour éviter d'utiliser du perchlorure très salissant. prendre des récipients en verre. Durée 30 à 40 secondes.

\subsection{Perçages}
Puis percer les trous (forêt au carbure de tungstène avec perceuse à colonne sur support vertical).

\subsection{Finitions}
Etamer, vernir, placer les composants, souder et tester le circuit.\chapter{Configuration de l'ESP12 avec WebREPL}     

\section{Présentation}

Ce document a pour but de configurer un ESP8266-12E (NodeMCU) afin que ce dernier puisse être accessible en tant que réseau Wifi.

Ce tutoriel s'adresse également dans le cas où vous avez perdu vos mots de passe d'accès (réseau wifi ou WebRepl) ou bien que vous souhaitez partir sur des bases saines.\\

\messageBox{Information}{green}{white}{Le temps estimé pour configurer l'ESP8266 est de 25 min}{black}


\section{Conventions}


\subsection{Commandes}

Les commandes à saisir sont dans des encadrés similaires : \\
\begin{Bash}{Exemple de commande}
sudo apt-get update
\end{Bash}

\subsection{Références et repères}

Dans un souci de clarté : 

\begin{items}{blue}{\Triangle}
	\item Les fichiers sont indiqués par le repère \file{nom du fichier}
	\item Les dossiers sont indiqués par le repère \dir{nom du dossier}
	\item Les touches du clavier et le texte à saisir au clavier sont indiqués par le repère \shortcut{Raccourci clavier ou texte à saisir}
	\item Les bibliothèques, logiciels et utilitaires sont indiqués par le repère \lib{nom de l'utilitaire}
\end{items}

\section{Matériel}

Pour réaliser ce tutoriel, vous aurez besoin de 

\begin{items}{blue}{\Triangle}
    \item Un ordinateur (Linux, Apple ou Windows)
    \item Un ESP8266 (NodeMCU)
    \item Un câble USB Micro Type-B
    \img{\rootImages/usb.png}{Un câble USB Micro type-B}{0.2}
    
\end{items}

\section{Mise à jour des systèmes UNIX}

Avant toute chose, il convient de mettre à jour la liste des paquets et de mettre à jour les logiciels déjà présents sur votre ordinateur si ce dernier est sous LINUX (UNIX). \\
Les commandes suivantes sont à saisir dans un terminal.

\subsection{Mise à jour de la liste des paquets}

\begin{Bash}{Mise à jour de la liste des paquets}
sudo apt-get update
\end{Bash}


\subsection{Mise à jour des logiciels}
\begin{Bash}{Mise à jour des logiciels}
sudo apt-get -y upgrade
\end{Bash}

\textit{Le -y sert à accepter automatiquement la mise à jour.}

\subsection{Mise à jour de Python}

Il conviendra d'installer au minimum la version 3.6 de Python. \\
Pour vérifier votre version, ouvrez un terminal et saisissez la commande 

\begin{Bash}{Vérification de la version de python}
python3
\end{Bash}

Si l'invité de commande Python suivant apparaît, la version est présente. \\
Pour quitter l'interpréteur python, il suffit de saisir \shortcut{exit()} dans l'interpréteur ou bien de faire \shortcut{Ctrl  +z}

\img{\rootImages/python.png}{Invité de commande Python}{0.6}
Le cas échéant, je vous invite à saisir la commande suivante :

\begin{Bash}{Installation de Python 3.7}
sudo apt-get -y install python3.7
\end{Bash}\section{Effacer la mémoire de l'ESP8266}

Dans un premier temps, nous allons effacer le contenu de la puce ESP8266. Ceci nous permettra de partir sur des bases saines. \\

\messageBox{Point-clé}{orange}{white}{Maintenant, vous pouvez brancher votre ESP8266 sur un des ports USB de votre ordinateur.}{black}

Il convient ensuite d'installer les outils adéquats.

\subsection{Installation de Pip3}

\lib{pip3} est un utilitaire Python qui va nous permettre d'installer le petit programme pour effacer l'ESP8266. \\
On l'installe de la manière suivante : 

\begin{Bash}{Installation de Pip3}
sudo apt-get -y install python3-pip
\end{Bash}


\subsection{Installation de Esptool}

L'utilitaire qui va se charger d'exécuter cette opération s'appelle \lib{esptool}.

Pour l'installer, on effectue

\begin{Bash}{Installation de Esptool}
pip3 install esptool
\end{Bash}

Voici le résultat de la commande sur le terminal : 

\img{\rootImages/esptool_download.png}{Résultat de l'installation de pip3}{0.28}



\subsection{Récupération du port USB}

L'ESP8266 étant raccordé, l'ordinateur lui a affecté un nom de port de type \italic{/dev/ttyUSBx} avec x représentant le numéro du périphérique USB. \\

Pour récupérer la valeur de ce numéro, nous allons lancer la commande suivante : 

\begin{Bash}{Récupération du numéro du port série}
ls /dev/ttyUSB*
\end{Bash}

\img{\rootImages/lsusb.png}{Résultat de la commande}{0.8} %@change

Dans le cas présent,le nom du port est \italic{/dev/ttyUSB0}

\subsection{Effacer la mémoire}

Lancer la commande suivante : 
\begin{Bash}{Effacer la mémoire de l'ESP8266}
esptool.py --port /dev/ttyUSB0 erase_flash
\end{Bash}

Évidemment, si vous avez un autre numéro de port avec la commande \bold{esptool.py flash\_id}, vous mettez votre numéro.

Voici le résultat de la commande sur le terminal : 

\img{\rootImages/esptool_erase.png}{Résultat de la commande pour effacer l'ESP8266}{0.6}


\section{Installer le firmware sur l'ESP8266}

Maintenant que l'ESP8266 est vide, il nous reste à installer son logiciel (firmware) fin qu'il puisse utiliser le Wifi selon deux modes : 

\begin{items}{blue}{\Triangle}
    \item Point d'accès : l'ESP8266 créer son propre réseau Wifi
    \item Connexion : l'ESP8266 peut se connecter à un réseau Wifi pour dialoguer
\end{items}

\subsection{Récupération du logiciel}

Le logiciel se présente sous fichier binaire (.bin) et est disponible à l'adresse suivante : \\

\url{http://micropython.org/download/esp8266/}\\

Je vous invite à télécharger la dernière version stable (latest)

\img{\rootImages/esplatest.png}{Récupération du logiciel pour l'ESP8266}{0.55}

\subsection{Installation du logiciel}

\bold{Tout d'abord, placez vous dans le même répertoire que votre fichier binaire installé précédemment et ouvrez un terminal.} \\

La commande \shortcut{ls} devrait confirmer votre contenu du répertoire.

\begin{Bash}{Vérification du répertoire}
ls
\end{Bash}

\img{\rootImages/ls.png}{Contenu du répertoire}{0.7}

Il ne vous reste plus qu'a saisir la commande pour installer le firmware. \\
\begin{Bash}{Installation du firmware}
esptool.py --port /dev/ttyUSB0 --baud 460800 write_flash --flash_size=detect 0 esp8266-20190125-v1.10.bin
\end{Bash}

Comme précédemment, si vous avez un nom de fichier différent, je vous laisse le soin de changer de nom afin de coïncider avec le vôtre.

\img{\rootImages/espinstall.png}{Résultat de la commande pour installer le firmware}{0.45}

Après le déploiement du firmware, le module redémarre et il est configuré en point d’accès WiFi avec pour nom \bold{MicroPython-6953}. \\ Les chiffres correspondent aux quatre derniers chiffres de l'adresse MAC du module. 


\section{Configurer le mot de passe WebRepl}

\subsection{Installation de WebRepl}

Le logiciel \lib{WebRepl} va nous permettre de se connecter à l'ESP8266 afin de saisir des commandes Python.

Le logiciel est disponible à l'adresse suivante : \\

\url{https://github.com/micropython/webrepl}\\

Cliquez ensuite sur \shortcut{Code} puis \shortcut{Download Zip}

\img{\rootImages/github.png}{Téléchargement de WebRepl sur Github}{0.45}

Veuillez commencer par extraire l'archive.
Celle-ci contient les fichiers suivants : 

\img{\rootImages/webrepl.png}{Contenu du dossier WebRepl}{0.45}

\subsection{Installation de screen}

\lib{screen} est un utilitaire qui va nous permettre de se connecter à l'ESP8266 via le câble USB car actuellement, il nous est impossible d'utiliser WebRepl.\\
On installe l'utilitaire avec la commande suivante : 
\begin{Bash}{Installation de screen}
sudo apt-get install -y screen
\end{Bash}

\subsection{Création du mot de passe}

\subsubsection{Utilisation de screen}

On peut accéder à l’interpréteur de commande Python REPL \footnote{Read Evaluate Print Loop} via le port série en tapant la commande suivante dans un terminal :

\begin{Bash}{Exécution de screen}
screen /dev/ttyUSB0 115200
\end{Bash}


\messageBox{Point-clé}{orange}{white}{\bold{Il faut appuyer sur la touche Entrée pour afficher l'invité de commande MicroPython.}}{black}

\img{\rootImages/console.png}{Console screen}{0.6}


Pour quitter Screen, il faut appuyer sur les touches \shortcut{CTRL + a} puis écrire \shortcut{:quit} \\

Ensuite, entrez la commande suivante via le terminal Screen :
\begin{Bash}{Commande pour créer un mot de passe}
>>> import webrepl_setup
\end{Bash}

Le système vous demande tout d'abord d’activer l’accès par le réseau Wifi dès le démarrage en saisissant \shortcut{E}.

\img{\rootImages/enable.png}{Activation de l'ESP8266 screen}{0.6}

Il vous invite ensuite à saisir le mot de passe pour l'accès à WebRepl. Ici le mot de passe choisi est \shortcut{crepp}
\img{\rootImages/password.png}{Activation de l'ESP8266 screen}{0.6}
Enfin, saisissez \shortcut{y} pour redémarrer l'ESP8266.\\
A ce moment là, les lignes suivantes apparaissent : 
\img{\rootImages/end.png}{Fin de la configuration}{0.6}

\bold{La configuration de l'ESP8266 est terminée}


\subsection{Connexion à WebRepl}



\subsubsection{Connexion au réseau de l'ESP8266}

Tout d'abord, veuillez chercher parmi les réseaux Wifi le réseau de l'ESP8266 appelé MicroPython-XXXX avec XXX représentant les 4 derniers chiffres de l'adresse MAC de l'ESP8266.

Lors de la connexion, un mot de passe est demandé, saisir \shortcut{micropythoN}

\subsection{Lancement de WebRepl}

 Veuillez lancer, à l'aide de votre navigateur Internet, le fichier \file{webrepl.html}  situé dans le dossier WebRepl précédemment installé. \\
 Pour cela, veuillez faire un \shortcut{Click droit + "Ouvrir avec le navigateur Web ..."}. \\
Vous tombez sur l’interface Web. Il suffit de cliquer sur \shortcut{Connect} et d’entrer le mot de passe que vous avez définie.
(en l'occurrence \bold{crepp}).


\section{Se connecter automatiquement à un réseau Wifi}

L’inconvénient avec la méthode présente est de jongler entre les 2 accès WiFi (Wifi classique ou réseau ESP8266).\\
Or, il est possible de configurer le module pour qu’il se connecte sur votre box WiFi en tant que client afin d'éviter les désagréments des connexions WiFi. \\
Pour cela il suffit de se connecter à l'ESP8266 via le port série et de taper les commandes suivantes : 
\begin{Bash}{Commandes de connexion}
import network
wlan = network.WLAN(network.STA_IF)
wlan.active(True)
wlan.connect('ssid', 'password')
\end{Bash}

Vous pouvez vérifier la nouvelle adresse IP fournie par votre box en tapant la commande :
\begin{Bash}{Vérification}
>>> wlan.ifconfig()
\end{Bash}

Par contre il est nécessaire de passer les commandes suivantes après la connexion à votre box :

\begin{Bash}{Initialisation}
>>> import webrepl
>>> webrepl.start()
\end{Bash}\chapter{Installation d'un serveur Apache}

\section{Présentation} \label{apache}

Apache est un logiciel qui va faire l’interface entre le serveur et les requêtes émises par le client. Ainsi, toutes les demandes d’affichage des pages Web passent par le logiciel Apache.
Ce dernier va écouter le port HTTP qui est le n°80 par défaut. \\

\img{\rootImages/schema.png}{Le rôle du serveur Apache}{0.6}

Les requêtes sécurisées passent, quant à elles par le port n°443. \\

\section{Installation}
Pour installer Apache, rien de plus simple :
\begin{Bash}{Installation de Apache}
sudo apt-get install -y apache2
\end{Bash}


\section{Une petite explication sur les ports}

Pour recevoir et transmettre des données à d’autres ordinateurs, un ordinateur a besoin de ports. Cependant, les ports physiques tel que le port USB, VGA, RS232 et ETHERNET sont peu nombreux. Ainsi, des ports virtuels ont été créés. \\

Chaque port virtuel est codé sur 16 bits et permet de faire communiquer un service ou un logiciel.\\
Par exemple, le service SSH communique sur le port 22. 
Il y a donc potentiellement 65536 ports disponibles. \\
Certains numéros de port sont réservés à certains services \\
Les ports de 0 à 1023 sont déjà réservés. Il conviendra de prendre un numéro de port non pris par un service dans les configurations à venir. \\

Le logiciel Apache gère l’emplacement du répertoire du site Web. \\
\bold {Par défaut, le code source du futur site est localisé dans /var/www/html}


\section{Masquer le serveur}

Tout d’abord, il convient de limiter le nombre d’information que le serveur va afficher en cas de problème. Moins l’utilisateur en sait, meilleure sera la sécurité globale.\\

Nous allons donc désactiver l’affichage du type de serveur et le système d’exploitation le faisant fonctionner.\\

\img{\rootImages/error.png}{L'affichage du système d'exploitation}{0.8}
Ainsi, nous voyons clairement le type de serveur en saisissant une adresse inexistante basée sur le serveur, avec les informations concernant le port (80) et le système d’exploitation Linux. \\

Editons le fichier \bold{/etc/apache2/conf-enabled/security.conf}

\begin{Bash}{Ouverture du fichier de configuration}
sudo nano /etc/apache2/conf-enabled/security.conf 
\end{Bash}

Si la commande \bold{nano} n'est pas reconnu, soit vous utiliser un éditeur de texte que vous avez l'habitude, soit vous installer \bold{nano} de la manière suivante : 

\begin{Bash}{Installation de nano}
sudo apt-get install -y nano
\end{Bash}


Ensuite, nous allons remplacer la ligne :
\begin{Bash}{Ancienne directive}
ServerTokens Os 
\end{Bash}
par
\begin{Bash}{Nouvelle directive}
ServerTokens Prod 
\end{Bash}

De plus, on va remplacer 

\begin{Bash}{Ancienne directive}
ServerSignature On
\end{Bash}
par
\begin{Bash}{Nouvelle directive}
ServerSignature Off
\end{Bash}



Enfin, on actualise le serveur avec

\begin{Bash}{Rédémarrage du serveur Apache}
sudo service apache2 restart
\end{Bash}

\section{Changer le port d'écoute d'Apache}

On édite le fichier /etc/apache2/ports.conf

\begin{Bash}{Edition du fichier de configuration des ports}
sudo nano /etc/apache2/ports.conf
\end{Bash}
Puis changer la ligne Listen si vous souhaiteez changer de port.\\
Si vous voulez ajouter un port d'écoute, ajouter une ligne Listen XXX


\section{Ajout d'un serveur virtuel}

/etc/apache2/sites-available/default
Exemple
\begin{Bash}{Fichier VirtualHost}


<VirtualHost *:80>
        # The ServerName directive sets the request scheme, hostname and port that
        # the server uses to identify itself. This is used when creating
        # redirection URLs. In the context of virtual hosts, the ServerName
        # specifies what hostname must appear in the request's Host: header to
        # match this virtual host. For the default virtual host (this file) this
        # value is not decisive as it is used as a last resort host regardless.
        # However, you must set it for any further virtual host explicitly.
        #ServerName www.example.com

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        #LogLevel info ssl:warn

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # For most configuration files from conf-available/, which are
        # enabled or disabled at a global level, it is possible to
        # include a line for only one particular virtual host. For example the
        # following line enables the CGI configuration for this host only
        # after it has been globally disabled with "a2disconf".
        #Include conf-available/serve-cgi-bin.conf
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet

\end{Bash}


\section{Protection d’un répertoire spécifique}

\paragraph{
Dans certains cas, on souhaite interdire, ou du moins restreindre l’accès d’un dossier au utilisateurs.
Une des solutions consiste à configurer un fichier htaccess. \newline
}
Un fichier htaccess est un fichier de configuration Apache permettant de restreindre des répertoires.
Ce dernier est de la forme suivante : \newline 


\begin{Bash}{Ancienne directive}
AuthUserFile /var/www/html/Admin/.htpasswd
AuthName "Veuillez saisir votre mot de passe pour ouvrir le dossier d'administration"
AuthType Basic
Require valid-user
\end{Bash}

Pour activer la lecture de ce fichier par le serveur Apache, il faut déclarer que la lecture est activée.

Dans le fichier 
\begin{Bash}{Ouverture du fichier}
sudo nano /etc/apache2/apache2.conf
\end{Bash}

Mettre tous les 
\begin{Bash}{\protect }
AllowOverride None
\end{Bash}
à 
\begin{Bash}{\protect }
AllowOverride All
\end{Bash}


\section{Htaccess}

\begin{Bash}{Fichier Htaccess}
AuthUserFile /var/www/html/root	//.htpasswd
AuthName "Accès protégé par un mot de passe"
AuthType Basic
Require valid-user
\end{Bash}

\section{Htpasswd}
\begin{Bash}{Fichier Htpasswd}
nico:\$apr1$KzVtay1X$NnfyAYUyQ0SN/PnxKu0aI1

\end{Bash}

\section{Définir les erreurs possibles}

Cette section ne traite plus de la sécurité mais traite du confort d’utilisation du site en cas d’erreurs.

Il est possible de personnaliser le message d’erreur en fonction de son type.

\begin{Bash}{Fichier htaccess}
ErrorDocument 404 /Warning/notfound.html
ErrorDocument 401 /Warning/unhautorized.html
\end{Bash}

\section{Afficher les erreurs Apache}
\begin{Bash}{Fichier log Apache}
cat /var/log/apache2/error.log 
\end{Bash}
\chapter{Installation de MySql}

\section{Présentation}
Un site qui commence à s’étoffer et à prendre de l’ampleur se verra un jour ou l’autre obligé d’utiliser une base de données pour traiter les informations et les stocker de manière efficace. 
Certaines  bases de données sont qualifiées de relationnelles car les éléments stockés entretiennent entre eux des points communs comme des noms, des catégories, des nombres… \\

La plupart des logiciels de gestion de base de données sont basés sur la relation client-serveur.\\
C’est à dire que pour le serveur fasse correctement son travail (stocker et récupérer des données), il faut un logiciel client qui dialogue avec le serveur. \\
Pour des raisons de facilités, nous installerons le logiciel client et serveur sur le même ordinateur, c'est à dire sur le serveur.

Aujourd’hui, de nombreux logiciels de gestion de base de données cohabitent : 

\begin{itemize}
    \item MariaDB
    \item MySql
    \item SQLite
    \item ...
\end{itemize}

\section{Installation}
Dans le cas de ce tutoriel, nous installerons MySql.

Il faut saisir les deux commandes suivantes : 

\begin{Bash}{Installation de MySql}
sudo apt-get install -y mysql-client
sudo apt-get install -y mysql-server
\end{Bash}

Selon la version de la distribution, un mot de passe peut être demandé ou non.
Par exemple, pour une distribution Ubuntu antérieur à la 18.04, un mot de passe est demandé, le cas échéant, le mot de passe par défaut est celui du compte root du serveur. \\
Dans tous les cas, retenez bien le mot de passe pour la suite.

\section{Connexion}

Deux méthodes de connexion sont possibles, en fonction de la distribution: 

\begin{Bash}{Lancement de MySql}
mysql -u root -p
\end{Bash}

-u 	représente l’utilisateur : root
-p 	indique que l’utilisateur va saisir un mot de passe

\begin{Bash}{Lancement de Mysql}
sudo mysql
\end{Bash}

Une fois le mot de passe saisi, un invité de commande apparaît

Le prompt mysql> indique que MySql a été correctement installé.

Pour ceux qui se sont connectés à MySql via > sudo mysql , il n’est pas recommandé de changer de mot de passe.

Pour les autres cas, vous pouvez changer de mot de passe en saisissant 
\begin{Bash}{Modifier un compte}
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'nouveau_mot_de_passe';
\end{Bash}

Il vous faudra donc vous connectez à votre compte Mysql avant de saisir la commande. 


Nous allons ensuite créer un compte qui possède des droits étendue :
Dans MySql \\


\begin{Bash}{Création d'un compte}
CREATE USER 'user'@'localhost' IDENTIFIED BY 'password';
GRANT ALL PRIVILEGES ON *.* TO 'user'@'localhost';
\end{Bash}


Vous pouvez remplacer user par un identifiant de votre choix.
password est à remplacer par le mot de passe de votre choix. \\

Enfin, si vous souhaitez supprimer un compte, il suffit de saisir
\begin{Bash}{Suppression d'un utilisateur Mysql}
DROP USER 'user'@'localhost';
\end{Bash}\chapter{Installation de PHP}

\section{Présentation}
Pour un site Web, toutes les personnes qui se connectent au serveur via un navigateur Web (Firefox, Chrome…) sont appelées clients. \\
Il faut distinguer un langage qui est exécuté du côté client et un langage qui est exécuté du côté serveur. \\

Les langages clients sont par exemple le langage HTML,Javascript, Mysql \\
Les langages serveurs sont Apache, Php ou Mysql. \\

Lorsqu’un client se connecte sur un site, il envoie une requête à ce dernier. Cette requête passe par Apache qui demande à Php de générer la page HTML. \\
La page est envoyée au client et est affichée du côté client. \\


\subsection{Installation}
Pour installer PHP sur le serveur, il faut saisir :

\begin{Bash}{Installation de Php}
sudo apt-get install -y php7.0
\end{Bash}

Par la même occasion, nous allons installer le programme permettant de communiquer entre la base de données et le serveur

\begin{Bash}{Installation du gestionnaire de base de données PHP}
sudo apt-get install -y php-mysql
\end{Bash}


\section{Modifier le fichier de configuration de php}
\begin{Bash}{Fichier php.ini}
sudo nano /etc/php/7.X/apache2/php.ini
\end{Bash}



\section{Augmentation de la taille des fichiers de chargements}

Il faut lire la fonction phpinfo() pour lire la variable :
puis modifier le fichier :

\begin{Bash}{Fichier php.ini}
sudo nano /etc/php/7.X/apache2/php.ini
\end{Bash}


\begin{Bash}{Fichier php.ini}
; Maximum size of POST data that PHP will accept.
; Its value may be 0 to disable the limit. It is ignored if POST data reading
; is disabled through enable_post_data_reading.
; http://php.net/post-max-size
post_max_size = 8M
\end{Bash}

puis
\begin{Bash}{Fichier php.ini}
; Maximum amount of memory a script may consume (128MB)
; http://php.net/memory-limit
memory_limit = 128M
\end{Bash}

puis 
\begin{Bash}{Fichier php.ini}
; Maximum allowed size for uploaded files.
; http://php.net/upload-max-filesize
upload_max_filesize = 100M
\end{Bash}\chapter{Installation de PhpMyAdmin}

\section{Présentation}
Administrer une base de données peut s'avérer compliqué. Afin de le faire plus facilement, l'utilitaire PhpMyAdmin est là pour nous aider. \\
Cela évite de rédiger les requêtes fastidieuses de MySql, il nous suffit juste de cocher des cases et de remplir les champs appropriés. \\
\section{Installation}
Veuillez sasir la commande suivante : 
\begin{Bash}{Installation de PhpMyAdmin}
sudo apt-get install -y phpmyadmin
\end{Bash}

Lors de l’installation, un mot de passe vous sera demandé : ce mot de passe sera utilisé pour se connecter à PhpMyAdmin. \\

Ensuite, le gestionnaire d’installation va vous demander votre serveur HTTP.
Sélectionnez \bold{Apache2}

\section{Emplacement de PhpMyAdmin}

\begin{Bash}{Emplacement de PhpMyAdmin}
cd /usr/share/phpmyadmin
\end{Bash}


\section{Configuration de PhpMyAdmin}

\begin{Bash}{Configu PhpMyAdmin}
#sudo mysql --user=root

#Dans MySql :
#DROP USER 'root'@'localhost';
#CREATE USER 'root'@'localhost' IDENTIFIED BY 'password';
#GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost';


\end{Bash}\chapter{Quelques fournisseurs électroniques}

  \section{Quelques fournisseurs de composants et matériels}

  \begin{items}{blue}{\Circle}
    \item \bold{Reichelt} \\ Cet site possède un choix très élevé de circuits intégrés (Amplificateurs opérationnels, transistors...) mais également de diodes, de leds, résistances.\\
    La documentation est bien fournie.\\
    Vente d'outils pour l'électronique.\\
    Le site est disponible à l'adresse \url{https://www.reichelt.com/}

    \item \bold{Gotronic} \\ Cet site possède un choix très élevé de capteurs.\\
    La documentation est bien fournie.\\
    Vente d'outils pour l'électronique.\\
    Délais de livraison rapides.\\
    Le site est disponible à l'adresse \url{https://www.gotronic.fr/}

    \item \bold{Arrow} \\ Cet site possède un choix très élevé de composants.\\
    La documentation est bien fournie.\\
    Le site est disponible à l'adresse \url{https://www.arrow.com/}

    \item \bold{Conrad} \\ Similaire à Gotronic.\\
    La documentation est bien fournie.\\
    Vente d'outils pour l'électronique.\\
    Le site est disponible à l'adresse \url{https://www.conrad.fr/}

    \item \bold{Semageek} \\ Similaire à Gotronic.\\
    Vente d'outils pour l'électronique.\\
    Le site est disponible à l'adresse \url{https://boutique.semageek.com/fr/}


    \item \bold{Dfrobot} \\ Un large choix de capteur pour l'embarqué.\\
    La documentation est bien fournie, cependant certains prix sont parfois un peu excessifs.\\
    Le site est disponible à l'adresse \url{https://www.dfrobot.com/}

    \item Puis \bold{Banggoods} pour les petites bricoles pas chères... \\
    Le site est disponible à l'adresse \url{https://www.banggood.com/}\\
    Délai de livraison au maximum de 3 semaines.


\end{items}\chapter{Installations de bibliothèques}

  Lors de nouveaux projets, certaines bibliothèques peuvent être manquantes.\\
  On s'en aperçoit quand on clique sur le bouton de vérification (bouton tout à gauche) du code :


  \img{\rootImages/verifier.png}{Bouton de vérification}{0.5}

  \img{\rootImages/dht.png}{La bibliothèque DHT manquante}{0.5}
  Une erreur de ce type nous indique que la bibliothèque \lib{DHT} est manquante.\\

  
  Il existe deux façons d'installer des bibliothèques Arduino.

  \section{Ajout via le gestionnaire de bibliothèques}

  Tout d'abord, veuillez vous rendre dans le menu \bold{Outils - Gérer les bibliothèques}.

  \img{\rootImages/lib-handler.png}{Le gestionnaire de bibliothèques}{0.6}

  Vous tombez sur une interface similaire :

  \img{\rootImages/lib-all.png}{Les bibliothèques existantes}{0.5}

  Cette page affiche toutes les bibliothèques disponibles via le gestionnaire de bibliothèques.\\
  Dans la barre de saisie en haut à droite, il faut indiquer le nom de la bibliothèque désirée. \\
  Prenons par exemple la bibliothèque DHT :

  \img{\rootImages/lib-install.png}{Ajouter une bibliothèque DHT}{0.5}

  Il faut parcourir la liste et trouver la bibliothèque \lib{DHT sensor library} de chez \bold{Adafruit}.
  Il ne reste plus qu'à sélectionner la version puis cliquer sur \shortcut{Installer}.

  Pour que les changements soit pris en compte, il faut redémarrer l'IDE \glossary{IDE} Arduino.


  \section{Ajout via un fichier ZIP}

  Cette méthode est un peu plus longue mais parfois, pour certaines bibliothèques non gérées par le gestionnaire de bibliothèques, nous n'avons pas le choix.\\

  En premier lieu, il faut trouver la bibliothèque sur Internet. Par exemple, la bibliothèque \lib{DHT} de chez \bold{Adafruit} est disponible à l'adresse suivante : 
  \url{https://github.com/adafruit/DHT-sensor-library}

  Il ne reste plus qu'à cliquer sur \shortcut{Code - Download ZIP} et le dossier compressé va se placer dans vos téléchargements.\\

  \img{\rootImages/git.png}{Téléchargement de la bibliothèque DHT}{0.4}


  Enfin, pour installer la bibliothèque, il suffit d'aller dans \bold{Croquis - Inclure une bibliothèque - Ajouter la bibliothèque .ZIP}
  
  \img{\rootImages/place.png}{Ajout d'une bibliothèque}{0.5}
  
  Il ne reste qu'à trouver le fichier \bold{DHT\_sensor-master.zip} et à faire \bold{OK}
  \chapter{VirtualBox}


Ce document a pour objectif de configurer le logiciel VirtualBox et de récupérer une image Linux 
afin de faire fonctionner Linux sous une machine Windows.\\
Ainsi, cela permet de travailler sur une machine Linux tout en évitant de modifier les fichiers 
sensibles de l’ordinateur (secteur d’amorçage…).\\
En revanche, ce système est gourmand en ressource, cela se traduit donc par une légère perte de 
performance sur la machine Virtuelle Linux (appelée MVL dans ce document).\\

Veuillez lire attentivement les prérequis car en cas de manquement à une obligation d’installation 
citée dans la section suivante, la MVL ne fonctionnera pas ou mal au pire des cas.\\



\section{Prérequis}


Avant de se lancer dans l’installation de la MVL, il est important de vérifier si l’ordinateur 
hôte pourra faire tourner cette MVL.\\
Pour cela, plusieurs conditions sont nécessaires :

\begin{items}{green}{\faviconCheck}
\item Être sous Windows 7, Windows 8, Windows 10 ou Windows 11
\item Avoir une connexion internet
\item Un ordinateur ayant au moins 6 Gigaoctets de mémoire vive (6 Go de RAM)
\item Cet ordinateur doit pouvoir supporter l’hébergement des machines virtuelles
\end{items}

Cette étape est primordiale, sans quoi la machine virtuelle ne pourra pas fonctionner.



\section{Bios}

Sur les ordinateurs pouvant héberger des machines virtuelles, le programme permettant 
d’activer cette fonctionnalité se trouve la plupart du temps dans le BIOS de l’ordinateur.\\

Le BIOS (Basic Input Output System) est un microprogramme qui se lance au démarrage de l’ordinateur 
avant que les systèmes d’exploitation ne démarrent. Ce microprogramme a pour but de vérifier 
l’intégrité des composants de l’ordinateur (mémoire, disque dur, ports USB…) et est accessible au 
démarrage de l’ordinateur en appuyant sur une touche du clavier lors de l’apparition de la marque 
de l’ordinateur.\\

Cependant, en fonction des ordinateurs, les touches peuvent changer…\\
Par exemple, voici les touches (les plus répandues) lors du démarrage d’un ordinateur.\\
Avant de faire une action, veuillez lire la section “Configuration du BIOS” en intégralité.

TOSHIBA
F2
DELL
F9
ASUS
F2
LENOVO
F2
HP
F10


Si jamais vous n’arrivez pas à accéder au BIOS avec les touches ECHAP, F2,F5, F10,F12 ou SUPPR, 
veuillez regarder la documentation en ligne à propos de votre ordinateur.\\


Le moment où il faut presser la touche :
(affichage de la marque de l’ordinateur)
(Je ne possède pas d’actions chez Dell…)

Une fois la touche pressée plusieurs fois dès le démarrage, le menu suivant devrait apparaître :

Il faut trouver la section Advanced (la plupart des cas) :
Dans les options, on cherche “Virtualization” ou “Virtualization Technology” que l’on sélectionne à « Enable » pour activer les machines virtuelles.

Il ne faut pas toucher aux autres options sous peine de ne plus voir l’ordinateur démarrer correctement
Ensuite, on presse F10 pour quitter le BIOS en sauvegardant les changements.


\section{Choix de la distribution}

Linux est un système d’exploitation basé sur un noyau UNIX.\\
Il existe une multitude de versions de Linux que l’on appelle distribution.\\
Ces distributions s’appellent Debian, Ubuntu, Fedora, CentOs… et se déclinent sous plusieurs 
interfaces graphiques.\\

Ainsi, pour chaque distribution Linux, le noyau est commun (gestion des composants…), 
seuls les logiciels annexes sont différents.\\
Le choix de la distribution se fait donc selon plusieurs critères comme : \\

\begin{items}{green}{\faviconLeaf}
\item La communauté autour de la distribution (Nombre d’utilisateurs et documentation fournie)
\item La variété des logiciels déjà présents lors de l’installation (peu de manipulation pour rendre 
le système fonctionnel)
\item La consommation de la mémoire vive (liée au choix de l’interface graphique)
\end{items}

Ainsi, je vous propose d’installer Xubuntu, une distribution basée sur Ubuntu et qui possède une 
interface graphique légère (interface Xfce). De plus, la communauté de Xubuntu est active et de nombreux 
logiciels sont disponibles.\\


Pour ceux qui le souhaitent, ils peuvent également installer une autre dérivée d'Ubuntu comme :

- Kubuntu  (interface gourmande mais évoluée)
- Lubuntu  (interface ultra-légère)

Pour ceux qui veulent plus d’informations, ils peuvent comparer les différentes interfaces graphiques :

- Kde			(Kubuntu...)
- Gnome		(Ubuntu...)
- Xfce			(Xubuntu...)
- Lxde			(Lubuntu...)
- Cinnamon 		(Linux Mint…)
- …


Ensuite, il vous faudra connaître votre architecture d’ordinateur. Si jamais vous ne l’avez pas, 
ce n’est pas grave mais c’est mieux de la connaître.\\
Pour cela, il vous faudra chercher dans les paramètres système de votre ordinateur.\\


Si vous avez un doute, prenez l’architecture 32 bits car cette dernière est compatible avec 
les 64 bits. Enfin, si votre ordinateur est récent, il y a de fortes chances pour qu’il soit en 64 bits.\\


Après avoir trouvé l'architecture, rendez vous sur le site officiel de la distribution en question 
(Exemple : http://xubuntu.fr/ )\\

Pour un ordinateur 32 bits avec Xubuntu, copier ce lien dans un navigateur : http://cdimage.ubuntu.com/xubuntu/releases/18.04.2/release/xubuntu-18.04.2-desktop-i386.iso
Pour un ordinateur 64 bits avec Xubuntu, copier ce lien dans un navigateur : http://cdimage.ubuntu.com/xubuntu/releases/18.04.2/release/xubuntu-18.04.2-desktop-amd64.iso

En cliquant sur un des ces liens, un fichier au format .iso va être téléchargé.\\
Il vous faudra noter l’emplacement du lieu de téléchargement (souvent dans “Téléchargements”)\\
Une fois le téléchargement de l’image ISO terminé, nous pouvons configurer VirtualBox.


\section{“Configuration}

Pour installer VirtualBox, téléchargez le logiciel sur le site officiel à l’adresse suivante :
https://www.virtualbox.org/wiki/Downloads 
Dans cette section, sélectionnez “Windows hosts”

Un exécutable sera téléchargé, exécutez le et laissez vous guider par l’installation (paramètres par défaut). Un logo similaire apparaît sur votre bureau




    b) Lancement
Lors de l’ouverture de VirtualBox, commencer par aller dans le menu supérieur et dans “Machine”, cliquez sur “Nouvelle”.



Le menu suivant s’affiche : il faut nommer la machine et sélectionner le système d’exploitation.
Dans le menu déroulant, sélectionnez “Linux/2.6/3.x” (dernière version).
Sélectionnez l’architecture 64 bits ou 32 bits en fonction de votre PC.


    c) Allocation de la mémoire
L’étape suivante permet d’allouer de la mémoire à la MVL et à VirtualBox



Par défaut, VirtualBox recommande une certaine quantité de mémoire (ici, 1Go)
Cependant, pour être à l’aise, il est recommandé de mettre 3 Go (3000 Mo)



Dans cette configuration de VirtualBox, l’ordinateur hôte n’est pas prévu pour faire beaucoup de tâches sur Windows. Si vous êtes sur la MVL, pensez à réduire les activités sous Windows, (Jeux, gros logiciels en arrière plan...).
Après quelques essais, vous pourrez diminuer la mémoire allouée pour la machine si vous le souhaitez.














    d) Création du disque dur

Nous allons créer un disque dur virtuel lors de l’installation.

Ensuite, nous allons définir le type de fichier de disque (par défaut)



Choisissez un fichier de disque dur à taille fixe afin de gagner en rapidité lors de l’utilisation de la MVL. (page suivante)





En faisant cette étape, nous allons pouvoir créer un disque dur pouvant contenir le système Linux. Pour être confortable, nous allons octroyer 20 Go de stockage pour la MVL.
Bien évidemment, cette capacité dépend de la taille de votre disque dur réel.

Après validation, cette fenêtre apparaît :


A la fin de l’animation, le disque dur virtuel est créé.





    e) Sélection de l’image ISO
Une fois sur la page principale, sélectionnez votre machine 

et cliquez sur Configuration


Cette interface apparaît :


Allez dans le menu Stockage


Puis cliquez sur “Ajouter un lecteur optique”


puis “Choisir un disque”

Cliquez sur “Ajouter”


Il ne vous reste plus qu'à trouver votre image ISO téléchargée.








Une fois ce résultat obtenu, la configuration de VirtualBox est terminée.



\section{Installation}


Une fois revenu sur le menu principal, sélectionnez votre machine et cliquez sur “Démarrer”


Après quelques instants, le logo de la distribution s’affiche suivi d’un menu gris :




Veuillez tout d’abord sélectionnez la langue d’installation : 


Puis cliquez sur “Installer Xubuntu”








Sélectionnez la langue de manière plus précise :



Pour la section “Mises à Jours”, sélectionnez les deux cases, surtout la deuxième car sans cette dernière, il vous faudra installer manuellement les pilotes et codecs multimédias (étape pénible…)
En revanche, si la première option n’est pas cochée, ce n’est pas grave car on pourra faire la mise à jour plus tard.
A partir de cette étape, le réseau internet n’est plus obligatoire.



Nous allons effacer le disque alloué (20 Go) afin de mettre Linux dessus.

Il faut ensuite valider ce choix…

Il ne vous reste plus qu'à renseigner vos informations personnelles.


Vous devez indiquer votre nom, votre identifiant et votre mot de passe.
Le nom de l’ordinateur importe peu.


Une fois validé, l’installation du noyau Linux peut débuter.


Après un petit temps, la fenêtre suivante s’affiche :

Faite “Redémarrer maintenant”.
Ensuite, à la vue de cette fenêtre, faites “Entrée”

La machine redémarre et affiche de nouveau la marque de la distribution (Xubuntu).

Vous pouvez maintenant vous connecter sous votre nom d’utilisateur
et avec votre mot de passe. Pour information, le pavé numérique n’est pas activé par défaut sous VirtualBox.


Une fois connecté, vous arrivez sur un menu semblable :


Le menu (équivalent Windows) se situe ici :



Pour éteindre la machine proprement, il suffit d’aller dans le menu et de cliquer sur le bouton 

Une fois éteinte, pour allumer la machine, il suffit de cliquer sur Démarrer



Ce tutoriel est désormais terminé, n’hésitez pas à faire des retours afin que je puisse l’améliorer et pour corriger les erreurs éventuelles.%\addPartText{Introduction aux réseaux}

%\part{Les réseaux}

\chapter{Les réseaux}

Un réseau est un ensemble de machines  \footnote{Serveurs, PC, Tablettes, téléphones, imprimantes} reliées entre elles. 
Dans notre cas, la liaison sur le réseau se fera en Ethernet ou WiFi.\\

Pour communiquer entre elles, il faut définir des adresses \glossary{IP} exactement comme une \\
adresse postale pour transmettre un courrier.


\subsection{Les adresses MAC}

Une adresse \glossary{MAC} est une adresse unique qui désigne la machine
\footnote{Plus précisément l'adresse de la carte réseau de la machine}.\\ 
Elle est de la forme \lbl{orange}{MAC}{XX:XX:XX:XX:XX:XX} 
(six octets usuellement exprimés et hexadécimal) et reste invariante dans le temps.\\

Contrairement aux adresses IP, les adresses MAC ne sont normalement pas attribuées explicitement par 
configuration ; elles sont au contraire attribuées à la production de la carte réseau par son fabriquant

La table \glossary{ARP} d'une machine sert à associer des adresses IP à des 
adresses MAC.


\subsection{Les adresse IP}

Une adresse IP est une adresse donnée à une machine qui rejoint le réseau. \\


\subsubsection{A quoi ressemble une adresse IP ?}

\begin{items}{blue}{\Bullet}
	\item Version 4 (Ipv4) : Les adresses sont codées sur 32 bits \\
		
	\lbl{green}{IP}{192.168.0.1}	= \lbl{orange}{BIN}{1100000.10101000.0000000.00000001} (En Binaire)
	\item version 6 (Ipv6)	: les adresses sont codées sur 128 bits \\
	\lbl{green}{IP}{FE80:0000:0000:0000:020C:76FF:FE21:1C3B}. 
	L’adresse de version 4 (IPv4) est encore actuellement la plus utilisée. 
\end{items}

Dans un réseau, chaque machine possède une adresse IP fixée par l'administrateur du réseau. \\
Il est interdit de donner la même adresse à 2 machines différentes sous peine de dysfonctionnement.\\

Une adresse IPv4 est une suite de 32 bits (4 octets)  notée en général a.b.c.d avec a, b, c, et d des entiers « décimal » 
compris entre 0 et 255.
 Chaque valeur a, b, c ou d représente dans ce cas une suite de 8 bits. 

 \begin{exemple}
Une machine qui a comme adresse IP 134.214.80.12 (En décimal) :

\begin{items}{blue}{\Bullet}
\item a vaut 134 soit (1000 0110) en binaire.
\item b vaut 214 soit (1101 0110) en binaire. 
\item c vaut 80 soit (0101 0000) 
\item d vaut 12 vaut (00001100).
\end{items}

En binaire, l'adresse IP s'écrit  \lbl{green}{IP}{10000110.1101 0110.0101 0000.0000 1100} et puisque le codage se fait sur 
8 bits les valeurs seront obligatoirement comprises entre 0 et 255.
\end{exemple}

\subsubsection{Le net-id et le host-id}

Au sein d'un même réseau IP, toutes les adresses IP commencent par la même suite de bits.
L’adresse IP d’une machine va en conséquence être composée de 2 parties : 

\begin{items}{blue}{\Bullet}
	\item Net-id : La partie fixe de l'adresse IP
	\item Host-id : La partie réservée aux machines qui viennent sur le réseau
\end{items}


\subsubsection{Masque de réseau IP}

\index{Masque de sous-réseau}
Le masque du réseau permet de connaître le nombre de bits du net-id. On appelle N ce nombre. Il s’agit d’une suite de 32 bits 
composée en binaire de N bits à 1 suivis de 32-N bits à 0.\\
C’est le masque du réseau qui définit la taille d’un réseau IP : c’est-à-dire la plage d’adresses assignables aux machines du réseau.

Ainsi, pour connaître le net-id, on va faire un ET (\& ou .) logique entre le masque et l'adresse IP.

\begin{exemple}

	Prenons l'adresse IP \lbl{green}{IP}{192.168.1.0} et le masque \lbl{green}{MASK}{255.255.255.0}. \\ Que vaut le net-id ? \\
	Pour rappel : 
	\begin{items}{blue}{\Triangle}
		\item 0.0 = 0
		\item 0.1 = 0
		\item 1.0 = 0
		\item 1.1 = 1
	\end{items}

\end{exemple}

	
\begin{solution}
	
	L'adresse \lbl{green}{IP}{192.168.1.0} vaut \lbl{orange}{BIN}{1100000.10101000.0000000.00000001} et \\
L'adresse \lbl{green}{MASK}{255.225.255.0} vaut \lbl{orange}{BIN}{11111111.11111111.11111111.00000000} \\


~~~01100000.10101000.00000000.00000001 \\
ET
~~11111111.11111111.11111111.00000000 \\
=
~~~01100000.10101000.00000000.00000000 ~~ = ~~\lbl{green}{BIN}{01100000.10101000.00000000.00000000} \\

L'adresse \lbl{green}{IP}{192.168.0.0} obtenue représente donc \bold{l'adresse du réseau}.\\

Les autres bits à 0 sont donc réservés aux périphériques du réseau. Étant sur 8 bits, il y a donc $2^8-2$ adresses 
disponibles sur ce réseau.

\end{solution}


\subsection{Les adresses interdites}

Il est interdit d’attribuer à une machine d’un réseau l’adresse du réseau et l’adresse de broadcast (diffusion)

\subsubsection{L'adresse de diffusion}

Cette adresse permet à une machine d’envoyer une info à toutes les machines d’un réseau. 
Cette adresse est celle obtenue en mettant tous les bits de l’host-id à 1. \\
Dans notre cas c'est l'adresse \lbl{green}{IP}{192.168.0.255}

\subsubsection{L'adresse de réseau}

Cette adresse est celle obtenue après avoir fait le ET entre l'adresse IP et le masque de sous-réseau.
Dans notre cas c'est l'adresse \lbl{green}{IP}{192.168.0.0}


\section{Choix des adresses IP}


Sur un réseau local, les adresses sont choisies par un serveur \glossary{DHCP}.

Les adresses peuvent être :

\begin{items}{blue}{\Bullet}
	\item Statiques : Un appareil sur le réseau possède la même adresse après connexion puis déconnexion.
	\item Dynamiques : l'adresse IP varie dans le temps au bout d'une période d'expiration après une déconnexion 
	(bail d'une journée par exemple)
\end{items}

A de rares exceptions, vous n'êtes pas censé attribuer une adresse IP vous-même à une machine.\\


\section{Quelques exemples de type de réseau}

Un réseau IP peut avoir une taille très variable :

\begin{items}{green}{\Bullet}
	\item Une entreprise moyenne aura un réseau comportant une centaine de machines.
	\item Un campus universitaire aura un réseau comportant de quelques milliers à quelques dizaines de milliers de machines.
	\item Le réseau d'une multinationale (un grand fournisseur d'accès par exemple) peut comporter des millions de postes.
\end{items}

\img{\rootImages/network.png}{Un réseau plus évolué}{0.4}

Il existe 2 types de réseau :

\begin{items}{green}{\Bullet}
\item Les réseaux publics Internet où chaque équipement connecté doit posséder une adresse unique et enregistrée au niveau mondial. 
\item Les réseaux privés, dans ce cas le choix des adresses est libre et ne doivent être uniques que dans ce réseau. 
\end{items}
Si un réseau privé doit être inter-connecté avec le réseau Internet, il faudra alors utiliser des adresses privées qui 
ne puissent correspondre à des adresses publiques utilisées sur Internet. Des plages d’adresses réservées à usage privé 
existent et elles ne sont donc pas acheminées par les routeurs Internet, ce qui supprime tout risque de conflit (cf. document annexe). 


\section{Récupération des adresse IP}

Voici 2 commandes pour récupérer l'adresse IP et le masque de sous-réseau.

\subsubsection{Pour Windows}
Sous un terminal Windows \footnote{Saisir \bold{cmd} dans le gestionnaire de programme}
\begin{Bash}{Récupération des informations IP sous Windows}
ipconfig
\end{Bash}
\img{\rootImages/ipconfig.png}{La commande ipconfig}{0.7}
	

\subsubsection{Pour Linux}
Sous un terminal Linux, on peut utiliser la commande \lbl{purple}{LIB}{ifconfig}\footnote{Si non installée sous Linux, 
saisir \lbl{purple}{CMD}{sudo apt-get install net-tools}}
\begin{Bash}{Récupération des informations IP sous Linux}
ifconfig
\end{Bash}

\img{\rootImages/ifconfig.png}{La commande ipconfig}{0.5}
	
	
\chapter{Utilisation des ressources du CREPP}

\section{Présentation}

Ce document a pour objectif d'expliquer le fonctionnement de Git pour les ateliers du CREPP.
Un répertoire Git a été créé pour centraliser les supports des ateliers ainsi que les codes et projets produits depuis la création du CREPP en 2012.\\
Il est donc en perpétuelle amélioration.

\section{Localisation}
Le répertoire est disponible à l'adresse suivante : \link{\url{https://github.com/CREPP-PLOEMEUR}} ou bien en passant sur
 le site du CREPP\footnote{\link{\url{crepp.org}}}, dans la section \bold{Ressources GIT}

\img{\rootImages/localisation.png}{Accès aux ressources GIT}{0.5}

\section{Menu principal}


Une fois le lien cliqué, vous tombez directement sur cette interface 

\img{\rootImages/git_home.png}{La page principale du répertoire Git}{0.35}

Les répertoires facilement accessibles sont :

\begin{items}{blue}{\Bullet}
    \item Le répertoire \bold{Supports\_PDF} regroupe les supports PDf utilisés pour les Ateliers Arduino et Microcontrôleurs.
    \item Le répertoire \bold{Codes\_Arduino} est une compilation des codes Arduino utilisés lors des ateliers.
    \item Le répertoire \bold{Codes\_ESP12} est une compilation des codes ESP12 des ateliers.
\end{items}

Sous ces trois répertoires, vous avez accès à l'ensemble des répertoires du CREPP. Pour afficher tous les répertoires, vous pouvez cliquer 
sur \bold{View all repositories} en bas de la page.

\img{\rootImages/view.png}{Afficher l'ensemble des répertoires}{0.45}

Il est possible de classer les répertoires en cliquant sur \bold{Sort} et de les classer en fonction de :

\begin{items}{blue}{\Bullet}
    \item Les dates de modifications
    \item Les noms
\end{items}

\img{\rootImages/sort.png}{Trier les répertoires}{0.45}

Actuellement, voici les répertoires : 

\begin{items}{orange}{\faBookmark} 
\item codes\_Arduino
\item Codes\_ESP12
\item Codes\_Pico
\item Projets\_Ateliers\_Jeunes
\item Projet\_Capteur\_pollution\_atmospherique
\item Projet\_Cocci-Bot
\item Projet\_Crepp-Rap
\item Projet\_Fauteuil\_roulant
\item Projet\_MySensors
\item Projet\_Pot\_Qui\_pense
\item Projet\_Raspi-Bot
\item Projet\_SimpleCDBot
\item Projet\_Tracker\_Solaire
\item Projet\_Ventilateur
\item Supports\_PDF 
\end{items}


\section{Exploration d'un répertoire}

\subsection{L'arborescence}

En cliquant sur un répertoire, l'arborescence de ce dernier apparaît avec le premier rang des dossiers et les fichiers sur le même niveau.\\
En cliquant sur les noms des dossiers, on peut parcourir l'arborescence du répertoire complet.\\

\img{\rootImages/main.png}{L'arborescence du répertoire}{0.30}

Une description du répertoire est disponible avec un fichier README.md. (ici le répertoire Codes\_Arduino)

\img{\rootImages/readme.png}{Une description du répertoire}{0.35}

Les principaux langages utilisés dans le répertoires sont indiqués à droite de la section \bold{README}.

\subsection{Récupération d'un fichier}

\subsubsection{Un fichier contenant du code}
Pour récupérer le contenu  d'un fichier particulier, il faut parcourir l'arborescence pour le trouver.\\
Une fois le fichier localisé, il faut cliquer sur le fichier afin de voir son contenu : 


\img{\rootImages/content.png}{Un contenu de fichier}{0.35}

Enfin, il ne reste plus qu'à cliquer sur \bold{Copy raw contents}
pour copier tout le texte du fichier dans le presse-papier.

\img{\rootImages/raw.png}{Copier le contenu d'un fichier}{0.6}


\subsubsection{Un fichier PDF}

Pour récupérer le fichier PDF, après l'avoir localisé, il suffit de cliquer sur le bouton \bold{Download}.

\img{\rootImages/download_pdf.png}{Téléchargement d'un fichier PDF}{0.35}

\messageBox{Remarque}{orange}{white}{Cette méthode est contraignante quand nous sommes ammenés à manipuler plusieurs fichiers au sein d'un même répertoire. \\La méthode suivante va vous expliquer comment télécharger directement tout un répertoire pour travailler par la suite en local.}{black}


\section{Téléchargement d'un répertoire}

Pour télécharger un répertoire dans son intégralité, il faut tout d'abord se placer à la racine de celui-ci en cliquant sur le 
nom du répertoire (Codes\_Arduino):

\img{\rootImages/name.png}{Déplacement à la racine du répertoire}{0.35}

Ensuite, il faut cliquer sur le bouton vert \shortcut{Code} pour dérouler un petit menu puis cliquer sur \bold{Download ZIP}

\img{\rootImages/zip.png}{Téléchargement du répertoire}{0.5}

Le répertoire va se télécharger au format ZIP dans vos téléchargements avec le suffixe \bold{-master}.\\ 
Par exemple, le répertoire \bold{Codes\_Arduino} sera téléchargé sous le nom \bold{Codes\_Arduino-master.zip}.\\

Il ne vous reste plus qu'à extraire le fichier pour explorer le répertoire.\n
